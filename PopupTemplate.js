// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","./core/tsSupport/assignHelper","./core/tsSupport/declareExtendsHelper","./core/tsSupport/decorateHelper","./core/Collection","./core/date","./core/JSONSupport","./core/kebabDictionary","./core/lang","./core/accessorSupport/decorators","./layers/support/fieldUtils","./support/Action","./support/arcadeUtils"],function(t,e,o,r,n,i,s,l,p,a,d,c,f,u){var y=p({richtext:"rich-text",textarea:"text-area",textbox:"text-box"}),h=p({barchart:"bar-chart",columnchart:"column-chart",linechart:"line-chart",piechart:"pie-chart"});return function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.actions=null,e.content="",e.expressionInfos=null,e.fieldInfos=null,e.layerOptions=null,e.overwriteActions=!1,e.title="",e.relatedRecordsInfo=null,e}return r(e,t),o=e,e.prototype.readContent=function(t,e){var o=this,r=e.description,n=e.mediaInfos,i=e.popupElements,s=e.showAttachments,l=i;if(l&&l.length)return l.map(function(t){return"text"!==t.type||t.text?"media"===t.type&&(t.mediaInfos||n)&&(t.mediaInfos||(t.mediaInfos=n),t.mediaInfos=o._readMediaInfos(t.mediaInfos)):t.text=r,t});var p=[];return r?p.push({type:"text",text:r}):p.push({type:"fields"}),n&&n.length&&p.push({type:"media",mediaInfos:this._readMediaInfos(n)}),s&&p.push({type:"attachments",displayType:"list"}),p.length?p:r},e.prototype.writeContent=function(t,e){var o=this;return e.showAttachments=!1,"string"==typeof t?void(e.description=t):Array.isArray(t)?(e.popupElements=a.clone(t),void e.popupElements.forEach(function(t){return"attachments"!==t.type||e.showAttachments?"media"!==t.type||e.mediaInfos?"text"!==t.type||e.description?"fields"!==t.type||e.fieldInfos||(t.fieldInfos&&(e.fieldInfos=o._writeFieldInfos(a.clone(t.fieldInfos))),delete t.fieldInfos):(t.text&&(e.description=t.text),delete t.text):(t.mediaInfos&&(e.mediaInfos=a.clone(t.mediaInfos),e.mediaInfos.forEach(function(t){t.type=h.toJSON(t.type)})),delete t.mediaInfos):e.showAttachments=!0,t})):void 0},e.prototype.writeExpressionInfos=function(t,e){e.expressionInfos=t||null},e.prototype.readFieldInfos=function(t){if(t)return t.forEach(function(t){var e=t.format&&t.format.dateFormat,o=t.stringFieldOption;e&&(t.format.dateFormat=s.fromJSON(e)),o&&(t.stringFieldOption=y.fromJSON(o))}),t},e.prototype.writeFieldInfos=function(t,e){e.fieldInfos=t?this._writeFieldInfos(a.clone(t)):t},e.prototype.writeLayerOptions=function(t,e){e.layerOptions=t||null},e.prototype.writeTitle=function(t,e){e.title=t||""},e.prototype.writeRelatedRecordsInfo=function(t,e){e.relatedRecordsInfo=t||null},Object.defineProperty(e.prototype,"requiredFields",{get:function(){return this.collectRequiredFields()},enumerable:!0,configurable:!0}),e.prototype.clone=function(){var t=this.actions,e=t?a.clone(t.toArray()):[];return new o({actions:e,content:Array.isArray(this.content)?a.clone(this.content):this.content,fieldInfos:this.fieldInfos?a.clone(this.fieldInfos):null,layerOptions:this.layerOptions?a.clone(this.layerOptions):null,overwriteActions:this.overwriteActions,relatedRecordsInfo:this.relatedRecordsInfo?a.clone(this.relatedRecordsInfo):null,title:this.title})},e.prototype.collectRequiredFields=function(){return this._getActionsFields(this.actions).concat(this._getTitleFields(this.title),this._getContentFields(this.content),this._getExpressionInfoFields(this.expressionInfos)).filter(function(t,e,o){return e===o.indexOf(t)})},e.prototype._getContentElementFields=function(t){var e=this;if(!t||"attachments"===t.type)return[];if("fields"===t.type)return this._getFieldInfoFields(t.fieldInfos||this.fieldInfos);if("media"===t.type){return(t.mediaInfos||[]).reduce(function(t,o){return t.concat(e._getMediaInfoFields(o))},[])}return"text"===t.type?c.extractFieldNames(t.text):void 0},e.prototype._getMediaInfoFields=function(t){var e=t.caption,o=t.title,r=t.value,n=r||{},i=n.fields,s=void 0===i?[]:i,l=n.normalizeField,p=n.tooltipField,a=n.sourceURL,d=n.linkURL,f=c.extractFieldNames(o).concat(c.extractFieldNames(e),c.extractFieldNames(a),c.extractFieldNames(d),s);return l&&f.push(l),p&&f.push(p),f},e.prototype._getContentFields=function(t){var e=this;return"string"==typeof t?c.extractFieldNames(t):Array.isArray(t)?t.reduce(function(t,o){return t.concat(e._getContentElementFields(o))},[]):[]},e.prototype._getExpressionInfoFields=function(t){return t?t.reduce(function(t,e){return t.concat(u.extractFieldNames(e.expression))},[]):[]},e.prototype._getFieldInfoFields=function(t){return t?t.filter(function(t){return void 0===t.visible||!!t.visible}).map(function(t){return t.fieldName}).filter(function(t){return-1===t.indexOf("relationships/")&&-1===t.indexOf("expression/")}):[]},e.prototype._getActionsFields=function(t){var e=this;return t?t.toArray().reduce(function(t,o){return t.concat(e._getActionFields(o))},[]):[]},e.prototype._getActionFields=function(t){return c.extractFieldNames(t.title).concat(c.extractFieldNames(t.className),c.extractFieldNames(t.image))},e.prototype._getTitleFields=function(t){return"string"==typeof t?c.extractFieldNames(t):[]},e.prototype._readMediaInfos=function(t){return t.forEach(function(t){t.type=h.fromJSON(t.type)}),t},e.prototype._writeFieldInfos=function(t){return t.forEach(function(t){var e=t.format&&t.format.dateFormat,o=t.stringFieldOption;e&&(t.format.dateFormat=s.toJSON(e)),o&&(t.stringFieldOption=y.toJSON(o)),t.format||delete t.format}),t},n([d.property({type:i.ofType(f)})],e.prototype,"actions",void 0),n([d.property()],e.prototype,"content",void 0),n([d.reader("content",["description","popupElements","mediaInfos","showAttachments"])],e.prototype,"readContent",null),n([d.writer("content")],e.prototype,"writeContent",null),n([d.property()],e.prototype,"expressionInfos",void 0),n([d.writer("expressionInfos")],e.prototype,"writeExpressionInfos",null),n([d.property()],e.prototype,"fieldInfos",void 0),n([d.reader("fieldInfos")],e.prototype,"readFieldInfos",null),n([d.writer("fieldInfos")],e.prototype,"writeFieldInfos",null),n([d.property()],e.prototype,"layerOptions",void 0),n([d.writer("layerOptions")],e.prototype,"writeLayerOptions",null),n([d.property()],e.prototype,"overwriteActions",void 0),n([d.property()],e.prototype,"title",void 0),n([d.writer("title")],e.prototype,"writeTitle",null),n([d.property()],e.prototype,"relatedRecordsInfo",void 0),n([d.writer("relatedRecordsInfo")],e.prototype,"writeRelatedRecordsInfo",null),n([d.property({dependsOn:["actions","title","content","fieldInfos","expressionInfos"],readOnly:!0})],e.prototype,"requiredFields",null),e=o=n([d.subclass("esri.PopupTemplate")],e);var o}(d.declared(l))});