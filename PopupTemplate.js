// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","./core/tsSupport/assignHelper","./core/tsSupport/declareExtendsHelper","./core/tsSupport/decorateHelper","./core/accessorSupport/decorators","./core/date","./core/Collection","./core/kebabDictionary","./core/JSONSupport","./core/lang","./support/Action","./support/arcadeUtils","./layers/support/fieldUtils"],function(e,t,o,r,n,i,s,p,l,a,d,c,f,u){var y=l({richtext:"rich-text",textarea:"text-area",textbox:"text-box"}),h=l({barchart:"bar-chart",columnchart:"column-chart",linechart:"line-chart",piechart:"pie-chart"}),m=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.actions=null,t.content="",t.expressionInfos=null,t.fieldInfos=null,t.layerOptions=null,t.overwriteActions=!1,t.title="",t.relatedRecordsInfo=null,t}return r(t,e),o=t,t.prototype.readContent=function(e,t){var o=this,r=t.description,n=t.mediaInfos,i=t.popupElements,s=t.showAttachments,p=i;if(p&&p.length)return p.map(function(e){return"text"!==e.type||e.text?"media"===e.type&&(e.mediaInfos||n)&&(e.mediaInfos||(e.mediaInfos=n),e.mediaInfos=o._readMediaInfos(e.mediaInfos)):e.text=r,e});var l=[];return r?l.push({type:"text",text:r}):l.push({type:"fields"}),n&&n.length&&l.push({type:"media",mediaInfos:this._readMediaInfos(n)}),s&&l.push({type:"attachments",displayType:"list"}),l.length?l:r},t.prototype.writeContent=function(e,t){var o=this;return t.showAttachments=!1,"string"==typeof e?void(t.description=e):Array.isArray(e)?(t.popupElements=d.clone(e),void t.popupElements.forEach(function(e){return"attachments"!==e.type||t.showAttachments?"media"!==e.type||t.mediaInfos?"text"!==e.type||t.description?"fields"!==e.type||t.fieldInfos||(e.fieldInfos&&(t.fieldInfos=o._writeFieldInfos(d.clone(e.fieldInfos))),delete e.fieldInfos):(e.text&&(t.description=e.text),delete e.text):(e.mediaInfos&&(t.mediaInfos=d.clone(e.mediaInfos),t.mediaInfos.forEach(function(e){e.type=h.toJSON(e.type)})),delete e.mediaInfos):t.showAttachments=!0,e})):void 0},t.prototype.writeExpressionInfos=function(e,t){t.expressionInfos=e||null},t.prototype.readFieldInfos=function(e){return e?(e.forEach(function(e){var t=e.format&&e.format.dateFormat,o=e.stringFieldOption;t&&(e.format.dateFormat=s.fromJSON(t)),o&&(e.stringFieldOption=y.fromJSON(o))}),e):void 0},t.prototype.writeFieldInfos=function(e,t){t.fieldInfos=e?this._writeFieldInfos(d.clone(e)):e},t.prototype.writeLayerOptions=function(e,t){t.layerOptions=e||null},t.prototype.writeTitle=function(e,t){t.title=e||""},t.prototype.writeRelatedRecordsInfo=function(e,t){t.relatedRecordsInfo=e||null},Object.defineProperty(t.prototype,"requiredFields",{get:function(){return this.collectRequiredFields()},enumerable:!0,configurable:!0}),t.prototype.clone=function(){var e=this.actions,t=e?d.clone(e.toArray()):[];return new o({actions:t,content:Array.isArray(this.content)?d.clone(this.content):this.content,fieldInfos:this.fieldInfos?d.clone(this.fieldInfos):null,layerOptions:this.layerOptions?d.clone(this.layerOptions):null,overwriteActions:this.overwriteActions,relatedRecordsInfo:this.relatedRecordsInfo?d.clone(this.relatedRecordsInfo):null,title:this.title})},t.prototype.collectRequiredFields=function(){var e=this._getActionsFields(this.actions).concat(this._getTitleFields(this.title),this._getContentFields(this.content),this._getExpressionInfoFields(this.expressionInfos));return e.filter(function(e,t,o){return t===o.indexOf(e)})},t.prototype._getContentElementFields=function(e){var t=this;if(!e||"attachments"===e.type)return[];if("fields"===e.type)return this._getFieldInfoFields(e.fieldInfos||this.fieldInfos);if("media"===e.type){var o=e.mediaInfos||[];return o.reduce(function(e,o){return e.concat(t._getMediaInfoFields(o))},[])}return"text"===e.type?u.extractFieldNames(e.text):void 0},t.prototype._getMediaInfoFields=function(e){var t=e.caption,o=e.title,r=e.value,n=r||{},i=n.fields,s=void 0===i?[]:i,p=n.normalizeField,l=n.tooltipField,a=n.sourceURL,d=n.linkURL,c=u.extractFieldNames(o).concat(u.extractFieldNames(t),u.extractFieldNames(a),u.extractFieldNames(d),s);return p&&c.push(p),l&&c.push(l),c},t.prototype._getContentFields=function(e){var t=this;return"string"==typeof e?u.extractFieldNames(e):Array.isArray(e)?e.reduce(function(e,o){return e.concat(t._getContentElementFields(o))},[]):[]},t.prototype._getExpressionInfoFields=function(e){return e?e.reduce(function(e,t){return e.concat(f.extractFieldNames(t.expression))},[]):[]},t.prototype._getFieldInfoFields=function(e){return e?e.filter(function(e){return"undefined"==typeof e.visible?!0:!!e.visible}).map(function(e){return e.fieldName}).filter(function(e){return-1===e.indexOf("relationships/")&&-1===e.indexOf("expression/")}):[]},t.prototype._getActionsFields=function(e){var t=this;return e?e.toArray().reduce(function(e,o){return e.concat(t._getActionFields(o))},[]):[]},t.prototype._getActionFields=function(e){return u.extractFieldNames(e.title).concat(u.extractFieldNames(e.className),u.extractFieldNames(e.image))},t.prototype._getTitleFields=function(e){return"string"==typeof e?u.extractFieldNames(e):[]},t.prototype._readMediaInfos=function(e){return e.forEach(function(e){e.type=h.fromJSON(e.type)}),e},t.prototype._writeFieldInfos=function(e){return e.forEach(function(e){var t=e.format&&e.format.dateFormat,o=e.stringFieldOption;t&&(e.format.dateFormat=s.toJSON(t)),o&&(e.stringFieldOption=y.toJSON(o)),e.format||delete e.format}),e},n([i.property({type:p.ofType(c)})],t.prototype,"actions",void 0),n([i.property()],t.prototype,"content",void 0),n([i.reader("content",["description","popupElements","mediaInfos","showAttachments"])],t.prototype,"readContent",null),n([i.writer("content")],t.prototype,"writeContent",null),n([i.property()],t.prototype,"expressionInfos",void 0),n([i.writer("expressionInfos")],t.prototype,"writeExpressionInfos",null),n([i.property()],t.prototype,"fieldInfos",void 0),n([i.reader("fieldInfos")],t.prototype,"readFieldInfos",null),n([i.writer("fieldInfos")],t.prototype,"writeFieldInfos",null),n([i.property()],t.prototype,"layerOptions",void 0),n([i.writer("layerOptions")],t.prototype,"writeLayerOptions",null),n([i.property()],t.prototype,"overwriteActions",void 0),n([i.property()],t.prototype,"title",void 0),n([i.writer("title")],t.prototype,"writeTitle",null),n([i.property()],t.prototype,"relatedRecordsInfo",void 0),n([i.writer("relatedRecordsInfo")],t.prototype,"writeRelatedRecordsInfo",null),n([i.property({dependsOn:["actions","title","content","fieldInfos","expressionInfos"],readOnly:!0})],t.prototype,"requiredFields",null),t=o=n([i.subclass("esri.PopupTemplate")],t);var o}(i.declared(a));return m});