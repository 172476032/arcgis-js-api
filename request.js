// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","dojo/_base/config","dojo/Deferred","dojo/_base/lang","dojo/_base/url","dojo/request","dojo/io-query","./config","./core/Error","./core/global","./core/sniff","./core/lang","./core/urlUtils","./core/deferredUtils","./core/promiseUtils","dojo/has!host-browser?./core/request/script","dojo/has!host-webworker?./core/workers/request"],function(e,r,t,n,o,s,a,i,l,u,c,d,f,h,p,g,m){function v(e){var r=a.objectToQuery(e.content);if(r&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+r),!f.isDataProtocol(e.url)&&e.url.length>2e3)return p.reject(n.mixin(new Error,{message:"When using responseType 'image', URL length cannot exceed 2000 characters."}));var o=new Image;e.allowImageDataAccess&&(e.withCredentials?o.crossOrigin="use-credentials":o.crossOrigin="anonymous");var s=!1,i=new t(function(e){s=!0,o.onload=o.onerror=o.onabort=null,o.src=""}),l=function(e){o.onload=o.onerror=o.onabort=null,s||i.reject(new Error("Unable to load the resource"))};return o.onload=function(){o.onload=o.onerror=o.onabort=null,s||i.resolve(this)},o.onerror=l,o.onabort=l,o.alt="",o.src=e.url,i.promise}function w(e){return e=new o(e),(e.host+(e.port?":"+e.port:"")).toLowerCase()}function b(){return P||(P=p.create(function(r){e(["./identity/IdentityManager"],r)}).then(function(e){S=e}))}function y(e,r){var o=!!e.useProxy,i=e.method||"auto",l=d.isDefined(e.crossOrigin)?e.crossOrigin:A.useCors;e=n.mixin({},e),e._ssl&&(e.url=e.url.replace(/^http:/i,"https:"));var u=e.content,h=e.url;e._token&&(e.content=e.content||{},e.content.token=e._token);var p,m=0;h&&(p=a.objectToQuery(u),m=p.length+h.length+1,c("esri-url-encodes-apostrophe")&&(m=p.replace(/'/g,"%27").length+h.length+1)),e.timeout=d.isDefined(e.timeout)?e.timeout:A.timeout,e.handleAs=e.handleAs||"json";try{var w,b,y=l&&f.canUseXhr(e.urlObj)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(e.url),C=f.hasSameOrigin(e.urlObj,f.appUrl)||y,_="post"===i||!!e.body||m>A.maxUrlLength,j=!C&&-1!==e.handleAs.indexOf("json")&&e.callbackParamName&&!e.body,O=!!f.getProxyRule(e.url)||A.forceProxy||o||("image"!==e.handleAs||e.allowImageDataAccess)&&(!j||_)&&!C;if(O&&(f.isBlobProtocol(e.url)||f.isDataProtocol(e.url))&&(O=!1),(c("host-browser")||c("host-webworker"))&&O)if(w=f.getProxyUrl(h,l),b=w.path,w._xo&&(y=!0),!_&&b.length+1+m>A.maxUrlLength&&(_=!0),e.url=b+"?"+h,_)e.content=n.mixin(w.query||{},u);else{var x=a.objectToQuery(n.mixin(w.query||{},u));x&&(e.url+=(-1===h.indexOf("?")?"?":"&")+x),e.content=null}if(j&&!_&&!O&&c("host-browser"))return e=D?D(e):e,e.jsonp=e.callbackParamName,e.query=e.content,g.get(e.url,e);var k=e.headers;if(!c("host-browser")&&!c("host-webworker")||k&&k.hasOwnProperty("X-Requested-With")||(k=e.headers=k||{},k["X-Requested-With"]=null),c("host-browser")&&r){var q=e.content&&e.content.token;q&&(r.set?r.set("token",q):r.append("token",q)),e.contentType=!1}if(y&&!e.hasOwnProperty("withCredentials")&&"with-credentials"===A.useCors){var P=O?b:h,T=f.getCorsConfig(P);if(T&&T.hasOwnProperty("withCredentials"))T.withCredentials&&(e.withCredentials=!0);else if(S){var I=S.findServerInfo(P);I&&I.webTierAuth&&(e.withCredentials=!0)}}return e=D?D(e):e,"image"===e.handleAs?v(e):_?(e.body?(e.data=r||e.body,e.query=e.content):e.data=e.content,delete e.body,delete e.content,!O&&c("safari")&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+"_ts="+(new Date).getTime()+U++),s.post(e.url,e)):(e.query=e.content,delete e.content,s.get(e.url,e))}catch(e){var L=new t;return L.reject(e),L.promise}}function C(e){var n=A.corsStatus,o=f.getCorsConfig(e,!0);o>-1&&A.corsEnabledServers.splice(o,1);var s=new t;return s.reject({log:!!r.isDebug}),n[w(e)]=s.promise,o}function _(e){var r=A.corsStatus;try{var n=w(e.url);if(A.corsDetection&&A.useCors&&c("esri-cors")&&e.url&&-1!==e.url.toLowerCase().indexOf("/rest/services")&&!f.hasSameOrigin(e.urlObj,f.appUrl)&&!f.canUseXhr(e.urlObj)){if(r[n])return r[n];var o=new t;r[n]=o.promise;var a=e.url.substring(0,e.url.toLowerCase().indexOf("/rest/")+"/rest/".length)+"info";return s.get(a,{query:{f:"json"},handleAs:"json",headers:{"X-Requested-With":null},timeout:1e3*A.corsDetectionTimeout}).then(function(r){r?(f.canUseXhr(e.url)||A.corsEnabledServers.push(n),o.resolve()):o.reject()},function(e){o.reject()}),o.promise}}catch(e){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}return L}function j(e){D=e}function O(e,r,o,s){function a(e){e&&(o._token=e.token,o._ssl=e.ssl)}function i(e){e._pendingDfd=y(o,p);var r=!!e._pendingDfd.response;(e._pendingDfd.response||e._pendingDfd).then(function(e){if(!r||!e.data)return e;var o=e.getHeader("Content-Type");if(o&&(o=o.toLowerCase(),-1===o.indexOf("text/plain")&&-1===o.indexOf("application/json")))return e;var s,a=e.data;if(a instanceof ArrayBuffer&&a.byteLength<=750)s=new Blob([a]);else{if(!(a instanceof Blob&&a.size<=750))return e;s=a}var i=new t,l=new FileReader;return l.readAsText(s),l.onloadend=function(){if(!l.error)try{var r=JSON.parse(l.result);r.error&&(Object.isExtensible(e)||(e=n.mixin({},e)),e._jsonData=r)}catch(e){}i.resolve(e)},i.promise}).then(function(t){var o=r?t.data:t,a=r?t.getHeader.bind(t):I;if(o){var i=r&&t._jsonData||o;if(i.error||"error"===i.status){var l=n.mixin(new Error,i.error||i);throw l.getHeader=a,l}}e.resolve({data:o,url:s.url,requestOptions:s.requestOptions,getHeader:a}),e._pendingDfd=null}).catch(function(r){var t,n,a;if(r&&(t=r.code,n=r.subcode,a=r.messageCode,a=a&&a.toUpperCase()),r&&403==t&&(4==n||r.message&&r.message.toLowerCase().indexOf("ssl")>-1&&-1===r.message.toLowerCase().indexOf("permission"))){if(!o._ssl)return o._ssl=o._sslFromServer=!0,void O(e,!0,o,s)}else if(r&&415==r.status){if(C(o.url),!o._err415)return o._err415=1,void O(e,!0,o,s)}else if(h&&"no-prompt"!==o.authMode&&S._errorCodes&&-1!==S._errorCodes.indexOf(t)&&!S._isPublic(o.url)&&(403!=t||T&&-1===T.indexOf(a)&&(!d.isDefined(n)||2==n&&o._token)))return void x(e,o,s,k("request:server",r,s));e.reject(k("request:server",r,s)),e._pendingDfd=null})}var u,c=o.body,h=o.useIdentity,p=null,g=c instanceof FormData;(g||c&&c.elements)&&(p=g?c:new FormData(c));var m=!!(-1!==o.url.toLowerCase().indexOf("token=")||o.content&&o.content.token||p&&p.get&&p.get("token")||c&&c.elements&&c.elements.token);return r||(!h||m||o._token||S._isPublic(o.url)||("immediate"===o.authMode?u=S.getCredential(o.url).then(a):"no-prompt"===o.authMode?u=S.checkSignInStatus(o.url).then(a).catch(function(){}):a(S.findCredential(o.url))),e.then(function(e){if((/\/sharing\/rest\/accounts\/self/i.test(o.url)||/\/sharing\/rest\/portals\/self/i.test(o.url))&&!m&&!o._token&&e.user&&e.user.username){var r=A.corsEnabledServers,t=f.getCorsConfig(o.url,!0),n={host:w(o.url),withCredentials:!0};if(-1===t)r.push(n);else{var s=r[t];"object"==typeof s?s.withCredentials=!0:r.splice(t,1,n)}}var a=o._credential;if(a){var i,l=S.findServerInfo(a.server),u=l&&l.owningSystemUrl;u&&(u=u.replace(/\/?$/,"/sharing"),(i=S.findCredential(u,a.userId))&&-1===S._getIdenticalSvcIdx(u,i)&&i.resources.splice(0,0,u))}return e}).always(function(e){if(delete o._credential,e){var r=!!o._ssl;e instanceof l?e.details.ssl=r:e.ssl=r}})),u?u.then(function(){i(e)}).catch(function(r){e.reject(r)}):i(e),e.promise}function x(e,r,t,n){e._pendingDfd=S.getCredential(r.url,{error:n,token:r._token}),e._pendingDfd.then(function(n){r._token=n.token,r._credential=n,r._ssl=r._sslFromServer||n.ssl,O(e,!0,r,t)}).catch(function(r){e.reject(r),e._pendingDfd=null})}function k(e,r,t){var n="Error",o={url:t.url,requestOptions:t.requestOptions,getHeader:I};if(r instanceof l)return r.details?(r.details=d.clone(r.details),r.details.url=t.url,r.details.requestOptions=t.requestOptions):r.details=o,r;if(r){var s=r.response,a=s&&s.getHeader,i=s&&s.status,u=r.message,c=r.getHeader||a;u&&(n=u),c&&(o.getHeader=c),o.httpStatus=(d.isDefined(r.httpCode)?r.httpCode:r.code)||i,o.subCode=r.subcode,o.messageCode=r.messageCode,"string"==typeof r.details?o.messages=[r.details]:o.messages=r.details}var f=new l(e,n,o);return r&&"cancel"===r.dojoType&&(f.dojoType="cancel"),f}function q(e,r){if(m&&u.invokeStaticMessage)return m.execute(e,r);var t=n.mixin({},r),s={url:e,requestOptions:n.mixin({},r)};if(t.content=t.query,delete t.query,t.preventCache=!!t.cacheBust,delete t.cacheBust,t.handleAs=t.responseType,delete t.responseType,"array-buffer"===t.handleAs&&(t.handleAs="arraybuffer"),"image"===t.handleAs){if(c("host-webworker")||c("host-node"))return p.reject(k("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),s));t.preventCache&&(t.content=t.content||{},t.content["request.preventCache"]=Date.now()),t.method="auto"}else if(f.isDataProtocol(e))return p.reject(k("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+t.handleAs),s));var a=A.useIdentity;"anonymous"===t.authMode&&(a=!1),t.useIdentity=a,t.url=f.normalize(e),t.urlObj=new o(t.url);var i=h.makeDeferredCancellingPending();return _(t).always(function(){if(a&&!S)return b()}).always(function(){O(i,!1,t,s)}),i.promise}var D,S,P,A=i.request,T=["COM_0056","COM_0057"],U=0,I=function(){return null},L=(new t).resolve();return q.setRequestPreCallback=j,q});