// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["require","dojo/_base/array","dojo/_base/config","dojo/_base/Deferred","dojo/_base/lang","dojo/_base/url","dojo/_base/xhr","dojo/io/script","dojo/io/iframe","dojo/dom-construct","dojo/io-query","./kernel","./config","./sniff","./lang","./urlUtils","./deferredUtils"],function(e,r,n,t,s,i,o,a,l,d,u,c,f,p,h,g,_){function m(e){return e=new i(e),(e.host+(e.port?":"+e.port:"")).toLowerCase()}function k(e){return this._xhr?this._xhr.getResponseHeader(e):null}function w(e,i,f,_){var m,k=!1,w=!1;h.isDefined(i)&&(s.isObject(i)?(k=!!i.useProxy,w=!!i.usePost,m=i.crossOrigin):k=!!i),e=s.mixin({},e),e._ssl&&(e.url=e.url.replace(/^http:/i,"https:")),p("ie")<10&&!S.test(e.url)&&(e.url=encodeURI(e.url));var b=e.content,v=e.url,C=f&&e.form,D=y;m=h.isDefined(m)?m:D.useCors,e.load=function(e){var r;return e&&(e.error?(r=s.mixin(new Error,e.error),r.log=n.isDebug):"error"===e.status&&(r=s.mixin(new Error,e),r.log=n.isDebug),r&&!h.isDefined(r.httpCode)&&(r.httpCode=r.code)),r||e},e.error=function(e,r){return r&&r.xhr&&r.xhr.abort(),e instanceof Error||(e=s.mixin(new Error,e)),e.log=n.isDebug,D.errorHandler(e,r),e},e._token&&(e.content=e.content||{},e.content.token=e._token);var O,j=0;b&&v&&(O=u.objectToQuery(b),j=O.length+v.length+1,p("esri-url-encodes-apostrophe")&&(j=O.replace(/'/g,"%27").length+v.length+1)),e.timeout=h.isDefined(e.timeout)?e.timeout:D.timeout,e.handleAs=e.handleAs||"json";try{var E,P,U=m&&g.canUseXhr(e.url)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(e.url),q=g.hasSameOrigin(e.url,window.location.href)||U,L=w||f||j>D.postLength?!0:!1,R=q||-1===e.handleAs.indexOf("json")||!e.callbackParamName||f?!1:!0,X=g.getProxyRule(e.url)||D.alwaysUseProxy||k||(!R||L)&&!q?!0:!1;if(f&&!p("esri-file-upload")&&!X&&U&&(X=!0),X)if(E=g.getProxyUrl(v,m),P=E.path,E._xo&&(U=!0),!L&&P.length+1+j>D.postLength&&(L=!0),e.url=P+"?"+v,L)e.content=s.mixin(E.query||{},b);else{var F=u.objectToQuery(s.mixin(E.query||{},b));F&&(e.url+="?"+F),e.content=null}if(R&&!L)return!h.isDefined(e.isAsync)&&p("ff")<4&&(e.isAsync=!0),a.get(x?x(e):e);var I=e.headers;if(!U||I&&I.hasOwnProperty("X-Requested-With")||(I=e.headers=I||{},I["X-Requested-With"]=null),f){var T,W,H,N,M,Q=e.callbackParamName||"callback.html",$=e.callbackElementName||"textarea",B=C.elements?C.elements.length:0;if(b=e.content)for(T in b)if(H=b[T],h.isDefined(H)){for(W=null,N=0;B>N;N++)if(M=C.elements[N],M.name===T){W=M;break}W?W.value=H:_?C.append(T,H):C.appendChild(d.create("input",{type:"hidden",name:T,value:H}))}p("esri-file-upload")?(r.forEach(C.elements,function(e){e.name===Q&&C.removeChild(e)}),e.contentType=!1,e.postData=_?C:new FormData(C),delete e.form):(C.enctype="multipart/form-data",p("ie")<9&&(C.encoding="multipart/form-data"),C.method="post",r.some(C.elements,function(e){return e.name===Q})||C.appendChild(d.create("input",{type:"hidden",name:Q,value:$})),(-1!==v.toLowerCase().indexOf("addattachment")||-1!==v.toLowerCase().indexOf("updateattachment"))&&(e.url=v+(-1===v.indexOf("?")?"?":"&")+Q+"="+$,X&&(e.url=P+"?"+e.url)),delete e.content)}if(U&&!e.hasOwnProperty("withCredentials")&&"with-credentials"===y.useCors){var z=X?P:v,G=g.canUseXhr(z,!0),J=G>-1?y.corsEnabledServers[G]:null;if(J&&J.hasOwnProperty("withCredentials"))J.withCredentials&&(e.withCredentials=!0);else if(c.id){var K=c.id.findServerInfo(z);K&&K.webTierAuth&&(e.withCredentials=!0)}}return e=x?x(e):e,L?f&&!p("esri-file-upload")?l.send(e):(!X&&p("safari")&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+"_ts="+(new Date).getTime()+A++),o.post(e)):o.get(e)}catch(V){var Y=new t;return Y.errback(e.error(V)),Y}}function b(e){var r=y.corsStatus,n=g.canUseXhr(e,!0);return n>-1&&y.corsEnabledServers.splice(n,1),r[m(e)]=1,n}function v(e){var r=y.corsStatus;if(y.corsDetection&&y.useCors)try{var n=m(e);!p("esri-cors")||!e||-1===e.toLowerCase().indexOf("/rest/services")||g.hasSameOrigin(e,window.location.href)||g.canUseXhr(e)||r[n]||(r[n]=-1,o.get({url:e.substring(0,e.toLowerCase().indexOf("/rest/")+"/rest/".length)+"info",content:{f:"json"},failOk:!0,handleAs:"json",headers:{"X-Requested-With":null}}).then(function(t){t?(r[n]=2,g.canUseXhr(e)||y.corsEnabledServers.push(n)):r[n]=1},function(e){r[n]=1}))}catch(t){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}}function C(e){x=e}function D(s,i){function a(e){if(e._pendingDfd=w(s,i,S,A),!e._pendingDfd){e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs;var t=new Error("Deferred object is missing");return t.log=n.isDebug,s._usrDfd=null,e.errback(t),e._pendingDfd=null,e}e._pendingDfd.addCallback(function(r){e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs,s._usrDfd=null,i.returnFullResponse&&(r={data:r,_xhr:e.ioArgs&&e.ioArgs.xhr,getHeader:k}),e.callback(r),e._pendingDfd=null}).addErrback(function(n){var t,o,a;if(n&&(t=n.code,o=n.subcode,a=n.messageCode,a=a&&a.toUpperCase()),n&&403==t&&(4==o||n.message&&n.message.toLowerCase().indexOf("ssl")>-1&&-1===n.message.toLowerCase().indexOf("permission"))){if(!s._ssl)return s._ssl=s._sslFromServer=!0,s._usrDfd=e,void D(s,i)}else if(n&&415==n.status){if(b(s.url),!s._err415)return s._err415=1,s._usrDfd=e,void D(s,i)}else if(c.id&&-1!==r.indexOf(c.id._errorCodes,t)&&!c.id._isPublic(s.url)&&!u&&(403!=t||-1===r.indexOf(j,a)&&(!h.isDefined(o)||2==o&&s._token)))return e._pendingDfd=c.id.getCredential(s.url,{token:s._token,error:n}),void e._pendingDfd.addCallback(function(r){s._token=r.token,s._usrDfd=e,s._credential=r,s._ssl=s._sslFromServer||r.ssl,D(s,i)}).addErrback(function(r){s._usrDfd=null,e.errback(r),e._pendingDfd=null});e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs,s._usrDfd=null,e.errback(n),e._pendingDfd=null})}s.url=g.fixUrl(s.url),i=i||{};var l,d=s.form,u=i.disableIdentityLookup,f=i._preLookup,C=!1;if(p("esri-workers")&&y.useWorkers!==!1)if(i.useWorkers===!0||y.useWorkers===!0)C=!0;else if(i.workerOptions){var x=i.workerOptions;(x.callback||x.worker&&x.worker.worker instanceof Worker)&&(C=!0)}var A=d&&p("esri-file-upload")&&d instanceof FormData,S=d&&(d.elements?r.some(d.elements,function(e){return"file"===e.type}):A),E=-1!==s.url.toLowerCase().indexOf("token=")||s.content&&s.content.token||S&&r.some(d.elements,function(e){return"token"===e.name})?1:0;if(v(s.url),s._usrDfd)l=s._usrDfd;else{l=new t(_._dfdCanceller),l.addCallback(function(e){if((/\/sharing\/rest\/accounts\/self/i.test(s.url)||/\/sharing\/rest\/portals\/self/i.test(s.url))&&!E&&!s._token&&e.user&&e.user.username){y.webTierAuthServers.push(m(s.url));var r=y.corsEnabledServers,n=g.canUseXhr(s.url,!0),t={host:m(s.url),withCredentials:!0};if(-1===n)r.push(t);else{var i=r[n];"object"==typeof i?i.withCredentials=!0:r.splice(n,1,t)}}var o=s._credential;if(o){var a,l=c.id.findServerInfo(o.server),d=l&&l.owningSystemUrl;d&&(d=d.replace(/\/?$/,"/sharing"),a=c.id.findCredential(d,o.userId),a&&-1===c.id._getIdenticalSvcIdx(d,a)&&a.resources.splice(0,0,d))}}),l.addBoth(function(e){delete s._credential,!e||p("ie")&&e.nodeType||(e._ssl=s._ssl)});var P=s.load,U=s.error;P&&l.addCallback(function(e){var r=l._pendingDfd,n=r&&r.ioArgs,t=n&&n.args;return P.call(t,e,n)}),U&&l.addErrback(function(e){var r=l._pendingDfd,n=r&&r.ioArgs,t=n&&n.args;return U.call(t,e,n)})}if(c.id&&!E&&!s._token&&!c.id._isPublic(s.url)&&(!u||f)){var q=c.id.findCredential(s.url);q&&(s._token=q.token,s._ssl=q.ssl)}return C?i.workerOptions&&i.workerOptions.worker?(O||(O=o),o=i.workerOptions.worker,a(l)):e(["./workers/RequestClient"],function(e){if(O||(O=o),i.workerOptions){var r=i.workerOptions;o=e.getClient(r.callback,r.cbFunction)}else o=e.getClient();a(l)}):(O&&(o=O,O=null),a(l)),l}var x,O=null,y=f.defaults.io,j=["COM_0056","COM_0057"],A=0,S=/%[0-9A-F]{2}/i;return D._request=w,D._disableCors=b,D._detectCors=v,D.setRequestPreCallback=C,p("extend-esri")&&(c.request=D,c._request=w,c._disableCors=b,c._detectCors=v,c.setRequestPreCallback=C),D});