// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","dojo/_base/array","dojo/_base/config","dojo/_base/Deferred","dojo/_base/lang","dojo/_base/url","dojo/_base/xhr","./core/request/script","dojo/request/iframe","dojo/dom-construct","dojo/io-query","./kernel","./config","./sniff","./lang","./urlUtils","./deferredUtils"],function(e,r,n,t,o,i,s,a,l,d,u,c,f,g,h,p,m){function k(e){return e=new i(e),(e.host+(e.port?":"+e.port:"")).toLowerCase()}function w(e){return this._xhr?this._xhr.getResponseHeader(e):null}function _(e,r){var n=u.objectToQuery(e.content);if(n&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+n),e.url.length>2e3){var i;if("data:"!==e.url.toLowerCase().slice(0,5))return i=new t,i.reject(o.mixin(new Error,{message:"When using responseType 'image', URL length cannot exceed 2000 characters."})),i;if(e.url.length>3e6)return i=new t,i.reject(o.mixin(new Error,{message:"When using responseType 'image', data URL length cannot exceed 3000000 characters."})),i}var s=new Image;r.allowImageDataAccess&&(e.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous");var a=!1,l=new t(function(e){a=!0,s.onload=s.onerror=s.onabort=null,s.src=""}),d=function(e){s.onload=s.onerror=s.onabort=null,a||l.reject(new Error("Unable to load the resource"))};return s.onload=function(){s.onload=s.onerror=s.onabort=null,a||l.resolve(this)},s.onerror=d,s.onabort=d,s.alt="",s.src=e.url,l}function v(e,i,f,m){var k,w,v=!1,b=!1;h.isDefined(i)&&(o.isObject(i)?(v=!!i.useProxy,b=!!i.usePost,k=i.crossOrigin):v=!!i),e=o.mixin({},e),e._ssl&&(e.url=e.url.replace(/^http:/i,"https:")),g("ie")<10&&!R.test(e.url)&&(e.url=encodeURI(e.url));var C=e.content,x=e.url,D=f&&e.form,O=A;k=h.isDefined(k)?k:O.useCors,e.load=function(r){var t;return r&&(r.error?(t=o.mixin(new Error,r.error),t.log=!!n.isDebug):"error"===r.status&&(t=o.mixin(new Error,r),t.log=!!n.isDebug),t&&(e.failOk=!t.log,h.isDefined(t.httpCode)||(t.httpCode=t.code))),t||r},e.error=function(r,t){return t&&t.xhr&&t.xhr.abort(),r instanceof Error||(r=o.mixin(new Error,r)),r.log=!!n.isDebug,e.failOk=!r.log,O.errorHandler(r,t),r},e._token&&(e.content=e.content||{},e.content.token=e._token);var j,E=0;C&&x&&(j=u.objectToQuery(C),E=j.length+x.length+1,g("esri-url-encodes-apostrophe")&&(E=j.replace(/'/g,"%27").length+x.length+1)),e.timeout=h.isDefined(e.timeout)?e.timeout:O.timeout,e.handleAs=e.handleAs||"json";try{var U,L,S=k&&p.canUseXhr(e.url)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(e.url),P=p.hasSameOrigin(e.url,window.location.href)||S,T=!!(b||f||E>O.postLength),I=!(P||-1===e.handleAs.indexOf("json")||!e.callbackParamName||f),F=!(!(p.getProxyRule(e.url)||O.alwaysUseProxy||v)&&("image"===e.handleAs&&!i.allowImageDataAccess||I&&!T||P));if(f&&!g("esri-file-upload")&&!F&&S&&(F=!0),F)if(U=p.getProxyUrl(x,k),L=U.path,U._xo&&(S=!0),!T&&L.length+1+E>O.postLength&&(T=!0),e.url=L+"?"+x,T)e.content=o.mixin(U.query||{},C);else{var W=u.objectToQuery(o.mixin(U.query||{},C));W&&(e.url+="?"+W),e.content=null}if(!I||T||F){var X=e.headers;if(!S||X&&X.hasOwnProperty("X-Requested-With")||(X=e.headers=X||{},X["X-Requested-With"]=null),f){var N,H,Q,M,$,B=e.callbackParamName||"callback.html",z=e.callbackElementName||"textarea",G=D.elements?D.elements.length:0;if(C=e.content){C.token&&x.toLowerCase().indexOf("/sharing/servers/")>-1&&(x+=(-1===x.indexOf("?")?"?":"&")+"token="+C.token,e.url=F?L+"?"+x:x,delete C.token);for(N in C)if(Q=C[N],h.isDefined(Q)){for(H=null,M=0;M<G;M++)if($=D.elements[M],$.name===N){H=$;break}H?H.value=Q:m?D.append(N,Q):D.appendChild(d.create("input",{type:"hidden",name:N,value:Q}))}}if(g("esri-file-upload")){r.forEach(D.elements,function(e){e.name===B&&D.removeChild(e)});var J=m?D:new FormData(D);if(g("safari")>11&&"entries"in J&&"delete"in J){for(var K=[],V=J.entries(),Y=V.next();!Y.done;){var Z=Y.value;Z[1]instanceof File&&""===Z[1].name&&K.push(Z[0]),Y=V.next()}K.forEach(function(e){J.delete(e)})}e.contentType=!1,e.postData=J,delete e.form}else D.enctype="multipart/form-data",g("ie")<9&&(D.encoding="multipart/form-data"),D.method="post",r.some(D.elements,function(e){return e.name===B})||D.appendChild(d.create("input",{type:"hidden",name:B,value:z})),-1===x.toLowerCase().indexOf("addattachment")&&-1===x.toLowerCase().indexOf("updateattachment")||(x+=(-1===x.indexOf("?")?"?":"&")+B+"="+z,e.url=F?L+"?"+x:x),delete e.content}if(S&&!e.hasOwnProperty("withCredentials")&&"with-credentials"===A.useCors){var ee=F?L:x,re=p.canUseXhr(ee,!0),ne=re>-1?A.corsEnabledServers[re]:null;if(ne&&ne.hasOwnProperty("withCredentials"))ne.withCredentials&&(e.withCredentials=!0);else if(c.id){var te=c.id.findServerInfo(ee);te&&te.webTierAuth&&(e.withCredentials=!0)}}if(e=y?y(e):e,"image"===e.handleAs)return _(e,i);if(T){if(f&&!g("esri-file-upload")){w=new t(function(){oe.cancel()});var oe=l.post(e.url,e).then(function(e){w.resolve(e)}).otherwise(function(e){w.reject(e)});return w.addCallback(function(r){return e.load(r)}),w.addErrback(function(r){return e.error(r)}),w}return!F&&g("safari")&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+"_ts="+(new Date).getTime()+q++),s.post(e)}return s.get(e)}e=y?y(e):e,e.jsonp=e.callbackParamName,e.query=e.content,w=new t(function(){ie.cancel()});var ie=a.get(e.url,e).then(function(e){w.resolve(e)}).otherwise(function(e){w.reject(e)});return w.addCallback(function(r){return e.load(r)}),w.addErrback(function(r){return e.error(r)}),w}catch(r){return w=new t,w.errback(e.error(r)),w}}function b(e){var r=A.corsStatus,o=p.canUseXhr(e,!0);o>-1&&A.corsEnabledServers.splice(o,1);var i=new t;return i.reject({log:!!n.isDebug}),r[k(e)]=i.promise,o}function C(e){var r=A.corsStatus;try{var n=k(e);if(A.corsDetection&&A.useCors&&g("esri-cors")&&e&&-1!==e.toLowerCase().indexOf("/rest/services")&&!p.hasSameOrigin(e,window.location.href)&&!p.canUseXhr(e)){if(r[n]&&!r[n].isCanceled())return r[n];var o=new t(m._dfdCanceller);r[n]=o.promise;var i=s.get({url:e.substring(0,e.toLowerCase().indexOf("/rest/")+"/rest/".length)+"info",content:{f:"json"},failOk:!0,handleAs:"json",headers:{"X-Requested-With":null},timeout:1e3*A.corsDetectionTimeout});return o._pendingDfd=i,i.then(function(r){r?(p.canUseXhr(e)||A.corsEnabledServers.push(n),o.resolve()):o.reject()},function(e){o.reject(e)}),o.promise}}catch(e){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}return U}function x(e){y=e}function D(t,o,i,a){function l(e){if(e._pendingDfd=v(i,a,x,C),!e._pendingDfd){e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs;var t=new Error("Deferred object is missing");return t.log=!!n.isDebug,e.errback(t),e._pendingDfd=null,e}e._pendingDfd.addCallback(function(r){e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs,a.returnFullResponse&&(r={data:r,_xhr:e.ioArgs&&e.ioArgs.xhr,getHeader:w}),e.callback(r),e._pendingDfd=null}).addErrback(function(n){var t,o,s;if(n&&(t=n.code,o=n.subcode,s=n.messageCode,s=s&&s.toUpperCase()),n&&403==t&&(4==o||n.message&&n.message.toLowerCase().indexOf("ssl")>-1&&-1===n.message.toLowerCase().indexOf("permission"))){if(!i._ssl)return i._ssl=i._sslFromServer=!0,void D(e,!0,i,a)}else if(n&&415==n.status){if(b(i.url),!i._err415)return i._err415=1,void D(e,!0,i,a)}else if(c.id&&-1!==r.indexOf(c.id._errorCodes,t)&&!c.id._isPublic(i.url)&&!u&&(403!=t||-1===r.indexOf(E,s)&&(!h.isDefined(o)||2==o&&i._token)))return e._pendingDfd=c.id.getCredential(i.url,{token:i._token,error:n}),void e._pendingDfd.addCallback(function(r){i._token=r.token,i._credential=r,i._ssl=i._sslFromServer||r.ssl,D(e,!0,i,a)}).addErrback(function(r){e.errback(r),e._pendingDfd=null});e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs,e.isFulfilled()||e.errback(n),e._pendingDfd=null})}var d=i.form,u=a.disableIdentityLookup,f=a._preLookup,m=!1;if(g("esri-workers")&&!1!==A.useWorkers)if(!0===a.useWorkers||!0===A.useWorkers)m=!0;else if(a.workerOptions){var _=a.workerOptions;(_.callback||_.worker&&_.worker.worker instanceof Worker)&&(m=!0)}var C=d&&g("esri-file-upload")&&d instanceof FormData,x=d&&(d.elements?r.some(d.elements,function(e){return"file"===e.type}):C),O=-1!==i.url.toLowerCase().indexOf("token=")||i.content&&i.content.token||x&&r.some(d.elements,function(e){return"token"===e.name})?1:0;if(!o){t.addCallback(function(e){if((/\/sharing\/rest\/accounts\/self/i.test(i.url)||/\/sharing\/rest\/portals\/self/i.test(i.url))&&!O&&!i._token&&e.user&&e.user.username){A.webTierAuthServers.push(k(i.url));var r=A.corsEnabledServers,n=p.canUseXhr(i.url,!0),t={host:k(i.url),withCredentials:!0};if(-1===n)r.push(t);else{var o=r[n];"object"==typeof o?o.withCredentials=!0:r.splice(n,1,t)}}var s=i._credential;if(s){var a,l=c.id.findServerInfo(s.server),d=l&&l.owningSystemUrl;d&&(d=d.replace(/\/?$/,"/sharing"),(a=c.id.findCredential(d,s.userId))&&-1===c.id._getIdenticalSvcIdx(d,a)&&a.resources.splice(0,0,d))}}),t.addBoth(function(e){delete i._credential,!e||g("ie")&&e.nodeType||(e._ssl=i._ssl)});var y=i.load,q=i.error;y&&t.addCallback(function(e){var r=t._pendingDfd,n=r&&r.ioArgs,o=n&&n.args;return y.call(o,e,n)}),q&&t.addErrback(function(e){var r=t._pendingDfd,n=r&&r.ioArgs,o=n&&n.args;return q.call(o,e,n)})}if(c.id&&!O&&!i._token&&!c.id._isPublic(i.url)&&(!u||f)){var R=c.id.findCredential(i.url);R&&(i._token=R.token,i._ssl=R.ssl)}return m?a.workerOptions&&a.workerOptions.worker?(j||(j=s),s=a.workerOptions.worker,l(t)):e(["./workers/RequestClient"],function(e){if(j||(j=s),a.workerOptions){var r=a.workerOptions;s=e.getClient(r.callback,r.cbFunction)}else s=e.getClient();l(t)}):(j&&(s=j,j=null),l(t)),t}function O(e,r){e.url=p.fixUrl(e.url),r=r||{};var n=new t(m._dfdCanceller),o=C(e.url);return n._pendingDfd=o,o.always(function(t){t&&"cancel"===t.dojoType?n.reject(t):D(n,!1,e,r)}),n}var y,j=null,A=f.defaults.io,E=["COM_0056","COM_0057"],q=0,R=/%[0-9A-F]{2}/i,U=function(){var e=new t;return e.resolve(),e.promise}();return O._makeRequest=v,O._processRequest=D,O._disableCors=b,O._detectCors=C,O.setRequestPreCallback=x,g("extend-esri")&&(c.request=O,c._makeRequest=v,c._processRequest=D,c._disableCors=b,c._detectCors=C,c.setRequestPreCallback=x),O});