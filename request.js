// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["require","dojo/_base/array","dojo/_base/config","dojo/_base/Deferred","dojo/_base/lang","dojo/_base/url","dojo/_base/xhr","./core/request/script","dojo/request/iframe","dojo/dom-construct","dojo/io-query","./kernel","./config","./sniff","./lang","./urlUtils","./deferredUtils"],function(e,r,n,t,o,i,s,a,l,d,u,c,f,p,h,g,m){function k(e){return e=new i(e),(e.host+(e.port?":"+e.port:"")).toLowerCase()}function _(e){return this._xhr?this._xhr.getResponseHeader(e):null}function w(e,i,f,m){var k,_,w=!1,v=!1;h.isDefined(i)&&(o.isObject(i)?(w=!!i.useProxy,v=!!i.usePost,k=i.crossOrigin):w=!!i),e=o.mixin({},e),e._ssl&&(e.url=e.url.replace(/^http:/i,"https:")),p("ie")<10&&!E.test(e.url)&&(e.url=encodeURI(e.url));var b=e.content,C=e.url,x=f&&e.form,D=j;k=h.isDefined(k)?k:D.useCors,e.load=function(r){var t;return r&&(r.error?(t=o.mixin(new Error,r.error),t.log=!!n.isDebug):"error"===r.status&&(t=o.mixin(new Error,r),t.log=!!n.isDebug),t&&(e.failOk=!t.log,h.isDefined(t.httpCode)||(t.httpCode=t.code))),t||r},e.error=function(e,r){return r&&r.xhr&&r.xhr.abort(),e instanceof Error||(e=o.mixin(new Error,e)),e.log=!!n.isDebug,D.errorHandler(e,r),e},e._token&&(e.content=e.content||{},e.content.token=e._token);var y,q=0;b&&C&&(y=u.objectToQuery(b),q=y.length+C.length+1,p("esri-url-encodes-apostrophe")&&(q=y.replace(/'/g,"%27").length+C.length+1)),e.timeout=h.isDefined(e.timeout)?e.timeout:D.timeout,e.handleAs=e.handleAs||"json";try{var S,P,R=k&&g.canUseXhr(e.url)&&!/https?:\/\/[^\/]+\/[^\/]+\/admin\/?(\/.*)?$/i.test(e.url),U=g.hasSameOrigin(e.url,window.location.href)||R,L=v||f||q>D.postLength?!0:!1,X=U||-1===e.handleAs.indexOf("json")||!e.callbackParamName||f?!1:!0,T=g.getProxyRule(e.url)||D.alwaysUseProxy||w||(!X||L)&&!U?!0:!1;if(f&&!p("esri-file-upload")&&!T&&R&&(T=!0),T)if(S=g.getProxyUrl(C,k),P=S.path,S._xo&&(R=!0),!L&&P.length+1+q>D.postLength&&(L=!0),e.url=P+"?"+C,L)e.content=o.mixin(S.query||{},b);else{var F=u.objectToQuery(o.mixin(S.query||{},b));F&&(e.url+="?"+F),e.content=null}if(!X||L||T){var I=e.headers;if(!R||I&&I.hasOwnProperty("X-Requested-With")||(I=e.headers=I||{},I["X-Requested-With"]=null),f){var W,N,H,M,Q,$=e.callbackParamName||"callback.html",B=e.callbackElementName||"textarea",z=x.elements?x.elements.length:0;if(b=e.content){b.token&&C.toLowerCase().indexOf("/sharing/servers/")>-1&&(C+=(-1===C.indexOf("?")?"?":"&")+"token="+b.token,T?e.url=P+"?"+C:e.url=C,delete b.token);for(W in b)if(H=b[W],h.isDefined(H)){for(N=null,M=0;z>M;M++)if(Q=x.elements[M],Q.name===W){N=Q;break}N?N.value=H:m?x.append(W,H):x.appendChild(d.create("input",{type:"hidden",name:W,value:H}))}}p("esri-file-upload")?(r.forEach(x.elements,function(e){e.name===$&&x.removeChild(e)}),e.contentType=!1,e.postData=m?x:new FormData(x),delete e.form):(x.enctype="multipart/form-data",p("ie")<9&&(x.encoding="multipart/form-data"),x.method="post",r.some(x.elements,function(e){return e.name===$})||x.appendChild(d.create("input",{type:"hidden",name:$,value:B})),(-1!==C.toLowerCase().indexOf("addattachment")||-1!==C.toLowerCase().indexOf("updateattachment"))&&(C+=(-1===C.indexOf("?")?"?":"&")+$+"="+B,T?e.url=P+"?"+C:e.url=C),delete e.content)}if(R&&!e.hasOwnProperty("withCredentials")&&"with-credentials"===j.useCors){var G=T?P:C,J=g.canUseXhr(G,!0),K=J>-1?j.corsEnabledServers[J]:null;if(K&&K.hasOwnProperty("withCredentials"))K.withCredentials&&(e.withCredentials=!0);else if(c.id){var V=c.id.findServerInfo(G);V&&V.webTierAuth&&(e.withCredentials=!0)}}if(e=O?O(e):e,L){if(f&&!p("esri-file-upload")){_=new t(function(){Y.cancel()});var Y=l.post(e.url,e).then(function(e){_.resolve(e)}).otherwise(function(e){_.reject(e)});return _.addCallback(function(r){return e.load(r)}),_.addErrback(function(r){return e.error(r)}),_}return!T&&p("safari")&&(e.url+=(-1===e.url.indexOf("?")?"?":"&")+"_ts="+(new Date).getTime()+A++),s.post(e)}return s.get(e)}e=O?O(e):e,e.jsonp=e.callbackParamName,e.query=e.content,_=new t(function(){Z.cancel()});var Z=a.get(e.url,e).then(function(e){_.resolve(e)}).otherwise(function(e){_.reject(e)});return _.addCallback(function(r){return e.load(r)}),_.addErrback(function(r){return e.error(r)}),_}catch(ee){return _=new t,_.errback(e.error(ee)),_}}function v(e){var r=j.corsStatus,o=g.canUseXhr(e,!0);o>-1&&j.corsEnabledServers.splice(o,1);var i=new t;return i.reject({log:!!n.isDebug}),r[k(e)]=i.promise,o}function b(e){var r=j.corsStatus;try{var n=k(e);if(j.corsDetection&&j.useCors&&p("esri-cors")&&e&&-1!==e.toLowerCase().indexOf("/rest/services")&&!g.hasSameOrigin(e,window.location.href)&&!g.canUseXhr(e)){if(r[n])return r[n];var o=new t;return r[n]=o.promise,s.get({url:e.substring(0,e.toLowerCase().indexOf("/rest/")+"/rest/".length)+"info",content:{f:"json"},failOk:!0,handleAs:"json",headers:{"X-Requested-With":null},timeout:1e3*j.corsDetectionTimeout}).then(function(r){r?(g.canUseXhr(e)||j.corsEnabledServers.push(n),o.resolve()):o.reject()},function(e){o.reject()}),o.promise}}catch(i){console.log("esri._detectCors: an unknown error occurred while detecting CORS support")}return S}function C(e){O=e}function x(t,o,i,a){function l(e){if(e._pendingDfd=w(i,a,D,C),!e._pendingDfd){e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs;var t=new Error("Deferred object is missing");return t.log=!!n.isDebug,e.errback(t),e._pendingDfd=null,e}e._pendingDfd.addCallback(function(r){e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs,a.returnFullResponse&&(r={data:r,_xhr:e.ioArgs&&e.ioArgs.xhr,getHeader:_}),e.callback(r),e._pendingDfd=null}).addErrback(function(n){var t,o,s;if(n&&(t=n.code,o=n.subcode,s=n.messageCode,s=s&&s.toUpperCase()),n&&403==t&&(4==o||n.message&&n.message.toLowerCase().indexOf("ssl")>-1&&-1===n.message.toLowerCase().indexOf("permission"))){if(!i._ssl)return i._ssl=i._sslFromServer=!0,void x(e,!0,i,a)}else if(n&&415==n.status){if(v(i.url),!i._err415)return i._err415=1,void x(e,!0,i,a)}else if(c.id&&-1!==r.indexOf(c.id._errorCodes,t)&&!c.id._isPublic(i.url)&&!u&&(403!=t||-1===r.indexOf(q,s)&&(!h.isDefined(o)||2==o&&i._token)))return e._pendingDfd=c.id.getCredential(i.url,{token:i._token,error:n}),void e._pendingDfd.addCallback(function(r){i._token=r.token,i._credential=r,i._ssl=i._sslFromServer||r.ssl,x(e,!0,i,a)}).addErrback(function(r){e.errback(r),e._pendingDfd=null});e.ioArgs=e._pendingDfd&&e._pendingDfd.ioArgs,e.errback(n),e._pendingDfd=null})}var d=i.form,u=a.disableIdentityLookup,f=a._preLookup,m=!1;if(p("esri-workers")&&j.useWorkers!==!1)if(a.useWorkers===!0||j.useWorkers===!0)m=!0;else if(a.workerOptions){var b=a.workerOptions;(b.callback||b.worker&&b.worker.worker instanceof Worker)&&(m=!0)}var C=d&&p("esri-file-upload")&&d instanceof FormData,D=d&&(d.elements?r.some(d.elements,function(e){return"file"===e.type}):C),O=-1!==i.url.toLowerCase().indexOf("token=")||i.content&&i.content.token||D&&r.some(d.elements,function(e){return"token"===e.name})?1:0;if(!o){t.addCallback(function(e){if((/\/sharing\/rest\/accounts\/self/i.test(i.url)||/\/sharing\/rest\/portals\/self/i.test(i.url))&&!O&&!i._token&&e.user&&e.user.username){j.webTierAuthServers.push(k(i.url));var r=j.corsEnabledServers,n=g.canUseXhr(i.url,!0),t={host:k(i.url),withCredentials:!0};if(-1===n)r.push(t);else{var o=r[n];"object"==typeof o?o.withCredentials=!0:r.splice(n,1,t)}}var s=i._credential;if(s){var a,l=c.id.findServerInfo(s.server),d=l&&l.owningSystemUrl;d&&(d=d.replace(/\/?$/,"/sharing"),a=c.id.findCredential(d,s.userId),a&&-1===c.id._getIdenticalSvcIdx(d,a)&&a.resources.splice(0,0,d))}}),t.addBoth(function(e){delete i._credential,!e||p("ie")&&e.nodeType||(e._ssl=i._ssl)});var A=i.load,E=i.error;A&&t.addCallback(function(e){var r=t._pendingDfd,n=r&&r.ioArgs,o=n&&n.args;return A.call(o,e,n)}),E&&t.addErrback(function(e){var r=t._pendingDfd,n=r&&r.ioArgs,o=n&&n.args;return E.call(o,e,n)})}if(c.id&&!O&&!i._token&&!c.id._isPublic(i.url)&&(!u||f)){var S=c.id.findCredential(i.url);S&&(i._token=S.token,i._ssl=S.ssl)}return m?a.workerOptions&&a.workerOptions.worker?(y||(y=s),s=a.workerOptions.worker,l(t)):e(["./workers/RequestClient"],function(e){if(y||(y=s),a.workerOptions){var r=a.workerOptions;s=e.getClient(r.callback,r.cbFunction)}else s=e.getClient();l(t)}):(y&&(s=y,y=null),l(t)),t}function D(e,r){e.url=g.fixUrl(e.url),r=r||{};var n=new t(m._dfdCanceller);return b(e.url).always(function(){x(n,!1,e,r)}),n}var O,y=null,j=f.defaults.io,q=["COM_0056","COM_0057"],A=0,E=/%[0-9A-F]{2}/i,S=function(){var e=new t;return e.resolve(),e.promise}();return D._makeRequest=w,D._processRequest=x,D._disableCors=v,D._detectCors=b,D.setRequestPreCallback=C,p("extend-esri")&&(c.request=D,c._makeRequest=w,c._processRequest=x,c._disableCors=v,c._detectCors=b,c.setRequestPreCallback=C),D});