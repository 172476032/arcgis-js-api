// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

//  copyright

/**
             * The copyright text as defined by the map service.
             *
             * @name copyright
             * @instance
             * @type {string}
             */

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/paramHelper","../core/accessorSupport/decorators","dojo/_base/lang","../Graphic","../PopupTemplate","../request","../core/MultiOriginJSONSupport","../core/Collection","../core/Error","../core/HandleRegistry","../core/Logger","../core/kebabDictionary","../core/lang","../core/promiseUtils","../core/requireUtils","../core/urlUtils","../geometry/Extent","../geometry/HeightModelInfo","../geometry/SpatialReference","../geometry/support/normalizeUtils","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","../symbols/support/jsonUtils","../symbols/support/ElevationInfo","../renderers/SimpleRenderer","../renderers/UniqueValueRenderer","../renderers/support/jsonUtils","../renderers/support/styleUtils","../renderers/support/typeUtils","../tasks/support/FeatureSet","../tasks/support/Query","./Layer","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./mixins/RefreshableLayer","./mixins/ArcGISService","./graphics/sources/MemorySource","./support/Field","./support/fieldUtils","./support/FeatureProcessing","./support/FeatureTemplate","./support/FeatureType","./support/FeatureReduction","./support/LabelClass","./support/labelingInfo","./support/arcgisLayerUrl","./support/commonProperties"],function(e,r,t,i,o,n,s,a,p,l,u,d,y,c,f,h,m,b,g,v,F,I,w,S,D,O,T,x,j,E,P,_,R,q,M,C,A,U,L,Q,B,G,V,k,z,W,Z,N,H,J,$,K,X){function Y(e){return e&&null!=e.applyEdits}function ee(e){return e&&e.isInstanceOf&&e.isInstanceOf(V)}function re(e){return e&&e.isInstanceOf&&e.isInstanceOf(d)}function te(e,r,t){return!!(e&&e.hasOwnProperty(r)?e[r]:t)}var ie=h({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),oe="FeatureLayer",ne=f.getLogger("esri.layers.FeatureLayer"),se=function(r){function u(e){var t=r.call(this)||this;return t.viewModulePaths={"2d":"../views/2d/layers/FeatureLayerView2D","3d":"../views/3d/layers/FeatureLayerView3D"},t._handles=new c,t.featureReduction=null,t.copyright=null,t.displayField=null,t.definitionExpression=null,t.editFieldsInfo=null,t.elevationInfo=null,t.fields=null,t.fullExtent=null,t.gdbVersion=null,t.geometryType=null,t.hasM=!1,t.hasZ=!1,t.heightModelInfo=null,t.isTable=!1,t.labelsVisible=!1,t.labelingInfo=null,t.layerId=void 0,t.legendEnabled=!0,t.maxRecordCount=void 0,t.minScale=0,t.maxScale=0,t.objectIdField=null,t.operationalLayerType="ArcGISFeatureLayer",t.popupEnabled=!0,t.popupTemplate=null,t.relationships=null,t.returnM=!1,t.returnZ=!1,t.screenSizePerspectiveEnabled=!0,t.serviceDefinitionExpression=null,t.spatialReference=w.WGS84,t.templates=null,t.timeInfo=null,t.title=null,t.sublayerTitleMode="item-title",t.trackIdField=null,t.type="feature",t.typeIdField=null,t.types=null,t.userIsAdmin=!1,t.version=void 0,t.visible=!0,t}return t(u,r),u.prototype.normalizeCtorArgs=function(e,r){return"string"==typeof e?s.mixin({},{url:e},r):e},u.prototype.load=function(){var e=this,r=this.source&&(Array.isArray(this.source)||ee(this.source));if(this.portalItem&&r)return void this.addResolvingPromise(b.resolve());var t=this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]}).always(function(){return e.url&&null==e.layerId&&/FeatureServer\/*$/i.test(e.url)?e._fetchFirstLayerId().then(function(r){null!=r&&(e.layerId=r)}):void 0}).then(function(){if(!e.url&&!e._hasMemorySource())throw new y("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return e.createGraphicsSource().then(e._initLayerProperties.bind(e))});return this.addResolvingPromise(t),this.when()},Object.defineProperty(u.prototype,"allRenderers",{get:function(){return this._getAllRenderers(this.renderer)},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"capabilities",{get:function(){var e=this._get("capabilities");return e||!this.loaded||this.hasService?e:{data:{supportsAttachment:!1,supportsM:!1,supportsZ:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!0,supportsDelete:!0,supportsEditing:!0,supportsQuery:!0,supportsUpdate:!0},query:{supportsStatistics:!1,supportsCentroid:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!0,supportsGeometryProperties:!1,supportsOrderBy:!1,supportsPagination:!1,supportsQuantization:!1,supportsResultType:!1,supportsSqlExpression:!1,supportsStandardizedQueriesOnly:!1,supportsQueryByOthers:!1},queryRelated:{supportsPagination:!1,supportsCount:!1,supportsOrderBy:!1},editing:{supportsGeometryUpdate:!0,supportsGlobalId:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1}}},enumerable:!0,configurable:!0}),u.prototype.readCapabilities=function(e,r){return r=r.layerDefinition||r,{data:this._readDataCapabilities(r),operations:this._readOperationsCapabilities(r.capabilities||e,r),query:this._readQueryCapabilities(r),queryRelated:this._readQueryRelatedCapabilities(r),editing:this._readEditingCapabilities(r)}},Object.defineProperty(u.prototype,"hasAttachments",{get:function(){return this.hasService&&this._get("hasAttachments")||!1},enumerable:!0,configurable:!0}),u.prototype.readIsTable=function(e,r){return r=r&&r.layerDefinition||r,"Table"===r.type},Object.defineProperty(u.prototype,"hasService",{get:function(){return!this._hasMemorySource()},enumerable:!0,configurable:!0}),u.prototype.readMinScale=function(e,r){return r.effectiveMinScale||e||0},u.prototype.readMaxScale=function(e,r){return r.effectiveMaxScale||e||0},u.prototype.readObjectIdFieldFromService=function(e,r){if(r=r.layerDefinition||r,r.objectIdField)return r.objectIdField;if(r.fields)for(var t=0,i=r.fields;t<i.length;t++){var o=i[t];if("esriFieldTypeOID"===o.type)return o.name}},Object.defineProperty(u.prototype,"outFields",{get:function(){var e=this,r=this._userOutFields,t=this.requiredFields;return r=r&&r.slice(0),t=t&&t.slice(0),r?-1===r.indexOf("*")&&t.forEach(function(e){-1===r.indexOf(e)&&r.push(e)}):r=t,this.loaded&&(r=r.filter(function(r){return"*"===r||!!e.getField(r,e.fields)},this),r=r.map(function(r){return"*"===r?r:e.getField(r,e.fields).name},this),r=r.filter(function(e,r,t){return t.indexOf(e)===r})),r},set:function(e){var r=this,t=this.requiredFields&&this.requiredFields.slice(0);e?-1===e.indexOf("*")&&t.forEach(function(r){-1===e.indexOf(r)&&e.push(r)}):e=t,this.loaded&&(e=e.filter(function(e){return"*"===e||!!r.getField(e,r.fields)},this),e=e.map(function(e){return"*"===e?e:r.getField(e,r.fields).name},this)),this._userOutFields=e},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"parsedUrl",{get:function(){var e=this.url?v.urlToObject(this.url):null;return null!=this.layerId&&null!=e&&(e.path=v.join(e.path,this.layerId.toString())),e},enumerable:!0,configurable:!0}),u.prototype.readPopupEnabled=function(e,r){return!r.disablePopup},u.prototype.writePopupEnabled=function(e,r,t){r[t]=!e},Object.defineProperty(u.prototype,"renderer",{set:function(e){var r=this._getAllRenderers(e);z.fixRendererFields(r,this.fields),this._set("renderer",e)},enumerable:!0,configurable:!0}),u.prototype.readRenderer=function(e,r,t){r=r.layerDefinition||r;var i,o,n=r.drawingInfo&&r.drawingInfo.renderer||void 0;if(n)i=_.read(n,r,t)||void 0,i||ne.error("Failed to create renderer",{rendererDefinition:r.drawingInfo.renderer,layer:this,context:t});else if(r.defaultSymbol)x.read(r.defaultSymbol,r,t),r.types&&r.types.length?(i=new P({defaultSymbol:o,field:r.typeIdField}),r.types.forEach(function(e){n.addUniqueValueInfo(e.id,x.read(e.symbol,e,t))})):i=new E({symbol:o});else if("Table"!==r.type){switch(r.geometryType){case"esriGeometryPoint":case"esriGeometryMultipoint":o=new D;break;case"esriGeometryPolyline":o=new O;break;case"esriGeometryPolygon":o=new T}i=o&&new E({symbol:o})}return i},Object.defineProperty(u.prototype,"requiredFields",{get:function(){var e=this.timeInfo,r=[],t=[],i=[this.objectIdField,this.typeIdField,this.editFieldsInfo&&this.editFieldsInfo.creatorField,e&&e.startTimeField,e&&e.endTimeField,this.trackIdField];this.allRenderers.forEach(function(e){r=r.concat(e.requiredFields)}),this.labelingInfo&&this.labelingInfo.length&&this.labelingInfo.forEach(function(e){t=t.concat(e.requiredFields)}),i=i.concat(r),i=i.concat(t);var o=this.elevationInfo&&this.elevationInfo.featureExpressionInfo;return o&&(i=i.concat(o.requiredFields)),this.popupTemplate&&(i=i.concat(this.popupTemplate.requiredFields)),i.filter(function(e,r,t){return!!e&&t.indexOf(e)===r&&"function"!=typeof e})},enumerable:!0,configurable:!0}),Object.defineProperty(u.prototype,"source",{set:function(e){var r=this._get("source");r!==e&&(ee(r)&&this._resetMemorySource(r),ee(e)&&this._initMemorySource(e),this._set("source",e))},enumerable:!0,configurable:!0}),u.prototype.castSource=function(e){return e?Array.isArray(e)||re(e)?new V({layer:this,items:e}):e:null},u.prototype.readSource=function(e,r){var t=M.fromJSON(r.featureSet);return new V({layer:this,items:t&&t.features||[]})},u.prototype.readTemplates=function(e,r){var t=r.editFieldsInfo,i=t&&t.creatorField,o=t&&t.editorField;return e=e&&e.map(function(e){return Z.fromJSON(e)}),this._fixTemplates(e,i),this._fixTemplates(e,o),e},u.prototype.readTitle=function(e,r){var t=r.layerDefinition&&r.layerDefinition.name||r.name,i=r.title||r.layerDefinition&&r.layerDefinition.title;if(t){var o=this.portalItem&&this.portalItem.title;if("item-title"===this.sublayerTitleMode)return this.url?K.titleFromUrlAndName(this.url,t):t;var n=t||this.url&&K.parse(this.url).title;if(!n)return;return"item-title-and-service-name"===this.sublayerTitleMode&&o&&(n=o+" - "+n),K.cleanTitle(n)}return"item-title"===this.sublayerTitleMode&&i?i:void 0},u.prototype.readTitleFromWebMap=function(e,r){var t=r.layerDefinition&&r.layerDefinition.name;return t?t:r.title},u.prototype.readTypeIdField=function(e,r){if(r=r.layerDefinition||r,e=r.typeIdField){var t=this.getField(e,r.fields);t&&(e=t.name)}return e},u.prototype.readTypes=function(e,r){var t=this;r=r.layerDefinition||r,e=r.types;var i=r.editFieldsInfo,o=i&&i.creatorField,n=i&&i.editorField;return e&&e.map(function(e){return e=N.fromJSON(e),t._fixTemplates(e.templates,o),t._fixTemplates(e.templates,n),e})},Object.defineProperty(u.prototype,"url",{set:function(e){var r=K.sanitizeUrlWithLayerId(this,e,ne);this._set("url",r.url),null!=r.layerId&&this._set("layerId",r.layerId)},enumerable:!0,configurable:!0}),u.prototype.writeUrl=function(e,r,t,i){K.writeUrlWithLayerId(this,e,r)},u.prototype.readVersion=function(e,r){return r=r.layerDefinition||r,r.currentVersion?r.currentVersion:r.hasOwnProperty("capabilities")||r.hasOwnProperty("drawingInfo")||r.hasOwnProperty("hasAttachments")||r.hasOwnProperty("htmlPopupType")||r.hasOwnProperty("relationships")||r.hasOwnProperty("timeInfo")||r.hasOwnProperty("typeIdField")||r.hasOwnProperty("types")?10:9.3},u.prototype.readVisible=function(e,r){return r.layerDefinition&&null!=r.layerDefinition.defaultVisibility?!!r.layerDefinition.defaultVisibility:null!=r.visibility?!!r.visibility:void 0},u.prototype.applyEdits=function(e){var r=this;return this.load().then(function(){return Y(r.source)?r._processApplyEditsParams(e):b.reject(new y(oe,"Layer source does not support applyEdits capability"))}).then(function(e){return Y(r.source)?r.source.applyEdits(e).then(function(e){var t=function(e){return e.filter(function(e){return!e.error}).map(m.clone)},i={addedFeatures:t(e.addFeatureResults),updatedFeatures:t(e.updateFeatureResults),deletedFeatures:t(e.deleteFeatureResults)};return(i.addedFeatures.length||i.updatedFeatures.length||i.deletedFeatures.length)&&r.emit("edits",i),e}):void 0})},u.prototype.createGraphicsSource=function(){var r=this;if(this._hasMemorySource())return this.emit("graphics-source-create",{graphicsSource:this.source}),this.source.when();var t="FeatureLayerSource";return g.when(e,"./graphics/sources/"+t).then(function(e){return new e({layer:r})}).then(function(e){return e.when()}).then(function(e){return r.emit("graphics-source-create",{graphicsSource:e}),e})},u.prototype.createGraphicsController=function(r){var t,i=this,o=r.layerView,n=d.ofType(a),p=this.source,l=ee(p),u=s.mixin(r.options||{},{layer:this,layerView:o,graphics:l?p:new n});return t=l?"./graphics/controllers/MemoryController":"2d"===o.view.type?"./graphics/controllers/AutoController2D":"./graphics/controllers/SnapshotController",g.when(e,t).then(function(e){return new e(u)}).then(function(e){return i.emit("graphics-controller-create",{graphicsController:e}),e.when()})},u.prototype.createQuery=function(){var e=new C,r=this.get("capabilities.data");return e.returnGeometry=!0,e.returnZ=r&&r.supportsZ&&this.returnZ||null,e.returnM=r&&r.supportsM&&this.returnM||null,e.outFields=this.outFields,e.where=this.definitionExpression||"1=1",e.multipatchOption="multipatch"===this.geometryType?"xyFootprint":null,e},u.prototype.getFieldDomain=function(e,r){var t,i=this,o=!1,n=r&&r.feature,s=n&&n.attributes,a=this.typeIdField&&s&&s[this.typeIdField];return null!=a&&this.types&&(o=this.types.some(function(r){return r.id==a?(t=r.domains&&r.domains[e],t&&"inherited"===t.type&&(t=i._getLayerDomain(e)),!0):!1})),o||t||(t=this._getLayerDomain(e)),t},u.prototype.getField=function(e,r){var t=this.processing?this.fields.concat(this.processing.fields):this.fields;return z.getField(e,r||t)},u.prototype.graphicChanged=function(e){this.emit("graphic-update",e)},u.prototype.queryFeatures=function(e){var r=this;return this.load().then(function(){return r.source.queryFeatures?void 0:b.reject(new y(oe,"Layer source does not support queryFeatures capability"))}).then(function(){return r.source.queryFeatures(e||r.createQuery())}).then(function(e){if(e&&e.features){var t=r.popupTemplate;e.features.forEach(function(e){e.popupTemplate=t,e.layer=r})}return e})},u.prototype.queryObjectIds=function(e){var r=this;return this.load().then(function(){return r.source.queryObjectIds?r.source.queryObjectIds(e||r.createQuery()):b.reject(new y(oe,"Layer source does not support queryObjectIds capability"))})},u.prototype.queryFeatureCount=function(e){var r=this;return this.load().then(function(){return r.source.queryFeatureCount?r.source.queryFeatureCount(e||r.createQuery()):b.reject(new y(oe,"Layer source does not support queryFeatureCount capability"))})},u.prototype.queryExtent=function(e){var r=this;return this.load().then(function(){return r.source.queryExtent?r.source.queryExtent(e||r.createQuery()):b.reject(new y(oe,"Layer source does not support queryExtent capability"))})},u.prototype.read=function(e,r){switch(r&&r.origin){case"web-scene":this.inherited(arguments,[{returnZ:!0},r])}var t=e.featureCollection;if(t){var i=t.layers;i&&1===i.length&&(this.inherited(arguments,[i[0],r]),null!=t.showLegend&&this.inherited(arguments,[{showLegend:t.showLegend},r]))}return this.inherited(arguments,[e,r]),this},u.prototype.write=function(e,r){if(r&&"web-scene"===r.origin&&r.messages){if(!this.url)return r.messages.push(new y("layer:unsupported","Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' require a url to a service to be written to web scenes",{layer:this})),null;if(this.isTable)return r.messages.push(new y("layer:unsupported","Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' using a Table source cannot written to web scenes",{layer:this})),null}return this.inherited(arguments)},u.prototype._getLayerDomain=function(e){if(!this.fields)return null;var r=null;return this.fields.some(function(t){return t.name===e&&(r=t.domain),!!r}),r},u.prototype._fetchFirstLayerId=function(){return l(this.url,{query:{f:"json"},callbackParamName:"callback",responseType:"json"}).then(function(e){var r=e.data;return r&&Array.isArray(r.layers)&&r.layers.length>0?r.layers[0].id:void 0})},u.prototype._initLayerProperties=function(e){var r=this;return this.source||(this.source=e),e.url&&(this.url=e.url),e.layerDefinition&&this.read(e.layerDefinition,{origin:"service",url:this.parsedUrl}),this._verifySource(),this._verifyFields(),this._addSymbolUrlTokens(),z.fixRendererFields(this._getAllRenderers(this.renderer),this.fields),this.watch("token",function(){r._addSymbolUrlTokens()}),R.loadStyleRenderer(this,{origin:"service"})},u.prototype._findUrlBasedSymbols=function(){var e=this.renderer;if(!e)return[];var r=[];e.symbol&&r.push(e.symbol),e.defaultSymbol&&r.push(e.defaultSymbol);var t=e.classBreakInfos||e.uniqueValueInfos;return t&&t.forEach(function(e){e.symbol&&r.push(e.symbol)}),r.filter(function(e){return!!e.url})},u.prototype._addSymbolUrlTokens=function(){var e=this.token;if(!this._hasMemorySource()&&e){var r=this._findUrlBasedSymbols();r.forEach(function(r){var t=r.url;if(t&&-1!==t.search(/https?\:/i)&&!/[?&]token=/.test(t)){var i=-1===t.indexOf("?")?"?":"&";r.url=t+i+"token="+e}})}},u.prototype._getAllRenderers=function(e){if(!e)return[];var r=[],t=[e,e.trackRenderer,e.observationRenderer,e.latestObservationRenderer];return t.forEach(function(e){e&&(r.push(e),e.rendererInfos&&e.rendererInfos.forEach(function(e){e.renderer&&r.push(e.renderer)}))}),r},u.prototype._verifyFields=function(){var e=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+e+")"),this.isTable||this._hasMemorySource()||-1!==e.search(/\/FeatureServer\//i)||this.fields&&this.fields.some(function(e){return"geometry"===e.type})||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+e+")")},u.prototype._fixTemplates=function(e,r){e&&e.forEach(function(e){var t=e.prototype&&e.prototype.attributes;t&&r&&delete t[r]})},u.prototype._verifySource=function(){var e=this;if(this._hasMemorySource()){if(this.url)throw new y("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url");var r=["geometryType","fields","objectIdField"],t=r.every(function(r){return null!=e[r]});if(!t)throw new y("feature-layer:missing-property","FeatureLayer created as feature collection requires properties: "+r.join(),{requiredProperties:r})}else{if(this.isTable)throw new y("feature-layer:source-type-not-supported","The table feature service type is not yet supported",{sourceType:"Table"});if(!this.url)throw new y("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source")}},u.prototype._initMemorySource=function(e){var r=this;e.forEach(function(e){e.layer=r}),this._handles.add([e.on("after-add",function(e){e.item.layer=r}),e.on("after-remove",function(e){e.item.layer=null})],"fl-source")},u.prototype._resetMemorySource=function(e){e.forEach(function(e){e.layer=null}),this._handles.remove("fl-source")},u.prototype._hasMemorySource=function(){return!(this.url||!this.source)},u.prototype._readDataCapabilities=function(e){return{supportsAttachment:te(e,"hasAttachments",!1),supportsM:te(e,"hasM",!1),supportsZ:te(e,"hasZ",!1)}},u.prototype._readOperationsCapabilities=function(e,r){var t=e?e.toLowerCase().split(",").map(function(e){return e.trim()}):[],i=-1!==t.indexOf("editing"),o=i&&-1!==t.indexOf("create"),n=i&&-1!==t.indexOf("delete"),s=i&&-1!==t.indexOf("update");return i&&!(o||n||s)&&(o=n=s=!0),{supportsCalculate:te(r,"supportsCalculate",!1),supportsTruncate:te(r,"supportsTruncate",!1),supportsValidateSql:te(r,"supportsValidateSql",!1),supportsAdd:o,supportsDelete:n,supportsEditing:i,supportsQuery:-1!==t.indexOf("query"),supportsUpdate:s}},u.prototype._readQueryCapabilities=function(e){var r=e.advancedQueryCapabilities,t=e.ownershipBasedAccessControlForFeatures;return{supportsStatistics:te(r,"supportsStatistics",e.supportsStatistics),supportsCentroid:te(r,"supportsReturningGeometryCentroid",!1),supportsDistance:te(r,"supportsQueryWithDistance",!1),supportsDistinct:te(r,"supportsDistinct",e.supportsAdvancedQueries),supportsExtent:te(r,"supportsReturningQueryExtent",!1),supportsGeometryProperties:te(r,"supportsReturningGeometryProperties",!1),supportsOrderBy:te(r,"supportsOrderBy",e.supportsAdvancedQueries),supportsPagination:te(r,"supportsPagination",!1),supportsQuantization:te(e,"supportsCoordinatesQuantization",!1),supportsResultType:te(r,"supportsQueryWithResultType",!1),supportsSqlExpression:te(r,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:te(e,"useStandardizedQueries",!1),supportsQueryByOthers:te(t,"allowOthersToQuery",!0)}},u.prototype._readQueryRelatedCapabilities=function(e){var r=e.advancedQueryCapabilities,t=te(r,"supportsAdvancedQueryRelated",!1);return{supportsPagination:te(r,"supportsQueryRelatedPagination",!1),supportsCount:t,supportsOrderBy:t}},u.prototype._readEditingCapabilities=function(e){var r=e.ownershipBasedAccessControlForFeatures;return{supportsGeometryUpdate:te(e,"allowGeometryUpdates",!0),supportsGlobalId:te(e,"supportsApplyEditsWithGlobalIds",!1),supportsRollbackOnFailure:te(e,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:te(e,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:te(e,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:te(r,"allowAnonymousToDelete",!0),supportsDeleteByOthers:te(r,"allowOthersToDelete",!0),supportsUpdateByAnonymous:te(r,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:te(r,"allowOthersToUpdate",!0)}},u.prototype._processApplyEditsParams=function(e){var r="'addFeatures', 'updateFeatures' or 'deleteFeatures' parameter is required",t="feature-layer:missing-parameters";if(!e)return b.reject(new y(t,r));if(e=s.mixin({},e),e.addFeatures=e.addFeatures||[],e.updateFeatures=e.updateFeatures||[],e.deleteFeatures=e.deleteFeatures||[],e.addFeatures.length||e.updateFeatures.length||e.deleteFeatures.length){var i=function(e){var r=new a;return r.geometry=e.geometry,r.attributes=e.attributes,r};return e.addFeatures=e.addFeatures.map(i),e.updateFeatures=e.updateFeatures.map(i),this._normalizeGeometries(e)}return b.reject(new y(t,r))},u.prototype._normalizeGeometries=function(e){var r=e.addFeatures,t=e.updateFeatures,i=r.concat(t).map(function(e){return e.geometry});return S.normalizeCentralMeridian(i).then(function(i){var o=r.length,n=t.length;return i.slice(0,o).forEach(function(r,t){e.addFeatures[t].geometry=r}),i.slice(o,o+n).forEach(function(r,t){e.updateFeatures[t].geometry=r}),e})},i([n.property({types:{key:"type",base:H.FeatureReduction,typeMap:{selection:H.FeatureReductionSelection}},json:{origins:{"web-scene":{read:{source:"layerDefinition.featureReduction"},write:{target:"layerDefinition.featureReduction"}}}}})],u.prototype,"featureReduction",void 0),i([n.property({readOnly:!0,dependsOn:["loaded","renderer","fields"]})],u.prototype,"allRenderers",null),i([n.property({readOnly:!0,dependsOn:["loaded"]})],u.prototype,"capabilities",null),i([n.reader("capabilities",["layerDefinition.capabilities","layerDefinition.advancedQueryCapabilities","layerDefinition.supportsStatistics","layerDefinition.supportsAdvancedQueries","layerDefinition.hasAttachments","layerDefinition.hasM","layerDefinition.hasZ","layerDefinition.supportsCalculate","layerDefinition.supportsTruncate","layerDefinition.supportsValidateSql","layerDefinition.supportsCoordinatesQuantization","layerDefinition.useStandardizedQueries","layerDefinition.ownershipBasedAccessControlForFeatures","layerDefinition.allowGeometryUpdates","layerDefinition.supportsApplyEditsWithGlobalIds","layerDefinition.supportsRollbackOnFailureParameter","layerDefinition.allowUpdateWithoutMValues","layerDefinition.supportsAttachmentsByUploadId"]),n.reader("service","capabilities",["advancedQueryCapabilities","supportsStatistics","supportsAdvancedQueries","hasAttachments","hasM","hasZ","supportsCalculate","supportsTruncate","supportsValidateSql","supportsCoordinatesQuantization","useStandardizedQueries","ownershipBasedAccessControlForFeatures","allowGeometryUpdates","supportsApplyEditsWithGlobalIds","supportsRollbackOnFailureParameter","allowUpdateWithoutMValues","supportsAttachmentsByUploadId","capabilities"])],u.prototype,"readCapabilities",null),i([n.property({type:String,json:{read:{source:"layerDefinition.copyrightText"},origins:{service:{read:{source:"copyrightText"}}}}})],u.prototype,"copyright",void 0),i([n.property({type:String,json:{read:{source:"layerDefinition.displayField"},origins:{service:{read:{source:"displayField"}}}}})],u.prototype,"displayField",void 0),i([n.property({type:String,json:{origins:{service:{read:!1,write:!1}},read:{source:"layerDefinition.definitionExpression"},write:{target:"layerDefinition.definitionExpression"}}})],u.prototype,"definitionExpression",void 0),i([n.property({readOnly:!0,json:{read:x.read}})],u.prototype,"defaultSymbol",void 0),i([n.property({readOnly:!0})],u.prototype,"editFieldsInfo",void 0),i([n.property({type:j,json:{origins:{service:{read:{source:"elevationInfo"},write:{target:"elevationInfo",enabled:!1}}},read:{source:"layerDefinition.elevationInfo"},write:{target:"layerDefinition.elevationInfo"}}})],u.prototype,"elevationInfo",void 0),i([n.property({type:[k],json:{origins:{service:{read:!0}},read:{source:"layerDefinition.fields"}}})],u.prototype,"fields",void 0),i([n.property({type:F,json:{origins:{service:{read:{source:"extent"}}},read:{source:"layerDefinition.extent"}}})],u.prototype,"fullExtent",void 0),i([n.property()],u.prototype,"gdbVersion",void 0),i([n.property({json:{origins:{service:{read:ie.read}},read:{source:"layerDefinition.geometryType",reader:ie.read}}})],u.prototype,"geometryType",void 0),i([n.property({readOnly:!0,dependsOn:["loaded"],json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasAttachments"}}})],u.prototype,"hasAttachments",null),i([n.property({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasM"}}})],u.prototype,"hasM",void 0),i([n.property({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasZ"}}})],u.prototype,"hasZ",void 0),i([n.property({readOnly:!0,type:I})],u.prototype,"heightModelInfo",void 0),i([n.property({json:{origins:{service:{read:!1},"portal-item":{read:!1}}}})],u.prototype,"id",void 0),i([n.property({readOnly:!0})],u.prototype,"isTable",void 0),i([n.reader("service","isTable",["type"]),n.reader("isTable",["layerDefinition.type"])],u.prototype,"readIsTable",null),i([n.property({dependsOn:["loaded","url","source"],readOnly:!0})],u.prototype,"hasService",null),i([n.property({type:Boolean,json:{read:{source:"showLabels"},write:{target:"showLabels"}}})],u.prototype,"labelsVisible",void 0),i([n.property({type:[J],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:$.reader},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:$.reader},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],u.prototype,"labelingInfo",void 0),i([n.property({type:Number,json:{origins:{service:{read:{source:"id"}}},read:!1}})],u.prototype,"layerId",void 0),i([n.property({type:Boolean,json:{read:{source:"showLegend"},write:{target:"showLegend"}}})],u.prototype,"legendEnabled",void 0),i([n.property({type:Number,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.maxRecordCount"}}})],u.prototype,"maxRecordCount",void 0),i([n.property({type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"}}})],u.prototype,"minScale",void 0),i([n.reader("service","minScale",["minScale","effectiveMinScale"])],u.prototype,"readMinScale",null),i([n.property({type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"}}})],u.prototype,"maxScale",void 0),i([n.reader("service","maxScale",["maxScale","effectiveMaxScale"])],u.prototype,"readMaxScale",null),i([n.property({type:String})],u.prototype,"objectIdField",void 0),i([n.reader("objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"]),n.reader("service","objectIdField",["objectIdField","fields"])],u.prototype,"readObjectIdFieldFromService",null),i([n.property()],u.prototype,"operationalLayerType",void 0),i([n.property({dependsOn:["requiredFields"]})],u.prototype,"outFields",null),i([n.property({readOnly:!0,dependsOn:["layerId"]})],u.prototype,"parsedUrl",null),i([n.property({type:Boolean,json:{write:{target:"disablePopup"}}})],u.prototype,"popupEnabled",void 0),i([n.reader("popupEnabled",["disablePopup"])],u.prototype,"readPopupEnabled",null),i([n.writer("popupEnabled")],u.prototype,"writePopupEnabled",null),i([n.property({type:p,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],u.prototype,"popupTemplate",void 0),i([n.property({type:W})],u.prototype,"processing",void 0),i([n.property({readOnly:!0})],u.prototype,"relationships",void 0),i([n.property({types:q.types,json:{origins:{service:{write:{target:"drawingInfo.renderer",enabled:!1}}},write:{target:"layerDefinition.drawingInfo.renderer"}}})],u.prototype,"renderer",null),i([n.reader("service","renderer",["drawingInfo.renderer","defaultSymbol","type"]),n.reader("renderer",["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol","layerDefinition.type"])],u.prototype,"readRenderer",null),i([n.property({readOnly:!0,dependsOn:["allRenderers","labelingInfo","elevationInfo.featureExpressionInfo","popupTemplate.requiredFields"]})],u.prototype,"requiredFields",null),i([n.property({type:Boolean})],u.prototype,"returnM",void 0),i([n.property({type:Boolean})],u.prototype,"returnZ",void 0),i([n.property(X.screenSizePerspectiveEnabled)],u.prototype,"screenSizePerspectiveEnabled",void 0),i([n.property()],u.prototype,"source",null),i([n.cast("source")],u.prototype,"castSource",null),i([n.reader("portal-item","source",["featureSet"]),n.reader("web-map","source",["featureSet"])],u.prototype,"readSource",null),i([n.property({readOnly:!0,json:{origins:{service:{read:{source:"definitionExpression"}}}}})],u.prototype,"serviceDefinitionExpression",void 0),i([n.property({type:w,json:{origins:{service:{read:{source:"extent.spatialReference"}}},read:{source:"layerDefinition.extent.spatialReference"}}})],u.prototype,"spatialReference",void 0),i([n.property({type:[Z]})],u.prototype,"templates",void 0),i([n.reader("templates",["editFieldsInfo","creatorField","editorField","templates"])],u.prototype,"readTemplates",null),i([n.property()],u.prototype,"timeInfo",void 0),i([n.property()],u.prototype,"title",void 0),i([n.reader("service","title",["name"]),n.reader("portal-item","title",["layerDefinition.title","layerDefinition.name","title"])],u.prototype,"readTitle",null),i([n.reader("web-map","title",["layerDefinition.name","title"])],u.prototype,"readTitleFromWebMap",null),i([n.property({type:String})],u.prototype,"sublayerTitleMode",void 0),i([n.property({type:String,readOnly:!0,json:{read:{source:"timeInfo.trackIdField"}}})],u.prototype,"trackIdField",void 0),i([n.property({json:{read:!1}})],u.prototype,"type",void 0),i([n.property({type:String,readOnly:!0})],u.prototype,"typeIdField",void 0),i([n.reader("service","typeIdField"),n.reader("typeIdField",["layerDefinition.typeIdField"])],u.prototype,"readTypeIdField",null),i([n.property({type:[N]})],u.prototype,"types",void 0),i([n.reader("service","types",["types"]),n.reader("types",["layerDefinition.types"])],u.prototype,"readTypes",null),i([n.property({type:String})],u.prototype,"url",null),i([n.writer("url")],u.prototype,"writeUrl",null),i([n.property({readOnly:!0})],u.prototype,"userIsAdmin",void 0),i([n.property({json:{origins:{"portal-item":{read:!1}}}})],u.prototype,"version",void 0),i([n.reader("service","version",["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"]),n.reader("version",["layerDefinition.currentVersion","layerDefinition.capabilities","layerDefinition.drawingInfo","layerDefinition.hasAttachments","layerDefinition.htmlPopupType","layerDefinition.typeIdField","layerDefinition.types"])],u.prototype,"readVersion",null),
i([n.property({type:Boolean,json:{origins:{"portal-item":{write:{target:"layerDefinition.defaultVisibility"}}}}})],u.prototype,"visible",void 0),i([n.reader("portal-item","visible",["visibility","layerDefinition.defaultVisibility"])],u.prototype,"readVisible",null),i([o(0,n.cast(C))],u.prototype,"queryFeatures",null),i([o(0,n.cast(C))],u.prototype,"queryObjectIds",null),i([o(0,n.cast(C))],u.prototype,"queryFeatureCount",null),i([o(0,n.cast(C))],u.prototype,"queryExtent",null),u=i([n.subclass("esri.layers.FeatureLayer")],u)}(n.declared(A,U,L,Q,B,G,u));return se});