// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

//  copyright

/**
       * The copyright text as defined by the map service.
       *
       * @type {string}
       */

define(["require","dojo/_base/lang","dojo/io-query","../Graphic","../PopupTemplate","../request","../core/kebabDictionary","../core/MultiOriginJSONSupport","../core/Collection","../core/Error","../core/Logger","../core/lang","../core/HandleRegistry","../core/promiseUtils","../core/requireUtils","../core/urlUtils","../geometry/Extent","../geometry/SpatialReference","../geometry/support/normalizeUtils","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","../symbols/support/jsonUtils","../renderers/SimpleRenderer","../renderers/UniqueValueRenderer","../renderers/support/arcadeUtils","../renderers/support/jsonUtils","../renderers/support/styleUtils","../tasks/support/FeatureSet","../tasks/support/Query","./Layer","./mixins/OperationalLayer","./mixins/PortalLayer","./mixins/ScaleRangeLayer","./mixins/ArcGISService","./graphics/sources/MemorySource","./support/Field","./support/FeatureType","./support/LabelClass","./support/labelingInfo","./support/arcgisLayerUrl","./support/ElevationInfo"],function(e,r,t,i,n,s,a,o,u,l,d,c,f,p,h,y,m,g,v,b,F,w,I,_,S,j,D,O,x,T,E,L,P,q,A,M,R,C,U,V,k,G){var Q=a({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),N="FeatureLayer",z=d.getLogger("esri.layers.FeatureLayer"),J=function(e,r){var t=x.fromJSON(r.featureSet);return new M({layer:this,items:t&&t.features||[]})},Z=E.createSubclass([L,P,q,A,o],{declaredClass:"esri.layers.FeatureLayer",viewModulePaths:{"2d":"../views/2d/layers/FeatureLayerView2D","3d":"../views/3d/layers/FeatureLayerView3D"},constructor:function(){this._handles=new f},normalizeCtorArgs:function(e,t){return"string"==typeof e?r.mixin({},{url:e},t):e},load:function(){var e,r=this.source&&(Array.isArray(this.source)||this.source.isInstanceOf&&this.source.isInstanceOf(u));e=this.portalItem&&r?p.resolve():this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]}).always(function(){return this.url&&null==this.layerId&&/FeatureServer\/*$/i.test(this.url)?this._fetchFirstLayerId().then(function(e){null!=e&&(this.layerId=e)}.bind(this)):void 0}.bind(this)).then(function(){if(!this.url&&!this._hasMemorySource())throw new l("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return this.createGraphicsSource().then(this._initLayerProperties.bind(this))}.bind(this)),this.addResolvingPromise(e)},_handles:null,_rndProps:["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],_visVariableProps:["field","normalizationField"],properties:{advancedQueryCapabilities:{json:{origins:{service:{read:{source:["advancedQueryCapabilities","supportsStatistics","supportsAdvancedQueries"],reader:function(e,r){return this._readAdvancedQueryCapabilities(r)}}}},read:{source:["layerDefinition.supportsAdvancedQueries","layerDefinition.supportsStatistics"],reader:function(e,r){return this._readAdvancedQueryCapabilities(r.layerDefinition)}}}},allowGeometryUpdates:{json:{origins:{service:{read:{reader:function(e){return this._readAllowGeometryUpdates(e)}}}},read:{source:"layerDefinition.allowGeometryUpdates",reader:function(e){return this._readAllowGeometryUpdates(e)}}}},allRenderers:{readOnly:!0,dependsOn:["loaded","renderer","fields"],get:function(){return this._getAllRenderers(this.renderer)}},capabilities:{json:{origins:{service:{read:{reader:function(e){return this._readCapabilities(e)}}}},read:{source:"layerDefinition.capabilities",reader:function(e){return this._readCapabilities(e)}}},dependsOn:["loaded"],get:function(){var e=this._get("capabilities");return!e&&this.loaded&&this._hasMemorySource()&&(e={operations:{supportsAdd:!0,supportsDelete:!0,supportsEditing:!0,supportsQuery:!0,supportsUpdate:!0}}),e}},copyright:{value:null,json:{origins:{service:{read:{source:"copyrightText"}}},read:{source:"layerDefinition.copyrightText"}}},definitionExpression:{value:null,json:{origins:{service:{read:!1,write:!1}},read:{source:"layerDefinition.definitionExpression"},write:{target:"layerDefinition.definitionExpression"}}},defaultSymbol:{json:{read:I.read}},elevationInfo:{type:G,value:null,json:{origins:{service:{read:{source:"elevationInfo"},write:{target:"elevationInfo",enabled:!1}}},read:{source:"layerDefinition.elevationInfo"},write:{target:"layerDefinition.elevationInfo"}}},fields:{value:null,type:[R],json:{origins:{service:{read:!0}},read:{source:"layerDefinition.fields"}}},fullExtent:{value:null,type:m,json:{origins:{service:{read:{source:"extent"}}},read:{source:"layerDefinition.extent"}}},gdbVersion:null,generalizeForScale:4e3,geometryType:{json:{origins:{service:{read:Q.fromJSON}},read:{source:"layerDefinition.geometryType",reader:Q.fromJSON}}},hasAttachments:{value:!1,readOnly:!0,get:function(){return!this._hasMemorySource()&&this._get("hasAttachments")},json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasAttachments"}}},hasM:{value:!1,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasM"}}},hasZ:{value:!1,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasM"}}},id:{json:{origins:{service:{read:!1},portalItem:{read:!1}}}},isTable:{value:!1,readOnly:!0,json:{origins:{service:{read:{source:"type",reader:function(e){return"Table"===e}}}},read:{source:"layerDefinition.type",reader:function(e){return"Table"===e}}}},labelsVisible:{value:!1,json:{read:{source:["showLabels"],reader:function(e,r){return!!r.showLabels}},write:function(e,r){e&&(r.showLabels=e)}}},labelingInfo:{value:null,type:[U],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:V.reader},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:V.reader},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}},layerId:{json:{origins:{service:{read:{source:["id"],reader:function(e,r){return r.id}}}},read:!1}},legendEnabled:{value:!0,json:{read:{source:["showLegend"],reader:function(e,r){return null!=r.showLegend?r.showLegend:!0}},write:function(e,r){e||(r.showLegend=!1)}}},maxRecordCount:{value:null,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.maxRecordCount"}}},minScale:{json:{origins:{service:{read:{source:["minScale","effectiveMinScale"],reader:function(e,r){return r.effectiveMinScale||e}},write:{target:["minScale"],enabled:!1}}},read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"}}},maxScale:{json:{origins:{service:{read:{source:["maxScale","effectiveMaxScale"],reader:function(e,r){return r.effectiveMaxScale||e}},write:{target:"maxScale",enabled:!1}}},read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"}}},objectIdField:{json:{origins:{service:{read:{source:["objectIdField","fields"],reader:function(e,r){return this._readObjectIdField(r)}}}},read:{source:["layerDefinition.objectIdField","layerDefinition.fields"],reader:function(e,r){return this._readObjectIdField(r.layerDefinition)}}}},operationalLayerType:"ArcGISFeatureLayer",outFields:{value:null,dependsOn:["requiredFields"],get:function(){var e=this._get("outFields"),r=this.requiredFields;return e?-1===e.indexOf("*")&&r.forEach(function(r){-1===e.indexOf(r)&&e.push(r)}):e=r,this.loaded&&(e=e.filter(function(e){return"*"===e||!!this.getField(e)},this),e=e.map(function(e){return"*"===e?e:this.getField(e).name},this)),e},set:function(e){var r=this.requiredFields;e?-1===e.indexOf("*")&&r.forEach(function(r){-1===e.indexOf(r)&&e.push(r)}):e=r,this.loaded&&(e=e.filter(function(e){return"*"===e||!!this.getField(e)},this),e=e.map(function(e){return"*"===e?e:this.getField(e).name},this)),this._set("outFields",e)}},parsedUrl:{dependsOn:["layerId"],get:function(){var e=this.url?y.urlToObject(this.url):null;return null!=this.layerId&&null!=e&&(e.path=y.join(e.path,this.layerId.toString())),e}},popupEnabled:{value:!0,json:{read:{source:["disablePopup"],reader:function(e,r){return null!=r.disablePopup?!r.disablePopup:!0}},write:function(e,r){e||(r.disablePopup=!0)}}},popupTemplate:{value:null,type:n,json:{read:{source:["popupInfo"],reader:function(e,r){return r.popupInfo?n.fromJSON(r.popupInfo):null}},write:function(e,r){e&&(r.popupInfo=e.toJSON())}}},relationships:null,renderer:{set:function(e){var r=this._getAllRenderers(e);this._fixRendererFields(r),this._set("renderer",e)},json:{origins:{service:{read:{source:["drawingInfo.renderer","defaultSymbol","type"],reader:function(e,r,t){return this._readRenderer(null,r,t)}},write:{target:"drawingInfo.renderer",enabled:!1}}},read:{source:["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol","layerDefinition.type"],reader:function(e,r,t){return this._readRenderer(null,r.layerDefinition,t)}},write:{target:"layerDefinition.drawingInfo.renderer"}}},requiredFields:{dependsOn:["allRenderers"],get:function(){var e=this.timeInfo,t=[this.objectIdField,this.typeIdField,this.editFieldsInfo&&this.editFieldsInfo.creatorField,e&&e.startTimeField,e&&e.endTimeField,this.trackIdField],i=this._rndProps,n=[];return this.allRenderers.forEach(function(e){i.forEach(function(i){t.push(r.getObject(i,!1,e))}),e.valueExpression&&(n=n.concat(j.extractFieldNames(e.valueExpression))),e.visualVariables&&e.visualVariables.forEach(function(e){this._visVariableProps.forEach(function(r){t.push(e[r])}),e.valueExpression&&(n=n.concat(j.extractFieldNames(e.valueExpression)))},this)},this),t=t.concat(n),t=t.concat(this.dataAttributes),t.filter(function(e,r,t){return!!e&&t.indexOf(e)===r&&"function"!=typeof e})}},returnM:!1,returnZ:!1,source:{json:{origins:{portalItem:{read:{source:["featureSet"],reader:J}},webMap:{read:{source:["featureSet"],reader:J}}}},cast:function(e){return e&&(Array.isArray(e)||e.isInstanceOf&&e.isInstanceOf(u))?new M({layer:this,items:e}):e},set:function(e){var r=this._get("source");r!==e&&(r&&r.isInstanceOf&&r.isInstanceOf(M)&&this._resetMemorySource(r),e&&e.isInstanceOf&&e.isInstanceOf(M)&&this._initMemorySource(e),this._set("source",e))}},supportsCoordinatesQuantization:!1,serviceDefinitionExpression:{json:{origins:{service:{read:{source:["definitionExpression"],reader:function(e,r){return r.definitionExpression}}}}}},spatialReference:{json:{origins:{service:{read:{source:"extent",reader:function(e){return e&&e.spatialReference?g.fromJSON(e.spatialReference):void 0}}}},read:{source:"layerDefinition.extent",reader:function(e){return e&&e.spatialReference?g.fromJSON(e.spatialReference):void 0}}}},title:{json:{origins:{portalItem:{read:{source:["layerDefinition.title","layerDefinition.name","title"],reader:function(e,r){var t=r.layerDefinition&&r.layerDefinition.name,i=r.title||r.layerDefinition&&r.layerDefinition.title;return t?this._readTitleFromName(t):"item-title"===this.sublayerTitleMode&&i?i:void 0}}},service:{read:{source:"name",reader:function(e,r){return this._readTitleFromName(e)}}}}}},sublayerTitleMode:{type:String,value:"item-title"},trackIdField:{json:{read:{source:["timeInfo.trackIdField"],reader:function(e,r){return r.timeInfo.trackIdField}}}},type:{value:"feature",json:{read:!1}},typeIdField:{json:{origins:{service:{read:function(e,r){return this._readTypeIdField(e,r)}}},read:{source:"layerDefinition.typeIdField",reader:function(e,r){return this._readTypeIdField(e,r.layerDefinition)}}}},types:{json:{origins:{service:{read:function(e,r){return this._readTypes(e,r)}}},read:{source:"layerDefinition.types",reader:function(e,r){return this._readTypes(e,r.layerDefinition)}}}},url:{set:function(e){var r=y.urlToObject(e),i=k.parse(r.path);if(i&&null!=i.sublayer){null==this.layerId&&(this.layerId=i.sublayer);var n=t.objectToQuery(r.query);e=i.url.path,n&&(e=e+"?"+n)}this._set("url",e)},json:{write:function(e,r){if(e&&y.isProtocolRelative(e)&&(e="https:"+e),e&&(r.url=e),null!=this.layerId){var i=y.urlToObject(e);i&&(r.url=y.join(i.path,""+this.layerId),i.query&&Object.keys(i.query)&&(r.url+="?"+t.objectToQuery(i.query)))}}}},userIsAdmin:!1,version:{json:{origins:{service:{read:{source:["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"],reader:function(e,r){return this._readVersion(r)}}}},read:{source:["layerDefinition.currentVersion","layerDefinition.capabilities","layerDefinition.drawingInfo","layerDefinition.hasAttachments","layerDefinition.htmlPopupType","layerDefinition.typeIdField","layerDefinition.types"],reader:function(e,r){return this._readVersion(r.layerDefinition)}}}},visible:{json:{origins:{portalItem:{read:{source:["visibility","layerDefinition.defaultVisibility"],reader:function(e,r){return r.layerDefinition&&null!=r.layerDefinition.defaultVisibility?!!r.layerDefinition.defaultVisibility:null!=r.visibility?!!r.visibility:void 0}},write:{target:"layerDefinition.defaultVisibility"}}}}}},applyEdits:function(e){return this.load().then(function(){return this.source.applyEdits?this._processApplyEditsParams(e).then(function(e){return this.source.applyEdits(e).then(function(e){var r=function(e){var r=function(e){return!e.error},t=function(e){return c.clone(e)};return e.filter(r).map(t)},t={addedFeatures:r(e.addFeatureResults),updatedFeatures:r(e.updateFeatureResults),deletedFeatures:r(e.deleteFeatureResults)};return(t.addedFeatures.length||t.updatedFeatures.length||t.deletedFeatures.length)&&this.emit("edits",t),e}.bind(this))}.bind(this)):p.reject(new l(N,"Layer source does not support applyEdits capability"))}.bind(this))},createGraphicsSource:function(){if(this._hasMemorySource())return this.emit("graphics-source-create",{graphicsSource:this.source}),p.resolve(this.source);var r="FeatureLayerSource";return h.when(e,"./graphics/sources/"+r).then(function(e){return new e({layer:this})}.bind(this)).then(function(e){return this.emit("graphics-source-create",{graphicsSource:e}),e}.bind(this))},createGraphicsController:function(t){var n=t.layerView,s=u.ofType(i),a=this.source,o=a&&a.isInstanceOf&&a.isInstanceOf(u),l=r.mixin(t.options||{},{layer:this,layerView:n,graphics:o?a:new s});if(o)return p.resolve(l);var d="2d"===n.view.type?"./graphics/controllers/AutoController2D":"./graphics/controllers/SnapshotController";return h.when(e,d).then(function(e){return new e(l)}.bind(this)).then(function(e){return this.emit("graphics-controller-create",{graphicsController:e}),e}.bind(this))},createQuery:function(){var e=new T;return e.returnGeometry=!0,e.returnZ=this.hasZ&&this.returnZ||null,e.returnM=this.hasM&&this.returnM||null,e.outFields=this.outFields,e.where=this.definitionExpression||"1=1",e.multipatchOption="multipatch"===this.geometryType?"xyFootprint":null,e},getFieldDomain:function(e,r){var t,i,n=r&&r.feature,s=n&&n.attributes,a=this.typeIdField&&s&&s[this.typeIdField];return null!=a&&this.types&&this.types.some(function(r){return r.id==a?(t=r.domains&&r.domains[e],t&&"inherited"===t.type&&(t=this._getLayerDomain(e),i=!0),!0):!1},this),i||t||(t=this._getLayerDomain(e)),t},getField:function(e,r){var t;return r=r||this.fields,r&&(e=e.toLowerCase(),r.some(function(r){return r&&r.name.toLowerCase()===e&&(t=r),!!t})),t},graphicChanged:function(e){this.emit("graphic-update",e)},queryFeatures:function(e){var r=this;if(e=e||this.createQuery(),!this.source.queryFeatures)return p.reject(new l(N,"Layer source does not support queryFeatures capability"));var t=this.popupTemplate;return this.source.queryFeatures(e).then(function(e){return e&&e.features&&e.features.forEach(function(e){e.popupTemplate=t,e.layer=r}),e})},queryObjectIds:function(e){return e=e||this.createQuery(),this.source.queryObjectIds?this.source.queryObjectIds(e):p.reject(new l(N,"Layer source does not support queryObjectIds capability"))},queryFeatureCount:function(e){return e=e||this.createQuery(),this.source.queryFeatureCount?this.source.queryFeatureCount(e):p.reject(new l(N,"Layer source does not support queryFeatureCount capability"))},queryExtent:function(e){return e=e||this.createQuery(),this.source.queryExtent?this.source.queryExtent(e):p.reject(new l(N,"Layer source does not support queryExtent capability"))},read:function(e,r){switch(r&&r.origin){case"web-map":this.inherited(arguments,[{outFields:["*"]},r]);break;case"web-scene":this.inherited(arguments,[{mode:Z.MODE_SNAPSHOT,returnZ:!0,outFields:["*"]},r])}var t=e.featureCollection;if(t){var i=t.layers;i&&1===i.length&&(this.inherited(arguments,[i[0],r]),null!=t.showLegend&&this.inherited(arguments,[{showLegend:t.showLegend},r]))}return this.inherited(arguments,[e,r]),this},write:function(e,r){if(r&&"web-scene"===r.origin&&r.messages){if(!this.url)return r.messages.push(new l("layer:unsupported","Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' require a url to a service to be written to web scenes",{layer:this})),null;if(this.isTable)return r.messages.push(new l("layer:unsupported","Layers ("+this.title+", "+this.id+") of type '"+this.declaredClass+"' using a Table source cannot written to web scenes",{layer:this})),null}return this.inherited(arguments)},_getLayerDomain:function(e){var r;return this.fields&&this.fields.some(function(t){return t.name===e&&(r=t.domain),!!r}),r},_fetchFirstLayerId:function(){return s(this.url,{query:{f:"json"},callbackParamName:"callback",responseType:"json"}).then(function(e){return e.data&&Array.isArray(e.data.layers)&&e.data.layers.length>0?e.data.layers[0].id:void 0})},_initLayerProperties:function(e){return this.source||(this.source=e),e.url&&(this.url=e.url),e.layerDefinition&&this.read(e.layerDefinition,{origin:"service",url:this.parsedUrl}),this._verifySource(),this._verifyFields(),this._addSymbolUrlTokens(),this._fixRendererFields(this._getAllRenderers(this.renderer)),this.watch("token",function(){this._addSymbolUrlTokens()}.bind(this)),O.loadStyleRenderer(this,{origin:"service"})},_findUrlBasedSymbols:function(){var e=this.renderer;if(!e)return[];var r=[];e.symbol&&r.push(e.symbol),e.defaultSymbol&&r.push(e.defaultSymbol);var t=e.classBreakInfos||e.uniqueValueInfos;return t&&t.forEach(function(e){e.symbol&&r.push(e.symbol)}),r.filter(function(e){return!!e.url})},_addSymbolUrlTokens:function(){var e=this.token;if(!this._hasMemorySource()&&e){var r=this._findUrlBasedSymbols();r.forEach(function(r){var t=r.url;if(t&&-1!==t.search(/https?\:/i)&&!/[?&]token=/.test(t)){var i=-1===t.indexOf("?")?"?":"&",n=t+i+"token="+e;if(r.source){var s=c.clone(r.source);s.url=n,r.source=s}else r.url=n}})}},_getAllRenderers:function(e){var r=[];if(e){var t=[e,e.trackRenderer,e.observationRenderer,e.latestObservationRenderer];t.forEach(function(e){e&&(r.push(e),e.rendererInfos&&e.rendererInfos.forEach(function(e){e.renderer&&r.push(e.renderer)}))})}return r},_fixRendererFields:function(e){var r=this.fields;e&&r&&e.forEach(function(e){this._fixFieldName(this._rndProps,e),e.visualVariables&&e.visualVariables.forEach(function(e){this._fixFieldName(this._visVariableProps,e)},this)},this)},_fixFieldName:function(e,t){e&&e.forEach(function(e){var i=r.getObject(e,!1,t),n=i&&"function"!=typeof i&&this.getField(i);n&&r.setObject(e,n.name,t)},this)},_verifyFields:function(){var e=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+e+")"),this.isTable||this._hasMemorySource()||-1!==e.search(/\/FeatureServer\//i)||this.fields&&this.fields.some(function(e){return"geometry"===e.type})||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+e+")")},_fixTemplates:function(e,r){e&&e.forEach(function(e){var t=e.prototype&&e.prototype.attributes;t&&r&&delete t[r]})},_verifySource:function(){if(this._hasMemorySource()){if(this.url)throw new l("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url");var e=["geometryType","fields","objectIdField"],r=e.every(function(e){return this.hasOwnProperty(e)},this);if(!r)throw new l("feature-layer:missing-property","FeatureLayer created as feature collection requires properties: "+e.join(),{requiredProperties:e})}else{if(this.isTable)throw new l("feature-layer:source-type-not-supported","The table feature service type is not yet supported",{sourceType:"Table"});if(!this.url)throw new l("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source")}},_initMemorySource:function(e){e.forEach(function(e){e.layer=this}.bind(this)),this._handles.add([e.on("after-add",function(e){e.item.layer=this}.bind(this)),e.on("after-remove",function(e){e.item.layer=null}.bind(this))],"fl-source")},_resetMemorySource:function(e){e.forEach(function(e){e.layer=null}.bind(this)),this._handles.remove("fl-source")},_hasMemorySource:function(){return!(this.url||!this.source)},_readTitleFromName:function(e){var r=this.portalItem&&this.portalItem.title;if("item-title"===this.sublayerTitleMode)return this.url?k.titleFromUrlAndName(this.url,e):e;var t=e||this.url&&k.parse(this.url).title;if(t)return"item-title-and-service-name"===this.sublayerTitleMode&&r&&(t=r+" - "+t),k.cleanTitle(t)},_readAdvancedQueryCapabilities:function(e){return e.advancedQueryCapabilities||{supportsPagination:!1,supportsQueryWithDistance:!1,supportsReturningQueryExtent:!1,supportsStatistics:e.supportsStatistics,supportsOrderBy:e.supportsAdvancedQueries,supportsDistinct:e.supportsAdvancedQueries}},_readAllowGeometryUpdates:function(e){return null==e?!0:e},_readCapabilities:function(e){e=e?e.toLowerCase().split(",").map(function(e){return e.trim()}):[];var r=-1!==e.indexOf("editing"),t=r&&-1!==e.indexOf("create"),i=r&&-1!==e.indexOf("delete"),n=r&&-1!==e.indexOf("update");return r&&!(t||i||n)&&(t=i=n=!0),{operations:{supportsAdd:t,supportsDelete:i,supportsEditing:r,supportsQuery:-1!==e.indexOf("query"),supportsUpdate:n}}},_readObjectIdField:function(e){if(e.objectIdField)return e.objectIdField;if(e.fields)for(var r=0;r<e.fields.length;r++){var t=e.fields[r];if("esriFieldTypeOID"===t.type)return t.name}},_readRenderer:function(e,r,t){var i;if(e=r.drawingInfo&&r.drawingInfo.renderer||void 0)e=D.read(e,r,t)||void 0,e||z.error("Failed to create renderer",{rendererDefinition:r.drawingInfo.renderer,layer:this,context:t});else if(r.defaultSymbol)I.read(r.defaultSymbol,r,t),r.types&&r.types.length?(e=new S({defaultSymbol:i,field:r.typeIdField}),r.types.forEach(function(r){e.addUniqueValueInfo(r.id,I.read(r.symbol,r,t))})):e=new _({symbol:i});else if("Table"!==r.type){switch(r.geometryType){case"esriGeometryPoint":case"esriGeometryMultipoint":i=new b;break;case"esriGeometryPolyline":i=new F;break;case"esriGeometryPolygon":i=new w}e=i&&new _({symbol:i})}return e},_readTypeIdField:function(e,r){if(e){var t=this.getField(e,r.fields);t&&(e=t.name)}return e},_readTypes:function(e,r){var t=r.editFieldsInfo,i=t&&t.creatorField,n=t&&t.editorField;return e&&e.map(function(e){return e=new C(e),this._fixTemplates(e.templates,i),this._fixTemplates(e.templates,n),e},this)},_readVersion:function(e){return e.currentVersion?e.currentVersion:e.hasOwnProperty("capabilities")||e.hasOwnProperty("drawingInfo")||e.hasOwnProperty("hasAttachments")||e.hasOwnProperty("htmlPopupType")||e.hasOwnProperty("relationships")||e.hasOwnProperty("timeInfo")||e.hasOwnProperty("typeIdField")||e.hasOwnProperty("types")?10:9.3},_processApplyEditsParams:function(e){var t="'addFeatures', 'updateFeatures' or 'deleteFeatures' parameter is required",n="feature-layer:missing-parameters";if(!e)return p.reject(new l(n,t));if(e=r.mixin({},e),e.addFeatures=e.addFeatures||[],e.updateFeatures=e.updateFeatures||[],e.deleteFeatures=e.deleteFeatures||[],e.addFeatures.length||e.updateFeatures.length||e.deleteFeatures.length){var s=function(e){var r=new i;return r.geometry=e.geometry,r.attributes=e.attributes,r};return e.addFeatures=e.addFeatures.map(s),e.updateFeatures=e.updateFeatures.map(s),this._normalizeGeometries(e).then(function(e){return p.resolve(e)})}return p.reject(new l(n,t))},_normalizeGeometries:function(e){var r=e.addFeatures,t=e.updateFeatures,i=function(e){return e.geometry},n=r.concat(t).map(i);return v.normalizeCentralMeridian(n).then(function(i){var n=r.length,s=t.length;return i.slice(0,n).forEach(function(r,t){e.addFeatures[t].geometry=r}),i.slice(n,n+s).forEach(function(r,t){e.updateFeatures[t].geometry=r}),e})}});return Z});