// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.21/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","../../kernel","../../Evented","../../graphic","../../dijit/PopupTemplate","../../dijit/Legend/utils","../../renderers/SimpleRenderer","../../symbols/SimpleMarkerSymbol","../GraphicsLayer","./GeohashAggregation"],function(e,t,r,i,n,a,s,l,o,u,c,h,d){var f=e(a,{declaredClass:"esri.layers.clustering.ClusterManager",layer:null,aggregationInfo:null,container:null,defaults:{clusterSize:80,markerSymbol:{color:[77,77,77,255],size:6,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[255,255,255,255],width:.75,type:"esriSLS",style:"esriSLSSolid"}}},_map:null,_eventHandles:null,_clusterSize:null,_renderer:null,_statisticInfos:null,_infoTemplate:null,_clusterGenerator:null,constructor:function(e){this._eventHandles=[],this.layer=e.layer,this.setAggregationInfo(e.aggregationInfo)},initialize:function(e){this._map=e,this.container=this._createContainer(),this._clusterGenerator=this._createClusterGenerator(),this._initClusterGenerator(),this._createLayerEventListeners(),this._createMapEventListeners()},destroy:function(){this._destroyEventListeners(),this._destroyClusterGenerator(),this._destroyContainer(),this.layer=this.aggregationInfo=this._map=null},setAggregationInfo:function(e){this.aggregationInfo=e,this._applyAggregationInfo()},getClusterRenderer:function(){return this._renderer},redraw:function(){this.container&&this.container.redraw()},isClusteringEnabled:function(){return this._clusterGenerator&&this._clusterGenerator.clustersEnabled},_createContainer:function(){var e=this.layer,t=new h._GraphicsLayer({_child:!0,id:e.id+"_clusters",visible:e.visible,minScale:e.minScale,maxScale:e.maxScale,infoTemplate:this._infoTemplate});return t.setRenderer(this._renderer),t.loaded=!0,t.onLoad(t),t._setMap(this._map,e._div),e._childLayer=t,t},_destroyContainer:function(){var e=this.container;e&&(e.clear(),e._unsetMap(this._map,this.layer._div),this.layer._childLayer=null),this.container=null},_createClusterGenerator:function(){var e=new d({map:this._map,layer:this.layer,clusterSize:this._clusterSize,statisticInfos:this._statisticInfos});return e},_initClusterGenerator:function(){var e=this._clusterGenerator;e.loaded?(this._applyRenderer(),this._initClusterUpdates()):this._eventHandles.push(e.on("load",t.hitch(this,function(){this._applyRenderer(),this._initClusterUpdates()})),e.on("load-error",t.hitch(this,function(e){console.log(e.error)}))),this._eventHandles.push(e.on("mode-change",t.hitch(this,function(){this.emit("mode-change")})))},_destroyClusterGenerator:function(){this._clusterGenerator&&this._clusterGenerator.destroy(),this._clusterGenerator=null},_applyAggregationInfo:function(){this._applyClusterSize(),this._applyRenderer(),this._clusterGenerator&&!this._clusterGenerator.isUpdateScheduled()&&this.redraw()},_applyClusterSize:function(){var e=this.aggregationInfo;this._clusterSize=e&&e.clusterSize||this.defaults.clusterSize,this._clusterGenerator&&this._clusterGenerator.setClusterSize(this._clusterSize)},_applyRenderer:function(){var e="avg";this._renderer=this._getRenderer(this.aggregationInfo,e),this._statisticInfos=this._createStatisticInfos(this._renderer,e),this._clusterGenerator&&this._clusterGenerator.setStatisticInfos(this._statisticInfos),this.container&&(this.container.setRenderer(this._renderer),this.emit("renderer-change"),r.forEach(this.container.graphics,function(e){e.setAttributes(e._cluster.attributes)})),this._applyInfoTemplate()},_applyInfoTemplate:function(){this._infoTemplate=this._getInfoTemplate(this.aggregationInfo,this._statisticInfos),this.container&&this.container.setInfoTemplate(this._infoTemplate)},_getRenderer:function(e,t){var r=e&&e.renderer;if(!r){var i=this.layer&&this.layer.renderer;r=i?this._createClusterRenderer(i,t):this._getDefaultClusterRenderer()}return r},_getDefaultClusterRenderer:function(){var e=new u(new c(this.defaults.markerSymbol));return this._addSizeByCountVariable(e),e},_createClusterRenderer:function(e,t){if(!this._isSupportedRenderer(e))return this._getDefaultClusterRenderer();var r=new e.constructor(e.toJson()),i=t+"_";r.attributeField=i+r.attributeField,r.normalizationField&&(r.normalizationField=i+r.normalizationField),r.setVisualVariables(null);var n=this._getSupportedVariables(e),a=this._createClusterVariables(n.allVars,t);return r.setVisualVariables(a),n.sizeVars.length||this._addSizeByCountVariable(r),r},_isSupportedRenderer:function(e){var t=e.declaredClass.toLowerCase();return t.indexOf("simplerenderer")>-1?!0:t.indexOf("classbreaksrenderer")>-1?e.valueExpression?!1:e.isContinuousRenderer():!1},_getSupportedVariables:function(e){var t=e.getVisualVariablesForType("colorInfo",!1)||[],i=e.getVisualVariablesForType("sizeInfo",!1)||[],n=e.getVisualVariablesForType("opacityInfo",!1)||[];return t=r.filter(t,this._variableFilter),i=r.filter(i,this._variableFilter),n=r.filter(n,this._variableFilter),{colorVars:t,sizeVars:i,opacityVars:n,allVars:t.concat(i).concat(n)}},_variableFilter:function(e){return"string"==typeof e.field},_createClusterVariables:function(e,t){return r.map(e,function(e){return this._createVarForAvg(e,t)},this)},_createVarForAvg:function(e,r){var i=t.clone(e),n=r+"_";return i.field=n+i.field,i.normalizationField&&(i.normalizationField=n+i.normalizationField),this._setVariableTitle(i,e),i},_setVariableTitle:function(e,t){var r=e.legendOptions&&e.legendOptions.title;r||(e.legendOptions=e.legendOptions||{},e.legendOptions.title=o.getVisualVariableTitle(t,this.layer))},_createStatisticInfos:function(e,t){var i=e.declaredClass.toLowerCase();if(-1!==i.indexOf("classbreaksrenderer")){var n=[e.attributeField,e.normalizationField];r.forEach(e.visualVariables,function(e){"count"!==e.field&&(n.push(e.field),n.push(e.normalizationField))}),n=r.filter(n,function(e){return!!e}),n.sort(),n=r.filter(n,function(e,t){return 0===t||n[t-1]!==e});var a=t+"_";return r.map(n,function(e){return{field:e.replace(a,""),type:t}})}},_addSizeByCountVariable:function(e){var t=this._createSizeByCountVariable();t&&this._addVariable(e,t)},_getSizeByCountVariable:function(e){var t=e.getVisualVariablesForType("sizeInfo",!1)||[];return r.filter(t,function(e){return"count"===e.field})[0]},_updateSizeByCountVariable:function(){var e=this._renderer,t=this._getSizeByCountVariable(e);if(t){var r=this._createSizeByCountVariable();r&&this._replaceVariable(e,t,r)}else this._addSizeByCountVariable(e)},_createSizeByCountVariable:function(){var e,t=this._clusterGenerator;if(t){var r=t.getCurrentLodStats();e={type:"sizeInfo",field:"count",valueUnit:"unknown",minSize:8,maxSize:50,minDataValue:r.min,maxDataValue:r.max,legendOptions:{title:"Number of features"}}}return e},_addVariable:function(e,t){var r=e.visualVariables||[];r.push(t),e.setVisualVariables(r)},_replaceVariable:function(e,t,i){var n=e.visualVariables,a=r.indexOf(n,t);a>-1&&n.splice(a,1),n.push(i),e.setVisualVariables(n)},_getInfoTemplate:function(e,t){var i=e&&e.infoTemplate;if(!i){var n=this.layer,a=[{fieldName:"count",visible:!0,label:"Number of features",format:{digitSeparator:!0,places:0}}],s=[];r.forEach(t,function(e){var t=e.type+"_"+e.field;a.push({fieldName:t,visible:!0,label:"Average "+n.getFieldLabel(e.field),format:{digitSeparator:!0,places:1}}),s.push("Average <b>"+n.getFieldLabel(e.field)+"</b> within this cluster is <b>{"+t+"}</b>.<br>")});var o=s.length?"<br>"+s.join(""):"";i=new l({fieldInfos:a,description:"This cluster represents <b>{count}</b> features.<br>"+o})}return i},_removeFromPopup:function(e){var t=this._map.infoWindow,i=t.features,n=[];r.forEach(i,function(t,r){t.getLayer()===e&&n.push(r)}),n.length&&(n.sort(function(e,t){return t-e}),i=i.slice(0),r.forEach(n,function(e){i.splice(e,1)}),t.setFeatures(i),i.length||t.hide())},_initClusterUpdates:function(){this._updateClusters(!0,!1),this._eventHandles.push(this._clusterGenerator.on("update-end",t.hitch(this,function(e){this._updateClusters(e.levelChange,e.modeChange)})))},_updateClusters:function(e,t){this.isClusteringEnabled()&&t&&this._removeFromPopup(this.layer);var i=r.map(this._clusterGenerator.clusters,function(e){var t=new s(e.centroid,null,e.attributes);return t._cluster=e,t});this._addGraphics(i,e)},_addGraphics:function(e,t){var i=this.container;i.clear();var n=this.aggregationInfo&&this.aggregationInfo.renderer;t&&this.isClusteringEnabled()&&this._renderer!==n&&(this._updateSizeByCountVariable(),this.emit("renderer-change")),r.forEach(e,function(e){i.add(e)})},_createLayerEventListeners:function(){var e=this.layer;this._eventHandles.push(e.on("visibility-change",t.hitch(this,function(e){this.container.setVisibility(e.visible),this.container.evaluateSuspension()})),e.on("scale-range-change",t.hitch(this,function(){this.container.setScaleRange(this.layer.minScale,this.layer.maxScale)})),e.on("renderer-change",t.hitch(this,function(){this._applyRenderer()})))},_createMapEventListeners:function(){this._eventHandles.push(this._map.on("zoom-start",t.hitch(this,function(e){this.isClusteringEnabled()&&this._removeFromPopup(this.container),this.container.clear()})))},_destroyEventListeners:function(){r.forEach(this._eventHandles,function(e){e.remove()})}});return i("extend-esri")&&t.setObject("layers.clustering.ClusterManager",f,n),f});