// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel","../SpatialReference","../srUtils","../tasks/query","./RenderMode","./support/ParallelSnapshot"],function(e,t,r,a,i,s,n,h,u){var l=e([h],{declaredClass:"esri.layers._SnapshotMode",maxFeatures:5e4,constructor:function(e){this.featureLayer=e,this._featureMap={},this._hasPartialFeatures=!1,this._drawFeatures=t.hitch(this,this._drawFeatures),this._queryErrorHandler=t.hitch(this,this._queryErrorHandler),this._handleSuccess=t.hitch(this,this._handleSuccess),this._handleError=t.hitch(this,this._handleError),this._handleProgress=t.hitch(this,this._handleProgress)},startup:function(){if(!this._started){this.inherited(arguments);var e=this.featureLayer,t=e.advancedQueryCapabilities,r=e.reHostedFS.test(e.url);this.pagination=e.queryPagination&&null!=e.maxRecordCount,this._tileQueriesAllowed=r&&t&&t.supportsQueryWithResultType&&e.isFeatureReductionApplied(),r&&this.pagination&&(this._parallelSnapshot=new u({layer:e,mode:this,queryTask:e._task})),e._collection?this._applyTimeFilter():this._fetchAll()}},propertyChangeHandler:function(e){this._init&&(e?this.featureLayer._collection?console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id = "+this.featureLayer.id):this._fetchAll():this._applyTimeFilter())},destroy:function(){this._cancelPendingRequest(this._pendingRequest),this._parallelSnapshot&&this._parallelSnapshot.destroy(),this.inherited(arguments)},drawFeature:function(e){var t=this.featureLayer,r=t.objectIdField,a=e.attributes[r];this._addFeatureIIf(a,e),this._incRefCount(a)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var e=this.featureLayer;e._collection?(e._fireUpdateStart(),e._refresh(!0),e._fireUpdateEnd()):this._fetchAll()},hasAllFeatures:function(){return!this._hasPartialFeatures},_fetchAll:function(){var e=this.featureLayer;e._collection||e.suspended||!e.isQueryable()||(e._fireUpdateStart(),this._clearIIf(),this._hasPartialFeatures=!1,this._parallelSnapshot?this._parallelSnapshot.fetch(this._createQuery()).then(this._handleSuccess,this._handleError,this._handleProgress):this._sendRequest())},_handleSuccess:function(e){this._hasPartialFeatures=e.hasPartialFeatures,this.featureLayer._fireUpdateEnd(null)},_handleError:function(e){this._queryErrorHandler(e)},_handleProgress:function(e){e.isError?this.featureLayer._errorHandler(e.error):this._addFeatures(e.features)},_sendRequest:function(e){var t=this.featureLayer,r=this._createQuery();this.pagination&&(this._start=r.start=null==e?0:e,r.num=t.maxRecordCount),this._pendingRequest&&this._cancelPendingRequest(this._pendingRequest),this._pendingRequest=t._task.execute(r,this._drawFeatures,this._queryErrorHandler)},_drawFeatures:function(e){this._pendingRequest=null;var t=this.featureLayer,r=e.exceededTransferLimit,a=r&&!t._collection,i=this._checkMaxLimit(e.features),s=i.maxLimitReached;this._addFeatures(i.features),this.pagination&&a&&!s||(this._hasPartialFeatures=!!r,t._fireUpdateEnd(null,r?{queryLimitExceeded:!0}:null)),a&&(this.pagination&&!s&&this._sendRequest(this._start+t.maxRecordCount),t.onQueryLimitExceeded())},_queryErrorHandler:function(e){this._pendingRequest=null,this._hasPartialFeatures=!0;var t=this.featureLayer;t._errorHandler(e),t._fireUpdateEnd(e)},_checkMaxLimit:function(e){var t=e?e.length:0,r=this.featureLayer.graphics.length+t,a=r>=this.maxFeatures;if(a){var i=r-this.maxFeatures;i&&e.splice(t-i,i)}return{maxLimitReached:a,featuresDiscarded:r>this.maxFeatures,features:e}},_createQuery:function(){var e=this.featureLayer,t=new n;return t.outFields=e.getOutFields(),t.where=e.getDefinitionExpression()||"1=1",t.returnGeometry=!0,t.outSpatialReference=s.createSpatialReference(this.map.spatialReference.toJson()),t.timeExtent=e.getTimeDefinition(),t.maxAllowableOffset=e._maxOffset,t.quantizationParameters=e._quantizationParameters,t.orderByFields=e.supportsAdvancedQueries?e.getOrderByFields():null,t.multipatchOption=e.multipatchOption,e._ts&&(t._ts=(new Date).getTime()),this._tileQueriesAllowed&&(t.resultType="tile"),t},_addFeatures:function(e){var t,r,a,i,s=this.featureLayer,n=s.objectIdField,h=e.length,u=s._selectedFeatures,l=s.mode===s.constructor.MODE_AUTO;for(s._fireUpdateStart(),s._sortFeatures(e),t=0;h>t;t++)a=e[t],i=a.attributes[n],r=this._addFeatureIIf(i,a),this._incRefCount(i),l&&r!==a&&u[i]&&(r.setGeometry(a.geometry),r.setAttributes(a.attributes));this._applyTimeFilter(!0)}});return r("extend-esri")&&t.setObject("layers._SnapshotMode",l,a),l});