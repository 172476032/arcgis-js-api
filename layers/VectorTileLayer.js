// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/url","dojo/dom-construct","dojo/dom-style","dojo/has","dojo/Deferred","../lang","../domUtils","../urlUtils","../kernel","../config","../request","../SpatialReference","../geometry/Extent","./layer","./TileInfo","./unitBezier"],function(e,t,i,n,r,o,s,a,l,h,c,u,d,f,p,v,_,m,g){for(var y=t(_,{declaredClass:"esri.layers.VectorTileLayer",_mapsWithAttribution:["World_Basemap"],_eventMap:{"style-change":["style"]},constructor:function(e,t){this._displayLevels=t?t.displayLevels:null,this._serviceOverrides={},t&&t.tileServers&&t.tileServers.length&&(this._serviceOverrides.tileServers=t.tileServers.map(function(e){return K.isMapboxUrl(e)?e:c.getAbsoluteUrl(c.urlToObject(e).path)},this));var i=e;if("string"==typeof e){var n=K.isMapboxUrl(e),r=n?e:c.getAbsoluteUrl(e);if(!n){var o=/token=([^&]+)/i,s=o.exec(r);s&&(r=c.urlToObject(e).path,this._serviceOverrides.credential={url:r,token:s[1]})}urlOrObbject=r}this.setStyle(i),this.registerConnectEvents()},setStyle:function(e){return e?this._loadStyle(e):void 0},opacity:1,setOpacity:function(e){this.opacity!=e&&this.onOpacityChange(this.opacity=e)},onOpacityChange:function(){},refresh:function(){},_loadStyle:function(t){return(new a).resolve().then(function(){var t=new a,i=null==s("ie")||s("ie")>9;return i?w?w.supported()?t.resolve():t.reject(new Error("layer not supported"),!0):e(["./vector-tile"],function(e){w=e,w.supported()?t.resolve():t.reject(new Error("layer not supported"),!0)}):t.reject(new Error("layer not supported"),!0),t.promise}).then(function(){return w.tokenHandler?S=w.tokenHandler:(S=new $,w.tokenHandler=S),this._serviceOverrides&&this._serviceOverrides.credential&&S.addToken(this._serviceOverrides.credential),K.loadMetadata(t,this._serviceOverrides)}.bind(this)).then(i.hitch(this,function(e){var i=e.layerDefinition;if(this.serviceUrl=e.serviceUrl||null,this.styleUrl=e.styleUrl||null,i){this.spatialReference=i.initialExtent&&i.initialExtent.spatialReference&&new p(i.initialExtent.spatialReference),this.initialExtent=i.initialExtent&&new v(i.initialExtent),this.fullExtent=i.fullExtent&&new v(i.fullExtent),this.version=i.currentVersion,this.tileInfo=new m(i.tileInfo),l.isDefined(i.minScale)&&!this._hasMin&&this.setMinScale(i.minScale),l.isDefined(i.maxScale)&&!this._hasMax&&this.setMaxScale(i.maxScale);var n=null;if(t){var r=c.urlToObject(e.serviceUrl),o=r.path.toLowerCase();n=this._getDefaultAttribution(this._getMapName(o))}n&&(this.attributionDataUrl=n,this.hasAttributionData=!0)}else this.spatialReference=U,this.initialExtent=A,this.fullExtent=D,this.tileInfo=z,this.version=null;for(var s,a=this.tileInfo,h=a.lods,d=this.scales=[],f=this._displayLevels,_=-1/0,g=1/0,y=0,S=h.length;S>y;y++)s=h[y],f&&-1===f.indexOf(s.level)||(d[y]=s.scale,_=s.scale>_?s.scale:_,g=s.scale<g?s.scale:g);_===-1/0||this._hasMin||this.setMinScale(_),1/0===g||this._hasMax||this.setMaxScale(g),this.style=e.style,this.gl&&(w.identityManager=u.id,this._applyGLStyle(this.style)),this.onStyleChange(this.style)})).then(i.hitch(this,function(){this.loaded||this.loadError||(this.loaded=!0,this.onLoad(this))})).otherwise(i.hitch(this,function(e){throw this._errorHandler(e),e}))},_setMap:function(e,t){this.inherited(arguments),this._map=e;var n=this._div=r.create("div",null,t),s={position:"absolute",width:e.width+"px",height:e.height+"px",overflow:"visible",opacity:this.opacity};if(o.set(n,s),this._onResizeHandle=e.on("resize",i.hitch(this,this._onResizeHandler)),this._onOpacityHandle=this.on("opacity-change",i.hitch(this,this._opacityChangeHandler)),w.identityManager=u.id,this.gl=new w.Renderer({container:n}),this.gl.setSize(e.width,e.height),this._applyGLStyle(this.style),this.evaluateSuspension(),this.suspended&&!e.loaded)var a=e.on("load",i.hitch(this,function(){a.remove(),this.evaluateSuspension()}));return n},_unsetMap:function(){this.gl.remove(),this.gl=null,r.destroy(this._div),this._map=this._div=null,this._onResizeHandle=this._onResizeHandle&&this._onResizeHandle.remove()&&null,this._onOpacityHandle=this._onOpacityHandle&&this._onOpacityHandle.remove()&&null,this._disableDrawConnectors(),this._animation&&(this._animation.stop(),this._animation=null),this.inherited(arguments)},_applyGLStyle:function(e){var t=this.gl;if(t){if(!e)return void t.setStyle(null);e.animationLoop=t.animationLoop,t.setStyle(e),e._loaded&&(Object.getOwnPropertyNames(e.sources).forEach(function(e){this.fire("source.add",{source:this.sources[e]})},e),e.fire("load"),e.sprite.loaded()&&e.fire("change"))}},_enableDrawConnectors:function(){var e=this._map;e&&(this._panHandle=e.on("pan",i.hitch(this,this._onPanExtentChangeHandler)),this._extentChangeHandle=e.on("extent-change",i.hitch(this,this._onPanExtentChangeHandler)),this._onScaleHandle=e.on("scale",i.hitch(this,this._onScaleHandler)))},_disableDrawConnectors:function(){this._onScaleHandle=this._onScaleHandle&&this._onScaleHandle.remove()&&null,this._panHandle=this._panHandle&&this._panHandle.remove()&&null,this._extentChangeHandle=this._extentChangeHandle&&this._extentChangeHandle.remove()&&null},_getZoom:function(e,t){var i=this.tileInfo,n=i.lods,r=null,o=null,t=0,s=n.length-1;for(t;s>t;t++){if(r=n[t],o=n[t+1],r.scale<=e)return t;if(o.scale===e)return t+1;if(r.scale>e&&o.scale<e)return t=t+1-(e-o.scale)/(r.scale-o.scale),t=Math.ceil(t)-Math.log(Math.abs(Math.ceil(t)-t+1))/Math.LN2,(t-Math.floor(t)>.995||t-Math.floor(t)<.005)&&(t=Math.round(t)),t}return e>n[0].scale?n[0].level:n[n.length-1].level},_isMapAtVisibleScale:function(){var e=this.inherited(arguments);if(e){for(var t=this._map,i=this.scales,n=t.getScale(),r=!1,o=t.width>t.height?t.width:t.height,s=0,a=i.length;a>s;s++)if(Math.abs(i[s]-n)/i[s]<1/o){r=!0;break}e=r}return e},_getMapName:function(e){var t=e.match(/^https?\:\/\/(basemaps|basemapsbeta)\.arcgis\.com\/arcgis\/rest\/services\/([^\/]+(\/[^\/]+)*)\/vectortileserver/i);return t&&t[2]},_getDefaultAttribution:function(e){if(e){var t;e=e.toLowerCase();for(var i=0,n=this._mapsWithAttribution.length;n>i;i++)if(t=this._mapsWithAttribution[i],t.toLowerCase().indexOf(e)>-1)return"file:"===window.location.protocol?"http:":window.location.protocol+"//static.arcgis.com/attribution/Vector/"+t}},onStyleChange:function(){},_opacityChangeHandler:function(e){this.gl&&(this._div.style.opacity=e.opacity)},_onResizeHandler:function(e){if(this.gl){var t=e.extent.getCenter();this.gl.setSize(e.width,e.height),this.gl.jumpTo({center:[t.getLongitude(),t.getLatitude()]}),this._div.style.width=e.width+"px",this._div.style.height=e.height+"px"}},onSuspend:function(){this.inherited(arguments),h.hide(this._div),this._disableDrawConnectors()},onResume:function(){if(this.inherited(arguments),this.gl&&this.style){h.show(this._div);var e=this._map,t=this._getZoom(e.getScale()),i=e.extent.getCenter();this._animate(i,t,!0)}this._enableDrawConnectors()},_onPanExtentChangeHandler:function(e){var t=this._map,i=this._getZoom(t.getScale()),n=e.extent.getCenter();this._animate(n,i,!0)},_onScaleHandler:function(e){var t=this._map,i=t._zoomAnimDiv.anchor,n=t._zoomAnimDiv.extent.getCenter(),r=this._getZoom(t._zoomAnimDiv.newLod.scale,t._zoomAnimDiv.newLod.level);this._animate(n,r,e.immediate,i)},_animate:function(e,t,i,n){this._animation&&(this._animation.stop(),this._animation=null),this._animation=Z(this.gl,e.getLongitude(),e.getLatitude(),t,i,this._map,n)}}),w=null,S=null,b=512,x=40075016.68557849,M=39.37007874015748,O=x/b,C=Object.freeze||function(){},H=[],E=0;20>E;E++){var j=O/Math.pow(2,E),k=Math.floor(96*j*M);H.push({level:E,scale:k,resolution:j})}var z=new m({rows:b,cols:b,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},spatialReference:{wkid:102100},lods:H});C(z);var U=new p(102100);C(U);var A=new v(-20037508.34,-20037508.34,20037508.34,20037508.34,U);C(A);var D=new v(-20037508.34,-20037508.34,20037508.34,20037508.34,U);C(D);var L,T=function(){var e,t=window.performance||{},i=t.now||t.webkitNow||t.msNow||t.oNow||t.mozNow;return void 0!==i?function(){return i.call(t)}:(e=window.performance&&window.performance.timing&&window.performance.timing.navigationStart?window.performance.timing.navigationStart:(new Date).getTime(),function(){return(new Date).getTime()-e})}(),R=s("ff"),N=s("ie"),P=s("webkit"),I=s("opera"),V=(new Date).getTime(),q=window.requestAnimationFrame;q||(L=P&&"webkit"||R&&"moz"||I&&"o"||N&&"ms",q=window[L+"RequestAnimationFrame"],q||(q=function(e){var t=T(),i=Math.max(0,16-(t-V)),n=window.setTimeout(function(){e(T())},i);return V=t+i,n}));var W=g.ease,Z=function(e,t,i,n,r,o,s){if(r=r||0===d.defaults.map.zoomDuration)return e.jumpTo({center:[t,i],zoom:Math.ceil(n)-Math.log(Math.abs(Math.ceil(n)-n+1))/Math.LN2}),null;var a=!0,l=d.defaults.map.zoomDuration,h=e.transform.center.lat,c=e.transform.center.lng,u=e.transform.zoom,f=T()+16,p=s?[s.x-o.width/2,s.y-o.height/2]:null,v=function(){if(a){var r=T()+16,o=(r-f)/l;o>=1&&(o=1,a=!1);var s=W(o),d=u+(n-u)*s;if(d=Math.ceil(d)-Math.log(Math.abs(Math.ceil(d)-d+1))/Math.LN2,p)e.zoomTo(d,{animate:!1,offset:p});else{var _=h+(i-h)*s,m=c+(t-c)*s;e.jumpTo({center:[m,_],zoom:d})}a&&q(v)}};return v(),{stop:function(){a=!1}}},G=t(String,{constructor:function(e,t){this.value=e,this.token=t},valueOf:function(){var e=this.value,t=this.token;if(!t){var i=u.id&&u.id.findCredential(e);i&&i.token&&(t=i.token)}return t&&(e+=(-1===e.indexOf("?")?"?":"&")+"token="+t),e},toString:function(){return this.valueOf()},replace:function(e,t){return String.prototype.replace.call(this.valueOf(),e,t)}}),K={loadMetadata:function(e,t){var i=null,n=null,r=t&&t.credential;return(new a).resolve(e).then(function(){return w.config.ACCESS_TOKEN=y.ACCESS_TOKEN,"string"!=typeof e?e:(K.isMapboxUrl(e)?(n=e,i=w.normalizeStyleURL(e)):n=i=c.normalize(e).replace(/\/*$/,""),K._corsify(i),i=K._appendToken(i,r),f({url:i,content:{f:"json"},handleAs:"json"}))}).then(function(e){return K._processMetadata(n,e,t)}).then(function(e){return K._loadStyle(e,t)})},isMapboxUrl:function(e){return e.search(/^mapbox:\/\/styles\//)>-1},_appendToken:function(e,t){return t&&t.token?e+=(-1===e.indexOf("?")?"?":"&")+"token="+t.token:e},_configureStyle:function(e,t){var i=e.layerDefinition,n=e.style,r=e.serviceUrl,o=e.styleUrl,s=K._getAbsolutePath,a=K._corsify;if(i&&n&&n.sources.esri){var l=i.tilejson||"2.0.0",h=i.tileInfo&&i.tileInfo.format||"pbf",c=i.tileMap?a(s(i.tileMap,r)):null,u=(i.tiles||[]).map(function(e){return new G(K._getAbsolutePath(e,r),t&&t.credential&&t.credential.token)});n.sources.esri={type:"vector",scheme:"xyz",tilejson:l,format:h,index:c,tiles:u,description:i.description,name:i.name},u.forEach(a),n.glyphs=a(s(n.glyphs,o)),n.sprite=a(s(n.sprite,o))}return{style:n,layerDefinition:i,serviceUrl:r,styleUrl:o}},_loadStyle:function(e,t){var n=new a,r=e.style,o=r.sources;t&&t.tileServers&&Object.getOwnPropertyNames(o).forEach(i.hitch(this,function(i){var n=o[i],r=t.tileServers.map(function(i){return new G(K._getAbsolutePath(i,e.serviceUrl,t))});n.tiles=r,r.forEach(K._corsify)})),w.identityManager=u.id,r=new w.Style(r);var s=function(){r.off("load",s),r.off("error",l),e.style=r,n.resolve(e)},l=function(e){r.off("load",s),r.off("error",l),n.reject(e)};return r.on("load",s),r.on("error",l),n.promise},_getAbsolutePath:function(e,t){var i;if(t=t||"",t=c.urlToObject(t).path,/^https?:\/\//i.test(e))i=e;else{if(0===e.indexOf("//"))return location.protocol+e;t=t.replace(/(\/+\w+\.\w+)$/,""),/\/+$/.test(t)||(t+="/"),0===e.indexOf("/")?(e=e.substring(1),i=t+e):i=t+e}return c.normalize(i)},_corsify:function(e){e=e.valueOf();var t=d.defaults.io.corsEnabledServers;if(!c.canUseXhr(e)){var i=new n(e);i=(i.host+(i.port?":"+i.port:"")).toLowerCase(),-1===t.indexOf(i)&&t.push(i)}return e},_processMetadata:function(e,t,n){var r,o,s,a={},l=K._getAbsolutePath,h=K._configureStyle,c=K._corsify,u=n&&n.credential;return delete t._ssl,t.currentVersion?(r=t,o=e,s=l(t.defaultStyles,o),f({url:K._appendToken(s,u),content:{f:"json"},handleAs:"json"}).then(i.hitch(this,function(e){return h({style:e,layerDefinition:r,styleUrl:s,serviceUrl:o},n)}))):(a=t,s=e,t.sources.esri&&t.sources.esri.url?(o=c(l(t.sources.esri.url,s)),f({url:K._appendToken(o,u),content:{f:"json"},handleAs:"json"}).then(i.hitch(this,function(e){return h({style:a,layerDefinition:e,styleUrl:s,serviceUrl:o},n)}))):h({style:a}))}},$=t([],{constructor:function(){this._credentials=[]},addToken:function(e){if(!e||!e.url||!e.token)return!1;var t=this.getServiceRoot(e.url);this._credentials.push({rootUrl:t,token:e.token})},findCredential:function(e){var t=-1,i=this._credentials,n=this.getServiceRoot(e);return i.some(function(e,i){var r=e.rootUrl;return r===n?(t=i,!0):void 0}),t>-1?i[t]:null},getServiceRoot:function(e){var t=/(.+\/rest\/services\/.*\/?vectortileserver)/i,i=/(.+\/sharing\/.*)/i;return t.test(e)?e.match(t)[1].toLowerCase():i.test(e)?e.match(i)[1].toLowerCase():null},shareSameService:function(e,t){return e=this.getServiceRoot(e),t=this.getServiceRoot(t),e=e.substr(e.indexOf(":")),t=t.substr(t.indexOf(":")),e===t}});return y.ACCESS_TOKEN=null,y});