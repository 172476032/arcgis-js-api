// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["./Jpg","./Zlib"],function(e,t){"use strict";var n=function(){var e=new ArrayBuffer(4),t=new Uint8Array(e),n=new Uint32Array(e);t[0]=1,t[1]=2,t[2]=3,t[3]=4;var a=67305985===n[0];return a},a=function(){var e=[];return e[254]="NEWSUBFILETYPE",e[255]="SUBFILETYPE",e[256]="IMAGEWIDTH",e[257]="IMAGELENGTH",e[258]="BITSPERSAMPLE",e[259]="COMPRESSION",e[262]="PHOTOMETRICINTERPRETATION",e[263]="THRESHHOLDING",e[264]="CELLWIDTH",e[265]="CELLLENGTH",e[266]="FILLORDER",e[269]="DOCUMENTNAME",e[270]="IMAGEDESCRIPTION",e[271]="MAKE",e[272]="MODEL",e[273]="STRIPOFFSETS",e[274]="ORIENTATION",e[277]="SAMPLESPERPIXEL",e[278]="ROWSPERSTRIP",e[279]="STRIPBYTECOUNTS",e[280]="MINSAMPLEVALUE",e[281]="MAXSAMPLEVALUE",e[282]="XRESOLUTION",e[283]="YRESOLUTION",e[284]="PLANARCONFIGURATION",e[285]="PAGENAME",e[286]="XPOSITION",e[287]="YPOSITION",e[288]="FREEOFFSETS",e[289]="FREEBYTECOUNTS",e[290]="GRAYRESPONSEUNIT",e[291]="GRAYRESPONSECURVE",e[292]="T4OPTIONS",e[293]="T6OPTIONS",e[296]="RESOLUTIONUNIT",e[297]="PAGENUMBER",e[300]="COLORRESPONSEUNIT",e[301]="TRANSFERFUNCTION",e[305]="SOFTWARE",e[306]="DATETIME",e[315]="ARTIST",e[316]="HOSTCOMPUTER",e[317]="PREDICTOR",e[318]="WHITEPOINT",e[319]="PRIMARYCHROMATICITIES",e[320]="COLORMAP",e[321]="HALFTONEHINTS",e[322]="TILEWIDTH",e[323]="TILELENGTH",e[324]="TILEOFFSETS",e[325]="TILEBYTECOUNTS",e[326]="BADFAXLINES",e[327]="CLEANFAXDATA",e[328]="CONSECUTIVEBADFAXLINES",e[330]="SUBIFD",e[332]="INKSET",e[333]="INKNAMES",e[334]="NUMBEROFINKS",e[336]="DOTRANGE",e[337]="TARGETPRINTER",e[338]="EXTRASAMPLES",e[339]="SAMPLEFORMAT",e[340]="SMINSAMPLEVALUE",e[341]="SMAXSAMPLEVALUE",e[342]="TRANSFERRANGE",e[347]="JPEGTABLES",e[512]="JPEGPROC",e[513]="JPEGIFOFFSET",e[514]="JPEGIFBYTECOUNT",e[515]="JPEGRESTARTINTERVAL",e[517]="JPEGLOSSLESSPREDICTORS",e[518]="JPEGPOINTTRANSFORM",e[519]="JPEGQTABLES",e[520]="JPEGDCTABLES",e[521]="JPEGACTABLES",e[529]="YCBCRCOEFFICIENTS",e[530]="YCBCRSUBSAMPLING",e[531]="YCBCRPOSITIONING",e[532]="REFERENCEBLACKWHITE",e[33550]="GEOPIXELSCALE",e[33922]="GEOTIEPOINTS",e[33432]="COPYRIGHT",e[42112]="GDAL_METADATA",e[42113]="GDAL_NODATA",e[50844]="RPCCOEFFICIENT",e[34735]="GEOKEYDIRECTORY",e[34736]="GEODOUBLEPARAMS",e[34737]="GEOASCIIPARAMS",e}(),r=function(e){var t=a[e];return void 0===t&&(t="unknown"+e),t},i=[0,1,1,2,4,8,1,1,2,4,8,4,8],A=function(e){var t,n=new DataView(e,0,8),a=n.getUint16(0,!1);if(18761===a)t=!0;else{if(19789!==a)throw"unexpected endianess byte";t=!1}var r=n.getUint16(2,t);if(42!==r)throw"unexpected tiff identifier";var i=n.getUint32(4,t);return{littleEndian:t,firstIFD:i}},E=function(e,t){var n="UNKNOWN";return 3===e?n="F32":1===e?8>=t?n="U8":16>=t?n="U16":32>=t&&(n="U32"):2===e&&(8>=t?n="S8":16>=t?n="S16":32>=t&&(n="S32")),n},s=function(e,t,n){var a,r,A=[],E=n.fieldType,s=n.fieldValueCount,l=n.fieldValueOffset,T=l,I=i[E],S=8*I,o=s*I,f=s*i[E]*8;if(32>=f)if(t||(l>>>=32-f),1===s)A=[l];else for(r=0;s>r;r++)A.push(l<<S*r>>>32-S);else for(T=l;l+o>T;T+=I){switch(E){case 1:a=new DataView(e,T,1).getUint8(0);break;case 2:a=new DataView(e,T,1).getUint8(0);break;case 3:a=new DataView(e,T,2).getUint16(0,t);break;case 4:a=new DataView(e,T,4).getUint32(0,t);break;case 5:a=new DataView(e,T,4).getUint32(0,t)/new DataView(e,T+4,4).getUint32(0,t);break;case 6:a=new DataView(e,T,1).getInt8(0);break;case 8:a=new DataView(e,T,2).getInt16(0,t);break;case 9:a=new DataView(e,T,4).getInt32(0,t);break;case 10:a=new DataView(e,T,4).getInt32(0,t)/new DataView(e,T+4,4).getInt32(0,t);break;case 11:a=new DataView(e,T,4).getFloat32(0,t);break;case 12:a=new DataView(e,T,8).getFloat64(0,t);break;case 7:a=null;break;default:a=null}A.push(a)}if(2===E){var O="",w=A;for(A=[],r=0;r<w.length;r++)0===w[r]?(A.push(O),O=""):O+=String.fromCharCode(w[r])}return A},l=function(e,t){var n,a,i,A,E,l,T,I,S,o,f,O;n=t.littleEndian,a=t.firstIFD;for(var w=[];a;){for(i=new DataView(e,a,2).getUint16(0,n),A=a+2,a=new DataView(e,A+12*i,4).getUint32(0,n),f={},E=0;i>E;E++)l=new DataView(e,A,12),T=l.getUint16(0,n),I=l.getUint16(2,n),S=l.getUint32(4,n),o=l.getUint32(8,n),A+=12,7===I||I>12||(O={fieldTag:T,fieldType:I,fieldValueCount:S,fieldValueOffset:o},O.fieldValues=s(e,n,O),f[r(T)]={type:I,values:O.fieldValues});w.push(f)}return w},T=function(a,r,i){var A,s,l,T=n()===r.littleEndian,I=i.TILEOFFSETS?i.TILEOFFSETS.values:void 0;if(void 0!==I){var S=i.TILEBYTECOUNTS.values,o=i.TILEWIDTH.values[0],f=i.TILELENGTH.values[0],O=i.IMAGEWIDTH.values[0],w=i.IMAGELENGTH.values[0],N=O*w,R=i.BITSPERSAMPLE.values[0],U=i.SAMPLESPERPIXEL.values[0],u=i.SAMPLEFORMAT?i.SAMPLEFORMAT.values[0]:1,P=E(u,R),L=i.PLANARCONFIGURATION?i.PLANARCONFIGURATION.values[0]:1;if(1!==L)throw console.log("can only handle PLANARCONFIGURATION=1"),"can only handle PLANARCONFIGURATION=1";var c=i.COMPRESSION?i.COMPRESSION.values[0]:1;if(1!==c&&6!==c&&8!==c&&32946!==c)throw console.log("this compression is not supported at this moment"),"this compression is not supported at this moment";if(!(u>3)){3===u?(s=new Float32Array(N*U),l=Float32Array):1===u?8>=R?(s=new Uint8Array(N*U),l=Uint8Array):16>=R?(s=new Uint16Array(N*U),l=Uint16Array):32>=R&&(s=new Uint32Array(N*U),l=Uint32Array):2===u&&(8>=R?(s=new Int8Array(N*U),l=Int8Array):16>=R?(s=new Int16Array(N*U),l=Int16Array):32>=R&&(s=new Int32Array(N*U),l=Int32Array));var h,y,g,F,d,M,C,v,D,G,p,B,V,b,H,m,k,x,Y=Math.ceil(O/o);if(R%8===0)for(h=0;h<I.length;h++){if(M=Math.floor(h/Y)*f,C=h%Y*o,v=(M*O+C)*U,"U8"===P||"S8"===P||T){if(8===c||32946===c)b=new Uint8Array(a,I[h],S[h]),k=new t(b),x=k.getBytes(),V=new ArrayBuffer(x.length),b=new Uint8Array(V),b.set(x),b.length!==o*f*U*R/8&&console.log("tile byte counts is different than expected");else if(6===c){b=new Uint8Array(a,I[h],S[h]);var W=new e;W.parse(b);var X=W.getData(W.width,W.height);V=new ArrayBuffer(X.length),b=new Uint8Array(V),b.set(X)}else 1===c&&(S[h]!==o*f*U*R/8&&console.log("tile byte counts is different than expected"),V=a.slice(I[h],I[h]+S[h]));A=new l(V)}else{switch(8===c||32946===c?(b=new Uint8Array(a,I[h],S[h]),k=new t(b),b=k.getBytes(),V=new ArrayBuffer(b.length),H=new Uint8Array(V),b.length!==o*f*U*R/8&&console.log("tile byte counts is different than expected")):1===c&&(S[h]!==o*f*U*R/8&&console.log("tile byte counts is different than expected"),V=new ArrayBuffer(S[h]),b=new Uint8Array(a,I[h],S[h]),H=new Uint8Array(V)),P){case"U16":case"S16":for(g=0;g<b.length;g+=2)H[g]=b[g+1],H[g+1]=b[g];break;case"U32":case"S32":case"F32":for(g=0;g<b.length;g+=4)H[g]=b[g+3],H[g+1]=b[g+2],H[g+2]=b[g+1],H[g+3]=b[g]}A=new l(V)}for(G=0,D=v,B=Math.min(o,O-C),p=Math.min(f,w-M),F=0;p>F;F++)for(D=v+F*O*U,G=F*o*U,d=0;B*U>d;d++,D++,G++)s[D]=A[G]}var J={width:O,height:w,pixelType:P};if(1===U)J.pixels=[s];else for(J.pixels=[],h=0;U>h;h++){for(m=new l(N),y=0;N>y;y++)m[y]=s[y*U+h];J.pixels.push(m)}return J}}},I=function(a,r,i){var A,s,l,T=n()===r.littleEndian,I=i.STRIPOFFSETS?i.STRIPOFFSETS.values:void 0;if(void 0!==I){var S=i.STRIPBYTECOUNTS.values,o=i.ROWSPERSTRIP.values,f=i.IMAGEWIDTH.values[0],O=i.IMAGELENGTH.values[0],w=f*O,N=i.BITSPERSAMPLE.values[0],R=i.SAMPLESPERPIXEL.values[0],U=i.SAMPLEFORMAT?i.SAMPLEFORMAT.values[0]:1,u=E(U,N),P=i.PLANARCONFIGURATION?i.PLANARCONFIGURATION.values[0]:1;if(1!==P)throw console.log("can only handle PLANARCONFIGURATION=1"),"can only handle PLANARCONFIGURATION=1";var L=i.COMPRESSION?i.COMPRESSION.values[0]:1;if(1!==L&&6!==L&&8!==L&&32946!==L)throw console.log("compressed tiff is not supported at this moment"),"compressed tiff is not supported at this moment";if(!(U>3)){3===U?(s=new Float32Array(w*R),l=Float32Array):1===U?8>=N?(s=new Uint8Array(w*R),l=Uint8Array):16>=N?(s=new Uint16Array(w*R),l=Uint16Array):32>=N&&(s=new Uint32Array(w*R),l=Uint32Array):2===U&&(8>=N?(s=new Int8Array(w*R),l=Int8Array):16>=N?(s=new Int16Array(w*R),l=Int16Array):32>=N&&(s=new Int32Array(f*O*R),l=Int32Array));var c,h,y,g,F,d,M,C,v,D,G=o;if(N%8===0)for(c=0;c<I.length;c++){if(g=c*(o*f)*R,G=(c+1)*o>O?O-c*o:o,"U8"===u||"S8"===u||T){if(8===L||32946===L)d=new Uint8Array(a,I[c],S[c]),v=new t(d),D=v.getBytes(),F=new ArrayBuffer(D.length),d=new Uint8Array(F),d.set(D),d.length!==G*f*R*N/8&&console.log("strip byte counts is different than expected");else if(6===L){d=new Uint8Array(a,I[c],S[c]);var p=new e;p.parse(d);var B=p.getData(p.width,p.height);F=new ArrayBuffer(B.length),d=new Uint8Array(F),d.set(B)}else 1===L&&(S[c]!==G*f*R*N/8&&console.log("strip byte counts is different than expected"),F=a.slice(I[c],I[c]+S[c]));A=new l(F)}else{switch(6===L||8===L||32946===L?(d=new Uint8Array(a,I[c],S[c]),v=new t(d),d=v.getBytes(),F=new ArrayBuffer(d.length),M=new Uint8Array(F),d.length!==G*f*R*N/8&&console.log("strip byte counts is different than expected")):1===L&&(S[c]!==G*f*R*N/8&&console.log("strip byte counts is different than expected"),F=new ArrayBuffer(S[c]),d=new Uint8Array(a,I[c],S[c]),M=new Uint8Array(F)),u){case"U16":case"S16":for(y=0;y<d.length;y+=2)M[y]=d[y+1],M[y+1]=d[y];break;case"U32":case"S32":case"F32":for(y=0;y<d.length;y+=4)M[y]=d[y+3],M[y+1]=d[y+2],M[y+2]=d[y+1],M[y+3]=d[y]}A=new l(F)}s.set(A,g)}var V={width:f,height:O,pixelType:u};if(1===R)V.pixels=[s];else for(V.pixels=[],c=0;R>c;c++){for(C=new l(w),h=0;w>h;h++)C[h]=s[h*R+c];V.pixels.push(C)}return V}}},S={decode:function(e){var t=A(e),n=l(e,t);if(0===n.length)throw"no valid image file directory";var a,r,i=n[0],E=void 0===i.GDAL_NODATA||null===i.GDAL_NODATA?null:parseFloat(i.GDAL_NODATA.values[0]);if(i.TILEOFFSETS?r=T(e,t,i):i.STRIPOFFSETS&&(r=I(e,t,i)),null!==E){if(r.maskData=new Uint8Array(r.width*r.height),Math.abs(E)>1e24)for(a=0;a<r.width*r.height;a++)Math.abs((r.pixels[0][a]-E)/E)<1e-6?r.maskData[a]=0:r.maskData[a]=1;else for(a=0;a<r.width*r.height;a++)r.pixels[0][a]===E?r.maskData[a]=0:r.maskData[a]=1;r.noDataValue=E}return r}};return S});