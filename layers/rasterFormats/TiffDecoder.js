// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define([],function(){"use strict";var e=function(){var e=new ArrayBuffer(4),a=new Uint8Array(e),t=new Uint32Array(e);a[0]=1,a[1]=2,a[2]=3,a[3]=4;var n=67305985===t[0];return n},a=function(){var e=[];return e[254]="NEWSUBFILETYPE",e[255]="SUBFILETYPE",e[256]="IMAGEWIDTH",e[257]="IMAGELENGTH",e[258]="BITSPERSAMPLE",e[259]="COMPRESSION",e[262]="PHOTOMETRICINTERPRETATION",e[263]="THRESHHOLDING",e[264]="CELLWIDTH",e[265]="CELLLENGTH",e[266]="FILLORDER",e[269]="DOCUMENTNAME",e[270]="IMAGEDESCRIPTION",e[271]="MAKE",e[272]="MODEL",e[273]="STRIPOFFSETS",e[274]="ORIENTATION",e[277]="SAMPLESPERPIXEL",e[278]="ROWSPERSTRIP",e[279]="STRIPBYTECOUNTS",e[280]="MINSAMPLEVALUE",e[281]="MAXSAMPLEVALUE",e[282]="XRESOLUTION",e[283]="YRESOLUTION",e[284]="PLANARCONFIGURATION",e[285]="PAGENAME",e[286]="XPOSITION",e[287]="YPOSITION",e[288]="FREEOFFSETS",e[289]="FREEBYTECOUNTS",e[290]="GRAYRESPONSEUNIT",e[291]="GRAYRESPONSECURVE",e[292]="T4OPTIONS",e[293]="T6OPTIONS",e[296]="RESOLUTIONUNIT",e[297]="PAGENUMBER",e[300]="COLORRESPONSEUNIT",e[301]="TRANSFERFUNCTION",e[305]="SOFTWARE",e[306]="DATETIME",e[315]="ARTIST",e[316]="HOSTCOMPUTER",e[317]="PREDICTOR",e[318]="WHITEPOINT",e[319]="PRIMARYCHROMATICITIES",e[320]="COLORMAP",e[321]="HALFTONEHINTS",e[322]="TILEWIDTH",e[323]="TILELENGTH",e[324]="TILEOFFSETS",e[325]="TILEBYTECOUNTS",e[326]="BADFAXLINES",e[327]="CLEANFAXDATA",e[328]="CONSECUTIVEBADFAXLINES",e[330]="SUBIFD",e[332]="INKSET",e[333]="INKNAMES",e[334]="NUMBEROFINKS",e[336]="DOTRANGE",e[337]="TARGETPRINTER",e[338]="EXTRASAMPLES",e[339]="SAMPLEFORMAT",e[340]="SMINSAMPLEVALUE",e[341]="SMAXSAMPLEVALUE",e[342]="TRANSFERRANGE",e[512]="JPEGPROC",e[513]="JPEGIFOFFSET",e[514]="JPEGIFBYTECOUNT",e[515]="JPEGRESTARTINTERVAL",e[517]="JPEGLOSSLESSPREDICTORS",e[518]="JPEGPOINTTRANSFORM",e[519]="JPEGQTABLES",e[520]="JPEGDCTABLES",e[521]="JPEGACTABLES",e[529]="YCBCRCOEFFICIENTS",e[530]="YCBCRSUBSAMPLING",e[531]="YCBCRPOSITIONING",e[532]="REFERENCEBLACKWHITE",e[33432]="COPYRIGHT",e[42112]="GDAL_METADATA",e[42113]="GDAL_NODATA",e[50844]="RPCCOEFFICIENT",e[34735]="GEOKEYDIRECTORY",e[34736]="GEODOUBLEPARAMS",e[34737]="GEOASCIIPARAMS",e}(),t=function(e){var t=a[e];return void 0===t&&(t="unknown"+e),t},n=[0,1,1,2,4,8,1,1,2,4,8,4,8],r=function(e){var a,t=new DataView(e,0,8),n=t.getUint16(0,!1);if(18761===n)a=!0;else{if(19789!==n)throw"unexpected endianess byte";a=!1}var r=t.getUint16(2,a);if(42!==r)throw"unexpected tiff identifier";var E=t.getUint32(4,a);return{littleEndian:a,firstIFD:E}},E=function(e,a){var t="UNKNOWN";return 3===e?t="F32":1===e?8>=a?t="U8":16>=a?t="U16":32>=a&&(t="U32"):2===e&&(8>=a?t="S8":16>=a?t="S16":32>=a&&(t="S32")),t},A=function(e,a,t){var r,E,A=[],i=t.fieldType,T=t.fieldValueCount,I=t.fieldValueOffset,S=I,l=n[i],O=8*l,s=T*l,R=T*n[i]*8;if(32>=R)if(a||(I>>>=32-R),1===T)A=[I];else for(E=0;T>E;E++)A.push(I<<O*E>>>32-O);else for(S=I;I+s>S;S+=l){switch(i){case 1:r=new DataView(e,S,1).getUint8(0);break;case 2:r=new DataView(e,S,1).getUint8(0);break;case 3:r=new DataView(e,S,2).getUint16(0,a);break;case 4:r=new DataView(e,S,4).getUint32(0,a);break;case 5:r=new DataView(e,S,4).getUint32(0,a)/new DataView(e,S+4,4).getUint32(0,a);break;case 6:r=new DataView(e,S,1).getInt8(0);break;case 8:r=new DataView(e,S,2).getInt16(0,a);break;case 9:r=new DataView(e,S,4).getInt32(0,a);break;case 10:r=new DataView(e,S,4).getInt32(0,a)/new DataView(e,S+4,4).getInt32(0,a);break;case 11:r=new DataView(e,S,4).getFloat32(0,a);break;case 12:r=new DataView(e,S,8).getFloat64(0,a);break;case 7:r=null;break;default:r=null}A.push(r)}if(2===i){var N="",o=A;for(A=[],E=0;E<o.length;E++)0===o[E]?(A.push(N),N=""):N+=String.fromCharCode(o[E])}return A},i=function(e,a){var n,r,E,i,T,I,S,l,O,s,R,N;n=a.littleEndian,r=a.firstIFD;for(var o=[];r;){for(E=new DataView(e,r,2).getUint16(0,n),i=r+2,r=new DataView(e,i+12*E,4).getUint32(0,n),R={},T=0;E>T;T++)I=new DataView(e,i,12),S=I.getUint16(0,n),l=I.getUint16(2,n),O=I.getUint32(4,n),s=I.getUint32(8,n),i+=12,7===l||l>12||(N={fieldTag:S,fieldType:l,fieldValueCount:O,fieldValueOffset:s},N.fieldValues=A(e,n,N),R[t(S)]={type:l,values:N.fieldValues});o.push(R)}return o},T=function(a,t,n){var r,A,i,T=e()===t.littleEndian,I=n.TILEOFFSETS?n.TILEOFFSETS.values:void 0;if(void 0!==I){var S=n.TILEBYTECOUNTS.values,l=n.TILEWIDTH.values[0],O=n.TILELENGTH.values[0],s=n.IMAGEWIDTH.values[0],R=n.IMAGELENGTH.values[0],N=s*R,o=n.BITSPERSAMPLE.values[0],f=n.SAMPLESPERPIXEL.values[0],P=n.SAMPLEFORMAT?n.SAMPLEFORMAT.values[0]:1,L=E(P,o),U=n.PLANARCONFIGURATION?n.PLANARCONFIGURATION.values[0]:1;if(1!==U)throw console.log("can only handle PLANARCONFIGURATION=1"),"can only handle PLANARCONFIGURATION=1";if(!(P>3)){3===P?(A=new Float32Array(N*f),i=Float32Array):1===P?8>=o?(A=new Uint8Array(N*f),i=Uint8Array):16>=o?(A=new Uint16Array(N*f),i=Uint16Array):32>=o&&(A=new Uint32Array(N*f),i=Uint32Array):2===P&&(8>=o?(A=new Int8Array(N*f),i=Int8Array):16>=o?(A=new Int16Array(N*f),i=Int16Array):32>=o&&(A=new Int32Array(N*f),i=Int32Array));var w,u,F,c,C,M,D,v,y,G,h,d,g,p,V,B,H=Math.ceil(s/l);if(o%8===0)for(w=0;w<I.length;w++){if(M=Math.floor(w/H)*O,D=w%H*l,v=(M*s+D)*f,S[w]!==l*O*f*o/8&&console.log("tile byte counts is different than expected"),"U8"===L||"S8"===L||T)g=a.slice(I[w],I[w]+S[w]),r=new i(g);else{switch(g=new ArrayBuffer(S[w]),p=new Uint8Array(a,I[w],S[w]),V=new Uint8Array(g),L){case"U16":case"S16":for(F=0;F<p.length;F+=2)V[F]=p[F+1],V[F+1]=p[F];break;case"U32":case"S32":case"F32":for(F=0;F<p.length;F+=4)V[F]=p[F+3],V[F+1]=p[F+2],V[F+2]=p[F+1],V[F+3]=p[F]}r=new i(g)}for(G=0,y=v,d=Math.min(l,s-D),h=Math.min(O,R-M),c=0;h>c;c++)for(y=v+c*s*f,G=c*l*f,C=0;d*f>C;C++,y++,G++)A[y]=r[G]}var Y={width:s,height:R,pixelType:L};if(1===f)Y.pixels=[A];else for(Y.pixels=[],w=0;f>w;w++){for(B=new i(N),u=0;N>u;u++)B[u]=A[u*f+w];Y.pixels.push(B)}return Y}}},I=function(a,t,n){var r,A,i,T=e()===t.littleEndian,I=n.STRIPOFFSETS?n.STRIPOFFSETS.values:void 0;if(void 0!==I){var S=n.STRIPBYTECOUNTS.values,l=n.ROWSPERSTRIP.values,O=n.IMAGEWIDTH.values[0],s=n.IMAGELENGTH.values[0],R=O*s,N=n.BITSPERSAMPLE.values[0],o=n.SAMPLESPERPIXEL.values[0],f=n.SAMPLEFORMAT?n.SAMPLEFORMAT.values[0]:1,P=E(f,N),L=n.PLANARCONFIGURATION?n.PLANARCONFIGURATION.values[0]:1;if(1!==L)throw console.log("can only handle PLANARCONFIGURATION=1"),"can only handle PLANARCONFIGURATION=1";var U=n.COMPRESSION?n.COMPRESSION.values[0]:1;if(1!==U)throw console.log("compressed tiff is not supported at this moment"),"compressed tiff is not supported at this moment";if(!(f>3)){3===f?(A=new Float32Array(R*o),i=Float32Array):1===f?8>=N?(A=new Uint8Array(R*o),i=Uint8Array):16>=N?(A=new Uint16Array(R*o),i=Uint16Array):32>=N&&(A=new Uint32Array(R*o),i=Uint32Array):2===f&&(8>=N?(A=new Int8Array(R*o),i=Int8Array):16>=N?(A=new Int16Array(R*o),i=Int16Array):32>=N&&(A=new Int32Array(O*s*o),i=Int32Array));var w,u,F,c,C,M,D,v,y=l;if(N%8===0)for(w=0;w<I.length;w++){if(c=w*(l*O)*o,y=(w+1)*l>s?s-w*l:l,S[w]!==y*O*o*N/8&&console.log("strip byte counts is different than expected"),"U8"===P||"S8"===P||T)C=a.slice(I[w],I[w]+S[w]),r=new i(C);else{switch(C=new ArrayBuffer(S[w]),M=new Uint8Array(a,I[w],S[w]),D=new Uint8Array(C),P){case"U16":case"S16":for(F=0;F<M.length;F+=2)D[F]=M[F+1],D[F+1]=M[F];break;case"U32":case"S32":case"F32":for(F=0;F<M.length;F+=4)D[F]=M[F+3],D[F+1]=M[F+2],D[F+2]=M[F+1],D[F+3]=M[F]}r=new i(C)}A.set(r,c)}var G={width:O,height:s,pixelType:P};if(1===o)G.pixels=[A];else for(G.pixels=[],w=0;o>w;w++){for(v=new i(R),u=0;R>u;u++)v[u]=A[u*o+w];G.pixels.push(v)}return G}}},S={decode:function(e){var a=r(e),t=i(e,a);if(0===t.length)throw"no valid image file directory";var n,E,A=t[0],S=void 0===A.GDAL_NODATA||null===A.GDAL_NODATA?null:parseFloat(A.GDAL_NODATA.values[0]);if(A.TILEOFFSETS?E=T(e,a,A):A.STRIPOFFSETS&&(E=I(e,a,A)),null!==S){for(E.maskData=new Uint8Array(E.width*E.height),n=0;n<E.width*E.height;n++)E.pixels[0][n]===S?E.maskData[n]=0:E.maskData[n]=1;E.noDataValue=S}return E}};return S});