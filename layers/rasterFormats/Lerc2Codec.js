// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define([],function(){"use strict";var e={unstuff:function(e,t,r,a,i,n,s,f){var l,o,u,c,h,p=(1<<r)-1,d=0,g=0,x=4*e.length-Math.ceil(r*a/8);if(e[e.length-1]<<=8*x,i)for(l=0;l<a;l++)0===g&&(u=e[d++],g=32),g>=r?(o=u>>>g-r&p,g-=r):(c=r-g,o=(u&p)<<c&p,u=e[d++],g=32-c,o+=u>>>g),t[l]=i[o];else for(h=Math.ceil((f-n)/s),l=0;l<a;l++)0===g&&(u=e[d++],g=32),g>=r?(o=u>>>g-r&p,g-=r):(c=r-g,o=(u&p)<<c&p,u=e[d++],g=32-c,o+=u>>>g),t[l]=o<h?n+o*s:f},unstuffLUT:function(e,t,r,a,i,n){var s,f=(1<<t)-1,l=0,o=0,u=0,c=0,h=0,p=[],d=4*e.length-Math.ceil(t*r/8);e[e.length-1]<<=8*d;var g=Math.ceil((n-a)/i);for(o=0;o<r;o++)0===c&&(s=e[l++],c=32),c>=t?(h=s>>>c-t&f,c-=t):(u=t-c,h=(s&f)<<u&f,s=e[l++],c=32-u,h+=s>>>c),p[o]=h<g?a+h*i:n;return p.unshift(a),p},unstuff2:function(e,t,r,a,i,n,s,f){var l,o,u,c,h=(1<<r)-1,p=0,d=0,g=0;if(i)for(l=0;l<a;l++)0===d&&(u=e[p++],d=32,g=0),d>=r?(o=u>>>g&h,d-=r,g+=r):(c=r-d,o=u>>>g&h,u=e[p++],d=32-c,o|=(u&(1<<c)-1)<<r-c,g=c),t[l]=i[o];else{var x=Math.ceil((f-n)/s);for(l=0;l<a;l++)0===d&&(u=e[p++],d=32,g=0),d>=r?(o=u>>>g&h,d-=r,g+=r):(c=r-d,o=u>>>g&h,u=e[p++],d=32-c,o|=(u&(1<<c)-1)<<r-c,g=c),t[l]=o<x?n+o*s:f}return t},unstuffLUT2:function(e,t,r,a,i,n){var s,f=(1<<t)-1,l=0,o=0,u=0,c=0,h=0,p=0,d=[],g=Math.ceil((n-a)/i);for(o=0;o<r;o++)0===c&&(s=e[l++],c=32,p=0),c>=t?(h=s>>>p&f,c-=t,p+=t):(u=t-c,h=s>>>p&f,s=e[l++],c=32-u,h|=(s&(1<<u)-1)<<t-u,p=u),d[o]=h<g?a+h*i:n;return d.unshift(a),d},originalUnstuff:function(e,t,r,a){var i,n,s,f,l=(1<<r)-1,o=0,u=0,c=4*e.length-Math.ceil(r*a/8);for(e[e.length-1]<<=8*c,i=0;i<a;i++)0===u&&(s=e[o++],u=32),u>=r?(n=s>>>u-r&l,u-=r):(f=r-u,n=(s&l)<<f&l,s=e[o++],u=32-f,n+=s>>>u),t[i]=n;return t},originalUnstuff2:function(e,t,r,a){var i,n,s,f,l=(1<<r)-1,o=0,u=0,c=0;for(i=0;i<a;i++)0===u&&(s=e[o++],u=32,c=0),u>=r?(n=s>>>c&l,u-=r,c+=r):(f=r-u,n=s>>>c&l,s=e[o++],u=32-f,n|=(s&(1<<f)-1)<<r-f,c=f),t[i]=n;return t}},t={HUFFMAN_LUT_BITS_MAX:12,computeChecksumFletcher32:function(e){for(var t=65535,r=65535,a=e.length,i=Math.floor(a/2),n=0;i;){var s=i>=359?359:i;i-=s;do{t+=e[n++]<<8,r+=t+=e[n++]}while(--s);t=(65535&t)+(t>>>16),r=(65535&r)+(r>>>16)}return 1&a&&(r+=t+=e[n]<<8),t=(65535&t)+(t>>>16),((r=(65535&r)+(r>>>16))<<16|t)>>>0},readHeaderInfo:function(e,t){var r=t.ptr,a=new Uint8Array(e,r,6),i={};if(i.fileIdentifierString=String.fromCharCode.apply(null,a),0!==i.fileIdentifierString.lastIndexOf("Lerc2",0))throw"Unexpected file identifier string (expect Lerc2 ): "+i.fileIdentifierString;r+=6;var n=new DataView(e,r,52);i.fileVersion=n.getInt32(0,!0),r+=4,i.fileVersion>=3&&(i.checksum=n.getUint32(4,!0),r+=4),n=new DataView(e,r,48),i.height=n.getUint32(0,!0),i.width=n.getUint32(4,!0),i.numValidPixel=n.getUint32(8,!0),i.microBlockSize=n.getInt32(12,!0),i.blobSize=n.getInt32(16,!0),i.imageType=n.getInt32(20,!0),i.maxZError=n.getFloat64(24,!0),i.zMin=n.getFloat64(32,!0),i.zMax=n.getFloat64(40,!0),r+=48,t.headerInfo=i,t.ptr=r;if(i.fileVersion>=3&&this.computeChecksumFletcher32(new Uint8Array(e,r-48,i.blobSize-14))!==i.checksum)throw"Checksum failed.";return!0},readMask:function(e,t){var r=t.ptr,a=t.headerInfo,i=a.width*a.height,n=a.numValidPixel,s=new DataView(e,r,4),f={};if(f.numBytes=s.getUint32(0,!0),r+=4,(0===n||i===n)&&0!==f.numBytes)throw"invalid mask";var l,o;if(0===n)l=new Uint8Array(Math.ceil(i/8)),f.bitset=l,o=new Uint8Array(i),t.pixels.resultMask=o,r+=f.numBytes;else if(f.numBytes>0){l=new Uint8Array(Math.ceil(i/8)),s=new DataView(e,r,f.numBytes);var u=s.getInt16(0,!0),c=2,h=0,p=0;do{if(u>0)for(;u--;)l[h++]=s.getUint8(c++);else for(p=s.getUint8(c++),u=-u;u--;)l[h++]=p;u=s.getInt16(c,!0),c+=2}while(c<f.numBytes);if(-32768!==u||h<l.length)throw"Unexpected end of mask RLE encoding";o=new Uint8Array(i);var d=0,g=0;for(g=0;g<i;g++)7&g?(d=l[g>>3],d<<=7&g):d=l[g>>3],128&d&&(o[g]=1);t.pixels.resultMask=o,f.bitset=l,r+=f.numBytes}return t.ptr=r,t.mask=f,!0},readDataOneSweep:function(e,r,a){var i,n=r.ptr,s=r.headerInfo,f=s.width*s.height,l=s.imageType,o=s.numValidPixel*t.getDateTypeSize(l);if(a===Uint8Array)i=new Uint8Array(e,n,o);else{var u=new ArrayBuffer(o);new Uint8Array(u).set(new Uint8Array(e,n,o)),i=new a(u)}if(i.length===f)r.pixels.resultPixels=i;else{r.pixels.resultPixels=new a(f);var c=0,h=0;for(h=0;h<f;h++)r.pixels.resultMask[h]&&(r.pixels.resultPixels[h]=i[c++])}return n+=o,r.ptr=n,!0},readHuffman:function(e,a,i){var n=a.headerInfo,s=n.width*n.height,f=this.HUFFMAN_LUT_BITS_MAX,l=new DataView(e,a.ptr,16);if(a.ptr+=16,l.getInt32(0,!0)<2)throw"unsupported Huffman version";var o=l.getInt32(4,!0),u=l.getInt32(8,!0),c=l.getInt32(12,!0);if(u>=c)return!1;var h=new Uint32Array(c-u);t.decodeBits(e,a,h);var p,d,g,x,w=[];for(p=u;p<c;p++)d=p-(p<o?0:o),w[d]={first:h[p-u],second:null};var k=e.byteLength-a.ptr,y=Math.ceil(k/4),b=new ArrayBuffer(4*y);new Uint8Array(b).set(new Uint8Array(e,a.ptr,k));var m,I=new Uint32Array(b),U=0,v=0;for(m=I[0],p=u;p<c;p++)d=p-(p<o?0:o),(x=w[d].first)>0&&(w[d].second=m<<U>>>32-x,32-U>=x?32===(U+=x)&&(U=0,v++,m=I[v]):(U+=x-32,v++,m=I[v],w[d].second|=m>>>32-U));var M=0===a.headerInfo.imageType?128:0,A=a.headerInfo.height,S=a.headerInfo.width,T=0,V=0,B=new r;for(p=0;p<w.length;p++)void 0!==w[p]&&(T=Math.max(T,w[p].first));V=T>=f?f:T,T>=30&&console.log("WARning, large NUM LUT BITS IS "+T);var z,D,P,F,L,O,C=[];for(p=u;p<c;p++)if(d=p-(p<o?0:o),(x=w[d].first)>0)if(z=[x,d],x<=V)for(D=w[d].second<<V-x,P=1<<V-x,g=0;g<P;g++)C[D|g]=z;else for(D=w[d].second,O=B,F=x-1;F>=0;F--)L=D>>>F&1,L?(O.right||(O.right=new r),O=O.right):(O.left||(O.left=new r),O=O.left),0!==F||O.val||(O.val=z[1]);var H,E,_,X,Z=a.pixels.resultMask,N=0,Y=0;U>0&&(v++,U=0),m=I[v];var R=new i(s);if(a.headerInfo.numValidPixel===S*A)for(g=0,p=0;p<A;p++)for(d=0;d<S;d++,g++){if(H=0,_=m<<U>>>32-V,X=_,32-U<V&&(_|=I[v+1]>>>64-U-V,X=_),C[X])H=C[X][1],U+=C[X][0];else for(_=m<<U>>>32-T,X=_,32-U<T&&(_|=I[v+1]>>>64-U-T,X=_),O=B,Y=0;Y<T;Y++)if(L=_>>>T-Y-1&1,O=L?O.right:O.left,!O.left&&!O.right){H=O.val,U=U+Y+1;break}U>=32&&(U-=32,v++,m=I[v]),E=H-M,E+=d>0?N:p>0?R[g-S]:N,E&=255,R[g]=E,N=E}else for(g=0,p=0;p<A;p++)for(d=0;d<S;d++,g++)if(Z[g]){if(H=0,_=m<<U>>>32-V,X=_,32-U<V&&(_|=I[v+1]>>>64-U-V,X=_),C[X])H=C[X][1],U+=C[X][0];else for(_=m<<U>>>32-T,X=_,32-U<T&&(_|=I[v+1]>>>64-U-T,X=_),O=B,Y=0;Y<T;Y++)if(L=_>>>T-Y-1&1,O=L?O.right:O.left,!O.left&&!O.right){H=O.val,U=U+Y+1;break}U>=32&&(U-=32,v++,m=I[v]),E=H-M,d>0&&Z[g-1]?E+=N:p>0&&Z[g-S]?E+=R[g-S]:E+=N,E&=255,R[g]=E,N=E}a.pixels.resultPixels=R,a.ptr=a.ptr+4*(v+1)+(U>0?4:0)},decodeBits:function(t,r,a,i){var n=r.headerInfo.fileVersion,s=0,f=new DataView(t,r.ptr,5),l=f.getUint8(0);s++;var o=l>>6,u=0===o?4:3-o,c=(32&l)>0,h=31&l,p=0;if(1===u)p=f.getUint8(s),s++;else if(2===u)p=f.getUint16(s,!0),s+=2;else{if(4!==u)throw"Invalid valid pixel count type";p=f.getUint32(s,!0),s+=4}var d,g,x,w,k,y,b,m,I,U=2*r.headerInfo.maxZError;if(c){for(r.counter.lut++,m=f.getUint8(s),h,s++,w=Math.ceil((m-1)*h/8),k=Math.ceil(w/4),g=new ArrayBuffer(4*k),x=new Uint8Array(g),r.ptr+=s,x.set(new Uint8Array(t,r.ptr,w)),b=new Uint32Array(g),r.ptr+=w,I=0;m-1>>>I;)I++;w=Math.ceil(p*I/8),k=Math.ceil(w/4),g=new ArrayBuffer(4*k),x=new Uint8Array(g),x.set(new Uint8Array(t,r.ptr,w)),d=new Uint32Array(g),r.ptr+=w,y=n>=3?e.unstuffLUT2(b,h,m-1,i,U,r.headerInfo.zMax):e.unstuffLUT(b,h,m-1,i,U,r.headerInfo.zMax),n>=3?e.unstuff2(d,a,I,p,y):e.unstuff(d,a,I,p,y)}else r.counter.bitstuffer++,I=h,r.ptr+=s,I>0&&(w=Math.ceil(p*I/8),k=Math.ceil(w/4),g=new ArrayBuffer(4*k),x=new Uint8Array(g),x.set(new Uint8Array(t,r.ptr,w)),d=new Uint32Array(g),r.ptr+=w,n>=3?null==i?e.originalUnstuff2(d,a,I,p):e.unstuff2(d,a,I,p,!1,i,U,r.headerInfo.zMax):null==i?e.originalUnstuff(d,a,I,p):e.unstuff(d,a,I,p,!1,i,U,r.headerInfo.zMax))},readTiles:function(e,r,a){var i=r.headerInfo,n=i.width,s=i.height,f=i.microBlockSize,l=i.imageType,o=Math.ceil(n/f),u=Math.ceil(s/f);r.pixels.numBlocksY=u,r.pixels.numBlocksX=o,r.pixels.ptr=0;var c,h,p,d,g,x,w,k,y=0,b=0,m=0,I=0,U=0,v=0,M=0,A=0,S=0,T=0,V=0,B=0,z=0,D=0,P=0,F=new a(f*f),L=s%f||f,O=n%f||f;for(m=0;m<u;m++)for(U=m!==u-1?f:L,I=0;I<o;I++){if(v=I!==o-1?f:O,T=m*n*f+I*f,V=n-v,M=e.byteLength-r.ptr,c=new DataView(e,r.ptr,Math.min(10,M)),h={},P=0,A=c.getUint8(0),P++,S=A>>6&255,(A>>2&15)!==(I*f>>3&15))throw"integrity issue";if((x=3&A)>3)throw r.ptr+=P,"Invalid block encoding ("+x+")";if(2!==x)if(0===x){if(r.counter.uncompressed++,r.ptr+=P,B=U*v*t.getDateTypeSize(l),z=e.byteLength-r.ptr,B=B<z?B:z,p=new ArrayBuffer(B),d=new Uint8Array(p),d.set(new Uint8Array(e,r.ptr,B)),g=new a(p),D=0,r.pixels.resultMask)for(y=0;y<U;y++){for(b=0;b<v;b++)r.pixels.resultMask[T]&&(r.pixels.resultPixels[T]=g[D++]),T++;T+=V}else for(y=0;y<U;y++){for(b=0;b<v;b++)r.pixels.resultPixels[T++]=g[D++];T+=V}r.ptr+=D*t.getDateTypeSize(l)}else if(w=t.getDataTypeUsed(l,S),k=t.getOnePixel(h,P,w,c),P+=t.getDateTypeSize(w),3===x)if(r.ptr+=P,r.counter.constantoffset++,r.pixels.resultMask)for(y=0;y<U;y++){for(b=0;b<v;b++)r.pixels.resultMask[T]&&(r.pixels.resultPixels[T]=k),T++;T+=V}else for(y=0;y<U;y++){for(b=0;b<v;b++)r.pixels.resultPixels[T++]=k;T+=V}else if(r.ptr+=P,t.decodeBits(e,r,F,k),P=0,r.pixels.resultMask)for(y=0;y<U;y++){for(b=0;b<v;b++)r.pixels.resultMask[T]&&(r.pixels.resultPixels[T]=F[P++]),T++;T+=V}else for(y=0;y<U;y++){for(b=0;b<v;b++)r.pixels.resultPixels[T++]=F[P++];T+=V}else r.counter.constant++,r.ptr+=P}},formatFileInfo:function(e){return{fileIdentifierString:e.headerInfo.fileIdentifierString,fileVersion:e.headerInfo.fileVersion,imageType:e.headerInfo.imageType,height:e.headerInfo.height,width:e.headerInfo.width,numValidPixel:e.headerInfo.numValidPixel,microBlockSize:e.headerInfo.microBlockSize,blobSize:e.headerInfo.blobSize,maxZError:e.headerInfo.maxZError,pixelType:t.getPixelType(e.headerInfo.imageType),eofOffset:e.eofOffset,mask:e.mask?{numBytes:e.mask.numBytes}:null,pixels:{numBlocksX:e.pixels.numBlocksX,numBlocksY:e.pixels.numBlocksY,maxValue:e.headerInfo.zMax,minValue:e.headerInfo.zMin,noDataValue:e.noDataValue}}},constructConstantSurface:function(e){var t=e.headerInfo.zMax,r=e.headerInfo.height*e.headerInfo.width,a=0;if(e.pixels.resultMask)for(a=0;a<r;a++)e.pixels.resultMask[a]&&(e.pixels.resultPixels[a]=t);else for(a=0;a<r;a++)e.pixels.resultPixels[a]=t},getDataTypeArray:function(e){var t;switch(e){case 0:t=Int8Array;break;case 1:t=Uint8Array;break;case 2:t=Int16Array;break;case 3:t=Uint16Array;break;case 4:t=Int32Array;break;case 5:t=Uint32Array;break;case 6:t=Float32Array;break;case 7:t=Float64Array;break;default:t=Float32Array}return t},getPixelType:function(e){var t;switch(e){case 0:t="S8";break;case 1:t="U8";break;case 2:t="S16";break;case 3:t="U16";break;case 4:t="S32";break;case 5:t="U32";break;case 6:t="F32";break;case 7:t="F64";break;default:t="F32"}return t},isValidPixelValue:function(e,t){if(null===t||void 0===t)return!1;var r;switch(e){case 0:r=t>=-128&&t<=127;break;case 1:r=t>=0&&t<=255;break;case 2:r=t>=-32768&&t<=32767;break;case 3:r=t>=0&&t<=65536;break;case 4:r=t>=-2147483648&&t<=2147483647;break;case 5:r=t>=0&&t<=4294967296;break;case 6:r=t>=-3.4027999387901484e38&&t<=3.4027999387901484e38;break;case 7:r=t>=5e-324&&t<=1.7976931348623157e308;break;default:r=!1}return r},getDateTypeSize:function(e){var t=0;switch(e){case 0:case 1:t=1;break;case 2:case 3:t=2;break;case 4:case 5:case 6:t=4;break;case 7:t=8;break;default:t=e}return t},getDataTypeUsed:function(e,t){var r=e;switch(e){case 2:case 4:r=e-t;break;case 3:case 5:r=e-2*t;break;case 6:r=0===t?e:1===t?2:1;break;case 7:r=0===t?e:e-2*t+1;break;default:r=e}return r},getOnePixel:function(e,t,r,a){var i=0;switch(r){case 0:i=a.getInt8(t);break;case 1:i=a.getUint8(t);break;case 2:i=a.getInt16(t,!0);break;case 3:i=a.getUint16(t,!0);break;case 4:i=a.getInt32(t,!0);break;case 5:i=a.getUInt32(t,!0);break;case 6:i=a.getFloat32(t,!0);break;case 7:i=a.getFloat64(t,!0);break;default:throw"the decoder does not understand this pixel type"}return i}},r=function(e,t,r){this.val=e,this.left=t,this.right=r};return{decode:function(e,r){r=r||{};var a=r.maskData||null===r.maskData,i=r.noDataValue,n=0,s={};if(s.ptr=r.inputOffset||0,s.pixels={},t.readHeaderInfo(e,s)){var f=s.headerInfo,l=t.getDataTypeArray(f.imageType);if(a)s.pixels.resultMask=r.maskData,s.ptr+=4;else if(!t.readMask(e,s))return;var o=f.width*f.height;if(s.pixels.resultPixels=new l(o),s.counter={onesweep:0,uncompressed:0,lut:0,bitstuffer:0,constant:0,constantoffset:0},0!==f.numValidPixel)if(f.zMax===f.zMin)t.constructConstantSurface(s);else{var u=new DataView(e,s.ptr,2),c=u.getUint8(0,!0);if(s.ptr++,c)t.readDataOneSweep(e,s,l);else if(f.fileVersion>1&&f.imageType<=1&&Math.abs(f.maxZError-.5)<1e-5){var h=u.getUint8(1,!0);s.ptr++,h?t.readHuffman(e,s,l):t.readTiles(e,s,l)}else t.readTiles(e,s,l)}s.eofOffset=s.ptr;var p;r.inputOffset?(p=s.headerInfo.blobSize+r.inputOffset-s.ptr,Math.abs(p)>=1&&(s.eofOffset=r.inputOffset+s.headerInfo.blobSize)):(p=s.headerInfo.blobSize-s.ptr,Math.abs(p)>=1&&(s.eofOffset=s.headerInfo.blobSize));var d={width:f.width,height:f.height,pixelData:s.pixels.resultPixels,minValue:f.zMin,maxValue:f.zMax,maskData:s.pixels.resultMask};if(s.pixels.resultMask&&t.isValidPixelValue(f.imageType,i)){var g=s.pixels.resultMask;for(n=0;n<o;n++)g[n]||(d.pixelData[n]=i);d.noDataValue=i}return s.noDataValue=i,r.returnFileInfo&&(d.fileInfo=t.formatFileInfo(s)),d}},getBandCount:function(e){var r=0,a=0,i={};for(i.ptr=0,i.pixels={};a<e.byteLength-58;)t.readHeaderInfo(e,i),a+=i.headerInfo.blobSize,r++,i.ptr=a;return r}}});