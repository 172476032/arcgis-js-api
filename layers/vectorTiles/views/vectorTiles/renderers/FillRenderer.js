// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["require","exports","../../../core/libs/gl-matrix/mat4","../../../core/libs/gl-matrix/mat3","../../../core/libs/gl-matrix/vec4","../../../core/libs/gl-matrix/vec3","../../webgl/Program","../../webgl/VertexArrayObject","../GeometryUtils","./vtShaderSnippets"],function(t,i,r,e,o,n,a,l,s,f){var _=1/65536,u=function(){function t(){this._outlineAttributeLocations={a_pos:0,a_offset:1,a_xnormal:2},this._fillAttributeLocations={a_pos:0},this._initialized=!1,this._viewProjMat=r.create(),this._offsetVector=n.create(),this._patternMatrix=e.create(),this._color=o.create(),this._outlineColor=o.create()}return t.prototype.render=function(t,i,o,n,a,l,f,u,m,h,g){this._initialized||this._initialize(t);var d=f.getPaintValue("fill-pattern",o),p=void 0!==d;if(!p||0!==a){var c=f.getPaintValue("fill-antialias",o)&&!p,v=g*f.getPaintValue("fill-opacity",o),y=f.getPaintValue("fill-color",o),x=!1;if(!p){var P=y[3]*v;1===P&&0===a&&(x=!0),1>P&&1===a&&(x=!0)}if(x||0!==a){var V=l.tileTransform.transform,b=512,A=l.coordRange/b,O=f.getPaintValue("fill-translate",o);if(0!==O[0]||0!==O[1]){r.copy(this._viewProjMat,l.tileTransform.transform);var M=O[0],F=O[1],U=0,w=0,z=(1<<l.key.level)/Math.pow(2,o)*A,S=f.getPaintValue("fill-translate-anchor",o);if(1===S){var C=Math.sin(s.C_DEG_TO_RAD*-n),T=Math.cos(s.C_DEG_TO_RAD*-n);U=z*(M*T-F*C),w=z*(M*C+F*T)}else U=z*M,w=z*F;this._offsetVector[0]=U,this._offsetVector[1]=w,this._offsetVector[2]=0,r.translate(this._viewProjMat,this._viewProjMat,this._offsetVector),V=this._viewProjMat}var j=this._getTrianglesVAO(t,l);if(j){if(p){if(1===a){var E=u.getMosaicItemPosition(d,!0);if(E){var L=512,B=l.coordRange/L,z=B/Math.pow(2,Math.round(o)-l.key.level)/h;e.identity(this._patternMatrix);var D=1/(E.size[0]*z),R=1/(E.size[1]*z);this._patternMatrix[0]=D,this._patternMatrix[4]=R,t.bindVAO(j),u.bind(t,9729,E.page,1),t.bindProgram(this._patternFillProgram),this._patternFillProgram.setUniformMatrix4fv("u_transformMatrix",V),this._patternFillProgram.setUniform2fv("u_normalized_origin",l.tileTransform.displayCoord),this._patternFillProgram.setUniform1f("u_depth",f.z),this._patternFillProgram.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix),this._patternFillProgram.setUniform1f("u_opacity",v),this._patternFillProgram.setUniform2f("u_pattern_tl",E.tl[0],E.tl[1]),this._patternFillProgram.setUniform2f("u_pattern_br",E.br[0],E.br[1]),this._patternFillProgram.setUniform1i("u_texture",1),t.drawElements(4,i.triangleElementCount,5125,12*i.triangleElementStart),t.bindVAO()}}}else if(x){var P=y[3]*v;this._color[0]=P*y[0],this._color[1]=P*y[1],this._color[2]=P*y[2],this._color[3]=P,t.bindVAO(j),t.bindProgram(this._solidFillProgram),this._solidFillProgram.setUniformMatrix4fv("u_transformMatrix",V),this._solidFillProgram.setUniform2fv("u_normalized_origin",l.tileTransform.displayCoord),this._solidFillProgram.setUniform1f("u_depth",f.z+_),this._solidFillProgram.setUniform4fv("u_color",this._color),t.drawElements(4,i.triangleElementCount,5125,12*i.triangleElementStart),t.bindVAO()}if(c&&i.outlineElementCount>0){if(1!==a)return;var G=f.getPaintValue("fill-outline-color",o);if(0===G[3]){if(1!==this._color[3])return;G=y}var I=.75/h,k=G[3]*v;this._outlineColor[0]=k*G[0],this._outlineColor[1]=k*G[1],this._outlineColor[2]=k*G[2],this._outlineColor[3]=k;var q=this._getOutlineVAO(t,l);if(!q)return;t.bindVAO(q),t.bindProgram(this._outlineProgram),this._outlineProgram.setUniformMatrix4fv("u_transformMatrix",V),this._outlineProgram.setUniformMatrix4fv("u_extrudeMatrix",m),this._outlineProgram.setUniform2fv("u_normalized_origin",l.tileTransform.displayCoord),this._outlineProgram.setUniform1f("u_depth",f.z),this._outlineProgram.setUniform1f("u_outline_width",I),this._outlineProgram.setUniform4fv("u_color",this._outlineColor),t.drawElements(4,i.outlineElementCount,5125,12*i.outlineElementStart),t.bindVAO()}}}}},t.prototype._initialize=function(t){if(this._initialized)return!0;var i={a_pos:0},r=new a(t,f.solidFillShaderVS,f.solidFillShaderFS,i);if(!r)return!1;var e={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}]},o=new a(t,f.patternFillShaderVS,f.patternFillShaderFS,this._fillAttributeLocations);if(!o)return!1;var n=new a(t,f.fillOutlineShaderVS,f.fillOutlineShaderFS,this._outlineAttributeLocations),l={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:8,normalized:!1,divisor:0},{name:"a_xnormal",count:2,type:5120,offset:6,stride:8,normalized:!1,divisor:0}]};return this._solidFillProgram=r,this._patternFillProgram=o,this._trianglesVertexAttributes=e,this._outlineProgram=n,this._outlineVertexAttributes=l,this._initialized=!0,!0},t.prototype._getTrianglesVAO=function(t,i){if(i.polygonTrianglesVertexArrayObject)return i.polygonTrianglesVertexArrayObject;var r=i.polygonTrianglesVertexBuffer,e=i.polygonTrianglesIndexBuffer;return r&&e?(i.polygonTrianglesVertexArrayObject=new l(t,this._fillAttributeLocations,this._trianglesVertexAttributes,{geometry:r},e),i.polygonTrianglesVertexArrayObject):null},t.prototype._getOutlineVAO=function(t,i){if(i.polygonOutlineVertexArrayObject)return i.polygonOutlineVertexArrayObject;var r=i.polygonOutlinesVertexBuffer,e=i.polygonOutlinesIndexBuffer;return r&&e?(i.polygonOutlineVertexArrayObject=new l(t,this._outlineAttributeLocations,this._outlineVertexAttributes,{geometry:r},e),i.polygonOutlineVertexArrayObject):null},t}();return u});