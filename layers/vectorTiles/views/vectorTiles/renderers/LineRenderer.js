// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define(["require","exports","../../../core/libs/gl-matrix/mat4","../../../core/libs/gl-matrix/vec4","../../../core/libs/gl-matrix/vec3","../../../core/libs/gl-matrix/vec2","dojo/text!./shaders/lineShader.vs.glsl","dojo/text!./shaders/lineShader.fs.glsl","dojo/text!./shaders/lineJoinShader.vs.glsl","dojo/text!./shaders/lineJoinShader.fs.glsl","../../webgl/Program","../../webgl/VertexArrayObject","../GeometryUtils"],function(t,e,i,r,o,a,n,s,l,_,f,h,g){var m=function(){function t(){this._joinAttributeLocations={a_pos:0,a_vertexOffset:1},this._triangleAttributeLocations={a_pos:0,a_offset:1,a_accumulatedDistance:2},this._initialized=!1,this._viewProjMat=i.create(),this._offsetVector=o.create(),this._screenSize=a.create(),this._color=r.create(),this._dashArray=a.create()}return t.prototype.render=function(t,e,r,o,a,n,s,l){if(0!==e.triangleElementCount){this._initialized||this._initialize(t);var _=a.tileTransform.transform,f=512,h=a.coordRange/f,m=n.getPaintValue("line-translate",r);if(0!==m[0]||0!==m[1]){i.copy(this._viewProjMat,a.tileTransform.transform);var c=m[0],u=m[1],d=0,v=0,j=(1<<a.key.level)/Math.pow(2,r)*h,P=o.rotation,x=n.getPaintValue("line-translate-anchor",r);if(1===x){var V=Math.sin(g.C_DEG_TO_RAD*-P),y=Math.cos(g.C_DEG_TO_RAD*-P);d=j*(c*y-u*V),v=j*(c*V+u*y)}else d=j*c,v=j*u;this._offsetVector[0]=d,this._offsetVector[1]=v,this._offsetVector[2]=0,i.translate(this._viewProjMat,this._viewProjMat,this._offsetVector),_=this._viewProjMat}var A=1/l,b=n.getPaintValue("line-blur",r)+A,p=n.getPaintValue("line-width",r),O=.5*(p+A),z=n.getPaintValue("line-opacity",r),U=n.getPaintValue("line-color",r);this._color[0]=U[0],this._color[1]=U[1],this._color[2]=U[2],this._color[3]=U[3]*z;var w=O>1&&e.joinCount>0;if(w){this._screenSize[0]=.5*o.width,this._screenSize[1]=.5*o.height;var M=Math.ceil(2*O),T=O-.25,S=this._getJoinsVAO(t,a);if(S){t.bindVAO(S),t.bindProgram(this._joinProgram);var J=1/(l>0?l:1);this._joinProgram.setUniformMatrix4fv("u_transformMatrix",_),this._joinProgram.setUniform2fv("u_normalized_origin",a.tileTransform.displayCoord),this._joinProgram.setUniform1f("u_depth",n.z),this._joinProgram.setUniform2fv("u_screen",this._screenSize),this._joinProgram.setUniform1f("u_size",M),this._joinProgram.setUniform4fv("u_color",this._color),this._joinProgram.setUniform1f("u_lineHalfWidth",T),this._joinProgram.setUniform1f("u_pixelRatio",l),this._joinProgram.setUniform1f("u_oneOverPixelRatio",J),t.drawArrays(0,e.joinStart,e.joinCount),t.bindVAO()}}var C=n.getPaintValue("line-dasharray",r);C.length<2&&(C=[1,-1]);var D=p*h;this._dashArray[0]=D*C[0],this._dashArray[1]=D*C[1];var E=this._getTrianglesVAO(t,a);E&&(t.bindVAO(E),t.bindProgram(this._triangleslProgram),this._triangleslProgram.setUniformMatrix4fv("u_transformMatrix",_),this._triangleslProgram.setUniformMatrix4fv("u_extrudeMatrix",s),this._triangleslProgram.setUniform2fv("u_normalized_origin",a.tileTransform.displayCoord),this._triangleslProgram.setUniform1f("u_depth",n.z),this._triangleslProgram.setUniform4fv("u_color",this._color),this._triangleslProgram.setUniform1f("u_lineHalfWidth",O),this._triangleslProgram.setUniform2fv("u_dasharray",this._dashArray),this._triangleslProgram.setUniform1f("u_blur",b),t.drawElements(4,e.triangleElementCount,5125,12*e.triangleElementStart),t.bindVAO())}},t.prototype._initialize=function(t){if(this._initialized)return!0;var e=new f(t,n,s,this._triangleAttributeLocations),i={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:8,normalized:!1,divisor:0},{name:"a_offset",count:2,type:5120,offset:4,stride:8,normalized:!1,divisor:0},{name:"a_accumulatedDistance",count:1,type:5122,offset:6,stride:8,normalized:!1,divisor:0}]},r=new f(t,l,_,this._joinAttributeLocations),o={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:4,normalized:!1,divisor:0}]};return this._triangleslProgram=e,this._trianglesVertexAttributes=i,this._joinProgram=r,this._joinVertexAttributes=o,this._initialized=!0,!0},t.prototype._getTrianglesVAO=function(t,e){if(e.lineTrianglesVertexArrayObject)return e.lineTrianglesVertexArrayObject;var i=e.lineVertexBuffer,r=e.lineTrianglesIndexBuffer;return i&&r?(e.lineTrianglesVertexArrayObject=new h(t,this._triangleAttributeLocations,this._trianglesVertexAttributes,{geometry:i},r),e.lineTrianglesVertexArrayObject):null},t.prototype._getJoinsVAO=function(t,e){if(e.lineJoinsVertexArrayObject)return e.lineJoinsVertexArrayObject;var i=e.lineJoinVertexBuffer;return i?(e.lineJoinsVertexArrayObject=new h(t,this._joinAttributeLocations,this._joinVertexAttributes,{geometry:i}),e.lineJoinsVertexArrayObject):null},t}();return m});