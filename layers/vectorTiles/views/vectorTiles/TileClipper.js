// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define(["require","exports","./Geometry"],function(i,t,s){var h=function(){function i(i,t,s){this.ratio=i,this.x=t,this.y=s}return i}(),n=function(){function i(i,t,s){this.dz=i,this.yPos=t,this.xPos=s}return i.prototype.setExtent=function(i){this.finalRatio=4096/i*(1<<this.dz);var t=64;t/=this.finalRatio;var s=i>>this.dz;t>s&&(t=s),this.margin=t,this.xmin=s*this.xPos-t,this.ymin=s*this.yPos-t,this.xmax=this.xmin+s+2*t,this.ymax=this.ymin+s+2*t},i.prototype.reset=function(i){this.type=i,this._prevIsIn=!1,this.lines=[],this.line=null},i.prototype.moveTo=function(i,t){this._push_line(),this._prevIsIn=this._isIn(i,t),this._moveTo(i,t,this._prevIsIn),this._prevPt=new s.Point(i,t),this._firstPt=new s.Point(i,t)},i.prototype.lineTo=function(i,t){var n,e,x,y,o,l,m,a,r=this._isIn(i,t);if(r)this._prevIsIn?this._lineTo(i,t,!0):(n=this._prevPt,e=new s.Point(i,t),x=this._intersect(e,n),this._lineTo(x.x,x.y,!0),this._lineTo(e.x,e.y,!0));else if(this._prevIsIn)e=this._prevPt,n=new s.Point(i,t),x=this._intersect(e,n),this._lineTo(x.x,x.y,!0),this._lineTo(n.x,n.y,!1);else{var p=this._prevPt,u=new s.Point(i,t);if(p.x<=this.xmin&&u.x<=this.xmin||p.x>=this.xmax&&u.x>=this.xmax||p.y<=this.ymin&&u.y<=this.ymin||p.y>=this.ymax&&u.y>=this.ymax)this._lineTo(u.x,u.y,!1);else{var _=[];if((p.x<this.xmin&&u.x>this.xmin||p.x>this.xmin&&u.x<this.xmin)&&(y=(this.xmin-p.x)/(u.x-p.x),a=p.y+y*(u.y-p.y),a<=this.ymin?l=!1:a>=this.ymax?l=!0:_.push(new h(y,this.xmin,a))),(p.x<this.xmax&&u.x>this.xmax||p.x>this.xmax&&u.x<this.xmax)&&(y=(this.xmax-p.x)/(u.x-p.x),a=p.y+y*(u.y-p.y),a<=this.ymin?l=!1:a>=this.ymax?l=!0:_.push(new h(y,this.xmax,a))),(p.y<this.ymin&&u.y>this.ymin||p.y>this.ymin&&u.y<this.ymin)&&(y=(this.ymin-p.y)/(u.y-p.y),m=p.x+y*(u.x-p.x),m<=this.xmin?o=!1:m>=this.xmax?o=!0:_.push(new h(y,m,this.ymin))),(p.y<this.ymax&&u.y>this.ymax||p.y>this.ymax&&u.y<this.ymax)&&(y=(this.ymax-p.y)/(u.y-p.y),m=p.x+y*(u.x-p.x),m<=this.xmin?o=!1:m>=this.xmax?o=!0:_.push(new h(y,m,this.ymax))),0===_.length)o?l?this._lineTo(this.xmax,this.ymax,!0):this._lineTo(this.xmax,this.ymin,!0):l?this._lineTo(this.xmin,this.ymax,!0):this._lineTo(this.xmin,this.ymin,!0);else if(_.length>1&&_[0].ratio>_[1].ratio)this._lineTo(_[1].x,_[1].y,!0),this._lineTo(_[0].x,_[0].y,!0);else for(var f=0;f<_.length;f++)this._lineTo(_[f].x,_[f].y,!0);this._lineTo(u.x,u.y,!1)}}this._prevIsIn=r,this._prevPt=new s.Point(i,t)},i.prototype.close=function(){var i,t;if(this.line.length>0){i=this._firstPt,t=this._prevPt,(i.x!==t.x||i.y!==t.y)&&this.lineTo(i.x,i.y);var s=this.line,h=s.length;h>=4&&(s[0].x===s[1].x&&s[0].x===s[h-2].x||s[0].y===s[1].y&&s[0].y===s[h-2].y)&&(s.pop(),s[0].x=s[h-2].x,s[0].y=s[h-2].y)}},i.prototype.result=function(){return this._push_line(),0===this.lines.length?null:this.lines},i.prototype._isIn=function(i,t){return i>=this.xmin&&i<=this.xmax&&t>=this.ymin&&t<=this.ymax},i.prototype._intersect=function(i,t){var h,n;if(t.x>=this.xmin&&t.x<=this.xmax)n=t.y<=this.ymin?this.ymin:this.ymax,h=i.x+(n-i.y)/(t.y-i.y)*(t.x-i.x);else if(t.y>=this.ymin&&t.y<=this.ymax)h=t.x<=this.xmin?this.xmin:this.xmax,n=i.y+(h-i.x)/(t.x-i.x)*(t.y-i.y);else{n=t.y<=this.ymin?this.ymin:this.ymax,h=t.x<=this.xmin?this.xmin:this.xmax;var e=(h-i.x)/(t.x-i.x),x=(n-i.y)/(t.y-i.y);x>e?n=i.y+e*(t.y-i.y):h=i.x+x*(t.x-i.x)}return new s.Point(h,n)},i.prototype._push_line=function(){this.line&&(1===this.type?this.line.length>0&&this.lines.push(this.line):2===this.type?this.line.length>1&&this.lines.push(this.line):3===this.type&&this.line.length>3&&this.lines.push(this.line)),this.line=[]},i.prototype._moveTo=function(i,t,h){3!==this.type?h&&(i=Math.round((i-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line.push(new s.Point(i,t))):(h||(i<this.xmin&&(i=this.xmin),i>this.xmax&&(i=this.xmax),t<this.ymin&&(t=this.ymin),t>this.ymax&&(t=this.ymax)),i=Math.round((i-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line.push(new s.Point(i,t)),this._is_h=!1,this._is_v=!1)},i.prototype._lineTo=function(i,t,h){var n,e;if(3!==this.type)if(h){if(i=Math.round((i-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line.length>0&&(n=this.line[this.line.length-1],n.equals(i,t)))return;this.line.push(new s.Point(i,t))}else this.line&&this.line.length>0&&this._push_line();else if(h||(i<this.xmin&&(i=this.xmin),i>this.xmax&&(i=this.xmax),t<this.ymin&&(t=this.ymin),t>this.ymax&&(t=this.ymax)),i=Math.round((i-(this.xmin+this.margin))*this.finalRatio),t=Math.round((t-(this.ymin+this.margin))*this.finalRatio),this.line&&this.line.length>0){n=this.line[this.line.length-1];var x=n.x===i,y=n.y===t;if(x&&y)return;this._is_h&&x?(n.x=i,n.y=t,e=this.line[this.line.length-2],this._is_h=e.x===i,this._is_v=e.y===t):this._is_v&&y?(n.x=i,n.y=t,e=this.line[this.line.length-2],this._is_h=e.x===i,this._is_v=e.y===t):(this.line.push(new s.Point(i,t)),this._is_h=x,this._is_v=y)}else this.line.push(new s.Point(i,t))},i}();t.TileClipper=n;var e=function(){function i(){}return i.prototype.setExtent=function(i){this._ratio=4096===i?1:4096/i},i.prototype.reset=function(i){this.lines=[],this.line=null},i.prototype.moveTo=function(i,t){this.line&&this.lines.push(this.line),this.line=[];var h=this._ratio;this.line.push(new s.Point(Math.round(i*h),Math.round(t*h)))},i.prototype.lineTo=function(i,t){var h=this._ratio;this.line.push(new s.Point(Math.round(i*h),Math.round(t*h)))},i.prototype.close=function(){var i=this.line;i&&!i[0].isEqual(i[i.length-1])&&i.push(i[0])},i.prototype.result=function(){return this.line&&this.lines.push(this.line),0===this.lines.length?null:this.lines},i}();t.SimpleBuilder=e});