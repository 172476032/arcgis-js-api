// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","exports","dojo/promise/all","../../core/promiseUtils","../../core/executeAsync","../../core/pbf","./SourceLayerData","./Feature","./BackgroundBucket","./FillBucket","./LineBucket","./SymbolBucket","../2d/engine/webgl/TileClipper"],function(e,t,r,i,n,a,l,u,s,o,f,c,h){var p=function(){function e(e,t,r){this._pbfTile=new a(new Uint8Array(e),new DataView(e)),this._tile=t,this._connection=r,this._layers=t.getLayers();var i=t.tileKey.split("/").map(parseFloat),n=i[0],l=i[1],u=i[2];this._level=n;var s=t.refKey;if(s){var o=t.refKey.split("/").map(parseFloat)[0],f=n-o;if(f>0){var c=(1<<f)-1,p=l&c,v=u&c;this._tileClipper=new h.TileClipper(f,p,v)}}this._tileClipper||(this._tileClipper=new h.SimpleBuilder)}return e.prototype.parse=function(){for(var e,t=this,a=this._parseTileData(this._pbfTile),l=this._layers,s=l.length,o=this._level,f=[],c={},h=new Set,p=s-1;p>=0;p--)if(e=l[p],!(e.minzoom&&o<e.minzoom||e.maxzoom&&o>=e.maxzoom||e.layout&&"none"===e.layout.visibility))if(0!==e.type){var v=e.sourceLayer,_=a[v];if(_){h.add(v);var y=this._createBucket(e);if(y){y.layerIndex=p,y.layerExtent=_.extent;var B=c[v];B||(B=c[v]=[]),B.push(y)}}}else{var y=this._createBucket(e);y.layerIndex=p,f.push(y)}var x=10*this._level,g=10*(this._level+1),k=[],d=[],D=[],w=[],m=this._tileClipper,b=new Set,I={},F=[];h.forEach(function(e){return F.push(e)});var V=0,L=0,T=F.length;return n(function(){if(6===t._tile.status)return!0;switch(V){case 0:if(T>L){var e=F[L++],r=a[e],i=c[e];if(!i||0===i.length)break;for(var n=r.getData();n.next(2);){var l=new u(n.getMessage(),r),s=l.values;if(s){var o=s._minzoom;if(o&&o>=g)continue;var f=s._maxzoom;if(f&&x>=f)continue}for(var h=0,p=i;h<p.length;h++){var v=p[h];v.pushFeature(l)}}}else{var _=t._tile;for(var e in c)for(var i=c[e],y=0,B=i;y<B.length;y++){var v=B[y];v.hasFeatures()&&(3===v.layer.type?(k.push(v),_.addBucket(v)):v.layer.refLayerId?D.push(v):(d.push(v),w[v.layer.id]=v))}V=1,L=0,T=k.length}break;case 1:if(T>L){var z=k[L++];z.getResources(m,b,I)}else V=2}return 2===V},50).then(function(){if(6===t._tile.status)return[];var e,a=[],l=t._tile.getWorkerTileHandler();b.size>0&&(e=l.fetchSprites(b,t._connection),a.push(e));var u;for(var s in I){var o=I[s];o.size>0&&(u=l.fetchGlyphs(t._tile.tileKey,s,o,t._connection),a.push(u))}return r(a).then(function(e){if(6===t._tile.status)return[];var r=0,i=0,a=d.length;return n(function(){if(6===t._tile.status)return!0;switch(r){case 0:if(a>i){var e=d[i++];e.processFeatures(m,t._tile),f.push(e)}else r=1,i=0,a=D.length;break;case 1:for(var n=0,l=D;n<l.length;n++){var e=l[n],u=w[e.layer.refLayerId];u&&(u.assignBufferInfo(e),f.push(e))}r=2,i=0,a=k.length;break;case 2:if(a>i){var e=k[i++];e.processFeatures(m,t._tile),f.push(e)}else r=3}return 3===r},50).then(function(){return f.sort(function(e,t){return e.layerIndex-t.layerIndex}),f})}).otherwise(function(e){return i.reject(new Error(e))})}).otherwise(function(e){return i.reject(new Error(e))})},e.prototype._parseTileData=function(e){for(var t={};e.next();)switch(e.tag()){case 3:var r=new l(e.getMessage());t[r.name]=r;break;default:e.skip()}return t},e.prototype._createBucket=function(e){switch(e.type){case 0:return this._createBackgroundBucket(e);case 1:return this._createFillBucket(e);case 2:return this._createLineBucket(e);case 3:return this._createSymbolBucket(e)}},e.prototype._createBackgroundBucket=function(e){var t=new s(e,this._level);return t},e.prototype._createFillBucket=function(e){var t=this._tile,r=new o(e,this._level,e.hasDataDrivenFill?t.fillDDVertexBuffer:t.fillVertexBuffer,t.fillIndexBuffer,e.hasDataDrivenOutline?t.outlineDDVertexBuffer:t.outlineVertexBuffer,t.outlineIndexBuffer);return r},e.prototype._createLineBucket=function(e){var t=this._tile,r=new f(e,this._level,e.hasDataDrivenLine?t.lineDDVertexBuffer:t.lineVertexBuffer,t.lineIndexBuffer);return r},e.prototype._createSymbolBucket=function(e){var t=this._tile,r=new c(e,this._level,e.hasDataDrivenIcon?t.iconDDVertexBuffer:t.iconVertexBuffer,t.iconIndexBuffer,e.hasDataDrivenText?t.textDDVertexBuffer:t.textVertexBuffer,t.textIndexBuffer,t.placementEngine,t.getWorkerTileHandler());return r},e}();return p});