// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["require","exports","./Rect","./GeometryUtils","./RectangleBinPack","../webgl/Texture"],function(t,i,e,s,h,a){var r=function(){function t(t,i,e){void 0===e&&(e=0),this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,(0>=t||0>=i)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=i,e>0&&(this._maxItemSize=e),this._binPack=new h(t,i)}return t.prototype.getWidth=function(t){return t>=this._size.length?-1:this._size[t][0]},t.prototype.getHeight=function(t){return t>=this._size.length?-1:this._size[t][1]},t.prototype.setSpriteSource=function(t){if(this._dispose(),this.pixelRatio=t.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new h(this._pageWidth,this._pageHeight);var i=Math.floor(this._pageWidth),e=Math.floor(this._pageHeight);this._mosaicsData[0]=new Uint32Array(i*e),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=t},t.prototype.getSpriteItem=function(t,i){void 0===i&&(i=!1);var e=this._mosaicRects[t];if(e)return e;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;var s=this._sprites.getSpritePosition(t);if(!s||!s.width||!s.height)return null;var h=this._allocateImage(s.width,s.height),a=h[0],r=h[1],o=h[2];return a.width<=0?null:(e={rect:a,width:s.width,height:s.height,sdf:s.sdf,pixelRatio:s.pixelRatio,page:r},this._copy(a,s,r,o,i),this._mosaicRects[t]=e,e)},t.prototype.getSpriteItems=function(t){for(var i={},e=0,s=t;e<s.length;e++){var h=s[e];i[h]=this.getSpriteItem(h)}return i},t.prototype.getMosaicItemPosition=function(t,i){var e=this.getSpriteItem(t,i),s=e&&e.rect;if(!s)return null;s.width=e.width,s.height=e.height;var h=e.width,a=e.height,r=1;return{size:[e.width,e.height],tl:[(s.x+r)/this._size[e.page][0],(s.y+r)/this._size[e.page][1]],br:[(s.x+r+h)/this._size[e.page][0],(s.y+r+a)/this._size[e.page][1]],page:e.page}},t.prototype.bind=function(t,i,e,s){void 0===e&&(e=0),void 0===s&&(s=0),this._textures[e]||(this._textures[e]=new a(t,{pixelFormat:6408,dataType:5121,width:this._size[e][0],height:this._size[e][1]},new Uint8Array(this._mosaicsData[e].buffer)));var h=this._textures[e];h.setSamplingMode(i),t.bindTexture(h,s),this._dirties[e]&&h.setData(new Uint8Array(this._mosaicsData[e].buffer)),this._dirties[e]=!1},t._copyBits=function(t,i,e,s,h,a,r,o,n,_,p){var g=s*i+e,u=o*a+r;if(p){u-=a;for(var c=-1;_>=c;c++,g=((c+_)%_+s)*i+e,u+=a)for(var d=-1;n>=d;d++)h[u+d]=t[g+(d+n)%n]}else for(var c=0;_>c;c++){for(var d=0;n>d;d++)h[u+d]=t[g+d];g+=i,u+=a}},t.prototype._copy=function(i,e,s,h,a){if(this._sprites&&"loaded"===this._sprites.loadStatus&&!(s>=this._mosaicsData.length)){var r=new Uint32Array(this._sprites.image.buffer),o=this._mosaicsData[s];o&&r||console.error("Source or target images are uninitialized!");var n=1;t._copyBits(r,this._sprites.width,e.x,e.y,o,h[0],i.x+n,i.y+n,e.width,e.height,a),this._dirties[s]=!0}},t.prototype._allocateImage=function(t,i){t+=2,i+=2;var a=Math.max(t,i);if(this._maxItemSize&&this._maxItemSize<a){var r=Math.pow(2,Math.ceil(s.log2(t))),o=Math.pow(2,Math.ceil(s.log2(i))),n=new e(0,0,t,i);return this._mosaicsData.push(new Uint32Array(r*o)),this._dirties.push(!0),this._size.push([r,o]),this._textures.push(void 0),[n,this._mosaicsData.length-1,[r,o]]}var _=t%4?4-t%4:0,p=i%4?4-i%4:0,g=this._binPack.allocate(t+_,i+p);return g.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new h(this._pageWidth,this._pageHeight),this._allocateImage(t,i)):[g,this._currentPage,[this._pageWidth,this._pageHeight]]},t.prototype._dispose=function(){this._binPack=null,this._mosaicRects={}},t}();return r});