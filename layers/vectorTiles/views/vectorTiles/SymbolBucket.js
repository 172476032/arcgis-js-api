// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/extendsHelper","../../core/tsSupport/decorateHelper","./Bucket","./Geometry","./style/StyleLayer","./Placement","./GeometryUtils","./TextShaping","dojox/string/BidiEngine"],function(e,t,r,n,i,a,o,s,m,l,h){var u=function(){function e(){}return e}(),f=function(){function e(e,t,r,n){this.line=t,this.shaping=e,this.iconMosaicItem=r,this.anchor=n}return e}(),c=function(e){function t(t,r,n,i,a,o,s,m){e.call(this,t,r),this._markerRatio=1,this._markerVertexBuffer=n,this._markerIndexBuffer=i,this._textVertexBuffer=a,this._textIndexBuffer=o,this._placementEngine=s,this._workerTileHandler=m}return r(t,e),Object.defineProperty(t.prototype,"markerIndexStart",{get:function(){return this._markerTriangleElementsStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"markerIndexCount",{get:function(){return this._markerTriangleElementsNum},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textIndexStart",{get:function(){return this._textTriangleElementsStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textIndexCount",{get:function(){return this._textTriangleElementsNum},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sdfMarker",{get:function(){return!1},enumerable:!0,configurable:!0}),t.prototype.copy=function(e,r,n,i,a){var o=new t(this.layer,this.zoom,e,r,n,i,a,this._workerTileHandler);return o.layerIndex=this.layerIndex,o.layerExtent=this.layerExtent,o._markerVertexStart=e.index,o._markerTriangleElementsStart=r.index,o._textVertexStart=n.index,o._textTriangleElementsStart=i.index,o._markerTriangleElementsNum=0,o._textTriangleElementsNum=0,o._symbolInstances=this._symbolInstances,o._glyphItems=this._glyphItems,o._textLayout=this._textLayout,o._markerLayout=this._markerLayout,o._isLinePlacement=this._isLinePlacement,o._avoidEdges=this._avoidEdges,o},t.prototype.getResources=function(e,r,n){var i=this.layer,a=this.zoom;e&&e.setExtent(this.layerExtent);for(var o=i.getLayoutValue("icon-image",a),s=i.getLayoutValue("text-field",a),m=i.getLayoutValue("text-font",a),l=i.getLayoutValue("text-transform",a),h=[],f=0,c=this._features;f<c.length;f++){var x=c[f],d=x.getGeometry(e);if(d&&0!==d.length){var g=void 0;o&&(g=this._replaceKeys(o,x.values),g&&r.add(g));var _=void 0,p=!1;if(s){switch(_=this._replaceKeys(s,x.values),l){case 2:_=_.toLowerCase();break;case 1:_=_.toUpperCase()}if(t._bidiEngine.hasBidiChar(_)){var y=t._bidiEngine.checkContextual(_),v=void 0;v="rtl"===y?"IDNNN":"ICNNN",_=t._bidiEngine.bidiTransform(_,v,"VLYSN"),p=!0}var I=_.length;if(I>0){var b=n[m];b||(b=n[m]=new Set);for(var k=0;I>k;k++){var E=_.charCodeAt(k);b.add(E)}}}if(g||_){var z=new u;z.sprite=g,z.label=_,z.rtl=p,z.geometry=d,h.push(z)}}}this._symbolFeatures=h},t.prototype.processFeatures=function(e,r){e&&e.setExtent(this.layerExtent);var n,i=this.layer,a=this.zoom,m=this._isLinePlacement=1===i.getLayoutValue("symbol-placement",a),h=this._avoidEdges=i.getLayoutValue("symbol-avoid-edges",a)&&!m,u=i.getLayoutValue("symbol-spacing",a),c=i.getLayoutValue("icon-image",a),x=i.getLayoutValue("text-field",a),d=this._workerTileHandler;c&&(this._markerLayout=new o.IconLayout(i,a,m),n=d.getSpriteItems());var g,_;if(x){var p=this._textLayout=new o.TextLayout(i,a,m),y=void 0;p.font&&p.font.length&&(y=p.font[0]);var v=.5;switch(p.anchor){case 5:case 1:case 7:v=0;break;case 6:case 2:case 8:v=1}var I=.5;switch(p.anchor){case 5:case 3:case 6:I=0;break;case 7:case 4:case 8:I=1}var b=.5;switch(p.justify){case 0:b=0;break;case 2:b=1}var k=24*p.letterSpacing,E=m?0:24*p.maxWidth,z=24*p.lineHeight,T=[24*p.offset[0],24*p.offset[1]];g=d.getGlyphItems(y),_=new l(g,E,z,k,T,v,I,b)}this._markerVertexStart=this._markerVertexBuffer.index,this._markerTriangleElementsStart=this._markerIndexBuffer.index,this._textVertexStart=this._textVertexBuffer.index,this._textTriangleElementsStart=this._textIndexBuffer.index,this._markerTriangleElementsNum=0,this._textTriangleElementsNum=0;var N=[];this._symbolInstances=N,this._glyphItems=g;var S=24,L=8,V=this._textLayout,w=1;V&&V.size&&(w=V.size/S);for(var B=4096,P=0,C=this._symbolFeatures;P<C.length;P++){var F=C[P],M=void 0;F.sprite&&(M=n[F.sprite]);var j=void 0,Y=F.label,A=0;if(Y&&(j=_.getShaping(Y,F.rtl),j&&j.length>0)){for(var H=1e30,O=-1e30,G=0,R=j;G<R.length;G++){var K=R[G];H=Math.min(H,K.x),O=Math.max(O,K.x)}A=(O-H+2*S)*w}for(var q=0,U=F.geometry;q<U.length;q++){var D=U[q],W=void 0;W=m?t._findAnchors(D,u,L,A):[new s.Anchor(D[0].x,D[0].y)];for(var J=0,Q=W;J<Q.length;J++){var X=Q[J],Z=X.x<0||X.x>B||X.y<0||X.y>B;h&&Z||N.push(new f(j,D,M,X))}}}for(var $=0,ee=N;$<ee.length;$++){var te=ee[$];this._processFeature(te,g,h)}},t.prototype.updateSymbols=function(){this._markerVertexStart=this._markerVertexBuffer.index,this._markerTriangleElementsStart=this._markerIndexBuffer.index,this._textVertexStart=this._textVertexBuffer.index,this._textTriangleElementsStart=this._textIndexBuffer.index,this._markerTriangleElementsNum=0,this._textTriangleElementsNum=0;for(var e=this._glyphItems,t=this._avoidEdges,r=0,n=this._symbolInstances;r<n.length;r++){var i=n[r];this._processFeature(i,e,t)}},t.prototype._replaceKeys=function(e,t){return e.replace(/{([^{}]+)}/g,function(e,r){return r in t?t[r]:""})},t.prototype._processFeature=function(e,t,r){var n=e.line,i=e.iconMosaicItem,o=e.shaping,s=e.anchor,l=8,h=this._markerLayout,u=h&&!!i,f=!0,c=1;if(u){var x=1/this._markerRatio,d=h.size/x;c=l*d,f=h.optional||!i}var g=this._textLayout,_=g&&o&&o.length>0,p=24,y=1,v=y,I=!0;_&&(y=g.size/p,v=l*y,I=g.optional||!o||0===o.length);var b,k=new a.Point(0,-17);if(u){if(b=this._placementEngine.getIconPlacement(s,i,c,n,h,r),b.footprint.minzoom===m.C_INFINITY&&!f)return;s.minzoom>b.footprint.minzoom&&(b.footprint.minzoom=s.minzoom)}var E;if(_&&(E=this._placementEngine.getTextPlacement(s,k,o,t,v,n,g,r))){if(E.footprint.minzoom===m.C_INFINITY&&!I)return;s.minzoom>E.footprint.minzoom&&(E.footprint.minzoom=s.minzoom)}if(!I&&!f||!f&&E&&E.footprint.minzoom!==m.C_INFINITY||!I&&b&&b.footprint.minzoom!==m.C_INFINITY){var z=Math.max(b.footprint.minzoom,E.footprint.minzoom);b.footprint.minzoom=z,E.footprint.minzoom=z}E&&E.footprint.minzoom!==m.C_INFINITY&&(g.ignorePlacement||this._placementEngine.add(E),this._addPlacedSymbols(E.shapes,E.footprint.minzoom,this.zoom,!1)),b&&b.footprint.minzoom!==m.C_INFINITY&&(h.ignorePlacement||this._placementEngine.add(b),this._addPlacedSymbols(b.shapes,b.footprint.minzoom,this.zoom,!0))},t.prototype._addPlacedSymbols=function(e,t,r,n){for(var i=m.log2(t)+r,a=0,o=e;a<o.length;a++){var s=o[a],l=Math.max(r+m.log2(s.minzoom),i),h=Math.min(r+m.log2(s.maxzoom),25);if(!(l>=h)){var u=s.tl,f=s.tr,c=s.bl,x=s.br,d=s.mosaicRect,g=-s.labelAngle,_=s.anchor,p=n?this._markerVertexBuffer:this._textVertexBuffer,y=n?this._markerIndexBuffer:this._textIndexBuffer,v=p.index,I=d.x,b=d.y,k=I+d.width,E=b+d.height;p.add(_.x,_.y,u.x,u.y,I,b,g,l,h,i),p.add(_.x,_.y,f.x,f.y,k,b,g,l,h,i),p.add(_.x,_.y,c.x,c.y,I,E,g,l,h,i),p.add(_.x,_.y,x.x,x.y,k,E,g,l,h,i),y.add(v+0,v+1,v+2),y.add(v+1,v+2,v+3),n?this._markerTriangleElementsNum+=6:this._textTriangleElementsNum+=6}}},t._findAnchors=function(e,t,r,n){var i=t*r,o=n*r;i+=o;for(var l=0,h=e.length-1,u=0;h>u;u++)l+=a.Point.distance(e[u],e[u+1]);var f=o||i;if(f*=.5,f>=l)return[];var c=f/l;i=l/Math.max(Math.round(l/i),1);for(var x=0,d=-i/2,g=[],_=e.length-1,u=0;_>u;u++){for(var p=e[u],y=e[u+1],v=y.x-p.x,I=y.y-p.y,b=Math.sqrt(v*v+I*I),k=void 0;x+b>d+i;){d+=i;var E=(d-x)/b,z=m.interpolate(p.x,y.x,E),T=m.interpolate(p.y,y.y,E);void 0===k&&(k=Math.atan2(I,v)),g.push(new s.Anchor(z,T,k,u,c))}x+=b}return g},t._bidiEngine=new h,t}(i);return c});