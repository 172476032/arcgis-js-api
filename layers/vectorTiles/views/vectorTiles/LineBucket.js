// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/extendsHelper","../../core/tsSupport/decorateHelper","./Bucket","../2d/engine/webgl/LineTess","./style/StyleLayer"],function(e,t,i,r,o,n,s){var a=.05,l=.1,c=.5,u=2.3,d=20,h=0,f=new n.Tessellator({distanceAlongCorrection:!0}),p=function(e){function t(t,i,r,o){var s=e.call(this,t,i)||this;if(s.extrudeVectorsDoubleBuffer=[n.allocExtrudeVectors(),n.allocExtrudeVectors()],s.firstExtrudeVectors=n.allocExtrudeVectors(),s.recycledTriangleBridge=n.allocTriangles(d),s.recycledTrianglePie=n.allocTriangles(d),t.hasDataDrivenLine!==r.isDataDriven())throw new Error("incompatible line buffer");return s._lineVertexBuffer=r,s._lineIndexBuffer=o,s}return i(t,e),Object.defineProperty(t.prototype,"lineIndexStart",{get:function(){return this._lineIndexStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"lineIndexCount",{get:function(){return this._lineIndexCount},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"connectorStart",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"connectorCount",{get:function(){return 0},enumerable:!0,configurable:!0}),t.prototype.assignBufferInfo=function(e){var t=e;t._lineIndexStart=this._lineIndexStart,t._lineIndexCount=this._lineIndexCount},t.prototype.processFeatures=function(e,t){this._lineIndexStart=this._lineIndexBuffer.index,this._lineIndexCount=0;var i=this.layer,r=this.zoom,o=i.hasDataDrivenLine;e&&e.setExtent(this.layerExtent);for(var n=i.getPaintValue("line-pattern",r),a=0,l=this._features;a<l.length;a++){var c=l[a],u=new s.LineLayout(i,r,c),d=void 0;if(!(o&&(d={color:n?[1,1,1,1]:i.getPaintValue("line-color",r,c),opacity:i.getPaintValue("line-opacity",r,c),size:Math.max(Math.min(i.getPaintValue("line-width",r,c),256),0)},d.size<=0||d.opacity<=0||d.color[3]<=0))){var h=c.getGeometry(e);this._processFeature(u,h,d)}}},t.prototype._processFeature=function(e,t,i){if(t)for(var r=t.length,o=0;r>o;o++)this._processGeometry(t[o],e,i)},t.prototype._processGeometry=function(e,t,i){if(!(e.length<2)){for(var r=.001,o=e[0],s=e[e.length-1],d=s.x-o.x,f=s.y-o.y,p=r*r>d*d+f*f,x=e[0],y=1;y<e.length;)d=e[y].x-x.x,f=e[y].y-x.y,r*r>d*d+f*f?e.splice(y,1):(x=e[y],++y);if(!(e.length<2)){this.vertices=e,this.verticesLen=e.length,this.isClosed=p,this.cap=t.cap,this.join=t.join,this.almostParallelRads=a,this.veryShallowRads=l,this.miterSafeRads=n.MITER_SAFE_RADS,this.miterLimitMag=Math.min(t.miterLimit,n.SYSTEM_MAG_LIMIT),this.roundLimitRads=Math.min(t.roundLimit,c),this.newRoundJoinsSafeRads=u;for(var v=this._lineIndexBuffer.index,m=h,g=void 0,_=this.verticesLen,b=0;_>b;++b){var P=e[b],V=e[(b+_-1)%_],E=p&&this._isClipEdge(V,P),C=g===this.extrudeVectorsDoubleBuffer[b%2]?this.extrudeVectorsDoubleBuffer[(b+1)%2]:this.extrudeVectorsDoubleBuffer[b%2];if(_-1>b||!p||this.hasPattern?(this._computeExtrudeVectors(C,b),this._writeGPUVertices(P.x,P.y,m,C,i),!C.capCenter||p&&b===_-1||this._writeGPUPieElements(C,E),p&&0===b&&!this.hasPattern&&n.copyExtrudeVectors(this.firstExtrudeVectors,C)):n.copyExtrudeVectors(C,this.firstExtrudeVectors),g&&this._writeGPUBridgeElements(g,C,E),_-1>b){var S=e[b+1],I=n.length([S.x-P.x,S.y-P.y]);m+=I}g=C}this._lineIndexCount+=3*(this._lineIndexBuffer.index-v)}}},t.prototype._computeExtrudeVectors=function(e,t){var i=this.vertices,r=this.verticesLen,o=this.isClosed,s=i[t],a=[void 0,void 0],l=[void 0,void 0];if(t>0&&r-1>t){var c=i[(t+r-1)%r],u=i[(t+1)%r];n.normalize(a,[s.x-c.x,s.y-c.y]),n.normalize(l,[u.x-s.x,u.y-s.y])}else if(0===t){var u=i[(t+1)%r];if(n.normalize(l,[u.x-s.x,u.y-s.y]),o){var d=i[r-2];n.normalize(a,[s.x-d.x,s.y-d.y])}else a=l}else{if(t!==r-1)return void console.error("Vertex index 'i' out of range.");var c=i[(t+r-1)%r];if(n.normalize(a,[s.x-c.x,s.y-c.y]),o){var h=i[1];n.normalize(l,[h.x-s.x,h.y-s.y])}else l=a}o||0!==t?o||t!==r-1?this._computeJoinExtrudeVectors(e,a,l):this._computeCapExtrudeVectors(e,a,l,n.CapPosition.END):this._computeCapExtrudeVectors(e,a,l,n.CapPosition.START)},t.prototype._computeCapExtrudeVectors=function(e,t,i,r){0===this.cap?f.buttCap(e,t,i):1===this.cap?f.roundCap(e,t,i,r,n.getNumberOfSlices(Math.PI),r===n.CapPosition.START?-1:1):2===this.cap?f.squareCap(e,t,i,r):f.buttCap(e,t,i)},t.prototype._computeJoinExtrudeVectors=function(e,t,i){var r=n.getRads(t,i);if(r>Math.PI-this.almostParallelRads)f.rectJoin(e,t,i);else if(0===this.join&&r>=this.veryShallowRads)f.bevelJoin(e,t,i,1);else if(1===this.join&&r>=this.veryShallowRads){var o=n.getNumberOfSlices(r),s=r<this.newRoundJoinsSafeRads;s?2>o||r<this.roundLimitRads?f.bevelJoin(e,t,i,1):f.roundJoin(e,t,i,o):f.unitRoundJoin(e,t,i,o)}else r<this.almostParallelRads?f.fastMiterJoin(e,t,i):r<this.miterSafeRads?f.miterJoin(e,t,i):f.bevelJoin(e,t,i,this.miterLimitMag)},t.prototype._writeGPUVertices=function(e,t,i,r,o){for(var n=0;n<r.vectors.count;++n){var s=r.vectors.items[n].vector[0],a=r.vectors.items[n].vector[1],l=r.vectors.items[n].texCoords[0],c=r.vectors.items[n].texCoords[1];r.vectors.items[n].base=this._lineVertexBuffer.index,this._lineVertexBuffer.add(e,t,s,a,l,c,i,o)}},t.prototype._writeGPUBridgeElements=function(e,t,i){if(f.bridge(this.recycledTriangleBridge,e,t),!i)for(var r=0;r<this.recycledTriangleBridge.count;++r){var o=this.recycledTriangleBridge.items[r];this._lineIndexBuffer.add(o.v1.base,o.v2.base,o.v3.base)}},t.prototype._writeGPUPieElements=function(e,t){if(f.pie(this.recycledTrianglePie,e),!t)for(var i=0;i<this.recycledTrianglePie.count;++i){var r=this.recycledTrianglePie.items[i];this._lineIndexBuffer.add(r.v1.base,r.v2.base,r.v3.base)}},t.prototype._isClipEdge=function(e,t){return e.x===t.x?e.x<=-64||e.x>=4160:e.y===t.y?e.y<=-64||e.y>=4160:!1},t}(o);return p});