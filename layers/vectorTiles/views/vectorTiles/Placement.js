// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["require","exports","./Geometry","./GeometryUtils","./Conflict"],function(t,n,e,i,o){var r=function(){function t(t,n,e,i,o){void 0===e&&(e=0),void 0===i&&(i=-1),void 0===o&&(o=c),this.x=t,this.y=n,this.angle=e,this.segment=i,this.minzoom=o}return t}();n.Anchor=r;var a=function(){function t(t,n,e){this.glyph=t,this.x=n,this.y=e}return t}();n.ShapedGlyph=a;var h=function(){function t(t,n,e,o,r,a){void 0===o&&(o=!1),void 0===r&&(r=c),void 0===a&&(a=i.C_INFINITY),this.anchor=t,this.labelAngle=n,this.glyphAngle=e,this.upsideDown=o,this.minzoom=r,this.maxzoom=a}return t}(),l=function(){function t(t,n,e,i,o,r,a,h,l){this.tl=t,this.tr=n,this.bl=e,this.br=i,this.mosaicRect=o,this.labelAngle=r,this.anchor=a,this.minzoom=h,this.maxzoom=l}return t}();n.PlacedSymbol=l;var s=function(){function t(t,n){this.footprint=t,this.shapes=n}return t}();n.Placement=s;var c=.5,p=2,m=function(){function t(t){this.mapAngle=t,this._conflictEngine=new o.ConflictEngine(t)}return t.prototype.getIconPlacement=function(t,n,r,a,h,p){var m=n.width/n.pixelRatio,g=n.height/n.pixelRatio,f=h.offset[0]-m/2,u=h.offset[1]-g/2,I=f+m,d=u+g,x=n.rect,w=f-1,v=u-1,y=w+x.width/n.pixelRatio,_=v+x.height/n.pixelRatio,N=new e.Point(w,v),P=new e.Point(y,_),T=new e.Point(w,_),A=new e.Point(y,v),C=h.rotate*i.C_DEG_TO_RAD,b=1===h.rotationAlignment;if(t.segment>=0&&!b&&(C+=t.angle),0!==C){var E=Math.cos(C),z=Math.sin(C);N.rotate(E,z),P.rotate(E,z),T.rotate(E,z),A.rotate(E,z)}var F=8,M=h.padding*F,G=new e.Point(t.x,t.y),Y=new o.Footprint(this.mapAngle,M,b);Y.addBox(G,new o.Box(f,u,I,d),r,C,c,i.C_INFINITY);var B=new l(N,A,T,P,x,0,G,c,i.C_INFINITY),R=new s(Y,[B]),O=c;return h.allowOverlap||(O=this._conflictEngine.getMinZoom(R.footprint,O,p,b)),Y.minzoom=O,R},t.prototype.getTextPlacement=function(t,n,r,a,m,g,f,u){for(var I,d=new e.Point(t.x,t.y),x=f.rotate*i.C_DEG_TO_RAD,w=0===f.rotationAlignment,v=f.keepUpright,y=c,_=!w,N=_?0:t.angle,P=t.segment>=0&&w,T=8,A=f.padding*T,C=new o.Footprint(this.mapAngle,A,_),b=[],E=3,z=!P,F=Number.POSITIVE_INFINITY,M=Number.NEGATIVE_INFINITY,G=F,Y=M,B=P?v:w&&v,R=[],O=0,D=r;O<D.length;O++){var q=D[O],S=a[q.glyph];if(S){var V=S.rect;if(!(!V||V.width<=0||V.height<=0)){var k=S.metrics;z&&(I&&I!==q.y&&(C.addBox(d,new o.Box(F,G,M,Y),m,x,c,i.C_INFINITY),F=Number.POSITIVE_INFINITY,M=Number.NEGATIVE_INFINITY,G=F,Y=M),I=q.y);var U=[];if(P){var Z=.5*S.metrics.width,j=(n.x+q.x+k.left-E+Z)*m;if(y=this._placeGlyph(t,y,j,g,t.segment,1,U),v&&(y=this._placeGlyph(t,y,j,g,t.segment,-1,U)),y>=p)break}else U.push(new h(d,N,N)),w&&v&&U.push(new h(d,N+i.C_PI,N+i.C_PI,!0));for(var H=q.x+n.x+k.left,J=q.y+n.y-k.top,K=H+k.width,L=J+k.height,Q=new e.Point(H-E,J-E),W=new e.Point(Q.x+V.width,Q.y+V.height),X=new e.Point(Q.x,W.y),$=new e.Point(W.x,Q.y),tt=0,nt=U;tt<nt.length;tt++){var et=nt[tt],it=Q.clone(),ot=X.clone(),rt=$.clone(),at=W.clone(),ht=J,lt=L,st=et.glyphAngle+x;if(0!==st){var ct=Math.cos(st),pt=Math.sin(st);it.rotate(ct,pt),at.rotate(ct,pt),ot.rotate(ct,pt),rt.rotate(ct,pt)}b.push(new l(it,rt,ot,at,V,et.labelAngle,et.anchor,et.minzoom,et.maxzoom)),(!B||this._legible(et.labelAngle))&&(z?(F>H&&(F=H),G>ht&&(G=ht),K>M&&(M=K),lt>Y&&(Y=lt)):et.minzoom<p&&C.addBox(et.anchor,new o.Box(H,ht,K,lt),m,st,et.minzoom,et.maxzoom)),R.push(et)}}}}if(y>=p)return null;z&&C.addBox(d,new o.Box(F,G,M,Y),m,x,c,i.C_INFINITY);var mt=new s(C,b);return f.allowOverlap||(y=this._conflictEngine.getMinZoom(mt.footprint,y,u,_)),C.minzoom=y,mt},t.prototype.add=function(t){this._conflictEngine.add(t.footprint)},t.prototype._legible=function(t){var n=i.radToByte(t);return 65>n||n>=193},t.prototype._placeGlyph=function(t,n,o,r,a,l,s){var c=l,p=0>c?i.positiveMod(t.angle+i.C_PI,i.C_2PI):t.angle,m=this._legible(p),g=0;0>o&&(c*=-1,o*=-1,g=i.C_PI),c>0&&++a;var f=new e.Point(t.x,t.y),u=r[a],I=i.C_INFINITY;if(r.length<=a)return I;for(;;){var d=u.x-f.x,x=u.y-f.y,w=Math.sqrt(d*d+x*x),v=Math.max(o/w,n),y=d/w,_=x/w,N=i.positiveMod(Math.atan2(_,y)+g,i.C_2PI);if(s.push(new h(f,p,N,m,v,I)),n>=v)return v;f=u.clone();do{if(a+=c,r.length<=a||0>a)return v;u=r[a]}while(f.isEqual(u));var P=u.x-f.x,T=u.y-f.y,A=Math.sqrt(P*P+T*T);P*=w/A,T*=w/A,f.x-=P,f.y-=T,I=v}},t}();n.PlacementEngine=m});