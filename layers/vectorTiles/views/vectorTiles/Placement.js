// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define(["require","exports","./Geometry","./GeometryUtils","./Conflict"],function(t,n,e,i,o){var r=function(){function t(t,n,e,i,o){void 0===e&&(e=0),void 0===i&&(i=-1),void 0===o&&(o=c),this.x=t,this.y=n,this.angle=e,this.segment=i,this.minzoom=o}return t}();n.Anchor=r;var a=function(){function t(t,n,e){this.glyph=t,this.x=n,this.y=e}return t}();n.ShapedGlyph=a;var h=function(){function t(t,n,e,o,r,a){void 0===o&&(o=!1),void 0===r&&(r=c),void 0===a&&(a=i.C_INFINITY),this.anchor=t,this.labelAngle=n,this.glyphAngle=e,this.upsideDown=o,this.minzoom=r,this.maxzoom=a}return t}(),l=function(){function t(t,n,e,i,o,r,a,h,l){this.tl=t,this.tr=n,this.bl=e,this.br=i,this.mosaicRect=o,this.labelAngle=r,this.anchor=a,this.minzoom=h,this.maxzoom=l}return t}();n.PlacedSymbol=l;var s=function(){function t(t,n){this.footprint=t,this.shapes=n}return t}();n.Placement=s;var c=.5,f=2,m=function(){function t(t){this.mapAngle=t,this._conflictEngine=new o.ConflictEngine(t)}return t.prototype.getIconPlacement=function(t,n,r,a,h,f){var m=n.width/n.pixelRatio,p=n.height/n.pixelRatio,g=h.offset[0]-m/2,u=h.offset[1]-p/2,I=g+m,y=u+p,d=n.rect,v=new e.Point(g,u),x=new e.Point(g+d.width/n.pixelRatio,u+d.height/n.pixelRatio),w=new e.Point(g,x.y),_=new e.Point(x.x,u),N=h.rotate*i.C_DEG_TO_RAD,P=1===h.rotationAlignment;if(t.segment>=0&&!P&&(N+=t.angle),0!==N){var T=Math.cos(N),A=Math.sin(N);v.rotate(T,A),x.rotate(T,A),w.rotate(T,A),_.rotate(T,A)}var C=8,E=h.padding*C,b=new e.Point(t.x,t.y),M=new o.Footprint(this.mapAngle,E,P);M.addBox(b,new o.Box(g,u,I,y),r,N,c,i.C_INFINITY);var z=new l(v,_,w,x,d,0,b,c,i.C_INFINITY),F=new s(M,[z]),G=c;return h.allowOverlap||(G=this._conflictEngine.getMinZoom(F.footprint,G,f,P)),M.minzoom=G,F},t.prototype.getTextPlacement=function(t,n,r,a,m,p,g,u){for(var I,y=new e.Point(t.x,t.y),d=g.maxAngle*i.C_DEG_TO_RAD,v=Math.cos(d),x=g.rotate*i.C_DEG_TO_RAD,w=0===g.rotationAlignment,_=g.keepUpright,N=c,P=!w,T=P?0:t.angle,A=t.segment>=0&&w,C=8,E=g.padding*C,b=new o.Footprint(this.mapAngle,E,P),M=[],z=3,F=!A,G=Number.POSITIVE_INFINITY,Y=Number.NEGATIVE_INFINITY,B=G,D=Y,R=A?_:w&&_,O=0,q=r;O<q.length;O++){var S=q[O],V=a[S.glyph];if(V){var k=V.rect;if(!(!k||k.width<=0||k.height<=0)){var U=V.metrics;F&&(I&&I!==S.y&&(b.addBox(y,new o.Box(G,B,Y,D),m,x,c,i.C_INFINITY),G=Number.POSITIVE_INFINITY,Y=Number.NEGATIVE_INFINITY,B=G,D=Y),I=S.y);var Z=[];if(A){var j=.5*V.metrics.width,H=(n.x+S.x+U.left-z+j)*m;if(N=this._placeGlyph(t,N,H,p,t.segment,1,v,Z),_&&(N=this._placeGlyph(t,N,H,p,t.segment,-1,v,Z)),N>=f)break}else Z.push(new h(y,T,T)),w&&_&&Z.push(new h(y,T+i.C_PI,T+i.C_PI,!0));for(var J=S.x+n.x+U.left,K=S.y+n.y-U.top,L=J+U.width,Q=K+U.height,W=new e.Point(J-z,K-z),X=new e.Point(W.x+k.width,W.y+k.height),$=new e.Point(W.x,X.y),tt=new e.Point(X.x,W.y),nt=0,et=Z;nt<et.length;nt++){var it=et[nt],ot=W.clone(),rt=$.clone(),at=tt.clone(),ht=X.clone(),lt=K,st=Q;if(it.upsideDown){var ct=-2*g.offset[1]*24;lt+=ct,st+=ct,ot.y+=ct,rt.y+=ct,at.y+=ct,ht.y+=ct}var ft=it.glyphAngle+x;if(0!==ft){var mt=Math.cos(ft),pt=Math.sin(ft);ot.rotate(mt,pt),ht.rotate(mt,pt),rt.rotate(mt,pt),at.rotate(mt,pt)}M.push(new l(ot,at,rt,ht,k,it.labelAngle,it.anchor,it.minzoom,it.maxzoom)),(!R||this._legible(it.labelAngle))&&(F?(G>J&&(G=J),B>lt&&(B=lt),L>Y&&(Y=L),st>D&&(D=st)):it.minzoom<f&&b.addBox(it.anchor,new o.Box(J,lt,L,st),m,ft,it.minzoom,it.maxzoom))}}}}if(N>=f)return null;F&&b.addBox(y,new o.Box(G,B,Y,D),m,x,c,i.C_INFINITY);var gt=new s(b,M);return g.allowOverlap||(N=this._conflictEngine.getMinZoom(gt.footprint,N,u,P)),b.minzoom=N,gt},t.prototype.add=function(t){this._conflictEngine.add(t.footprint)},t.prototype._legible=function(t){var n=i.radToByte(t);return 65>n||n>=193},t.prototype._placeGlyph=function(t,n,o,r,a,l,s,c){var f=l,m=0>f?i.positiveMod(t.angle+i.C_PI,i.C_2PI):t.angle,p=this._legible(m),g=0;0>o&&(f*=-1,o*=-1,g=i.C_PI),f>0&&++a;var u,I,y=new e.Point(t.x,t.y),d=r[a],v=i.C_INFINITY;if(r.length<=a)return v;for(;;){var x=d.x-y.x,w=d.y-y.y,_=Math.sqrt(x*x+w*w),N=Math.max(o/_,n),P=x/_,T=w/_,A=i.positiveMod(Math.atan2(T,P)+g,i.C_2PI);if(void 0!==u){var C=P*u+T*I;if(s>C)return v}if(u=P,I=T,c.push(new h(y,m,A,p,N,v)),n>=N)return N;y=d.clone();do{if(a+=f,r.length<=a||0>a)return N;d=r[a]}while(y.isEqual(d));var E=d.x-y.x,b=d.y-y.y,M=Math.sqrt(E*E+b*b);E*=_/M,b*=_/M,y.x-=E,y.y-=b,v=N}},t}();n.PlacementEngine=m});