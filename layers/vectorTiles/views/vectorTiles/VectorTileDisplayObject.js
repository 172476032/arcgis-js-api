// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/extendsHelper","../webgl/BufferObject","../2d/engine/DisplayObject","../../core/libs/gl-matrix/vec2","../../core/libs/gl-matrix/mat4","./RenderBucket"],function(e,t,r,i,s,n,a,l){var o=function(e){function t(t,r,i,s,l,o,f,u,h,c,x){var d=e.call(this)||this;return d._renderBuckets=[],d._vectorTileData=null,d._symbolUpdateData=null,d.topLeft=[0,0],d.bottomRight=[0,0],d.tileTransform={transform:Float32Array[16],displayCoord:Float32Array[2]},d.stencilData={mask:0,reference:0},d.key=t,d.refKey=r,d.topLeft[0]=i[0],d.topLeft[1]=i[1],d.bottomRight[0]=i[2],d.bottomRight[1]=i[3],d.widthInPixels=s,d.coordRange=l,d.rotation=o,d._vectorTileData=f,d.styleLayers=u,d._glyphsMosaic=h,d.workerID=c,d._connection=x,d.id=t.id,d.status=3,d.tileTransform.transform=a.create(),d.tileTransform.displayCoord=n.create(),d}return r(t,e),t.prototype.updateSymbolData=function(e){e&&(this._symbolUpdateData=e,this.requestRender())},t.prototype.dispose=function(){-1!==this.workerID&&this._connection&&6!==this.status&&7!==this.status&&this._connection.broadcast("destructTileData",{key:this.id,worker:this.workerID},[]),this.polygonTrianglesVertexArrayObject&&(this.polygonTrianglesVertexArrayObject.dispose(),this.polygonTrianglesVertexArrayObject=null),this.polygonOutlineVertexArrayObject&&(this.polygonOutlineVertexArrayObject.dispose(),this.polygonOutlineVertexArrayObject=null),this.lineTrianglesVertexArrayObject&&(this.lineTrianglesVertexArrayObject.dispose(),this.lineTrianglesVertexArrayObject=null),this.lineJoinsVertexArrayObject&&(this.lineJoinsVertexArrayObject.dispose(),this.lineJoinsVertexArrayObject=null),this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=null),this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null),this.polygonTrianglesVertexBuffer&&(this.polygonTrianglesVertexBuffer.dispose(),this.polygonTrianglesVertexBuffer=null),this.polygonTrianglesIndexBuffer&&(this.polygonTrianglesIndexBuffer.dispose(),this.polygonTrianglesIndexBuffer=null),this.polygonOutlinesVertexBuffer&&(this.polygonOutlinesVertexBuffer.dispose(),this.polygonOutlinesVertexBuffer=null),this.polygonOutlinesIndexBuffer&&(this.polygonOutlinesIndexBuffer.dispose(),this.polygonOutlinesIndexBuffer=null),this.lineVertexBuffer&&(this.lineVertexBuffer.dispose(),this.lineVertexBuffer=null),this.lineTrianglesIndexBuffer&&(this.lineTrianglesIndexBuffer.dispose(),this.lineTrianglesIndexBuffer=null),this.lineJoinVertexBuffer&&(this.lineJoinVertexBuffer.dispose(),this.lineJoinVertexBuffer=null),this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null),this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null),this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null),this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),this._renderBuckets=[],this.status=7},t.prototype.attach=function(e){if(this.status=3,!this._vectorTileData)return!1;if(0===this._renderBuckets.length)for(var t=new Uint32Array(this._vectorTileData.bucketDataInfo),r=t.length,s=0;r>s;){var n=t[s],a=t[s+1];if(0===a){var o=new l.BackgroundRenderBucket;o.layerID=n,this._renderBuckets.push(o),s+=2}else if(1===a){var f=new l.FillRenderBucket;f.layerID=n,f.triangleElementStart=t[s+2],f.triangleElementCount=t[s+3],f.outlineElementStart=t[s+4],f.outlineElementCount=t[s+5],this._renderBuckets.push(f),s+=6}else if(2===a){var u=new l.LineRenderBucket;u.layerID=n,u.triangleElementStart=t[s+2],u.triangleElementCount=t[s+3],u.joinStart=t[s+4],u.joinCount=t[s+5],this._renderBuckets.push(u),s+=6}else if(3===a){var h=new l.SymbolRenderBucket;h.layerID=n,h.textElementStart=t[s+2],h.textElementCount=t[s+3],h.isSDF=0!==t[s+4];var c=t[s+5];if(c>0)for(var x=s+6,d=void 0,y=void 0,p=void 0,B=0;c>B;B++)d=t[x],y=t[x+1],p=t[x+2],h.markerPerPageElementsMap.set(d,[y,p]),x+=3;this._renderBuckets.push(h),s+=6+3*c}else console.error("Bad bucket type!")}for(var b=e.context,g=e.budget,D=new Uint32Array(this._vectorTileData.bufferDataInfo),V=D.length,v=0,I=0;V>I;I+=2,v++){var k=D[I],_=D[I+1];if(!(0>=_||0===this._vectorTileData.bufferData[v].byteLength)){if(g&&g.done)return!1;switch(k){case 2:this.polygonTrianglesVertexBuffer||(this.polygonTrianglesVertexBuffer=i.createVertex(b,35044,this._vectorTileData.bufferData[v]));break;case 6:this.polygonTrianglesIndexBuffer||(this.polygonTrianglesIndexBuffer=i.createIndex(b,35044,new Uint32Array(this._vectorTileData.bufferData[v],0,_/4)));break;case 3:this.polygonOutlinesVertexBuffer||(this.polygonOutlinesVertexBuffer=i.createVertex(b,35044,this._vectorTileData.bufferData[v]));break;case 7:this.polygonOutlinesIndexBuffer||(this.polygonOutlinesIndexBuffer=i.createIndex(b,35044,new Uint32Array(this._vectorTileData.bufferData[v],0,_/4)));break;case 0:this.lineVertexBuffer||(this.lineVertexBuffer=i.createVertex(b,35044,this._vectorTileData.bufferData[v]));break;case 8:this.lineTrianglesIndexBuffer||(this.lineTrianglesIndexBuffer=i.createIndex(b,35044,this._vectorTileData.bufferData[v]));break;case 1:this.lineJoinVertexBuffer||(this.lineJoinVertexBuffer=i.createVertex(b,35044,this._vectorTileData.bufferData[v]));break;case 4:this.iconVertexBuffer||(this.iconVertexBuffer=i.createVertex(b,35044,this._vectorTileData.bufferData[v]));break;case 9:this.iconIndexBuffer||(this.iconIndexBuffer=i.createIndex(b,35044,new Uint32Array(this._vectorTileData.bufferData[v],0,_/4)));break;case 5:this.textVertexBuffer||(this.textVertexBuffer=i.createVertex(b,35044,this._vectorTileData.bufferData[v]));break;case 10:this.textIndexBuffer||(this.textIndexBuffer=i.createIndex(b,35044,new Uint32Array(this._vectorTileData.bufferData[v],0,_/4)))}}}return this.status=4,!0},t.prototype.detach=function(e){},t.prototype.render=function(e){if(this.visible&&4===this.status){var t=e.context,r=e.renderer;if(t&&r){var i=e.drawphase;this._symbolUpdateData&&this._updateSymbolData(e),t.setStencilFunction(514,this.stencilData.reference,this.stencilData.mask);var s=this.styleLayers,n=void 0!==e.layerOpacity?e.layerOpacity:1;if(0!==n){var a,l=this._renderBuckets.length,o=0;if(0===i)for(o=l-1;o>=0;o--)a=this._renderBuckets[o],3!==a.type&&a.hasData()&&r.renderBucket(t,a,e.displayLevel,e.requiredLevel,i,this,s.layers[a.layerID],n);else for(o=0;l>o;o++)a=this._renderBuckets[o],a.hasData()&&r.renderBucket(t,a,e.displayLevel,e.requiredLevel,i,this,s.layers[a.layerID],n)}}}},t.prototype._updateSymbolData=function(e){var t=new Uint32Array(this._symbolUpdateData.bucketDataInfo),r=t.length;if(0===r)return this._symbolUpdateData=null,!0;if(e.budget.remaining<1)return this.requestRender(),!1;var s=e.context;s.bindVAO(null);for(var n=new Uint32Array(this._symbolUpdateData.bufferDataInfo),a=n.length,o=0,f=0;a>f;f+=2,o++){var u=n[f],h=n[f+1];if(!(0>=h||0===this._symbolUpdateData.bufferData[o].byteLength))switch(u){case 4:this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null),this.iconVertexBuffer=i.createVertex(s,35044,this._symbolUpdateData.bufferData[o]);break;case 9:this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null),this.iconIndexBuffer=i.createIndex(s,35044,new Uint32Array(this._symbolUpdateData.bufferData[o],0,h/4));break;case 5:this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null),this.textVertexBuffer=i.createVertex(s,35044,this._symbolUpdateData.bufferData[o]);break;case 10:this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),this.textIndexBuffer=i.createIndex(s,35044,new Uint32Array(this._symbolUpdateData.bufferData[o],0,h/4))}}for(var c=this._renderBuckets.length,x=0;c>x;x++){var d=this._renderBuckets[x];if(d instanceof l.SymbolRenderBucket){var y=this._renderBuckets[x];y.markerPerPageElementsMap.clear(),y.textElementStart=0,y.textElementCount=0}}for(var p,B,b=0;r>b;){var g=t[b];B=-1;for(var D=this._renderBuckets.length,x=0;D>x;x++)if(this._renderBuckets[x].layerID===g){B=x;break}if(-1===B&&console.log("bucket not found"),p=this._renderBuckets[B]){p.textElementStart=t[b+2],p.textElementCount=t[b+3];for(var V=t[b+5],v=b+6,I=void 0,k=void 0,_=void 0,m=0;V>m;m++)I=t[v],k=t[v+1],_=t[v+2],p.markerPerPageElementsMap.set(I,[k,_]),v+=3;b+=6+3*V}else b+=7}return this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=null),this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null),this._symbolUpdateData=null,!0},t}(s);return o});