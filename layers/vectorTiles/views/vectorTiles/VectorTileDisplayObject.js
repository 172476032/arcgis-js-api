// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/extendsHelper","../../core/libs/gl-matrix/vec2","../../core/libs/gl-matrix/mat4","../../core/ObjectPool","../../geometry/support/spatialReferenceUtils","../webgl/BufferObject","../2d/engine/DisplayObject","../2d/tiling/TileKey","./RenderBucket"],function(e,t,r,i,s,a,f,l,n,u,h){var o=function(e){function t(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];var a=e.call(this)||this;return a._renderBuckets=[],a._vectorTileData=null,a._symbolUpdateData=null,a.status=5,a.coords=[0,0],a.bounds=[0,0,0,0],a.tileTransform={transform:Float32Array[16],displayCoord:Float32Array[2]},a.stencilData={mask:0,reference:0},a.status=0,a.tileTransform.transform=s.create(),a.tileTransform.displayCoord=i.create(),t.length>0&&(f=a.acquire).call.apply(f,[a].concat(t)),a;var f}return r(t,e),t.prototype.reset=function(){u.pool.release(this.key),this.key=null,this.refKey=null,this.coords[0]=0,this.coords[1]=0,this.bounds[0]=0,this.bounds[1]=0,this.bounds[2]=0,this.bounds[3]=0,this.width=0,this.height=0,this.resolution=null,this.rotation=0,this._vectorTileData=null,this.styleLayers=null,this.workerID=null,this._connection=null,this.id=null,this.tileTransform.transform.fill(0),this.tileTransform.displayCoord.fill(0),this.stencilData.mask=0,this.stencilData.reference=0,this._renderBuckets.length=0,this._symbolUpdateData=null,this.status=0},t.prototype.acquire=function(e,t,r,i,s){this.key=e,this.refKey=t;var a=r.lodAt(e.level).resolution,l=r.size[0]*a,n=r.origin,u=e.col*l,h=e.row*l,o=r.spatialReference,c=o&&(o._isWrappable?o._isWrappable():o.isWrappable),D=0;if(c){var x=f.getInfo(o);D=x.valid[1]-x.valid[0]}var d=e.world*D,b=n.x+u+d,B=n.y-h,V=b+l,y=B-l;this.coords[0]=b,this.coords[1]=B,this.bounds[0]=b,this.bounds[1]=B,this.bounds[2]=V,this.bounds[3]=y,this.widthInPixels=r.size[1],this.coordRange=4096,this.resolution=a,this.rotation=s,this.styleLayers=i,this.id=e.id,this.status=1},t.prototype.setData=function(e,t,r){this._vectorTileData=e,this.workerID=t,this._connection=r,this.status=3},t.prototype.updateSymbolData=function(e){e&&(this._symbolUpdateData=e,this.requestRender())},t.prototype.dispose=function(){this.fillVertexArrayObject&&(this.fillVertexArrayObject.dispose(),this.fillVertexArrayObject=null),this.fillDDVertexArrayObject&&(this.fillDDVertexArrayObject.dispose(),this.fillDDVertexArrayObject=null),this.outlineVertexArrayObject&&(this.outlineVertexArrayObject.dispose(),this.outlineVertexArrayObject=null),this.outlineDDVertexArrayObject&&(this.outlineDDVertexArrayObject.dispose(),this.outlineDDVertexArrayObject=null),this.lineVertexArrayObject&&(this.lineVertexArrayObject.dispose(),this.lineVertexArrayObject=null),this.lineDDVertexArrayObject&&(this.lineDDVertexArrayObject.dispose(),this.lineDDVertexArrayObject=null),this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=null),this.iconDDVertexArrayObject&&(this.iconDDVertexArrayObject.dispose(),this.iconDDVertexArrayObject=null),this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null),this.textDDVertexArrayObject&&(this.textDDVertexArrayObject.dispose(),this.textDDVertexArrayObject=null),this.fillVertexBuffer&&(this.fillVertexBuffer.dispose(),this.fillVertexBuffer=null),this.fillDDVertexBuffer&&(this.fillDDVertexBuffer.dispose(),this.fillDDVertexBuffer=null),this.fillIndexBuffer&&(this.fillIndexBuffer.dispose(),this.fillIndexBuffer=null),this.outlineVertexBuffer&&(this.outlineVertexBuffer.dispose(),this.outlineVertexBuffer=null),this.outlineDDVertexBuffer&&(this.outlineDDVertexBuffer.dispose(),this.outlineDDVertexBuffer=null),this.outlineIndexBuffer&&(this.outlineIndexBuffer.dispose(),this.outlineIndexBuffer=null),this.lineVertexBuffer&&(this.lineVertexBuffer.dispose(),this.lineVertexBuffer=null),this.lineDDVertexBuffer&&(this.lineDDVertexBuffer.dispose(),this.lineDDVertexBuffer=null),this.lineIndexBuffer&&(this.lineIndexBuffer.dispose(),this.lineIndexBuffer=null),this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null),this.iconDDVertexBuffer&&(this.iconDDVertexBuffer.dispose(),this.iconDDVertexBuffer=null),this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null),this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null),this.textDDVertexBuffer&&(this.textDDVertexBuffer.dispose(),this.textDDVertexBuffer=null),this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null),this._renderBuckets.length=0,this.status=7},t.prototype.attach=function(e){if(4===this.status)return!0;if(this.status=3,!this._vectorTileData)return!1;if(!this._vectorTileData.bufferDataInfo)return this.status=4,!0;if(0===this._renderBuckets.length)for(var t=new Uint32Array(this._vectorTileData.bucketDataInfo),r=t.length,i=0;r>i;){var s=t[i],a=t[i+1];if(0===a){var f=new h.BackgroundRenderBucket;f.layerID=s,this._renderBuckets.push(f),i+=2}else if(1===a){var n=new h.FillRenderBucket;n.layerID=s,n.triangleElementStart=t[i+2],n.triangleElementCount=t[i+3],n.outlineElementStart=t[i+4],n.outlineElementCount=t[i+5],this._renderBuckets.push(n),i+=6}else if(2===a){var u=new h.LineRenderBucket;u.layerID=s,u.triangleElementStart=t[i+2],u.triangleElementCount=t[i+3],this._renderBuckets.push(u),i+=6}else if(3===a){var o=new h.SymbolRenderBucket;o.layerID=s,o.isSDF=0!==t[i+2];var c=i+3,D=t[c];if(c++,D>0)for(var x=void 0,d=void 0,b=void 0,B=0;D>B;B++)x=t[c],d=t[c+1],b=t[c+2],o.markerPerPageElementsMap.set(x,[d,b]),c+=3;var V=c,y=t[V];if(V++,y>0)for(var x=void 0,d=void 0,b=void 0,B=0;y>B;B++)x=t[V],d=t[V+1],b=t[V+2],o.glyphPerPageElementsMap.set(x,[d,b]),V+=3;this._renderBuckets.push(o),i+=5+3*D+3*y}else console.error("Bad bucket type!")}for(var p=e.context,v=new Uint32Array(this._vectorTileData.bufferDataInfo),_=v.length,k=0,I=0;_>I;I+=2,k++){var m=v[I],A=v[I+1];if(!(0>=A||0===this._vectorTileData.bufferData[k].byteLength))switch(m){case 1:this.fillVertexBuffer?this.fillVertexBuffer.setData(this._vectorTileData.bufferData[k]):this.fillVertexBuffer=l.createVertex(p,35044,this._vectorTileData.bufferData[k]);break;case 2:this.fillDDVertexBuffer?this.fillDDVertexBuffer.setData(this._vectorTileData.bufferData[k]):this.fillDDVertexBuffer=l.createVertex(p,35044,this._vectorTileData.bufferData[k]);break;case 3:this.fillIndexBuffer?this.fillIndexBuffer.setData(this._vectorTileData.bufferData[k]):this.fillIndexBuffer=l.createIndex(p,35044,this._vectorTileData.bufferData[k]);break;case 4:this.outlineVertexBuffer?this.outlineVertexBuffer.setData(this._vectorTileData.bufferData[k]):this.outlineVertexBuffer=l.createVertex(p,35044,this._vectorTileData.bufferData[k]);break;case 5:this.outlineDDVertexBuffer?this.outlineDDVertexBuffer.setData(this._vectorTileData.bufferData[k]):this.outlineDDVertexBuffer=l.createVertex(p,35044,this._vectorTileData.bufferData[k]);break;case 6:this.outlineIndexBuffer?this.outlineIndexBuffer.setData(this._vectorTileData.bufferData[k]):this.outlineIndexBuffer=l.createIndex(p,35044,this._vectorTileData.bufferData[k]);break;case 7:this.lineVertexBuffer?this.lineVertexBuffer.setData(this._vectorTileData.bufferData[k]):this.lineVertexBuffer=l.createVertex(p,35044,this._vectorTileData.bufferData[k]);break;case 8:this.lineDDVertexBuffer?this.lineDDVertexBuffer.setData(this._vectorTileData.bufferData[k]):this.lineDDVertexBuffer=l.createVertex(p,35044,this._vectorTileData.bufferData[k]);break;case 9:this.lineIndexBuffer?this.lineIndexBuffer.setData(this._vectorTileData.bufferData[k]):this.lineIndexBuffer=l.createIndex(p,35044,this._vectorTileData.bufferData[k]);break;case 10:this.iconVertexBuffer?this.iconVertexBuffer.setData(this._vectorTileData.bufferData[k]):this.iconVertexBuffer=l.createVertex(p,35044,this._vectorTileData.bufferData[k]);break;case 11:this.iconDDVertexBuffer?this.iconDDVertexBuffer.setData(this._vectorTileData.bufferData[k]):this.iconDDVertexBuffer=l.createVertex(p,35044,this._vectorTileData.bufferData[k]);break;case 12:this.iconIndexBuffer?this.iconIndexBuffer.setData(this._vectorTileData.bufferData[k]):this.iconIndexBuffer=l.createIndex(p,35044,this._vectorTileData.bufferData[k]);break;case 13:this.textVertexBuffer?this.textVertexBuffer.setData(this._vectorTileData.bufferData[k]):this.textVertexBuffer=l.createVertex(p,35044,this._vectorTileData.bufferData[k]);break;case 14:this.textDDVertexBuffer?this.textDDVertexBuffer.setData(this._vectorTileData.bufferData[k]):this.textDDVertexBuffer=l.createVertex(p,35044,this._vectorTileData.bufferData[k]);break;case 15:this.textIndexBuffer?this.textIndexBuffer.setData(this._vectorTileData.bufferData[k]):this.textIndexBuffer=l.createIndex(p,35044,this._vectorTileData.bufferData[k])}}return this.status=4,!0},t.prototype.detach=function(t){-1!==this.workerID&&this._connection&&6!==this.status&&7!==this.status&&this._connection.broadcast("destructTileData",{key:this.id,worker:this.workerID},[]),this.dispose(),e.prototype.detach.call(this,t)},t.prototype.doRender=function(e){if(this.visible&&4===this.status){var t=e.context,r=e.renderer;if(t&&r){var i=e.drawphase;this._symbolUpdateData&&this._updateSymbolData(e),t.setStencilFunction(514,this.stencilData.reference,this.stencilData.mask);var s=this.styleLayers,a=void 0!==e.layerOpacity?e.layerOpacity:1;if(0!==a){var f,l=this._renderBuckets.length,n=0;if(0===i)for(n=l-1;n>=0;n--)f=this._renderBuckets[n],3!==f.type&&f.hasData()&&r.renderBucket(t,f,e.displayLevel,e.requiredLevel,i,this,s.layers[f.layerID],a);else for(n=0;l>n;n++)f=this._renderBuckets[n],f.hasData()&&r.renderBucket(t,f,e.displayLevel,e.requiredLevel,i,this,s.layers[f.layerID],a)}}}},t.prototype._updateSymbolData=function(e){if(!this._symbolUpdateData.bucketDataInfo)return!0;var t=new Uint32Array(this._symbolUpdateData.bucketDataInfo),r=t.length;if(0===r)return this._symbolUpdateData=null,!0;if(e.budget.remaining<1||4!==this.status)return this.requestRender(),!1;for(var i=e.context,s=new Uint32Array(this._symbolUpdateData.bufferDataInfo),a=s.length,f=0,n=0;a>n;n+=2,f++){var u=s[n];switch(u){case 10:this.iconVertexBuffer&&(this.iconVertexBuffer.dispose(),this.iconVertexBuffer=null),this.iconVertexBuffer=l.createVertex(i,35044,this._symbolUpdateData.bufferData[f]);break;case 11:this.iconDDVertexBuffer&&(this.iconDDVertexBuffer.dispose(),this.iconDDVertexBuffer=null),this.iconDDVertexBuffer=l.createVertex(i,35044,this._symbolUpdateData.bufferData[f]);break;case 12:this.iconIndexBuffer&&(this.iconIndexBuffer.dispose(),this.iconIndexBuffer=null),this.iconIndexBuffer=l.createIndex(i,35044,this._symbolUpdateData.bufferData[f]);break;case 13:this.textVertexBuffer&&(this.textVertexBuffer.dispose(),this.textVertexBuffer=null),this.textVertexBuffer=l.createVertex(i,35044,this._symbolUpdateData.bufferData[f]);break;case 14:this.textDDVertexBuffer&&(this.textDDVertexBuffer.dispose(),this.textDDVertexBuffer=null),this.textDDVertexBuffer=l.createVertex(i,35044,this._symbolUpdateData.bufferData[f]);break;case 15:this.textIndexBuffer&&(this.textIndexBuffer.dispose(),this.textIndexBuffer=null),this.textIndexBuffer=l.createIndex(i,35044,this._symbolUpdateData.bufferData[f])}}for(var o=this._renderBuckets.length,c=0;o>c;c++){var D=this._renderBuckets[c];if(D instanceof h.SymbolRenderBucket){var x=this._renderBuckets[c];x.markerPerPageElementsMap.clear(),x.glyphPerPageElementsMap.clear()}}for(var d,b,B=0;r>B;){var V=t[B];b=-1;for(var y=this._renderBuckets.length,c=0;y>c;c++)if(this._renderBuckets[c].layerID===V){b=c;break}d=this._renderBuckets[b],d||(d=new h.SymbolRenderBucket,d.layerID=V,d.isSDF=0!==t[B+2],this._renderBuckets.push(d));var p=B+3,v=t[p];if(p++,v>0)for(var _=void 0,k=void 0,I=void 0,m=0;v>m;m++)_=t[p],k=t[p+1],I=t[p+2],d.markerPerPageElementsMap.set(_,[k,I]),p+=3;var A=p,O=t[A];if(A++,O>0)for(var _=void 0,k=void 0,I=void 0,m=0;O>m;m++)_=t[A],k=t[A+1],I=t[A+2],d.glyphPerPageElementsMap.set(_,[k,I]),A+=3;B+=5+3*v+3*O}return this.iconVertexArrayObject&&(this.iconVertexArrayObject.dispose(),this.iconVertexArrayObject=null),this.iconDDVertexArrayObject&&(this.iconDDVertexArrayObject.dispose(),this.iconDDVertexArrayObject=null),this.textVertexArrayObject&&(this.textVertexArrayObject.dispose(),this.textVertexArrayObject=null),this.textDDVertexArrayObject&&(this.textDDVertexArrayObject.dispose(),this.textDDVertexArrayObject=null),this._symbolUpdateData=null,!0},t.pool=new a(t),t}(n);return o});