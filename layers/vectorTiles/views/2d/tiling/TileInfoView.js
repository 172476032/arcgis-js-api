// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","exports","./LODInfo","./TileCoverage","./TileKey","./TileSpan"],function(o,e,t,r,n,i){var l=function(){function o(o,e,t,r,n,i,l,s){this.x=o,this.ymin=e,this.ymax=t,this.invM=r,this.leftAdjust=n,this.rightAdjust=i,this.leftBound=l,this.rightBound=s}return o.create=function(e,t){e[1]>t[1]&&(c=[t,e],e=c[0],t=c[1]);var r=e[0],n=e[1],i=t[0],l=t[1],s=i-r,a=l-n,u=0!==a?s/a:0,f=(Math.ceil(n)-n)*u,h=(Math.floor(n)-n)*u;return new o(r,Math.floor(n),Math.ceil(l),u,s<0?f:h,s<0?h:f,s<0?i:r,s<0?r:i);var c},o.prototype.incrRow=function(){this.x+=this.invM},o.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)},o.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)},o}(),s=[[0,0],[0,0],[0,0],[0,0]];return function(){function o(o,e){var r=this;this.tileInfo=o,this.fullExtent=e,this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};var n=o.lods.slice();n.sort(function(o,e){return e.scale-o.scale});var i=this._lodInfos=n.map(function(r){return t.create(o,r,e)});n.forEach(function(o,e){r._infoByLevel[o.level]=i[e],r._infoByScale[o.scale]=i[e],r.scales[e]=o.scale},this),this._wrap=o.isWrappable}return o.prototype.getTileBounds=function(o,e){var t=this._infoByLevel[e.level];return t?t.getTileBounds(o,e):o},o.prototype.getTileCoords=function(o,e){var t=this._infoByLevel[e.level];return t?t.getTileCoords(o,e):o},o.prototype.getTileCoverage=function(o,e){void 0===e&&(e=192);var t,n,a,u=this.getClosestInfoForScale(o.scale),f=r.pool.acquire(u),h=this._wrap,c=1/0,p=-1/0,v=f.spans;s[0][0]=s[0][1]=s[1][1]=s[3][0]=-e,s[1][0]=s[2][0]=o.size[0]+e,s[2][1]=s[3][1]=o.size[1]+e;for(var d=0,g=s;d<g.length;d++){var m=g[d];o.toMap(m,m),m[0]=u.getColumnForX(m[0]),m[1]=u.getRowForY(m[1])}for(var y=[],w=3,M=0;M<4;M++)if(s[M][1]!==s[w][1]){var C=l.create(s[M],s[w]);c=Math.min(C.ymin,c),p=Math.max(C.ymax,p),void 0===y[C.ymin]&&(y[C.ymin]=[]),y[C.ymin].push(C),w=M}else w=M;if(null==c||null==p||p-c>100)return null;var B=[];for(t=c;t<p;){null!=y[t]&&(B=B.concat(y[t])),n=1/0,a=-1/0;for(var M=B.length-1;M>=0;M--){var C=B[M];n=Math.min(n,C.getLeftCol()),a=Math.max(a,C.getRightCol())}if(n=Math.floor(n),a=Math.floor(a),t>=u.first[1]&&t<=u.last[1])if(h)if(u.size[0]<u.worldSize[0])for(var _=Math.floor(a/u.worldSize[0]),M=Math.floor(n/u.worldSize[0]);M<=_;M++)v.push(new i(t,Math.max(u.getFirstColumnForWorld(M),n),Math.min(u.getLastColumnForWorld(M),a)));else v.push(new i(t,n,a));else n>u.last[0]||a<u.first[0]||(n=Math.max(n,u.first[0]),a=Math.min(a,u.last[0]),v.push(new i(t,n,a)));t+=1;for(var M=B.length-1;M>=0;M--){var C=B[M];C.ymax>=t?C.incrRow():B.splice(M,1)}}return f},o.prototype.getTileIdAtParent=function(o,e){var t=n.pool.acquire(e),r=this._infoByLevel[t.level];if(o.resolution<r.resolution)throw new Error("Cannot calculate parent tile. destination LOD's resolution "+o.resolution+" is not a parent resolution of "+r.resolution);if(o.resolution===r.resolution)return t.id;var i=Math.floor(t.col*r.resolution/o.resolution+.01),l=Math.floor(t.row*r.resolution/o.resolution+.01);return n.getId(o.level,l,i,t.world)},o.prototype.getTileParentId=function(o){var e=n.pool.acquire(o),t=this._infoByLevel[e.level],r=this._lodInfos.indexOf(t)-1;if(r<0)return n.pool.release(e),null;var i=this._lodInfos[r],l=this.getTileIdAtParent(i,e);return n.pool.release(e),l},o.prototype.getTileResolution=function(o){var e=this._infoByLevel[o.level];return e?e.resolution:-1},o.prototype.getTileScale=function(o){var e=this._infoByLevel[o.level];return e?e.scale:-1},o.prototype.intersects=function(o,e){var t=n.pool.acquire(e),r=this._infoByLevel[t.level],i=o.lodInfo;if(i.resolution>r.resolution){var l=n.pool.acquire(this.getTileIdAtParent(i,t)),s=i.denormalizeCol(l.col,l.world),a=o.spans.some(function(o){return o.row===l.row&&o.colFrom<=s&&o.colTo>=s});return n.pool.release(t),n.pool.release(l),a}if(i.resolution<r.resolution){var u=o.spans.reduce(function(o,e){return o[0]=Math.min(o[0],e.row),o[1]=Math.max(o[1],e.row),o[2]=Math.min(o[2],e.colFrom),o[3]=Math.max(o[3],e.colTo),o},[1/0,-1/0,1/0,-1/0]),f=u[0],h=u[1],c=u[2],p=u[3],v=r.denormalizeCol(t.col,t.world),d=i.getColumnForX(r.getXForColumn(v)),g=i.getRowForY(r.getYForRow(t.row)),m=i.getColumnForX(r.getXForColumn(v+1))-1,y=i.getRowForY(r.getYForRow(t.row+1))-1;return n.pool.release(t),!(d>p||m<c||g>h||y<f)}var w=i.denormalizeCol(t.col,t.world),M=o.spans.some(function(o){return o.row===t.row&&o.colFrom<=w&&o.colTo>=w});return n.pool.release(t),M},o.prototype.getClosestInfoForScale=function(o){var e=this.scales;return this._infoByScale[o]?this._infoByScale[o]:(o=e.reduce(function(e,t,r,n){return Math.abs(t-o)<Math.abs(e-o)?t:e},e[0]),this._infoByScale[o])},o}()});