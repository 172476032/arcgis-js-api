// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["require","exports","../../../../core/LRUCache","./TileKey"],function(e,t,i,s){function r(e,t){e["delete"](t)}var n=[],o=[],a=[null,null],l=[],h=new i(30),u=new s(0,0,0,0),f=function(){function e(e){this._tiles=new Map,this._tilesToRender=new Map,this._requests=new Map,this._updates=new Map,this._prevResolution=Number.POSITIVE_INFINITY,this._isStationary=!1,this.tileFilter=null,this.container=e.container,this.tileInfoView=e.tileInfoView,this.requestUpdate=e.requestUpdate,this.fetchTile=e.fetchTile,this.tileFilter=e.tileFilter}return e.prototype.destroy=function(){this._requests&&(this._requests.forEach(function(e){e.isFulfilled()||e.cancel()}),this._requests=null,this._tilesToRender=null)},Object.defineProperty(e.prototype,"updating",{get:function(){return 0!==this._requests.size||0!==this._updates.size},enumerable:!0,configurable:!0}),e.prototype.update=function(e){var t=this,i=this,s=i._tiles,o=i._tilesToRender,a=i._requests,f=i._updates,c=this.tileInfoView.getTileCoverage(e.state);if(c){var d=c.lodInfo,p=d.level,_=e.state.resolution,v=_>this._prevResolution;this._createCoverageList(n,c);var g=this.tileFilter?this.tileFilter([],n):n;o.clear();for(var T=0,w=0,I=g;w<I.length;w++){var y=I[w];if(s.has(y)){var q=s.get(y);if(o.set(y,q),T++,q.attached)continue;v||this._addParentTile(y,o)}else h.has(y)?T++:a.has(y)||this._getTile(y,e),v||this._addParentTile(y,o)}var m=T===g.length;!this._isStationary&&e.stationary&&this.requestUpdate(),this._isStationary=e.stationary;var R=[],F=[];s.forEach(function(e,i){u.set(i),o.has(i)||(!v&&m||!t.tileInfoView.intersects(c,u)?(u.level>p||!t.tileInfoView.intersects(c,u))&&R.push(i):F.push(i))});for(var V=0,b=F;V<b.length;V++){var M=b[V];o.set(M,s.get(M))}for(var C=0,P=R;C<P.length;C++){var M=P[C];if(f.has(M)){var U=f.get(M);U.cancel(M),r(f,M)}var q=s.get(M);q.dispose(),r(s,M)}this.container.removeAllTiles(),o.forEach(function(e){return t.container.addTile(e)}),a.forEach(function(e,i){u.set(i),(u.level>p||!t.tileInfoView.intersects(c,u))&&(e.cancel(),l.push(i))});for(var E=0,L=l;E<L.length;E++){var y=L[E];r(a,y)}l.length=0}},e.prototype.updateTiles=function(e,t){var i=this;this._tilesToRender.forEach(function(s,n){if(s.attached){var o=e(s,t);if(o){if(i._updates.has(n)){var a=i._updates.get(n);a.cancel(),r(i._updates,n)}o.then(function(e){r(i._updates,n),i._tilesToRender.has(n)&&i._tilesToRender.set(n,e),i.requestUpdate()}).otherwise(function(e){if(r(i._updates,n),i.requestUpdate(),e&&"cancel"!==e.dojoType)throw e}),i._updates.set(n,o)}}})},e.prototype._addParentTile=function(e,t){this._getAvailableParentTile(a,e),a[0]&&!t.has(a[0])&&t.set(a[0],a[1])},e.prototype._getTile=function(e,t){var i=this,s=this.fetchTile(e,t).then(function(t){u.set(e),i.tileInfoView.getTileTopLeft(t.topLeft,u),i.tileInfoView.getTileBottomRight(t.bottomRight,u),t.resolution=i.tileInfoView.getTileResolution(u),i._tiles.set(e,t),r(i._requests,e),i.requestUpdate()}).otherwise(function(t){t&&"no data"===t.message&&h.insert(e,e),r(i._requests,e)});this._requests.set(e,s)},e.prototype._getAvailableParentTile=function(e,t){e[0]=null,e[1]=null;for(var i=t;i=this.tileInfoView.getTileParentId(i);)if(this._tiles.has(i)){e[0]=i,e[1]=this._tiles.get(i);break}return e},e.prototype._createCoverageList=function(e,t){e.length=0,o.length=0;var i=t.spans;if(0!==i.length){var s=0,r=0,n=1/0,a=-(1/0);s=i[0].row,r=i[i.length-1].row;for(var l=0,h=i;l<h.length;l++)for(var f=h[l],c=f.colFrom,d=f.colTo,p=c;d>=p;p++)n=Math.min(n,p),a=Math.max(a,p);var _=t.lodInfo,v=_.level,g=s+Math.floor(.5*(r-s)),T=n+Math.floor(.5*(a-n)),w=g-s;w>=0&&w<i.length&&(u.set(v,g,_.normalizeCol(T),_.getWorldForColumn(T)),o.push({dist:0,id:u.id}));for(var I,y=0,q=i;y<q.length;y++)for(var m=q[y],R=m.row,c=m.colFrom,d=m.colTo,p=c;d>=p;p++)I=Math.abs(p-T)+Math.abs(R-g),0!==I&&(u.set(v,R,_.normalizeCol(p),_.getWorldForColumn(p)),o.push({dist:I,id:u.id}));o.sort(function(e,t){return e.dist-t.dist});for(var F=0,V=o;F<V.length;F++){var b=V[F];e.push(b.id)}}},e}();return f});