// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define(["require","exports","../../../../core/LRUCache","../../layers/support/TileKey"],function(e,t,i,s){function r(e,t){e["delete"](t)}var n=[],l=[],o=[null,null],a=[],h=function(){function e(e,t,s,r){this.container=e,this.tileInfoView=t,this.requestUpdate=s,this.fetchTile=r,this._tilesToRender=new Map,this._requests=new Map,this._updates=new Map,this._loadedTiles=new Map,this._newTilesToRender=new Map,this._lru=new i(30),this._prevResolution=Number.POSITIVE_INFINITY,this._isStationary=!1}return e.prototype.destroy=function(){this._requests&&(this._requests.forEach(function(e){e.isFulfilled()||e.cancel()}),this._requests=null,this._tilesToRender=null,this._loadedTiles=null)},e.prototype.update=function(t){var i=this,l=this.tileInfoView.getTileCoverage(t.state);if(l){var o=l.lodInfo,h=o.level,d=t.state.resolution;if(t.budget.remaining<1.5)return this.requestUpdate(),void(this._prevResolution=d);var u=d>this._prevResolution;this._prevResolution=d,e._createCoverageList(n,l);for(var _,f=0,T=n,c=0,v=T;c<v.length;c++){var p=v[c];if(this._tilesToRender.has(p)){if(_=this._tilesToRender.get(p),_.visible=!0,this._newTilesToRender.set(p,_),f++,_.attached)continue;u||this._addParentTile(p,this._newTilesToRender)}else if(this._loadedTiles.has(p))this._newTilesToRender.set(p,this._loadedTiles.get(p)),f++,r(this._loadedTiles,p),u||this._addParentTile(p,this._newTilesToRender);else{if(this._lru.has(p)){_=this._lru.use(p),_.visible=!0,this._newTilesToRender.set(p,_),f++,_.attached||u||this._addParentTile(p,this._newTilesToRender);continue}var g=this._requests.get(p);g?(g.isCanceled()||g.isRejected())&&(r(this._requests,p),this._getTile(p,t)):this._getTile(p,t),u||this._addParentTile(p,this._newTilesToRender)}}!this._isStationary&&t.stationary&&this.requestUpdate(),this._isStationary=t.stationary;var w,R=f===n.length,q=this._tilesToRender;q.forEach(function(e,t){if(w=s.from(t),!i._newTilesToRender.has(t))if(0===w.level||w.level<h&&i.tileInfoView.intersects(l,w))e.visible=!1,i._newTilesToRender.set(t,e);else if(!u&&R||!i.tileInfoView.intersects(l,w)){if(i._updates.has(t)){var n=i._updates.get(t);n.cancel(t),r(i._updates,t)}e.visible=!0,i._lru.insert(t,e)}else e.visible=!0,i._newTilesToRender.set(t,e)}),q.clear(),this._tilesToRender=this._newTilesToRender,this._newTilesToRender=q,this.container.removeAllChildren(),this._tilesToRender.forEach(function(e){return i.container.addChild(e)},this),this._loadedTiles.forEach(function(e){return e.dispose()}),this._loadedTiles.clear(),this._requests.forEach(function(e,r){return t.budget.done?void i.requestUpdate():void(e.isFulfilled()?a.push(r):(w=s.from(r),(w.level>h||!i.tileInfoView.intersects(l,w))&&(e.cancel(),a.push(r))))});for(var I=0,b=a;I<b.length;I++){var p=b[I];r(this._requests,p)}a.length=0}},e.prototype.updateTiles=function(e,t){var i=this;this._tilesToRender.forEach(function(s,n){if(s.visible&&s.attached){var l=e(s,t);if(l){if(i._updates.has(n)){var o=i._updates.get(n);o.cancel(),r(i._updates,n)}l.then(function(e){r(i._updates,n),i._tilesToRender.set(n,e)}),i._updates.set(n,l)}}})},e.prototype._addParentTile=function(e,t){this._getAvailableParentTile(o,e),o[0]&&!t.has(o[0])&&(o[1].visible=!0,t.set(o[0],o[1]))},e.prototype._getTile=function(e,t){var i=this;if(!this._requests.has(e)){var n=this.fetchTile(e,t);n.then(function(t){var n=s.fromId(e);i.tileInfoView.getTileTopLeft(t.topLeft,n),i.tileInfoView.getTileBottomRight(t.bottomRight,n),t.resolution=i.tileInfoView.getTileResolution(n),i._loadedTiles.set(e,t),r(i._requests,e),i.requestUpdate()}).otherwise(function(t){r(i._requests,e)}),this._requests.set(e,n)}},e.prototype._getAvailableParentTile=function(e,t){e[0]=null,e[1]=null;for(var i=t;i=this.tileInfoView.getTileParentId(i);){if(this._tilesToRender.has(i)){e[0]=i,e[1]=this._tilesToRender.get(i);break}if(this._lru.has(i)){var s=this._lru.use(i);if(s.attached){e[0]=i,e[1]=s;break}}}return e},e._createCoverageList=function(e,t){e.length=0,l.length=0;var i=t.spans;if(0!==i.length){var r=0,n=0,o=1/0,a=-(1/0);r=i[0].row,n=i[i.length-1].row;for(var h=0,d=i;h<d.length;h++)for(var u=d[h],_=u.colFrom,f=u.colTo;f>=_;_++)o=Math.min(o,_),a=Math.max(a,_);var T,c=t.lodInfo,v=c.level,p=r+Math.floor((n-r)/2),g=o+Math.floor((a-o)/2),w=p-r;w>=0&&w<i.length&&(T=s.from(v,p,c.normalizeCol(g),c.getWorldForColumn(g)),l.push({dist:0,id:T.id}));for(var R,q,I=0,b=i;I<b.length;I++){var u=b[I];q=u.row;for(var _=u.colFrom,f=u.colTo;f>=_;_++)R=Math.abs(_-g)+Math.abs(q-p),0!==R&&(T.row=q,T.col=c.normalizeCol(_),T.world=c.getWorldForColumn(_),l.push({dist:R,id:T.id}))}l.sort(function(e,t){return e.dist-t.dist});for(var m=0,y=l;m<y.length;m++){var C=y[m];e.push(C.id)}}},e}();return h});