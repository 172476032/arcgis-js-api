// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["require","exports","./LODInfo","./TileKey","./TileSpan","./TileCoverage"],function(o,t,e,r,n,i){var l=function(){function o(o,t,e,r,n,i,l,a){this.x=o,this.ymin=t,this.ymax=e,this.invM=r,this.leftAdjust=n,this.rightAdjust=i,this.leftBound=l,this.rightBound=a}return o.create=function(t,e){t[1]>e[1]&&(c=[e,t],t=c[0],e=c[1]);var r=t[0],n=t[1],i=e[0],l=e[1],a=i-r,s=l-n,u=0!==s?a/s:0,f=(Math.ceil(n)-n)*u,h=(Math.floor(n)-n)*u;return new o(r,Math.floor(n),Math.ceil(l),u,0>a?f:h,0>a?h:f,0>a?i:r,0>a?r:i);var c},o.prototype.incrRow=function(){this.x+=this.invM},o.prototype.getLeftCol=function(){return Math.max(this.x+this.leftAdjust,this.leftBound)},o.prototype.getRightCol=function(){return Math.min(this.x+this.rightAdjust,this.rightBound)},o}(),a=[[0,0],[0,0],[0,0],[0,0]],s=function(){function o(o,t){var r=this;this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};var n=o.lods.slice();n.sort(function(o,t){return t.scale-o.scale});var i=this._lodInfos=n.map(function(r){return e.create(o,r,t)});n.forEach(function(o,t){r._infoByLevel[o.level]=i[t],r._infoByScale[o.scale]=i[t],r.scales[t]=o.scale},this),this._wrap=o.spatialReference.isWrappable}return o.prototype.getTileTopLeft=function(o,t){var e=this._infoByLevel[t.level];return e?e.getTileTopLeft(o,t):o},o.prototype.getTileBottomRight=function(o,t){var e=this._infoByLevel[t.level];return e?e.getTileBottomRight(o,t):o},o.prototype.getTileResolution=function(o){var t=this._infoByLevel[o.level];return t?t.resolution:-1},o.prototype.getTileParentId=function(o){var t=r.pool.acquire(o),e=this._infoByLevel[t.level],n=this._lodInfos.indexOf(e)-1;if(0>n)return r.pool.release(t),null;var i=this._lodInfos[n],l=this.getTileIdAtParent(i,t);return r.pool.release(t),l},o.prototype.getTileIdAtParent=function(o,t){var e=r.pool.acquire(t),n=this._infoByLevel[e.level];if(o.resolution<n.resolution)throw new Error("Cannot calculate parent tile. destination LOD's resolution "+o.resolution+" is not a parent resolution of "+n.resolution);if(o.resolution===n.resolution)return e.id;var i=Math.floor(e.col*n.resolution/o.resolution+.01),l=Math.floor(e.row*n.resolution/o.resolution+.01);return r.getId(o.level,l,i,e.world)},o.prototype.getTileCoverage=function(o){var t,e,r,s=this.getClosestInfoForScale(o.scale),u=i.pool.acquire(s),f=this._wrap,h=+(1/0),c=-(1/0),p=u.spans;a[0][0]=a[0][1]=a[1][1]=a[3][0]=0,a[1][0]=a[2][0]=o.size[0],a[2][1]=a[3][1]=o.size[1];for(var v=0,g=a;v<g.length;v++){var m=g[v];o.toMap(m,m),m[0]=s.getColumnForX(m[0]),m[1]=s.getRowForY(m[1])}for(var d=[],y=3,w=0;4>w;w++)if(a[w][1]!==a[y][1]){var M=l.create(a[w],a[y]);h=Math.min(M.ymin,h),c=Math.max(M.ymax,c),void 0===d[M.ymin]&&(d[M.ymin]=[]),d[M.ymin].push(M),y=w}else y=w;if(null==h||null==c||c-h>100)return null;var B=[];for(t=h;c>t;){null!=d[t]&&(B=B.concat(d[t])),e=+(1/0),r=-(1/0);for(var w=B.length-1;w>=0;w--){var M=B[w];e=Math.min(e,M.getLeftCol()),r=Math.max(r,M.getRightCol())}if(e=Math.floor(e),r=Math.floor(r),t>=s.first[1]&&t<=s.last[1])if(f)if(s.size[0]<s.worldSize[0])for(var C=Math.floor(r/s.worldSize[0]),w=Math.floor(e/s.worldSize[0]);C>=w;w++)p.push(new n(t,Math.max(s.getFirstColumnForWorld(w),e),Math.min(s.getLastColumnForWorld(w),r)));else p.push(new n(t,e,r));else e>s.last[0]||r<s.first[0]||(e=Math.max(e,s.first[0]),r=Math.min(r,s.last[0]),p.push(new n(t,e,r)));t+=1;for(var w=B.length-1;w>=0;w--){var M=B[w];M.ymax>=t?M.incrRow():B.splice(w,1)}}return u},o.prototype.intersects=function(o,t){var e=r.pool.acquire(t),n=this._infoByLevel[e.level],i=o.lodInfo;if(i.resolution>n.resolution){var l=r.pool.acquire(this.getTileIdAtParent(i,e)),a=i.denormalizeCol(l.col,l.world),s=o.spans.some(function(o){return o.row===l.row&&o.colFrom<=a&&o.colTo>=a});return r.pool.release(e),r.pool.release(l),s}if(i.resolution<n.resolution){var u=o.spans.reduce(function(o,t){return o[0]=Math.min(o[0],t.row),o[1]=Math.max(o[1],t.row),o[2]=Math.min(o[2],t.colFrom),o[3]=Math.max(o[3],t.colTo),o},[+(1/0),-(1/0),+(1/0),-(1/0)]),f=u[0],h=u[1],c=u[2],p=u[3],v=n.denormalizeCol(e.col,e.world),g=i.getColumnForX(n.getXForColumn(v)),m=i.getRowForY(n.getYForRow(e.row)),d=i.getColumnForX(n.getXForColumn(v+1))-1,y=i.getRowForY(n.getYForRow(e.row+1))-1;return r.pool.release(e),!(g>p||c>d||m>h||f>y)}var w=i.denormalizeCol(e.col,e.world),M=o.spans.some(function(o){return o.row===e.row&&o.colFrom<=w&&o.colTo>=w});return r.pool.release(e),M},o.prototype.getClosestInfoForScale=function(o){var t=this.scales;return this._infoByScale[o]?this._infoByScale[o]:(o=t.reduce(function(t,e,r,n){return Math.abs(e-o)<Math.abs(t-o)?e:t},t[0]),this._infoByScale[o])},o}();return s});