// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../libs/gl-matrix/common","../libs/gl-matrix/vec2","../libs/gl-matrix/mat2d","./webgl/BitBlitRenderer","../../support/screenshotUtils","../../../core/promiseUtils","../../webgl/RenderingContext","../../webgl/FramebufferObject","../../webgl/webgl-utils","../../webgl/Program","../../webgl/VertexArrayObject","../../webgl/BufferObject","./webgl/painter/WGLPainter","./Container","./webgl/shaders/glShaderSnippets"],function(e,t,i,r,a,n,h,s,o,d,l,c,p,g,_,u,f,m){function v(e){return{budget:e.budget,state:e.state,devicePixelRatio:e.devicePixelRatio,stationary:e.stationary}}var w={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},b=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._clipData=new Float32Array(8),t._upperLeft=a.create(),t._upperRight=a.create(),t._lowerLeft=a.create(),t._lowerRight=a.create(),t._mat2=n.create(),t._clipRendererInitialized=!1,t}return i(t,e),Object.defineProperty(t.prototype,"glPainter",{get:function(){return this._painter},enumerable:!0,configurable:!0}),t.prototype.createElement=function(){var e=document.createElement("canvas");return e.setAttribute("class","esri-display-object"),e},t.prototype.setElement=function(e){this.element=e},t.prototype.attach=function(t){if(this.attached)return!0;this._resizeCanvas(t);var i={alpha:!0,antialias:!1,depth:!0,stencil:!0},r=c.setupWebGL(this.element,i);return this._renderingContext=new d(r[0]),this.attached=!0,this._cachedRenderParams=v(t),this._painter||(this._painter=new u,this._painter.initialize(this._renderingContext)),e.prototype.attach.call(this,t)},t.prototype.detach=function(t){e.prototype.detach.call(this,t),this._renderingContext&&(this._renderingContext.dispose(),this._renderingContext=null),this._cachedRenderParams=null},t.prototype.beforeRenderChildren=function(e,t){var i=e.state,h=this._painter;if(h){var s=this._renderingContext;s.enforceState(),h.update(i,e.devicePixelRatio);var o=i.spatialReference&&(i.spatialReference._isWrappable?i.spatialReference._isWrappable():i.spatialReference.isWrappable);if(!o)return void(this._clipFrame=!1);var d=i.width,c=i.height,p=i.rotation;d=Math.round(d*e.devicePixelRatio),c=Math.round(c*e.devicePixelRatio);var g=r.toRadian(p),_=Math.abs(Math.cos(g)),u=Math.abs(Math.sin(g)),f=Math.round(d*_+c*u),m=Math.round(i.worldScreenWidth);if(m>=f)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===d&&this._clipFBO.height===c||(this._clipFBO=new l(s,{colorTarget:0,depthStencilTarget:3,width:d,height:c}));var v=.5*d,w=.5*c,b=1/d,R=1/c,C=d*u+c*_,x=.5*m*e.devicePixelRatio,y=.5*C,F=this._upperLeft,B=this._upperRight,M=this._lowerLeft,E=this._lowerRight;a.set(F,-x,-y),a.set(B,x,-y),a.set(M,-x,y),a.set(E,x,y),n.identity(this._mat2),n.translate(this._mat2,this._mat2,[v,w]),0!==p&&n.rotate(this._mat2,this._mat2,g),a.transformMat2d(F,F,this._mat2),a.transformMat2d(B,B,this._mat2),a.transformMat2d(M,M,this._mat2),a.transformMat2d(E,E,this._mat2);var P=this._clipData;P.set([2*M[0]*b-1,2*(c-M[1])*R-1,2*E[0]*b-1,2*(c-E[1])*R-1,2*F[0]*b-1,2*(c-F[1])*R-1,2*B[0]*b-1,2*(c-B[1])*R-1]),this._clipRendererInitialized||this._initializeClipRenderer(s),this._clipVBO.setData(P),this._boundFBO=s.getBoundFramebufferObject(),s.bindFramebuffer(this._clipFBO),s.setDepthWriteEnabled(!0),s.setStencilWriteMask(255),s.setClearColor(0,0,0,0),s.setClearDepth(1),s.setClearStencil(0),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT|s.gl.STENCIL_BUFFER_BIT),s.setDepthWriteEnabled(!1),this._clipFrame=!0}},t.prototype.afterRenderChildren=function(e,t){if(this._clipFrame&&this._clipRendererInitialized){var i=this._renderingContext;i.bindFramebuffer(this._boundFBO),this._boundFBO=null,i.bindVAO(this._clipVAO),i.bindProgram(this._clipStencilProgram),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setStencilTestEnabled(!0),i.setBlendingEnabled(!1),i.setColorMask(!1,!1,!1,!1),i.setStencilOp(7680,7680,7681),i.setStencilWriteMask(255),i.setStencilFunction(519,1,255),i.drawElements(4,6,5123,0),i.bindVAO(),i.setColorMask(!0,!0,!0,!0),i.setBlendingEnabled(!0),i.setStencilFunction(514,1,255),this._blitRenderer.render(i,this._clipFBO.colorTexture,9728,1),i.setStencilTestEnabled(!1)}},t.prototype.doRender=function(t){var i=this.element.style;return this.visible?(i.display="block",i.opacity=""+this.opacity,this._resizeCanvas(t),e.prototype.doRender.call(this,t),void(this._cachedRenderParams=v(t))):void(i.display="none")},t.prototype.takeScreenshot=function(e){void 0===e&&(e={});var t=e.pixelRatio||1;this._cachedRenderParams.devicePixelRatio=t;var i=Math.round(t*this._cachedRenderParams.state.width),r=Math.round(t*this._cachedRenderParams.state.height),a={x:0,y:0,width:i,height:r},n={x:0,y:0,width:i,height:r},h=e.area;if(h&&(a.x=Math.round(t*h.x),a.y=Math.round(t*h.y),a.width=Math.round(t*h.width),a.height=Math.round(t*h.height)),void 0!==e.width&&void 0!==e.height){var d=e.width/e.height;if(a.height*d<a.width){var c=a.height*d;a.x+=Math.floor((a.width-c)/2),a.width=Math.floor(c)}else{var p=a.width/d;a.y+=Math.floor((a.height-p)/2),a.height=Math.floor(p)}n.width=e.width,n.height=e.height}else n.width=a.width,n.height=a.height;var g=document.createElement("canvas");g.width=n.width,g.height=n.height;var _=g.getContext("2d"),u=new Uint8Array(a.width*a.height*4),f=this._renderingContext,m=l.create(f,{colorTarget:1,depthStencilTarget:3,width:i,height:r});f.bindFramebuffer(m),f.setViewport(0,0,i,r),this._cachedRenderParams.budget&&this._cachedRenderParams.budget.reset(Number.MAX_VALUE);var v=this._cachedRenderParams,b=this._renderingContext.gl;if(this._renderingContext.setClearColor(0,0,0,0),this._renderingContext.setClearDepth(1),this._renderingContext.setClearStencil(0),this._renderingContext.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT|b.STENCIL_BUFFER_BIT),v.context=this._renderingContext,this.beforeRenderChildren(v,v),void 0!==e.rotation&&null!==e.rotation){var R=v.state,C=R.clone();C.viewpoint.rotation=e.rotation,v.state=C,this.renderChildren(v),v.state=R}else this.renderChildren(v);this.afterRenderChildren(v,v),m.readPixels(a.x,r-(a.y+a.height),a.width,a.height,6408,5121,u),f.bindFramebuffer();var x=_.getImageData(n.x,n.y,n.width,n.height);if(0!==a.x||0!==a.y||a.width!==i||a.height!==r||0!==n.x||0!==n.y||n.width!==i||n.height!==r)s.resampleHermite(u,a.width,a.height,x.data,n.width,n.height,!0);else{for(var y=a.height-1,F=0,B=4*a.width,M=void 0,E=void 0,P=void 0,O=void 0,S=void 0,T=void 0,I=void 0;y>F;){for(T=F*B,I=y*B,M=0;B>M;M+=4)E=u[T+M],P=u[T+M+1],O=u[T+M+2],S=u[T+M+3],u[T+M]=u[I+M],u[T+M+1]=u[I+M+1],u[T+M+2]=u[I+M+2],u[T+M+3]=u[I+M+3],u[I+M]=E,u[I+M+1]=P,u[I+M+2]=O,u[I+M+3]=S;F++,y--}for(var D=x.data,L=u.length,U=0;L>U;U++)D[U]=u[U]}for(var W=x.data,z=W.length,U=0;z>U;U+=4){var S=W[U+3];if(S>0){var V=S/255,E=Math.floor(W[U+0]/V),P=Math.floor(W[U+1]/V),O=Math.floor(W[U+2]/V);W[U+0]=255>=E?E:255,W[U+1]=255>=P?P:255,W[U+2]=255>=O?O:255}}_.putImageData(x,n.x,n.y);var A=w[e.format?e.format.toLowerCase():"png"],j=1;void 0!==e.quality&&(j=e.quality/100);var k=g.toDataURL(A,j);return o.resolve({dataURL:k,x:n.x,y:n.y,width:n.width,height:n.height})},t.prototype.prepareChildrenRenderParameters=function(e){if(!this.attached||!this._renderingContext)return null;var t=v(e),i=this._renderingContext,r=i.gl;return i.setDepthWriteEnabled(!0),i.setStencilWriteMask(255),i.setClearColor(0,0,0,0),i.setClearDepth(1),i.setClearStencil(0),i.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT),i.setViewport(0,0,this.element.width,this.element.height),i.setDepthWriteEnabled(!1),t.context=i,t},t.prototype.attachChild=function(e,t){return e.attach(t)},t.prototype.detachChild=function(e,t){return e.detach(t)},t.prototype.renderChild=function(e,t){return e.processRender(t)},t.prototype._resizeCanvas=function(e){var t=this.element,i=t.style,r=e.state,a=e.devicePixelRatio,n=Math.round(r.width*a),h=Math.round(r.height*a);(t.width!==n||t.height!==h)&&(t.width=n,t.height=h),i.width=r.width+"px",i.height=r.height+"px"},t.prototype._initializeClipRenderer=function(e){if(this._clipRendererInitialized)return!0;this._blitRenderer=new h;var t={a_pos:0},i=new p(e,m.stencilVS,m.stencilFS,t);if(!i)return!1;var r=_.createVertex(e,35040,32),a=new Uint16Array([0,1,2,2,1,3]),n=_.createIndex(e,35044,a),s={geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},o=new g(e,t,s,{geometry:r},n);return this._clipStencilProgram=i,this._clipVBO=r,this._clipVAO=o,this._clipRendererInitialized=!0,!0},t}(f);return b});