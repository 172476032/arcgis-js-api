// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","exports","dojo/has","../../../../core/screenUtils","../../../../core/libs/earcut/earcut","../../../../core/libs/libtess/libtess","./color","./enums","./lineMeshUtil","./MeshData","./number","./TileClipper","./Utils","./visualVariablesUtils"],function(e,t,i,n,r,s,o,l,a,u,h,c,p,g){function d(e,t,i,r,s,l,a){var c,d,v,y,f,_,b,x,T,m=new u,I=0,S=0,E=t.heatmapInfo;if(E){var V=Math.round(t.heatmapInfo.radius);c=0,d=0,v=V,y=V,f=[1,1,1,1],_=[0,0,0,0],b=V,x=V,T=0}else{var w=r.spriteMosaicItem;c=Math.round(w.rect.x/4),d=Math.round(w.rect.y/4),v=c+Math.round(w.rect.width/4),y=d+Math.round(w.rect.height/4),I=0|l.xoffset,S=0|l.yoffset;var k=l.color?l.color:[0,0,0,0];f=p.isPictureSymbol(l)?[255,255,255,255]:o.copyAndPremultiply(k),b=Math.round(n.pt2px(l.width||l.size)),x=Math.round(n.pt2px(l.height||l.size)),l.outline?(_=null!=l.outline.color?o.copyAndPremultiply(l.outline.color):[0,0,0,0],T=null!=l.outline.width?Math.round(n.pt2px(l.outline.width)):0):(_=[0,0,0,0],T=0)}var C=[],G=h.i8888to32(f[0],f[1],f[2],f[3]),U=h.i8888to32(_[0],_[1],_[2],_[3]),M=h.i8888to32(b,x,T,0),N=h.numTo32(e),P=0,L=0,R=0,z=0,O=0,A=i.vvColor||i.vvOpacity||i.vvRotation||i.vvSizeMinMaxValue||i.vvSizeScaleStops||i.vvSizeFieldStops||i.vvSizeUnitValue;if(A){var D=t.vvFields,F=D.rotation?t.getValue(s,D.rotation):0,W=D.opacity?t.getValue(s,D.opacity):0,B=D.color?t.getValue(s,D.color):0,H=D.size&&!i.vvSizeScaleStops?t.getValue(s,D.size):0;i.vvSizeUnitValue&&(H=g.getVisualVariableSizeValueRepresentationRatio(H,t.vvRanges.size.unitValue.valueRepresentation)),isNaN(H)&&(H=1),isNaN(F)&&(F=1),isNaN(W)&&(W=1),isNaN(B)&&(B=1),P=h.toUint32(H),L=h.toUint32(W),R=h.toUint32(F),z=h.toUint32(B)}var j=[P,z,L,R];E&&(O=h.toUint32(t.heatmapInfo.getIntensity(s)));var q,K=s.centroid||s.geometry;switch(a){case"esriGeometryPoint":q=[[K.x,K.y]];break;case"esriGeometryMultipoint":q=K.points;break;case"esriGeometryPolyline":q=K.paths[0];break;case"esriGeometryPolygon":q=s.centroid?[[K.x,K.y]]:K.rings[0]}for(var X,J=0,Q=0,Y=0,Z=new Array(4*q.length),$=0;$<q.length;$++){var ee=q[$],te=ee[0],ie=ee[1],ne=h.i1616to32(te+Q+I,ie+Y+S);Q+=te,Y+=ie,C.push(ne),C.push(h.i8888to32(-32,-32,c,d)),C.push(N),C.push(G),C.push(U),C.push(M),A?C.push.apply(C,j):E&&C.push(O),C.push(ne),C.push(h.i8888to32(32,-32,v,d)),C.push(N),C.push(G),C.push(U),C.push(M),A?C.push.apply(C,j):E&&C.push(O),C.push(ne),C.push(h.i8888to32(-32,32,c,y)),C.push(N),C.push(G),C.push(U),C.push(M),A?C.push.apply(C,j):E&&C.push(O),C.push(ne),C.push(h.i8888to32(32,32,v,y)),C.push(N),C.push(G),C.push(U),C.push(M),A?C.push.apply(C,j):E&&C.push(O),X=6*$,Z[X+0]=J+0,Z[X+1]=J+1,Z[X+2]=J+2,Z[X+3]=J+1,Z[X+4]=J+3,Z[X+5]=J+2,J+=4}return m.update({geometry:C},J,Z),m}function v(e,t,i,n,r,s){var l,a=null!=n?n.spriteMosaicItem:null,g=r.geometry,d=p.isPictureSymbol(s);l=d?o.premultiplyAlphaUint32(o.white):s.color?o.premultiplyAlphaUint32(s.color):0;var v=i.vvColor||i.vvOpacity,y=new u,f=0,S=0,E=0,w=0;if(a){var k=a.rect,C=k.x,G=k.y,U=a.width,M=a.height;f=C+1,S=G+1,E=C+1+U,w=G+1+M}var N=d&&s.width&&s.height?h.i8888to32(h.nextHighestPowerOfTwo(s.width),h.nextHighestPowerOfTwo(s.height),0,0):h.i8888to32(h.nextHighestPowerOfTwo(E-f),h.nextHighestPowerOfTwo(w-S),0,0),P=[h.numTo32(e),l,h.i1616to32(f,S),h.i1616to32(E,w),N];if(v){var L=t.vvFields,R=L.opacity?t.getValue(r,L.opacity):0,z=L.color?t.getValue(r,L.color):0;isNaN(R)&&(R=1),isNaN(z)&&(z=1),P.push(h.toUint32(z),h.toUint32(R))}for(var O=!1,A=0,D=g.rings;A<D.length;A++){var F=D[A],W=F.length;if(!(W<3)){var B=F[0][0],H=F[0][1];if(B<-8||B>520||H<-8||H>520){O=!0;break}for(var j=1;j<W;++j)if(B+=F[j][0],H+=F[j][1],B<-8||B>520||H<-8||H>520){O=!0;break}if(O)break}}var q,K,X;if(O){b||(b=new c.TileClipper(0,0,0,1,8),b.setExtent(512)),b.reset(3);for(var J=0,Q=g.rings;J<Q.length;J++){var F=Q[J],W=F.length;if(!(W<3)){K=F[0][0],X=F[0][1],b.moveTo(K,X);for(var j=1;j<W;++j)K+=F[j][0],X+=F[j][1],b.lineTo(K,X);b.close()}}if(q={rings:b.result(!V)},!q.rings||0===q.rings.length)return null}else q=g;var Y,Z,$=[],ee=[];if(V){x||(x=new I),x.beginPolygon(T,ee);for(var te=0,ie=q.rings;te<ie.length;te++){var F=ie[te];if(!(F.length<3)){x.beginContour(),Y=Z=0,O?(K=F[0].x,X=F[0].y):(de=F[0],K=de[0],X=de[1]);var ne=[K,X,0];x.addVertex(ne,ne);for(var j=1;j<F.length-1;j++){O?(K=F[j].x,X=F[j].y):(ve=F[j],Y=ve[0],Z=ve[1],K+=Y,X+=Z);var re=[K,X,0];x.addVertex(re,re)}x.endContour()}}x.endPolygon();for(var se=0;se<T.length;se+=2)$.push(h.i1616to32(T[se],T[se+1])),$.push.apply($,P)}else{for(var oe=0,le=0,ae=void 0,ue=void 0,he=0,ce=q.rings;he<ce.length;he++){var F=ce[he],pe=le;O?(K=F[0].x,X=F[0].y):(ye=F[0],K=ye[0],X=ye[1]),T[le++]=K,T[le++]=X;var ge=0;Y=Z=0;for(var j=1;j<F.length;++j)O?(ae=F[j].x,ue=F[j].y,Y=ae-K,Z=ue-X,ge-=Y*(X+X+Z),K=ae,X=ue):(fe=F[j],Y=fe[0],Z=fe[1],ge-=Y*(X+X+Z),K+=Y,X+=Z),T[le++]=K,T[le++]=X;ge>0?(pe-oe>0&&(_($,ee,T,oe,pe,m,P),oe=pe),m.length=0):ge<0&&pe-oe>0?m.push(.5*(pe-oe)):le=pe}le-oe>0&&_($,ee,T,oe,le,m,P)}return T.length=m.length=0,y.update({geometry:$},$.length/(P.length+1),ee),y;var de,ve,ye,fe}function y(e,t,i,n,r,s,o){return null}function f(e,t,i,n,r,s,o,u,h){switch(r){case l.WGLGeometryType.MARKER:return d(e,t,i,n,u,h,s);case l.WGLGeometryType.FILL:return v(e,t,i,n,u,h);case l.WGLGeometryType.LINE:return a.createLineMeshData(e,t,i,n,o,u,h)}return null}function _(e,t,i,n,s,o,l){var a=i.slice(n,s),u=e.length/(l.length+1),c=r(a,o,2),p=c.length;if(p<=0)return 0;for(var g=0;g<a.length;)e.push(h.i1616to32(a[g++],a[g++])),e.push.apply(e,l);for(var d=0;d<p;)t.push(c[d++]+u,c[d++]+u,c[d++]+u)}Object.defineProperty(t,"__esModule",{value:!0});var b,x,T=[],m=[],I=function(){function e(){this._currentVertexIndex=0,this._indexCounter=0,this._triangleIndices=[-1,-1,-1],this.glu=new s.GluTesselator,this.glu.gluTessCallback(s.gluEnum.GLU_TESS_BEGIN,this._begincallback.bind(this)),this.glu.gluTessCallback(s.gluEnum.GLU_TESS_VERTEX_DATA,this._vertexCallback.bind(this)),this.glu.gluTessCallback(s.gluEnum.GLU_TESS_END,this._endcallback.bind(this)),this.glu.gluTessCallback(s.gluEnum.GLU_TESS_COMBINE,this._combinecallback.bind(this)),this.glu.gluTessCallback(s.gluEnum.GLU_TESS_ERROR,this._errorcallback.bind(this)),this.glu.gluTessCallback(s.gluEnum.GLU_TESS_EDGE_FLAG,this._edgeCallback.bind(this)),this.glu.gluTessProperty(s.gluEnum.GLU_TESS_WINDING_RULE,s.windingRule.GLU_TESS_WINDING_ODD)}return e.prototype.beginPolygon=function(e,t){this._triangleIndices[0]=-1,this._triangleIndices[1]=-1,this._triangleIndices[2]=-1,this._currentVertexIndex=0,this._indexCounter=0,this.glu.gluTessBeginPolygon(e),this._indices=t},e.prototype.endPolygon=function(){this.glu.gluTessEndPolygon()},e.prototype.beginContour=function(){this.glu.gluTessBeginContour()},e.prototype.endContour=function(){this.glu.gluTessEndContour()},e.prototype.addVertex=function(e,t){this.glu.gluTessVertex(e,t)},e.prototype._vertexCallback=function(e,t){if(t[t.length]=e[0],t[t.length]=e[1],this._triangleIndices[this._currentVertexIndex]=-1,this._currentVertexIndex>=2){for(var i=0;i<3;i++)-1===this._triangleIndices[i]&&(this._triangleIndices[i]=this._indexCounter++),this._indices[this._indices.length]=this._triangleIndices[i];this._currentVertexIndex=0}else this._currentVertexIndex++},e.prototype._begincallback=function(e){this._triangleIndices[0]=-1,this._triangleIndices[1]=-1,this._triangleIndices[2]=-1,this._currentVertexIndex=0},e.prototype._endcallback=function(){this._currentVertexIndex=0},e.prototype._errorcallback=function(e){},e.prototype._combinecallback=function(e,t,i){return[e[0],e[1],e[2]]},e.prototype._edgeCallback=function(e){},e}(),S=i("esri-featurelayer-webgl"),E=S&&S.tesselator||"libtess",V="libtess"===E;t.createTextMesh=y,t.createMesh=f});