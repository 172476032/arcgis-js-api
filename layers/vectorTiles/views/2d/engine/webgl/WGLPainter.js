// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/assignHelper","dojo/has","../../../../core/libs/gl-matrix/mat4","./enums","./GeometryUtils","./MaterialManager","./Utils","./brushes/WGLBrushInfo","./brushes/WGLBrushStencil","./brushes/WGLGeometryBrushFill","./brushes/WGLGeometryBrushLine","./brushes/WGLGeometryBrushMarker","./brushes/WGLGeometryBrushText","./painter/WGLHighlightPainter","./../../../webgl/FramebufferObject"],function(t,e,i,s,r,a,n,h,o,u,d,_,l,c,p,f,g){Object.defineProperty(e,"__esModule",{value:!0});var w=function(){function t(){this._initialized=!1}return t.prototype.registerPass=function(t,e){this._initialize();for(var i=0,s=e;i<s.length;i++){var r=s[i];this._passMap.set(r,t)}return this},t.prototype.getPaintPassTs=function(t){return this._initialize(),this._passMap.has(t)?[this._passMap.get(t)]:[]},t.prototype._initialize=function(){this._initialized||(this._passMap=new Map,this._initialized=!0)},t}();e.WGLPainterOptions=w;var x=new Uint8Array(4*o.C_HITTEST_SEARCH_SIZE*o.C_HITTEST_SEARCH_SIZE),b=new Uint32Array(x.buffer),P=function(){function t(){this._hlPainter=new f,this._extrudeMatrix=new Float32Array(16),this._extrudeNoRotationMatrix=new Float32Array(16),this._extrudeRotateVector=new Float32Array([0,0,1]),this._extrudeScaleVector=new Float32Array([1,1,1]),this._state={rotation:0,width:0,height:0},this._cachedWidth=0,this._cachedHeight=0,this._cachedRotation=0,this.materialManager=new h}return t.allGeometryPhases=function(){return[a.WGLDrawPhase.FILL,a.WGLDrawPhase.LINE,a.WGLDrawPhase.MARKER,a.WGLDrawPhase.TEXT]},Object.defineProperty(t.prototype,"extrudeMatrix",{get:function(){return this._extrudeMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"extrudeNoRotationMatrix",{get:function(){return this._extrudeNoRotationMatrix},enumerable:!0,configurable:!0}),t.prototype.initialize=function(t){this.materialManager.initialize(t)},t.prototype.update=function(t,e){this._state=t,this._state.width===this._cachedWidth&&this._state.height===this._cachedHeight&&this._state.rotation===this._cachedRotation||(this._extrudeScaleVector[0]=2/t.width,this._extrudeScaleVector[1]=-2/t.height,r.identity(this._extrudeMatrix),r.rotate(this._extrudeMatrix,this._extrudeMatrix,-t.rotation*n.C_DEG_TO_RAD,this._extrudeRotateVector),r.scale(this._extrudeMatrix,this._extrudeMatrix,this._extrudeScaleVector),r.transpose(this._extrudeMatrix,this._extrudeMatrix),r.identity(this._extrudeNoRotationMatrix),r.scale(this._extrudeNoRotationMatrix,this._extrudeNoRotationMatrix,this._extrudeScaleVector),r.transpose(this._extrudeNoRotationMatrix,this._extrudeNoRotationMatrix),this._cachedWidth=this._state.width,this._cachedHeight=this._state.height,this._cachedRotation=this._state.rotation)},t.prototype.getBrushes=function(t){if(!this._brushes){var e=new _.default,i=new c.default,s=new l.default,r=new p.default,n=new u.default,h=new d.default;this._brushes=new Map,this._brushes.set(a.WGLDrawPhase.FILL,[e]),this._brushes.set(a.WGLDrawPhase.MARKER,[i]),this._brushes.set(a.WGLDrawPhase.LINE,[s]),this._brushes.set(a.WGLDrawPhase.TEXT,[r]),this._brushes.set(a.WGLDrawPhase.HITTEST,[e,i,s,r]),this._brushes.set(a.WGLDrawPhase.HIGHLIGHT,[e,i,s,r]),this._brushes.set(a.WGLDrawPhase.CLIP,[h]),this._brushes.set(a.WGLDrawPhase.DEBUG,[n])}if(!this._brushes.has(t))throw new Error("WGLPainter: Tried to get brush for unknown phase: "+t);return this._brushes.get(t)},t.prototype.bindTextureManager=function(t){this.textureManager=t},t.prototype.draw=function(t,e,i,s){this._drawClippingRects(t,e);var r=t.context;r.setBlendingEnabled(!0),r.setStencilWriteMask(0),r.setBlendFunctionSeparate(1,771,1,771),this._drawPhases(t,e,i,s),this._debugTiles(t,e)},t.prototype.setHighlightOptions=function(t){this._hlPainter.setHighlightOptions(t)},t.prototype.highlight=function(t,e){var i=t.context,s=i.getViewport();this._hlPainter.setup(i,s.width,s.height),this._hlPainter.startMaskDraw(i),this._drawClippingRects(t,e),i.setBlendingEnabled(!0),i.setStencilWriteMask(0),i.setBlendFunctionSeparate(1,771,1,771),this._drawPhases(t,e,[a.WGLDrawPhase.HIGHLIGHT]),this._hlPainter.draw(i)},t.prototype.hitTest=function(t,e){var i=o.C_HITTEST_SEARCH_SIZE,s=[0,0],r=[0,0],n=t.state;if(n.toMap(s,[0,0]),n.toMap(r,[i,i]),0===e.filter(function(t){return!(s[0]>t.bounds[2]||r[0]<t.bounds[0]||s[1]<t.bounds[1]||r[1]>t.bounds[3])}).length)return[];var h=t.context;this._hittestFBO||(this._hittestFBO=g.create(h,{colorTarget:0,depthStencilTarget:3,width:i,height:i}));var u=h.getViewport(),d=h.getBoundFramebufferObject();h.bindFramebuffer(this._hittestFBO),h.setViewport(0,0,i,i),this._drawClippingRects(t,e);var _=h.gl;h.setClearColor(1,1,1,1),h.clear(_.COLOR_BUFFER_BIT),h.setBlendingEnabled(!1),h.setStencilWriteMask(0),this._drawPhases(t,e,[a.WGLDrawPhase.HITTEST]),h.setBlendingEnabled(!0),this._hittestFBO.readPixels(0,0,i,i,6408,5121,x);for(var l=i*i,c=new Set,p=0;p<l;p++){var f=b[p];4294967295!==f&&c.add(f)}h.bindFramebuffer(d),h.setViewport(u.x,u.y,u.width,u.height);var w=[];return c.forEach(function(t){w.push(t)}),w},t.prototype._getPaintPass=function(t){if(this._passes||(this._passes=new Map),!this._passes.has(t))try{this._passes.set(t,new t)}catch(e){throw new Error("Tried to instantiate WGLPaintPass with unknown constructor: "+t+",\n"+e)}return this._passes.get(t)},t.prototype._getPaintPasses=function(t,e){var i=this;return e.getPaintPassTs(t).map(function(t){return i._getPaintPass(t)})},t.prototype._drawPhases=function(t,e,s,r){t.context.setStencilTestEnabled(!0);for(var a=0,n=s;a<n.length;a++){var h=n[a],o=r?this._getPaintPasses(h,r):[],u=i({},t,{drawPhase:h});o.forEach(function(e){return e.preRender(t,t.rendererInfo)});for(var d=0,_=e;d<_.length;d++){_[d].doRender(u)}o.reverse().forEach(function(e){return e.postRender(t,t.rendererInfo)})}t.context.setStencilTestEnabled(!1)},t.prototype._debugTiles=function(t,e){s("esri-feature-tiles-debug")&&this._drawPhases(t,e,[a.WGLDrawPhase.DEBUG])},t.prototype._drawClippingRects=function(t,e){if(0!==e.length){var i=t.context;i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setStencilTestEnabled(!0),i.setBlendingEnabled(!1),i.setColorMask(!1,!1,!1,!1),i.setStencilOp(7680,7680,7681),i.setClearStencil(0),i.clear(i.gl.STENCIL_BUFFER_BIT),i.setStencilWriteMask(255);for(var s=0,r=e.length;s<e.length;s++,r--){e[s].stencilRef=r}this._drawPhases(t,e,[a.WGLDrawPhase.CLIP]),t.context.setColorMask(!0,!0,!0,!0)}},t}();e.default=P});