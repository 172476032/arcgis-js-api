// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","exports","./color","./LineTess","./MeshData","./number","./TileClipper","./Utils","./visualVariablesUtils"],function(e,i,t,r,o,a,n,s,l){function v(e,i,n,v,c,d,y){var h=null!=v?v.spriteMosaicItem:null,b=d.geometry,m=s.isPictureSymbol(y),R=!m&&y.color?t.copyAndPremultiply(y.color):[255,255,255,1],A=a.numTo32(e),J=1/c,P=y.width>0?.5*(y.width+J):0,I=null!=h,U=n.vvColor||n.vvOpacity||n.vvSizeMinMaxValue||n.vvSizeScaleStops||n.vvSizeFieldStops||n.vvSizeUnitValue,_=0,D=0,F=0;if(U){var O=i.vvFields,q=O.opacity?i.getValue(d,O.opacity):0,L=O.color?i.getValue(d,O.color):0,k=O.size&&!n.vvSizeScaleStops?i.getValue(d,O.size):0;n.vvSizeUnitValue&&(k=l.getVisualVariableSizeValueRepresentationRatio(k,i.vvRanges.size.unitValue.valueRepresentation)),isNaN(k)&&(k=1),isNaN(q)&&(q=1),isNaN(L)&&(L=1),z[0]=k,F=V[0],z[0]=q,_=V[0],z[0]=L,D=V[0]}var j=a.i8888to32(R[0],R[1],R[2],R[3]),G=[0,0],W=[0,0];if(h){var Y=h.rect.x,B=h.rect.y,H=h.width,K=h.height;G[0]=Y+1,G[1]=B+1,W[0]=Y+1+H,W[1]=B+1+K}for(var Q=b.rings||b.paths,X=[],Z=Q.length,$=0,ee=!1;$<Z;){var ie=Q[$],te=[];N.reset(2);var re=ie[0][0],oe=ie[0][1];if(ee)N.moveTo(re,oe);else{if(re<-8||re>520||oe<-8||oe>520){ee=!0;continue}te.push({x:re,y:oe})}for(var ae=!1,ne=ie.length,se=1;se<ne;++se)if(re+=ie[se][0],oe+=ie[se][1],ee)N.lineTo(re,oe);else{if(re<-8||re>520||oe<-8||oe>520){ae=!0;break}te.push({x:re,y:oe})}if(ae)ee=!0;else{if(ee){var le=N.resultWithStarts();if(le)for(var ve=0,ue=le;ve<ue.length;ve++){var ce=ue[ve];X.push(ce)}}else X.push({line:te,start:0});$++,ee=!1}}for(var de=0,fe=[],pe=[],xe=0,ye=X;xe<ye.length;xe++){var he=ye[xe],te=he.line,be=he.start;if(!(te.length<2)){var me=te.length,ge=te[0],Se=te[me-1],Me=Se.x-ge.x,ze=Se.y-ge.y,Ve=Me*Me+ze*ze<w*w,Ce=be%g,Te=C[1],Ee=void 0,Re=U?{size:F,color:D,opacity:_}:null;for(Ee=0;Ee<me;++Ee){var we=te[Ee],Ae=Te===C[Ee%2]?C[(Ee+1)%2]:C[Ee%2];if(Ee<me-1||!Ve||I?(u(Ae,Ee,te,me,Ve,"round","round"),de+=f(we.x,we.y,Ce,j,G,W,A,P,de,Re,Ae,fe),!Ae.capCenter||Ve&&Ee===me-1||x(Ae,pe),Ve&&0===Ee&&!I&&r.copyExtrudeVectors(T,Ae)):r.copyExtrudeVectors(Ae,T),Ee>0&&p(Te,Ae,pe),Ee<me-1){var Ne=te[Ee+1],Je=[Ne.x-we.x,Ne.y-we.y],Pe=r.length(Je),Ie=[Je[0]/Pe,Je[1]/Pe],Ue=Ce+Pe;if(S&&Ue>g){var _e=(g-Ce)/(Ue-Ce),De=we.x+(Ne.x-we.x)*_e,Fe=we.y+(Ne.y-we.y)*_e,Oe=Te;M.buttCap(Oe,Ie,Ie),de+=f(De,Fe,g,j,G,W,e,P,de,Re,Oe,fe),M.bridge(E,Ae,Oe),p(Ae,Oe,pe),M.buttCap(Oe,Ie,Ie),de+=f(De,Fe,0,j,G,W,e,P,de,Re,Oe,fe),Ce=Ue-g}else Ce=Ue,Te=Ae}}}}var qe=new o;return qe.update({geometry:fe},de,pe),qe}function u(e,i,t,o,a,n,s){var l=t[i],v=[void 0,void 0],u=[void 0,void 0];if(i>0&&i<o-1){var f=t[(i+o-1)%o],p=t[(i+1)%o];r.normalize(v,[l.x-f.x,l.y-f.y]),r.normalize(u,[p.x-l.x,p.y-l.y])}else if(0===i){var p=t[(i+1)%o];if(r.normalize(u,[p.x-l.x,p.y-l.y]),a){var x=t[o-2];r.normalize(v,[l.x-x.x,l.y-x.y])}else v=u}else{if(i!==o-1)return void console.error("Vertex index 'i' out of range.");var f=t[(i+o-1)%o];if(r.normalize(v,[l.x-f.x,l.y-f.y]),a){var y=t[1];r.normalize(u,[y.x-l.x,y.y-l.y])}else u=v}a||0!==i?a||i!==o-1?d(e,v,u,s):c(e,v,u,r.CapPosition.END,n):c(e,v,u,r.CapPosition.START,n)}function c(e,i,t,o,a){"butt"===a?M.buttCap(e,i,t):"round"===a?M.roundCap(e,i,t,o,r.getNumberOfSlices(Math.PI),o===r.CapPosition.START?-1:1):"square"===a?M.squareCap(e,i,t,o):(M.buttCap(e,i,t),console.error("Unknown cap type!"))}function d(e,i,t,o){var a=r.getRads(i,t);if(a>Math.PI-y)M.rectJoin(e,i,t);else if("miter"===o||a<h)a<y?M.fastMiterJoin(e,i,t):a<r.MITER_SAFE_RADS?M.miterJoin(e,i,t):M.bevelJoin(e,i,t,r.SYSTEM_MAG_LIMIT);else if("bevel"===o)M.bevelJoin(e,i,t,1);else if("round"===o){var n=r.getNumberOfSlices(a),s=a<m;s?n<2||a<b?M.bevelJoin(e,i,t,1):M.roundJoin(e,i,t,n):M.unitRoundJoin(e,i,t,n)}}function f(e,i,t,r,o,n,s,l,v,u,c,d){var f,p=0;for(f=0;f<c.vectors.count;++f){var x=c.vectors.items[f].vector[0],y=c.vectors.items[f].vector[1],h=c.vectors.items[f].texCoords[0],b=c.vectors.items[f].texCoords[1],m=c.vectors.items[f].direction[0],g=c.vectors.items[f].direction[1],S=v+p;++p,d.push(a.i1616to32(e,i),s,r,a.i8888to32(Math.round(A*x),Math.round(A*y),Math.round(A*h),Math.round(A*b)),a.i1616to32(t,A*l),a.i1616to32(o[0],o[1]),a.i1616to32(n[0],n[1]),a.i8888to32(Math.round(A*m),Math.round(A*g),0,0)),u&&d.push(u.size,u.color,u.opacity),c.vectors.items[f].base={index:S,point:[e,i]}}return p}function p(e,i,t){M.bridge(E,e,i);var r;for(r=0;r<E.count;++r){var o=E.items[r];t.push(o.v1.base.index,o.v2.base.index,o.v3.base.index)}}function x(e,i){M.pie(R,e);var t;for(t=0;t<R.count;++t){var r=R.items[t];i.push(r.v1.base.index,r.v2.base.index,r.v3.base.index)}}Object.defineProperty(i,"__esModule",{value:!0});var y=.05,h=.1,b=.5,m=2.3,g=65535,S=!0,M=new r.Tessellator({distanceAlongCorrection:!0}),z=new Float32Array(1),V=new Uint32Array(z.buffer),C=[r.allocExtrudeVectors(),r.allocExtrudeVectors()],T=r.allocExtrudeVectors(),E=r.allocTriangles(20),R=r.allocTriangles(20),w=.001,A=31,N=new n.TileClipper(0,0,0,1,8);N.setExtent(512),i.createLineMeshData=v});