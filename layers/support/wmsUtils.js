// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../core/urlUtils","../../geometry/Extent","../../geometry/SpatialReference"],function(e,t,n,r,a){function i(e,t){if(e){if(h=-1,"string"==typeof e){e=(new DOMParser).parseFromString(e,"text/xml")}var n=e.documentElement,a=f("Layer",n);if(a){var i=o("WMS_Capabilities","version",n,null)||o("WMT_MS_Capabilities","version",n,"1.3.0"),s=f("Service",n),l=p("Title",s,"")||p("Name",s,""),c=p("AccessConstraints",s,""),g=p("Abstract",s,""),x=parseInt(p("MaxWidth",s,5e3),10),b=parseInt(p("MaxHeight",s,5e3),10),N=f("Capability",n),v=y(n,"GetMap"),A=t&&t.toLowerCase().indexOf("https")>-1,E=m(n,"GetMap");A&&(E=E.replace(/^http:/i,"https:"));var L,R=d(a,i,A),O=0;if(Array.prototype.slice.call(N.childNodes).forEach(function(e){"Layer"===e.nodeName&&(0===O?L=e:1===O?(R.name&&(R.name="",R.sublayers.push(d(L,i,A))),R.sublayers.push(d(e,i,A))):R.sublayers.push(d(e,i,A)),O++)}),!R)return null;var M,C,U=[],w=R.fullExtents;if(U=R.sublayers,U&&0!==U.length||U.push(R),!(M=R.extent)){var F=new r(U[0].extent);R.extent=F.toJSON(),M=R.extent}if(C=R.spatialReferences,!C.length&&U.length>0){var I=function(e){var t=[];return e.sublayers.forEach(function(e){!t.length&&e.spatialReferences.length&&(t=e.spatialReferences||I(e))}),t};U.forEach(function(e){C.length||(C=e.spatialReferences||I(e))})}var B,_=m(n,"GetFeatureInfo");if(_){var S=y(n,"GetFeatureInfo");S.indexOf("text/html")>-1?B="text/html":S.indexOf("text/plain")>-1&&(B="text/plain"),A&&(_=_.replace(/^http:/i,"https:"))}if(!B){var T=function(e){e&&(e.queryable=!1,e.sublayers&&e.sublayers.forEach(function(e){T(e)}))};T(R)}return{copyright:c,description:g,extent:M,fullExtents:w,featureInfoFormat:B,featureInfoUrl:_,mapUrl:E,maxImageWidth:x,maxImageHeight:b,layers:u(U),spatialReferences:C,supportedImageFormatTypes:v,title:l,version:i}}}}function s(e){return x.some(function(t){var n=t[0],r=t[1];return e>=n&&e<=r})}function l(e){return e.length?e.filter(function(e){return e.popupEnabled&&e.name&&e.queryable}).map(function(e){return e.name}).join(","):""}function u(e){var t=[];return e.forEach(function(e){t.push(e),e.sublayers&&e.sublayers.length&&(t=t.concat(u(e.sublayers)),delete e.sublayers)}),t}function o(e,t,n,r){var a=f(e,n);return a?a.getAttribute(t):r}function f(e,t){var n=t&&t.getElementsByTagName(e);return n&&n.length>0?n[0]:null}function p(e,t,n){var r=f(e,t);return r?r.textContent:n}function c(e,t,n){if(!e)return null;var i,s,l,u,o=parseFloat(e.getAttribute("minx")),f=parseFloat(e.getAttribute("miny")),p=parseFloat(e.getAttribute("maxx")),c=parseFloat(e.getAttribute("maxy"));n?(i=isNaN(f)?-Number.MAX_VALUE:f,s=isNaN(o)?-Number.MAX_VALUE:o,l=isNaN(c)?Number.MAX_VALUE:c,u=isNaN(p)?Number.MAX_VALUE:p):(i=isNaN(o)?-Number.MAX_VALUE:o,s=isNaN(f)?-Number.MAX_VALUE:f,l=isNaN(p)?Number.MAX_VALUE:p,u=isNaN(c)?Number.MAX_VALUE:c);var m=new a({wkid:t});return new r({xmin:i,ymin:s,xmax:l,ymax:u,spatialReference:m})}function m(e,t){var n=f(t,e),r=f("DCPType",n);if(r){var a=f("HTTP",r);if(a){var i=f("Get",a);if(i){var s=o("OnlineResource","xlink:href",i,null);if(s)return s.indexOf("&")===s.length-1&&(s=s.substring(0,s.length-1)),g(s,["service","request"])}}}return null}function y(e,t){var n=e.getElementsByTagName("Operation");if(n&&n.length){var r=Array.prototype.slice.call(n),a=[];return r.forEach(function(e){if(e.getAttribute("name")===t){var n=e.getElementsByTagName("Format");Array.prototype.slice.call(n).forEach(function(e){a.push(e.textContent)})}}),a}var i=f(t,e),s=i.getElementsByTagName("Format");return Array.prototype.slice.call(s).map(function(e){return e.textContent})}function d(e,t,n){if(!e)return null;var i={id:h++,fullExtents:[],parentLayerId:null,queryable:"1"===e.getAttribute("queryable"),spatialReferences:[],sublayers:null},l=f("LatLonBoundingBox",e),u=f("EX_GeographicBoundingBox",e),o=null;l&&(o=c(l,4326)),u&&(o=new r(0,0,0,0,new a({wkid:4326})),o.xmin=parseFloat(p("westBoundLongitude",u,0)),o.ymin=parseFloat(p("southBoundLatitude",u,0)),o.xmax=parseFloat(p("eastBoundLongitude",u,0)),o.ymax=parseFloat(p("northBoundLatitude",u,0))),l||u||(o=new r(-180,-90,180,90,new a({wkid:4326})));var m=["1.0.0","1.1.0","1.1.1"].indexOf(t)>-1?"SRS":"CRS";return Array.prototype.slice.call(e.childNodes).forEach(function(e){if("Name"===e.nodeName)i.name=e.textContent||"";else if("Title"===e.nodeName)i.title=e.textContent||"";else if("Abstract"===e.nodeName)i.description=e.textContent||"";else if("BoundingBox"===e.nodeName){var r=e.getAttribute(m);if(r&&0===r.indexOf("EPSG:")){var a=parseInt(r.substring(5),10);0===a||isNaN(a)||o||(o="1.3.0"===t?c(e,a,s(a)):c(e,a))}var l=r&&r.indexOf(":");if(l&&l>-1){var a=parseInt(r.substring(l+1,r.length),10);0===a||isNaN(a)||(a=b[a]?b[a]:a);var u="1.3.0"===t?c(e,a,s(a)):c(e,a);i.fullExtents.push(u)}}else if(e.nodeName===m){var p=e.textContent.split(" ");p.forEach(function(e){0===(e=e.indexOf(":")>-1?parseInt(e.split(":")[1],10):parseInt(e,10))||isNaN(e)||(b[e]&&(e=b[e]),-1===i.spatialReferences.indexOf(e)&&i.spatialReferences.push(e))})}else if("Style"!==e.nodeName||i.legendURL){if("Layer"===e.nodeName){var y=d(e,t,n);y&&(y.parentLayerId=i.id,i.sublayers||(i.sublayers=[]),i.sublayers.push(y))}}else{var g=f("LegendURL",e);if(g){var h=f("OnlineResource",g);h&&(i.legendURL=h.getAttribute("xlink:href"),n&&(i.legendURL=i.legendURL.replace(/^http:/i,"https:")))}}}),i.extent=o&&o.toJSON(),i}function g(e,t){var r=[],a=n.urlToObject(e);for(var i in a.query)a.query.hasOwnProperty(i)&&-1===t.indexOf(i.toLowerCase())&&r.push(i+"="+a.query[i]);return a.path+(r.length?"?"+r.join("&"):"")}Object.defineProperty(t,"__esModule",{value:!0});var h,x=[[4001,4999],[2044,2045],[2081,2083],[2085,2086],[2093,2093],[2096,2098],[2105,2132],[2169,2170],[2176,2180],[2193,2193],[2200,2200],[2206,2212],[2319,2319],[2320,2462],[2523,2549],[2551,2735],[2738,2758],[2935,2941],[2953,2953],[3006,3030],[3034,3035],[3058,3059],[3068,3068],[3114,3118],[3126,3138],[3300,3301],[3328,3335],[3346,3346],[3350,3352],[3366,3366],[3416,3416],[20004,20032],[20064,20092],[21413,21423],[21473,21483],[21896,21899],[22171,22177],[22181,22187],[22191,22197],[25884,25884],[27205,27232],[27391,27398],[27492,27492],[28402,28432],[28462,28492],[30161,30179],[30800,30800],[31251,31259],[31275,31279],[31281,31290],[31466,31700]],b={84:4326,83:4269,27:4267};t.parseCapabilities=i,t.coordsReversed=s,t.getPopupLayers=l});