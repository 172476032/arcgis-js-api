// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","dojo/_base/lang","../../core/JSONSupport","../../core/kebabDictionary","../../core/lang","../../core/accessorSupport/decorators","../../geometry/SpatialReference","../../geometry/Point","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../geometry/support/scaleUtils","./LOD"],function(e,t,o,r,i,l,n,s,a,p,c,u,f,h,v){var y=n({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc"}),d=m=function(e){function t(t){var o=e.call(this)||this;return o.dpi=96,o.format=null,o.origin=null,o.minScale=0,o.maxScale=0,o.size=null,o.spatialReference=null,o}return o(t,e),t.create=function(e){void 0===e&&(e={size:256,spatialReference:p.WebMercator});for(var t=e.size||256,o=e.spatialReference||p.WebMercator,r=u.getInfo(o),i=r?new c(r.origin[0],r.origin[1],o):new c(0,0,o),l=h.getUnitValueForSR(o),n=96,s=39.3700787,a=1/(l*s*n),f=591657527.591555*(256/t),v=24,y=1,d=[{level:0,scale:f,resolution:f*a}],g=1;v>g;g++){var S=f/(2*y),x=S*a;d.push({level:g,scale:S,resolution:x}),f=S}return new m({dpi:n,lods:d,origin:i,size:t,spatialReference:o})},Object.defineProperty(t.prototype,"lods",{set:function(e){var t=this,o=0,r=0,i=[];this._levelToLOD={},e&&(o=-(1/0),r=1/0,e.forEach(function(e){i.push(e.scale),o=e.scale>o?e.scale:o,r=e.scale<r?e.scale:r,t._levelToLOD[e.level]=e})),this._set("scales",i),this._set("minScale",o),this._set("maxScale",r),this._set("lods",e),this._initializeUpsampleLevels()},enumerable:!0,configurable:!0}),t.prototype.zoomToScale=function(e){var t=this.scales;if(0>=e)return t[0];if(e>=t.length)return t[t.length-1];var o=Math.round(e-.5),r=Math.round(e);return t[r]+(r-e)*(t[o]-t[r])},t.prototype.scaleToZoom=function(e){for(var t=this.scales,o=t.length-1,r=0;o>r;r++){var i=t[r],l=t[r+1];if(e>=i)return r;if(l===e)return r+1;if(i>e&&e>l)return r+1-(e-l)/(i-l)}return r},t.prototype.snapScale=function(e,t){void 0===t&&(t=.95);var o=this.scaleToZoom(e),r=o%Math.floor(o);return r>=t?this.zoomToScale(Math.ceil(o)):this.zoomToScale(Math.floor(o))},t.prototype.tileAt=function(e,t,o,r){var i=this.lodAt(e);if(!i)return null;r||(r={id:null,level:0,row:0,col:0,extent:[0,0,0,0]});var l,n;if("number"==typeof t)l=t,n=o;else if(t.spatialReference.equals(this.spatialReference))l=t.x,n=t.y,r=o;else{var s=f.project(t,this.spatialReference);if(!s)return null;l=s.x,n=s.y,r=o}var a=i.resolution*this.size[0],p=i.resolution*this.size[1];return r.level=e,r.row=Math.floor((this.origin.y-n)/p+.001),r.col=Math.floor((l-this.origin.x)/a+.001),this.updateTileInfo(r),r},t.prototype.updateTileInfo=function(e){var t=this.lodAt(e.level),o=t.resolution*this.size[0],r=t.resolution*this.size[1];e.id=e.level+"/"+e.row+"/"+e.col,e.extent||(e.extent=[0,0,0,0]),e.extent[0]=this.origin.x+e.col*o,e.extent[1]=this.origin.y-(e.row+1)*r,e.extent[2]=e.extent[0]+o,e.extent[3]=e.extent[1]+r},t.prototype.upsampleTile=function(e){var t=this._upsampleLevels[e.level];return t&&-1!==t.parentLevel?(e.level=t.parentLevel,e.row=Math.floor(e.row/t.factor+.001),e.col=Math.floor(e.col/t.factor+.001),this.updateTileInfo(e),!0):!1},t.prototype.lodAt=function(e){return this._levelToLOD&&this._levelToLOD[e]||null},t.prototype.clone=function(){return m.fromJSON(this.toJSON())},t.prototype.toJSON=function(){return s.fixJson({rows:this.size[0],cols:this.size[1],dpi:this.dpi,format:y.toJSON(this.format),compressionQuality:this.compressionQuality,origin:this.origin&&this.origin.toJSON(),spatialReference:this.spatialReference&&this.spatialReference.toJSON(),lods:this.lods&&this.lods.map(function(e){return e.toJSON()})})},t.prototype._initializeUpsampleLevels=function(){var e=this.lods;this._upsampleLevels=[];for(var t=null,o=0;o<e.length;o++){var r=e[o];this._upsampleLevels[r.level]={parentLevel:t?t.level:-1,factor:t?t.resolution/r.resolution:0},t=r}},t}(a.declared(l));r([a.property()],d.prototype,"compressionQuality",void 0),r([a.property()],d.prototype,"dpi",void 0),r([a.property({json:{read:y.fromJSON}})],d.prototype,"format",void 0),r([a.property({type:c,json:{read:function(e,t){return c.fromJSON(i.mixin({spatialReference:t.spatialReference},e))}}})],d.prototype,"origin",void 0),r([a.property({type:[v],value:null})],d.prototype,"lods",null),r([a.property({readOnly:!0})],d.prototype,"minScale",void 0),r([a.property({readOnly:!0})],d.prototype,"maxScale",void 0),r([a.property({readOnly:!0})],d.prototype,"scales",void 0),r([a.property({cast:function(e){return Array.isArray(e)?e:"number"==typeof e?[e,e]:[256,256]},json:{read:{source:["rows","cols"],reader:function(e,t){return[t.cols,t.rows]}}}})],d.prototype,"size",void 0),r([a.property({type:p})],d.prototype,"spatialReference",void 0),d=m=r([a.subclass("esri.layers.support.TileInfo")],d);var m;return d});