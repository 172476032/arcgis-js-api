// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","dojo/_base/lang","../../core/JSONSupport","../../core/kebabDictionary","../../core/accessorSupport/decorators","../../geometry/SpatialReference","../../geometry/Point","../../geometry/support/spatialReferenceUtils","../../geometry/support/webMercatorUtils","../../geometry/support/scaleUtils","./LOD"],function(e,t,r,o,i,l,n,s,p,a,u,c,f,y){var v=n({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc"}),d=function(e){function t(t){var r=e.call(this)||this;return r.dpi=96,r.format=null,r.origin=null,r.minScale=0,r.maxScale=0,r.size=null,r.spatialReference=null,r}return r(t,e),l=t,t.create=function(e){void 0===e&&(e={size:256,spatialReference:p.WebMercator});var t=e.scales,r=e.size||256,o=e.spatialReference||p.WebMercator,i=u.getInfo(o),n=i?new a(i.origin[0],i.origin[1],o):new a(0,0,o),s=f.getMetersPerUnitForSR(o),c=96,y=39.37,v=1/(s*y*c),d=[];if(t)for(var h=0;h<t.length;h++){var g=t[h],m=g*v;d.push({level:h,scale:g,resolution:m})}else{var S=591657527.591555*(256/r),w=24,b=1;d.push({level:0,scale:S,resolution:S*v});for(var h=1;w>h;h++){var g=S/(2*b),m=g*v;d.push({level:h,scale:g,resolution:m}),S=g}}return new l({dpi:c,lods:d,origin:n,size:r,spatialReference:o})},Object.defineProperty(t.prototype,"isWrappable",{get:function(){var e=this,t=e.spatialReference,r=e.origin;if(t&&r){var o=u.getInfo(t);return t.isWrappable&&Math.abs(o.origin[0]-r.x)<=o.dx}return!1},enumerable:!0,configurable:!0}),t.prototype.readOrigin=function(e,t){return a.fromJSON(i.mixin({spatialReference:t.spatialReference},e))},Object.defineProperty(t.prototype,"lods",{set:function(e){var t=this,r=0,o=0,i=[];this._levelToLOD={},e&&(r=-(1/0),o=1/0,e.forEach(function(e){i.push(e.scale),r=e.scale>r?e.scale:r,o=e.scale<o?e.scale:o,t._levelToLOD[e.level]=e})),this._set("scales",i),this._set("minScale",r),this._set("maxScale",o),this._set("lods",e),this._initializeUpsampleLevels()},enumerable:!0,configurable:!0}),t.prototype.readSize=function(e,t){return[t.cols,t.rows]},t.prototype.writeSize=function(e,t){t.cols=e[0],t.rows=e[0]},t.prototype.zoomToScale=function(e){var t=this.scales;if(0>=e)return t[0];if(e>=t.length)return t[t.length-1];var r=Math.round(e-.5),o=Math.round(e);return t[o]+(o-e)*(t[r]-t[o])},t.prototype.scaleToZoom=function(e){for(var t=this.scales,r=t.length-1,o=0;r>o;o++){var i=t[o],l=t[o+1];if(e>=i)return o;if(l===e)return o+1;if(i>e&&e>l)return o+1-(e-l)/(i-l)}return o},t.prototype.snapScale=function(e,t){void 0===t&&(t=.95);var r=this.scaleToZoom(e),o=r%Math.floor(r);return o>=t?this.zoomToScale(Math.ceil(r)):this.zoomToScale(Math.floor(r))},t.prototype.tileAt=function(e,t,r,o){var i=this.lodAt(e);if(!i)return null;o||(o={id:null,level:0,row:0,col:0,extent:[0,0,0,0]});var l,n;if("number"==typeof t)l=t,n=r;else if(t.spatialReference.equals(this.spatialReference))l=t.x,n=t.y,o=r;else{var s=c.project(t,this.spatialReference);if(!s)return null;l=s.x,n=s.y,o=r}var p=i.resolution*this.size[0],a=i.resolution*this.size[1];return o.level=e,o.row=Math.floor((this.origin.y-n)/a+.001),o.col=Math.floor((l-this.origin.x)/p+.001),this.updateTileInfo(o),o},t.prototype.updateTileInfo=function(e){var t=this.lodAt(e.level),r=t.resolution*this.size[0],o=t.resolution*this.size[1];e.id=e.level+"/"+e.row+"/"+e.col,e.extent||(e.extent=[0,0,0,0]),e.extent[0]=this.origin.x+e.col*r,e.extent[1]=this.origin.y-(e.row+1)*o,e.extent[2]=e.extent[0]+r,e.extent[3]=e.extent[1]+o},t.prototype.upsampleTile=function(e){var t=this._upsampleLevels[e.level];return t&&-1!==t.parentLevel?(e.level=t.parentLevel,e.row=Math.floor(e.row/t.factor+.001),e.col=Math.floor(e.col/t.factor+.001),this.updateTileInfo(e),!0):!1},t.prototype.lodAt=function(e){return this._levelToLOD&&this._levelToLOD[e]||null},t.prototype.clone=function(){return l.fromJSON(this.write({}))},t.prototype._initializeUpsampleLevels=function(){var e=this.lods;this._upsampleLevels=[];for(var t=null,r=0;r<e.length;r++){var o=e[r];this._upsampleLevels[o.level]={parentLevel:t?t.level:-1,factor:t?t.resolution/o.resolution:0},t=o}},o([s.property({type:Number,json:{write:!0}})],t.prototype,"compressionQuality",void 0),o([s.property({type:Number,json:{write:!0}})],t.prototype,"dpi",void 0),o([s.property({type:String,json:{read:v.read,write:v.write}})],t.prototype,"format",void 0),o([s.property({readOnly:!0,dependsOn:["spatialReference","origin"]})],t.prototype,"isWrappable",null),o([s.property({type:a,json:{write:!0}})],t.prototype,"origin",void 0),o([s.reader("origin")],t.prototype,"readOrigin",null),o([s.property({type:[y],value:null,json:{write:!0}})],t.prototype,"lods",null),o([s.property({readOnly:!0})],t.prototype,"minScale",void 0),o([s.property({readOnly:!0})],t.prototype,"maxScale",void 0),o([s.property({readOnly:!0})],t.prototype,"scales",void 0),o([s.property({cast:function(e){return Array.isArray(e)?e:"number"==typeof e?[e,e]:[256,256]}})],t.prototype,"size",void 0),o([s.reader("size",["rows","cols"])],t.prototype,"readSize",null),o([s.writer("size",{cols:{type:Number},rows:{type:Number}})],t.prototype,"writeSize",null),o([s.property({type:p,json:{write:!0}})],t.prototype,"spatialReference",void 0),t=l=o([s.subclass("esri.layers.support.TileInfo")],t);var l}(s.declared(l));return d});