// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel","../geometry/Extent"],function(e,t,i,n,r){var s=e(null,{declaredClass:"esri.layers.WCSCapabilities",version:null,name:null,onlineResources:null,coverages:null,supportedFormats:null,supportedVersions:null,profiles:null,supportedInterpolations:null,constructor:function(e){this._parse=t.hitch(this,this._parse),e&&t.mixin(this,this._parse(e))},_parse:function(e){var t=this._getElement(e,"Capabilities")||this._getElement(e,"WCS_Capabilities");if(null===t)throw"not a valid capabilities file -- cannot find Capabilities or WCS_Capabilities root element";var i=t.getAttribute("version");switch(this.version=i,i){case"1.0.0":this._parse100(e);break;case"1.1.0":case"1.1.1":case"1.1.2":this._parse110(e);break;case"2.0.1":this._parse201(e);break;default:throw"unsupported WCS version "+i}},_getElements:function(e,t){if(!e)return null;if(!t)return e;var i=t;return t.indexOf("/")>-1?(i=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="",t?this._getElement(e,i).getElementsByTagNameNS("*",t):e.getElementsByTagNameNS("*",i)},_getElement:function(e,t){if(!e)return null;if(!t)return e;var i=t;t.indexOf("/")>-1?(i=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=this._getElements(e,i);return n.length>0?t?this._getElement(n[0],t):n[0]:null},_getElementValue:function(e,t){var i,n=this._getElement(e,t);return n?(i=n.textContent||n.text||n.nodeValue||n.innerText,i?i.trim():null):null},_getElementValues:function(e,t){var i,n,r=this._getElements(e,t),s=[];for(n=0;n<r.length;n++)i=r[n].textContent||r[n].text||r[n].nodeValue||r[n].innerText,i&&(i=i.trim(),""!==i&&s.push(i));return s},_removeTrailingQuestionMark:function(e){return e?e.indexOf("?")===e.length-1?e.substring(0,e.length-1):e:null},_parse100:function(e){var t=this._getElement(e,"Service");this.name=this._getElementValue(t,"name"),this.supportedVersions=["1.0.0"];var i={},n=this._getElement(e,"Capability");i.getCapabilities=this._removeTrailingQuestionMark(this._getElement(n,"GetCapabilities/Get/OnlineResource").getAttribute("xlink:href")),i.describeCoverage=this._removeTrailingQuestionMark(this._getElement(n,"DescribeCoverage/Get/OnlineResource").getAttribute("xlink:href")),i.getCoverage=this._removeTrailingQuestionMark(this._getElement(n,"GetCoverage/Get/OnlineResource").getAttribute("xlink:href")),this.onlineResources=i;var s,a,l,o,u,g,h=this._getElements(e,"CoverageOfferingBrief"),m=[];for(s=0;s<h.length;s++)a=h[s],l={},l.id=this._getElementValue(a,"name"),l.label=this._getElementValue(a,"label"),l.description=this._getElementValue(a,"description"),o=this._getElements(a,"pos"),u=this._getElementValue(o[0]).split(" "),g=this._getElementValue(o[1]).split(" "),l.lonLatEnvelope=new r({xmin:parseFloat(u[0]),ymin:parseFloat(u[1]),xmax:parseFloat(g[0]),ymax:parseFloat(g[1]),spatialReference:{wkid:4326}}),m.push(l);return this.coverages=m,!0},_parse110:function(e){this.name=this._getElementValue(e,"ServiceIdentification/Title"),this.supportedVersions=this._getElementValues(e,"ServiceIdentification/ServiceTypeVersion");var t={},i=this._getElement(e,"OperationsMetadata");t.getCapabilities=this._removeTrailingQuestionMark(this._getElement(i.querySelector("Operation[name=GetCapabilities]"),"Get").getAttribute("xlink:href")),t.describeCoverage=this._removeTrailingQuestionMark(this._getElement(i.querySelector("Operation[name=DescribeCoverage]"),"Get").getAttribute("xlink:href")),t.getCoverage=this._removeTrailingQuestionMark(this._getElement(i.querySelector("Operation[name=GetCoverage]"),"Get").getAttribute("xlink:href")),this.onlineResources=t;var n,s,a,l,o,u,g=this._getElement(e,"Contents"),h=[],m=this._getElements(g,"CoverageSummary");for(n=0;n<m.length;n++)s=m[n],a={},a.title=this._getElementValue(s,"Title"),a["abstract"]=this._getElementValue(s,"Abstract"),a.id=this._getElementValue(s,"Identifier"),l=this._getElement(s,"WGS84BoundingBox"),o=this._getElementValue(l,"LowerCorner").split(" "),u=this._getElementValue(l,"UpperCorner").split(" "),a.lonLatEnvelope=new r({xmin:parseFloat(o[0]),ymin:parseFloat(o[1]),xmax:parseFloat(u[0]),ymax:parseFloat(u[1]),spatialReference:{wkid:4326}}),h.push(a);this.coverages=h;var p=[],_=this._getElements(g,"SupportedFormat");for(n=0;n<_.length;n++)p.push(this._getElementValue(_[n]));return this.supportedFormats=p,!0},_parse201:function(e){var t,i=this._getElement(e,"ServiceIdentification");this.name=this._getElementValue(i,"Title"),this.supportedVersions=this._getElementValues(i,"ServiceTypeVersion");var n=this._getElements(i,"Profile"),s=[];for(t=0;t<n.length;t++)s.push(this._getElementValue(n[t]));this.profiles=s;var a={},l=this._getElement(e,"OperationsMetadata");a.getCapabilities=this._removeTrailingQuestionMark(this._getElement(l.querySelector("Operation[name=GetCapabilities]"),"Get").getAttribute("xlink:href")),a.describeCoverage=this._removeTrailingQuestionMark(this._getElement(l.querySelector("Operation[name=DescribeCoverage]"),"Get").getAttribute("xlink:href")),a.getCoverage=this._removeTrailingQuestionMark(this._getElement(l.querySelector("Operation[name=GetCoverage]"),"Get").getAttribute("xlink:href")),this.onlineResources=a;var o,u,g,h,m,p=this._getElements(e,"Contents/CoverageSummary"),_=[];for(t=0;t<p.length;t++)o=p[t],u={},u.id=this._getElementValue(o,"CoverageId"),g=this._getElement(o,"WGS84BoundingBox"),h=this._getElementValue(g,"LowerCorner").split(" "),m=this._getElementValue(g,"UpperCorner").split(" "),u.lonLatEnvelope=new r({xmin:parseFloat(h[0]),ymin:parseFloat(h[1]),xmax:parseFloat(m[0]),ymax:parseFloat(m[1]),spatialReference:{wkid:4326}}),_.push(u);this.coverages=_;var c=this._getElement(e,"ServiceMetadata"),v=this._getElements(c,"formatSupported"),E=[];for(t=0;t<v.length;t++)E.push(this._getElementValue(v[t]));this.supportedFormats=E;var f=this._getElements(c,"interpolationSupported"),d=[];for(t=0;t<f.length;t++)d.push(this._getElementValue(f[t]));return this.supportedInterpolations=d.map(function(e){var t=null;return e.toLowerCase().indexOf("nearest")>-1?t=0:e.toLowerCase().indexOf("linear")>-1?t=1:e.toLowerCase().indexOf("cubic")>-1&&(t=2),t}).filter(function(e){return null!==e}),!0}});return i("extend-esri")&&t.setObject("layers.WCSCapabilities",s,n),s});