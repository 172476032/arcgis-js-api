// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/Deferred","dojo/_base/array","dojo/_base/json","dojo/_base/config","dojo/_base/connect","dojo/has","dojo/io-query","../kernel","../config","../lang","../request","../deferredUtils","../urlUtils","../geometry/Extent","../geometry/Point","../geometry/Polygon","./MosaicRule","./RasterFunction","./DimensionalDefinition","./Raster","./PixelBlock","./pixelFilters/VectorFieldPixelFilter","./rasterFormats/ImageCanvasDecoder","./TimeInfo","./Field","../graphic","../tasks/ImageServiceIdentifyTask","../tasks/ImageServiceIdentifyParameters"],function(e,t,i,n,a,s,r,l,o,u,h,c,f,d,m,p,g,_,b,v,x,R,D,y,T,F,P,w,I,C){var V=e(null,{declaredClass:"esri.layers.ImageServiceLayerMixin",_rasterFieldPrefix:"Raster.",_renderingRuleFieldSubPrefix:"ServicePixelValue.",_eventMap:{"rendering-change":!0,"mosaic-rule-change":!0,"spatial-reference-change":!0},constructor:function(e,t){this.useMapTime=t&&t.hasOwnProperty("useMapTime")?!!t.useMapTime:!0},_initialize:function(e,i){this._url=m.urlToObject(e),this.raster=new R(this._url.path),this.infoTemplate=i&&i.infoTemplate;var n=i&&i.imageServiceParameters;this.format=n&&n.format,this.compressionTolerance=n&&n.compressionTolerance?n.compressionTolerance:.01,this.interpolation=n?n.interpolation:null,this.compressionQuality=n?n.compressionQuality:null,this.bandIds=n?n.bandIds:null,this.mosaicRule=n?n.mosaicRule:null,this.renderingRule=n?n.renderingRule:null,this.useMapDimensionValue=i&&i.hasOwnProperty("useMapDimensionValue")?!!i.useMapDimensionValue:!0,this.activeMapDimensions=i&&i.activeMapDimensions,this._params=t.mixin({},this._url.query,{f:"image",interpolation:this.interpolation,format:this.format,compressionQuality:this.compressionQuality,bandIds:this.bandIds?this.bandIds.join(","):null},n?n.toJson():{}),this.pixelFilter=i&&i.pixelFilter,this.pixelData=null,this.originalPixelData=null,this.hasDataChanged=!0,this._requestDataHandler=t.hitch(this,this._requestDataHandler),this._requestDataErrorHandler=t.hitch(this,this._requestDataErrorHandler),this._rasterReadPromise=null,this._initLayer=t.hitch(this,this._initLayer),this._queryVisibleRastersHandler=t.hitch(this,this._queryVisibleRastersHandler),this._visibleRasters=[],this._rasterAttributeTableFields=[],this._rasterAttributeTableFeatures=[],this._renderingRuleAttributeTable={},this._useRenderingRuleAttributeTable=!1,this._loadCallback=i&&i.loadCallback;var a=i&&i.resourceInfo;a?this._initLayer(a):f({url:this._url.path,content:t.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}),this.registerConnectEvents()},disableClientCaching:!1,_initLayer:function(e,i){if(null!==e&&void 0!==e){this._findCredential();var n=this.credential&&this.credential.ssl||e&&e._ssl;n&&this._useSSL();var a=this.minScale,s=this.maxScale;t.mixin(this,e),this.minScale=a,this.maxScale=s,this.initialExtent=this.fullExtent=this.extent=new p(e.extent),this.spatialReference=this.initialExtent.spatialReference,this.pixelSizeX=parseFloat(this.pixelSizeX),this.pixelSizeY=parseFloat(this.pixelSizeY);var r,l,o=this.minValues,u=this.maxValues,h=this.meanValues,f=this.stdvValues,d=this.bands=[];for(r=0,l=this.bandCount;l>r;r++)d[r]={min:o[r],max:u[r],mean:h[r],stddev:f[r]};var m=this.timeInfo;this.timeInfo=m&&m.timeExtent?new F(m):null;var g=this.fields=[],_=e.fields;if(_)for(r=0;r<_.length;r++)g.push(new P(_[r]));if(this.version=e.currentVersion,!this.version){var v;v="fields"in e||"objectIdField"in e||"timeInfo"in e?10:9.3,this.version=v}c.isDefined(e.minScale)&&!this._hasMin&&this.setMinScale(e.minScale),c.isDefined(e.maxScale)&&!this._hasMax&&this.setMaxScale(e.maxScale);var x={};if(e.defaultMosaicMethod?(x.method=e.defaultMosaicMethod,x.operation=e.mosaicOperator,x.sortField=e.sortField,x.sortValue=e.sortValue):x.method=b.METHOD_NONE,this.defaultMosaicRule=new b(x),this.defaultMosaicRule.ascending=!0,this._useRenderingRuleAttributeTable=this.version>10&&"esriImageServiceDataTypeThematic"===this.serviceDataType&&!this.hasRasterAttributeTable,this._setDefaultRenderingRule(!0),this._isScientificData()&&(!this.mosaicRule||this.mosaicRule&&!this.mosaicRule.multidimensionalDefinition)&&this._setDefaultMultidimensionalDefinition(!0),this.version>10&&this.hasRasterAttributeTable){var R=this.getRasterAttributeTable();R.then(t.hitch(this,function(e){e&&e.features&&e.features.length>0&&(this._rasterAttributeTableFeatures=t.clone(e.features)),e&&e.fields&&e.fields.length>0&&(this._rasterAttributeTableFields=t.clone(e.fields))}))}this._isVectorData()&&!c.isDefined(this.pixelFilter)&&(this.vectorFieldPixelFilter=new y,this.vectorFieldPixelFilter.isDataUV="esriImageServiceDataTypeVector-UV"===this.serviceDataType,this.pixelFilter=this.vectorFieldPixelFilter.computeMagnitudeAndDirection,this.getKeyProperties().then(t.hitch(this,this._setFlowRepresentation))),this.loaded=!0,this._setDefaultFilter(),this.onLoad(this);var D=this._loadCallback;D&&(delete this._loadCallback,D(this))}},getKeyProperties:function(){var e=this._url.path+"/keyProperties",t=new i(d._dfdCanceller);if(this.version>10)t._pendingDfd=f({url:e,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),t._pendingDfd.then(function(e){t.callback(e)},function(e){t.errback(e)});else{var n=new Error("Layer does not have key properties");n.log=s.isDebug,t.errback(n)}return t},getRasterAttributeTable:function(e){var t=this._url.path+"/rasterAttributeTable",n=new i(d._dfdCanceller),r={f:"json"},l=this.hasRasterAttributeTable;if(e&&e.renderingRule&&(r.renderingRule=a.toJson(e.renderingRule.toJson()),l=!0),this.version>10&&l)n._pendingDfd=f({url:t,content:r,handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then(function(e){n.callback(e)},function(e){n.errback(e)});else{var o=new Error("Layer does not support raster attribute table");o.log=s.isDebug,n.errback(o)}return n},_getRenderingRuleAttributeTable:function(e){var n=new i(d._dfdCanceller);if(!e||!e.renderingRule){var a=new Error("Rendering rule is not specified");return n.errback(a),n}var s=e.renderingRule,r=s.functionName;return this._renderingRuleAttributeTable&&r&&this._renderingRuleAttributeTable.hasOwnProperty(r)?n.resolve(this._renderingRuleAttributeTable[r]):n=this.getRasterAttributeTable({renderingRule:s}).then(t.hitch(this,function(e){var i;return e&&e.features&&e.features.length&&e.fields&&e.fields.length&&(i={features:t.clone(e.features),fields:t.clone(e.fields)},r&&(this._renderingRuleAttributeTable[r]=i)),i})),n},_getRasterAttributeTableFeatures:function(){var e=new i;if(this._rasterAttributeTableFeatures&&this._rasterAttributeTableFeatures.length>0)return e.resolve(this._rasterAttributeTableFeatures),e;if(this.version>10&&this.hasRasterAttributeTable){var n=this.getRasterAttributeTable();return n.then(t.hitch(this,function(e){e&&e.features&&e.features.length>0&&(this._rasterAttributeTableFeatures=t.clone(e.features))})),n}return e.resolve(this._rasterAttributeTableFeatures),e},_getRenderingRuleAttributeTableFeatures:function(e){var t=e&&e.renderingRule;if(!t){var n=new i,a=new Error("Rendering rule is not specified");return n.errback(a),n}var s=this._getRenderingRuleAttributeTable({renderingRule:t});return s.then(function(e){return e&&e.features})},getCustomRasterFields:function(e){var i=e?e.rasterAttributeTableFieldPrefix:this._rasterFieldPrefix,a=this.version>=10.3?"esriFieldTypeDouble":"esriFieldTypeString",s={name:this._rasterFieldPrefix+"ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:a},r={name:this._rasterFieldPrefix+"ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,length:50,type:a},l={name:this._rasterFieldPrefix+"ServicePixelValue.Raw",alias:"Raw Service Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeDouble"},o=this.fields?t.clone(this.fields):[],u=o.length;if(o[u]=r,this.version>=10.4&&"esri.layers.ArcGISImageServiceLayer"===this.declaredClass&&(!this.rasterFunctionInfos||!this.rasterFunctionInfos.length||this._isRasterFunctionInfoAvailable("none"))&&(u++,o[u]=l),(this.capabilities&&this.capabilities.toLowerCase().indexOf("catalog")>-1||this.fields&&this.fields.length>0)&&(u++,o[u]=s),c.isDefined(this.pixelFilter)&&("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)){var h={name:this._rasterFieldPrefix+"Magnitude",alias:"Magnitude",domain:null,editable:!1,type:"esriFieldTypeDouble"},f={name:this._rasterFieldPrefix+"Direction",alias:"Direction",domain:null,editable:!1,type:"esriFieldTypeDouble"};u++,o[u]=h,u++,o[u]=f}var d=this._rasterAttributeTableFields,m=this.renderingRule&&this.renderingRule.functionName;if(m&&this._renderingRuleAttributeTable&&this._renderingRuleAttributeTable.hasOwnProperty(m)&&(d=this._renderingRuleAttributeTable[m].fields),d&&d.length>0){var p=n.filter(d,function(e){return"esriFieldTypeOID"!==e.type&&"value"!==e.name.toLowerCase()}),g=n.map(p,function(e){var n=t.clone(e);return n.name=i+e.name,n});o=o.concat(g)}var _=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;return this.version>=10.4&&this.rasterFunctionInfos&&n.forEach(this.rasterFunctionInfos,function(e){if(e&&e.name&&"none"!==e.name.toLowerCase()){var t={name:_+e.name.replace(/ /gi,"_"),alias:e.name,domain:null,editable:!1,type:"esriFieldTypeDouble"};o.push(t)}}),o},_prepareGetImageParameters:function(e,i,n,s){s=c.isDefined(s)?s:this._params;var r=e.spatialReference.wkid||a.toJson(e.spatialReference.toJson(!1));delete s._ts,t.mixin(s,{bbox:e.xmin+","+e.ymin+","+e.xmax+","+e.ymax,imageSR:r,bboxSR:r,size:i+","+n},this.disableClientCaching?{_ts:(new Date).getTime()}:{}),delete s.compressionTolerance,s.format&&"LERC"===s.format.toUpperCase()&&(s.compressionTolerance=this.compressionTolerance),s.token=this._getToken()},getImageUrl:function(e,i,n,a,s){s=c.isDefined(s)?s:this._params,this._prepareGetImageParameters(e,i,n,s);var r=t.clone(s);this._cleanupRequestParams(r);var l=this._url.path+"/exportImage?",u=m.addProxy(l+o.objectToQuery(t.mixin(r,{f:"image"}))),d=r.token;u.length>h.defaults.io.postLength||this.useMapImage?this._jsonRequest=f({url:l,content:t.mixin(r,{f:"json"}),callbackParamName:"callback",load:function(e,t){var i=e.href;d&&(i+=-1===i.indexOf("?")?"?token="+d:"&token="+d),a(m.addProxy(i))},error:this._errorHandler}):a(u)},onRenderingChange:function(){},onMosaicRuleChange:function(){},setInterpolation:function(e,t){this.interpolation=this._params.interpolation=e,t||this.refresh(!0)},setCompressionQuality:function(e,t){this.compressionQuality=this._params.compressionQuality=e,t||this.refresh(!0)},setCompressionTolerance:function(e,t){this.compressionTolerance=e,t||this.refresh(!0)},setBandIds:function(e,t){var i=!1;this.bandIds!==e&&(i=!0),this.bandIds=e,this._params.bandIds=e.join(","),i&&!t&&this.onRenderingChange(),t||this.refresh(!0)},setDefaultBandIds:function(e){this.bandIds=this._params.bandIds=null,e||this.refresh(!0)},setDisableClientCaching:function(e){this.disableClientCaching=e},setMosaicRule:function(e,t){var i=!1;this.mosaicRule!==e&&(i=!0),this.mosaicRule=e,this._params.mosaicRule=a.toJson(e.toJson()),i&&!t&&this.onMosaicRuleChange(),t||this.refresh(!0)},setRenderingRule:function(e,t){var i=!1;this.renderingRule!==e&&(i=!0),this.renderingRule=e,this._params.renderingRule=e?a.toJson(e.toJson()):null,this._useRenderingRuleAttributeTable&&this._getRenderingRuleAttributeTable({renderingRule:e}),i&&this.onRenderingChange(),this._setDefaultFilter(),t||this.refresh(!0)},setImageFormat:function(e,t){this.format=this._params.format=e,this._setDefaultFilter(),t||this.refresh(!0)},setInfoTemplate:function(e){this.infoTemplate=e},setDefinitionExpression:function(e,t){var i=this.mosaicRule?this.mosaicRule.toJson():{};this.mosaicRule||(this.defaultMosaicRule?i=this.defaultMosaicRule.toJson():i.method=b.METHOD_NONE),i.where=e;var n=new b(i);return this.setMosaicRule(n,t),this},getDefinitionExpression:function(){return this.mosaicRule?this.mosaicRule.where:null},setPixelFilter:function(e){this.pixelFilter=e,this._isDefaultPixelFilter=!1},getPixelData:function(e){if(e){var t=this._useBrowserDecoding();return t&&(this.originalPixelData={pixelBlock:this._getPixelBlockFromCanvas(this._context,this._map.width,this._map.height),extent:this._map.extent}),this.originalPixelData}return this.pixelData},redraw:function(){this.hasDataChanged=!1,this._setPixelData(this.originalPixelData)},queryVisibleRasters:function(e,a,s,r){var l=this._map,o=d._fixDfd(new i(d._dfdCanceller));this._visibleRasters=[];var u,h,c=!0,f=this.infoTemplate?this.infoTemplate.info:null,m=f?t.clone(this.infoTemplate.info.fieldInfos):null;if(a=a||{},f&&this.infoTemplate.info.mediaInfos&&this.infoTemplate.info.mediaInfos.length){var p=[];n.forEach(this.infoTemplate.info.mediaInfos,function(e){var t=e&&e.value&&e.value.fields||[];p=p.concat(t)}),p.length&&n.forEach(m,function(e){e&&p.indexOf(e.fieldName)>-1&&(e.visible=!0)})}if(m&&m.length>0)for(c=!1,u=0;u<m.length;u++)if(h=m[u],h&&h.fieldName.toLowerCase()!==this._rasterFieldPrefix.toLowerCase()+"servicepixelvalue"&&(h.visible||f.title&&f.title.toLowerCase().indexOf(h.fieldName.toLowerCase())>-1)){c=!0;break}var _=this._removeVisualizationStretchFunction(this.renderingRule),b=_&&_.functionName,x=[];if(this.version>=10.4){var R=!1;if(this.rasterFunctionInfos&&m){var D=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;n.forEach(this.rasterFunctionInfos,function(e){var t=D+e.name.replace(/ /gi,"_"),i=n.some(m,function(e){return e.visible&&e.fieldName===t});i&&(R=R||b&&b===e.name,x.push(new v({rasterFunction:e.name})))})}_&&!R&&x.push(_)}var y=new C;if(y.geometry=e.geometry,y.returnGeometry=this._map.spatialReference.equals(this.spatialReference),y.returnCatalogItems=c,y.timeExtent=e.timeExtent,y.mosaicRule=this.mosaicRule||null,y.renderingRule=this.version<10.4&&_||null,y.renderingRules=x||null,l){var T=(l.extent.xmax-l.extent.xmin)/l.width,F=(l.extent.ymax-l.extent.ymin)/l.height,P=l.extent.spatialReference,w=new g(T,F,P);y.pixelSize=w}a.requestParams=y;var V=this,S=new I(this.url),A=o._pendingDfd=S.execute(y);return A.addCallbacks(function(e){V._queryVisibleRastersHandler(e,a,s,r,o)},function(e){V._resolve([e],null,r,o,!0)}),o},_queryVisibleRastersHandler:function(e,i,s,r,l){function o(){var e,a,r,o,f,d,m,g,_,x,R,y,P=this.getCustomRasterFields(i),w=this._getDomainFields(P),I=i?i.returnDomainValues:!1,C=i&&i.rasterAttributeTableFieldPrefix;this._useRenderingRuleAttributeTable&&this.renderingRule?(R=this._getRenderingRuleAttributeTableFeatures({renderingRule:this.renderingRule}),y=b):R=this._getRasterAttributeTableFeatures(),R.then(t.hitch(this,function(i){for(e=0;e<h.length;e++){if(j=h[e],a=j.attributes[T],j.setInfoTemplate(this.infoTemplate),j._layer=this,b){if(x=b.replace(/ /gi,"").split(","),r=b,o=x,u&&u.length>=e&&(r=u[e].replace(/ /gi,", "),o=u[e].split(" ")),j.attributes[this._rasterFieldPrefix+"ItemPixelValue"]=o,j.attributes[this._rasterFieldPrefix+"ServicePixelValue"]=x,v&&(j.attributes[this._rasterFieldPrefix+"ServicePixelValue.Raw"]=v.replace(/ /gi,"").split(",")),this.pixelFilter){var R=new D({height:1,width:1,pixelType:"F32",pixels:[],statistics:[]});n.forEach(o,function(e){R.addData({pixels:[e],statistics:{minValue:e,maxValue:e,noDataValue:null}})}),this.pixelFilter({pixelBlock:R,extent:new p(0,0,0,0,this._map.spatialReference)}),("esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType)&&(j.attributes[this._rasterFieldPrefix+"Magnitude"]=R.pixels[0][0],j.attributes[this._rasterFieldPrefix+"Direction"]=R.pixels[1][0])}n.forEach(F,function(e){j.attributes[e.name]=e.value});var P=y||r;if(i&&i.length>0&&(f=n.filter(i,function(e){return e&&e.attributes?e.attributes.hasOwnProperty("Value")?e.attributes.Value==P:e.attributes.VALUE==P:void 0}),f.length>0&&(d=t.clone(f[0]),C&&d))){_={};for(m in d.attributes)d.attributes.hasOwnProperty(m)&&(g=C+m,_[g]=d.attributes[m]);d.attributes=_,j.attributes=t.mixin(j.attributes,d.attributes)}}I&&w&&w.length>0&&n.forEach(w,function(e){if(e){var t=j.attributes[e.name];if(c.isDefined(t)){var i=this._getDomainValue(e.domain,t);c.isDefined(i)&&(j.attributes[e.name]=i)}}},this),N.push(j),this._visibleRasters.push(j)}this._resolve([N,null,!0],null,s,l)}))}var u,h,d,m,g,b=e.value,v=e.value,x=0,R=0,y=this,T=this.objectIdField,F=[],P=i.requestParams.renderingRules,I=e.processedValues,C=this.renderingRule&&a.toJson(this._removeVisualizationStretchFunction(this.renderingRule).toJson());if(P&&I&&P.length===I.length){var V=this._rasterFieldPrefix+this._renderingRuleFieldSubPrefix;n.forEach(P,function(e,t){if(e.functionName){var i={name:V+e.functionName.replace(/ /gi,"_"),value:I[t].replace(/ /gi,"").split(",")};F.push(i),C&&C===a.toJson(e.toJson())&&(b=I[t])}})}if(m=this.infoTemplate&&this.infoTemplate.info&&this.infoTemplate.info.layerOptions&&this.infoTemplate.info.layerOptions.hasOwnProperty("showNoDataRecords")?this.infoTemplate.info.layerOptions.showNoDataRecords:!0,e.catalogItems){var S,A,M=0,k=e.catalogItems.features.length,E=0;for(h=new Array(k),u=new Array(k),d=new Array(k),x=0;k>x;x++)e.properties.Values[x].toLowerCase().indexOf("nodata")>-1&&E++;for(S=k-E,x=0;k>x;x++)g=!0,e.properties.Values[x].toLowerCase().indexOf("nodata")>-1?(A=S++,m||(g=!1,h.length--,u.length--,d.length--)):A=M++,g&&(h[A]=e.catalogItems.features[x],u[A]=e.properties.Values[x],d[A]=h[A].attributes[T])}this._visibleRasters=[];var j,L=b.toLowerCase().indexOf("nodata")>-1;if(L&&!m&&(h=[],u=[],d=[]),b&&!h&&!L){T="ObjectId",h=[];var O={};O.ObjectId=0,j=new w(new p(this.fullExtent),null,O),h.push(j)}var N=[];return h?void(!this._map.spatialReference.equals(this.spatialReference)&&d&&d.length>0?f({url:this._url.path+"/query",content:{f:"json",objectIds:d.join(","),returnGeometry:!0,outSR:a.toJson(y._map.spatialReference.toJson()),outFields:T},handleAs:"json",callbackParamName:"callback",load:function(e){if(0===e.features.length)return void y._resolve([N,null,null],null,s,l);for(x=0;x<e.features.length;x++)for(R=0;R<h.length;R++)h[R].attributes[T]==e.features[x].attributes[T]&&(h[R].geometry=new _(e.features[x].geometry),h[R].geometry.setSpatialReference(y._map.spatialReference));o.call(y)},error:function(e){y._resolve([N,null,null],null,s,l)}}):o.call(this)):void this._resolve([N,null,null],null,s,l)},getVisibleRasters:function(){var e,t=this._visibleRasters,i=[];for(e in t)t.hasOwnProperty(e)&&i.push(t[e]);return i},_getDomainFields:function(e){if(e){var t=[];return n.forEach(e,function(e){if(e.domain){var i={};i.name=e.name,i.domain=e.domain,t.push(i)}}),t}},_getDomainValue:function(e,t){if(e&&e.codedValues){var i;return n.some(e.codedValues,function(e){return e.code===t?(i=e.name,!0):!1}),i}},_requestData:function(e,i,n){this._rasterReadPromise&&this._rasterReadPromise.cancel();var a=t.clone(e),s=a._normalize(!0);this._prepareGetImageParameters(s,i,n);var r=t.clone(this._params);this._cleanupRequestParams(r),r.extent=a,r.format=r.format||(this.version>=10.3?"lerc":"jpgpng"),"lerc"===r.format.toLowerCase()&&!r.lercVersion&&this.version>=10.5&&(r.lercVersion=2);var l=this._useBrowserDecoding(),o=null;l&&(o=new T({ctx:this._context}));var u={imageServiceParameters:r,nBands:Math.min(this.bandCount,3),pixelType:this.pixelType,decodeFunc:o?t.hitch(o,"decode"):null};this._rasterReadPromise=this.raster.read(u,this._requestDataHandler,this._requestDataErrorHandler)},_requestDataHandler:function(e){this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this.originalPixelData=e,this.hasDataChanged=!0,this._setPixelData(e))},_setPixelData:function(e){var t=this._clonePixelData(e);this.pixelFilter&&this.pixelFilter(t),this.pixelData=t,this._rasterReadPromise&&this._rasterReadPromise.isCanceled()||(this._drawPixelData(),this._rasterReadPromise=null)},_clonePixelData:function(e){if(null===e||void 0===e)return e;var i={};e.extent&&(i.extent=t.clone(e.extent));var n=e.pixelBlock;return null===n||void 0===n?i:(i.pixelBlock=n.clone(),i)},_setDefaultFilter:function(){},_getPixelBlockFromCanvas:function(e,t,i){var n,a,s,r=e.getImageData(0,0,t,i).data,l=t*i,o=0,u=0,h=new Uint8Array(l),c=new Uint8Array(l),f=new Uint8Array(l),d=new Uint8Array(l),m=1/0,p=1/0,g=1/0,_=-(1/0),b=-(1/0),v=-(1/0);for(o=0;l>o;o++)n=r[u++],a=r[u++],s=r[u++],m=n>m?m:n,_=_>n?_:n,p=a>p?p:a,b=b>a?b:a,g=s>g?g:s,v=v>s?v:s,h[o]=n,c[o]=a,f[o]=s,d[o]=1&r[u++];var x=new D({width:t,height:i,pixels:[h,c,f],pixelType:"U8",mask:d,statistics:[{minValue:m,maxValue:_},{minValue:p,maxValue:b},{minValue:g,maxValue:v}]});return x},_useBrowserDecoding:function(){return(void 0===this.pixelFilter||null===this.pixelFilter)&&("jpeg"===this.format.toLowerCase()||"jpg"===this.format.toLowerCase()||this.format.toLowerCase().indexOf("png")>-1)},getMultidimensionalInfo:function(){var e=this._url.path+"/multiDimensionalInfo",n=new i(d._dfdCanceller);if(this._multidimensionalInfo)return n.resolve(this._multidimensionalInfo),n;if(this.version>=10.3&&this.hasMultidimensions)n._pendingDfd=f({url:e,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),n._pendingDfd.then(t.hitch(this,function(e){this._multidimensionalInfo=e.multidimensionalInfo,n.callback(e.multidimensionalInfo)}),function(e){n.errback(e)});else{var a=new Error("Layer does not support multidimensional info");a.log=s.isDebug,n.errback(a)}return n},getDefaultMultidimensionalDefinition:function(){var e,n,a,s,r=[],l=new i(d._dfdCanceller);return this._defaultMultidimensionalDefinition?(l.resolve(this._defaultMultidimensionalDefinition),l):(l._pendingDfd=this.getMultidimensionalInfo(),l._pendingDfd.then(t.hitch(this,function(t){e=t,n="",a=e.variables[0].dimensions;for(s in a)a.hasOwnProperty(s)&&(a[s].hasRanges?r.push(new x({variableName:n,dimensionName:a[s].name,isSlice:!1,values:[a[s].values[0]]})):r.push(new x({variableName:n,dimensionName:a[s].name,isSlice:!0,values:[a[s].extent[0]]})));this._defaultMultidimensionalDefinition=r,l.callback(r)}),function(e){l.errback(e)}),l)},_setDefaultMultidimensionalDefinition:function(e){var i,n={};this.getDefaultMultidimensionalDefinition().then(t.hitch(this,function(a){i=a,i.length>0&&(this.mosaicRule?(n=t.clone(this.mosaicRule),n.multidimensionalDefinition=i):this.defaultMosaicRule?(n=t.clone(this.defaultMosaicRule),n.multidimensionalDefinition=i):n=new b({multidimensionalDefinition:i}),this.setMosaicRule(n,e))}))},_setDefaultRenderingRule:function(e){var t={};if(!this.renderingRule&&"esri.layers.ArcGISImageServiceVectorLayer"!==this.declaredClass&&this.rasterFunctionInfos&&this.rasterFunctionInfos.length&&"none"!==this.rasterFunctionInfos[0].name.toLowerCase())t.rasterFunction=this.rasterFunctionInfos[0].name;else if(!this.renderingRule&&"esri.layers.ArcGISImageServiceVectorLayer"===this.declaredClass&&this.version>10.3){var i="esriImageServiceDataTypeVector-UV"===this.serviceDataType?7:10;t.rasterFunction="Resample",t.rasterFunctionArguments={ResamplingType:i,InputCellSize:{x:this.pixelSizeX,y:this.pixelSizeY}}}t.hasOwnProperty("rasterFunction")&&(this.defaultRenderingRule=new v(t),this.setRenderingRule(this.defaultRenderingRule,e))},_cleanupRequestParams:function(e){if(!e)return e;if(e.time&&e.mosaicRule){var t=new b(a.fromJson(e.mosaicRule));if(t&&t.multidimensionalDefinition&&t.multidimensionalDefinition.length>0){var i=n.filter(t.multidimensionalDefinition,function(e){return"StdTime"!==e.dimensionName});t.multidimensionalDefinition=i,e.mosaicRule=a.toJson(t.toJson())}}var s,r=["displayOnPan","drawMode","styling","id","opacity","visible","resourceInfo","useMapDimensionValue","extent"];for(s in r)e.hasOwnProperty(r[s])&&delete e[r[s]];return e},_removeVisualizationStretchFunction:function(e){var t=e&&e.functionName;if(!t||"stretch"!==t.toLowerCase())return e;var i=e.functionArguments.Raster;if(i&&i.functionName){var a=n.some(this.rasterFunctionInfos,function(e){return i.functionName===e.name});if(a)return i}return e},_isScientificData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType||"esriImageServiceDataTypeScientific"===this.serviceDataType},_isVectorData:function(){return"esriImageServiceDataTypeVector-UV"===this.serviceDataType||"esriImageServiceDataTypeVector-MagDir"===this.serviceDataType},_isRasterFunctionInfoAvailable:function(e){return n.some(e&&(this.rasterFunctionInfos||[]),function(t){return t&&t.name&&t.name.toLowerCase()===e.toLowerCase()})},_createPixelData:function(e){var t=new D({width:2,height:2,pixels:e,pixelType:this.pixelType,statistics:e}),i=this.fullExtent.getCenter(),n=new p(i.x,i.y,i.x+this.pixelSizeX,i.y+this.pixelSizeY,this.spatialReference),a={pixelBlock:t,extent:n};return a},_resolve:function(e,t,i,n,a){t&&this[t].apply(this,e),i&&i.apply(null,e),n&&d._resDfd(n,e,a)},_toggleTime:function(){var e=this._map;this.timeInfo&&this.useMapTime&&e&&!this.suspended?(this._timeConnect||(this._timeConnect=r.connect(e,"onTimeExtentChange",this,this._onTimeExtentChangeHandler)),this._setTime(e.timeExtent)):(r.disconnect(this._timeConnect),this._timeConnect=null,this._setTime(null))},setUseMapTime:function(e,t){this.useMapTime=e,this._toggleTime(),!t&&this._map&&this.refresh(!0)},_setTime:function(e){this._params&&(this._params.time=e?e.toJson().join(","):null)},_onTimeExtentChangeHandler:function(e){this.suspended||(this._setTime(e),this.refresh(!0))},handleSpatialReferenceChange:function(){this.onSpatialReferenceChange()}});return l("extend-esri")&&t.setObject("layers.ImageServiceLayerMixin",V,u),V});