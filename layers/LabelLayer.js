// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/number","dojo/i18n!dojo/cldr/nls/number","dojo/_base/array","dojo/_base/connect","dojo/has","dojox/gfx/_base","../kernel","../lang","../graphic","../PopupInfo","../core/timerUtils","./labelLayerUtils/DynamicLabelClass","./labelLayerUtils/StaticLabelClass","./support/attributeUtils","../symbols/TextSymbol","../symbols/ShieldLabelSymbol","../geometry/Extent","../geometry/Point","../geometry/webMercatorUtils","./GraphicsLayer","./LabelClass","../renderers/SimpleRenderer","../support/expressionUtils"],function(e,t,r,i,n,a,s,o,l,h,f,c,u,b,p,v,d,L,g,m,y,_,P,S,w,x){function C(e){return"sizeInfo"===e.type}var A=t(P,{declaredClass:"esri.layers.LabelLayer",constructor:function(e){this._refreshLabels=r.hitch(this,this._refreshLabels),this.id="labels",this.featureLayers=[],this._featureLayerInfos=[],this._preparedLabels=[],this._engineType="STATIC",this._mapEventHandlers=[],e&&(e.id&&(this.id=e.id),e.mode&&(this._engineType="DYNAMIC"===e.mode.toUpperCase()?"DYNAMIC":"STATIC"))},_setMap:function(e){this._mapEventHandlers.push(e.on("extent-change",r.hitch(this,"_handleLevelChange")));var t=this.inherited(arguments);return this.refresh(),t},_unsetMap:function(){var e;for(e=0;e<this._mapEventHandlers.length;e++)s.disconnect(this._mapEventHandlers[e]);this.refresh(),b.clearTimeout(this._refreshHandle),this._refreshHandle=null,this.inherited(arguments)},setAlgorithmType:function(e){this._engineType=e&&"DYNAMIC"===e.toUpperCase()?"DYNAMIC":"STATIC",this.refresh()},addFeatureLayer:function(e,t,i,n){if(!this.getFeatureLayer(e.layerId)){var a=[];a.push(e.on("update-end",r.hitch(this,"refresh"))),a.push(e.on("suspend",r.hitch(this,"refresh"))),a.push(e.on("resume",r.hitch(this,"refresh"))),a.push(e.on("edits-complete",r.hitch(this,"refresh"))),a.push(e.on("labeling-info-change",r.hitch(this,"refresh"))),a.push(e.on("time-extent-change",r.hitch(this,"refresh"))),a.push(e.on("show-labels-change",r.hitch(this,"refresh"))),a.push(e.on("feature-reduction-change",r.hitch(this,"refresh"))),this._featureLayerInfos.push({FeatureLayer:e,LabelExpressionInfo:i,LabelingOptions:n,LabelRenderer:t,EventHandlers:a}),this.featureLayers.push(e),this.refresh()}},getFeatureLayer:function(e){var t,r;for(t=0;t<this.featureLayers.length;t++)if(r=this.featureLayers[t],void 0!==r&&r.id==e)return r;return null},removeFeatureLayer:function(e){var t,r,i;if(r=this.getFeatureLayer(e),void 0!==r&&(i=a.indexOf(this.featureLayers,r),i>-1)){for(this.featureLayers.splice(i,1),t=0;t<this._featureLayerInfos[i].EventHandlers.length;t++)s.disconnect(this._featureLayerInfos[i].EventHandlers[t]);this._featureLayerInfos.splice(i,1),this.refresh()}},removeAllFeatureLayers:function(){var e;for(e=0;e<this.featureLayers.length;e++){for(var t=0;t<this._featureLayerInfos[e].EventHandlers.length;t++)s.disconnect(this._featureLayerInfos[e].EventHandlers[t]);this.featureLayers=[],this._featureLayerInfos=[]}this.refresh()},getFeatureLayers:function(){return this.featureLayers},getFeatureLayerInfo:function(e){var t,r;for(t=0;t<this.featureLayers.length;t++)if(r=this.featureLayers[t],void 0!==r&&r.id==e)return this._featureLayerInfos[t];return null},refresh:function(){null==this._refreshHandle&&(this._refreshHandle=b.setTimeout(this._refreshLabels,b.priority.LOW))},_handleLevelChange:function(e){e.levelChange&&this.clear(),this.refresh()},_refreshLabels:function(e){this._refreshHandle=null;var t,r,i,n,a,s,o,l,h=[],f="DYNAMIC"===this._engineType?new p:new v;if(this._map){for(f.setMap(this._map,this),this._preparedLabels=[],r=0;r<this.featureLayers.length;r++)if(i=this.featureLayers[r],i.visible&&i.showLabels&&i.visibleAtMapScale&&!i._suspended)if(n=this._featureLayerInfos[r],o=this._convertOptions(null),n.LabelRenderer){if(h=i.labelingInfo,h&&(l=h[0],l&&(s=this._getLabelExpression(l),o=this._convertOptions(l))),a=n.LabelRenderer,n.LabelExpressionInfo&&(s=n.LabelExpressionInfo),n.LabelingOptions){if(o=this._convertOptions(null),void 0!==n.LabelingOptions.pointPriorities){var c=n.LabelingOptions.pointPriorities;"above-center"==c||"AboveCenter"==c||"esriServerPointLabelPlacementAboveCenter"==c?o.pointPriorities="AboveCenter":"above-left"==c||"AboveLeft"==c||"esriServerPointLabelPlacementAboveLeft"==c?o.pointPriorities="AboveLeft":"above-right"==c||"AboveRight"==c||"esriServerPointLabelPlacementAboveRight"==c?o.pointPriorities="AboveRight":"below-center"==c||"BelowCenter"==c||"esriServerPointLabelPlacementBelowCenter"==c?o.pointPriorities="BelowCenter":"below-left"==c||"BelowLeft"==c||"esriServerPointLabelPlacementBelowLeft"==c?o.pointPriorities="BelowLeft":"below-right"==c||"BelowRight"==c||"esriServerPointLabelPlacementBelowRight"==c?o.pointPriorities="BelowRight":"center-center"==c||"CenterCenter"==c||"esriServerPointLabelPlacementCenterCenter"==c?o.pointPriorities="CenterCenter":"center-left"==c||"CenterLeft"==c||"esriServerPointLabelPlacementCenterLeft"==c?o.pointPriorities="CenterLeft":"center-right"==c||"CenterRight"==c||"esriServerPointLabelPlacementCenterRight"==c?o.pointPriorities="CenterRight":o.pointPriorities="AboveRight"}void 0!==n.LabelingOptions.lineLabelPlacement&&(o.lineLabelPlacement=n.LabelingOptions.lineLabelPlacement),void 0!==n.LabelingOptions.lineLabelPosition&&(o.lineLabelPosition=n.LabelingOptions.lineLabelPosition),void 0!==n.LabelingOptions.labelRotation&&(o.labelRotation=n.LabelingOptions.labelRotation),void 0!==n.LabelingOptions.howManyLabels&&(o.howManyLabels=n.LabelingOptions.howManyLabels)}a instanceof S&&(s=this._getLabelExpression(a),a=new w(a.symbol),o=this._convertOptions(a)),this._addLabels(i,a,s,o)}else if(h=i.labelingInfo)for(t=h.length-1;t>=0;t--)l=h[t],l&&(a=new S(l instanceof S?l.toJson():l),s=this._getLabelExpression(l),o=this._convertOptions(l),this._addLabels(i,a,s,o));var u=f._process(this._preparedLabels);this.clear(),this.drawLabels(this._map,u)}},drawLabels:function(e,t){this._scale=(e.extent.xmax-e.extent.xmin)/e.width;var r;for(r=0;r<t.length;r++){var i=t[r],n=i.layer,a=i.x,s=i.y,o=i.text,l=i.angle,h=i.layer.labelSymbol;"polyline"==n.geometry.type&&i.layer.options.labelRotation&&h.setAngle(l*(180/Math.PI)),h.setText(o);var f=a,u=s;if(h instanceof L){var b=h.getHeight(),p=Math.sin(l);f-=.25*b*this._scale*p,u-=.33*b*this._scale}var v=new c(new y(f,u,e.extent.spatialReference));v.setSymbol(h),this.add(v)}},_addLabels:function(e,t,r,i){var n,a,s,o,l=t.minScale,h=t.maxScale;if(this._isWithinScaleRange(l,h)&&r&&""!==r){var f=this._map,c=!e.url&&!f.spatialReference.equals(e.spatialReference);for(n=0;n<e.graphics.length;n++)if(a=e.graphics[n],a.visible!==!1&&!a._suspended){if(s=a.geometry,c){if(!_.canProject(s,f))continue;s=_.project(s,f)}s&&this._isWhere(t.where,a.attributes)&&this._isWithinScreenArea(s)&&(o=this._buildLabelText(r,a,e.fields,i),this._addLabel(o,t,e.renderer,a,i,s,f))}}},_isWithinScreenArea:function(e){var t;if(t="point"===e.type?new m(e.x,e.y,e.x,e.y,e.spatialReference):e.getExtent(),void 0===t)return!1;var r=this._intersects(this._map,t);return null===r||0===r.length?!1:!0},_isWithinScaleRange:function(e,t){var r=this._map.getScale();return e>0&&r>=e?!1:t>0&&t>=r?!1:!0},_isWhere:function(e,t){try{if(!e)return!0;if(e){var r=e.split(" ");if(3===r.length)return this._sqlEquation(t[this._removeQuotes(r[0])],r[1],this._removeQuotes(r[2]));if(7===r.length){var i=this._sqlEquation(t[this._removeQuotes(r[0])],r[1],this._removeQuotes(r[2])),n=r[3],a=this._sqlEquation(t[this._removeQuotes(r[4])],r[5],this._removeQuotes(r[6]));switch(n){case"AND":return i&&a;case"OR":return i||a}}}return!1}catch(s){console.log("Error.: can't parse = "+e)}},_sqlEquation:function(e,t,r){switch(t){case"=":return e==r?!0:!1;case"<>":return e!=r?!0:!1;case">":return e>r?!0:!1;case">=":return e>=r?!0:!1;case"<":return r>e?!0:!1;case"<=":return r>=e?!0:!1}return!1},_removeQuotes:function(e){var t=e.indexOf('"'),r=e.lastIndexOf('"');return-1!=t&&-1!=r?e.substr(1,e.length-2):(t=e.indexOf("'"),r=e.lastIndexOf("'"),-1!=t&&-1!=r?e.substr(1,e.length-2):e)},_getSizeInfo:function(e){return e?e.sizeInfo||a.filter(e.visualVariables,C)[0]:null},_addLabel:function(e,t,i,n,a,s,o){var h,f,c,u;if(e&&""!==r.trim(e)&&t){e=e.replace(/\s+/g," "),h=t.getSymbol(n),h instanceof L?(h=new L(h.toJson()),h.setVerticalAlignment("baseline"),h.setHorizontalAlignment("center")):h=h instanceof g?new g(h.toJson()):new L,h.setText(e),t.symbol=h;var b=this._getProportionalSize(t.sizeInfo,n.attributes);if(b&&(h instanceof L?h.setSize(b):h instanceof g&&(h.setWidth(b),h.setHeight(b))),c=0,u=0,i){f=i.getSymbol(n);var p,v=this._getSizeInfo(i);p=v?i.getSize(n,{sizeInfo:v,resolution:o.getResolutionInMeters()}):n.size,p&&null!==p?c=u=p:f&&("simplemarkersymbol"==f.type?(c=f.size,u=f.size):"picturemarkersymbol"==f.type?(c=f.width,u=f.height):("simplelinesymbol"==f.type||"cartographiclinesymbol"==f.type)&&(c=f.width))}var d={};d.graphic=n,d.options=a,d.geometry=s,d.labelRenderer=t,d.labelSymbol=h,d.labelWidth=h.getWidth()/2,d.labelHeight=h.getHeight()/2,d.symbolWidth=l.normalizedLength(c)/2,d.symbolHeight=l.normalizedLength(u)/2,d.text=e,d.angle=h.angle,this._preparedLabels.push(d)}},_buildLabelText:function(e,t,a,s){if(s.hasExpression){var o=s.arcadeCache,l=t._getDataValue(o.attributeInfo,o,x);return f.isDefined(l)?""+l:""}var h=t.attributes,c=e.replace(/{[^}]*}/g,function(e){var t,o,l,c=e;for(t=0;t<a.length;t++){if("{"+a[t].name+"}"==e){c=h[a[t].name];var b=a[t].domain;if(b&&r.isObject(b)){if("codedValue"==b.type&&s.useCodedValues){var p=c;for(l=0;l<b.codedValues.length;l++)if(b.codedValues[l].code==p){c=b.codedValues[l].name;break}}else"range"==b.type&&b.minValue<=c&&c<=b.maxValue&&(c=b.name);return null==c?"":c}var v=a[t].type;if(s.fieldInfos){var d=s.fieldInfos;for(o=0;o<d.length;o++)if("{"+d[o].fieldName+"}"==e){var L=d[o].format;if("esriFieldTypeDate"==v){var g=L.dateFormat?L.dateFormat:"shortDate",m="DateFormat"+u.prototype._dateFormats[g];m&&(c=f.substitute({myKey:c},"${myKey:"+m+"}"))}else("esriFieldTypeInteger"==v||"esriFieldTypeSingle"==v||"esriFieldTypeSmallInteger"==v||"esriFieldTypeLong"==v||"esriFieldTypeDouble"==v)&&L&&(c=i.format(c,{places:L.places}),L.digitSeparator||n.group&&(c=c.replace(new RegExp("\\"+n.group,"g"),"")));break}}break}c=""}return null==c?"":c});return c},_getLabelExpression:function(e){var t="";return e.labelExpressionInfo?t=e.labelExpressionInfo.value||e.labelExpressionInfo.expression:this._validSyntax(e.labelExpression)&&(t=this._convertLabelExpression(e.labelExpression)),t},_validSyntax:function(e){var t=/^(\s*\[[^\]]+\]\s*)+$/i;return t.test(e)},_convertLabelExpression:function(e){return e.replace(new RegExp("\\[","g"),"{").replace(new RegExp("\\]","g"),"}")},_getProportionalSize:function(e,t){if(!e)return null;var r=f.substitute(t,"${"+e.field+"}",{first:!0});if(!e.minSize||!e.maxSize||!e.minDataValue||!e.maxDataValue||!r||e.maxDataValue-e.minDataValue<=0)return null;var i=(e.maxSize-e.minSize)/(e.maxDataValue-e.minDataValue),n=i*(r-e.minDataValue)+e.minSize;return n},_convertOptions:function(e){var t,r,i=!0,n="shortDate",a=null,s=null,o="",l="AboveRight",h="PlaceAtCenter",f="Above",c=!0,u="OneLabel";if(e){e.format&&(n=e.format.dateFormat,a={places:e.format.places,digitSeparator:e.format.digitSeparator}),s=e.fieldInfos,o=e.labelPlacement,null!=e.useCodedValues&&(i=e.useCodedValues);var b=e.labelExpressionInfo;if(b){var p=b.expression;p&&!b.value&&(r=!0,t=d.createAttributeCache({valueExpression:p},!0))}}return l="above-center"==o||"esriServerPointLabelPlacementAboveCenter"==o?"AboveCenter":"above-left"==o||"esriServerPointLabelPlacementAboveLeft"==o?"AboveLeft":"above-right"==o||"esriServerPointLabelPlacementAboveRight"==o?"AboveRight":"below-center"==o||"esriServerPointLabelPlacementBelowCenter"==o?"BelowCenter":"below-left"==o||"esriServerPointLabelPlacementBelowLeft"==o?"BelowLeft":"below-right"==o||"esriServerPointLabelPlacementBelowRight"==o?"BelowRight":"center-center"==o||"esriServerPointLabelPlacementCenterCenter"==o?"CenterCenter":"center-left"==o||"esriServerPointLabelPlacementCenterLeft"==o?"CenterLeft":"center-right"==o||"esriServerPointLabelPlacementCenterRight"==o?"CenterRight":"AboveRight",h="above-start"==o||"below-start"==o||"center-start"==o?"PlaceAtStart":"above-end"==o||"below-end"==o||"center-end"==o?"PlaceAtEnd":"PlaceAtCenter",f="above-after"==o||"esriServerLinePlacementAboveAfter"==o||"above-along"==o||"esriServerLinePlacementAboveAlong"==o||"above-before"==o||"esriServerLinePlacementAboveBefore"==o||"above-start"==o||"esriServerLinePlacementAboveStart"==o||"above-end"==o||"esriServerLinePlacementAboveEnd"==o?"Above":"below-after"==o||"esriServerLinePlacementBelowAfter"==o||"below-along"==o||"esriServerLinePlacementBelowAlong"==o||"below-before"==o||"esriServerLinePlacementBelowBefore"==o||"below-start"==o||"esriServerLinePlacementBelowStart"==o||"below-end"==o||"esriServerLinePlacementBelowEnd"==o?"Below":"center-after"==o||"esriServerLinePlacementCenterAfter"==o||"center-along"==o||"esriServerLinePlacementCenterAlong"==o||"center-before"==o||"esriServerLinePlacementCenterBefore"==o||"center-start"==o||"esriServerLinePlacementCenterStart"==o||"center-end"==o||"esriServerLinePlacementCenterEnd"==o?"OnLine":"Above",("always-horizontal"==o||"esriServerPolygonPlacementAlwaysHorizontal"==o)&&(c=!1),{useCodedValues:i,dateFormat:n,numberFormat:a,fieldInfos:s,pointPriorities:l,lineLabelPlacement:h,lineLabelPosition:f,labelRotation:c,howManyLabels:u,hasExpression:r,arcadeCache:t}}});return o("extend-esri")&&r.setObject("layers.LabelLayer",A,h),A});