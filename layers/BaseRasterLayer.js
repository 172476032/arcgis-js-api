// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/connect","dojo/_base/array","dojo/sniff","dojo/dom-construct","dojo/dom-style","../lang","../domUtils","../geometry/Point","./layer"],function(t,i,e,n,s,a,h,o,r,c,d){var _=t([d],{declaredClass:"esri.layers.BaseRasterLayer",managedSuspension:!0,opacity:1,constructor:function(t,i){this.drawMode=i&&void 0!==i.drawMode?i.drawMode:!0,this.drawType=i&&i.drawType?i.drawType:"2d",this.pixelData=null,this._initialize(t,i)},setDrawMode:function(t){this.drawMode=t},setOpacity:function(t){this.opacity!==t&&(this.opacity=t,this.onOpacityChange(t))},onOpacityChange:function(){},refresh:function(){return!this._canDraw()||s("ie")<10?void this.onError(new Error("Unable to refresh. This layer is not supported in the current browser.")):void(this._map&&this._extentChangeHandler(this._map.extent))},clear:function(){this._canDraw()&&"2d"===this.drawType&&this._context.clearRect(0,0,this._mapWidth,this._mapHeight)},getContext:function(){return this._context},onResume:function(){this.inherited(arguments),this._toggleTime(),this._displayTimer=this._displayTimer||setTimeout(i.hitch(this,function(){this._extentChangeHandler(this._map.extent,null,!0)}),0)},onSuspend:function(){this.inherited(arguments),this._toggleTime(),clearTimeout(this._displayTimer),this._displayTimer=null},redraw:function(){this.hasDataChanged=!1,this._setPixelData(this.originalPixelData)},getCurrentResolution:function(){var t=this._map.extent,i=new c((t.xmax-t.xmin)/this._map.width,(t.ymax-t.ymin)/this._map.height,t.spatialReference);return i},setPixelFilter:function(t,i){this.pixelFilter=t,i||this.redraw()},_toggleTime:function(){},_setMap:function(t,i){this.inherited(arguments);var n=this._canvas=a.create("canvas",{id:"canvas",width:t.width+"px",height:t.height+"px",style:"position: absolute; left: 0px; top: 0px;"},i);if(o.isDefined(this.opacity)&&h.set(n,"opacity",this.opacity),this._context=n.getContext(this.drawType),this._context||console.error("Unable to create the context. This browser might not support <canvas> elements."),this._mapWidth=t.width,this._mapHeight=t.height,this._connects=[],this._connects.push(e.connect(t,"onPan",this,this._panHandler)),this._connects.push(e.connect(t,"onPanEnd",this,this._panEndHandler)),this._connects.push(e.connect(t,"onZoom",this,this._onZoomHandler)),this._connects.push(e.connect(t,"onZoomEnd",this,this._onZoomEndHandler)),this._connects.push(e.connect(t,"onResize",this,this._onResizeHandler)),this._connects.push(e.connect(t,"onExtentChange",this,this._extentChangeHandler)),this._connects.push(e.connect(this,"onVisibilityChange",this,this._visibilityChangeHandler)),this._connects.push(e.connect(this,"onOpacityChange",this,this._opacityChangeHandler)),this._startRect={left:0,top:0,width:t.width,height:t.height},this.evaluateSuspension(),this.suspended&&!t.loaded)var s=e.connect(t,"onLoad",this,function(){e.disconnect(s),s=null,this.evaluateSuspension()});return n},_unsetMap:function(t,i){n.forEach(this._connects,e.disconnect,this),this._canvas&&i.removeChild(this._canvas),this._map=this._canvas=this._context=this.data=this._connects=null,clearTimeout(this._displayTimer),this._displayTimer=null,this.inherited(arguments)},_canDraw:function(){return!!(this._map&&this._canvas&&this._context)},_requestDataErrorHandler:function(t){"CancelError"!==t.name&&(this.clear(),this.onError(t))},_drawPixelData:function(){if(h.set(this._canvas,{left:"0px",top:"0px",width:this._map.width+"px",height:this._map.height+"px"}),this._startRect={left:0,top:0,width:this._map.width,height:this._map.height},this._canDraw&&this.drawMode){var t=this._useBrowserDecoding();if(t)return void this._fireUpdateEnd();if(this.drawMode){if(!this.pixelData||!this.pixelData.pixelBlock)return void this.clear();var i=this.pixelData.pixelBlock,e=this._context,n=e.createImageData(i.width,i.height);n.data.set(i.getAsRGBA());var s=this.pixelData.extent,a=this._map.extent,o=this.getCurrentResolution(),r={x:0,y:0};Math.abs(s.xmin-a.xmin)>o.x&&(r.x=Math.round((s.xmin-a.xmin)/o.x)),Math.abs(a.ymax-s.ymax)>o.y&&(r.y=Math.round((a.ymax-s.ymax)/o.y)),this.clear(),e.putImageData(n,r.x,r.y,0,0,i.width,i.height),this._fireUpdateEnd()}}},_panHandler:function(t,i){h.set(this._canvas,{left:this._startRect.left+i.x+"px",top:this._startRect.top+i.y+"px"})},_panEndHandler:function(t,i){i&&(this._startRect.left+=i.x,this._startRect.top+=i.y)},_onZoomHandler:function(t,i,e){var n=this._startRect,s=n.width*i,a=n.height*i,o=n.left-(s-n.width)*(e.x-n.left)/n.width,r=n.top-(a-n.height)*(e.y-n.top)/n.height;h.set(this._canvas,{left:o+"px",top:r+"px",width:s+"px",height:a+"px"}),this._endRect={left:o,top:r,width:s,height:a}},_onZoomEndHandler:function(){this._endRect&&(this._startRect=this._endRect)},_onResizeHandler:function(t,i,e){h.set(this._canvas,{width:i+"px",height:e+"px"}),this._startRect.width=this._canvas.width=i,this._startRect.height=this._canvas.height=e},_extentChangeHandler:function(t,i,e,n){if(!this.suspended&&(!i||0!==i.x||0!==i.y||e)){this._fireUpdateStart();var s=this._map;this._requestData(s.extent,s.width,s.height)}},_visibilityChangeHandler:function(t){t?r.show(this._canvas):r.hide(this._canvas)},_opacityChangeHandler:function(t){h.set(this._canvas,"opacity",t)}});return _});