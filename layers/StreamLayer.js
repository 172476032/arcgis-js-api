// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","dojo/_base/lang","dojo/Deferred","../core/sniff","../core/Collection","../core/Logger","../Graphic","../geometry/SpatialReference","../geometry/Extent","./FeatureLayer","./support/arcgisLayerUrl"],function(e,r,t,i,o,s,n,a,l,c,u){var h=s.getLogger("esri.layers.StreamLayer"),d=c.createSubclass({declaredClass:"esri.layers.StreamLayer",viewModulePaths:{"2d":"../views/2d/layers/StreamLayerView2D","3d":"../views/3d/layers/StreamLayerView3D"},constructor:function(e,r){this._set("type","stream"),this._set("operationalLayerType","ArcGISStreamLayer"),"WebSocket"in window||(this.loadError=new Error("WebSocket is not supported in this browser"),console.log("WebSocket is not supported in this browser. StreamLayer will not have real-time connection with the stream service."))},normalizeCtorArgs:function(e,t){return"string"==typeof e?r.mixin({},{url:e},t):e&&e.layerDefinition?r.mixin({},{collectionLayer:e},t):(e&&e.filter&&(e.filter=this._makeFilter({where:e.filter.where||null,geometry:e.filter.geometry||null}),delete e.geometryDefinition,delete e.definitionExpression),e)},getDefaults:function(e){return r.mixin(this.inherited(arguments)||{},{purgeOptions:{displayCount:2e3},outFields:["*"]})},properties:{definitionExpression:{value:null,get:function(){return console.warn("StreamLayer.definitionExpression is deprecated. Access the filter.where property"),this.filter.where},set:function(e){console.warn("StreamLayer.definitionExpression is deprecated. Use the updateFilter method to change the attribute filter");var r=this._makeFilter({where:e});this._set("filter",r)}},geometryDefinition:{value:null,get:function(){return console.warn("StreamLayer.geometryDefinition is deprecated. Access the filter.geometry property"),this.filter.geometry},set:function(e){console.warn("StreamLayer.geometryDefinition is deprecated. Use the updateFilter method to change the spatial filter");var r=this._makeFilter({geometry:e});this._set("filter",r)}},filter:{value:{geometry:null,where:null},constructOnly:!0},maxReconnectAttempts:10,maximumTrackPoints:1,operationalLayerType:"ArcGISStreamLayer",purgeOptions:{value:null,set:function(e){var r=this._get("purgeOptions"),t={},i=!1;if(e&&"object"==typeof e&&r!==e)return e.hasOwnProperty("displayCount")&&e.displayCount>0&&(t.displayCount=e.displayCount,i=!0),e.hasOwnProperty("age")&&e.age>=0&&(t.age=e.age,i=!0),i?this._set("purgeOptions",t):void 0}},socketDirection:"subscribe",spatialReference:{value:a.WGS84,type:a,json:{origins:{service:{read:{source:"spatialReference"}}}}},type:{value:"stream",json:{read:!1}},url:{set:function(e){var r=u.sanitizeUrlWithLayerId(this,e,h);this._set("url",r.url),null!=r.layerId&&this._set("layerId",r.layerId)}}},createGraphicsSource:function(){var i=new t;return e(["./graphics/sources/StreamLayerSource"],r.hitch(this,function(e){var t=new e({layer:this});t.when(r.hitch(this,function(){this.emit("graphics-source-create",{graphicsSource:t}),i.resolve(t)}),function(e){i.reject(e)})})),i.promise},createGraphicsController:function(i){var s=new t,a="./graphics/controllers/StreamController",l=i.layerView,c=l.view.map,u=o.ofType(n),h=c.view===l.view?this.graphics:new u,d=r.mixin(i.options||{},{layer:this,layerView:l,graphics:h});return a?e([a],r.hitch(this,function(e){var t=new e(d);t.when(r.hitch(this,function(){this.emit("graphics-controller-create",{graphicsController:t}),s.resolve(t)}),function(e){s.reject(e)})})):s.reject(new Error('Module path not found for controller type: "'+this.mode+'"')),s.promise},loadFromPortal:function(e){return e=r.mixin(e,{supportedTypes:["Stream Service"]}),this.inherited(arguments,[e])},updateFilter:function(e){var r=new t;try{var i=this._makeFilter(e);this._set("filter",i),r.resolve({filter:this.filter})}catch(o){r.reject(o)}return r.promise},_initLayerProperties:function(e){this.source=e;var r=this.source.relatedFeaturesInfo;r&&(this.objectIdField=r.joinField,this.source.relatedFeaturesInfo.outFields=this.outFields?this.outFields.splice(0):null);var t=e.layerDefinition;if(this.read(t,{origin:"service",url:this.parsedUrl}),r&&r.outFields&&"*"!==r.outFields[0]){var o=r.outFields.map(function(e){return e.toLowerCase()}),s=this.requiredFields||[];s.forEach(function(e){-1===o.indexOf(e.toLowerCase())&&r.outFields.push(e)})}t._ssl&&(this.url=this.url.replace(this.reHttp,"https:")),this._verifyFields(),this._addSymbolUrlTokens(),this.useQueryTimestamp=i("ie")||i("safari")},_makeFilter:function(e){var r;if(e){var t,i=e.hasOwnProperty("where")?e.where:this.filter.where;if(e.hasOwnProperty("geometry")){if(t=e.geometry,t&&!t.hasOwnProperty("xmin"))throw console.log("geometry is not an extent: ",t),new Error("Cannot set filter. Only Extent is supported for the geometry filter");t&&!t.declaredClass&&(t=new l(t))}else t=this.filter.geometry;r={where:i,geometry:t}}else r={geometry:null,where:null};return r},_readObjectIdField:function(e){if(e.objectIdField)return e.objectIdField;if(e.fields){for(var r,t=e.fields,i=0,o=t.length;o>i;i++){var s=t[i];if("esriFieldTypeOID"===s.type){r=s.name;break}}if(!r){var n=1,a="objectid",l=[];if(t.forEach(function(e){e.name.split("_")[0]===a&&l.push(e.name)}),l.length)for(;-1!==l.indexOf(a+"_"+n);)n+=1;r=a+"_"+n}return r}},_verifyFields:function(){var e=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("StreamLayer: 'objectIdField' property is not defined (url: "+e+")")}});return d});