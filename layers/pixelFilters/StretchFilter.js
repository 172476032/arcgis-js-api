// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","../PixelBlock"],function(t,i,s){"use strict";var e;return t(null,{stretchType:0,min:0,max:255,numberOfStandardDeviations:2,statistics:null,histograms:null,dra:!1,minPercent:.25,maxPercent:.5,useGamma:!1,gamma:null,raster:null,outputPixelType:"U8",constructor:function(t){this.stretchType=t.stretchType||t.StretchType||this.stretchType,this.min=t.min||t.Min||this.min,this.max=t.max||t.Max||this.max,this.numberOfStandardDeviations=t.numberOfStandardDeviations||t.NumberOfStandardDeviations||this.numberOfStandardDeviations,this.statistics=t.statistics||t.Statistics||this.statistics,this.dra=t.dra||t.DRA||t.dRA||this.dra,this.minPercent=t.minPercent||t.MinPercent||this.minPercent,this.maxPercent=t.maxPercent||t.MaxPercent||this.maxPercent,this.useGamma=t.useGamma||t.UseGamma||this.useGamma,this.gamma=t.gamma||t.Gamma||this.gamma,this.raster=t.raster||t.Raster||this.raster,this.outputPixelType=t.outputPixelType||t.OutputPixelType||this.outputPixelType,this.raster=t.raster||t.Raster||this.raster,e=this},filter:function(t){if(null!==t&&null!==t.pixelBlock&&null!==t.pixelBlock.pixels){var i,s,a=t.pixelBlock,r=a.pixels,n=a.width*a.height,o=r.length,l=6===e.stretchType||3===e.stretchType&&e.dra;if(l&&e._calculateStatisticsHistograms(t),e.dra)if(l)e._statistics=a.statistics,e._histograms=a.histograms;else{var h=a.statistics;for(e._statistics=[],i=0;o>i;i++)e._statistics[i]=[h[i].minValue,h[i].maxValue,0,0]}else e._statistics=e.statistics,e._histograms=e.histograms;if(e._createLUT(t),void 0===e.LUT||null===e.LUT)return e._filterNoLUT(t);var m,f,u=e.LUT,c=e.LUTOffset;for(i=0;o>i;i++)for(f=u[i],s=0;n>s;s++)m=r[i][s],r[i][s]=f[m-c];return t.pixelBlock.pixelType="U8",t}},_calculateStatisticsHistograms:function(t){var s,e,a,r,n,o,l,h,m,f,u,c,p,x,g,_,d,T=t.pixelBlock,y=T.pixelType,U=T.pixels,M=T.mask,S=U.length,v=function(t){this.min=-.5,this.max=255.5,this.size=256,i.mixin(this,t),this.counts=this.counts||new Uint32Array(this.size)},P=[];for(r=0;S>r;r++){if(o=new v,l=o.counts,m=U[r],"U8"===y)if(M)for(n=0;n<T.width*T.height;n++)M[n]&&l[m[n]]++;else for(n=0;n<T.width*T.height;n++)l[m[n]]++;else{if(s=T.statistics[r].minValue,e=T.statistics[r].maxValue,o.min=s,o.max=e,a=(e-s)/256,h=new Uint32Array(257),M)for(n=0;n<T.width*T.height;n++)M[n]&&h[Math.floor((m[n]-s)/a)]++;else for(n=0;n<T.width*T.height;n++)h[Math.floor((m[n]-s)/a)]++;for(n=0;255>n;n++)l[n]=h[n];l[255]=h[255]+h[256]}for(P.push(o),f=[],s=T.statistics[r].minValue,e=T.statistics[r].maxValue,u=0,c=0,g=0,n=0;n<o.size;n++)u+=l[n],c+=n*l[n];for(_=c/u,n=0;n<o.size;n++)g+=l[n]*Math.pow(n-_,2);d=Math.sqrt(g/(u-1)),p=(_+.5)*(o.max-o.min)/o.size+o.min,x=d*(o.max-o.min)/o.size,f.push(s),f.push(e),f.push(p),f.push(x),T.statistics[r]=f}T.histograms=P},_getCutOffPoints:function(t){var i,s,a,r,n,o,l,h=t.pixelBlock.pixels,m=h.length,f=[],u=[];switch(e.stretchType){case 5:for(o=0;m>o;o++)f[o]=e._statistics[o][0],u[o]=e._statistics[o][1];break;case 3:for(o=0;m>o;o++)f[o]=e._statistics[o][2]-e.numberOfStandardDeviations*e._statistics[o][3],u[o]=e._statistics[o][2]+e.numberOfStandardDeviations*e._statistics[o][3],f[o]<e._statistics[o][0]&&(f[o]=e._statistics[o][0]),u[o]>e._statistics[o][1]&&(u[o]=e._statistics[o][1]);break;case 6:for(o=0;m>o;o++){for(i=e._histograms[o],r=new Uint32Array(i.size),a=i.counts,s=0,l=0;l<i.size;l++)s+=a[l],r[l]=s;for(n=e.minPercent*s/100,l=1;l<i.size;l++)if(r[l]>n){f[o]=i.min+(i.max-i.min)/i.size*(l-.5);break}for(n=(1-e.maxPercent/100)*s,l=i.size-2;l>=0;l--)if(r[l]<n){u[o]=i.min+(i.max-i.min)/i.size*(l+.5);break}}break;default:for(o=0;m>o;o++)f[o]=0,u[o]=255}return{minCutOff:f,maxCutOff:u}},_createLUT:function(t){var i=t.pixelBlock,s=i.pixelType,a="U8"===s||"U16"===s||"S8"===s||"S16"===s;if(a){if(e._LUTSignature){var r=e._computeLutSignature(),n=r.length===e._LUTSignature.length&&!r.some(function(t,i){return t!==e._LUTSignature[i]});if(n)return}var o,l,h,m,f,u=i.pixels,c=u.length,p=[],x=[],g=[],_=[],d=e.max,T=e.min,y=e.gamma,U=d-T,M=e._getCutOffPoints(t),S=M.minCutOff,v=M.maxCutOff,P=0,w=256;for("S8"===i.pixelType?P=-127:"S16"===i.pixelType&&(P=-32767),("U16"===i.pixelType||"S16"===i.pixelType)&&(w=65536),o=0;c>o;o++)x[o]=v[o]-S[o],p[o]=U/(v[o]-S[o]);if(e.useGamma&&null!==y&&y.length===c)for(o=0;c>o;o++)y[o]>1?y[o]>2?_[o]=6.5+Math.pow(y[o]-2,2.5):_[o]=6.5+100*Math.pow(2-y[o],4):_[o]=1;if(e.useGamma){var O;for(o=0;c>o;o++){for(f=[],l=0;w>l;l++)h=l+P,O=(h-S[o])/x[o],m=1,y[o]>1&&(m-=Math.pow(1/U,O*_[o])),h<v[o]&&h>S[o]?f[l]=Math.floor(m*U*Math.pow(O,1/y[o]))+T:h>v[o]?f[l]=d:h<S[o]&&(f[l]=T);g[o]=f}}else for(o=0;c>o;o++){for(f=[],l=0;w>l;l++)h=l+P,h<S[o]?f[l]=T:h>v[o]?f[l]=d:f[l]=Math.floor((h-S[o])/x[o]*U)+T;g[o]=f}e.LUT=g,e.LUTOffset=P,e._LUTSignature=e._computeLutSignature()}},_computeLutSignature:function(){var t,i,s=[];if(s.push(e.stretchType),s.push(e.min),s.push(e.max),s.push(e.numberOfStandardDeviations),e._statistics)for(t=0;t<e._statistics.length;t++)for(i=0;i<e._statistics[t].length;i++)s.push(e._statistics[t][i]);if(s.push(e.dra?1:0),s.push(e.minPercent),s.push(e.maxPercent),e.gamma)for(t=0;t<e._statistics.length;t++)s.push(e.gamma[t]);return s.push(e.useGamma?1:0),s},_filterNoLUT:function(t){if(null!==t&&null!==t.pixelBlock&&null!==t.pixelBlock.pixels){var i,s,a,r,n,o=t.pixelBlock,l=o.pixels,h=o.mask,m=o.width*o.height,f=l.length,u=[],c=[],p=[],x=e.max,g=e.min,_=e.gamma,d=x-g,T=e._getCutOffPoints(t),y=T.minCutOff,U=T.maxCutOff;for(i=0;f>i;i++)c[i]=U[i]-y[i],u[i]=d/(U[i]-y[i]);if(e.useGamma&&null!==_&&_.length===f)for(i=0;f>i;i++)_[i]>1?_[i]>2?p[i]=6.5+Math.pow(_[i]-2,2.5):p[i]=6.5+100*Math.pow(2-_[i],4):p[i]=1;if(e.useGamma)if(void 0!==h&&null!==h){for(s=0;m>s;s++)if(h[s])for(i=0;f>i;i++)a=l[i][s],n=(a-y[i])/c[i],r=1,_[i]>1&&(r-=Math.pow(1/d,n*p[i])),a<U[i]&&a>y[i]?l[i][s]=Math.floor(r*d*Math.pow(n,1/_[i]))+g:a>U[i]?l[i][s]=x:a<y[i]&&(l[i][s]=g)}else for(s=0;m>s;s++)for(i=0;f>i;i++)a=l[i][s],n=(a-y[i])/c[i],r=1,_[i]>1&&(r-=Math.pow(1/d,n*p[i])),a<U[i]&&a>y[i]?l[i][s]=Math.floor(r*d*Math.pow(n,1/_[i]))+g:a>U[i]?l[i][s]=x:a<y[i]&&(l[i][s]=g);else if(void 0!==h&&null!==h){for(s=0;m>s;s++)if(h[s])for(i=0;f>i;i++)a=l[i][s],a<U[i]&&a>y[i]?l[i][s]=Math.floor((a-y[i])/c[i]*d)+g:a>U[i]?l[i][s]=x:a<y[i]&&(l[i][s]=g)}else for(s=0;m>s;s++)for(i=0;f>i;i++)a=l[i][s],a<U[i]&&a>y[i]?l[i][s]=Math.floor((a-y[i])/c[i]*d)+g:a>U[i]?l[i][s]=x:a<y[i]&&(l[i][s]=g);return t.pixelBlock.pixelType="U8",t}}})});