// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/Error","../../../core/LRUMap","../../../core/Logger","../../../core/promiseUtils","../../../core/sql/WhereClause","../../../core/libs/rbush/rbush","../../../geometry","../../../geometry/support/webMercatorUtils","../../../geometry/support/normalizeUtils"],function(e,t,r,n,i,a,u,o,s,l,p){var m=i.getLogger("esri.layers.graphics.stores.SparseFeatureStore");m.level="warn";var y="spatial-index",c=new n(25),h=function(){function e(e){var t=this;this._attributesMap=new Map,this._fieldsMap=new Map,this.objectIdField=e.objectIdField,this.spatialReference=e.spatialReference,this._numFeatures=e.numFeatures,this._readCoordinates=e.readCoordinates,this._readFeatureAttributes=e.readFeatureAttributes,e.fields.forEach(function(e){t._fieldsMap.set(e.name,e),t._fieldsMap.set(e.name.toLowerCase(),e)})}return e.prototype.destroy=function(){this._spatialIndex.clear(),this._spatialIndex=null},e.prototype.execute=function(e){var t=this;return this._normalizeQueryGeometry(e).then(function(e){return a.all([t._checkQuerySupport(e),t._buildSpatialIndex()])}).then(function(e){var r=e[0],n=e[1],i=t._getWhereFilter(r),a=t._getCreateFeature(r);if(r.geometry){for(var u=t._getQueryBoundList(r.geometry),o=[],s=0,l=u;s<l.length;s++)for(var p=l[s],m=n.search({minX:p[0],minY:p[1],maxX:p[2],maxY:p[3]}).filter(i),y=0,c=m;y<c.length;y++){var h=c[y];o.push(a(h))}return o}return n.all().filter(i).map(a)}).then(function(r){return t._createQueryResponse(e,r)})},e.prototype.executeForCount=function(e){var t=this;return this._normalizeQueryGeometry(e).then(function(e){return a.all([t._checkQuerySupport(e),t._buildSpatialIndex()])}).then(function(e){var r=e[0],n=e[1],i=t._getWhereFilter(r);if(r.geometry){for(var a=t._getQueryBoundList(r.geometry),u=0,o=0,s=a;o<s.length;o++){var l=s[o],p=n.search({minX:l[0],minY:l[1],maxX:l[2],maxY:l[3]}).filter(i);u+=p.length}return u}return n.all().filter(i).length})},e.prototype.executeForExtent=function(e){var t=this;return this._normalizeQueryGeometry(e).then(function(e){return a.all([t._checkQuerySupport(e),t._buildSpatialIndex()])}).then(function(e){var r=e[0],n=e[1],i=t._getWhereFilter(r),a={xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,ymax:Number.NEGATIVE_INFINITY},u=0;if(r.geometry)for(var o=t._getQueryBoundList(r.geometry),l=0,p=o;l<p.length;l++){for(var m=p[l],y=n.search({minX:m[0],minY:m[1],maxX:m[2],maxY:m[3]}).filter(i),c=0,h=y;c<h.length;c++){var f=h[c],d=f[0],g=f[1];a.xmin=Math.min(d,a.xmin),a.ymin=Math.min(g,a.ymin),a.xmax=Math.max(d,a.xmax),a.ymax=Math.max(g,a.ymax)}u+=y.length}else{var y=n.all().filter(i);u+=y.length;for(var x=0,_=y;x<_.length;x++){var v=_[x],d=v[0],g=v[1];a.xmin=Math.min(d,a.xmin),a.ymin=Math.min(g,a.ymin),a.xmax=Math.max(d,a.xmax),a.ymax=Math.max(g,a.ymax)}}return{count:u,extent:new s.Extent(a)}})},e.prototype.executeForIds=function(e){var t=this;return this._normalizeQueryGeometry(e).then(function(e){return a.all([t._checkQuerySupport(e),t._buildSpatialIndex()])}).then(function(e){var r=e[0],n=e[1],i=t._attributesMap,a=t.objectIdField,u=t._getWhereFilter(r);if(r.geometry){for(var o=t._getQueryBoundList(r.geometry),s=[],l=0,p=o;l<p.length;l++)for(var m=p[l],y=n.search({minX:m[0],minY:m[1],maxX:m[2],maxY:m[3]}).filter(u),c=0,h=y;c<h.length;c++){var f=h[c];s.push(i.get(f)[a])}return s}return n.all().filter(u).map(function(e){return i.get(e)[a]})})},e.prototype._normalizeQueryGeometry=function(e){var t=e.geometry?[e.geometry]:[];return p.normalizeCentralMeridian(t).then(function(t){return e.clone().set("geometry",t[0])})},e.prototype._checkQuerySupport=function(e){var t=this._isSupportedQuery(e);return t?a.reject(t):e},e.prototype._isSupportedQuery=function(e){var t=this;if(null!=e.distance||null!=e.geometryPrecision||e.groupByFieldsForStatistics&&e.groupByFieldsForStatistics.length||null!=e.maxAllowableOffset||e.multipatchOption||null!=e.num||e.orderByFields&&e.orderByFields.length||e.outSpatialReference&&!l.canProject(e.outSpatialReference,this.spatialReference)||e.outStatistics&&e.outStatistics.length||e.pixelSize||e.relationParameter||e.returnDistinctValues||null!=e.start||e.text||e.timeExtent)return new r(y+":unsupported-query","Unsupported query");var n=e.where;if(n&&"1=1"!==n){var i=void 0;if(c.has(n)?i=c.get(n):(i=u.create(n),c.set(n,i)),!i.isStandardized())return new r(y+":unsupported-query","where clause is using non standard function");var a=i.getFields(),o=a.every(function(e){return t._fieldsMap.has(e)});if(!o)return new r(y+":unsupported-query","where clause is using unknown field")}var s=e.geometry;if(!s)return null;if("extent"!==s.type&&"polygon"!==s.type)return new r(y+":unsupported-query","Unsupported query geometry type: "+s.type);if("polygon"===s.type){var p=s.rings;if(2===p.length){var m=p.every(function(e){return 5!==e.length?!1:e[0][0]===e[1][0]&&e[0][0]===e[4][0]&&e[2][0]===e[3][0]&&e[0][1]===e[3][1]&&e[0][1]===e[4][1]&&e[1][1]===e[2][1]});return m?null:new r(y+":unsupported-query","Unsupported query geometry")}return new r(y+":unsupported-query","Unsupported query geometry")}return null},e.prototype._getWhereFilter=function(e){var t=this,r=e.where;if(c.has(r)){var n=c.get(r);if(n.isStandardized())return function(e){return n.testFeature(t._attributesMap.get(e))}}return function(e){return!0}},e.prototype._getCreateFeature=function(e){var t=this._attributesMap,r=e.quantizationParameters,n=e.returnGeometry;if(!n)return function(e){return{attributes:t.get(e)}};var i,a;if(r){var u=r.extent.xmin,o=r.extent.ymax,s=r.tolerance;i=function(e){return Math.round((e-u)/s)},a=function(e){return Math.round((o-e)/s)}}else i=a=function(e){return e};return function(e){return{geometry:{x:i(e[0]),y:a(e[1])},attributes:t.get(e)}}},e.prototype._getQueryBoundList=function(e){return"extent"===e.type?[[e.xmin,e.ymin,e.xmax,e.ymax]]:"polygon"===e.type?e.rings.map(function(e){var t=[e[0][0],e[0][1],e[2][0],e[2][1]];return t}):void 0},e.prototype._buildSpatialIndex=function(){if(this._spatialIndex)return a.resolve(this._spatialIndex);var e=this._numFeatures,t=this._attributesMap,r=this._spatialIndex=o(9,["[0]","[1]","[0]","[1]"]),n=this._readCoordinates(0,e);r.load(n);for(var i=0;e>i;i++)t.set(n[i],this._readFeatureAttributes(i));return a.resolve(r)},e.prototype._createQueryResponse=function(e,t){var r=this,n=e.outFields,i=e.outSpatialReference,a=e.quantizationParameters;return{features:t,fields:n.map(function(e){return r._fieldsMap.get(e)}),geometryType:"esriGeometryPoint",objectIdFieldName:this.objectIdField,spatialReference:i?i.toJSON():this.spatialReference.toJSON(),transform:a?{originPosition:"upperLeft",scale:[a.tolerance,a.tolerance],translate:[a.extent.xmin,a.extent.ymax]}:null}},e}();return h});