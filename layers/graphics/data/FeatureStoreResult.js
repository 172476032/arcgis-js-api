// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","@dojo/shim/array","@dojo/shim/Set","../../../core/promiseUtils","../../../geometry/support/quantizationUtils","../../../geometry/support/spatialReferenceUtils","./attributeSupport","./FeatureStoreItem","./projectionSupport"],function(e,t,r,i,s,a,n,o,u,l){function c(e){return e?JSON.parse(JSON.stringify(e,["latestWkid","wkid","wkt"])):e}Object.defineProperty(t,"__esModule",{value:!0});var p=function(){function e(e,t){this.items=e,this.definitionExpression=t.definitionExpression,this.geometryType=t.geometryType,this.hasM=t.hasM,this.hasZ=t.hasZ,this.objectIdField=t.objectIdField,this.spatialReference=t.spatialReference,this.fieldsMap=t.fieldsMap}return Object.defineProperty(e.prototype,"size",{get:function(){return this.items.length},enumerable:!0,configurable:!0}),e.prototype.createQueryResponse=function(e){return e.outStatistics?this._createStatisticsQueryResponse(e):this._createFeatureQueryResponse(e)},e.prototype.executeAttributesQuery=function(e){var t=o.getWhereClause(e.where);if(!t)return s.resolve(this);if(t.isStandardized()){for(var r=0,i=[],a=0,n=this.items;a<n.length;a++){var u=n[a];t.testFeature(u.getAttributes())&&(i[r++]=u)}var l=this._createNew(i);return l.definitionExpression=e.where,s.resolve(l)}return s.reject(new TypeError("Where clause is not standardized"))},e.prototype.executeObjectIdsQuery=function(e){if(!e.objectIds||!e.objectIds.length)return s.resolve(this);var t=new i.default(e.objectIds);return s.resolve(this._createNew(this.items.filter(function(e){return t.has(e.oid)})))},e.prototype.project=function(t){var i=this;return!t||n.equals(this.spatialReference,t)?s.resolve(this):l.projectMany(this.items.map(function(e){return e.getGeometry()}),this.spatialReference,t).then(function(s){for(var a=[],n=0;n<i.items.length;n++)a[n]={attributes:i.items[n].getAttributes(),geometry:s[n]};return new e(u.createFromFeatureSet({fields:r.from(i.fieldsMap.values()),spatialReference:t,geometryType:i.geometryType,hasM:i.hasM,hasZ:i.hasZ,features:a,objectIdFieldName:i.objectIdField}),{definitionExpression:i.definitionExpression,geometryType:i.geometryType,hasM:i.hasM,hasZ:i.hasZ,objectIdField:i.objectIdField,spatialReference:t,fieldsMap:i.fieldsMap})})},e.prototype._createFeatureQueryResponse=function(e){var t=this,r=this.items,i=this,s=i.geometryType,n=i.hasM,o=i.hasZ,u=i.objectIdField,l=i.spatialReference,p=e.outFields,f=e.outSpatialReference,h=e.quantizationParameters,d=!1;if(null!=e.num&&null!=e.start){var g=e.start+e.num;d=r.length>g,r=r.slice(e.start,Math.min(r.length,g))}return{exceededTransferLimit:d,features:this._createFeatures(e,r),fields:p&&p.map(function(e){return t.fieldsMap.get(e)}),geometryType:s,hasM:n,hasZ:o,objectIdFieldName:u,spatialReference:c(f?f.toJSON():l),transform:h&&a.toTransform(h)}},e.prototype._createFeatures=function(e,t){var r=e.quantizationParameters,i=e.returnGeometry,s=e.returnCentroid,n=[],o=0;if(i||s)if(r){var u=a.toTransform(r),l=a.getQuantizeX(u),c=a.getQuantizeY(u);if(i&&!s)for(var p=0,f=t;p<f.length;p++){var h=f[p];n[o++]={attributes:h.getAttributes(),geometry:h.getGeometryQuantized(u,l,c)}}else if(!i&&s)for(var d=0,g=t;d<g.length;d++){var h=g[d];n[o++]={attributes:h.getAttributes(),centroid:h.getCentroidQuantized(u,l,c)}}else for(var m=0,y=t;m<y.length;m++){var h=y[m];n[o++]={attributes:h.getAttributes(),centroid:h.getCentroidQuantized(u,l,c),geometry:h.getGeometryQuantized(u,l,c)}}}else if(i&&!s)for(var v=0,b=t;v<b.length;v++){var h=b[v];n[o++]={attributes:h.getAttributes(),geometry:h.getGeometry()}}else if(!i&&s)for(var F=0,S=t;F<S.length;F++){var h=S[F];n[o++]={attributes:h.getAttributes(),centroid:h.getCentroid()}}else for(var I=0,M=t;I<M.length;I++){var h=M[I];n[o++]={attributes:h.getAttributes(),centroid:h.getCentroid(),geometry:h.getGeometry()}}else for(var j=0,T=t;j<T.length;j++){var h=T[j];n[o++]={attributes:h.getAttributes()}}return n},e.prototype._createNew=function(t){return new e(t,this)},e.prototype._createStatisticsQueryResponse=function(e){var t=e.outStatistics,r=[],i=[];if(e.groupByFieldsForStatistics&&e.groupByFieldsForStatistics.length)for(var s={},a=0,n=t;a<n.length;a++){var o=n[a],u=o.onStatisticField,l=o.outStatisticFieldName,c=o.statisticType;if("count"===c){s[u]||(s[u]=this._calculateUniqueValues(u));var p=s[u];for(var f in p){var h=p[f],d={attributes:{}};d.attributes[l]=h.count,d.attributes[u]=h.data,r.push(d)}i.push({name:l,alias:l,type:"esriFieldTypeString"})}}else{for(var g={},m={attributes:{}},y=0,v=t;y<v.length;y++){var b=v[y],u=b.onStatisticField,l=b.outStatisticFieldName,c=b.statisticType;g[u]||(g[u]=this._calculateStatistics(u));var F=g[u],S="var"===c?"variance":c;m.attributes[l]=F[S],i.push({name:l,alias:l,type:"esriFieldTypeDouble"})}r.push(m)}return{fields:i,features:r}},e.prototype._calculateStatistics=function(e){for(var t=this.items,r=t.length,i=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,a=null,n=null,o=null,u=null,l=[],c=0;c<r;c++){var p=l[c]=t[c].getAttributes()[e];a+=p,i=Math.min(i,p),s=Math.max(s,p)}if(r){n=a/r;for(var f=0,h=0,d=l;h<d.length;h++){var p=d[h];f+=Math.pow(p-n,2)}u=r>1?f/(r-1):0,o=Math.sqrt(u)}else i=null,s=null;return{avg:n,count:r,max:s,min:i,stddev:o,sum:a,variance:u}},e.prototype._calculateUniqueValues=function(e){for(var t={},r=0,i=this.items;r<i.length;r++){var s=i[r],a=s.getAttributes()[e];(null==a||"string"==typeof a&&""===a.trim())&&(a=null),null==t[a]?t[a]={count:1,data:a}:t[a].count++}return t},e}();t.default=p});