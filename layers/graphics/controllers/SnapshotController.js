// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["dojo/_base/lang","../../support/GraphicsManager","../../../core/Accessor","../../../core/Error","../../../core/Promise","../../../core/Evented","../../../core/HandleRegistry","../../../core/Logger","../../../core/promiseUtils","../../../geometry/support/scaleUtils"],function(e,t,i,r,a,s,n,u,h,l){var o=u.getLogger("esri.layers.graphics.controllers.SnapshotController"),c=i.createSubclass([a,s],{declaredClass:"esri.layers.graphics.controllers.SnapshotController",constructor:function(){this._handles=new n,this._pendingQueries=new Map},initialize:function(){var e=this.layer.then(function(){this._verifyCapabilities()}.bind(this));this.addResolvingPromise(e),this.then(this._init.bind(this))},destroy:function(){this.cancelQuery(),this._gManager&&(this._gManager.destroy(),this._gManager=null),this._handles.destroy(),this._handles=null,this._pendingQueries=null},_cancelErrorMsg:"SnapshotController: query cancelled",_featureResolution:{value:.25,scale:945},_gManager:null,_handles:null,_maxFeatures:{point:16e3,multipoint:8e3,polyline:4e3,polygon:4e3,multipatch:4e3},_source:null,_started:!1,properties:{_pendingQueries:null,updating:{value:!1,dependsOn:["_pendingQueries"],get:function(){return!!(this._pendingQueries&&this._pendingQueries.size>0)}},graphics:{value:null,set:function(e){var t=this._get("graphics");t!==e&&(this._handles.remove("graphics"),e&&(this._collectionChanged({added:e.toArray()}),this._handles.add(e.on("change",this._collectionChanged.bind(this)),"graphics")),this._set("graphics",e))}},extent:{},hasAllFeatures:!1,hasFeatures:!1,layer:null,layerView:null,maxPageSize:null,pageSize:null,paginationEnabled:!1},update:function(e){this.startup()},startup:function(){this._started||(this._started=!0,this._resolutionParams=this._getResolutionParams(),this._queryFeatures())},refresh:function(){this.isResolved()&&this._started&&this._queryFeatures()},cancelQuery:function(){this._pendingQueries&&(this._pendingQueries.forEach(function(e,t){e.isFulfilled()||e.cancel(new Error(this._cancelErrorMsg))}.bind(this)),this._pendingQueries.clear(),this.notifyChange("updating"))},_init:function(){var e=this.layer;this.paginationEnabled=!!e.get("capabilities.query.supportsPagination"),this._source=e.source,this.pageSize=null==this.maxPageSize?e.maxRecordCount:Math.min(e.maxRecordCount,this.maxPageSize),this._gManager=new t({graphics:this.graphics,objectIdField:e.objectIdField}),this._setupStateWatchers()},_getResolutionParams:function(){var e,t=this.layer,i=t.get("capabilities.query.supportsQuantization");if("polyline"===t.geometryType||"polygon"===t.geometryType){var r=l.getMetersPerUnit(this.layerView.view.spatialReference);if(null==r);else{var a=this._featureResolution.scale,s=this._featureResolution.value/r;a=t.maxScale?t.maxScale:t.minScale?Math.min(a,t.minScale):Math.min(a,l.getScale(this.layerView.view,t.fullExtent)),e=s/this._featureResolution.scale*a}}return e?{maxAllowableOffset:i?null:e,quantizationParameters:i?{mode:"view",originPosition:"upperLeft",tolerance:e,extent:t.fullExtent}:null}:null},_setupStateWatchers:function(){this._handles.add([this.watch("extent",this.refresh.bind(this)),this.layer.watch("definitionExpression",this.refresh.bind(this)),this.layer.on("edits",this._editsHandler.bind(this))])},_createQueryParams:function(){var t=this.layer,i=this.layerView,r=t.createQuery();return r.outSpatialReference=i.view.spatialReference,r.geometry=this.extent,e.mixin(r,this._resolutionParams),this.paginationEnabled&&(r.start=0,r.num=this.pageSize),r},_queryFeatures:function(){this.cancelQuery(),this.hasAllFeatures=this.hasFeatures=!1,this._gManager.beginPagedUpdate(),this.emit("query-start"),this._executeQuery(this._createQueryParams())},_executeQuery:function(e){var t=this._source.queryFeatures(e),i=this._gManager.createIntentToAdd();this._querySetup(i,t),t.then(this._processFeatureSet.bind(this,e,i)).otherwise(this._queryError.bind(this,i)).always(this._queryTeardown.bind(this,i))},_processFeatureSet:function(e,t,i){var r=i.exceededTransferLimit,a=i.features,s=this._maxFeatures[this.layer.geometryType]||0,n=a?a.length:0,u=this._gManager.numGraphics+n,h=u>=s;if(h){o.warn('Feature limit exceeded on layer "',this.layer.title,'". Not all features are shown.');var l=u-s;l&&a.splice(n-l,l)}var c=r&&this.paginationEnabled&&!h?this._queryNextPage(e):!1;return a&&this._gManager.addPage(a,t),this.hasFeatures=!0,c||(this._gManager.endPagedUpdate(),this.hasAllFeatures=!r,this.emit("query-end",{success:!0})),i},_queryNextPage:function(e){return e.start+=this.pageSize,this._executeQuery(e),!0},_queryError:function(e,t){if(t&&"cancel"===t.dojoType&&!this.hasFeatures?this._gManager.revertPagedUpdate():this._gManager.endPagedUpdate(),this.emit("query-end",{success:!1}),t&&"cancel"===t.dojoType)return h.reject(t);var i=new r("snapshotcontroller:tile-request-failed","Failed to query for features",{error:t});return o.error(i),h.reject(i)},_querySetup:function(e,t){this._pendingQueries.set(e,t),this.notifyChange("updating")},_queryTeardown:function(e){this._gManager.removeIntent(e),this._pendingQueries["delete"](e),this.notifyChange("updating")},_collectionChanged:function(e){var t,i,r;if(r=e.added)for(t=0;i=r[t];t++)i.layer=this.layer;if(r=e.removed)for(t=0;i=r[t];t++)i.layer=null},_editsHandler:function(e){var t=function(e){return e.objectId},i=e.deletedFeatures.map(t);this._gManager["delete"](i);var r=e.addedFeatures.concat(e.updatedFeatures).map(t);if(r.length){var a=this._createQueryParams();a.objectIds=r;var s=this._source.queryFeatures(a),n=this._gManager.createIntentToAdd(r);this._querySetup(n,s),s.then(this._processRefetch.bind(this,n)).otherwise(this._refetchError.bind(this,n)).always(this._queryTeardown.bind(this,n))}},_processRefetch:function(e,t){var i=t.features;i&&this._gManager.add(i,e)},_refetchError:function(e,t){},_verifyCapabilities:function(){if(!this.layer.get("capabilities.operations.supportsQuery"))throw new r("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:this.layer})}});return c});