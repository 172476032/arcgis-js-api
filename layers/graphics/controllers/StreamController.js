// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../core/declare","dojo/promise/all","dojo/Deferred","../../../core/Accessor","../../../core/Promise","../../../core/Collection","../../../core/HandleRegistry","../../../core/Evented","../../../core/promiseUtils","../../support/StreamPurger","../../../Graphic","../../../geometry/support/jsonUtils","../../../tasks/support/Query"],function(e,t,r,i,n,s,o,a,h,c,l,u,d){var f=e([i,n,a],{declaredClass:"esri.layers.graphics.controllers.StreamController",constructor:function(){this._addFeatures=this._addFeatures.bind(this),this._handleMessage=this._handleMessage.bind(this),this._handleRegistry=new o,this._nextId=0,this._socketConnector=null},initialize:function(){var e=new r;return this.addResolvingPromise(t([this.layer,this.layerView])),this.then(function(){var t=s.ofType(l);this.source=this.layer.source,this.graphics=this.graphics||new t,this._initializeFilter();var r=new c(this);r.then(function(){this.purger=r,this._makeConnection()}.bind(this),function(t){this.addResolvingPromise(e.promise),e.reject(t)}.bind(this))}.bind(this)),e.promise},destroy:function(){this._socketConnector&&(this._disconnect(),this._socketConnector=null),this.purger&&(this.purger.destroy(),this.purger=null),this.graphics=null,this._handleRegistry&&(this._handleRegistry.destroy(),this._handleRegistry=null)},properties:{graphics:{type:s.ofType(l),set:function(e){var t=this._get("graphics");t!==e&&(this._handleRegistry.remove("graphics"),e&&(this._collectionChanged({added:e.toArray()}),this._handleRegistry.add(e.on("change",this._collectionChanged.bind(this)),"graphics")),this._set("graphics",e))}},filter:{value:{geometry:null,where:null},readOnly:!0},definitionExpression:{value:null,get:function(){return console.warn("StreamController.definitionExpression is deprecated. Access the filter.where property"),this.filter.where},set:function(e){console.warn("StreamController.definitionExpression is deprecated. Use the updateFilter method to change the attribute filter");var t={where:e};this.updateFilter(t)}},geometryDefinition:{value:null,get:function(){return console.warn("StreamController.geometryDefinition is deprecated. Access the filter.geometry property"),this.filter.geometry},set:function(e){console.warn("StreamController.geometryDefinition is deprecated. Use the updateFilter method to change the spatial filter");var t={geometry:e};this.updateFilter(t)}},layer:{value:{}},currentSocketUrl:{set:function(e){this._get("currentSocketUrl")!==e&&this._set("currentSocketUrl",e)}},purger:{set:function(e){var t=this._get("purger");t!==e&&this._set("purger",e)}},_socketConnector:{}},connect:function(){this._connect()},disconnect:function(){this._disconnect()},updateFilter:function(e){return this._filterValid(e)?this._filterChanged(e)?this._setFilter(e):h.resolve(this.filter):h.reject(new Error("Invalid properties in filter. geometry must be an extent and where must be a string"))},_makeConnection:function(){return this._handleRegistry.remove("websocket"),this._addBuddiedServiceFeatures(!0).then(function(){return this._addBuddiedServiceFeatures(!1)}.bind(this),function(e){return h.reject(new Error("Error fetching related features. Layer cannot be created"))}.bind(this)).then(function(e){var t=this.layerView.view.spatialReference;return this.source.createWebSocketConnector(t)}.bind(this)).then(function(e){this._socketConnector=e,this._handleRegistry.add(e.on("connect",function(){this.emit("connect")}.bind(this)),"websocket"),this._handleRegistry.add(e.on("disconnect",function(e){this.emit("disconnect",e)}.bind(this)),"websocket"),this._handleRegistry.add(e.on("attempt-reconnect",function(e){this.emit("attempt-reconnect",e)}.bind(this)),"websocket"),this._handleRegistry.add(e.on("message",function(e){this._handleMessage(e)}.bind(this)),"websocket"),this._handleRegistry.add(e.watch("currentSocketUrl",function(e){this.currentSocketUrl=e}.bind(this)),"websocket"),e.connect()}.bind(this)).otherwise(function(e){this.emit("error",e)}.bind(this))},_connect:function(){this._socketConnector&&this._socketConnector.connect()},_disconnect:function(){this._socketConnector&&this._socketConnector.disconnect()},_handleMessage:function(e){var t,r=JSON.parse(e);this.emit("message",r),r.filter||(t=r instanceof Array?r:[r],this._addFeatures(t))},_addFeatures:function(e){if(e){for(var t=this.layer.objectIdField,r=[],i=0,n=e.length;n>i;i++){var s,o=e[i];!o.geometry||o.geometry.hasOwnProperty("x")&&!o.geometry.x?console.log("not adding feature. null geometry"):((!o.attributes||!o.attributes[t]&&0!==o.attributes[t])&&(o.attributes=o.attributes||{},o.attributes[t]=this._nextId++),s=o.declaredClass?o:l.fromJSON(o),r.push(s))}this.purger.addMany(r)}},_collectionChanged:function(e){var t,r,i;if(i=e.added)for(t=0;r=i[t];t++)r.layer=this.layer;if(i=e.removed)for(t=0;r=i[t];t++)r.layer=null},_initializeFilter:function(){var e=this.layer;e&&e.filter&&this._set("filter",{where:e.filter.where||null,geometry:e.filter.geometry||null}),this._handleRegistry.add(this.watch("layer.filter",function(e){this._setFilter(e)}.bind(this)))},_filterChanged:function(e){var t,r=!1,i=!1;return t=e?this.source.makeFilter(e):{geometry:null,where:null},t.hasOwnProperty("geometry")&&(r=t.geometry?!t.geometry.equals(this.filter.geometry):t.geometry!==this.filter.geometry),t.hasOwnProperty("where")&&(i=t.where!==this.filter.where),r||i},_filterValid:function(e){var t=!0;return e&&(e.hasOwnProperty("geometryDefinition")&&e.geometryDefinition&&(e.geometryDefinition.type&&"extent"===e.geometryDefinition.type||(t=!1)),t&&e.hasOwnProperty("definitionExpression")&&e.definitionExpression&&"string"!=typeof e.definitionExpression&&(t=!1)),t},_setFilter:function(e){var t=null,i=new r;e&&(t=this.source.makeFilter(e),t.geometry&&"string"!=typeof t.geometry&&(t.geometry=t.geometry.toJSON?JSON.stringify(t.geometry.toJSON()):JSON.stringify(t.geometry)));var n={filter:t},s=this._socketConnector.on("message",function(e){if(e=JSON.parse(e),e.hasOwnProperty("filter")){s.remove();var t=this._processFilterMessage(e);t.error?(this.emit("filter-change",t),i.reject(t.error)):(this.emit("filter-change",{filter:this.filter}),i.resolve({filter:this.filter}))}}.bind(this));return this._socketConnector.send(n),i.promise},_processFilterMessage:function(e){var t,r,i={};return e.error?(i.error=new Error(e.error.join(",")),i.filter={where:this.filter.where,geometry:this.filter.geometry}):(e.filter=e.filter||{},t=e.filter.geometry,t&&("string"==typeof t&&(t=JSON.parse(t)),t=u.fromJSON(t)),r={where:e.filter.where||null,geometry:t||null},this._set("filter",r),this.notifyChange("geometryDefinition"),this.notifyChange("definitionExpression"),i.filter=r),i},_addBuddiedServiceFeatures:function(e){var t,r,i;if(e){if(!this.source.relatedFeaturesInfo)return h.resolve();t=this.source.relatedFeaturesQueryTask,r=this.source.relatedLayerDefinition,i=this._createQuery(r,!0)}else{if(!this.source.latestUrl)return h.resolve();t=this.source.latestQueryTask,r=this.source.archivedLayerDefinition,i=this._createQuery(r,!1)}var n=r.advancedQueryCapabilities||{},s=!!n.supportsPagination;return s&&(i.num=r.maxRecordCount),this._query({query:i,queryTask:t}).then(function(e){if(e){var t=this._fixFieldNameCasing(this.source.layer,e);e.features=t,this._addFeatures(e.features)}return h.resolve()}.bind(this),function(e){return h.reject(e)},function(e){e&&this._addFeatures(e.features)}.bind(this))},_query:function(e){var t=e.query,i=e.queryTask,n=new r;t.num&&(t.start=0);var s=function(e){(e||0===e)&&(t.start=e),i.execute(t).then(o,function(e){console.log("error performing query: ",e),n.reject(e)})},o=function(e){e.exceededTransferLimit&&t.num?(s(t.start+t.num),n.progress(e)):n.resolve(e)};return s(t.start),n.promise},_createQuery:function(e,t){var r=this.layer,i=this.layerView,n={where:"1=1",returnGeometry:!0,outFields:["*"]};if(!e)return new d(n);var s;s=t?this.source.relatedFeaturesInfo&&this.source.relatedFeaturesInfo.outFields:r.outFields,s=s?s.slice(0):["*"];var o=r.definitionExpression||"1=1";if(t){var a=this._getFieldsNotShared(e,this.layer.fields);s=this._removeInvalidOutfields(a,s),"1=1"!==o&&this._checkForInvalidFieldInWhere(a,o)&&(o="1=1")}return s=this._addObjectIdFieldToOutfields(e,s),new d({where:o,geometry:r.geometryDefinition,outFields:s,outSpatialReference:i.view.spatialReference,returnGeometry:!0})},_addObjectIdFieldToOutfields:function(e,t){if(t=t||["*"],"*"!==t[0]){var r=this._getObjectIdFieldName(e);if(r){var i=t.some(function(e){return e.toLowerCase()===r.toLowerCase()});i||t.push(r)}}return t},_removeInvalidOutfields:function(e,t){t=t||["*"];var r;return"*"!==t[0]&&(r=t.filter(function(t){return-1===e.indexOf(t)?t:void 0})),r&&0!==r.length?r:["*"]},_checkForInvalidFieldInWhere:function(e,t){return t&&"1=1"!==t?e.some(function(e){var r=new RegExp("\\s*"+e+"\\b","i");return r.test(t)}):!1},_getObjectIdFieldName:function(e){var t=null;return e.fields.some(function(e){return"esriFieldTypeOID"===e.type?(t=e.name,!0):!1}),t},_getFieldsNotShared:function(e,t){var r=e.fields.map(function(e){return e.name.toLowerCase()}),i=[];return t.forEach(function(e){var t=e.name;-1===r.indexOf(t.toLowerCase())&&i.push(t)}),i},_fixFieldNameCasing:function(e,t){var r,i,n=[];if(!e)throw new Error("streamLayer is a required argument for _fixFieldNameCasingmethod");if(e&&(r=e.fields),t&&(n=t.features||[],i=t.fields),!i||!n.length||!r)return n;for(var s,o,a=this._mapFieldNameDifferences(r,i),h=[],c=0,l=t.features.length;l>c;c++)s=n[c],o=this._swizzleResponseAttributes(s.attributes,a),s.attributes=o,h.push(s);return h},_mapFieldNameDifferences:function(e,t){var r,i,n=[],s={};for(e=e||[],t=t||[],r=0,i=t.length;i>r;r++)n.push(t[r].name);for(r=0,i=e.length;i>r;r++){var o=e[r].name,a=this._checkForStreamFieldName(o,n);a&&(s[a]=o)}return s},_checkForStreamFieldName:function(e,t){var r,i,n;if(t&&t.length){if(e&&e.toLowerCase){r=e.toLowerCase();for(var s=0,o=t.length;o>s;s++)if(i=t[s],i.toLowerCase&&i.toLowerCase()===r){n=i;break}}return n}},_swizzleResponseAttributes:function(e,t){var r={};for(var i in e)if(e.hasOwnProperty(i)){var n=e[i];t.hasOwnProperty(i)?r[t[i]]=n:r[i]=n}return r}});return f});