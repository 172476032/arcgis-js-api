// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/promise/all","dojo/errors/CancelError","dojo/has","dojo/_base/lang","../../../views/3d/support/ResourceController","../../../core/sql/WhereClause","../../../views/3d/layers/SceneLayerView3D","../../../views/3d/layers/i3s/I3SNodeLoader","../../../views/3d/layers/i3s/I3SIndexTraversal","../../../views/3d/layers/i3s/I3SUtil","../../../views/3d/layers/i3s/I3SLodHandling","../../../views/3d/layers/i3s/I3SViewportQueries","../../../views/3d/layers/i3s/IdleQueue","../../../views/3d/layers/i3s/GoogPriorityQueue","../../../layers/SceneLayer","../../../layers/IntegratedMeshLayer","../../../core/accessorSupport/decorators","../../../core/Accessor","../../../core/Evented","../../../core/Promise","../../../core/Logger","../../../core/promiseUtils","../../../core/watchUtils","../../../core/HandleRegistry","../../../views/3d/support/PromiseLightweight","../../../views/3d/support/projectionUtils","../../../views/3d/lib/glMatrix"],function(e,t,i,r,n,o,a,s,d,l,u,h,p,c,y,_,g,f,v,w,m,L,b,x,I,N,F,V,S,O,P){function C(e,t){for(var i=t.toLowerCase(),r=0;r<e.length;r++)if(e[r].name.toLowerCase()===i)return r;return-1}var A=I.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),E=function(e){function t(t){var i=e.call(this)||this;return i.nodeIndex={},i.screenSizeFactor=0,i.updating=!0,i.updatingPercentage=0,i._lodFactorProperty=null,i._isIdle=!1,i._alwaysLoadEverythingModeEnabled=!1,i._uncompressedTextureDownsamplingEnabled=!1,i._computedMbs={},i._nodeQueue=null,i.maxQueueLevel=0,i._numNodesLoading=0,i._numAttributesLoading=0,i._progressMaxNumNodes=1,i._poi=null,i._requiredAttributesDirty=!0,i._updatesDisabled=!1,i.disableCache=!1,i._restartNodeLoading=!1,i._fields=null,i._attributeStorageInfo=null,i._handles=new V,i._idleQueue=new g.IdleQueue,i}return i(t,e),Object.defineProperty(t.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"streamDataSupplier",{get:function(){return this.layerView.view.resourceController.registerClient(this.layerView,d.ClientType.SCENE,{trackRequests:!0})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parsedDefinitionExpression",{get:function(){if(!(this.layer instanceof v&&this.layer.definitionExpression))return null;try{var e=l.create(this.layer.definitionExpression);if(!e.isStandardized())return A.error("definitionExpression is using non standard function"),null;var t=[],i=e.getFields();return c.findFieldsCaseInsensitive(i,this.layer.fields,{missingFields:t}),t.length>0?(A.error("definitionExpression references unknown fields: "+t.join(", ")),null):e}catch(r){return A.error("Failed to parse definitionExpression: "+r),null}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"definitionExpressionFields",{get:function(){if(this.parsedDefinitionExpression){var e=this.parsedDefinitionExpression.getFields();return c.findFieldsCaseInsensitive(e,this._fields)}return null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsVertex",{get:function(){return c.getVertexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsIndex",{get:function(){return c.getIndexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rootNodeVisible",{get:function(){var e=this._rootNodeId&&this.nodeIndex[this._rootNodeId];return e&&this._viewportQueries?this._viewportQueries.isNodeVisible(e):!0},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this.updateEventListener={needsUpdate:function(){return e._needsAnimationFrameHandler()},idleFrame:function(t){return e._animationFrameHandler(t)},idleBegin:function(){e._startNodeLoading(),e._updateIdleState(!0)},idleEnd:function(){e.cancelNodeLoading(),e._updateIdleState(!1)}},this.updateEventListenerWhileSuspended={idleBegin:function(){return e._startNodeLoadingWhileSuspended()}},this._lodHandling=new y(this.layerViewRequiredFunctions,this.layerViewOptionalFunctions,function(){return e._evaluateUpdatingState()}),this.layerView._controller=this;var t=this.layer;this._defaultGeometrySchema=t.store.defaultGeometrySchema,this._rootNodeUrl=t.store.rootNode;var i=this._rootNodeUrl.split("/");this._rootNodeId=i[i.length-1],this.disableCache=a("disable-feature:idb-cache"),t instanceof v?("mesh"===t.geometryType?this._lodFactorProperty="qualitySettings.sceneService.3dObject.lodFactor":"point"===t.geometryType&&(this._lodFactorProperty="qualitySettings.sceneService.point.lodFactor"),this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo):t instanceof w&&(this._lodFactorProperty="qualitySettings.sceneService.integratedMesh.lodFactor");var r=n([this.layer.when(),this.layerView.when()]).then(function(){if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){e.setClippingArea(e.layerView.view.clippingArea);var t=e.layerView.view.pointsOfInterest,i=function(){return e.restartNodeLoading()};e._centerOnSurface=t.centerOnSurfaceFrequent,e._handles.add([e._centerOnSurface.watch("renderLocation",function(){return e._pointOfInterestChanged()}),t.events.on("camera-parameters-changed",i)],"view");var r=e.layerView.view.resourceController,n=!1;e._handles.add(F.init(e.layerView,"suspended",function(t){n&&r.deregisterIdleFrameWorker(e),t?r.registerIdleFrameWorker(e,e.updateEventListenerWhileSuspended):r.registerIdleFrameWorker(e,e.updateEventListener),n=!0}),"layerview"),e._handles.add(e.layer.watch("elevationInfo",function(t){return e._elevationInfoChanged(t)}),"layer"),e.layerView instanceof u&&e._handles.add([F.init(e.layerView,"alwaysLoadEverythingModeEnabled",function(t){e._alwaysLoadEverythingModeEnabled=t,i()}),F.init(e.layerView,"uncompressedTextureDownsamplingEnabled",function(t){e._uncompressedTextureDownsamplingEnabled=t,i()})],"layer"),e._lodFactorProperty&&e._handles.add(e.layerView.view.watch(e._lodFactorProperty,function(){return e._qualityChanged()}),"quality")}});this.addResolvingPromise(r)},t.prototype.destroy=function(){this.layerView.view.resourceController.deregisterIdleFrameWorker(this),this.layerView.view.resourceController.deregisterClient(this.layerView),this._handles.destroy(),this._nodeLoader=null},t.prototype._getRequiredAttributes=function(){if(!(null!=this._attributeStorageInfo&&this.layer instanceof v&&this._fields))return[];var e=Object.create(null);if(this.layer.renderer&&this.layer.renderer.collectRequiredFields(e),this.layer.labelsVisible&&this.layer.labelingInfo&&this.layer.labelingInfo.forEach(function(t){t._collectRequiredFields(e)}),null!=this.definitionExpressionFields)for(var t=0,i=this.definitionExpressionFields;t<i.length;t++){var r=i[t];e[r]=!0}var n=this._attributeStorageInfo,o=this._fields,a=this.layer.objectIdField,s=Object.keys(e).map(function(e){var t=C(n,e),i=C(o,e);return t>=0&&i>=0?{index:t,name:o[i].name,field:o[i],attributeStorageInfo:n[t]}:null}).filter(function(e){return null!=e&&e.name!==a}).sort(function(e,t){return t.index-e.index}).filter(function(e,t,i){return 0===t||i[t-1].index!==e.index});return s},t.prototype._requiredFieldsChange=function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()},t.prototype._labelingChanged=function(){var e=this._requiredAttributes,t=this._getRequiredAttributes();e.length===t.length&&e.every(function(e){return C(t,e.name)>=0})||this._requiredFieldsChange()},t.prototype.setClippingArea=function(e){var t=[];O.extentToBoundingBox(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null},t.prototype._qualityChanged=function(){this.restartNodeLoading()},t.prototype._pointOfInterestChanged=function(){this._poi&&(this._calculatePointOfInterest(this._poi),this._indexLoader&&(this._indexLoader.updatePointOfInterest(this._poi),this._indexLoader.progressiveLoadPenalty=D.distancePenalty*this._viewportQueries.distCameraToPOI(this._poi)))},t.prototype._calculatePointOfInterest=function(e){void 0===e&&(e=P.vec3d.create());var t=P.vec3d.create(),i=P.vec3d.create(),r=this._centerOnSurface.renderLocation,n=this.layerView.view.renderCoordsHelper;P.vec3d.subtract(r,this.camPos,t),P.vec3d.normalize(t),n.worldUpAtPosition(r,i);var o=Math.acos(P.vec3d.dot(i,t))-.5*Math.PI;return P.vec3d.lerp(this.camPos,r,Math.max(0,Math.min(1,o/(.5*Math.PI))),e),e},t.prototype.updateClippingArea=function(e){this.setClippingArea(e),this.restartNodeLoading()},t.prototype.getBaseUrl=function(){return this.layer.parsedUrl.path},t.prototype.updateElevationChanged=function(e,t,i){c.findIntersectingNodes(e,t,this.nodeIndex.root,this.crsIndex,this.nodeIndex,i);for(var r=0;r<i.length;r++){var n=i.data[r];this._computedMbs[n.id]&&(this._computedMbs[n.id][3]=-1),n.id===this._rootNodeId&&this.notifyChange("rootNodeVisible")}i.length&&this.restartNodeLoading()},t.prototype._elevationInfoChanged=function(e){for(var t=0,i=Object.keys(this._computedMbs);t<i.length;t++){var r=i[t];this._computedMbs[r][3]=-1}this._initViewData()},t.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0,this._evaluateUpdatingState()},t.prototype.schedule=function(e){return this._idleQueue.push(e)},t.prototype._needsAnimationFrameHandler=function(){return!0},t.prototype._animationFrameHandler=function(e){if(this._restartNodeLoading&&(this.cancelNodeLoading(),this._startNodeLoading()),null!=this._nodeLoader){var t=this._indexLoader&&(this.maxQueueLevel>=this._indexLoader.getMaxLevel(0)||!this._indexLoader.isLoading());if(this._nodeQueue&&t)for(var i=this._indexLoader.isLoading()?3:5;this._numNodesLoading<i&&!this._nodeQueue.isEmpty();)this._loadNode(this._nodeQueue.dequeue());if(this._indexLoader){var r=t?4:10,n=4,o=this._indexLoader.getNumLoading(),a=Math.min(r-o,n);a>0&&this._indexLoader.continueTraversal(a)}for(;this._idleQueue.length()>0&&!e.done();)this._idleQueue.process();this._evaluateUpdatingState(),this._lodHandling.lodGlobalHandling()}},t.prototype._evaluateUpdatingState=function(){var e=this._indexLoader?this._indexLoader.getQueueSize():0,t=this._nodeQueue?this._nodeQueue.getCount():0,i=e+3*(t+this._numNodesLoading),r=!(!(i>0||this._numAttributesLoading>0||this._indexLoader&&this._indexLoader.isLoading()||this._restartNodeLoading||this._idleQueue.length()>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling)&&this._isIdle);0===i&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(i,this._progressMaxNumNodes),r!==this._get("updating")&&this._set("updating",r);var n=100*i/this._progressMaxNumNodes;n!==this._get("updatingPercentage")&&this._set("updatingPercentage",n)},t.prototype._initViewData=function(){var e=this.layerView.view,t=e.state.camera,i=e.renderCoordsHelper;this.camPos=P.vec3d.create(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/t.perPixelRatio,this._poi=this._calculatePointOfInterest();var r=this._lodFactorProperty&&this.layerView.view.get(this._lodFactorProperty)||1,n=null!=this.layerViewOptionalFunctions.traversalOptions?this.layerViewOptionalFunctions.traversalOptions.errorMetricPreference:null;this._viewportQueries=new _(this._computedMbs,this.crsIndex,i,t,this._clippingArea,n,e.elevationProvider,this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(this.layer,r),screenspaceErrorBias:r,angleDependentLoD:.5>r,disableLod:this._alwaysLoadEverythingModeEnabled}),this.notifyChange("rootNodeVisible")},t.prototype._getProgressiveLoadFactor=function(e,t){if(e instanceof v&&"mesh"===e.geometryType){var i=t>=1&&a("enable-feature:progressive-3dobject");return i?D.factor3dObject:1}if(e instanceof w){var i=t>=1&&!a("disable-feature:progressive-im");return i?D.factorIM:1}return 1},t.prototype._startNodeLoadingWhileSuspended=function(){var e=this;if(this._initViewData(),!this._alwaysLoadEverythingModeEnabled||!this.layerView.visible||this.layerView.get("parent.suspended")){var t=function(t){return e._viewportQueries.isNodeVisible(t)};this._removeInvisibleNodes(t)}},t.prototype._startNodeLoading=function(){var e=this;if(this._restartNodeLoading=!1,!this._updatesDisabled&&null!=this.streamDataSupplier){this._initViewData(),null!=this.layerViewOptionalFunctions.getLoadedAttributes&&this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1,this._handles.add([this.layer.watch("renderer",function(){return e._requiredFieldsChange()}),this.layer.watch("definitionExpression",function(){return e._requiredFieldsChange()}),this.layer.watch("labelsVisible",function(){return e._labelingChanged()}),this.layer.watch("labelingInfo",function(){return e._labelingChanged()})],"requiredAttributes"));var t=this.layerViewOptionalFunctions.textureOptions,i=h.TextureFormat.Normal;t&&t.useCompressedTextures?i=h.TextureFormat.Compressed:this._uncompressedTextureDownsamplingEnabled&&(i=h.TextureFormat.Downsampled);var r=this._defaultGeometrySchema,n={textureFormat:i,loadTextureData:this.layerView instanceof u&&this.layerView.rendererNeedsTextures,loadFeatureData:!this.isMeshPyramid||null==r||null==r.ordering};this._nodeLoader=new h(this.streamDataSupplier,A,r,this._requiredAttributes,n);var o=s.mixin({loadEverything:this._alwaysLoadEverythingModeEnabled},this.layerViewOptionalFunctions.traversalOptions);this._indexLoader=new p(this.getBaseUrl(),this._rootNodeUrl,this._rootNodeId,this._poi,this.nodeIndex,this.streamDataSupplier,this._viewportQueries,function(t,i){return e._processNodeIndexDocument(t,i)},function(t){return e._lodHandling.finishedLevel(t)},A,o),this._indexLoader.progressiveLoadPenalty=D.distancePenalty*this._viewportQueries.distCameraToPOI(this._poi),this._nodeQueue=new q,this.maxQueueLevel=0,this._indexLoader.start(),this._alwaysLoadEverythingModeEnabled||this._removeInvisibleNodes(function(t){return e._indexLoader.nodeIsVisible(t)});var a=null!=o&&o.perLevelTraversal?"perLevel":"global";this._lodHandling.startNodeLoading(function(t){return e._indexLoader.nodeIsVisible(t)},function(t){return e._indexLoader.nodeTraversalState(t)},this.nodeIndex,this._rootNodeId,{mode:a,allowPartialOverlaps:!!o.allowPartialOverlaps,maxLodLevel:this._viewportQueries.maxLodLevel}),this.layerViewOptionalFunctions.additionalStartNodeLoadingHandler&&this.layerViewOptionalFunctions.additionalStartNodeLoadingHandler(),this._evaluateUpdatingState()}},t.prototype.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._indexLoader},t.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this._indexLoader.cancel(),this._nodeLoader.cancel(),this.streamDataSupplier.cancelAll(),this._idleQueue.cancelAll(),this._numNodesLoading=0,this._nodeLoader=null,this._indexLoader=null,this._nodeQueue=null,this._poi=null,this.layerViewOptionalFunctions.additionalCancelNodeLoadingHandler&&this.layerViewOptionalFunctions.additionalCancelNodeLoadingHandler(),this._evaluateUpdatingState())},t.prototype._removeInvisibleNodes=function(e){for(var t={},i=this.layerViewRequiredFunctions.getAddedNodeIDs(),r=0;r<i.length;r++){var n=i[r],o=this.nodeIndex[n],a=this._isNodeVisibleWithParents(o,e);a?t[n]=o:this._removeNodeData(o)}return t},t.prototype._isNodeVisibleWithParents=function(e,t){var i,r=e;do{i=t(r);var n=r.parentNode;r=null!=n?this.nodeIndex[n.id]:null}while(i&&null!=r);return i},t.prototype._removeNodeData=function(e){this._lodHandling.setLodGlobalDirty(),this.layerViewRequiredFunctions.removeNodeData(e)},t.prototype._processNodeIndexDocument=function(e,t){var i=this.layerViewOptionalFunctions.traversalOptions;if(i&&i.perLevelTraversal)return this._loadNode(e);this._nodeQueue.enqueue(t,e),this.maxQueueLevel=Math.max(e.level,this.maxQueueLevel);var r=new S.Promise;return r.done(),r},t.prototype._loadNode=function(e){var t=this,i=new S.Promise;if(null!=e.featureData&&e.featureData.length>0)if(this.layerViewRequiredFunctions.areAllBundlesLoaded(e)){var r=this.layerViewOptionalFunctions.getLoadedAttributes,n=null!=r?r(e):void 0;if(null!=n&&n!==this._requiredAttributes){var o=e.baseUrl;this._nodeLoader.loadAttributes(e,o,this._requiredAttributes).then(function(i){t.layerViewOptionalFunctions.setAttributeData(e,t._requiredAttributes,i)}).otherwise(function(i){t.layerViewOptionalFunctions.setAttributeData(e,t._requiredAttributes,{})}).then(function(){t._numAttributesLoading--,t._evaluateUpdatingState()}),this._numAttributesLoading++,this._evaluateUpdatingState()}this._lodHandling.shouldLoadNode(e)&&this._lodHandling.lodSwapBundleLoaded(e)}else if(this._lodHandling.shouldLoadNode(e)){if(this.layerViewRequiredFunctions.isOverMemory())return i.done(),i;for(var a=[],s=0;s<e.featureData.length;s++)this.layerViewRequiredFunctions.isBundleAlreadyAddedToStage(e,s)||a.push(this._loadAndAddBundle(e,s));return this._numNodesLoading++,this._evaluateUpdatingState(),N.eachAlways(a).then(function(){t._numNodesLoading--,t._evaluateUpdatingState(),i.done()}),i}return i.done(),i},t.prototype._loadCached=function(e,t){var i=this,r=this.disableCache?null:this.layerViewOptionalFunctions.loadCachedBundle,n=this.disableCache?null:this.layerViewOptionalFunctions.addCachedBundle;return r&&n?this.schedule().then(function(){return r(e,t,function(e,t){return i._nodeLoader.loadTextures(e,t)})}).then(function(r){if(null==r)return!1;var o=i._requiredAttributes;return i.schedule().then(function(){return i._nodeLoader.loadAttributes(e,e.baseUrl,o)}).then(function(e){return i.schedule({loadedAttributes:o,attributeData:e})}).then(function(i){return n(e,t,r,i)}).then(function(){return i._lodHandling.lodSwapBundleLoaded(e),!0})}):N.resolve(!1)},t.prototype._loadUncached=function(e,t){var i=this;return this.schedule().then(function(){return i._nodeLoader.loadBundleData(e,t)}).then(function(e){return i.schedule(e)}).then(function(r){return i.layerViewRequiredFunctions.addBundle(e,t,r)}).then(function(){return i._lodHandling.lodSwapBundleLoaded(e)})},t.prototype._loadAndAddBundle=function(e,t){var i=this;return this._loadCached(e,t).then(function(r){return r?void 0:i._loadUncached(e,t)}).otherwise(function(i){i instanceof o||A.error("Failed to load node '"+e.id+"' bundle "+t+": "+i)})},t.prototype._updateIdleState=function(e){e!==this._isIdle&&(this._isIdle=e,this._evaluateUpdatingState())},r([m.property({readOnly:!0})],t.prototype,"isMeshPyramid",null),r([m.property({readOnly:!0})],t.prototype,"streamDataSupplier",null),r([m.property({readOnly:!0,dependsOn:["layer.definitionExpression"]})],t.prototype,"parsedDefinitionExpression",null),r([m.property({readOnly:!0,dependsOn:["parsedDefinitionExpression"]})],t.prototype,"definitionExpressionFields",null),r([m.property({readOnly:!0})],t.prototype,"crsVertex",null),r([m.property({readOnly:!0})],t.prototype,"crsIndex",null),r([m.property({readOnly:!0})],t.prototype,"nodeIndex",void 0),r([m.property()],t.prototype,"camPos",void 0),r([m.property()],t.prototype,"screenSizeFactor",void 0),r([m.property()],t.prototype,"layerView",void 0),r([m.property()],t.prototype,"layerViewRequiredFunctions",void 0),r([m.property()],t.prototype,"layerViewOptionalFunctions",void 0),r([m.property()],t.prototype,"layer",void 0),r([m.property({readOnly:!0})],t.prototype,"updating",void 0),r([m.property({readOnly:!0})],t.prototype,"updatingPercentage",void 0),r([m.property({readOnly:!0})],t.prototype,"rootNodeVisible",null),t=r([m.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],t)}(m.declared(L,x,b)),D={factorIM:.2,factor3dObject:.05,distancePenalty:10},q=f.goog.structs.PriorityQueue;return E});