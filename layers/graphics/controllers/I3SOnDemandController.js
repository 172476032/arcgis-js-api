// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/has","dojo/errors/CancelError","dojo/promise/all","../../../core/Accessor","../../../core/Evented","../../../core/Handles","../../../core/Logger","../../../core/Promise","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../core/sql/WhereClause","../../../layers/IntegratedMeshLayer","../../../layers/SceneLayer","../../../views/3d/layers/SceneLayerView3D","../../../views/3d/layers/i3s/I3SIndexTraversal","../../../views/3d/layers/i3s/I3SLodHandling","../../../views/3d/layers/i3s/I3SNodeLoader","../../../views/3d/layers/i3s/I3SUtil","../../../views/3d/layers/i3s/I3SViewportQueries","../../../views/3d/layers/i3s/IdleQueue","../../../views/3d/lib/glMatrix","../../../views/3d/support/projectionUtils","../../../views/3d/support/PromiseLightweight","../../../views/3d/support/ResourceController"],function(e,t,i,r,o,n,a,s,d,l,u,h,p,c,_,y,g,f,v,m,w,b,L,N,x,I,F,V,E){function C(e,t){return e.length===t.length&&e.every(function(e){return O(t,e.name)>=0})}function O(e,t){for(var i=t.toLowerCase(),r=0;r<e.length;r++)if(e[r].name.toLowerCase()===i)return r;return-1}var S=u.getLogger("esri.layers.graphics.controllers.I3SOnDemandController"),D=function(e){function t(t){var i=e.call(this)||this;return i.nodeIndex={},i.screenSizeFactor=0,i.updating=!0,i.updatingPercentage=0,i._lodFactorProperty=null,i._isIdle=!1,i._cameraDirty=!0,i._alwaysLoadEverythingModeEnabled=!1,i._uncompressedTextureDownsamplingEnabled=!1,i._processLambda=null,i._loadingNodes=new Map,i._updatingNodes=new Map,i._dirtyNodes=!1,i._numUnloadedNodes=0,i._progressMaxNumNodes=1,i._unloadedMemoryEstimate=0,i._poi=null,i._requiredAttributesDirty=!0,i._updatesDisabled=!1,i.disableCache=!1,i._restartNodeLoading=!1,i._fields=null,i._attributeStorageInfo=null,i._handles=new l,i._idleQueue=new x.IdleQueue,i._errorCount=0,i}return i(t,e),Object.defineProperty(t.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"streamDataSupplier",{get:function(){return this.layerView.view.resourceController.registerClient(this.layerView,E.ClientType.SCENE,{trackRequests:!0})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"parsedDefinitionExpression",{get:function(){if(!(this.layer instanceof f&&this.layer.definitionExpression))return null;try{var e=y.create(this.layer.definitionExpression);if(!e.isStandardized())return S.error("definitionExpression is using non standard function"),null;var t=[],i=e.getFields();return L.findFieldsCaseInsensitive(i,this.layer.fields,{missingFields:t}),t.length>0?(S.error("definitionExpression references unknown fields: "+t.join(", ")),null):e}catch(e){return S.error("Failed to parse definitionExpression: "+e),null}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"definitionExpressionFields",{get:function(){if(this.parsedDefinitionExpression){var e=this.parsedDefinitionExpression.getFields();return L.findFieldsCaseInsensitive(e,this._fields)}return null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsVertex",{get:function(){return L.getVertexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"crsIndex",{get:function(){return L.getIndexCrs(this.layer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rootNodeVisible",{get:function(){var e=this._rootNodeId&&this.nodeIndex[this._rootNodeId];return!e||!this._viewportQueries||this._viewportQueries.isNodeVisible(e)},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this.updateEventListener={needsUpdate:function(){return e._needsAnimationFrameHandler()},idleFrame:function(t){return e._processLogError(t)},idleBegin:function(){e._updateIdleState(!0)},idleEnd:function(){e._updateIdleState(!1)}},this.updateEventListenerWhileSuspended={idleBegin:function(){return e._startNodeLoadingWhileSuspended()}},this._lodHandling=new w(this.layerViewRequiredFunctions,this.layerViewOptionalFunctions,function(){return e._evaluateUpdatingState()}),this.layerView._controller=this;var t=this.layer;this._defaultGeometrySchema=t.store.defaultGeometrySchema,this._rootNodeUrl=t.store.rootNode;var i=this._rootNodeUrl.split("/");this._rootNodeId=i[i.length-1],this.disableCache=o("disable-feature:idb-cache"),t instanceof f?("mesh"===t.geometryType?this._lodFactorProperty="qualitySettings.sceneService.3dObject.lodFactor":"point"===t.geometryType&&(this._lodFactorProperty="qualitySettings.sceneService.point.lodFactor"),this._fields=t.fields,this._attributeStorageInfo=t.attributeStorageInfo):t instanceof g&&(this._lodFactorProperty="qualitySettings.sceneService.integratedMesh.lodFactor");var r=a([this.layer.when(),this.layerView.when()]).then(function(){if(!e.destroyed&&e.layerView&&!e.layerView.destroyed){var t=e.layerView.view;e.setClippingArea(t.clippingArea);var i=t.pointsOfInterest;e._centerOnSurface=i.centerOnSurfaceFrequent,e._handles.add(e._centerOnSurface.watch("renderLocation",function(){return e._pointOfInterestChanged()}));var r=e.layerView.view.resourceController;r.getMemoryEvents().on("quality-changed",function(){return e._setCameraDirty()});var o=!1;e._processLambda=e._frame.bind(e),e._handles.add(c.init(e.layerView,"suspended",function(t){o&&(r.deregisterIdleFrameWorker(e),e.restartNodeLoading()),t?(r.registerIdleFrameWorker(e,e.updateEventListenerWhileSuspended),r.deregisterFrameWorker(e._processLambda)):(r.registerIdleFrameWorker(e,e.updateEventListener),r.registerFrameWorker(e._processLambda)),o=!0}),"layerview"),e._handles.add(e.layer.watch("elevationInfo",function(t){return e._elevationInfoChanged(t)}),"layer"),e.layerView instanceof v&&e._handles.add([c.init(e.layerView,"alwaysLoadEverythingModeEnabled",function(t){e._alwaysLoadEverythingModeEnabled=t,e.restartNodeLoading()}),c.init(e.layerView,"uncompressedTextureDownsamplingEnabled",function(t){e._uncompressedTextureDownsamplingEnabled=t,e.restartNodeLoading()})],"layer"),e._handles.add(t.state.watch("camera",function(){return e._setCameraDirty()})),e._lodFactorProperty&&e._handles.add(e.layerView.view.watch(e._lodFactorProperty,function(){return e._setCameraDirty()}),"quality")}});this.addResolvingPromise(r),this.when(function(){return e._startNodeLoading()})},t.prototype.destroy=function(){this.layerView.view.resourceController.deregisterIdleFrameWorker(this),this.layerView.view.resourceController.deregisterFrameWorker(this._processLambda),this.layerView.view.resourceController.deregisterClient(this.layerView),this._handles.destroy(),this._nodeLoader=null},t.prototype._getRequiredAttributes=function(){if(!(null!=this._attributeStorageInfo&&this.layer instanceof f&&this._fields))return[];var e=Object.create(null);if(this.layer.renderer&&this.layer.renderer.collectRequiredFields(e),this.layer.labelsVisible&&this.layer.labelingInfo&&this.layer.labelingInfo.forEach(function(t){t._collectRequiredFields(e)}),null!=this.definitionExpressionFields)for(var t=0,i=this.definitionExpressionFields;t<i.length;t++){var r=i[t];e[r]=!0}var o=this._attributeStorageInfo,n=this._fields,a=this.layer.objectIdField;return Object.keys(e).map(function(e){var t=O(o,e),i=O(n,e);return t>=0&&i>=0?{index:t,name:n[i].name,field:n[i],attributeStorageInfo:o[t]}:null}).filter(function(e){return null!=e&&e.name!==a}).sort(function(e,t){return t.index-e.index}).filter(function(e,t,i){return 0===t||i[t-1].index!==e.index})},t.prototype._requiredFieldsChange=function(){this._requiredAttributesDirty=!0,this.restartNodeLoading()},t.prototype._labelingChanged=function(){C(this._requiredAttributes,this._getRequiredAttributes())||this._requiredFieldsChange()},t.prototype.setClippingArea=function(e){var t=[];F.extentToBoundingBox(e,t,this.layerView.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null},t.prototype._pointOfInterestChanged=function(){this._poi&&(this._calculatePointOfInterest(this._poi),this._viewportQueries&&this._viewportQueries.updatePointOfInterest(this._poi),this._indexLoader&&(this._indexLoader.progressiveLoadPenalty=P.distancePenalty*this._viewportQueries.distCameraToPOI(),this._indexLoader.requestReload()))},t.prototype._calculatePointOfInterest=function(e){void 0===e&&(e=I.vec3d.create());var t=this._centerOnSurface.renderLocation,i=I.vec3d.create();I.vec3d.subtract(t,this.camPos,i),I.vec3d.normalize(i);var r=this.layerView.view.renderCoordsHelper,o=I.vec3d.create();r.worldUpAtPosition(t,o);var n=Math.acos(I.vec3d.dot(o,i))-.5*Math.PI;return I.vec3d.lerp(this.camPos,t,Math.max(0,Math.min(1,n/(.5*Math.PI))),e),e},t.prototype.updateClippingArea=function(e){this.setClippingArea(e),this._cameraDirty=!0,this._viewportQueries&&this._viewportQueries.updateExtent(this._clippingArea)},t.prototype._setCameraDirty=function(){this._cameraDirty=!0,this._evaluateUpdatingState()},t.prototype.getBaseUrl=function(){return this.layer.parsedUrl.path},t.prototype.updateElevationChanged=function(e,t,i){L.findIntersectingNodes(e,t,this.nodeIndex.root,this.crsIndex,this.nodeIndex,i);for(var r=0;r<i.length;r++){var o=i.data[r];this._viewportQueries.invalidateCache(o.id),o.id===this._rootNodeId&&this.notifyChange("rootNodeVisible")}i.length&&this.restartNodeLoading()},t.prototype._elevationInfoChanged=function(e){this._viewportQueries.invalidateCache(),this._initViewData()},t.prototype.restartNodeLoading=function(){this._restartNodeLoading=!0,this._evaluateUpdatingState()},t.prototype.schedule=function(e){return this._idleQueue.push(e)},t.prototype.getUnloadedMemoryEstimate=function(){return.8*this._unloadedMemoryEstimate*this._getLodDropFactor()},t.prototype._needsAnimationFrameHandler=function(){return!0},t.prototype._frame=function(e){null!==this._viewportQueries&&this._viewportQueries.setCameraIdle(!this._cameraDirty),this.layerView.visible&&this._processLogError(e,!1)},t.prototype._processLogError=function(e,t){void 0===t&&(t=!0);try{this._process(e,t)}catch(e){this._errorCount<50?S.error("Error during processing: "+e):50===this._errorCount&&S.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}},t.prototype._process=function(e,t){if(this._restartNodeLoading&&(this.cancelNodeLoading(),this._startNodeLoading()),null!=this._nodeLoader&&null!=this._indexLoader){this._updateViewData();var i=this._indexLoader.isLoading();for(this._processIndex()&&(t=!1),i||this._dirtyNodes?t=this._processNodes(e,t):(this._numUnloadedNodes=0,this._unloadedMemoryEstimate=0);this._idleQueue.length()>0&&(t||!e.done());)t=!1,this._idleQueue.process();this._evaluateUpdatingState(),this._lodHandling.lodGlobalHandling()}},t.prototype._processIndex=function(){var e=Math.min(10-this._indexLoader.getNumLoading(),this._getAvailableLoadTokens(1));return e>0&&this._indexLoader.update(e)},t.prototype._processNodes=function(e,t){var i=this,r=Math.min(5-this._loadingNodes.size,this._getAvailableLoadTokens(2));if(r<=0)return this._dirtyNodes=!0,!1;var o=this._collectUpdates(r);return o.cancel.forEach(this._cancelNodeIdLoading,this),o.update.forEach(function(r){!t&&e.done()||(t=!1,i._updateLoadedNode(r.id))}),o.add.forEach(function(r,o){if(t||!e.done()){t=!1;var n=i.nodeIndex[o];i._loadNode(n)}}),this._dirtyNodes=o.update.length>0||o.add.size>0,t},t.prototype._cancelNodeLoading=function(){var e=this;this._loadingNodes.forEach(function(t,i){return e._cancelNodeIdLoading(i)}),this._loadingNodes.clear(),this._updatingNodes.forEach(function(t,i){return e._updatingNodes.get(i).cancel()}),this._updatingNodes.clear()},t.prototype._cancelNodeIdLoading=function(e){this._loadingNodes.get(e).cancel(),this._loadingNodes.delete(e)},t.prototype._getAvailableLoadTokens=function(e){return Math.floor((12-1*this._indexLoader.getNumLoading()-2*this._loadingNodes.size)/e)},t.prototype._collectUpdates=function(e){var t=this,i=new Map,r=[],o=L.mapToKeys(this._loadingNodes),n=Number.NEGATIVE_INFINITY,a=0,s=0,d=0,l=0,u=0;this._numUnloadedNodes=0;var h=function(h){var p=t.nodeIndex[h.id];return p?!(!p.failed&&p.featureData&&0!==p.featureData.length)||(t.layerViewRequiredFunctions.isBundleLoaded(p)?(a+=p.memory,++s,t._shouldLoadNode(p)||(u+=p.memory),t._needsUpdate(p)&&r.push({prio:t._indexLoader.entryPriority(p),id:p.id}),!0):(p.memory&&(a+=p.memory,++s),!t._shouldLoadNode(p)||(++t._numUnloadedNodes,p.memory?l+=p.memory:++d,t._loadingNodes.has(p.id)?(o=o.filter(function(e){return e!==p.id}),!0):(L.buildTopNodeMap(i,e,p.id,t._indexLoader.entryPriority(h)),!0)))):(n=Math.max(n,t._indexLoader.entryPriority(h)),!0)};return this._indexLoader.traverseVisible(h),this._unloadedMemoryEstimate=l-u,s>3&&(this._unloadedMemoryEstimate+=d*a/s),this._unloadedMemoryEstimate=Math.max(0,this._unloadedMemoryEstimate),i.forEach(function(e,t){e<n&&i.delete(t)}),r.sort(function(e,t){return t.prio-e.prio}),{update:r,add:i,cancel:o}},t.prototype._evaluateUpdatingState=function(){var e=this._indexLoader?this._indexLoader.getNumPending():0,t=e+3*this._numUnloadedNodes+2*this._loadingNodes.size,i=!(!(t>0||this._updatingNodes.size>0||this._indexLoader&&this._indexLoader.isLoading()||this._restartNodeLoading||this._cameraDirty||this._idleQueue.length()>0||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling)&&this._isIdle);0===t&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(t,this._progressMaxNumNodes),i!==this._get("updating")&&this._set("updating",i);var r=100*t/this._progressMaxNumNodes;r!==this._get("updatingPercentage")&&this._set("updatingPercentage",r)},t.prototype._initViewData=function(){var e=this.layerView.view,t=e.state.camera,i=e.renderCoordsHelper;this.camPos=I.vec3d.create(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/t.perPixelRatio,this._poi=this._calculatePointOfInterest();var r=(this._lodFactorProperty&&this.layerView.view.get(this._lodFactorProperty)||1)*this._getLodMemoryFactor(),o=null!=this.layerViewOptionalFunctions.traversalOptions?this.layerViewOptionalFunctions.traversalOptions.errorMetricPreference:null;this._viewportQueries=new N(this.crsIndex,i,t,this._poi,this._clippingArea,o,e.elevationProvider,this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(this.layer,r),screenspaceErrorBias:r,angleDependentLoD:r<.5,disableLod:this._alwaysLoadEverythingModeEnabled}),this._cameraDirty=!1,this.notifyChange("rootNodeVisible")},t.prototype._updateViewData=function(){if(this._cameraDirty&&this._indexLoader){var e=this.layerView.view,t=e.state.camera;this.camPos=I.vec3d.create(e.pointsOfInterest.renderPointOfView),this.screenSizeFactor=1/t.perPixelRatio,this._poi=this._calculatePointOfInterest(this._poi),this._viewportQueries.updateCamera(t),this._viewportQueries.updatePointOfInterest(this._poi);var i=(this._lodFactorProperty&&this.layerView.view.get(this._lodFactorProperty)||1)*this._getLodMemoryFactor();this._viewportQueries.updateScreenSpaceErrorBias(i),this._indexLoader.progressiveLoadPenalty=P.distancePenalty*this._viewportQueries.distCameraToPOI(),this._indexLoader.requestReload(),this._alwaysLoadEverythingModeEnabled||this._removeInvisibleNodes(),this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}},t.prototype._getProgressiveLoadFactor=function(e,t){if(e instanceof f&&"mesh"===e.geometryType){var i=t>=1&&o("enable-feature:progressive-3dobject");return i?P.factor3dObject:1}if(e instanceof g){var i=t>=1&&!o("disable-feature:progressive-im");return i?P.factorIM:1}return 1},t.prototype._getLodMemoryFactor=function(){return this.layerView.view.resourceController.getMemoryFactor()},t.prototype._getLodDropFactor=function(){return Math.min(this._getLodMemoryFactor(),.5)/.5},t.prototype._startNodeLoadingWhileSuspended=function(){this._initViewData(),this._alwaysLoadEverythingModeEnabled&&this.layerView.visible&&!this.layerView.get("parent.suspended")||this._removeInvisibleNodes()},t.prototype.isGeometryVisible=function(e){return this._viewportQueries.isGeometryVisible(e)},t.prototype._shouldLoadNode=function(e){if(!this._lodHandling.shouldLoadNode(e))return!1;var t=this._getLodDropFactor();return!(t>0&&this._viewportQueries.maxDistance>0&&this._lodHandling.childrenEmpty(e)&&this._viewportQueries.distToPOI(e)>this._viewportQueries.maxDistance*t)&&(!e.obb||this._viewportQueries.isGeometryVisible(e))},t.prototype._startNodeLoading=function(){var e=this;if(this._restartNodeLoading=!1,!this._updatesDisabled&&null!=this.streamDataSupplier){this._initViewData(),null!=this.layerViewOptionalFunctions.getLoadedAttributes&&this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1,this._handles.add([this.layer.watch("renderer",function(){return e._requiredFieldsChange()}),this.layer.watch("definitionExpression",function(){return e._requiredFieldsChange()}),this.layer.watch("labelsVisible",function(){return e._labelingChanged()}),this.layer.watch("labelingInfo",function(){return e._labelingChanged()})],"requiredAttributes"));var t=this.layerViewOptionalFunctions.textureOptions,i=b.TextureFormat.Normal;t&&t.useCompressedTextures?i=b.TextureFormat.Compressed:this._uncompressedTextureDownsamplingEnabled&&(i=b.TextureFormat.Downsampled);var r=this._defaultGeometrySchema,o={textureFormat:i,loadTextureData:this.layerView instanceof v&&this.layerView.rendererNeedsTextures,loadFeatureData:!this.isMeshPyramid||null==r||null==r.ordering};this._nodeLoader=new b(this.streamDataSupplier,S,r,this._requiredAttributes,o);var n=P.distancePenalty*this._viewportQueries.distCameraToPOI();this._indexLoader=new m(this.getBaseUrl(),this._rootNodeUrl,this._rootNodeId,n,this.nodeIndex,this.streamDataSupplier,this._viewportQueries,S),this._alwaysLoadEverythingModeEnabled||this._removeInvisibleNodes(),this._lodHandling.startNodeLoading(function(t){return e._viewportQueries.isNodeVisible(t)},function(t){return e._viewportQueries.isGeometryVisible(t)},function(t){return e._indexLoader.nodeTraversalState(t)},this.nodeIndex,this._rootNodeId,{maxLodLevel:this._viewportQueries.maxLodLevel}),this.layerViewOptionalFunctions.additionalStartNodeLoadingHandler&&this.layerViewOptionalFunctions.additionalStartNodeLoadingHandler(),this._evaluateUpdatingState()}},t.prototype.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._indexLoader},t.prototype.cancelNodeLoading=function(){this.isNodeLoading()&&(this._indexLoader.cancel(),this._nodeLoader.cancel(),this.streamDataSupplier.cancelAll(),this._idleQueue.cancelAll(),this._cancelNodeLoading(),this._nodeLoader=null,this._indexLoader=null,this._poi=null,this.layerViewOptionalFunctions.additionalCancelNodeLoadingHandler&&this.layerViewOptionalFunctions.additionalCancelNodeLoadingHandler(),this._evaluateUpdatingState())},t.prototype._removeInvisibleNodes=function(){for(var e=this.layerViewRequiredFunctions.getAddedNodeIDs(),t=this._getLodDropFactor(),i=this._viewportQueries.maxDistance*t,r=t>0&&i>0,o=0;o<e.length;o++){var n=e[o],a=this.nodeIndex[n];(!this._viewportQueries.isGeometryVisible(a)||r&&this._lodHandling.childrenEmpty(a)&&this._viewportQueries.distToPOI(a)>i)&&(this._lodHandling.setLodGlobalDirty(),this.layerViewRequiredFunctions.removeNodeData(a))}},t.prototype._needsUpdate=function(e){if(null==e.featureData||0===e.featureData.length||this._updatingNodes.has(e.id))return!1;var t=this.layerViewOptionalFunctions.getLoadedAttributes,i=null!=t?t(e):void 0;return null!=i&&i!==this._requiredAttributes},t.prototype._updateLoadedNode=function(e){var t=this,i=this.nodeIndex[e],r=i.baseUrl,o=this.layerViewOptionalFunctions.getLoadedAttributes(i),a=C(o,this._requiredAttributes)?p.resolve(this.layerViewOptionalFunctions.getAttributeData(i)):this._nodeLoader.loadAttributes(i,r,this._requiredAttributes);this._updatingNodes.set(e,a),a.then(function(e){return t.schedule().then(function(){return t.layerViewOptionalFunctions.setAttributeData(i,t._requiredAttributes,e)})}).catch(function(e){e instanceof n||t.layerViewOptionalFunctions.setAttributeData(i,t._requiredAttributes,{})}).always(function(){t._updatingNodes.delete(e),t._evaluateUpdatingState()}),this._evaluateUpdatingState()},t.prototype._loadNode=function(e){var t=this,i=new V.Promise;return this._loadingNodes.set(e.id,i),this._evaluateUpdatingState(),this._loadAndAddBundle(e).always(function(){t._loadingNodes.delete(e.id),t._evaluateUpdatingState(),i.done()}),i},t.prototype._loadAndAddBundle=function(e){var t=this;return 1!==e.featureData.length&&S.warn("Node ${node.id} has ${node.featureData.length} bundles. Only the first bundle will be loaded."),this._loadCached(e).then(function(i){if(!i)return t._loadUncached(e)}).catch(function(i){if(!(i instanceof n))return t._loadUncached(e)})},t.prototype._loadCached=function(e){var t=this,i=this.disableCache?null:this.layerViewOptionalFunctions.loadCachedBundle,r=this.disableCache?null:this.layerViewOptionalFunctions.addCachedBundle;return i&&r?this.schedule().then(function(){return i(e,function(e,i){return t._nodeLoader.loadTextures(e,i)})}).then(function(i){if(null==i)return!1;var o=t._requiredAttributes;return t.schedule().then(function(){return t._nodeLoader.loadAttributes(e,e.baseUrl,o)}).then(function(e){return t.schedule({loadedAttributes:o,attributeData:e})}).then(function(t){return r(e,i,t)}).then(function(){return t._lodHandling.lodSwapBundleLoaded(e),!0})}):p.resolve(!1)},t.prototype._loadUncached=function(e){var t=this;return this.schedule().then(function(){return t._nodeLoader.loadBundleData(e,0)}).then(function(e){return t.schedule(e)}).then(function(i){return t.layerViewRequiredFunctions.addBundle(e,i)}).then(function(){return t._lodHandling.lodSwapBundleLoaded(e)}).catch(function(t){t instanceof n||(S.error("Failed to load node '"+e.id+"' bundle 0: "+t),e.failed=!0)})},t.prototype._updateIdleState=function(e){e!==this._isIdle&&(this._isIdle=e,this._viewportQueries&&this._viewportQueries.setCameraIdle(!0),this._evaluateUpdatingState())},r([_.property({readOnly:!0})],t.prototype,"isMeshPyramid",null),r([_.property({readOnly:!0})],t.prototype,"streamDataSupplier",null),r([_.property({readOnly:!0,dependsOn:["layer.definitionExpression"]})],t.prototype,"parsedDefinitionExpression",null),r([_.property({readOnly:!0,dependsOn:["parsedDefinitionExpression"]})],t.prototype,"definitionExpressionFields",null),r([_.property({readOnly:!0})],t.prototype,"crsVertex",null),r([_.property({readOnly:!0})],t.prototype,"crsIndex",null),r([_.property({readOnly:!0})],t.prototype,"nodeIndex",void 0),r([_.property()],t.prototype,"camPos",void 0),r([_.property()],t.prototype,"screenSizeFactor",void 0),r([_.property()],t.prototype,"layerView",void 0),r([_.property()],t.prototype,"layerViewRequiredFunctions",void 0),r([_.property()],t.prototype,"layerViewOptionalFunctions",void 0),r([_.property()],t.prototype,"layer",void 0),r([_.property({readOnly:!0})],t.prototype,"updating",void 0),r([_.property({readOnly:!0})],t.prototype,"updatingPercentage",void 0),r([_.property({readOnly:!0})],t.prototype,"rootNodeVisible",null),t=r([_.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],t)}(_.declared(s,h,d)),P={factorIM:.2,factor3dObject:.05,distancePenalty:10};return D});