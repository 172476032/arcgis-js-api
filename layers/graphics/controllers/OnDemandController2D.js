// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessorSupport/decorators","../../../core/Accessor","../../../core/Evented","../../../core/HandleRegistry","../../../core/Promise","../../../geometry/Extent","./support/TileSet","../../../views/2d/layers/support/TileQueue","../../../views/2d/layers/support/TileStrategy","../../../views/2d/layers/support/TileInfoView","../../../views/2d/layers/support/TileKey","../../support/GraphicsManager","../../support/TileInfo"],function(e,t,r,n,i,a,o,s,u,c,l,p,f,d,h,y,g){var _=(function(){function e(){}return e.prototype.dispose=function(){},e}(),function(e){function t(t){var r=e.call(this)||this;r._handles=new s,r._pendingQueries=new Map,r.layer=t.layer,r.layerView=t.layerView,r.graphics=t.graphics,r._tileInfo=g.create({spatialReference:r.layerView.view.spatialReference,size:512}),r._tileInfoView=new d(r._tileInfo),r._tileQueue=new p({tileInfoView:r._tileInfoView,process:function(e){return r._fetchTile(e)}}),r._tileSet=new l({layer:r.layer,tileInfo:r._tileInfo}),r._graphicsManager=new y({graphics:r.graphics,objectIdField:r.layer.objectIdField});var n={addTile:function(e){r._graphicsManager.add(e.featureSet.features,e.intentId),r._graphicsManager.removeIntent(e.intentId)},removeTile:function(e){r._graphicsManager.remove(e.featureSet.features)},removeAllTiles:function(){r._graphicsManager.removeAll()}};return r._tileStrategy=new f({container:n,fetchTile:function(e){return r._tileQueue.push(h.from(e))},requestUpdate:function(){return r.layerView.requestUpdate()},tileInfoView:r._tileInfoView,cachePolicy:"purge"}),r._handles.add([r.layer.watch("definitionExpression",function(){return r._refresh()}),r.layer.on("edits",function(e){return r._editsHandler(e)})],"layer"),r}return r(t,e),t.prototype.destroy=function(){this._handles.destroy(),this._graphicsManager.destroy(),this._tileStrategy.destroy(),this._tileQueue.clear(),this._pendingQueries.forEach(function(e){e.isFulfilled()||e.cancel()})},Object.defineProperty(t.prototype,"graphics",{set:function(e){var t=this,r=this._get("graphics");r!==e&&(this._handles.remove("graphics"),r&&r.forEach(function(e){return e.layer=null}),e&&(e.forEach(function(e){return e.layer=t.layer}),this._handles.add([e.on("after-add",function(e){return e.item.layer=t.layer}),e.on("after-remove",function(e){return e.item.layer=null})],"graphics")),this._set("graphics",e))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._tileStrategy.updating||this._pendingQueries.size>0},enumerable:!0,configurable:!0}),t.prototype.update=function(e){this._tileQueue.pause(),this._tileQueue.state=e.state,this._tileStrategy.update(e),this._tileQueue.resume(),this.notifyChange("updating")},t.prototype._fetchTile=function(e){var t=this,r=this._graphicsManager.createIntentToAdd(),n=this._tileSet.fetch(e).then(function(t){return{key:e,intentId:r,attached:!0,coords:[0,0],featureSet:t,dispose:function(){}}});return n.otherwise(function(){return t._graphicsManager.removeIntent(r)}),n},t.prototype._refresh=function(){var e=this;this._tileQueue.reset(),this._tileStrategy.updateTiles(function(t){var r=e._graphicsManager.createIntentToAdd(),n=e._tileSet.fetch(t.key).then(function(n){return e._graphicsManager.remove(t.featureSet.features),t.intentId=r,t.featureSet=n,e._graphicsManager.add(t.featureSet.features,t.intentId),t});return n.always(function(){return e._graphicsManager.removeIntent(r)}),n}),this.notifyChange("updating")},t.prototype._editsHandler=function(e){var t=this,r=function(e){return e.objectId},n=e.deletedFeatures.map(r);this._graphicsManager["delete"](n);var i=e.addedFeatures.concat(e.updatedFeatures).map(r);if(i.length){var a=this.layer.createQuery();a.objectIds=i,a.outSpatialReference=this._tileInfo.spatialReference;var o=this._graphicsManager.createIntentToAdd(i),s=this.layer.queryFeatures(a);this._pendingQueries.set(o,s),this.notifyChange("updating"),s.then(function(e){return t._refetchHandler(e,o)}).always(function(){t._graphicsManager.removeIntent(o),t._pendingQueries["delete"](o),t.notifyChange("updating")})}},t.prototype._refetchHandler=function(e,t){var r=this,n=e.features;if(n){var i=this._tileInfo.spatialReference;this._tileStrategy.tiles.forEach(function(e,t){var a=e.key.extent,o=new c({xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:i});n.forEach(function(t){t.geometry&&o.intersects(t.geometry)&&r._addFeatureToTile(t,e)})}),this._graphicsManager.add(n,t)}},t.prototype._addFeatureToTile=function(e,t){var r,n=t.featureSet.features||[],i=this.layer.objectIdField,a=e.attributes&&e.attributes[i];n.some(function(e){var t=e.attributes&&e.attributes[i];return t===a&&(r=e),!!r}),r?(r.geometry=e.geometry,r.attributes=e.attributes):n.push(e),t.featureSet.features=n},t}(i.declared(a,u,o)));return n([i.property()],_.prototype,"graphics",null),n([i.property()],_.prototype,"layer",void 0),n([i.property()],_.prototype,"layerView",void 0),n([i.property()],_.prototype,"updating",null),_=n([i.subclass("esri.layers.graphics.controllers.OnDemandController2D")],_)});