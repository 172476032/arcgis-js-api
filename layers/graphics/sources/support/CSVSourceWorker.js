// COPYRIGHT © 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","@dojo/shim/Set","dojo/has","dojo/number","dstore/Csv","../../../../geometry","../../../../request","../../../../core/Error","../../../../core/promiseUtils","../../../../core/urlUtils","../../../../geometry/projection","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/support/webMercatorUtils","../../data/FeatureStore","../../../../tasks/support/Query"],function(e,t,r,i,n,o,a,l,u,s,d,f,c,p,m,y,g){Object.defineProperty(t,"__esModule",{value:!0});var h=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong"],F=["lat","latitude","y","ycenter","latitude83","latdecdeg","POINT-Y"],v=["lon","lng","long","longitude","x","xcenter","longitude83","longdecdeg","POINT-X"],N=[","," ",";","|","\t"],b=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i,_=[0,0],I=function(){function e(e,t){this.x=e,this.y=t}return e}(),x=function(){var e=o._parseInfo(),t=new RegExp("^"+e.regexp+"$"),r=new RegExp("["+e.group+"\\s\\xa0]","g"),i=e.factor;return function(n){var o=t.exec(n);if(e.factor=i,!o)return NaN;var a=o[1];if(!o[1]){if(!o[2])return NaN;a=o[2],e.factor*=-1}return+(a=a.replace(r,"").replace(e.decimal,"."))*e.factor}}(),T=function(){function e(){this._store=null}return e.prototype.load=function(e){var t=this;return d.all([this._fetch(e.url),this._checkProjection(e)]).then(function(r){var i=r[0],n=t._parse(i,e.parsing);return t._store=t._createStore(i,n),t._store.executeQueryForExtent().then(function(e){return n.layerDefinition.extent=e.extent,n})})},e.prototype.queryFeatures=function(e){return this._store.executeQuery(g.fromJSON(e))},e.prototype.queryFeatureCount=function(e){return this._store.executeQueryForCount(g.fromJSON(e))},e.prototype.queryObjectIds=function(e){return this._store.executeQueryForIds(g.fromJSON(e))},e.prototype.queryExtent=function(e){return this._store.executeQueryForExtent(g.fromJSON(e))},e.prototype._fetch=function(e){if(!e)return d.reject(new s("csv-source:invalid-source","url not defined"));var t=f.urlToObject(e);return u(t.path,{query:t.query,responseType:"text"}).then(function(e){return e.data})},e.prototype._parse=function(e,t){var r={columnDelimiter:t.columnDelimiter,layerDefinition:null,locationInfo:{latitudeFieldName:t.latitudeField,longitudeFieldName:t.longitudeField}},i=this._readFirstLine(e);if(!i)throw new s("csv","CSV is empty");if(!t.columnDelimiter){var n=this._inferDelimiter(i);if(!n)throw new s("csv","Unable to detect the delimiter from CSV");r.columnDelimiter=n}var o=i.split(r.columnDelimiter),a=r.layerDefinition={name:"csv",geometryType:"esriGeometryPoint",objectIdField:null,fields:[],extent:{xmin:Number.POSITIVE_INFINITY,ymin:Number.POSITIVE_INFINITY,xmax:Number.NEGATIVE_INFINITY,ymax:Number.NEGATIVE_INFINITY,spatialReference:t.spatialReference||{wkid:102100}}};if(!t.latitudeField||!t.longitudeField){var l=this._inferLocationInfo(o);if(!t.longitudeField&&!l.longitudeFieldName||!t.latitudeField&&!l.latitudeFieldName)throw new s("csv","Unable to identify latitudeField and/or longitudeField from CSV");r.locationInfo={longitudeFieldName:t.longitudeField||l.longitudeFieldName,latitudeFieldName:t.latitudeField||l.latitudeFieldName}}return t.fields&&t.fields.length?a.fields=t.fields:a.fields=this._inferFields(e,r.columnDelimiter,o,r.locationInfo),a.fields.some(function(e){return"esriFieldTypeOID"===e.type&&(a.objectIdField=e.name,!0)})||(a.objectIdField="__OBJECTID",a.fields.unshift({name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",domain:null})),r},e.prototype._inferLocationInfo=function(e){var t=null,r=null;return e.forEach(function(e){var i,n=e.toLowerCase();i=F.indexOf(n),-1===i||r||(r=e),-1===(i=v.indexOf(n))||t||(t=e)}),{longitudeFieldName:t,latitudeFieldName:r}},e.prototype._inferFields=function(e,t,r,i){for(var n=[],o=this._sampleLines(e).map(function(e){return e.split(t).map(function(e){return e.trim()})}),a=this,l=0;l<r.length;l++)!function(e){var t=r[e];if(t===i.longitudeFieldName||t===i.latitudeFieldName)n.push({name:t,alias:t,type:"esriFieldTypeDouble",domain:null});else{var l=o.map(function(t){return t[e]}),u=a._inferFieldType(l),s={name:t.replace(/[\s\'’‘\.\-\/\(\)]+/g,"_"),type:null,alias:t,domain:null,editable:!0,nullable:!0};switch(u){case"integer":s.type="esriFieldTypeInteger";break;case"double":s.type="esriFieldTypeDouble";break;case"date":s.type="esriFieldTypeDate",s.length=36;break;default:s.type="esriFieldTypeString",s.length=255}n.push(s)}}(l);return n},e.prototype._inferFieldType=function(e){var t=this,r=/[^+-.,0-9]/;return e.map(function(e){var i=!1;if(""===e||r.test(e))i=!0;else{var n=x(e);if(!isNaN(n))return/[.,]/.test(e)?"double":n>214783647||n<-214783648?"double":"integer";if(-1===e.indexOf("E"))i=!0;else{if(n=Number(e),!isNaN(n))return"double";if(-1===e.indexOf(","))i=!0;else{if(e=e.replace(",","."),n=Number(e),!isNaN(n))return"double";i=!0}}}if(i){if(/^[-]?\d*[.,]?\d*$/.test(e))return"string";var o=new Date(e);return t._isValidDate(o,e)?"date":"string"}return"string"}).reduce(function(e,t){return e===t?t:"string"===e||"string"===t?"string":"double"===e||"double"===t?"double":void 0})},e.prototype._isValidDate=function(e,t){if(!e||"[object Date]"!==Object.prototype.toString.call(e)||isNaN(e.getTime()))return!1;var r=!0;if(n("chrome")&&/\d+\W*$/.test(t)){var i=t.match(/[a-zA-Z]{2,}/);if(i){for(var o=!1,a=0;!o&&a<=i.length;)o=!b.test(i[a]),a++;r=!o}}return r},e.prototype._readFirstLine=function(e){return e.substring(0,e.indexOf("\n")).trim()},e.prototype._sampleLines=function(e,t){void 0===t&&(t=10);for(var r=!1,i=[],n=e.indexOf("\n")+1;!r&&i.length<t;){var o=e.indexOf("\n",n);-1===o&&(r=!0);var a=void 0;a=-1===o&&n<e.length-1?e.substring(n).trim():e.substring(n,o).trim(),a&&i.push(a),n=o+1}return i},e.prototype._inferDelimiter=function(e){var t=0,r="";return N.forEach(function(i){var n=e.split(i).length;n>t&&(t=n,r=i)}),""===r?null:r},e.prototype._createStore=function(e,t){for(var n=t.locationInfo,o=n.latitudeFieldName,u=n.longitudeFieldName,s=t.layerDefinition,d=s.objectIdField,f=s.fields,g=s.extent,F=[],v=[],N=new i.Set,b=new i.Set,T=[],D=0,S=f;D<S.length;D++){var j=S[D],w=j.name,O=j.type;"esriFieldTypeDate"===O?N.add(w):h.indexOf(O)>-1&&b.add(w),w!==d&&T.push(w)}var E=new a;E.delimiter=t.columnDelimiter,E.fieldNames=T,E.newline="\n";var C=E.parse(e),R=0;C.shift();for(var V=0,P=C;V<P.length;V++){var G=P[V],Q=this._parseCoordinateValue(G[o]),k=this._parseCoordinateValue(G[u]);if(null!=k&&null!=Q&&!isNaN(Q)&&!isNaN(k)){for(var q in G)if(q!==o&&q!==u)if(N.has(q)){var L=new Date(G[q]);G[q]=this._isValidDate(L,G[q])?L.getTime():null}else if(b.has(q)){var J=x(G[q]);isNaN(J)?G[q]=null:G[q]=J}G[d]=R,R++,F.push(new I(k,Q)),v.push(G)}}if(!p.equals({wkid:4326},g.spatialReference))if(p.isWebMercator(g.spatialReference))for(var M=0,U=F;M<U.length;M++){var Y=U[M];A=m.lngLatToXY(Y.x,Y.y,_),Y.x=A[0],Y.y=A[1]}else F=c.projectMany(F,l.SpatialReference.WGS84,g.spatialReference,null,!0);var z=new y.default({fields:t.layerDefinition.fields,geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1,objectIdField:t.layerDefinition.objectIdField,spatialReference:g.spatialReference||{wkid:4326},cacheSpatialQueries:!0});return z.load({oids:function(){var e,t;return r(this,function(r){switch(r.label){case 0:e=F.length,t=0,r.label=1;case 1:return t<e?[4,t]:[3,4];case 2:r.sent(),r.label=3;case 3:return t++,[3,1];case 4:return[2]}})},getAttributes:function(e){return v[e]},getBounds:function(e){var t=F[e];return[t.x,t.y,t.x,t.y]},getCentroid:function(e){return this.getGeometry(e)},getCentroidQuantized:function(e,t,r,i){return this.getGeometryQuantized(e,t,r,i)},getGeometry:function(e){return F[e]},getGeometryQuantized:function(e,t,r,i){var n=F[e],o=n.x,a=n.y;return{x:r(o),y:i(a)}}}),z;var A},e.prototype._parseCoordinateValue=function(e){if(null==e||""===e)return null;var t=x(e);return(isNaN(t)||Math.abs(t)>181)&&(t=parseFloat(e)),t},e.prototype._checkProjection=function(e){var t=e.parsing.spatialReference;return!t||m.canProject(l.SpatialReference.WGS84,t)?d.resolve():c.isSupported()?c.load():d.reject(new s("csv-layer","Projection not supported"))},e}();t.default=T});