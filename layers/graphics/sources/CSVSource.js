// COPYRIGHT © 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../core/tsSupport/decorateHelper","dojo/has","dojo/number","dstore/Csv","../../../core/accessorSupport/decorators","../../../core/Accessor","../../../core/Error","../../../core/Promise","../../../core/promiseUtils","../../../core/urlUtils","../../../request","../../../geometry","../../../geometry/support/webMercatorUtils","../../../tasks/support/FeatureSet","../stores/SparsePointFeatureStore"],function(e,t,r,i,n,o,l,u,s,a,d,p,f,c,h,y,m,g){var v=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong"],F=["lat","latitude","y","ycenter","latitude83","latdecdeg","POINT-Y"],b=["lon","lng","long","longitude","x","xcenter","longitude83","longdecdeg","POINT-X"],x=[","," ",";","|","	"],_=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i,S=function(){var e=o._parseInfo(),t=new RegExp("^"+e.regexp+"$"),r=new RegExp("["+e.group+"\\s\\xa0]","g"),i=e.factor;return function(n){var o=t.exec(n);if(e.factor=i,!o)return NaN;var l=o[1];if(!o[1]){if(!o[2])return NaN;l=o[2],e.factor*=-1}return l=l.replace(r,"").replace(e.decimal,"."),+l*e.factor}}(),N=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.delimiter=null,t.fields=null,t.latitudeField=null,t.longitudeField=null,t.layerDefinition=null,t.url=null,t}return r(t,e),t.prototype.initialize=function(){this.addResolvingPromise(this._fetchCSV())},Object.defineProperty(t.prototype,"parsedUrl",{get:function(){return this.url?f.urlToObject(this.url):null},enumerable:!0,configurable:!0}),t.prototype.buildIndex=function(){var e=this;return this._storePromise?this._storePromise:(this._storePromise=this._fetchCSVText().then(function(t){var r=e._parseFeatures(e._data),i=new g({numFeatures:r.coords.length,fields:e.layerDefinition.fields,objectIdField:e.layerDefinition.objectIdField,spatialReference:h.SpatialReference.WebMercator,readCoordinates:function(e,t){return 0===e&&t===r.coords.length?r.coords:r.coords.slice(e,e+t)},readFeatureAttributes:function(e){return r.attributes[e]}});return i}),this._storePromise)},t.prototype.queryFeaturesJSON=function(e){return this.buildIndex().then(function(t){return t.execute(e)})},t.prototype.queryFeatures=function(e){return this.buildIndex().then(function(t){return t.execute(e)}).then(function(e){return m.fromJSON(e)})},t.prototype.queryFeatureCount=function(e){return this.buildIndex().then(function(t){return t.executeForCount(e)})},t.prototype.queryObjectIds=function(e){return this.buildIndex().then(function(t){return t.executeForIds(e)})},t.prototype.queryExtent=function(e){return this.buildIndex().then(function(t){return t.executeForExtent(e)})},t.prototype._fetchCSV=function(){var e=this;return this._fetchCSVText().then(function(t){return e._processCSV(t)})},t.prototype._fetchCSVText=function(){var e=this;this._data&&p.resolve(this._data);var t=this.parsedUrl;return t||p.reject(new a("csv-source:invalid-source","url not defined")),c(t.path,{query:t.query,responseType:"text"}).then(function(t){var r=e.url;return t.ssl&&(e.url=r.replace(/^http:/i,"https:")),e._data=t.data,t.data})},t.prototype._processCSV=function(e){var t=this._readFirstLine(e);if(!t)return p.reject(new a("CSVSource","CSV is empty"));if(!this.delimiter){var r=this._inferDelimiter(t);if(!r)return p.reject(new a("CSVSource","Unable to detect the delimiter from CSV"));this.delimiter=r}var i=t.split(this.delimiter);if(!this.latitudeField||!this.longitudeField){var n=this._inferCoordinateFields(i),o=n.longitudeField,l=n.latitudeField;if(!this.longitudeField&&!o||!this.latitudeField&&!l)return p.reject(new a("CSVSource","Unable to identify latitudeField and/or longitudeField from CSV"));this.longitudeField=this.longitudeField||o,this.latitudeField=this.latitudeField||l}if(!this.layerDefinition){var u=this.layerDefinition={name:"csv",geometryType:"esriGeometryPoint",objectIdField:"__OBJECTID",fields:[{name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",domain:null}],extent:null};if(this.fields&&this.fields.length)u.fields=this.fields.map(function(e){return e.toJSON()});else{var s=this._inferFields(e,this.delimiter,i,this.latitudeField,this.longitudeField);(f=u.fields).push.apply(f,s)}var d=this._inferExtent(e,this.delimiter,i,this.latitudeField,this.longitudeField);u.extent=d}var f},t.prototype._inferFields=function(e,t,r,i,n){for(var o=[],l=this._sampleLines(e).map(function(e){return e.split(t).map(function(e){return e.trim()})}),u=function(e){var t=r[e];if(t===i||t===n)o.push({name:t,alias:t,type:"esriFieldTypeDouble",domain:null});else{var u=l.map(function(t){return t[e]}),a=s._inferFieldType(u),d={name:t.replace(/[\s\'’‘\.\-\/\(\)]+/g,"_"),type:null,alias:t,domain:null,editable:!0,nullable:!0};switch(a){case"integer":d.type="esriFieldTypeInteger";break;case"double":d.type="esriFieldTypeDouble";break;case"date":d.type="esriFieldTypeDate",d.length=36;break;default:d.type="esriFieldTypeString",d.length=255}o.push(d)}},s=this,a=0;a<r.length;a++)u(a);return o},t.prototype._inferFieldType=function(e){var t=this,r=/[^+-.,0-9]/,i=e.map(function(e){var i=!1;if(""===e||r.test(e))i=!0;else{var n=S(e);if(!isNaN(n))return/[.,]/.test(e)?"double":n>214783647||-214783648>n?"double":"integer";if(-1===e.indexOf("E"))i=!0;else{if(n=Number(e),!isNaN(n))return"double";if(-1===e.indexOf(","))i=!0;else{if(e=e.replace(",","."),n=Number(e),!isNaN(n))return"double";i=!0}}}if(i){if(/^[-]?\d*[.,]?\d*$/.test(e))return"string";var o=new Date(e);return t._isValidDate(o,e)?"date":"string"}return"string"});return i.reduce(function(e,t){return e===t?t:"string"===e||"string"===t?"string":"double"===e||"double"===t?"double":void 0})},t.prototype._isValidDate=function(e,t){if(!e||"[object Date]"!==Object.prototype.toString.call(e)||isNaN(e.getTime()))return!1;var r=!0;if(n("chrome")&&/\d+\W*$/.test(t)){var i=t.match(/[a-zA-Z]{2,}/);if(i){for(var o=!1,l=0;!o&&l<=i.length;)o=!_.test(i[l]),l++;r=!o}}return r},t.prototype._inferExtent=function(e,t,r,i,n){return{xmin:-20037508.342787,ymin:-20037508.34278,xmax:20037508.34278,ymax:20037508.342787,spatialReference:{wkid:102100}}},t.prototype._parseCoordinateValue=function(e){var t=S(e);return(isNaN(t)||Math.abs(t)>181)&&(t=parseFloat(e)),t},t.prototype._readFirstLine=function(e){return e.substring(0,e.indexOf("\n")).trim()},t.prototype._sampleLines=function(e,t){void 0===t&&(t=10);for(var r=!1,i=[],n=e.indexOf("\n")+1;!r&&i.length<t;){var o=e.indexOf("\n",n);-1===o&&(r=!0);var l=void 0;l=-1===o&&n<e.length-1?e.substring(n).trim():e.substring(n,o).trim(),l&&i.push(l),n=o+1}return i},t.prototype._inferDelimiter=function(e){var t=0,r="";return x.forEach(function(i){var n=e.split(i).length;n>t&&(t=n,r=i)}),""===r?null:r},t.prototype._inferCoordinateFields=function(e){var t=null,r=null;return e.forEach(function(e){var i,n=e.toLowerCase();i=F.indexOf(n),-1===i||r||(r=e),i=b.indexOf(n),-1===i||t||(t=e)}),{longitudeField:t,latitudeField:r}},t.prototype._parseFeatures=function(e){for(var t=this.latitudeField,r=this.longitudeField,i=[],n=[],o=[],u=[],s=[],a=this.layerDefinition,d=a.objectIdField,p=a.fields,f=0,c=p;f<c.length;f++){var h=c[f];"esriFieldTypeDate"===h.type?o.push(h.name):v.indexOf(h.type)>-1&&u.push(h.name),h.name!==d&&s.push(h.name)}var m=new l;m.delimiter=this.delimiter,m.fieldNames=s,m.newline="\n";var g=m.parse(e),F=0;g.shift();for(var b=0,x=g;b<x.length;b++){var _=x[b];for(var N in _)if(o.indexOf(N)>-1){var T=new Date(_[N]);_[N]=this._isValidDate(T,_[N])?T.getTime():null}else if(u.indexOf(N)>-1){var C=S(_[N]);N!==t&&N!==r||!(isNaN(C)||Math.abs(C)>181)||(C=parseFloat(_[N])),isNaN(C)?_[N]=null:_[N]=C}var D=_[t],O=_[r];_[this.layerDefinition.objectIdField]=F,F++,null===O||null===D||isNaN(D)||isNaN(O)||(i.push(y.lngLatToXY(O,D)),n.push(_))}return{coords:i,attributes:n}},i([u.property({readOnly:!0,dependsOn:["url"]})],t.prototype,"parsedUrl",null),i([u.property()],t.prototype,"delimiter",void 0),i([u.property()],t.prototype,"fields",void 0),i([u.property()],t.prototype,"latitudeField",void 0),i([u.property()],t.prototype,"longitudeField",void 0),i([u.property()],t.prototype,"layerDefinition",void 0),i([u.property()],t.prototype,"url",void 0),t=i([u.subclass("esri.layers.graphics.sources.CSVSource")],t)}(u.declared(s,d));return N});