// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/assignHelper","./support/widget","../core/accessorSupport/decorators","../core/lang","../core/HandleRegistry","../core/watchUtils","./Widget","../widgets/support/widgetUtils","./Popup/PopupRenderer","./Popup/PopupViewModel","dojo/i18n!./Popup/nls/Popup","./Spinner","dojo/dom-geometry"],function(e,t,o,i,n,r,a,s,p,l,u,c,d,h,g,f,_){function v(e,t){return void 0===t?x+"__"+e:x+"__"+e+"-"+t}function b(e){return e&&e.isInstanceOf&&e.isInstanceOf(u)}function y(e){return e&&"function"==typeof e.postMixInProperties&&"function"==typeof e.buildRendering&&"function"==typeof e.postCreate&&"function"==typeof e.startup}var w=e.toUrl("./Popup/images/default-action.svg"),m={iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconDockToTop:"esri-icon-maximize",iconDockToBottom:"esri-icon-dock-bottom",iconDockToLeft:"esri-icon-dock-left",iconDockToRight:"esri-icon-dock-right",iconClose:"esri-icon-close",iconUndock:"esri-icon-minimize",iconFeatureMenu:"esri-icon-layer-list",iconCheckMark:"esri-icon-check-mark",iconLoading:"esri-rotating esri-icon-loading-indicator",iconZoom:"esri-icon-zoom-in-magnifying-glass",base:"esri-popup",widget:"esri-widget",container:"esri-popup__position-container",main:"esri-popup__main-container",loadingContainer:"esri-popup__loading-container",shadow:"esri-popup--shadow",isDocked:"esri-popup--is-docked",isDockedTopLeft:"esri-popup--is-docked-top-left",isDockedTopCenter:"esri-popup--is-docked-top-center",isDockedTopRight:"esri-popup--is-docked-top-right",isDockedBottomLeft:"esri-popup--is-docked-bottom-left",isDockedBottomCenter:"esri-popup--is-docked-bottom-center",isDockedBottomRight:"esri-popup--is-docked-bottom-right",alignTopCenter:"esri-popup--aligned-top-center",alignBottomCenter:"esri-popup--aligned-bottom-center",alignTopLeft:"esri-popup--aligned-top-left",alignBottomLeft:"esri-popup--aligned-bottom-left",alignTopRight:"esri-popup--aligned-top-right",alignBottomRight:"esri-popup--aligned-bottom-right",isFeatureMenuOpen:"esri-popup--feature-menu-open",hasFeatureUpdated:"esri-popup--feature-updated",header:"esri-popup__header",headerButtons:"esri-popup__header-buttons",headerTitle:"esri-popup__header-title",headerTitleButton:"esri-popup__header-title--button",content:"esri-popup__content",featureButtons:"esri-popup__feature-buttons",button:"esri-popup__button",buttonDock:"esri-popup__button--dock",icon:"esri-popup__icon",iconDock:"esri-popup__icon--dock-icon",actions:"esri-popup__actions",action:"esri-popup__action",actionImage:"esri-popup__action-image",actionText:"esri-popup__action-text",pointer:"esri-popup__pointer",pointerDirection:"esri-popup__pointer-direction",navigation:"esri-popup__navigation",navigationButtons:"esri-popup__navigation-buttons",paginationPrevious:"esri-popup__pagination-previous",paginationNext:"esri-popup__pagination-next",paginationPreviousIconLTR:"esri-popup__pagination-previous-icon",paginationPreviousIconRTL:"esri-popup__pagination-previous-icon--rtl",paginationNextIconLTR:"esri-popup__pagination-next-icon",paginationNextIconRTL:"esri-popup__pagination-next-icon--rtl",paginationText:"esri-popup__pagination-page-text",featureMenu:"esri-popup__feature-menu",featureMenuList:"esri-popup__feature-menu-list",featureMenuItem:"esri-popup__feature-menu-item",featureMenuViewport:"esri-popup__feature-menu-viewport",featureMenuHeader:"esri-popup__feature-menu-header",featureMenuNote:"esri-popup__feature-menu-note",featureMenuSelected:"esri-popup__feature-menu-item--selected",featureMenuButton:"esri-popup__feature-menu-button",featureMenuTitle:"esri-popup__feature-menu-title"},k="zoom-to",M={buttonEnabled:!0,position:"auto",breakpoint:{width:544}},x="esri-popup",C=function(e){function t(t){var o=e.call(this)||this;return o._containerNode=null,o._mainContainerNode=null,o._featureMenuButtonNode=null,o._featureMenuViewportNode=null,o._handleRegistry=new p,o._displayActionTextLimit=2,o._pointerOffsetInPx=16,o._spinner=null,o._closeFeatureMenuHandle=null,o.actions=null,o.alignment="auto",o.autoCloseEnabled=null,o.content=null,o.collapsed=!1,o.collapseEnabled=!0,o.dockEnabled=!1,o.featureCount=null,o.featureMenuOpen=!1,o.features=null,o.featureNavigationEnabled=!0,o.highlightEnabled=null,o.location=null,o.popupRenderers=[],o.promises=null,o.selectedFeature=null,o.selectedFeatureIndex=null,o.selectedPopupRenderer=null,o.spinnerEnabled=!0,o.title=null,o.updateLocationEnabled=null,o.view=null,o.viewModel=new h,o.visible=null,o}return o(t,e),t.prototype.postInitialize=function(){var e=this,t=l.pausable(this,"\n      viewModel.visible,\n      dockEnabled,\n      viewModel.selectedFeature\n    ",function(){return e._closeFeatureMenu()});this._closeFeatureMenuHandle=t,this.own(l.watch(this,"viewModel.screenLocation",function(){return e._positionContainer()}),l.watch(this,["viewModel.visible","dockEnabled"],function(){return e._toggleScreenLocationEnabled()}),l.watch(this,"viewModel.screenLocation",function(t,o){!!t!=!!o&&e.reposition()}),l.watch(this,"viewModel.features",function(t){return e._createPopupRenderers(t)}),l.watch(this,["viewModel.view.padding","viewModel.view.size","viewModel.visible","viewModel.waitingForResult","viewModel.location","alignment"],function(){return e.reposition()}),t,l.watch(this,"spinnerEnabled",function(t){return e._spinnerEnabledChange(t)}),l.watch(this,["title","content"],function(){return e._hasFeatureUpdated()}),l.watch(this,"viewModel.view.size",function(t,o){return e._updateDockEnabledForViewSize(t,o)}),l.watch(this,"viewModel.view",function(t,o){return e._viewChange(t,o)}),l.watch(this,"viewModel.view.ready",function(t,o){return e._viewReadyChange(t,o)}),l.watch(this,["viewModel.waitingForResult","viewModel.location"],function(){return e._displaySpinner()}),l.watch(this,["popupRenderers","viewModel.selectedFeatureIndex"],function(){return e._updatePopupRenderer()}),l.watch(this,"selectedPopupRenderer.viewModel.title",function(t){return e._setTitleFromPopupRenderer(t)}),l.watch(this,["selectedPopupRenderer.viewModel.content","selectedPopupRenderer.viewModel.waitingForContent"],function(){return e._setContentFromPopupRenderer()}),l.on(this,"viewModel","trigger-action",function(t){return e._zoomToAction(t)}))},t.prototype.destroy=function(){this._destroyPopupRenderers(),this._destroySpinner(),this._handleRegistry.destroy(),this._handleRegistry=null},Object.defineProperty(t.prototype,"currentAlignment",{get:function(){return this._getCurrentAlignment()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"currentDockPosition",{get:function(){return this._getCurrentDockPosition()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dockOptions",{get:function(){return this._get("dockOptions")||M},set:function(e){var t=n({},M),o=this.get("viewModel.view.breakpoints"),i={};o&&(i.width=o.xsmall,i.height=o.xsmall);var r=n({},t,e),a=n({},t.breakpoint,i),s=r.breakpoint;s===!0?r.breakpoint=a:"object"==typeof s&&(r.breakpoint=n({},a,s)),this._set("dockOptions",r),this._setCurrentDockPosition(),this.reposition()},enumerable:!0,configurable:!0}),t.prototype.clear=function(){},t.prototype.close=function(){this.visible=!1},t.prototype.next=function(){return null},t.prototype.open=function(e){var t={featureMenuOpen:!1,updateLocationEnabled:!1,promises:[]},o=n({visible:!0},t,e);o.featureMenuOpen&&this._closeFeatureMenuHandle.pause(),this.set(o)},t.prototype.previous=function(){return null},t.prototype.reposition=function(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()},t.prototype.triggerAction=function(e){return null},t.prototype.render=function(){var e=this,t=e.collapsed,o=e.collapseEnabled,i=e.dockEnabled,n=e.dockOptions,a=e.actions,p=e.featureMenuOpen,l=e.featureNavigationEnabled,u=e.popupRenderers,d=e.visible,h=this.viewModel,f=h.featureCount,_=h.promiseCount,b=h.pendingPromisesCount,y=h.selectedFeatureIndex,w=h.title,k=h.waitingForResult,M=f>1&&l,x=f>1&&p,C=o&&!x&&t,P=a&&a.length,T=M&&this._getPageText(f,y),F=this._renderContent(),R=c.isRtl(),E=this.get("selectedPopupRenderer")?this.get("selectedPopupRenderer.viewModel.waitingForContent")||this.get("selectedPopupRenderer.viewModel.content"):F,D=i?g.undock:g.dock,N=this,O=N.currentAlignment,L=N.currentDockPosition,A=b?r.tsx("div",{key:v("loading-container"),role:"presentation","class":m.loadingContainer,"aria-label":g.loading,title:g.loading},r.tsx("span",{"aria-hidden":"true","class":r.join(m.icon,m.iconLoading)})):null,I=(Ae={},Ae[m.iconFeatureMenu]=!x,Ae[m.iconClose]=x,Ae),B=r.tsx("span",{"aria-hidden":"true","class":m.icon,classes:I}),S=(Ie={},Ie[m.iconRightTriangleArrow]=R,Ie[m.paginationPreviousIconRTL]=R,Ie[m.iconLeftTriangleArrow]=!R,Ie[m.paginationPreviousIconLTR]=!R,Ie),V=r.tsx("span",{"aria-hidden":"true","class":m.icon,classes:S}),H=r.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,"class":r.join(m.button,m.paginationPrevious),"aria-label":g.previous,title:g.previous},V),j=(Be={},Be[m.iconLeftTriangleArrow]=R,Be[m.paginationNextIconRTL]=R,Be[m.iconRightTriangleArrow]=!R,Be[m.paginationNextIconLTR]=!R,Be),U=r.tsx("span",{"aria-hidden":"true","class":m.icon,classes:j}),z=r.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,"class":r.join(m.button,m.paginationNext),"aria-label":g.next,title:g.next},U),W=r.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._storeFeatureMenuButtonNode,afterUpdate:this._storeFeatureMenuButtonNode,"class":r.join(m.button,m.featureMenuButton),"aria-label":g.menu,title:g.menu},B),Z=r.tsx("div",{"class":m.paginationText},T),q=M?r.tsx("div",{"class":m.navigationButtons},H,Z,z,W):null,G=this._wouldDockTo(),J="top-right"===G||"bottom-right"===G,K="top-left"===G||"bottom-left"===G,Q="top-center"===G,X="bottom-center"===G,Y=J?r.tsx("span",{"aria-hidden":"true",key:v("dock-right-icon"),"class":r.join(m.icon,m.iconDock,m.iconDockToRight)}):null,$=K?r.tsx("span",{"aria-hidden":"true",key:v("dock-left-icon"),"class":r.join(m.icon,m.iconDock,m.iconDockToLeft)}):null,ee=Q?r.tsx("span",{"aria-hidden":"true",key:v("dock-top-icon"),"class":r.join(m.icon,m.iconDock,m.iconDockToTop)}):null,te=X?r.tsx("span",{"aria-hidden":"true",key:v("dock-bottom-icon"),"class":r.join(m.icon,m.iconDock,m.iconDockToBottom)}):null,oe=i?r.tsx("span",{"aria-hidden":"true",key:v("undocked-icon"),"class":r.join(m.icon,m.iconUndock)}):null,ie=n.buttonEnabled?r.tsx("div",{role:"button","aria-label":D,title:D,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,"class":r.join(m.button,m.buttonDock)},Y,ee,$,te,oe):null,ne=o&&(E||P||M),re=(Se={},Se[m.headerTitleButton]=ne,Se),ae=ne?"button":"heading",se=ne?C?g.expand:g.collapse:"",pe=w?r.tsx("h1",{"class":m.headerTitle,role:ae,"aria-label":se,title:se,classes:re,bind:this,tabIndex:ne?0:-1,onclick:this._toggleCollapsed,onkeydown:this._toggleCollapsed,innerHTML:w}):null,le=r.tsx("span",{"aria-hidden":"true","class":r.join(m.icon,m.iconClose)}),ue=r.tsx("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,"class":m.button,"aria-label":g.close,title:g.close},le),ce=r.tsx("header",{"class":m.header},pe,r.tsx("div",{"class":m.headerButtons},ie,ue)),de=E&&!C?r.tsx("article",{key:v("content-container"),"class":m.content},F):null,he=!C&&("bottom-left"===O||"bottom-center"===O||"bottom-right"===O||"top-left"===L||"top-center"===L||"top-right"===L),ge=!C&&("top-left"===O||"top-center"===O||"top-right"===O||"bottom-left"===L||"bottom-center"===L||"bottom-right"===L),fe=x?null:r.tsx("div",{key:v("actions"),"class":m.actions},this._renderActions()),_e=r.tsx("section",{key:v("navigation"),"class":m.navigation},A,q),ve=M||P?r.tsx("div",{key:v("feature-buttons"),"class":m.featureButtons},fe,_e):null,be=this._renderFeatureMenuNode(u,y,x);be&&this._closeFeatureMenuHandle.resume();var ye=s.substitute({total:u.length},g.selectedFeatures),we=r.tsx("section",{key:v("menu"),"class":m.featureMenu},r.tsx("h2",{"class":m.featureMenuHeader},ye),r.tsx("nav",{"class":m.featureMenuViewport,afterCreate:this._storeFeatureMenuViewportNode,afterUpdate:this._storeFeatureMenuViewportNode},be));this._featureMenuViewportNode&&(this._featureMenuViewportNode.scrollTop=0);var me=i?null:r.tsx("div",{key:v("pointer"),"class":m.pointer,role:"presentation"},r.tsx("div",{"class":r.join(m.pointerDirection,m.shadow)})),ke=(Ve={},Ve[m.alignTopCenter]="top-center"===O,Ve[m.alignBottomCenter]="bottom-center"===O,Ve[m.alignTopLeft]="top-left"===O,Ve[m.alignBottomLeft]="bottom-left"===O,Ve[m.alignTopRight]="top-right"===O,Ve[m.alignBottomRight]="bottom-right"===O,Ve[m.isDocked]=i,Ve[m.shadow]=!i,Ve[m.hasFeatureUpdated]=d,Ve[m.isDockedTopLeft]="top-left"===L,Ve[m.isDockedTopCenter]="top-center"===L,Ve[m.isDockedTopRight]="top-right"===L,Ve[m.isDockedBottomLeft]="bottom-left"===L,Ve[m.isDockedBottomCenter]="bottom-center"===L,Ve[m.isDockedBottomRight]="bottom-right"===L,Ve[m.isFeatureMenuOpen]=x,Ve),Me=this.get("selectedFeature.layer.title"),xe=this.get("selectedFeature.layer.id"),Ce=(He={},He[m.shadow]=i,He),Pe=!!_,Te=!!f,Fe=Pe?Te:!0,Re=d&&!k&&Fe,Ee=he?we:null,De=ge?we:null,Ne=he?ve:null,Oe=ge?ve:null,Le=Re?r.tsx("div",{key:v("container"),"class":m.container,classes:ke,"data-layer-title":Me,"data-layer-id":xe,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},r.tsx("div",{"class":r.join(m.main,m.widget),classes:Ce,bind:this,afterCreate:this._storeMainContainerNode,afterUpdate:this._storeMainContainerNode},Ne,Ee,ce,de,Oe,De),me):null;return r.tsx("div",{key:v("base"),"class":m.base,role:"presentation"},Le);var Ae,Ie,Be,Se,Ve,He},t.prototype._setTitleFromPopupRenderer=function(e){this.viewModel.title=e||""},t.prototype._setContentFromPopupRenderer=function(){this.viewModel.content=this.selectedPopupRenderer||null,this.scheduleRender()},t.prototype._zoomToAction=function(e){e.action&&e.action.id===k&&this.viewModel.zoomToLocation()},t.prototype._spinnerEnabledChange=function(e){if(this._destroySpinner(),e){var t=this.get("viewModel.view");this._createSpinner(t)}},t.prototype._displaySpinner=function(){var e=this._spinner;if(e){var t=this.viewModel,o=t.location,i=t.waitingForResult;return i?void e.show({location:o}):void e.hide()}},t.prototype._getIconStyles=function(e){return{"background-image":e?"url("+e+")":""}},t.prototype._renderAction=function(e,t,o,i){var n=this,a=l.watch(e,["id","className","title","image","visible"],function(){return n.scheduleRender()});this._handleRegistry.add(a,i);var p=this.get("selectedFeature.attributes");e.id===k&&(e.title=g.zoom,e.className=m.iconZoom);var u=e.title,c=e.className,d=e.image||c?e.image:w,h=u&&p?s.substitute(p,u):u,f=c&&p?s.substitute(p,c):c,_=d&&p?s.substitute(p,d):d,b=(M={},M[f]=!!f,M[m.actionImage]=!!_,M),y=o<=this._displayActionTextLimit?r.tsx("span",{key:v("action-text-"+t+"-"+e.uid),"class":m.actionText},h):null;return e.visible?r.tsx("div",{key:v("action-"+t+"-"+e.uid),role:"button",tabIndex:0,title:h,"aria-label":h,"class":r.join(m.button,m.action),bind:this,"data-action-index":t,onclick:this._triggerAction,onkeydown:this._triggerAction},r.tsx("span",{key:v("action-icon-"+t+"-"+e.uid),"aria-hidden":"true","class":m.icon,classes:b,styles:this._getIconStyles(_)}),y):null;var M},t.prototype._renderActions=function(){var e=this,t="actions";this._handleRegistry.remove(t);var o=this.actions;if(o){var i=o.length,n=o.toArray(),a=n.map(function(o,n){return e._renderAction(o,n,i,t)});return r.tsx("div",{key:v("actions"),"class":m.actions},a)}},t.prototype._updatePopupRenderer=function(){var e=this.popupRenderers,t=this.viewModel.selectedFeatureIndex,o=e[t]||null;o&&!o.contentEnabled&&(o.contentEnabled=!0),this._set("selectedPopupRenderer",o)},t.prototype._destroyPopupRenderers=function(){this.popupRenderers.forEach(function(e){return e.destroy()}),this._set("popupRenderers",[])},t.prototype._createPopupRenderers=function(e){var t=this;this._destroyPopupRenderers();var o=[];e&&e.forEach(function(e){var i=new d({contentEnabled:!1,graphic:e,view:t.get("viewModel.view")});o.push(i)}),this._set("popupRenderers",o)},t.prototype._isScreenLocationWithinView=function(e,t){return e.x>-1&&e.y>-1&&e.x<=t.width&&e.y<=t.height},t.prototype._isOutsideView=function(e){var t=e.popupHeight,o=e.popupWidth,i=e.screenLocation,n=e.side,r=e.view;if(isNaN(o)||isNaN(t)||!r||!i)return!1;var a=r.padding;return"right"===n&&i.x+o/2>r.width-a.right?!0:"left"===n&&i.x-o/2<a.left?!0:"top"===n&&i.y-t<a.top?!0:"bottom"===n&&i.y+t>r.height-a.bottom?!0:!1},t.prototype._determineCurrentAlignment=function(){function e(e){return parseInt(e.replace(/[^-\d\.]/g,""),10)}var t=this,o=t._pointerOffsetInPx,i=t._containerNode,n=t._mainContainerNode,r=t.viewModel,a=r.screenLocation,s=r.view;if(!a||!s||!i)return"top-center";if(!this._isScreenLocationWithinView(a,s))return this._get("currentAlignment")||"top-center";var p=n?window.getComputedStyle(n,null):null,l=p?e(p.getPropertyValue("max-height")):0,u=p?e(p.getPropertyValue("height")):0,c=_.getContentBox(i),d=c.w+o,h=Math.max(c.h,l,u)+o,g=this._isOutsideView({popupHeight:h,popupWidth:d,screenLocation:a,side:"right",view:s}),f=this._isOutsideView({popupHeight:h,popupWidth:d,screenLocation:a,side:"left",view:s}),v=this._isOutsideView({popupHeight:h,popupWidth:d,screenLocation:a,side:"top",view:s}),b=this._isOutsideView({popupHeight:h,popupWidth:d,screenLocation:a,side:"bottom",view:s});return f?v?"bottom-right":"top-right":g?v?"bottom-left":"top-left":v?b?"top-center":"bottom-center":"top-center"},t.prototype._getCurrentAlignment=function(){var e=this,t=e.alignment,o=e.dockEnabled;if(o)return null;var i="auto"===t?this._determineCurrentAlignment():"function"==typeof t?t.call(this):t;return i},t.prototype._setCurrentAlignment=function(){this._set("currentAlignment",this._getCurrentAlignment())},t.prototype._setCurrentDockPosition=function(){this._set("currentDockPosition",this._getCurrentDockPosition())},t.prototype._getDockPosition=function(){var e=this.get("dockOptions.position"),t="auto"===e?this._determineCurrentDockPosition():"function"==typeof e?e.call(this):e;return t},t.prototype._getCurrentDockPosition=function(){return this.dockEnabled?this._getDockPosition():null},t.prototype._wouldDockTo=function(){return this.dockEnabled?null:this._getDockPosition()},t.prototype._renderFeatureMenuItemNode=function(e,t,o,i){var n=t===o,a=(l={},l[m.featureMenuSelected]=n,l),s=e.title||g.untitled,p=n?r.tsx("span",{key:v("feature-menu-selected-feature-"+o),title:g.selectedFeature,"aria-label":g.selectedFeature,"class":m.iconCheckMark}):null;return r.tsx("li",{role:"menuitem",tabIndex:n||!i?-1:0,key:v("feature-menu-feature-"+o),classes:a,"class":m.featureMenuItem,title:s,"aria-label":s,bind:this,"data-feature-index":t,onclick:this._selectFeature,onkeydown:this._selectFeature},r.tsx("span",{"class":m.featureMenuTitle},s,p));var l},t.prototype._renderFeatureMenuNode=function(e,t,o){var i=this;return e.length>1?r.tsx("ol",{"class":m.featureMenuList,role:"menu"},e.map(function(e,n){return i._renderFeatureMenuItemNode(e,n,t,o)})):null},t.prototype._determineCurrentDockPosition=function(){var e=this.get("viewModel.view"),t=c.isRtl()?"top-left":"top-right";if(!e)return t;var o=e.padding||{left:0,right:0,top:0,bottom:0},i=e.width-o.left-o.right,n=e.get("breakpoints");return n&&i<=n.xsmall?"bottom-center":t},t.prototype._renderContent=function(){var e=this.get("viewModel.content"),t="content";return"string"==typeof e?r.tsx("div",{key:v(t+"-string"),innerHTML:e}):b(e)?r.tsx("div",{key:v(t+"-widget")},e.render()):e instanceof HTMLElement?r.tsx("div",{key:v(t+"-html-element"),bind:e,afterUpdate:this._attachToNode,afterCreate:this._attachToNode}):y(e)?r.tsx("div",{key:v(t+"-dijit"),bind:e.domNode,afterUpdate:this._attachToNode,afterCreate:this._attachToNode}):void 0},t.prototype._attachToNode=function(e){var t=this;e.appendChild(t)},t.prototype._positionContainer=function(e){if(void 0===e&&(e=this._containerNode),e&&(this._containerNode=e),e){var t=this.viewModel.screenLocation,o=_.getContentBox(e),i=this._calculatePositionStyle(t,o);i&&(e.style.top=i.top,e.style.left=i.left,e.style.bottom=i.bottom,e.style.right=i.right)}},t.prototype._calculateFullWidth=function(e){var t=this,o=t.currentAlignment,i=t._pointerOffsetInPx;return"top-left"===o||"bottom-left"===o||"top-right"===o||"bottom-right"===o?e+i:e},t.prototype._calculateAlignmentPosition=function(e,t,o,i){var n=this,r=n.currentAlignment,a=n._pointerOffsetInPx,s=i/2,p=o.height-t,l=o.width-e;return"bottom-center"===r?{top:t+a,left:e-s}:"top-left"===r?{bottom:p+a,right:l+a}:"bottom-left"===r?{top:t+a,right:l+a}:"top-right"===r?{bottom:p+a,left:e+a}:"bottom-right"===r?{top:t+a,left:e+a}:"top-center"===r?{bottom:p+a,left:e-s}:void 0},t.prototype._calculatePositionStyle=function(e,t){var o=this,i=o.dockEnabled,n=o.view;if(n){var r=n.padding;if(i)return{left:r.left?r.left+"px":"",top:r.top?r.top+"px":"",right:r.right?r.right+"px":"",bottom:r.bottom?r.bottom+"px":""};if(e&&t){var a=this._calculateFullWidth(t.w),s=this._calculateAlignmentPosition(e.x,e.y,n,a);if(s)return{top:void 0!==s.top?s.top+"px":"auto",left:void 0!==s.left?s.left+"px":"auto",bottom:void 0!==s.bottom?s.bottom+"px":"auto",right:void 0!==s.right?s.right+"px":"auto"}}}},t.prototype._viewChange=function(e,t){e&&t&&(this.close(),this.clear())},t.prototype._viewReadyChange=function(e,t){if(e){var o=this.get("viewModel.view");return void this._wireUpView(o)}t&&(this.close(),this.clear())},t.prototype._wireUpView=function(e){if(this._destroySpinner(),e){var t=this.spinnerEnabled;t&&this._createSpinner(e),this._setDockEnabledForViewSize(this.dockOptions)}},t.prototype._dockingThresholdCrossed=function(e,t,o){var i=e[0],n=e[1],r=t[0],a=t[1],s=o.width,p=o.height;return s>=i&&r>s||i>s&&s>=r||p>=n&&a>p||n>p&&p>=a},t.prototype._updateDockEnabledForViewSize=function(e,t){if(e&&t){var o=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},i=o.left+o.right,n=o.top+o.bottom,r=[],a=[];r[0]=e[0]-i,r[1]=e[1]-n,a[0]=t[0]-i,a[1]=t[1]-n;var s=this.dockOptions,p=s.breakpoint;this._dockingThresholdCrossed(r,a,p)&&this._setDockEnabledForViewSize(s),this._setCurrentDockPosition()}},t.prototype._hasFeatureUpdated=function(){var e=this._containerNode,t=this.viewModel.pendingPromisesCount,o=this.get("selectedPopupRenderer.viewModel.waitingForContent");!e||t||o||(e.classList.remove(m.hasFeatureUpdated),e.offsetHeight,e.classList.add(m.hasFeatureUpdated))},t.prototype._storeMainContainerNode=function(e){this._mainContainerNode=e},t.prototype._storeFeatureMenuButtonNode=function(e){this._featureMenuButtonNode=e},t.prototype._storeFeatureMenuViewportNode=function(e){this._featureMenuViewportNode=e},t.prototype._toggleScreenLocationEnabled=function(){var e=this,t=e.dockEnabled,o=e.visible,i=e.viewModel;if(i){var n=o&&!t;i.screenLocationEnabled=n}},t.prototype._shouldDockAtCurrentViewSize=function(e){var t=e.breakpoint,o=this.get("viewModel.view.ui"),i=o.width,n=o.height;if(isNaN(i)||isNaN(n))return!1;var r=t.hasOwnProperty("width")&&i<=t.width,a=t.hasOwnProperty("height")&&n<=t.height;return r||a},t.prototype._setDockEnabledForViewSize=function(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))},t.prototype._getPageText=function(e,t){return s.substitute({index:t+1,total:e},g.pageText)},t.prototype._destroySpinner=function(){this._spinner&&(this._spinner.destroy(),this._spinner=null)},t.prototype._createSpinner=function(e){e&&(this._spinner=new f({container:document.createElement("div"),view:e}),e.root.appendChild(this._spinner.container))},t.prototype._closeFeatureMenu=function(){this.featureMenuOpen=!1},t.prototype._toggleCollapsed=function(){this.collapsed=!this.collapsed},t.prototype._close=function(){this.close()},t.prototype._toggleDockEnabled=function(){this.dockEnabled=!this.dockEnabled},t.prototype._toggleFeatureMenu=function(){this.featureMenuOpen=!this.featureMenuOpen},t.prototype._triggerAction=function(e){var t=e.currentTarget,o=t["data-action-index"];this.viewModel.triggerAction(o)},t.prototype._selectFeature=function(e){var t=e.currentTarget,o=t["data-feature-index"];isNaN(o)||(this.viewModel.selectedFeatureIndex=o),this._featureMenuButtonNode&&this._featureMenuButtonNode.focus()},t.prototype._next=function(){this.next()},t.prototype._previous=function(){this.previous()},i([a.aliasOf("viewModel.actions"),r.renderable()],t.prototype,"actions",void 0),i([a.property()],t.prototype,"alignment",void 0),i([a.aliasOf("viewModel.autoCloseEnabled")],t.prototype,"autoCloseEnabled",void 0),i([a.aliasOf("viewModel.content"),r.renderable()],t.prototype,"content",void 0),i([a.property(),r.renderable()],t.prototype,"collapsed",void 0),i([a.property(),r.renderable()],t.prototype,"collapseEnabled",void 0),i([a.property({readOnly:!0,dependsOn:["dockEnabled","alignment"]}),r.renderable()],t.prototype,"currentAlignment",null),i([a.property({readOnly:!0,dependsOn:["dockEnabled","dockOptions"]}),r.renderable()],t.prototype,"currentDockPosition",null),i([a.property(),r.renderable()],t.prototype,"dockOptions",null),i([a.property(),r.renderable()],t.prototype,"dockEnabled",void 0),i([a.aliasOf("viewModel.featureCount"),r.renderable()],t.prototype,"featureCount",void 0),i([a.property(),r.renderable()],t.prototype,"featureMenuOpen",void 0),i([a.aliasOf("viewModel.features"),r.renderable()],t.prototype,"features",void 0),i([a.property(),r.renderable()],t.prototype,"featureNavigationEnabled",void 0),i([a.aliasOf("viewModel.highlightEnabled")],t.prototype,"highlightEnabled",void 0),i([a.aliasOf("viewModel.location"),r.renderable()],t.prototype,"location",void 0),i([a.property({readOnly:!0}),r.renderable()],t.prototype,"popupRenderers",void 0),i([a.aliasOf("viewModel.promises")],t.prototype,"promises",void 0),i([a.aliasOf("viewModel.selectedFeature"),r.renderable()],t.prototype,"selectedFeature",void 0),i([a.aliasOf("viewModel.selectedFeatureIndex"),r.renderable()],t.prototype,"selectedFeatureIndex",void 0),i([a.property({readOnly:!0}),r.renderable()],t.prototype,"selectedPopupRenderer",void 0),i([a.property()],t.prototype,"spinnerEnabled",void 0),i([a.aliasOf("viewModel.title"),r.renderable()],t.prototype,"title",void 0),i([a.aliasOf("viewModel.updateLocationEnabled")],t.prototype,"updateLocationEnabled",void 0),i([a.aliasOf("viewModel.view")],t.prototype,"view",void 0),i([a.property({type:h}),r.renderable(["viewModel.screenLocation","viewModel.screenLocationEnabled","viewModel.state","viewModel.pendingPromisesCount","viewModel.promiseCount","viewModel.waitingForResult"]),r.vmEvent(["triggerAction","trigger-action"])],t.prototype,"viewModel",void 0),i([a.aliasOf("viewModel.visible"),r.renderable()],t.prototype,"visible",void 0),i([a.aliasOf("viewModel.clear")],t.prototype,"clear",null),i([a.aliasOf("viewModel.next")],t.prototype,"next",null),i([a.aliasOf("viewModel.previous")],t.prototype,"previous",null),i([a.aliasOf("viewModel.triggerAction")],t.prototype,"triggerAction",null),i([r.accessibleHandler()],t.prototype,"_toggleCollapsed",null),i([r.accessibleHandler()],t.prototype,"_close",null),i([r.accessibleHandler()],t.prototype,"_toggleDockEnabled",null),i([r.accessibleHandler()],t.prototype,"_toggleFeatureMenu",null),i([r.accessibleHandler()],t.prototype,"_triggerAction",null),i([r.accessibleHandler()],t.prototype,"_selectFeature",null),i([r.accessibleHandler()],t.prototype,"_next",null),i([r.accessibleHandler()],t.prototype,"_previous",null),t=i([a.subclass("esri.widgets.Popup")],t)}(a.declared(u));return C});