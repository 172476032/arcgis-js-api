// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../Color","../../../request","../../../renderers/SimpleRenderer","../../../renderers/ClassBreaksRenderer","../../../renderers/UniqueValueRenderer","../../../renderers/support/jsonUtils","../../../core/Accessor","../../../core/HandleRegistry","../../../core/Logger","../../../core/arrayUtils","../../../core/promiseUtils","../../../layers/support/ExportImageParameters","../../../symbols/support/symbolPreview","./colorRampUtils","./sizeRampUtils","dojo/_base/lang"],function(e,t,n,l,i,r,s,a,o,u,h,d,c,f,y,g){var m="https://utility.arcgis.com/sharing/tools/legend",p="esri.layers.ImageryLayer",b=o.getLogger("esri.widgets.Legend.support.ActiveLayerInfo");return s.createSubclass({declaredClass:"esri.widgets.Legend.support.ActiveLayerInfo",constructor:function(){this._legendResponse=null,this._handles=new a;var e=this.watch("tearingDown",function(){this.destroy()}.bind(this));this._handles.add(e,"tearingDown-watcher")},getDefaults:function(){return{legendElements:[]}},destroy:function(){this._handles.destroy(),this._handles=null,this._legendResponse=null},properties:{layer:null,legendElements:{type:Array},ready:!1,tearingDown:!1,title:null,scale:null,updating:!1,version:{value:0,readOnly:!0,dependsOn:["updating"],get:function(){return this._get("version")+1}},_hasColorRamp:!1,_hasOpacityRamp:!1,_hasSizeRamp:!1},buildLegendElementsForFeatureCollections:function(){var e=this.layer.featureCollections;e.forEach(function(e){if(e.featureSet.features.length){var t=e.layerDefinition,n=t&&t.drawingInfo,l=n&&r.fromJSON(n.renderer);if(!l)return void b.warn("drawingInfo not available!");this._getRendererLegendElements(l,e.name).then(function(e){this.updating=!0,this.ready=!1,e&&e.length&&(Array.prototype.push.apply(this.legendElements,e),this.ready=!0)}.bind(this)).otherwise(function(e){b.warn("error while building legend for layer!",e)}).always(function(){this.updating=!1}.bind(this))}},this)},buildLegendElementsForRenderer:function(){this._getRendererLegendElements(this.layer.renderer).then(function(e){this.updating=!0,this.ready=!1,this.legendElements=e,this.legendElements.length&&(this.ready=!0)}.bind(this)).otherwise(function(e){b.warn("error while building legend for layer!",e)}).always(function(){this.updating=!1}.bind(this))},buildLegendElementsForTools:function(){this.layer.sublayers?this._constructLegendElementsForSublayers():(this._handles.remove("imageryLayers-watcher"),this._getLegendLayers().then(function(e){this.updating=!0,this.ready=!1,this.legendElements=[],e.forEach(function(e){if(this.layer.declaredClass===p){var t=this.layer.watch("renderingRule, bandIds",function(){this._legendResponse=null,this.buildLegendElementsForTools()}.bind(this));this._handles.add(t,"imageryLayers-watcher")}var n=this._generateSymbolTableElementForLegendLayer(e);n&&n.infos.length&&this.legendElements.push(n)},this),this.legendElements.length&&(this.ready=!0)}.bind(this)).otherwise(function(e){b.warn("Request to server for legend has failed!",e)}).always(function(){this.updating=!1}.bind(this)))},_getLegendLayers:function(e){var t=e&&e.hasDynamicLayers,n=this._legendResponse;if(!t&&n)return h.resolve(n);var l=t?e.dynamicLayers:null;return this._legendRequest(l).then(function(e){var t=e.data.layers;return this._legendResponse=t,t}.bind(this))},_legendRequest:function(e){var n=this.layer,l=n.url.replace(/(\/)+$/,""),i={f:"json",dynamicLayers:e};if(n.declaredClass===p&&(n.renderingRule&&(i.renderingRule=JSON.stringify(n.renderingRule.toJSON())),n.bandIds&&(i.bandIds=n.bandIds.join())),n.version>=10.01){var r=l.indexOf("?");r>-1?l=l.substring(0,r)+"/legend"+l.substring(r):l+="/legend",n.token&&(l+="?token="+n.token)}else{var s=l.toLowerCase().indexOf("/rest/"),a=l.substring(0,s)+l.substring(s+5,l.length);l=m+"?soapUrl="+window.escape(a)+"&returnbytes=true"}return t(l,{query:i,callbackParamName:"callback"})},_constructLegendElementsForSublayers:function(){this.updating=!0,this.ready=!1,this.legendElements=[],this._handles.remove("sublayers-watcher");var e=new d({layer:this.layer});this._getLegendLayers(e).then(function(e){var t={};e.forEach(function(e){t[e.layerId]=e}),this.legendElements=this._generateLegendElementsForSublayers(this.layer.sublayers,t,this.layer.opacity),this.legendElements.length&&(this.ready=!0)}.bind(this)).otherwise(function(e){b.warn("Request to server for legend has failed!",e)}).always(function(){e.destroy(),this.updating=!1}.bind(this))},_generateLegendElementsForSublayers:function(e,t,n){var l=[];return this._handles.add(e.on("change",this._constructLegendElementsForSublayers.bind(this)),"sublayers-watcher"),e.forEach(function(e){var i=e.watch("renderer, opacity, title, visible",this._constructLegendElementsForSublayers.bind(this));if(this._handles.add(i,"sublayers-watcher"),e.visible&&e.legendEnabled){var r=e&&null!=e.opacity?e.opacity:null,s=null!=r?r*n:n,a=this._generateSymbolTableElementForSublayer(e,t,s);a&&a.infos.length&&l.unshift(a)}},this),l},_generateSymbolTableElementForSublayer:function(e,t,n){var l=t[e.id];if(!l&&e.sublayers){var i=this._generateLegendElementsForSublayers(e.sublayers,t,n);return{type:"symbol-table",title:e.title,infos:i}}return this._generateSymbolTableElementForLegendLayer(l,e,n)},_generateSymbolTableElementForLegendLayer:function(e,t,n){if(e){var l=e.layerName,i=t&&t.renderer;if(i){var r=t&&t.title?t.title:this._getRendererTitle(i,t);r&&(l&&(r.title=l),l=r)}var s={type:"symbol-table",title:l,infos:[]};if(e.legendType&&(s.legendType=e.legendType),e.legend&&this._isLegendLayerInScale(e,t)){var a=t?this._sanitizeLegendForSublayer(e.legend,t):e.legend;s.infos=a.map(function(t){var l=t.url;if(t.imageData&&t.imageData.length>0)l="data:image/png;base64,"+t.imageData;else{if(0===l.indexOf("http"))return null;l=this.layer.url+"/"+e.layerId+"/images/"+l;var i=this.layer.token;i&&(l+="?token="+i)}return{label:t.label,src:l,opacity:n,width:t.width,height:t.height}},this).filter(function(e){return!!e})}return s.infos.length?s:null}},_sanitizeLegendForSublayer:function(e,t){if(this.layer.version<10.1||0===e.length)return e;var n,l,i=t.renderer,r=e.some(function(e){return e.values});return r&&e.some(function(e,t){return e.values||(n=t,l=e,l.label||(l.label="others")),null!=l}),i?"uniqueValue"===i.type?l&&(e.splice(n,1),e.push(l)):"classBreaks"===i.type&&(l&&e.splice(n,1),e.reverse(),l&&e.push(l)):l&&(e.splice(n,1),e.push(l)),e},_isLegendLayerInScale:function(e,t){var n,l,i=t||this.layer,r=!0;return!i.minScale&&0!==i.minScale||!i.maxScale&&0!==i.maxScale?(0===e.minScale&&i.tileInfo&&(n=i.tileInfo.lods[0].scale),0===e.maxScale&&i.tileInfo&&(l=i.tileInfo.lods[i.tileInfo.lods.length-1].scale)):(n=Math.min(i.minScale,e.minScale)||i.minScale||e.minScale,l=Math.max(i.maxScale,e.maxScale)),(n>0&&n<this.scale||l>this.scale)&&(r=!1),r},_getRendererLegendElements:function(e,t){return this._loadRenderer(e).then(function(r){this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1;var s=this._getVisualVariableLegendElements(r)||[],a={type:"symbol-table",title:t||this._getRendererTitle(r),infos:[]},o=e.isInstanceOf(n),u=e.isInstanceOf(l),d=e.isInstanceOf(i),c=o||u||d;if(d)r.uniqueValueInfos.forEach(function(e){e.symbol&&a.infos.push({label:e.label||e.value,value:e.value,symbol:e.symbol})},this);else if(u){var f=this._isUnclassedRenderer(r),y=!f||!this._hasSizeRamp;y&&(r.classBreakInfos.forEach(function(e){e.symbol&&a.infos.unshift({label:e.label||(f?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:e.symbol})}),f&&(a.title=null))}else o&&r.symbol&&!this._hasSizeRamp&&a.infos.push({label:r.label,symbol:r.symbol});var g=!1;if(c){var m=r.defaultLabel,p=r.defaultSymbol;p&&!f&&(a.infos.push({label:m||"others",symbol:p}),g=!0)}g||o||f&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||s.push({type:"symbol-table",infos:[{label:r.defaultLabel,symbol:r.defaultSymbol}]}),a.infos.length&&s.unshift(a);var b=[],v=this._getSymbolConfig(r.visualVariables);return s.forEach(function(e){e.infos.forEach(function(e){e.symbol&&b.push(this._getSymbolPreview(e,v))},this)},this),r=null,h.eachAlways(b).then(function(){return s})}.bind(this))},_getSymbolConfig:function(e){var t=!1,n=!1;return e&&e.forEach(function(e){"size"===e.type&&("height"===e.axis&&(t=!0),"width-and-depth"===e.axis&&(n=!0))}),t&&n?"tall":null},_getSymbolPreview:function(e,t){return c.renderPreviewHTML(e.symbol,{size:e.size,opacity:this.layer.opacity,symbolConfig:t}).then(function(t){return e.preview=t,e}).otherwise(function(){return e.preview=null,e})},_getVisualVariableLegendElements:function(e){var t=e.visualVariables,i=[],r=[],s=[],a=this.layer.opacity,o=null,u=null;if(!t)return null;if(t.forEach(function(e){"color"===e.type?i.push(e):"size"===e.type?r.push(e):"opacity"===e.type&&s.push(e)}),t=[],Array.prototype.push.apply(t,i),Array.prototype.push.apply(t,r),Array.prototype.push.apply(t,s),0===i.length&&e.isInstanceOf(l)&&e.classBreakInfos&&1===e.classBreakInfos.length){var h=e.classBreakInfos[0];o=h&&h.symbol}if(0===i.length&&e.isInstanceOf(n)&&(o=e.symbol),o){if(o.type.indexOf("3d")>-1){var d=o.symbolLayers.getItemAt(0);d.get("material.color")&&(u=d.material.color)}else o.url||(u=o.color);u&&(u=u.toRgba())}return t.map(function(t){if(!t.legendOptions||t.legendOptions.showLegend!==!1){var n,l=this._getRampTitle(t,this.layer),i=f.getRampBorderColor(e),r=f.getRampOverlayColor(a);return"color"===t.type?(n={type:"color-ramp",title:l,borderColor:i,overlayColor:r,infos:f.getRampStops(e,t)},this._hasColorRamp||(this._hasColorRamp=null!=n.infos&&n.infos.length)):"size"===t.type?(n={type:"size-ramp",title:l,infos:y.getRampStops(e,t,this._getMedianColor(e),this.scale)},this._hasSizeRamp||(this._hasSizeRamp=null!=n.infos&&n.infos.length)):"opacity"===t.type&&(n={type:"opacity-ramp",title:l,borderColor:i,overlayColor:r,infos:f.getRampStops(e,t,u)},this._hasOpacityRamp||(this._hasOpacityRamp=null!=n.infos&&n.infos.length)),n.infos&&n}},this).filter(function(e){return!!e})},_loadRenderer:function(e){var t=e.isInstanceOf(n),r=e.isInstanceOf(l),s=e.isInstanceOf(i),a=t||r||s,o=[];if(!a)return b.warn("Renderer not supported!"),h.reject();e=e.clone();var u=this._getMedianColor(e),d=this.layer.opacity;if(r||s){var c=e.classBreakInfos||e.uniqueValueInfos;c.forEach(function(e){o.push(this._fetchSymbol(e.symbol,u,d).then(function(t){e.symbol=t}).otherwise(function(){e.symbol=null}))},this)}return o.push(this._fetchSymbol(e.symbol||e.defaultSymbol,e.defaultSymbol?null:u,d).then(function(n){t?e.symbol=n:e.defaultSymbol=n}).otherwise(function(){t?e.symbol=null:e.defaultSymbol=null})),h.eachAlways(o).then(function(){return e})},_fetchSymbol:function(e,t,n){return e?"web-style-symbol"===e.type?e.fetchSymbol().then(function(e){return this._getAppliedCloneSymbol(e,t,n)}.bind(this)).otherwise(function(){return b.warn("Fetching web-style-symbol failed!"),h.reject()}):h.resolve(this._getAppliedCloneSymbol(e,t,n)):h.reject()},_getMedianColor:function(e){var t,n,l,i;if(!e.visualVariables)return null;if(i=u.find(e.visualVariables,function(e){return"color"===e.type}),!i)return null;if(i.colors)t=i.minDataValue,n=i.maxDataValue;else if(i.stops){if(1===i.stops.length)return i.stops[0].color;t=i.stops[0].value,n=i.stops[i.stops.length-1].value}return null!=t&&null!=n?(l=t+(n-t)/2,e.getColor(l,{colorInfo:i})):void 0},_getAppliedCloneSymbol:function(t,n,l){if(!t)return t;var i,r,s=t.clone(),a=s.type,o=a.indexOf("3d")>-1;if(n&&(i=new e(n.toRgba()),o?this._applyColorTo3dSymbol(s,i):s.color=i),"simple-line-symbol"===a||"text-symbol"===a){if(!s.color)return;r=s.color.toRgba(),r[3]=r[3]*l,s.color=r}else"simple-marker-symbol"===a||"simple-fill-symbol"===a?(s.color&&(r=s.color.toRgba(),r[3]=r[3]*l,s.color=r),s.outline&&s.outline.color&&(r=s.outline.color.toRgba(),r[3]=r[3]*l,s.outline.color=r)):o&&this._applyColorTo3dSymbol(s,null,l);return s},_applyColorTo3dSymbol:function(e,t,n){e.symbolLayers.forEach(function(e){if(e&&(t&&(e.material||(e.material={}),e.material.color=t),null!=n)){var l;e.material&&e.material.color&&(l=e.material.color.toRgba(),l[3]=l[3]*n,e.material.color=l),e.outline&&e.outline.color&&(l=e.outline.color.toRgba(),l[3]=l[3]*n,e.outline.color=l)}})},_getRampTitle:function(e,t){var n,l=e.field,i=e.normalizationField,r=!1,s=!1,a=!1;if(l=g.isFunction(l)?null:l,i=g.isFunction(i)?null:i,e.legendOptions&&e.legendOptions.title)n=e.legendOptions.title;else if(e.valueExpressionTitle)n=e.valueExpressionTitle;else{if(t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables)for(var o=t.renderer.authoringInfo.visualVariables,u=0;u<o.length;u++){var h=o[u];if("colorInfo"===h.type){if("ratio"===h.style){r=!0;break}if("percent"===h.style){s=!0;break}if("percentTotal"===h.style){a=!0;break}}}n={field:l&&this._getFieldAlias(l,t),normField:i&&this._getFieldAlias(i,t),ratio:r,ratioPercent:s,ratioPercentTotal:a}}return n},_getRendererTitle:function(e,t){if(e.legendOptions&&e.legendOptions.title)return e.legendOptions.title;if(e.valueExpressionTitle)return e.valueExpressionTitle;var n,i,r,s=this.layer,a=e.field;return e instanceof l&&(n=e.normalizationField,i="percent-of-total"===e.normalizationType),a=g.isFunction(a)?null:a,n=g.isFunction(n)?null:n,(a||n)&&(r={field:t?a:a&&this._getFieldAlias(a,s),normField:t?n:n&&this._getFieldAlias(n,s),normByPct:i}),r},_getFieldAlias:function(e,t){var n,l,i,r=t.popupTemplate,s=r&&r.fieldInfos,a=g.isFunction(e)?null:t.getField&&t.getField(e);return s&&s.some(function(t){return e===t.fieldName?(l=t,!0):void 0}),i=l||a,i&&(n=l&&l.label||a&&a.alias||i.name||i.fieldName),n},_isUnclassedRenderer:function(e){var t=!1,n=e.visualVariables,i=e.isInstanceOf(l)&&e.classBreakInfos&&1===e.classBreakInfos.length;return i&&n&&(t=e.field?n.some(function(t){return!(!t||e.field!==t.field||e.normalizationField!=t.normalizationField)}):!!n.length),t}})});