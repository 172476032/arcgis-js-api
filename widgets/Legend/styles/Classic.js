// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/i18n!../../Legend/nls/Legend","dojox/gfx","../../../core/accessorSupport/decorators","../../Widget","../../Legend/support/styleUtils","../../support/widget"],function(e,r,l,a,t,s,i,n,o,d){var c={widget:"esri-widget",base:"esri-legend esri-widget--panel",service:"esri-legend__service",label:"esri-legend__service-label",layer:"esri-legend__layer",groupLayer:"esri-legend__group-layer",groupLayerChild:"esri-legend__group-layer-child",layerTable:"esri-legend__layer-table",layerTableSizeRamp:"esri-legend__layer-table--size-ramp",layerChildTable:"esri-legend__layer-child-table",layerCaption:"esri-legend__layer-caption",layerBody:"esri-legend__layer-body",layerRow:"esri-legend__layer-row",layerCell:"esri-legend__layer-cell",layerInfo:"esri-legend__layer-cell esri-legend__layer-cell--info",imageryLayerStretchedImage:"esri-legend__imagery-layer-image--stretched",imageryLayerCellStretched:"esri-legend__imagery-layer-cell--stretched",imageryLayerInfoStretched:"esri-legend__imagery-layer-info--stretched",symbolContainer:"esri-legend__layer-cell esri-legend__layer-cell--symbols",symbol:"esri-legend__symbol",rampContainer:"esri-legend__ramps",sizeRamp:"esri-legend__size-ramp",colorRamp:"esri-legend__color-ramp",opacityRamp:"esri-legend__opacity-ramp",borderlessRamp:"esri-legend__borderless-ramp",rampTick:"esri-legend__ramp-tick",rampFirstTick:"esri-legend__ramp-tick-first",rampLastTick:"esri-legend__ramp-tick-last",rampLabelsContainer:"esri-legend__ramp-labels",rampLabel:"esri-legend__ramp-label",message:"esri-legend__message",hidden:"esri-hidden"};return function(e){function r(r){var l=e.call(this)||this;return l.activeLayerInfos=null,l}return l(r,e),r.prototype.render=function(){var e=this,r=this.activeLayerInfos,l=d.join(c.base,c.widget),a=r&&r.toArray().map(function(r){return e._renderLegendForLayer(r)}).filter(function(e){return!!e});return d.tsx("div",{class:l},a&&a.length?a:d.tsx("div",{class:c.message},t.noLegend))},r.prototype._renderLegendForLayer=function(e){var r=this;if(!e.ready)return null;var l=!!e.children.length,a="esri-legend__"+e.layer.uid+"-version-"+e.version,t=e.title?d.tsx("div",{class:c.label},e.title):null;if(l){var s=e.children.map(function(e){return r._renderLegendForLayer(e)}).toArray(),i=(y={},y[c.groupLayer]=l,y);return d.tsx("div",{key:a,class:c.service,classes:i},t,s)}var n=e.legendElements;if(n&&!n.length)return null;var o=n.map(function(l){return r._renderLegendForElement(l,e.layer)}).filter(function(e){return!!e});if(!o.length)return null;var i=(p={},p[c.groupLayerChild]=!!e.parent,p);return d.tsx("div",{key:a,class:c.service,classes:i},t,d.tsx("div",{class:c.layer},o));var y,p},r.prototype._renderLegendForElement=function(e,r,l){var a=this,t="color-ramp"===e.type,s="opacity-ramp"===e.type,i="size-ramp"===e.type,n=null;if("symbol-table"===e.type||i){var y=e.infos.map(function(l){return a._renderLegendForElementInfo(l,r,i,e.legendType)}).filter(function(e){return!!e});y.length&&(n=d.tsx("div",{class:c.layerBody},y))}else(t||s)&&(n=this._renderLegendForRamp(e.infos,e.overlayColor,s));if(!n)return null;var p=e.title,g=null;if("string"==typeof p)g=p;else if(p){var m=o.getTitle(p,t||s);g=o.isRendererTitle(p,t||s)&&p.title?p.title+" ("+m+")":m}var u=l?c.layerChildTable:c.layerTable,_=g?d.tsx("div",{class:c.layerCaption},g):null,f=(v={},v[c.layerTableSizeRamp]=i||!l,v);return d.tsx("div",{class:u,classes:f},_,n);var v},r.prototype._renderLegendForRamp=function(e,r,l){var a=e.length-1,t=null;t=a>2?25*a:50;var i=document.createElement("div"),n=l?c.opacityRamp:"";i.className=c.colorRamp+" "+n,i.style.height=t+"px";var y=s.createSurface(i,"100%",t);try{e.forEach(function(e,r){e.offset=r/a}),y.createRect({x:0,y:0,width:"100%",height:t}).setFill({type:"linear",x1:0,y1:0,x2:0,y2:t,colors:e}).setStroke(null),r&&r.a>0&&y.createRect({x:0,y:0,width:"100%",height:t}).setFill(r).setStroke(null)}catch(e){y.clear(),y.destroy()}if(!y)return null;var p=e.filter(function(e){return!!e.label}).map(function(e){return d.tsx("div",{class:c.rampLabel},e.label)}),g={width:"24px"},m={height:t+"px"};return d.tsx("div",{class:c.layerRow},d.tsx("div",{class:c.symbolContainer,styles:g},d.tsx("div",{class:c.rampContainer,bind:i,afterCreate:o.attachToNode})),d.tsx("div",{class:c.layerInfo},d.tsx("div",{class:c.rampLabelsContainer,styles:m},p)))},r.prototype._renderLegendForElementInfo=function(e,r,l,a){if(e.type)return this._renderLegendForElement(e,r,!0);var t=null,s=o.isImageryStretchedLegend(r,a);if(e.symbol&&e.preview?t=d.tsx("div",{class:c.symbol,bind:e.preview,afterCreate:o.attachToNode}):e.src&&(t=this._renderImage(e,r,s)),!t)return null;var i=(y={},y[c.imageryLayerInfoStretched]=s,y),n=(p={},p[c.imageryLayerInfoStretched]=s,p[c.sizeRamp]=!s&&l,p);return d.tsx("div",{class:c.layerRow},d.tsx("div",{class:c.symbolContainer,classes:n},t),d.tsx("div",{class:c.layerInfo,classes:i},e.label||""));var y,p},r.prototype._renderImage=function(e,r,l){var a=e.label,t=e.src,s=e.opacity,i=(o={},o[c.imageryLayerStretchedImage]=l,o[c.symbol]=!l,o),n={opacity:""+(null!=s?s:r.opacity)};return d.tsx("img",{alt:a,src:t,border:0,width:e.width,height:e.height,classes:i,styles:n});var o},a([d.renderable(),i.property()],r.prototype,"activeLayerInfos",void 0),r=a([i.subclass("esri.widgets.Legend.styles.Classic")],r)}(i.declared(n))});