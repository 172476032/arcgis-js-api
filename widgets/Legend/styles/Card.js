// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/i18n!../../../nls/common","dojo/i18n!../../Legend/nls/Legend","dojox/gfx","../../../core/lang","../../../core/accessorSupport/decorators","../../Widget","../../Legend/support/styleUtils","../../support/colorUtils","../../support/widget"],function(e,t,r,a,s,i,l,o,n,c,d,h,y){var p={activated:"esri-legend--card__carousel-indicator--activated",base:"esri-legend--card esri-widget",carouselTitle:"esri-legend--card__carousel-title",indicator:"esri-legend--card__carousel-indicator",intervalSeparator:"esri-legend--card__interval-separator",imageryLayerStretchedImage:"esri-legend--card__imagery-layer-image--stretched",imageLabel:"esri-legend--card__image-label",layerCaption:"esri-legend--card__layer-caption",labelElement:"esri-legend--card__label-element",layerRow:"esri-legend--card__layer-row",labelCell:"esri-legend--card__label-cell",message:"esri-legend--card__message",rampLabel:"esri-legend--card__ramp-label",section:"esri-legend--card__section",serviceCaptionText:"esri-legend--card__service-caption-text",serviceContent:"esri-legend--card__service-content",service:"esri-legend--card__service",symbol:"esri-legend--card__symbol",sizeRampRow:"esri-legend--card__size-ramp-row",symbolRow:"esri-legend--card__symbol-row",symbolCell:"esri-legend--card__symbol-cell",indicatorContainer:"esri-legend--card__carousel-indicator-container",intervalSeparatorsContainer:"esri-legend--card__interval-separators-container",labelContainer:"esri-legend--card__label-container",serviceCaptionContainer:"esri-legend--card__service-caption-container",symbolContainer:"esri-legend--card__symbol-container",sizeRampContainer:"esri-legend--card__size-ramp-container",hidden:"esri-hidden"},m="esri-legend--card__";return function(e){function t(t){var r=e.call(this)||this;return r._hasIndicators=!1,r._selectedSectionName=null,r._sectionNames=[],r._sectionMap=new Map,r.activeLayerInfos=null,r.view=null,r}return r(t,e),t.prototype.render=function(){var e=this;this._sectionNames.length=0,this._hasIndicators=this.view.container.clientWidth<=768;var t=this.activeLayerInfos,r=t&&t.toArray().map(function(t){return e._renderLegendForLayer(t)}).filter(function(e){return!!e});this._hasIndicators?this._selectedSectionName&&-1!==this._sectionNames.indexOf(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;var a=this._sectionNames.length,l=this._sectionNames.map(function(t,r){var i=o.substitute({index:r+1,total:a},s.pagination.pageText);return y.tsx("div",{key:t,"aria-label":i,title:i,tabIndex:0,onclick:e._selectSection,onkeydown:e._selectSection,bind:e,class:e.classes(p.indicator,(l={},l[p.activated]=e._selectedSectionName===t,l)),"data-section-name":t});var l}),n=this._hasIndicators?y.tsx("div",{class:p.indicatorContainer,key:"carousel-navigation"},l):null,c=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):r&&r.length?r:null;return y.tsx("div",{class:p.base},n,c||y.tsx("div",{class:p.message},i.noLegend))},t.prototype._selectSection=function(e){var t=e.target,r=t.getAttribute("data-section-name");r&&(this._selectedSectionName=r)},t.prototype._renderLegendForLayer=function(e){var t=this;if(!e.ready)return null;var r=!!e.children.length,a=""+m+e.layer.uid+"-version-"+e.version;if(r){var s=e.children.map(function(e){return t._renderLegendForLayer(e)}).toArray();return this._sectionNames.push(a),y.tsx("div",{key:e.layer.uid,class:p.service},y.tsx("div",{class:p.serviceCaptionContainer},e.title),s)}var i=e.legendElements;if(i&&!i.length)return null;var l=i.map(function(r){return t._renderLegendForElement(r,e.layer)}).filter(function(e){return!!e});return l.length?y.tsx("div",{key:e.layer.uid,class:p.service},y.tsx("div",{class:p.serviceCaptionContainer},y.tsx("div",{class:p.serviceCaptionText},e.title)),y.tsx("div",{class:p.serviceContent},l)):null},t.prototype._renderLegendForElement=function(e,t){var r=this,a="color-ramp"===e.type,s="opacity-ramp"===e.type,i="size-ramp"===e.type,l=e.title,o=null;if("string"==typeof l)o=l;else if(l){var n=d.getTitle(l,a||s);o=l.title?l.title+" ("+n+")":n}var c=""+m+t.uid+"-type-"+e.type,h=this._hasIndicators?y.tsx("p",{class:p.carouselTitle},t.title):null,g=null;if("symbol-table"===e.type){var v=e.infos.map(function(a){return r._renderLegendForElementInfo(a,t,i,e.legendType)}).filter(function(e){return!!e});if(this._hasIndicators||v.reverse(),v.length){var u=v[0].properties.classes&&v[0].properties.classes[p.symbolRow],b=(_={},_[p.labelContainer]=!u,_);g=y.tsx("div",{key:c,class:p.section},h,y.tsx("div",{class:p.layerCaption},o),y.tsx("div",{classes:b},v))}}else a||s?g=y.tsx("div",{key:c,class:p.section},h,y.tsx("div",{class:p.layerCaption},o),this._renderLegendForRamp(e.infos,e.overlayColor,s)):i&&(g=y.tsx("div",{key:c,class:p.section},h,y.tsx("div",{class:p.layerCaption},o),this._renderSizeRamps(e.infos)));return g?(this._sectionNames.push(c),this._sectionMap.set(c,g),g):null;var _},t.prototype._renderLegendForElementInfo=function(e,t,r,a){if(e.type)return this._renderLegendForElement(e,t);var s=d.isImageryStretchedLegend(t,a);if(e.symbol&&e.preview){if(!e.label)return-1===e.symbol.type.indexOf("simple-fill")?y.tsx("div",{bind:e.preview,afterCreate:d.attachToNode}):null;if(-1!==e.symbol.type.indexOf("marker")){var i=(C={},C[p.symbolCell]=this._hasIndicators,C);return y.tsx("div",{class:this.classes(p.layerRow,(k={},k[p.symbolRow]=this._hasIndicators,k))},y.tsx("div",{classes:i,bind:e.preview,afterCreate:d.attachToNode}),y.tsx("div",{class:this.classes(p.imageLabel,(M={},M[p.labelCell]=this._hasIndicators,M))},e.label||""))}var l=255,o=255,n=255,c=0,m=255,g=255,v=255,u=0,b=e.symbol.color&&e.symbol.color.a,_=e.symbol.outline&&e.symbol.outline.color.a;b&&(l=e.symbol.color.r,o=e.symbol.color.g,n=e.symbol.color.b,c=e.symbol.color.a),_&&(m=e.symbol.outline.color.r,g=e.symbol.outline.color.g,v=e.symbol.outline.color.b,u=e.symbol.outline.color.a);var x=h.isBright(e.symbol.color),w=x?"black":"white",f=x?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",S={background:b?"rgba("+l+", "+o+", "+n+", "+c+")":"none",color:w,textShadow:"-1px -1px 0 "+f+",\n                                              1px -1px 0 "+f+",\n                                              -1px 1px 0 "+f+",\n                                              1px 1px 0 "+f,border:_?"1px solid rgba("+m+", "+g+", "+v+", "+u+")":"none"};return y.tsx("div",{key:e.label,class:p.labelElement,styles:S}," ",e.label," ")}if(e.src){var L=this._renderImage(e,t,s);return y.tsx("div",{class:p.layerRow},L,y.tsx("div",{class:p.imageLabel},e.label||""))}var C,k,M},t.prototype._renderImage=function(e,t,r){var a=e.label,s=e.src,i=e.opacity,l=(n={},n[p.imageryLayerStretchedImage]=r,n[p.symbol]=!r,n),o={opacity:""+(null!=i?i:t.opacity)};return y.tsx("img",{alt:a,src:s,border:0,width:e.width,height:e.height,classes:l,styles:o});var n},t.prototype._renderSizeRamps=function(e){var t,r,a,s=document.createElement("div"),i=e[e.length-1].symbol.color,o=e[0].label,n=e[e.length-1].label,c=e[0].symbol.style&&"circle"===e[0].symbol.style;try{if(this._hasIndicators)if(a=100,c){var h=e[0].symbol.size/2,m=e[e.length-1].symbol.size/2;r=2*h;var g=a-h-m,v=Math.sqrt(Math.pow(g,2)-Math.pow(h-m,2)),u=h*v/g,b=h+u,_=h+Math.sqrt(Math.pow(h,2)-Math.pow(u,2)),x=m*u/h,w=h+x,f=a-(m-Math.sqrt(Math.pow(m,2)-Math.pow(x,2))),S=h-u,L=h-x;t=l.createSurface(s,r,a),t.createCircle({cx:h,cy:h,r:h}).setFill(i).setStroke({color:"#ddd",width:1}),t.createCircle({cx:h,cy:a-m,r:m}).setFill(i).setStroke({color:"#ddd",width:1}),t.createLine({x1:b,y1:_,x2:w,y2:f}).setStroke({color:"#ddd",width:1}),t.createLine({x1:S,y1:_,x2:L,y2:f}).setStroke({color:"#ddd",width:1})}else{var C=Math.max(e[0].symbol.height,e[0].symbol.width),k=Math.max(e[e.length-1].symbol.height,e[e.length-1].symbol.width);r=C,t=l.createSurface(s,r,a),t.createRect({x:0,y:0,height:C,width:C}).setStroke({color:"#ddd",width:1}),t.createRect({x:C/2-k/2,y:a-k,height:k,width:k}).setStroke({color:"#ddd",width:1}),t.createImage({src:e[0].symbol.url,height:C,width:C}),t.createImage({src:e[e.length-1].symbol.url,height:k,width:k,y:a-k,x:C/2-k/2}),t.createLine({x1:0,y1:C,x2:C/2-k/2,y2:a-k}).setStroke({color:"#ddd",width:1}),t.createLine({x1:r,y1:C,x2:C/2+k/2,y2:a-k}).setStroke({color:"#ddd",width:1})}else{if(r=180,c){var h=e[0].symbol.size/2,m=e[e.length-1].symbol.size/2;a=2*h;var g=r-h-m,v=Math.sqrt(Math.pow(g,2)-Math.pow(h-m,2)),u=h*v/g,M=h-u,I=r-(h+Math.sqrt(Math.pow(h,2)-Math.pow(u,2))),x=m*u/h,R=h-x,N=m-Math.sqrt(Math.pow(m,2)-Math.pow(x,2)),F=h+u,z=h+x;t=l.createSurface(s,r,a),t.createCircle({cx:r-h,cy:h,r:h}).setFill(i).setStroke({color:"#ddd",width:1}),t.createCircle({cx:m,cy:h,r:m}).setFill(i).setStroke({color:"#ddd",width:1}),t.createLine({x1:I,y1:M,x2:N,y2:R}).setStroke({color:"#ddd",width:1}),t.createLine({x1:I,y1:F,x2:N,y2:z}).setStroke({color:"#ddd",width:1})}else{var C=Math.max(e[0].symbol.height,e[0].symbol.width),k=Math.max(e[e.length-1].symbol.height,e[e.length-1].symbol.width);a=C,t=l.createSurface(s,r,a),t.createRect({x:0,y:C/2-k/2,height:k,width:k}).setStroke({color:"#ddd",width:1}),t.createRect({x:r-C,y:0,height:C,width:C}).setStroke({color:"#ddd",width:1}),t.createImage({src:e[e.length-1].symbol.url,height:k,width:k,y:C/2-k/2}),t.createImage({src:e[0].symbol.url,height:C,width:C,x:r-C}),t.createLine({x1:k,y1:C/2-k/2,x2:r-C,y2:0}).setStroke({color:"#ddd",width:1}),t.createLine({x1:k,y1:C/2+k/2,x2:r-C,y2:C}).setStroke({color:"#ddd",width:1})}var E=o;o=n,n=E}}catch(e){t.clear(),t.destroy()}return t?y.tsx("div",{class:this.classes(p.layerRow,(T={},T[p.sizeRampRow]=this._hasIndicators,T))},y.tsx("div",{class:p.rampLabel},o),y.tsx("div",{class:p.sizeRampContainer},y.tsx("div",{bind:s,afterCreate:d.attachToNode})),y.tsx("div",{class:p.rampLabel},n)):null;var T},t.prototype._renderLegendForRamp=function(e,t,r){var a=e.length-1,s=a>2?25*a:100,i=s+20,o=document.createElement("div");o.style.width=i+"px";var n=l.createSurface(o,i,25),c=e.slice(0).reverse();try{c.forEach(function(e,t){e.offset=t/a}),n.createPath("M0 12.5 L10 0 L10 25 Z").setFill(c[0].color).setStroke(null),n.createRect({x:10,y:0,width:s,height:25}).setFill({type:"linear",x1:10,y1:0,x2:s+10,y2:0,colors:c}).setStroke(null),n.createPath("M"+(s+10)+" 0 L"+i+" 12.5 L"+(s+10)+" 25 Z").setFill(c[c.length-1].color).setStroke(null)}catch(e){n.clear(),n.destroy()}if(!n)return null;var h=c.filter(function(e,t){return!!e.label&&0!==t&&t!==c.length-1}).map(function(e){return y.tsx("div",{class:p.intervalSeparatorsContainer},y.tsx("div",{class:p.intervalSeparator},"|"),y.tsx("div",{class:p.rampLabel},e.label))});return y.tsx("div",{class:p.layerRow},y.tsx("div",{class:p.rampLabel},e[e.length-1].label),y.tsx("div",{class:p.symbolContainer},y.tsx("div",{bind:o,afterCreate:d.attachToNode}),h),y.tsx("div",{class:p.rampLabel},e[0].label))},a([y.renderable(),n.property()],t.prototype,"activeLayerInfos",void 0),a([n.property()],t.prototype,"view",void 0),a([y.accessibleHandler()],t.prototype,"_selectSection",null),t=a([n.subclass("esri.widgets.Legend.styles.Card")],t)}(n.declared(c))});