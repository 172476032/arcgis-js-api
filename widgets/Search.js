// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/accessorSupport/decorators","./support/widget","./Search/SearchViewModel","./Search/SearchResultRenderer","./Widget","../core/lang","../core/watchUtils","../PopupTemplate","dojo/regexp","../core/geolocationUtils","dojo/keys","dojo/query","dojo/i18n!./Search/nls/Search"],function(e,t,o,s,n,r,i,u,a,l,c,d,h,p,g,_,v){var f={base:"esri-search esri-widget",hasMultipleSources:"esri-search--multiple-sources",isSearchLoading:"esri-search--loading",showSuggestions:"esri-search--show-suggestions",showSources:"esri-search--sources",showWarning:"esri-search--warning",container:"esri-search__container",input:"esri-search__input",inputContainer:"esri-search__input-container",form:"esri-search__form",submitButton:"esri-search__submit-button",sourcesButton:"esri-search__sources-button",clearButton:"esri-search__clear-button",sourceName:"esri-search__source-name",suggestionsMenu:"esri-search__suggestions-menu",sourcesMenu:"esri-search__sources-menu",source:"esri-search__source",activeSource:"esri-search__source--active",warningMenu:"esri-search__warning-menu",warningMenuBody:"esri-search__warning-body",warningMenuHeader:"esri-search__warning-header",warningMenuText:"esri-search__warning-text",noValueText:"esri-search__no-value-text",button:"esri-widget-button",fallbackText:"esri-icon-font-fallback-text",locate:"esri-icon-locate-circled",menu:"esri-menu",header:"esri-header",searchIcon:"esri-icon-search",dropdownIcon:"esri-icon-down-arrow esri-search__sources-button--down",dropupIcon:"esri-icon-up-arrow esri-search__sources-button--up",clearIcon:"esri-icon-close",noticeIcon:"esri-icon-notice-triangle",disabled:"esri-disabled"},y=function(e){function t(t){var o=e.call(this)||this;return o._supportsGeolocation=null,o._inputNode=null,o._searching=null,o._sourceMenuButtonNode=null,o._sourceListNode=null,o._suggestionListNode=null,o._searchResultRenderer=new u({container:document.createElement("div")}),o._suggestPromise=null,o._popupTemplate=new d({title:v.searchResult,content:o._renderSearchResultsContent.bind(o)}),o._relatedTarget=null,o.activeMenu="none",o.activeSource=null,o.activeSourceIndex=null,o.allPlaceholder=null,o.autoNavigate=null,o.autoSelect=null,o.defaultSource=null,o.locationEnabled=!0,o.locationToAddressDistance=null,o.maxResults=null,o.maxSuggestions=null,o.minSuggestCharacters=null,o.popupEnabled=null,o.popupOpenOnSelect=null,o.popupTemplate=null,o.resultGraphic=null,o.resultGraphicEnabled=null,o.results=null,o.searchAllEnabled=null,o.searchTerm=null,o.selectedResult=null,o.sources=null,o.suggestions=null,o.suggestionsEnabled=null,o.view=null,o.viewModel=new i,o._supportsGeolocation=p.supported(),o}return o(t,e),t.prototype.postInitialize=function(){var e=this;this.viewModel.popupTemplate=this._popupTemplate,this.own(c.watch(this,"searchTerm",function(t){var o=t&&"warning"===e.activeMenu||!t&&!e.get("viewModel.selectedSuggestion.location");o&&(e.activeMenu="none")}))},t.prototype.destroy=function(){this._cancelSuggest(),this._searchResultRenderer&&(this._searchResultRenderer.viewModel=null,this._searchResultRenderer.destroy(),this._searchResultRenderer=null)},Object.defineProperty(t.prototype,"state",{get:function(){return 0===this.sources.length?"disabled":this._searching?"searching":"ready"},enumerable:!0,configurable:!0}),t.prototype.clear=function(){},t.prototype.focus=function(){this._inputNode&&(this.activeMenu="suggestion",this._inputNode.focus(),this.emit("search-focus"))},t.prototype.blur=function(e){this._inputNode&&(this._inputNode.blur(),this._inputBlur(e),this.emit("search-blur"))},t.prototype.search=function(e){var t=this;this.activeMenu="none",this._cancelSuggest();var o=this.viewModel.search(e).then(function(e){return t.activeMenu=e.numResults?"none":"warning",e}).otherwise(function(){return t.activeMenu="none",null}).always(function(e){return t._searching=null,t.notifyChange("state"),e});return this._searching=o.isFulfilled()?null:o,this.notifyChange("state"),o},t.prototype.suggest=function(e){var t=this;this._cancelSuggest();var o=this.viewModel.suggest(e).then(function(e){return e.numResults&&(t.activeMenu="suggestion"),t._scrollToTopSuggestion(),e}).otherwise(function(){return null});return this._suggestPromise=o,o},t.prototype.render=function(){var e=this,t=this.viewModel,o=t.placeholder,s=t.searchTerm,n=this._getSourceName(t.activeSourceIndex),u=(""+s).trim(),a=this,c=a.activeMenu,d=a.id,h=a.state,p=this.id+"-suggest-menu",g=r.tsx("input",{bind:this,placeholder:o,"aria-label":v.searchButtonTitle,maxlength:t.maxInputLength,autocomplete:"off",type:"text",tabindex:"0","class":f.input,"aria-autocomplete":"list",value:s,"aria-haspopup":"true","aria-owns":p,role:"textbox",onkeydown:this._handleInputKeydown,onkeyup:this._handleInputKeyup,onclick:this._handleInputClick,oninput:this._handleInputPaste,onpaste:this._handleInputPaste,afterCreate:this._storeInputNode,afterUpdate:this._storeInputNode,onfocusout:this._storeRelatedTarget,onfocus:this.focus,onblur:this.blur,title:s?"":o}),_=r.tsx("form",{key:"esri-search__form",bind:this,"class":f.form,onsubmit:this._formSubmit,role:"search"},g),y=s?r.tsx("div",{key:"esri-search__clear-button",bind:this,role:"button","class":r.join(f.clearButton,f.button),tabindex:"0",title:v.clearButtonTitle,onfocus:this._clearButtonFocus,onclick:this._handleClearButtonClick,onkeydown:this._handleClearButtonClick},r.tsx("span",{"aria-hidden":"true","class":f.clearIcon})):null,S=this.locationEnabled&&this._supportsGeolocation&&!u,w=S?r.tsx("ul",{key:"esri-search__suggestion-list-current-location"},r.tsx("li",{bind:this,onclick:this._handleUseCurrentLocationClick,onkeydown:this._handleUseCurrentLocationClick,onkeyup:this._handleSuggestionKeyup,role:"menuitem",tabindex:"-1"},r.tsx("span",{"aria-hidden":"true",role:"presentation","class":f.locate})," ",v.useCurrentLocation)):null,M=t.sources.length>1&&t.activeSourceIndex===i.ALL_INDEX,m=t.suggestions?t.suggestions.map(function(t,o){var s=t.sourceIndex,n=t.results.length,i=n&&M?e._getSuggestionHeaderNode(s):null,u=t.results,a=u.map(function(t,o){return e._getSuggestionNode(t,o,s)}),l=n?r.tsx("ul",{key:"esri-search__suggestion-list-"+s},a):null;return[i,l]}):null,b=r.tsx("div",{id:p,"aria-expanded":"suggestion"===c,key:"esri-search__suggestions-menu","class":r.join(f.menu,f.suggestionsMenu),role:"menu",bind:this,afterCreate:this._storeSuggestionsListNode,afterUpdate:this._storeSuggestionsListNode},w,m),x=r.tsx("div",{key:"esri-search__input-container","class":f.inputContainer},_,b,y),N=r.tsx("div",{key:"esri-search__submit-button",bind:this,role:"button",title:v.searchButtonTitle,"class":r.join(f.submitButton,f.button),tabindex:"0",onclick:this._handleSearchButtonClick,onkeydown:this._handleSearchButtonClick},r.tsx("span",{"aria-hidden":"true",role:"presentation","class":f.searchIcon}),r.tsx("span",{"class":f.fallbackText},v.searchButtonTitle)),R=u?l.substitute({value:'"'+s+'"'},v.noResultsFoundForValue):v.noResultsFound,k=t.get("selectedSuggestion.location")||u?r.tsx("div",{key:"esri-search__no_results"},r.tsx("div",{"class":f.warningMenuHeader},v.noResults),r.tsx("div",{"class":f.warningMenuText},R)):null,C=t.get("selectedSuggestion.location")||u?null:r.tsx("div",{key:"esri-search__empty-search"},r.tsx("span",{"aria-hidden":"true","class":f.noticeIcon}),r.tsx("span",{"class":f.noValueText},v.emptyValue)),O=r.tsx("div",{key:"esri-search__error-menu","class":r.join(f.menu,f.warningMenu)},r.tsx("div",{"class":f.warningMenuBody},k,C)),T=t.sources,E=T.length>1,B=T&&T.toArray(),A=t.searchAllEnabled?this._getSourceNode(i.ALL_INDEX):null,L=d+"-source-menu",I=E?r.tsx("div",{key:"esri-search__source-menu-button",bind:this,role:"button",title:v.searchIn,"aria-haspopup":"true","aria-expanded":"source"===c,"aria-controls":L,"class":r.join(f.sourcesButton,f.button),tabindex:"0",onkeydown:this._handleSourceMenuButtonKeydown,onclick:this._handleSourcesMenuToggleClick,onkeyup:this._handleSourceMenuButtonKeyup,onblur:this._sourcesButtonBlur,afterCreate:this._storeSourceMenuButtonNode,afterUpdate:this._storeSourceMenuButtonNode},r.tsx("span",{"aria-hidden":"true",role:"presentation","class":f.dropdownIcon}),r.tsx("span",{"aria-hidden":"true",role:"presentation","class":f.dropupIcon}),r.tsx("span",{"class":f.sourceName},n)):null,P=E?r.tsx("ul",{bind:this,afterCreate:this._storeSourcesListNode,afterUpdate:this._storeSourcesListNode},A,B.map(function(t,o){return e._getSourceNode(o)})):null,D=r.tsx("div",{id:L,key:"esri-search__source-menu","class":r.join(f.menu,f.sourcesMenu),role:"menu"},P),W=(K={},K[f.hasMultipleSources]=E,K[f.isSearchLoading]="searching"===h,K[f.showWarning]="warning"===c,K[f.showSources]="source"===c,K[f.showSuggestions]="suggestion"===c,K),H=(U={},U[f.disabled]="disabled"===h,U);return r.tsx("div",{"class":f.base,classes:H},r.tsx("div",{role:"presentation",classes:W,"class":f.container},I,D,x,N,O));var K,U},t.prototype._handleSourceMenuButtonKeydown=function(e){var t=e.keyCode;return t===g.UP_ARROW||t===g.DOWN_ARROW||t===g.END||t===g.HOME?(e.preventDefault(),e.stopPropagation(),void(this.activeMenu="source")):void this._handleSourcesMenuToggleClick(e)},t.prototype._handleSourcesMenuToggleClick=function(e){var t="source"===this.activeMenu;if(this.activeMenu=t?"none":"source",this.renderNow(),t)return void(this._sourceMenuButtonNode&&this._sourceMenuButtonNode.focus());var o=this._sourceListNode?_("li",this._sourceListNode):null;if(o){var s=e.keyCode,n=s===g.END?o[o.length-1]:o[0];n&&n.focus()}},t.prototype._handleClearButtonClick=function(){this.viewModel.clear(),this._focus()},t.prototype._handleSearchButtonClick=function(){this.search()},t.prototype._handleSuggestionClick=function(e){var t=e.currentTarget,o=t["data-suggestion"];o&&(this._focus(),this.search(o))},t.prototype._handleUseCurrentLocationClick=function(){var e=this;this._focus("none");var t=p.getCurrentPosition().then(function(t){return p.positionToPoint(t,e.view).then(function(t){return e.search(t)})}).always(function(t){return e._searching=null,e.notifyChange("state"),t});this._searching=t.isFulfilled()?null:t,this.notifyChange("state")},t.prototype._handleSourceClick=function(e){var t=this.viewModel,o=e.currentTarget,s=o["data-source-index"];t.activeSourceIndex=s,this._focus("none")},t.prototype._sourcesButtonBlur=function(e){var t=e&&e.relatedTarget;this._removeActiveMenu(t,this._sourceListNode)},t.prototype._inputBlur=function(e){var t=e&&e.relatedTarget;this._removeActiveMenu(t?t:this._relatedTarget,this._suggestionListNode)},t.prototype._storeRelatedTarget=function(e){this._relatedTarget=e.relatedTarget},t.prototype._clearButtonFocus=function(){this.activeMenu="none"},t.prototype._removeActiveMenu=function(e,t){e&&t&&t.contains(e)||(this.activeMenu="none")},t.prototype._cancelSuggest=function(){var e=this._suggestPromise;e&&(e.cancel(),this._suggestPromise=null)},t.prototype._storeSuggestionsListNode=function(e){this._suggestionListNode=e},t.prototype._storeSourcesListNode=function(e){this._sourceListNode=e},t.prototype._storeInputNode=function(e){this._inputNode=e},t.prototype._storeSourceMenuButtonNode=function(e){this._sourceMenuButtonNode=e},t.prototype._handleInputKeydown=function(e){var t=e.keyCode;(t===g.TAB||t===g.ESCAPE||e.shiftKey&&t===g.TAB)&&this._cancelSuggest()},t.prototype._handleInputKeyup=function(e){var t=e.keyCode,o=e.ctrlKey||e.metaKey||t===g.copyKey||t===g.LEFT_ARROW||t===g.RIGHT_ARROW||t===g.ENTER||t===g.SHIFT,s=this._suggestionListNode?_("li",this._suggestionListNode):null;if(!o){if(t===g.TAB||t===g.ESCAPE||e.shiftKey&&t===g.TAB)return this._cancelSuggest(),void(t===g.ESCAPE&&(this.activeMenu="none"));if((t===g.UP_ARROW||t===g.DOWN_ARROW)&&s){this.activeMenu="suggestion",e.stopPropagation(),e.preventDefault(),this._cancelSuggest();var n=t===g.UP_ARROW?s.length-1:0,r=s[n];return void(r&&r.focus())}this.viewModel.searchTerm&&this.suggest()}},t.prototype._scrollToTopSuggestion=function(){this._suggestionListNode&&(this._suggestionListNode.scrollTop=0)},t.prototype._handleInputClick=function(e){this.activeMenu="suggestion"},t.prototype._handleInputPaste=function(e){var t=this.viewModel,o=e.target;t.searchTerm!==o.value&&(t.searchTerm=o.value),t.searchTerm&&this.suggest()},t.prototype._handleSourceMenuButtonKeyup=function(e){var t=e.keyCode;if(t===g.UP_ARROW||t===g.DOWN_ARROW||t===g.HOME||t===g.END){e.stopPropagation(),e.preventDefault();var o=this._sourceListNode?_("li",this._sourceListNode):null;if(o){var s=t===g.UP_ARROW||t===g.END?o.length-1:0,n=o[s];n&&n.focus()}}},t.prototype._handleSourceKeyup=function(e){var t=e.target,o=this._sourceListNode?_("li",this._sourceListNode):null,s=e.keyCode;if(s===g.ESCAPE)return this._focus("none"),void(this._sourceMenuButtonNode&&this._sourceMenuButtonNode.focus());if(o){var n=o.indexOf(t);if((s===g.HOME||s===g.END||s===g.UP_ARROW||s===g.DOWN_ARROW)&&(e.stopPropagation(),e.preventDefault()),s===g.HOME){var r=o[0];return void(r&&r.focus())}if(s===g.END){var i=o[o.length-1];return void(i&&i.focus())}if(s===g.UP_ARROW){var u=n-1,a=0>u?this._sourceMenuButtonNode:o[u];return void(a&&a.focus())}if(s===g.DOWN_ARROW){var l=n+1,c=l>=o.length?this._sourceMenuButtonNode:o[l];c&&c.focus()}}},t.prototype._handleSuggestionKeyup=function(e){var t=e.target,o=this._suggestionListNode?_("li",this._suggestionListNode):null,s=o.indexOf(t),n=e.keyCode;if(this._cancelSuggest(),n===g.BACKSPACE||n===g.DELETE)return void this._focus();if(n===g.ESCAPE)return void this._focus("none");if(o){if((n===g.HOME||n===g.END||n===g.UP_ARROW||n===g.DOWN_ARROW)&&(e.stopPropagation(),e.preventDefault()),n===g.HOME){var r=o[0];r&&r.focus()}if(n===g.END){var i=o[o.length-1];i&&i.focus()}if(n===g.UP_ARROW){var u=s-1,a=0>u?o[o.length-1]:o[u];return void(a&&a.focus())}if(n===g.DOWN_ARROW){var l=s+1,c=l>=o.length?o[0]:o[l];return void(c&&c.focus())}}},t.prototype._focus=function(e){this.focus(),e&&(this.activeMenu=e)},t.prototype._formSubmit=function(e){e.preventDefault(),this.search()},t.prototype._getSourceName=function(e){var t=this.viewModel,o=t.sources,s=o.getItemAt(e);return e===i.ALL_INDEX?v.all:s?s.name:v.untitledSource},t.prototype._getSuggestionHeaderNode=function(e){var t=this._getSourceName(e);return r.tsx("div",{key:"esri-search__suggestion-header-"+e,"class":f.header},t)},t.prototype._splitResult=function(e,t){var o=h.escapeString(t),s=e.replace(new RegExp("(^|)("+o+")(|$)","ig"),"$1|$2|$3");return s.split("|")},t.prototype._getSuggestionNode=function(e,t,o){var s=this.viewModel,n=s.searchTerm;if(n){var i=e.text,u=i||v.untitledResult,a=this._splitResult(u,n),l=n.toLowerCase(),c=[];return a.forEach(function(e,s){if(e&&e.length){var n=o+"-"+t+"-"+s;e.toLowerCase()===l?c.push(r.tsx("strong",{key:"esri-search__partial-match-"+n},e)):c.push(e)}}),r.tsx("li",{bind:this,onclick:this._handleSuggestionClick,onkeydown:this._handleSuggestionClick,onkeyup:this._handleSuggestionKeyup,key:"esri-search__suggestion$-{sourceIndex}_"+t,"data-suggestion":e,role:"menuitem",tabindex:"-1"},c)}},t.prototype._getSourceNode=function(e){var t=(o={},o[f.activeSource]=e===this.viewModel.activeSourceIndex,o);return r.tsx("li",{bind:this,key:"esri-search__source-"+e,onclick:this._handleSourceClick,onkeydown:this._handleSourceClick,onkeyup:this._handleSourceKeyup,"data-source-index":e,role:"menuitem","class":f.source,classes:t,tabindex:"-1"},this._getSourceName(e));var o},t.prototype._renderSearchResultsContent=function(){return this._searchResultRenderer.showMoreResultsOpen=!1,this._searchResultRenderer.viewModel=this.viewModel,this._searchResultRenderer},s([n.property(),r.renderable()],t.prototype,"activeMenu",void 0),s([n.aliasOf("viewModel.activeSource"),r.renderable()],t.prototype,"activeSource",void 0),s([n.aliasOf("viewModel.activeSourceIndex"),r.renderable()],t.prototype,"activeSourceIndex",void 0),s([n.aliasOf("viewModel.allPlaceholder"),r.renderable()],t.prototype,"allPlaceholder",void 0),s([n.aliasOf("viewModel.autoNavigate")],t.prototype,"autoNavigate",void 0),s([n.aliasOf("viewModel.autoSelect")],t.prototype,"autoSelect",void 0),s([n.aliasOf("viewModel.defaultSource")],t.prototype,"defaultSource",void 0),s([n.property()],t.prototype,"locationEnabled",void 0),s([n.aliasOf("viewModel.locationToAddressDistance")],t.prototype,"locationToAddressDistance",void 0),s([n.aliasOf("viewModel.maxResults")],t.prototype,"maxResults",void 0),s([n.aliasOf("viewModel.maxSuggestions")],t.prototype,"maxSuggestions",void 0),s([n.aliasOf("viewModel.minSuggestCharacters")],t.prototype,"minSuggestCharacters",void 0),s([n.aliasOf("viewModel.popupEnabled")],t.prototype,"popupEnabled",void 0),s([n.aliasOf("viewModel.popupOpenOnSelect")],t.prototype,"popupOpenOnSelect",void 0),s([n.aliasOf("viewModel.popupTemplate")],t.prototype,"popupTemplate",void 0),s([n.aliasOf("viewModel.resultGraphic")],t.prototype,"resultGraphic",void 0),s([n.aliasOf("viewModel.resultGraphicEnabled")],t.prototype,"resultGraphicEnabled",void 0),s([n.aliasOf("viewModel.results"),r.renderable()],t.prototype,"results",void 0),s([n.aliasOf("viewModel.searchAllEnabled"),r.renderable()],t.prototype,"searchAllEnabled",void 0),s([n.aliasOf("viewModel.searchTerm"),r.renderable()],t.prototype,"searchTerm",void 0),s([n.aliasOf("viewModel.selectedResult")],t.prototype,"selectedResult",void 0),s([n.aliasOf("viewModel.sources"),r.renderable()],t.prototype,"sources",void 0),s([n.property({readOnly:!0,dependsOn:["sources.length"]}),r.renderable()],t.prototype,"state",null),s([n.aliasOf("viewModel.suggestions"),r.renderable()],t.prototype,"suggestions",void 0),s([n.aliasOf("viewModel.suggestionsEnabled")],t.prototype,"suggestionsEnabled",void 0),s([n.aliasOf("viewModel.view"),r.renderable()],t.prototype,"view",void 0),s([r.vmEvent(["search-complete","search-clear","search-start","select-result","suggest-start","suggest-complete"]),n.property({type:i}),r.renderable(["viewModel.activeSource.placeholder","viewModel.activeSource.name"])],t.prototype,"viewModel",void 0),s([n.aliasOf("viewModel.clear")],t.prototype,"clear",null),s([r.accessibleHandler()],t.prototype,"_handleSourcesMenuToggleClick",null),s([r.accessibleHandler()],t.prototype,"_handleClearButtonClick",null),s([r.accessibleHandler()],t.prototype,"_handleSearchButtonClick",null),s([r.accessibleHandler()],t.prototype,"_handleSuggestionClick",null),s([r.accessibleHandler()],t.prototype,"_handleUseCurrentLocationClick",null),s([r.accessibleHandler()],t.prototype,"_handleSourceClick",null),t=s([n.subclass("esri.widgets.Search")],t)}(n.declared(a));return y});