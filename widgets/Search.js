// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/accessorSupport/decorators","./support/widget","./Search/SearchViewModel","./Search/SearchResultRenderer","./Widget","../core/lang","../core/watchUtils","../PopupTemplate","dojo/regexp","dojo/keys","dojo/query","dojo/i18n!./Search/nls/Search"],function(e,t,s,o,r,n,i,a,u,l,c,d,h,p,g,_){var v={base:"esri-search esri-widget",hasMultipleSources:"esri-search--multiple-sources",isSearchLoading:"esri-search--loading",showSuggestions:"esri-search--show-suggestions",showSources:"esri-search--sources",showWarning:"esri-search--warning",container:"esri-search__container",input:"esri-search__input",inputContainer:"esri-search__input-container",form:"esri-search__form",submitButton:"esri-search__submit-button",sourcesButton:"esri-search__sources-button",clearButton:"esri-search__clear-button",sourceName:"esri-search__source-name",suggestionsMenu:"esri-search__suggestions-menu",sourcesMenu:"esri-search__sources-menu",source:"esri-search__source",activeSource:"esri-search__source--active",warningMenu:"esri-search__warning-menu",warningMenuBody:"esri-search__warning-body",warningMenuHeader:"esri-search__warning-header",warningMenuText:"esri-search__warning-text",noValueText:"esri-search__no-value-text",button:"esri-widget-button",fallbackText:"esri-icon-font-fallback-text",menu:"esri-menu",header:"esri-header",searchIcon:"esri-icon-search",dropdownIcon:"esri-icon-down-arrow esri-search__sources-button--down",dropupIcon:"esri-icon-up-arrow esri-search__sources-button--up",clearIcon:"esri-icon-close",noticeIcon:"esri-icon-notice-triangle"},f=function(e){function t(t){var s=e.call(this)||this;return s._inputNode=null,s._sourceMenuButtonNode=null,s._sourceListNode=null,s._suggestionListNode=null,s._searchResultRenderer=new a({container:document.createElement("div")}),s._suggestPromise=null,s._popupTemplate=new d({title:_.searchResult,content:s._renderSearchResultsContent.bind(s)}),s._relatedTarget=null,s.activeMenu="none",s.activeSource=null,s.activeSourceIndex=null,s.allPlaceholder=null,s.autoNavigate=null,s.autoSelect=null,s.defaultSource=null,s.locationToAddressDistance=null,s.maxResults=null,s.maxSuggestions=null,s.minSuggestCharacters=null,s.popupEnabled=null,s.popupOpenOnSelect=null,s.popupTemplate=null,s.resultGraphic=null,s.resultGraphicEnabled=null,s.results=null,s.searchAllEnabled=null,s.searching=!1,s.searchTerm=null,s.selectedResult=null,s.sources=null,s.suggestions=null,s.suggestionsEnabled=null,s.view=null,s.viewModel=new i,s}return s(t,e),t.prototype.postInitialize=function(){var e=this;this.viewModel.popupTemplate=this._popupTemplate,this.own(c.whenNot(this,"searchTerm",function(){e.activeMenu="none"}))},t.prototype.destroy=function(){this._cancelSuggest(),this._searchResultRenderer&&(this._searchResultRenderer.viewModel=null,this._searchResultRenderer.destroy(),this._searchResultRenderer=null)},t.prototype.clear=function(){},t.prototype.focus=function(){this._inputNode&&(this._inputNode.focus(),this.emit("search-focus"))},t.prototype.blur=function(e){this._inputNode&&(this._inputNode.blur(),this._inputBlur(e),this.emit("search-blur"))},t.prototype.search=function(e){var t=this;return this.activeMenu="none",this._set("searching",!0),this._cancelSuggest(),this.viewModel.search(e).then(function(e){return t.activeMenu=e.numResults?"none":"warning",t._set("searching",!1),e}).otherwise(function(){return t._set("searching",!1),t.activeMenu="none",null})},t.prototype.suggest=function(e){var t=this;this._cancelSuggest();var s=this.viewModel.suggest(e).then(function(e){return e.numResults&&(t.activeMenu="suggestion"),e}).otherwise(function(){return t.activeMenu="none",null});return this._suggestPromise=s,s},t.prototype.render=function(){var e=this,t=this.viewModel,s=t.searchTerm,o=this._getSourceName(t.activeSourceIndex),r=s.trim(),a=this.id,u=n.tsx("input",{bind:this,placeholder:t.placeholder,"aria-label":_.searchButtonTitle,maxlength:t.maxInputLength,autocomplete:"off",type:"text",tabindex:"0","class":v.input,value:s,"aria-haspopup":"true",id:a+"_input",role:"textbox",onkeydown:this._handleInputKeydown,onkeyup:this._handleInputKeyup,oninput:this._handleInputPaste,onpaste:this._handleInputPaste,afterCreate:this._storeInputNode,afterUpdate:this._storeInputNode,onfocusout:this._storeRelatedTarget,onfocus:this.focus,onblur:this.blur}),c=n.tsx("form",{key:"esri-search__form",bind:this,"class":v.form,onsubmit:this._formSubmit,role:"search"},u),d=s?n.tsx("div",{key:"esri-search__clear-button",bind:this,role:"button","class":n.join(v.clearButton,v.button),tabindex:"0",title:_.clearButtonTitle,onfocus:this._clearButtonFocus,onclick:this._handleClearButtonClick,onkeydown:this._handleClearButtonClick},n.tsx("span",{"aria-hidden":"true","class":v.clearIcon})):null,h=t.suggestions?t.suggestions.map(function(t){var s=t.sourceIndex,o=t.results.length,r=o?e._getSuggestionHeaderNode(s):null,i=t.results,a=i.map(function(t,o){return e._getSuggestionNode(t,o,s)});return n.tsx("div",{key:"esri-search__suggestion-container-"+s},r,n.tsx("ul",{key:"esri-search__suggestion-list-"+s},a))}):null,p=n.tsx("div",{key:"esri-search__suggestions-menu","class":n.join(v.menu,v.suggestionsMenu),role:"menu",bind:this,afterCreate:this._storeSuggestionsListNode,afterUpdate:this._storeSuggestionsListNode},h),g=n.tsx("div",{key:"esri-search__input-container","class":v.inputContainer},c,p,d),f=n.tsx("div",{key:"esri-search__submit-button",bind:this,role:"button",title:_.searchButtonTitle,"class":n.join(v.submitButton,v.button),tabindex:"0",onclick:this._handleSearchButtonClick,onkeydown:this._handleSearchButtonClick},n.tsx("span",{"aria-hidden":"true",role:"presentation","class":v.searchIcon}),n.tsx("span",{"class":v.fallbackText},_.searchButtonTitle)),y=l.substitute({value:'"'+s+'"'},_.noResultsFound),S=r?n.tsx("div",{key:"esri-search__no_results"},n.tsx("div",{"class":v.warningMenuHeader},_.noResults),n.tsx("div",{"class":v.warningMenuText},y)):null,w=r?null:n.tsx("div",{key:"esri-search__empty-search"},n.tsx("span",{"aria-hidden":"true","class":v.noticeIcon}),n.tsx("span",{"class":v.noValueText},_.emptyValue)),m=n.tsx("div",{key:"esri-search__error-menu","class":n.join(v.menu,v.warningMenu)},n.tsx("div",{"class":v.warningMenuBody},S,w)),M=t.sources,b=M.length>1,x=M&&M.toArray(),N=t.searchAllEnabled?this._getSourceNode(i.ALL_INDEX):null,R=b?n.tsx("div",{key:"esri-search__source-menu-button",bind:this,role:"button",title:_.searchIn,id:a+"_menu_button","class":n.join(v.sourcesButton,v.button),tabindex:"0",onkeydown:this._handleSourcesMenuToggleClick,onclick:this._handleSourcesMenuToggleClick,onkeyup:this._handleSourceMenuButtonKeyup,onblur:this._sourcesButtonBlur,afterCreate:this._storeSourceMenuButtonNode,afterUpdate:this._storeSourceMenuButtonNode},n.tsx("span",{"aria-hidden":"true",role:"presentation","class":v.dropdownIcon}),n.tsx("span",{"aria-hidden":"true",role:"presentation","class":v.dropupIcon}),n.tsx("span",{"class":v.sourceName},o)):null,k=b?n.tsx("ul",{bind:this,afterCreate:this._storeSourcesListNode,afterUpdate:this._storeSourcesListNode},N,x.map(function(t,s){return e._getSourceNode(s)})):null,T=n.tsx("div",{key:"esri-search__source-menu","class":n.join(v.menu,v.sourcesMenu),role:"menu"},k),C=this.activeMenu,O=(B={},B[v.hasMultipleSources]=b,B[v.isSearchLoading]=this.searching,B[v.showWarning]="warning"===C,B[v.showSources]="source"===C,B[v.showSuggestions]="suggestion"===C,B);return n.tsx("div",{"class":v.base},n.tsx("div",{role:"presentation",classes:O,"class":v.container},R,T,g,f,m));var B},t.prototype._handleSourcesMenuToggleClick=function(){this.activeMenu="source"===this.activeMenu?"none":"source"},t.prototype._handleClearButtonClick=function(){this.viewModel.clear(),this.focus()},t.prototype._handleSearchButtonClick=function(){this.search()},t.prototype._handleSuggestionClick=function(e){var t=e.currentTarget,s=t["data-suggestion"];s&&(this.search(s),this.focus())},t.prototype._handleSourceClick=function(e){var t=this.viewModel,s=e.currentTarget,o=s["data-source-index"];t.activeSourceIndex=o,this.activeMenu="none",this.focus()},t.prototype._sourcesButtonBlur=function(e){var t=e&&e.relatedTarget;this._removeActiveMenu(t,this._sourceListNode)},t.prototype._inputBlur=function(e){var t=e&&e.relatedTarget;this._removeActiveMenu(t?t:this._relatedTarget,this._suggestionListNode)},t.prototype._storeRelatedTarget=function(e){this._relatedTarget=e.relatedTarget},t.prototype._clearButtonFocus=function(){this.activeMenu="none"},t.prototype._removeActiveMenu=function(e,t){e&&t&&t.contains(e)||(this.activeMenu="none")},t.prototype._cancelSuggest=function(){var e=this._suggestPromise;e&&(e.cancel(),this._suggestPromise=null)},t.prototype._storeSuggestionsListNode=function(e){this._suggestionListNode=e},t.prototype._storeSourcesListNode=function(e){this._sourceListNode=e},t.prototype._storeInputNode=function(e){this._inputNode=e},t.prototype._storeSourceMenuButtonNode=function(e){this._sourceMenuButtonNode=e},t.prototype._handleInputKeydown=function(e){var t=e.keyCode;(t===p.TAB||t===p.ESCAPE||e.shiftKey&&t===p.TAB)&&this._cancelSuggest()},t.prototype._handleInputKeyup=function(e){var t=e.keyCode,s=e.ctrlKey||e.metaKey||t===p.copyKey||t===p.LEFT_ARROW||t===p.RIGHT_ARROW||t===p.ENTER||t===p.SHIFT,o=this._suggestionListNode?g("li",this._suggestionListNode):null,r=t===p.UP_ARROW,n=t===p.DOWN_ARROW;if(!s){if(t===p.TAB||t===p.ESCAPE||e.shiftKey&&t===p.TAB)return this._cancelSuggest(),void(t===p.ESCAPE&&(this.activeMenu="none"));if((r||n)&&o){this.activeMenu="suggestion",e.stopPropagation(),e.preventDefault(),this._cancelSuggest();var i=r?o.length-1:0,a=o[i];return void(a&&a.focus())}this.viewModel.searchTerm&&this.suggest()}},t.prototype._handleInputPaste=function(e){var t=this.viewModel,s=e.target;t.searchTerm!==s.value&&(t.searchTerm=s.value),t.searchTerm&&this.suggest()},t.prototype._handleSourceMenuButtonKeyup=function(e){var t=e.keyCode,s=t===p.UP_ARROW,o=t===p.DOWN_ARROW;if(s||o){e.stopPropagation(),e.preventDefault();var r=this._sourceListNode?g("li",this._sourceListNode):null;if(r){var n=s?r.length-1:0,i=r[n];i&&i.focus()}}},t.prototype._handleSourceKeyup=function(e){var t=e.target,s=this._sourceListNode?g("li",this._sourceListNode):null,o=e.keyCode;if(o===p.ESCAPE)return this.activeMenu="none",void this.focus();if(s){var r=s.indexOf(t);if(o===p.UP_ARROW){e.stopPropagation(),e.preventDefault();var n=r-1,i=0>n?this._sourceMenuButtonNode:s[n];return void(i&&i.focus())}if(o===p.DOWN_ARROW){e.stopPropagation(),e.preventDefault();var a=r+1,u=a>=s.length?this._sourceMenuButtonNode:s[a];u&&u.focus()}}},t.prototype._handleSuggestionKeyup=function(e){var t=e.target,s=this._suggestionListNode?g("li",this._suggestionListNode):null,o=s.indexOf(t),r=e.keyCode;if(this._cancelSuggest(),r===p.BACKSPACE||r===p.DELETE)return void this.focus();if(r===p.ESCAPE)return this.activeMenu="none",void this.focus();if(s){if(r===p.UP_ARROW){e.stopPropagation(),e.preventDefault();var n=o-1;if(0>n)this.focus();else{var i=s[n];i&&i.focus()}return}if(r===p.DOWN_ARROW){e.stopPropagation(),e.preventDefault();var a=o+1;if(a>=s.length)this.focus();else{var u=s[a];u&&u.focus()}return}}},t.prototype._formSubmit=function(e){e.preventDefault(),this.search()},t.prototype._getSourceName=function(e){var t=this.viewModel,s=t.sources,o=s.getItemAt(e);return e===i.ALL_INDEX?_.all:o?o.name:_.untitledSource},t.prototype._getSuggestionHeaderNode=function(e){var t=this.viewModel;if(t.sources.length>1&&t.activeSourceIndex===i.ALL_INDEX){var s=this._getSourceName(e);return n.tsx("div",{"class":v.header},s)}return null},t.prototype._splitResult=function(e,t){var s=h.escapeString(t),o=e.replace(new RegExp("(^|)("+s+")(|$)","ig"),"$1|$2|$3");return o.split("|")},t.prototype._getSuggestionNode=function(e,t,s){var o=this.viewModel,r=o.searchTerm;if(r){var i=e.text,a=i||_.untitledResult,u=this._splitResult(a,r),l=r.toLowerCase(),c=[];return u.forEach(function(e,o){if(e&&e.length){var r=s+"-"+t+"-"+o;e.toLowerCase()===l?c.push(n.tsx("strong",{key:"esri-search__partial-match-"+r},e)):c.push(e)}}),n.tsx("li",{bind:this,onclick:this._handleSuggestionClick,onkeydown:this._handleSuggestionClick,onkeyup:this._handleSuggestionKeyup,key:"esri-search__suggestion$-{sourceIndex}_"+t,"data-suggestion":e,role:"menuitem",tabindex:"0"},c)}},t.prototype._getSourceNode=function(e){var t=(s={},s[v.activeSource]=e===this.viewModel.activeSourceIndex,s);return n.tsx("li",{bind:this,key:"esri-search__source-"+e,onclick:this._handleSourceClick,onkeydown:this._handleSourceClick,onkeyup:this._handleSourceKeyup,"data-source-index":e,role:"menuitem","class":v.source,classes:t,tabindex:"0"},this._getSourceName(e));var s},t.prototype._renderSearchResultsContent=function(){return this._searchResultRenderer.showMoreResultsOpen=!1,this._searchResultRenderer.viewModel=this.viewModel,this._searchResultRenderer},o([r.property(),n.renderable()],t.prototype,"activeMenu",void 0),o([r.aliasOf("viewModel.activeSource"),n.renderable()],t.prototype,"activeSource",void 0),o([r.aliasOf("viewModel.activeSourceIndex"),n.renderable()],t.prototype,"activeSourceIndex",void 0),o([r.aliasOf("viewModel.allPlaceholder"),n.renderable()],t.prototype,"allPlaceholder",void 0),o([r.aliasOf("viewModel.autoNavigate")],t.prototype,"autoNavigate",void 0),o([r.aliasOf("viewModel.autoSelect")],t.prototype,"autoSelect",void 0),o([r.aliasOf("viewModel.defaultSource")],t.prototype,"defaultSource",void 0),o([r.aliasOf("viewModel.locationToAddressDistance")],t.prototype,"locationToAddressDistance",void 0),o([r.aliasOf("viewModel.maxResults")],t.prototype,"maxResults",void 0),o([r.aliasOf("viewModel.maxSuggestions")],t.prototype,"maxSuggestions",void 0),o([r.aliasOf("viewModel.minSuggestCharacters")],t.prototype,"minSuggestCharacters",void 0),o([r.aliasOf("viewModel.popupEnabled")],t.prototype,"popupEnabled",void 0),o([r.aliasOf("viewModel.popupOpenOnSelect")],t.prototype,"popupOpenOnSelect",void 0),o([r.aliasOf("viewModel.popupTemplate")],t.prototype,"popupTemplate",void 0),o([r.aliasOf("viewModel.resultGraphic")],t.prototype,"resultGraphic",void 0),o([r.aliasOf("viewModel.resultGraphicEnabled")],t.prototype,"resultGraphicEnabled",void 0),o([r.aliasOf("viewModel.results"),n.renderable()],t.prototype,"results",void 0),o([r.aliasOf("viewModel.searchAllEnabled"),n.renderable()],t.prototype,"searchAllEnabled",void 0),o([r.property({readOnly:!0}),n.renderable()],t.prototype,"searching",void 0),o([r.aliasOf("viewModel.searchTerm"),n.renderable()],t.prototype,"searchTerm",void 0),o([r.aliasOf("viewModel.selectedResult")],t.prototype,"selectedResult",void 0),o([r.aliasOf("viewModel.sources"),n.renderable()],t.prototype,"sources",void 0),o([r.aliasOf("viewModel.suggestions"),n.renderable()],t.prototype,"suggestions",void 0),o([r.aliasOf("viewModel.suggestionsEnabled")],t.prototype,"suggestionsEnabled",void 0),o([r.aliasOf("viewModel.view"),n.renderable()],t.prototype,"view",void 0),o([n.vmEvent(["search-complete","search-clear","search-start","select-result","suggest-start","suggest-complete"]),r.property({type:i}),n.renderable("viewModel")],t.prototype,"viewModel",void 0),o([r.aliasOf("viewModel.clear")],t.prototype,"clear",null),o([n.accessibleHandler()],t.prototype,"_handleSourcesMenuToggleClick",null),o([n.accessibleHandler()],t.prototype,"_handleClearButtonClick",null),o([n.accessibleHandler()],t.prototype,"_handleSearchButtonClick",null),o([n.accessibleHandler()],t.prototype,"_handleSuggestionClick",null),o([n.accessibleHandler()],t.prototype,"_handleSourceClick",null),t=o([r.subclass("esri.widgets.Search")],t)}(r.declared(u));return f});