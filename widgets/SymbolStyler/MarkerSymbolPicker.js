// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../core/domUtils","../../core/promiseUtils","../../portal/Portal","../../symbols/support/gfxUtils","../../symbols/support/symbolUtils","./support/symbolFetcher","./support/symbolStorage","./support/symbolUtils","dijit/_TemplatedMixin","dijit/_WidgetBase","dijit/_WidgetsInTemplateMixin","dijit/Tooltip","dojo/dom-class","dojo/dom-construct","dojo/on","dojo/promise/all","dojo/store/Memory","dojo/store/Observable","dojo/i18n!./nls/SymbolStyler","dojo/text!./templates/MarkerSymbolPicker.html","dijit/form/Select"],function(t,e,o,i,s,l,r,n,a,m,c,y,d,u,h,b,p,S,_,f){function g(t){var e={};return t.get("data.items")&&t.data.items.forEach(function(t){e[t.name]=t.title}),e}var v={id:"customTypes",keywords:"custom symbols",name:_.customImages,title:_.customImages},I={root:"esri-marker-symbol-picker",symbolGrid:"esri-symbol-grid",symbol:"esri-symbol",noSymbols:"esri-no-symbols",defaultSymbols:"esri-default-symbols",loadingIndicator:"esri-loading-indicator",loading:"esri-loading",typeInput:"esri-type-input",categorySelect:"esri-marker-symbol-picker__category-select",container:"esri-container",overlay:"esri-overlay",content:"esri-content",centerContainer:"esri-center-container",table:"esri-table",tableCell:"esri-table-cell",centerBlock:"esri-center-block",loadingSymbolViewport:"esri-marker-symbol-picker__symbolViewport--loading",symbolViewport:"esri-marker-symbol-picker__symbolViewport",selectedSymbol:"esri-symbol--selected",dimensionalityFlat:"esri-marker-symbol-picker--dimensionality-flat",dimensionalityVolumetric:"esri-marker-symbol-picker--dimensionality-volumetric",blocked:"esri-marker-symbol-picker--blocked"},k=m.createSubclass([a,c],{baseClass:I.root,declaredClass:"esri.widgets.SymbolStyler.MarkerSymbolPicker",templateString:f,css:I,postCreate:function(){this.inherited(arguments),this._sourceSymbolTypesStore=new p,this._symbolTypesStore=new S(new p),this._symbolItemStore=new p,this._symbolItemSurfaces=[],this._activeSymbolFetch={},this.dap_markerCategoryInput.set({labelAttr:"name",sortByLabel:!1}),this._symbolTooltip=new y({connectId:this.dap_symbolGrid,selector:".esri-symbol",getContent:function(t){var e=n.getSymbolName(t.symbol);return this._symbolStyleNameToTooltip[e]||e||""}.bind(this)}),this.own(this._symbolTooltip)},startup:function(){this.inherited(arguments);var t=this;h(this.dap_symbolGrid,".esri-symbol:click",function(){t._selectedNode&&d.remove(t._selectedNode,I.selectedSymbol),t._selectedNode=this,d.add(this,I.selectedSymbol),t.emit("symbol-select",{selection:this.symbol.clone()})}),this.dap_markerCategoryInput.on("change",function(t){this.clearSelection(),this._fetchSymbols(t)}.bind(this)),this.refresh()},_3dSymbolsFilter:"volumetric",_symbolTypesStore:null,_sourceSymbolTypesStore:null,_symbolItemStore:null,_symbolItemSurfaces:null,_noSymbolsOverlay:null,_symbolGrid:null,_portal:null,_portalLoadTimeoutInMs:3e3,_selectedNode:null,_symbolTooltip:null,_symbolStyleNameToTooltip:null,displayMode:"portal",portal:null,symbolSource:"symbol-set",addCustomImageSymbol:function(t){var e=t.clone(),o=r.loadCustomItems()||[],i=e.url.split("/").pop(),s=o.some(function(t){return t.url===e.url});s||(e.type="esriPMS",e.name=i,o.push(e),this.dap_markerCategoryInput.set("value",v.id),this.clearSelection(),this._fetchSymbols(v.id))},_getDimensionality:function(){return this.symbolSource.split(":")[1]},_updateDisplay:function(){var e=this.dap_markerCategoryInput;this.clearSelection(),"portal"===this.displayMode?(this._fetchSymbols(e.value),t.show(e.domNode),d.remove(this.domNode,I.defaultSymbols)):"default"===this.displayMode&&(this._updateSymbolOptions(l.getBasic()),t.hide(e.domNode),d.add(this.domNode,I.defaultSymbols))},refresh:function(){this._blockInteraction(!0),this._setUpDimensionality(),this._setUpSymbolCategories().then(this._updateDisplay.bind(this)).then(function(){this._blockInteraction(!1)}.bind(this))},_blockInteraction:function(t){this.dap_markerCategoryInput.set("disabled",t),d.toggle(this.domNode,I.blocked,t)},clearSelection:function(){u.empty(this.dap_symbolGrid)},_activeSymbolFetch:null,_fetchSymbols:function(t){var e,o;this._activeSymbolFetch.promise&&(this._activeSymbolFetch.promise.cancel(),this._activeSymbolFetch.promise=null,this._activeSymbolFetch.id=null),e=this._symbolItemStore.query({id:t})[0],e&&(r.saveRecentItem(e),this._updateSymbolOptions(e.symbols),e.id!==v.id)||(o=this._symbolTypesStore.query({id:t})[0],this._activeSymbolFetch.id=t,this._showLoadingIndicator(),this._activeSymbolFetch.promise=this._getSymbols(o).then(function(e){var o,i={id:t,symbols:e};return this._symbolItemStore.put(i),r.saveRecentItem(i),o=this._symbolTypesStore.query({defaultType:!0})[0],o&&o.id===t&&r.saveDefaultItem(i),e}.bind(this)).then(function(e){t===this._activeSymbolFetch.id&&this._updateSymbolOptions(e)}.bind(this)))},_showLoadingIndicator:function(){d.add(this.dap_symbolViewport,I.loadingSymbolViewport)},_hideLoadingIndicator:function(){d.remove(this.dap_symbolViewport,I.loadingSymbolViewport)},_showNoSymbolsMessage:function(){this._hideLoadingIndicator(),d.add(this.domNode,I.noSymbols),this._placeNoSymbolsOverlay()},_placeNoSymbolsOverlay:function(){var t,e,o,i;this._noSymbolsOverlay||(t=u.create("div",{"class":I.overlay}),i=u.create("div",{"class":I.centerContainer+" "+I.table},t),o=u.create("div",{"class":I.tableCell},i),e=u.create("div",{"class":I.centerBlock},o),u.create("div",{"class":I.content,innerHTML:_.symbolLoadError},e),u.place(t,this.domNode),this._noSymbolsOverlay=t)},_setUpSymbolCategories:function(){return this._showLoadingIndicator(),this._initPortal().then(function(t){return 0===this.symbolSource.indexOf("symbol-set")?l.fetchSymbolSetSymbolSources(t):l.fetchWebStyleSymbolSources(t).then(function(t){return t.sort(function(t,e){var o=s.styleNameFromItem(t.portalItem),i=s.styleNameFromItem(e.portalItem);return o>i?1:i>o?-1:0})})}.bind(this)).then(function(t){var e=this._webStyleItemKeywordBlacklist;return t.filter(function(t){return!t.portalItem.typeKeywords.some(function(t){return e[t]})})}.bind(this)).then(function(t){if(0===this.symbolSource.indexOf("symbol-set"))return t;var o=this._getDimensionality(),i=t.map(function(t){return t.portalItem.fetchData()});return e.eachAlways(i).then(function(e){var i=[l.getPrimitives(o)];return e.forEach(function(e,l){var r=e.value;if(r&&r.items&&Array.isArray(r.items)&&0!==r.items.length){var n=s.styleNameFromItem(t[l].portalItem),a="EsriIconsStyle"===n?"flat":"volumetric",m=r.items[0].dimensionality||a;m===o&&i.push(t[l])}}),i})}.bind(this)).then(this._setUpSymbolSelect.bind(this)).otherwise(this._showNoSymbolsMessage.bind(this))},_webStyleItemKeywordBlacklist:{EsriThematicShapesStyle:!0},_setUpDimensionality:function(){var t="volumetric"===this._getDimensionality();d.toggle(this.domNode,I.dimensionalityVolumetric,t),d.toggle(this.domNode,I.dimensionalityFlat,!t)},_setUpSymbolSelect:function(t){var e,o,i,s=this._sourceSymbolTypesStore;s.setData(t),t.forEach(function(t){t.defaultType&&(e=t.id)}),o=r.loadRecentSymbolItem(),o&&(i=s.query({id:o.id})[0],i&&(e=o.id));var l=this._symbolTypesStore;l.setData(s.query()),this.dap_markerCategoryInput.set("store",l),this.dap_markerCategoryInput.set("value",e,!1)},_injectCustomSymbolType:function(t){return t.push(v),t},_initPortal:function(){var t,i=this.portal||o.getDefault();return t=e.timeout(i.load().then(function(){return this._portal=i,i}.bind(this)),this._portalLoadTimeoutInMs),this.own(t),t},_getSymbols:function(t){return t.id===v.id?r.loadCustomItems():t.getSymbols().then(function(e){return this._symbolStyleNameToTooltip=g(t),0===this.symbolSource.indexOf("symbol-set")?e:e.filter(function(e,o){var i=t.get("data.items"),s=i&&i[o].dimensionality,l=n.getDimensionality(e),r=s||l,a=this.symbolSource.split(":")[1];return!a||r===a},this)}.bind(this))},_updateSymbolOptions:function(t){this._symbolItemSurfaces.forEach(function(t){t&&t.destroy()}),this._symbolItemSurfaces.length=0;var e="volumetric"===this._getDimensionality(),o=e?48:24;b(t.map(function(t){var e=u.create("div",{className:I.symbol});return"point-symbol-3d"===t.type&&t.symbolLayers.forEach(function(t){t.get("material.color")&&("Icon"===t.type?t.material.color=i.defaultThematicColor.clone():"Object"===t.type&&(t.material.color=[255,255,255]))}),e.symbol=t,n.renderOnSurface(t,e,o)})).then(function(t){var e=document.createDocumentFragment();t.forEach(function(t){e.appendChild(t)}),this.dap_symbolGrid.appendChild(e),this._hideLoadingIndicator()}.bind(this))}});return k});