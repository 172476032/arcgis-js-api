// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../core/domUtils","../symbols/PictureMarkerSymbol","./ColorPicker","./ColorPicker/colorUtils","./SymbolStyler/_DelayedUpdate","./SymbolStyler/IconSelect","./SymbolStyler/MarkerSymbolPicker","./SymbolStyler/support/schemeUtils","./SymbolStyler/support/stylerUtils","./SymbolStyler/support/symbolUtils","dijit/_TemplatedMixin","dijit/_WidgetBase","dijit/_WidgetsInTemplateMixin","dijit/a11yclick","dijit/form/CheckBox","dijit/form/ComboBoxMixin","dijit/form/NumberTextBox","dojo/dom-class","dojo/dom-construct","dojo/keys","dojo/number","dojo/on","dojo/i18n!./SymbolStyler/nls/SymbolStyler","dojo/text!./SymbolStyler/templates/SymbolStyler.html","./HorizontalSlider","./SymbolStyler/MarkerSymbolPicker","./SymbolStyler/ColorRampPicker","dijit/form/Button","dijit/form/ComboBox","dijit/form/NumberSpinner","dijit/form/Select","dijit/form/TextBox","dijit/layout/BorderContainer","dijit/layout/ContentPane","dijit/layout/StackController","dijit/layout/StackContainer"],function(t,e,i,o,l,s,n,r,a,d,h,p,c,_,u,m,g,b,C,S,y,f,P,x){function I(e){b.remove(t.getNode(e),v.hidden)}function k(e){b.add(t.getNode(e),v.hidden)}var T=d.is3d,v={root:"esri-symbol-styler",symbolPreviewContainer:"esri-symbol-preview-container",symbolPreview:"esri-symbol-preview",tabBar:"esri-tab-bar",content:"esri-content",link:"esri-link",label:"esri-label",shapeImageUrlContainer:"esri-shape-image-url-container",urlInput:"esri-url-input",addIcon:"esri-add-icon",errorDisplay:"esri-error-display",symbolSizeInput:"esri-symbol-size-input",inlineInput:"esri-inline-input",text:"esri-text",hidden:"esri-hidden",lineWidthInput:"esri-line-width-input",linePattern:"esri-line-pattern",linePatternInput:"esri-line-pattern-input",alt:"esri-alt",disabled:"esri-disabled"},z=p.createSubclass([h,c,l],{declaredClass:"esri.widgets.SymbolStyler",baseClass:v.root,templateString:x,labels:P,css:v,constructor:function(){this._tabOptions={},this._delayedCommitPropsTrigger=this.createUpdateTrigger(this._commitProperties,this),this._initOptimizationControls()},postCreate:function(){this.inherited(arguments),this._setUpComboBox();var t=s.prototype.baseClass,e=new s({baseClass:t+" "+v.root+" "+v.linePatternInput},this.dap_linePatternSelect);this._linePatternSelect=e,k(this.dap_shapeImageUrlContainer),this.dap_shapeImageUrlInput.set("placeholder",P.imageUrlInputPlaceholder),this._lineWidthTextBox.selectOnClick=!0,this.dap_shapeSizeTextBox.selectOnClick=!0,this.dap_lineWidthSlider.intermediateChanges=!0,this._lineWidthTextBox.intermediateChanges=!0,this.dap_shapeSizeSlider.intermediateChanges=!0,this.dap_shapeSizeTextBox.intermediateChanges=!0,this.dap_fillColorPicker.trackColors=!1,this.dap_outlineColorPicker.trackColors=!1,this._linePatternSelect.addIconOptions(["solid","dot","dash","dash-dot","long-dash-dot-dot"],v.linePattern),this._importRecentColors(),this.dap_outlineColorPicker._enableTransparencySlider=function(){},this.dap_outlineColorPicker._disableTransparencySlider=function(){}},startup:function(){this.inherited(arguments);var t=new n(this._getSymbolPickerParams(),this.dap_symbolPicker);t.startup(),this._symbolPicker=t,this._addHandlers()},destroy:function(){this._symbolPreviewSurface&&C.empty(this._symbolPreviewSurface),C.destroy(this._optimizationSection),this._optimizationCheckBox.destroy(),this.dap_shapeContainer.destroy(),this.dap_fillContainer.destroy(),this.dap_outlineContainer.destroy(),this.inherited(arguments)},_RECENT_FILL_COLORS_ITEM_KEY:"symbolStyler/recent/fill/colors",_RECENT_OUTLINE_COLORS_ITEM_KEY:"symbolStyler/recent/outline/colors",_defaultMinLineWidthInPx:0,_defaultMinShapeSizeInPx:1,_defaultMaxLineWidthInPx:18,_defaultMaxShapeSizeInPx:120,_originalSymbol:null,_editedSymbol:null,_activeTabName:null,_externalSizing:!1,_delayedCommitPropsTrigger:null,_symbolPreviewSurface:null,_linePatternSelect:null,_symbolPicker:null,_customImageSymbol:null,_optimizationSection:null,_optimizationCheckBox:null,_isPreppingEdit:null,shapeSymbol:null,_setShapeSymbolAttr:function(t){this._adjustOutlineProperties(this._editedSymbol,t),this._set("shapeSymbol",t),this._editedSymbol=t,this._updateTabs(t),this._toggleOutlineColorControls(t),this._delayedCommitPropsTrigger()},shapeSize:null,_setShapeSizeAttr:function(t){this._set("shapeSize",t),this._delayedCommitPropsTrigger()},_shapeImageUrl:null,_setShapeImageUrlAttr:function(t){this._set("shapeImageUrl",t),this._delayedCommitPropsTrigger()},fillColor:null,_setFillColorAttr:function(t){this._set("fillColor",t),this._delayedCommitPropsTrigger()},fillColorRamp:null,_setFillColorRampAttr:function(t){this._set("fillColorRamp",t),this._delayedCommitPropsTrigger()},outlineColorRamp:null,_setOutlineColorRampAttr:function(t){this._set("outlineColorRamp",t),this._delayedCommitPropsTrigger()},outlineWidth:null,_setOutlineWidthAttr:function(t){this._set("outlineWidth",t),this._delayedCommitPropsTrigger()},outlineColor:null,_setOutlineColorAttr:function(t){var e=!!this._optimizationOptions&&this._optimizationCheckBox.checked;t&&e&&(t.a=.5,this.dap_outlineColorPicker.set("color",t,!1)),this._set("outlineColor",t),this._delayedCommitPropsTrigger()},outlinePattern:null,_setOutlinePatternAttr:function(t){this._set("outlinePattern",t),this._delayedCommitPropsTrigger()},mode:"2d",_setModeAttr:function(t){var e="2d"===t;this._set("mode",t),this.dap_linePatternSelect.hidden=!e,this.dap_linePatternSelectLabel.hidden=!e,this.dap_useImageContent.hidden=!e},portal:null,previewVisible:!0,_setPreviewVisibleAttr:function(t){this._set("previewVisible",t),this.dap_symbolPreviewContainer.hidden=!t,this._delayedCommitPropsTrigger()},edit:function(t,e){d.ensureProps(t.clone()).then(function(i){var o;if(e=e||{},o=e.colorRamp,T(i)&&"3d"!==this.mode||!T(i)&&"2d"!==this.mode)throw new Error("symbol-styler:incompatible-symbol-edit","tried to edit a symbol with an incompatible mode",{symbol:i,mode:this.mode});this._isPreppingEdit=!0,this._colorRamp=o,this._originalSymbol=t,this._editedSymbol=i,this._activeTabName=e.activeTab,this._externalSizing=e.externalSizing,this._tabOptions=e.tabOptions||{},this._optimizationOptions="boolean"==typeof e.optimizeOutline?{value:e.optimizeOutline}:void 0,this._setUpColorControls(e.schemes,o),this._assimilateSymbol(i),this._toggleSizingControls(this._externalSizing),this._updateSymbolPicker(),this._toggleOutlineColorControls(i),this._toggleOptimizationOptions();var l=d.hasExtrudeSymbolLayer(i)||d.hasTextSymbolLayer(t)?this.dap_fillContainer:this.dap_shapeContainer;C.place(this.dap_shapeSizeControls,l.domNode,"last")}.bind(this))},getStyle:function(){var t,e,i=this._editedSymbol.clone(),o={symbol:i};return this._colorRamp&&(t=d.isLine(i,"2d")||d.isPoint(i,"2d")&&d.hasPureOutlineStyle(i),e=t?this.dap_outlineColorRampPicker:this.dap_fillColorRampPicker,o.colorRamp=e.get("selected").colors),this._optimizationOptions&&(o.optimizeOutline=this._optimizationCheckBox.checked),o},storeColors:function(){this._storeRecentColors(this.dap_fillColorPicker,this._RECENT_FILL_COLORS_ITEM_KEY),this._storeRecentColors(this.dap_outlineColorPicker,this._RECENT_OUTLINE_COLORS_ITEM_KEY)},_initOptimizationControls:function(){var t=new u,e=C.create("div",{className:i.prototype.css.section});C.create("label",{"for":t.id,className:v.label,innerHTML:P.autoAdjustOutline},e),t.on("change",function(t){var e=this.dap_outlineColorPicker.get("color");e.a=t?.5:1,this.dap_outlineColorPicker.set("color",e),this._delayedCommitPropsTrigger()}.bind(this)),t.placeAt(e,"first"),this._optimizationSection=e,this._optimizationCheckBox=t},_toggleOutlineColorControls:function(t){var e=this.dap_outlineColorRampPicker,i=this.dap_outlineColorPicker;this._shouldShowOutlineColorRamp(t)?(I(e),k(i)):(I(i),k(e))},_shouldShowOutlineColorRamp:function(t){var e=d;return this._colorRamp&&(e.isLine(t,"2d")||e.isPoint(t,"2d")&&e.hasPureOutlineStyle(t))},_setUpColorControls:function(t,e){var i,o=this.dap_outlineColorRampPicker,l=this.dap_outlineColorPicker,s=this.dap_fillColorRampPicker,n=this.dap_fillColorPicker;return e?(i={colors:e.colors},e.scheme&&(i.scheme=e.scheme),d.isLine(this._editedSymbol,"2d")?(o.set({numStops:e.numStops,schemes:t,selected:i}),k(l),I(o)):(d.isPoint(this._editedSymbol,"2d")&&o.set({numStops:e.numStops,schemes:t,selected:i}),s.set({numStops:e.numStops,schemes:t,selected:i}),I(s),I(l),k(n),k(o)),void l.set("suggestedColors",r.getOutlineColors(t))):(I(n),I(l),k(s),k(o),this._updateSuggestedColors(n,r.getFillColors(t)),void this._updateSuggestedColors(l,r.getOutlineColors(t)))},_toggleOptimizationOptions:function(){var t=this._optimizationOptions,e=this._optimizationSection;d.isPolygon(this._editedSymbol,"2d")&&t?(this._optimizationCheckBox.set("value",t.value),C.place(e,this.dap_outlineColorPicker.dap_recentColorSection)):e.parentNode&&C.empty(e.parentNode)},_importRecentColors:function(){this.dap_fillColorPicker.loadRecentColors(this._RECENT_FILL_COLORS_ITEM_KEY),this.dap_outlineColorPicker.loadRecentColors(this._RECENT_OUTLINE_COLORS_ITEM_KEY)},_toggleSizingControls:function(t){var e=!1,i=!1;t&&(d.isLine(this._editedSymbol)?i=!0:e=!0),this._toggleLabeledControls({labels:this.dap_lineWidthLabel,controls:[this._lineWidthTextBox,this.dap_lineWidthSlider],disabled:i}),this._toggleLabeledControls({labels:this.dap_shapeSizeLabel,controls:[this.dap_shapeSizeTextBox,this.dap_shapeSizeSlider],disabled:e})},_toggleLabeledControls:function(t){var e=[].concat(t.labels),i=[].concat(t.controls),o=t.disabled;e.forEach(function(t){b.toggle(t,v.disabled,o)}),i.forEach(function(t){a.toggleControl(t,o)})},_updateSymbolPicker:function(){var t=!!this._tabOptions.symbolDisplayMode,e=t?this._tabOptions.symbolDisplayMode:d.isPoint(this._editedSymbol,"2d")&&this._colorRamp?"default":"portal";this.dap_useImageContent.hidden="3d"===this.mode||"portal"!==e,this._symbolPicker.set({displayMode:e,symbolSource:d.getSymbolSource(this._editedSymbol)}),this._symbolPicker.refresh()},_adjustOutlineProperties:function(t,e){var i,l,s,n=this.dap_fillColorPicker,r=this.dap_outlineColorPicker,a=this.dap_fillColorRampPicker,h=this.dap_outlineColorRampPicker,p=.1,c=.2;if(d.switchedFromRasterToVectorSymbol(t,e))return n.set("color",e.color),i=d.getOutline(e),r.set("color",i.color),this._lineWidthTextBox.set("value",i.size),void this._linePatternSelect.set("value",i.style);if(d.switchedFromPureOutline(t,e)&&this._colorRamp)return void a.set("selected",h.get("selected"));if(d.switchedToPureOutline(t,e)){if(this._colorRamp)return void h.set("selected",a.get("selected"));if(i=d.getOutline(t),s=r.get("color"),!i.color)return void r.set("color",e.color);l=o.isBright(i.color),l&&i.color.a<c?(s.a=c,r.set("color",s)):!l&&i.color.a<p&&(s.a=p,r.set("color",s))}},_getTabContainer:function(t){return"fill"===t?this.dap_fillContainer:"outline"===t?this.dap_outlineContainer:this.dap_shapeContainer},_storeRecentColors:function(t,e){var i=t;i.addRecentColor(i.get("color")),i.saveRecentColors(e)},_addHandlers:function(){this._linePatternSelect.on("change",function(t){this.set("outlinePattern",t)}.bind(this)),this.own(f(this.dap_loadShapeImageUrl,_,function(){this._loadImage(this.dap_shapeImageUrlInput.get("value"))}.bind(this))),this.own(f(this.dap_addImage,_,function(){I(this.dap_shapeImageUrlContainer),this.dap_shapeImageUrlInput.focus()}.bind(this))),this.dap_shapeImageUrlInput.on("input",function(t){t.keyCode===S.ENTER&&this._loadImage(this.dap_shapeImageUrlInput.get("value"))}.bind(this)),this.dap_shapeImageUrlInput.on("change",function(t){this.set("shapeImageUrl",t)}.bind(this)),this.dap_fillColorPicker.on("color-change",function(t){this.set("fillColor",t.color)}.bind(this)),this.dap_fillColorRampPicker.on("color-ramp-change",function(t){this.set("fillColorRamp",t.colors)}.bind(this)),this.dap_outlineColorRampPicker.on("color-ramp-change",function(t){this.set("outlineColorRamp",t.colors)}.bind(this)),this.dap_outlineColorPicker.on("color-change",function(t){var e=t.color;!this.outlineColor&&e&&0===this.outlineWidth||null===this.outlineWidth?this._lineWidthTextBox.set("value",1):this.outlineColor&&!e&&this._lineWidthTextBox.set("value",0),this.set("outlineColor",e)}.bind(this)),this._symbolPicker.on("symbol-select",function(t){this._hideImageUrlInput(),this.set("shapeSymbol",t.selection)}.bind(this)),this.dap_shapeSizeTextBox.on("change",function(t){this.set("shapeSize",t)}.bind(this)),this.dap_fillColorPicker.on("color-change",function(t){this.set("fillColor",t.color)}.bind(this)),this.dap_outlineColorPicker.on("color-change",function(t){this.set("outlineColor",t.color)}.bind(this)),this._lineWidthTextBox.on("change",function(t){this.set("outlineWidth",t)}.bind(this))},_setUpComboBox:function(){var t=g.createSubclass([m]),e=[1,1.2,1.5,2,3,4,5,6,7,8,9,10],i=document.createDocumentFragment();e.forEach(function(t){i.appendChild(C.create("option",{innerHTML:y.format(t)}))}),this.dap_lineWidthTextBox.appendChild(i),this._lineWidthTextBox=new t({},this.dap_lineWidthTextBox)},_loadImage:function(t){this._clearUrlImageErrorDisplay(),d.testImageUrl(t).then(function(i){var o=this._customImageSymbol,l=this.shapeSize;i=d.preserveAspectRatio({dimensions:i,targetDimension:"width",targetSize:l}),o?(o.url=t,o.height=i.height,o.width=i.width):(o=new e(t,i.width,i.height),this._customImageSymbol=o),this._symbolPicker.addCustomImageSymbol(o),this.set("shapeSymbol",o)}.bind(this)).otherwise(function(){this.dap_shapeImageUrlErrorDisplay.innerHTML=P.imageLoadError}.bind(this))},_clearUrlImageErrorDisplay:function(){this.dap_shapeImageUrlErrorDisplay.innerHTML=""},_getActiveTabAttr:function(){var t=this.dap_stackContainer.selectedChildWidget;return t===this.dap_outlineContainer?"outline":t===this.dap_fillContainer?"fill":"shape"},_updateTabs:function(t){var e=d.getApplicableTabs(t,this._tabOptions.excluded),i=this.dap_stackContainer,o=0;Object.keys(e).forEach(function(t,l){var s=e[t],n=this._getTabContainer(t);"disabled"===s.state&&a.disable(n),"enabled"===s.state&&a.enable(n),"excluded"===s.state?n.domNode.parentNode&&i.removeChild(n):(n.domNode.parentNode||i.addChild(n,o),o++)},this);var l=1===i.getChildren().length;l?k(this.dap_stackController.domNode):I(this.dap_stackController.domNode),this._supportsPattern(t)?(I(this.dap_linePatternSelectLabel),I(this._linePatternSelect.domNode)):(k(this.dap_linePatternSelectLabel),k(this._linePatternSelect.domNode));var s=this._getTabContainer(this._activeTabName),n=this.dap_stackContainer.getIndexOfChild(s)>-1;n&&this.dap_stackContainer.selectChild(s),a.ensureEnabledChildSelection(this.dap_stackContainer)},_supportsPattern:function(t){return d.isLine(t,"2d")||d.isPolygon(t,"2d")},_syncControls:function(t){var e,i;this._hideImageUrlInput(),this._updateSizingConstraints();var o=d.getApplicableTabs(t,this._tabOptions.excluded);if("enabled"===o.shape.state&&(e=d.getMarkerLength(t),this.set("shapeSize",e),a.silentlyUpdateIntermediateChangingValueWidget(this.dap_shapeSizeSlider,e),a.silentlyUpdateIntermediateChangingValueWidget(this.dap_shapeSizeTextBox,e)),"enabled"===o.fill.state){var l=d.getFillColor(t);this.set("fillColor",l),this.dap_fillColorPicker.set("color",l,!1),(d.hasExtrudeSymbolLayer(t)||d.hasTextSymbolLayer(t))&&(e=d.getMarkerLength(t),this.set("shapeSize",e),a.silentlyUpdateIntermediateChangingValueWidget(this.dap_shapeSizeSlider,e),a.silentlyUpdateIntermediateChangingValueWidget(this.dap_shapeSizeTextBox,e))}"enabled"===o.outline.state&&(i=d.getOutline(t),i&&(this.set({outlineColor:i.color,outlineWidth:i.size,outlinePattern:i.style}),this.dap_outlineColorPicker.set("color",i.color,!1),a.silentlyUpdateIntermediateChangingValueWidget(this.dap_lineWidthSlider,i.size),a.silentlyUpdateIntermediateChangingValueWidget(this._lineWidthTextBox,i.size),this._linePatternSelect.set("value",i.style,!1)))},_updateSizingConstraints:function(){var t=this._editedSymbol,e=d.is3d(t),i=d.getOutlineUnit(t),o=d.getSizeUnit(t),l=d.getOutline(t),s=e?99999999:l&&l.size>this._defaultMaxLineWidthInPx?Math.ceil(l.size):this._defaultMaxLineWidthInPx,n=d.getMarkerLength(t),r=e?99999999:n>this._defaultMaxShapeSizeInPx?Math.ceil(n):this._defaultMaxShapeSizeInPx,h=e?"meters"===i?.001:0:this._defaultMinLineWidthInPx,p=e?"meters"===o?.001:1:this._defaultMinShapeSizeInPx;a.updateSliderAndTextBoxConstraints({textBox:this._lineWidthTextBox,slider:this.dap_lineWidthSlider,minimum:h,maximum:s}),this.dap_lineWidthUnitLabel.innerHTML="meters"===i?P.meters:P.px,a.updateSliderAndTextBoxConstraints({textBox:this.dap_shapeSizeTextBox,slider:this.dap_shapeSizeSlider,minimum:p,maximum:r}),this.dap_sizeUnitLabel.innerHTML="meters"===o?P.meters:P.px},_assimilateSymbol:function(t){this._updateTabs(t),this._syncControls(t)},_getSymbolPickerParams:function(){return{portal:this.portal,symbolSource:"2d"===this.mode?"symbol-set":"web-style"}},_hideImageUrlInput:function(){this._clearUrlImageErrorDisplay(),k(this.dap_shapeImageUrlContainer),this.dap_shapeImageUrlInput.set("value","")},_getFillColor:function(){var t=this._editedSymbol;return T(t)||d.isLine(t)||!this._colorRamp?this.fillColor:this._getMiddleItem(this.fillColorRamp)},_getMiddleItem:function(t){var e=Math.floor(.5*(t.length-1));return t[e]},_getOutlineColor:function(){return this._shouldShowOutlineColorRamp(this._editedSymbol)?this._getMiddleItem(this.outlineColorRamp):this.outlineColor},_commitProperties:function(){var t=this._editedSymbol,e=d.getApplicableTabs(t,this._tabOptions.excluded);"enabled"===e.shape.state&&d.updateShape({symbol:t,size:this.shapeSize}),"enabled"===e.fill.state&&(d.updateFill({symbol:t,color:this._getFillColor()}),(d.hasExtrudeSymbolLayer(t)||d.hasTextSymbolLayer(t))&&d.updateShape({symbol:t,size:this.shapeSize}),this._isPreppingEdit||d.ensureSupportedSimpleFillSymbolStyle(t)),"enabled"===e.outline.state&&d.updateOutline({symbol:t,color:this._getOutlineColor(),pattern:this.outlinePattern,size:this.outlineWidth}),this.previewVisible&&this._updatePreviewSymbol(),this._toggleOutlineOptions(),this._isPreppingEdit=!1,this.emit("style-update")},_toggleOutlineOptions:function(){var t=!!this._optimizationOptions&&this._optimizationCheckBox.checked,e=this.outlineColor,i=d.isLine(this._editedSymbol),o=this._externalSizing&&i||!e||t,l=t||!e,s=!e;this._toggleLabeledControls({labels:this.dap_lineWidthLabel,controls:[this._lineWidthTextBox,this.dap_lineWidthSlider],disabled:o}),this._toggleLabeledControls({labels:this.dap_linePatternSelectLabel,controls:this._linePatternSelect,disabled:s}),this._toggleLabeledControls({labels:[this.dap_outlineColorPicker.dap_transparencyLabel],controls:[this.dap_outlineColorPicker.dap_transparencySlider],disabled:l})},_updatePreviewSymbol:function(){var t=this._editedSymbol,e=this.dap_symbolPreview;if(this._symbolPreviewSurface)try{C.empty(this._symbolPreviewSurface)}catch(i){}d.hasTextSymbolLayer(t)||d.renderOnSurface(t,e).then(function(i){this._symbolPreviewSurface=i,b.toggle(e,v.alt,d.blendsIntoBackground(t))}.bind(this))},_updateSuggestedColors:function(t,e){t.set("suggestedColors",e)}});return z});