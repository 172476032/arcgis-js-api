// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["./Widgette","./RendererSlider","./RendererSlider/sliderUtils","../core/lang","../core/numberUtils","../renderers/support/utils","dijit/_TemplatedMixin","dojo/_base/array","dojo/_base/lang","dojo/dom-style","dojox/gfx","dojo/text!./ColorSlider/templates/ColorSlider.html"],function(t,i,s,e,a,l,o,r,h,n,u,m){var d=t.createSubclass([o],{_rampNode:null,_sliderHeight:null,_colorRampSurface:null,_histogramSurface:null,_surfaceRect:null,_barsGroup:null,_updateTimer:null,_transparentBackgroundNode:null,_css:null,_defaultHeight:200,_handles:[0,4],_primaryHandleIndex:null,declaredClass:"esri.widgets.ColorSlider",templateString:m,properties:{visualVariable:null,minValue:{dependsOn:["statistics"],get:function(){return this.get("statistics.min")||0},set:function(t){return void 0===t?this._clearOverride("minValue"):void this._override("minValue",t)}},maxValue:{dependsOn:["statistics"],get:function(){return this.get("statistics.max")||100},set:function(t){return void 0===t?this._clearOverride("maxValue"):void this._override("maxValue",t)}},histogram:null,statistics:null,zoomOptions:null,numHandles:{value:2,set:function(t){t=3===t?t:2,this._handles=3===t?[0,2,4]:[0,4],this._set("numHandles",t)}},syncedHandles:{value:!1,set:function(t){this._primaryHandleIndex=3===this.numHandles?2:null,this._set("syncedHandles",t)}},labelsVisible:!0,ticksVisible:!0,handlesVisible:!0,histogramVisible:!0,statisticsVisible:!0,transparentBackgroundEnabled:!1,ratioLabelsVisible:null,histogramWidth:100,rampWidth:26,isDate:!1,values:null},constructor:function(){this._css={container:"esri-color-info-slider",rampSurface:"esri-slider-ramp-surface"}},postCreate:function(){this.inherited(arguments),this._setUpDataDefaults()},startup:function(){this.inherited(arguments),this._slider=new i({type:"ColorSlider",values:this.values,isDate:this.isDate,minimum:this.zoomOptions?this.zoomOptions.minSliderValue:this.minValue,maximum:this.zoomOptions?this.zoomOptions.maxSliderValue:this.maxValue,_minZoomLabel:this.zoomOptions?this.minValue:null,_maxZoomLabel:this.zoomOptions?this.maxValue:null,_isZoomed:this.zoomOptions?!0:!1,labelsVisible:this.labelsVisible,ticksVisible:this.ticksVisible,handlesVisible:this.handlesVisible,ratioLabelsVisible:this.ratioLabelsVisible,handles:this._handles,primaryHandleIndex:this._primaryHandleIndex},this._sliderNode),this._slider.startup(),this._rampNode=this._slider._sliderAreaRight,this._sliderHeight=n.get(this._rampNode,"height")||this._defaultHeight,this._valuesAutoAdjust(),this._createSVGSurfaces(),this._slider.on("slide",h.hitch(this,function(){this._valuesAutoAdjust(),this._fillRamp()})),this._slider.on("data-change",h.hitch(this,function(t){this.values=t.values,this._valuesAutoAdjust(),this._updateVisualVariable(this._slider.values),this._fillRamp(),this.emit("data-change",{})})),this._slider.on("handle-value-change",h.hitch(this,function(t){this.values=t.values,this._valuesAutoAdjust(),this._updateVisualVariable(this._slider.values),this._fillRamp(),this._updateRendererSlider(),this.emit("handle-value-change",{})})),this._slider.on("data-value-change",h.hitch(this,function(t){this.set({minValue:t.min,maxValue:t.max}),this._updateRendererSlider(),this.emit("data-value-change",{})})),this._slider.on("stop",h.hitch(this,function(){this.emit("handle-value-change",{})})),this._slider.on("zoom-out",h.hitch(this,function(){this.zoomOptions=null})),this.statistics&&this.statisticsVisible&&this._generateStatistics(),this.histogramVisible&&(this.histogram||this.zoomOptions&&this.zoomOptions.histogram)&&this._generateHistogram(),this.watch("visualVariable, numHandles, statistics, histogram, zoomOptions, handlesVisible, labelsVisible, ticksVisible, ratioLabelsVisible",this._updateTimeout),this.watch("zoomOptions",this._zoomEventHandler),this.watch("histogramVisible",this._toggleHistogram),this.watch("transparentBackgroundEnabled",this._toggleTransparentBackground)},destroy:function(){this._slider&&this._slider.destroy(),this._avgHandleObjs&&this._avgHandleObjs.avgHandleTooltip&&this._avgHandleObjs.avgHandleTooltip.destroy(),this.countTooltips&&r.forEach(this.countTooltips,function(t){t.destroy()})},refresh:function(){this._updateTimeout()},_updateTimeout:function(){this._updateRendererSlider()},_updateRendererSlider:function(){var t=this.get("ratioLabelsVisible");"percent"!==t&&"percentTotal"!==t&&(this.ratioLabelsVisible=null),null!==this.zoomOptions&&this.zoomOptions!==!1?(this.toggleSliderBottom=this.zoomOptions.minSliderValue>this.minValue,this.toggleSliderTop=this.zoomOptions.maxSliderValue<this.maxValue,this._slider.set({minimum:this.zoomOptions.minSliderValue,maximum:this.zoomOptions.maxSliderValue,ratioLabelsVisible:this.ratioLabelsVisible,_minZoomLabel:this.minValue,_maxZoomLabel:this.maxValue,_isZoomed:!0})):this._slider.set({minimum:this.minValue,maximum:this.maxValue,ratioLabelsVisible:this.ratioLabelsVisible,_minZoomLabel:null,_maxZoomLabel:null,_isZoomed:!1}),this.values=this._generateHandleValues(e.clone(this.visualVariable.stops)),this._slider.set({values:this.values,handles:this._handles,primaryHandleIndex:this._primaryHandleIndex}),this._slider._reset(),this._slider._updateRoundedLabels(),this._slider._generateMoveables(),this._clearRect(),this._createSVGSurfaces(),this.statistics&&this.statisticsVisible&&this._generateStatistics(),this.histogramVisible&&(this.histogram||this.zoomOptions&&this.zoomOptions.histogram)&&this._generateHistogram()},_generateHandleValues:function(t){return r.forEach(t,h.hitch(this,function(t,i){(1===i||3===i)&&(t.hidden=!0),2===i&&2===this.numHandles&&(t.hidden=!0)})),t.slice()},_valuesAutoAdjust:function(){var t,i,s,e,a,l,o,h=this._slider.values,n=[];for(r.some(h,function(t,i){t.hidden||n.push(i)}),l=0;l<n.length-1;l++)for(t=n[l],i=n[l+1],s=i-t,e=h[t].value,a=h[i].value,o=t+1;i>o;o++)h[o].value=e*(i-o)/s+a*(o-t)/s},_zoomEventHandler:function(){this.emit("zoom",{zoomed:!!this.zoomOptions})},_setUpDataDefaults:function(){var t=this.visualVariable.stops;null!==this.zoomOptions&&(this.toggleSliderBottom=this.zoomOptions.minSliderValue>this.minValue,this.toggleSliderTop=this.zoomOptions.maxSliderValue<this.maxValue),t[0].value===t[t.length-1].value&&0!==t[0].value&&(this.set({minValue:0,maxValue:2*t[0].value}),t[0].value=this.maxValue/5,t[t.length-1].value=this.maxValue/5*4),this.minValue===this.maxValue&&(0===this.minValue?this.maxValue=100:null===this.minValue?this.set({minValue:0,maxValue:100}):this.set({minValue:0,maxValue:2*this.minValue})),this.values=this._generateHandleValues(e.clone(t))},_createSVGSurfaces:function(){this._colorRampSurface=u.createSurface(this._rampNode,this.rampWidth-2,this._sliderHeight),this._colorRampSurface.rawNode.setAttribute("class",this._css.rampSurface),this._surfaceRect=this._colorRampSurface.createRect({width:this.rampWidth,height:this._sliderHeight}),this._transparentBackgroundNode=s.generateTransparentBackground(this._colorRampSurface,this.rampWidth-2,this._sliderHeight-2,this.transparentBackgroundEnabled),this._histogramSurface=s.generateHistogramSurface(this._rampNode,this.histogramWidth,this._sliderHeight,this.rampWidth),this._fillRamp(),null!==this.zoomOptions&&(this.toggleSliderBottom&&this.toggleSliderTop?(this._colorRampSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke({color:"#fff",width:3}).setTransform(u.matrix.translate(0,5)),this._colorRampSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke({color:"#fff",width:3}).setTransform(u.matrix.translate(0,195))):this.toggleSliderBottom?this._colorRampSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke({color:"#fff",width:3}).setTransform(u.matrix.translate(0,195)):this.toggleSliderTop&&this._colorRampSurface.createPath("M0,1 L6.25,-1 L12.5,1 L18.75,-1 L25,1").setStroke({color:"#fff",width:3}).setTransform(u.matrix.translate(0,5)))},_fillRamp:function(){var t=this._getGradientColorStops();null!==this.zoomOptions?this.toggleSliderBottom&&this.toggleSliderTop?this._surfaceRect.setFill({type:"linear",x1:0,y1:10,x2:0,y2:this._sliderHeight-10,colors:t}):this.toggleSliderBottom?this._surfaceRect.setFill({type:"linear",x1:0,y1:0,x2:0,y2:this._sliderHeight-20,colors:t}):this.toggleSliderTop&&this._surfaceRect.setFill({type:"linear",x1:0,y1:20,x2:0,y2:this._sliderHeight,colors:t}):this._surfaceRect.setFill({type:"linear",x1:0,y1:0,x2:0,y2:this._sliderHeight,colors:t})},_getGradientColorStops:function(){var t=this._slider.values,i=this._slider.minimum,s=this._slider.maximum;return t.slice().map(function(t){return{color:t.color,offset:(s-t.value)/(s-i)}}).reverse()},_clearRect:function(){this._colorRampSurface.destroy(),this._histogramSurface.destroy()},_toggleTransparentBackground:function(){this.transparentBackgroundEnabled?this._transparentBackgroundNode.setFill(s.getTransparentFill()):this._transparentBackgroundNode.setFill(null)},_updateVisualVariable:function(t){var i=this.visualVariable.stops;t&&i&&t.length===i.length&&(r.forEach(i,function(i,s){i.value=t[s].value,t[s].index=s}),l.updateColorStops({stops:i,changes:t,isDate:this.isDate}))},_showHistogram:function(){this.histogram||this.zoomOptions&&this.zoomOptions.histogram?this._generateHistogram():this._barsGroup&&(this._barsGroup.destroy(),this._barsGroup=null)},_toggleHistogram:function(){this.histogramVisible?(n.set(this._barsGroup.rawNode,"display","inline-block"),this._showHistogram()):n.set(this._barsGroup.rawNode,"display","none")},_generateHistogram:function(){var t=this.zoomOptions&&this.zoomOptions.histogram?this.zoomOptions.histogram:this.histogram;this._barsGroup=s.generateHistogram(this._histogramSurface,t,this.histogramWidth,this.rampWidth,this.isLeftToRight()),this.countTooltips=s.generateCountTooltips(t,this._barsGroup)},_generateStatistics:function(){if(!(this.statistics.count<2||isNaN(this.statistics.avg)||isNaN(this.maxValue))){var t,i,e,l,o=this.statistics,r=this._slider,h=this.zoomOptions||null,n=s.getPrecision(this.maxValue);o.min===o.max&&o.min===o.avg?(t=0,i=2*o.avg):(t=o.min,i=o.max),(t!==r.minimum||i!==r.maximum)&&(t=r.minimum,i=r.maximum),h&&(t=h.minSliderValue,i=h.maxSliderValue),e=this._sliderHeight*(i-o.avg)/(i-t),l=this.get("ratioLabelsVisible")?a.round([this._slider._getRatioFromValue(o.avg),t,i])[0]:a.round([o.avg,i,t])[0],this._avgHandleObjs=s.generateAvgLine(this._histogramSurface,l,e,n,this.isLeftToRight(),this.isDate,this.get("ratioLabelsVisible"))}}});return d});