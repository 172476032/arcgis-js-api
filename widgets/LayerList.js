// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/i18n!../nls/common","dojo/i18n!./LayerList/nls/LayerList","../core/Handles","../core/watchUtils","../core/accessorSupport/decorators","./Widget","./LayerList/LayerListViewModel","./support/widget"],function(e,i,t,n,r,s,l,o,a,c,d,p){function u(e){var i=e.actionsOpen,t=e.children;i&&(e.actionsOpen=!1),t.forEach(function(e){return u(e)})}var g={base:"esri-layer-list esri-widget esri-widget--panel",noItems:"esri-layer-list__no-items",list:"esri-layer-list__list",listRoot:"esri-layer-list__list--root",listExclusive:"esri-layer-list__list--exclusive",listInherited:"esri-layer-list__list--inherited",listIndependent:"esri-layer-list__list--independent",item:"esri-layer-list__item",itemContent:"esri-layer-list__item-content",itemError:"esri-layer-list__item--error",itemInvisibleAtScale:"esri-layer-list__item--invisible-at-scale",itemUpdating:"esri-layer-list__item--updating",itemChildren:"esri-layer-list__item--has-children",itemContainer:"esri-layer-list__item-container",actionsMenu:"esri-layer-list__item-actions-menu",actionsMenuItem:"esri-layer-list__item-actions-menu-item",actionsMenuItemActive:"esri-layer-list__item-actions-menu-item--active",actions:"esri-layer-list__item-actions",actionsList:"esri-layer-list__item-actions-list",action:"esri-layer-list__item-action",actionIcon:"esri-layer-list__item-action-icon",actionImage:"esri-layer-list__item-action-image",actionTitle:"esri-layer-list__item-action-title",label:"esri-layer-list__item-label",errorMessage:"esri-layer-list__item-error-message",title:"esri-layer-list__item-title",toggleVisible:"esri-layer-list__item-toggle",toggleVisibleIcon:"esri-layer-list__item-toggle-icon",childToggle:"esri-layer-list__child-toggle",childToggleOpen:"esri-layer-list__child-toggle--open",childOpened:"esri-layer-list__child-toggle-icon--opened",childClosed:"esri-layer-list__child-toggle-icon--closed",childClosed_RTL:"esri-layer-list__child-toggle-icon--closed-rtl",disabled:"esri-disabled",hidden:"esri-hidden",iconEllipses:"esri-icon-handle-horizontal",iconVisible:"esri-icon-visible",iconInvisible:"esri-icon-non-visible",iconRadioSelected:"esri-icon-radio-checked",iconRadioUnselected:"esri-icon-radio-unchecked",iconNoticeTriangle:"esri-icon-notice-triangle",iconChildrenOpen:"esri-icon-down-arrow",iconDownArrow:"esri-icon-down-arrow",iconRightArrow:"esri-icon-right-triangle-arrow",iconLeftArrow:"esri-icon-left-triangle-arrow",widgetIcon:"esri-icon-layers"},h={actions:"actions",actionSection:"action-section",items:"items"},_={exclusive:"exclusive",inherited:"inherited",independent:"independent"},y=e.toUrl("./LayerList/images/default-action.svg");return function(e){function i(){var i=e.call(this)||this;return i._handles=new l,i.iconClass=g.widgetIcon,i.statusIndicatorsVisible=!0,i.label=s.widgetLabel,i.listItemCreatedFunction=null,i.operationalItems=null,i.view=null,i.viewModel=new d,i}return t(i,e),i.prototype.postInitialize=function(){var e=this,i=this.operationalItems;this.own(o.on(this,"operationalItems","change",function(){return e._itemsChanged(i)}))},i.prototype.destroy=function(){this._handles.destroy(),this._handles=null},i.prototype.triggerAction=function(e,i){},i.prototype.render=function(){var e=this,i=this._getItems(),t=this.get("viewModel.state"),n=0===i.length?p.tsx("div",{class:g.noItems},s.noItemsToDisplay):p.tsx("ul",{class:p.join(g.list,g.listRoot,g.listIndependent)},i.map(function(i,t){return e._renderItem(i,null)})),r=(l={},l[g.hidden]="loading"===t,l[g.disabled]="disabled"===t,l);return p.tsx("div",{class:g.base,classes:r},n);var l},i.prototype._getItems=function(){var e=this;return this.operationalItems.toArray().filter(function(i){return e.errorsVisible||!i.error})},i.prototype._renderItem=function(e,i){var t=this,n=this.id,l=n+"_"+e.uid,o=l+"_actions",a=l+"__list",c=l+"__title",d=e.children.length,u=!!d,h=!!e.error,y=h?s.layerError:"",m=e.visibilityMode,v=e.children&&e.children.toArray(),b=_.exclusive,f=_.inherited,I=(P={},P[g.listExclusive]=m===b,P[g.listInherited]=m===f,P[g.listIndependent]=m!==f&&m!==b,P),x=(U={},U[g.itemChildren]=u,U[g.itemError]=!!y,U[g.itemUpdating]=e.updating&&!i&&this.statusIndicatorsVisible,U[g.itemInvisibleAtScale]=!e.visibleAtCurrentScale,U),A=this._countActions(e.actionsSections),w=e.panel,C=w&&w.open?w.render():null,k=w&&w.visible?this._renderPanelButton(w):null,O=(D={},D[g.actionsMenuItemActive]=e.actionsOpen,D),S=e.actionsOpen?r.close:r.open,L=A?p.tsx("div",{key:"esri-layer-list__actions-menu-toggle","data-item":e,bind:this,onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,class:g.actionsMenuItem,classes:O,tabindex:"0",role:"button","aria-controls":o,"aria-label":S,title:S},p.tsx("span",{"aria-hidden":"true",class:g.iconEllipses})):null,M=A||k?p.tsx("div",{key:"esri-layer-list__actions-menu",class:g.actionsMenu},k,L):null,R=A?this._renderActionsSections(e,e.actionsSections,o):null,T=u?p.tsx("ul",{key:"esri-layer-list__list-items",id:a,class:g.list,classes:I,"aria-expanded":e.open?"true":"false",role:m===b?"radiogroup":"group",hidden:!e.open||null},v.map(function(i,n){return t._renderItem(i,e)})):null,E=(F={},F[g.childToggleOpen]=e.open,F),V=e.open?r.collapse:r.expand,N=u?p.tsx("span",{onclick:this._toggleChildrenClick,onkeydown:this._toggleChildrenClick,"data-item":e,key:"esri-layer-list__toggle-children",class:g.childToggle,classes:E,tabindex:"0",role:"button","aria-controls":a,"aria-label":V,title:V},p.tsx("span",{"aria-hidden":"true",class:p.join(g.childClosed,g.iconRightArrow)}),p.tsx("span",{"aria-hidden":"true",class:p.join(g.childOpened,g.iconDownArrow)}),p.tsx("span",{"aria-hidden":"true",class:p.join(g.childClosed_RTL,g.iconLeftArrow)})):null,H=this._createLabelNode(e,i,c),j=h?p.tsx("div",{key:"esri-layer-list__error",class:g.errorMessage,role:"alert"},p.tsx("span",{"aria-hidden":"true",class:g.iconNoticeTriangle}),p.tsx("span",null,y)):null;return p.tsx("li",{key:e,class:g.item,classes:x,"aria-labelledby":c},p.tsx("div",{key:"esri-layer-list__list-item-container",class:g.itemContainer},N,H,M),j,R,C,T);var P,U,D,F},i.prototype._createLabelNode=function(e,i,t){var n=_.exclusive,r=_.inherited,l=i&&i.visibilityMode,o=(h={},h[g.iconRadioSelected]=l===n&&e.visible,h[g.iconRadioUnselected]=l===n&&!e.visible,h[g.iconVisible]=l!==n&&e.visible,h[g.iconInvisible]=l!==n&&!e.visible,h),a=l===n?"radio":"checkbox",c=e.title||s.untitledLayer,d=e.visibleAtCurrentScale?c:c+" ("+s.layerInvisibleAtScale+")",u=p.tsx("span",{id:t,title:d,"aria-label":d,class:g.title},c);return l===r?p.tsx("div",{key:e,class:g.label},u):p.tsx("div",{key:e,onclick:this._labelClick,onkeydown:this._labelClick,"data-item":e,"data-parent-visibility":l,tabindex:"0","aria-checked":e.visible?"true":"false",role:a,"aria-labelledby":t,class:g.label},p.tsx("span",{class:g.toggleVisible},p.tsx("span",{class:g.toggleVisibleIcon,"aria-hidden":"true",classes:o})),u);var h},i.prototype._renderPanelButton=function(e){var i=e.className,t=e.open,n=e.title,r=this._getIconImageStyles(e),s=(o={},o[g.actionsMenuItemActive]=t,o),l=(a={},a[i]=!!i,a[g.actionImage]=!!r["background-image"],a);return p.tsx("div",{key:e,bind:this,"data-panel":e,onclick:this._triggerPanel,onkeydown:this._triggerPanel,class:g.actionsMenuItem,classes:s,role:"button",tabindex:"0",title:n,"aria-label":n},p.tsx("span",{classes:l,styles:r}));var o,a},i.prototype._watchActionSectionChanges=function(e,i){var t=this,n=h.actionSection+i;this._handles.add(e.on("change",this.scheduleRender.bind(this)),n),e.forEach(function(e){return t._renderOnActionChanges(e,i)})},i.prototype._renderOnActionChanges=function(e,i){var t=this,n=h.actions+i;this._handles.add([o.init(e,"className, image, id, title, visible",function(){return t.scheduleRender()})],n)},i.prototype._renderOnItemChanges=function(e){var i=this,t=e.uid,n=h.items+t;this._handles.add([o.init(e,["actionsOpen","visible","open","updating","title","visibleAtCurrentScale","error","visibilityMode","panel","panel.title","panel.content","panel.className"],function(){return i.scheduleRender()}),e.actionsSections.on("change",function(){return i.scheduleRender()}),e.children.on("change",function(){return i.scheduleRender()})],n),e.children.forEach(function(e){return i._renderOnItemChanges(e)}),e.actionsSections.forEach(function(e){return i._watchActionSectionChanges(e,t)})},i.prototype._itemsChanged=function(e){var i=this;this._handles.removeAll(),e.forEach(function(e){return i._renderOnItemChanges(e)}),this.scheduleRender()},i.prototype._renderActionsSections=function(e,i,t){var n=this,r=i.toArray(),s=r.map(function(i){return p.tsx("ul",{key:i,class:g.actionsList},n._renderActionSection(e,i))});return p.tsx("div",{role:"group","aria-expanded":e.actionsOpen?"true":"false",key:"esri-layer-list__actions-section",id:t,class:g.actions,hidden:!e.actionsOpen||null},s)},i.prototype._renderActionSection=function(e,i){var t=this;return(i&&i.toArray()).map(function(i){return t._renderAction(e,i)})},i.prototype._renderAction=function(e,i){var t=this._getIconImageStyles(i),n=(r={},r[i.className]=!!i.className,r[g.actionImage]=!!t["background-image"],r);return p.tsx("li",{bind:this,"data-item":e,"data-action":i,key:i,onclick:this._triggerAction,onkeydown:this._triggerAction,class:g.action,tabindex:"0",role:"button",title:i.title,"aria-label":i.title},p.tsx("span",{"aria-hidden":"true",class:g.actionIcon,classes:n,styles:t}),p.tsx("span",{class:g.actionTitle},i.title));var r},i.prototype._countActions=function(e){return e.reduce(function(e,i){return e+i.length},0)},i.prototype._getIconImageStyles=function(e){var i=e.image||null;return e.className||i||(i=y),{"background-image":i?'url("'+i+'")':null}},i.prototype._toggleActionsOpen=function(e){var i=e.currentTarget,t=i["data-item"],n=t.actionsOpen,r=!n;r&&this.operationalItems.forEach(function(e){return u(e)}),t.actionsOpen=r},i.prototype._triggerPanel=function(e){var i=e.currentTarget,t=i["data-panel"];t&&(t.open=!t.open)},i.prototype._triggerAction=function(e){var i=e.currentTarget,t=i["data-action"],n=i["data-item"];this.triggerAction(t,n)},i.prototype._labelClick=function(e){var i=e.currentTarget,t=i.getAttribute("data-parent-visibility"),n=i["data-item"];t===_.exclusive&&n.visible||(n.visible=!n.visible)},i.prototype._toggleChildrenClick=function(e){var i=e.currentTarget,t=i["data-item"];t.open=!t.open},n([a.property()],i.prototype,"iconClass",void 0),n([a.property(),p.renderable()],i.prototype,"statusIndicatorsVisible",void 0),n([a.property(),p.renderable()],i.prototype,"errorsVisible",void 0),n([a.property()],i.prototype,"label",void 0),n([a.aliasOf("viewModel.listItemCreatedFunction"),p.renderable()],i.prototype,"listItemCreatedFunction",void 0),n([a.aliasOf("viewModel.operationalItems"),p.renderable()],i.prototype,"operationalItems",void 0),n([a.aliasOf("viewModel.view"),p.renderable()],i.prototype,"view",void 0),n([p.vmEvent("trigger-action"),a.property({type:d}),p.renderable("viewModel.state")],i.prototype,"viewModel",void 0),n([a.aliasOf("viewModel.triggerAction")],i.prototype,"triggerAction",null),n([p.accessibleHandler()],i.prototype,"_toggleActionsOpen",null),n([p.accessibleHandler()],i.prototype,"_triggerPanel",null),n([p.accessibleHandler()],i.prototype,"_triggerAction",null),n([p.accessibleHandler()],i.prototype,"_labelClick",null),n([p.accessibleHandler()],i.prototype,"_toggleChildrenClick",null),i=n([a.subclass("esri.widgets.LayerList")],i)}(a.declared(c))});