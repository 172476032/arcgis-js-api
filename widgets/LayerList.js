// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/accessorSupport/decorators","./Widget","./support/widget","dojo/i18n!../nls/common","dojo/i18n!./LayerList/nls/LayerList","../core/HandleRegistry","./LayerList/LayerListViewModel","../core/watchUtils"],function(e,i,t,n,r,s,l,o,a,c,d,u){var p={base:"esri-layer-list esri-widget esri-widget--panel",noItems:"esri-layer-list__no-items",list:"esri-layer-list__list",listRoot:"esri-layer-list__list--root",listExclusive:"esri-layer-list__list--exclusive",listInherited:"esri-layer-list__list--inherited",listIndependent:"esri-layer-list__list--independent",item:"esri-layer-list__item",itemError:"esri-layer-list__item--error",itemInvisibleAtScale:"esri-layer-list__item--invisible-at-scale",itemUpdating:"esri-layer-list__item--updating",itemChildren:"esri-layer-list__item--has-children",itemContainer:"esri-layer-list__item-container",actionsMenu:"esri-layer-list__item-actions-menu",actionsMenuItem:"esri-layer-list__item-actions-menu-item",actions:"esri-layer-list__item-actions",actionsList:"esri-layer-list__item-actions-list",action:"esri-layer-list__item-action",actionIcon:"esri-layer-list__item-action-icon",actionImage:"esri-layer-list__item-action-image",actionTitle:"esri-layer-list__item-action-title",label:"esri-layer-list__item-label",errorMessage:"esri-layer-list__item-error-message",title:"esri-layer-list__item-title",toggleVisible:"esri-layer-list__item-toggle",toggleVisibleIcon:"esri-layer-list__item-toggle-icon",childToggle:"esri-layer-list__child-toggle",childToggleOpen:"esri-layer-list__child-toggle--open",childOpened:"esri-layer-list__child-toggle-icon--opened",childClosed:"esri-layer-list__child-toggle-icon--closed",childClosed_RTL:"esri-layer-list__child-toggle-icon--closed-rtl",disabled:"esri-disabled",hidden:"esri-hidden",iconClose:"esri-icon-close",iconEllipses:"esri-icon-handle-horizontal",iconVisible:"esri-icon-visible",iconInvisible:"esri-icon-non-visible",iconRadioSelected:"esri-icon-radio-checked",iconRadioUnselected:"esri-icon-radio-unchecked",iconNoticeTriangle:"esri-icon-notice-triangle",iconChildrenOpen:"esri-icon-down-arrow",iconDownArrow:"esri-icon-down-arrow",iconRightArrow:"esri-icon-right-triangle-arrow",iconLeftArrow:"esri-icon-left-triangle-arrow"},g={actions:"actions",actionSection:"action-section",items:"items"},h={exclusive:"exclusive",inherited:"inherited",independent:"independent"},_=e.toUrl("./LayerList/images/default-action.svg"),y=function(e){function i(){var i=e.call(this)||this;return i._handleRegistry=new c,i.createActionsFunction=null,i.statusIndicatorsVisible=!0,i.listItemCreatedFunction=null,i.operationalItems=null,i.view=null,i.viewModel=new d,i}return t(i,e),i.prototype.postInitialize=function(){var e=this,i=this.operationalItems;this.own(u.on(this,"operationalItems","change",function(){return e._itemsChanged(i)}))},i.prototype.destroy=function(){this._handleRegistry.destroy(),this._handleRegistry=null},i.prototype.triggerAction=function(e,i){},i.prototype.render=function(){var e=this,i=this._getItems(),t=this.get("viewModel.state"),n=0===i.length?l.tsx("div",{"class":p.noItems},a.noItemsToDisplay):l.tsx("ul",{"class":l.join(p.list,p.listRoot,p.listIndependent)},i.map(function(i,t){return e._renderItem(i,null)})),r=(s={},s[p.hidden]="loading"===t,s[p.disabled]="disabled"===t,s);return l.tsx("div",{"class":p.base,classes:r},n);var s},i.prototype._getItems=function(){var e=this;return this.operationalItems.toArray().filter(function(i){return e.errorsVisible||!i.error})},i.prototype._renderItem=function(e,i){var t=this,n=this.id,r=n+"_"+e.uid,s=r+"_actions",c=r+"__list",d=r+"__title",u=e.children.length,g=!!u,_=!!e.error,y=_?a.layerError:"",m=e.visibilityMode,v=e.children&&e.children.toArray(),b=h.exclusive,f=h.inherited,A=(H={},H[p.listExclusive]=m===b,H[p.listInherited]=m===f,H[p.listIndependent]=m!==f&&m!==b,H),I=(j={},j[p.itemChildren]=g,j[p.itemError]=!!y,j[p.itemUpdating]=e.updating&&!i&&this.statusIndicatorsVisible,j[p.itemInvisibleAtScale]=!e.visibleAtCurrentScale,j),x=this._countActions(e.actionsSections),w=x?this._renderActionMenuItem(e,e.actionsSections):null,k=(F={},F[p.iconEllipses]=!e.actionsOpen,F[p.iconClose]=e.actionsOpen,F),C=e.actionsOpen?o.close:o.open,O=x>1?l.tsx("div",{key:"esri-layer-list__actions-menu-toggle","data-item":e,onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,"class":p.actionsMenuItem,tabindex:"0",role:"button","aria-controls":s,"aria-label":C,title:C},l.tsx("span",{"aria-hidden":"true",classes:k})):null,S=x?l.tsx("div",{key:"esri-layer-list__actions-menu","class":p.actionsMenu},w,O):null,R=x>1?this._renderActionsSections(e,e.actionsSections,s):null,M=g?l.tsx("ul",{key:"esri-layer-list__list-items",id:c,"class":p.list,classes:A,"aria-expanded":e.open?"true":"false",role:m===b?"radiogroup":"group",hidden:e.open?null:!0},v.map(function(i,n){return t._renderItem(i,e)})):null,L=(U={},U[p.childToggleOpen]=e.open,U),T=e.open?o.collapse:o.expand,E=g?l.tsx("span",{onclick:this._toggleChildrenClick,onkeydown:this._toggleChildrenClick,"data-item":e,key:"esri-layer-list__toggle-children","class":p.childToggle,classes:L,tabindex:"0",role:"button","aria-controls":c,"aria-label":T,title:T},l.tsx("span",{"aria-hidden":"true","class":l.join(p.childClosed,p.iconRightArrow)}),l.tsx("span",{"aria-hidden":"true","class":l.join(p.childOpened,p.iconDownArrow)}),l.tsx("span",{"aria-hidden":"true","class":l.join(p.childClosed_RTL,p.iconLeftArrow)})):null,V=this._createLabelNode(e,i,d),N=_?l.tsx("div",{key:"esri-layer-list__error","class":p.errorMessage,role:"alert"},l.tsx("span",{"aria-hidden":"true","class":p.iconNoticeTriangle}),l.tsx("span",null,y)):null;return l.tsx("li",{key:e,"class":p.item,classes:I,"aria-labelledby":d},l.tsx("div",{key:"esri-layer-list__list-item-container","class":p.itemContainer},E,V,S),N,R,M);var H,j,F,U},i.prototype._createLabelNode=function(e,i,t){var n=h.exclusive,r=h.inherited,s=i&&i.visibilityMode,o=(_={},_[p.iconRadioSelected]=s===n&&e.visible,_[p.iconRadioUnselected]=s===n&&!e.visible,_[p.iconVisible]=s!==n&&e.visible,_[p.iconInvisible]=s!==n&&!e.visible,_),c=s===n?"radio":"checkbox",d=e.title||a.untitledLayer,u=e.visibleAtCurrentScale?d:d+" ("+a.layerInvisibleAtScale+")",g=l.tsx("span",{id:t,title:u,"aria-label":u,"class":p.title},d);return s===r?l.tsx("div",{key:e,"class":p.label},g):l.tsx("div",{key:e,onclick:this._labelClick,onkeydown:this._labelClick,"data-item":e,"data-parent-visibility":s,tabindex:"0","aria-checked":e.visible?"true":"false",role:c,"aria-labelledby":t,"class":p.label},l.tsx("span",{"class":p.toggleVisible},l.tsx("span",{"class":p.toggleVisibleIcon,"aria-hidden":"true",classes:o})),g);var _},i.prototype._renderActionMenuItem=function(e,i){var t=i.getItemAt(0),n=t&&t.getItemAt(0);if(n){var r=this._getActionImageStyles(n),s=(a={},a[n.className]=!!n.className,a[p.actionImage]=!!r["background-image"],a),o=n.title;return l.tsx("div",{key:e,bind:this,"data-item":e,"data-action":n,onclick:this._triggerAction,onkeydown:this._triggerAction,"class":p.actionsMenuItem,role:"button",tabindex:"0",title:o,"aria-label":o},l.tsx("span",{classes:s,styles:r}))}var a},i.prototype._watchActionSectionChanges=function(e,i){var t=this,n=g.actionSection+i;this._handleRegistry.add(e.on("change",this.scheduleRender.bind(this)),n),e.forEach(function(e){return t._renderOnActionChanges(e,i)})},i.prototype._renderOnActionChanges=function(e,i){var t=this,n=g.actions+i;this._handleRegistry.add([u.init(e,"className, image, id, title, visible",function(){return t.scheduleRender()})],n)},i.prototype._renderOnItemChanges=function(e){var i=this,t=e.uid,n=g.items+t;this._handleRegistry.add([u.init(e,"actionsOpen, visible, open, updating, title, visibleAtCurrentScale, error, visibilityMode",function(){return i.scheduleRender()}),e.actionsSections.on("change",function(){return i.scheduleRender()}),e.children.on("change",function(){return i.scheduleRender()})],n),e.children.forEach(function(e){return i._renderOnItemChanges(e)}),e.actionsSections.forEach(function(e){return i._watchActionSectionChanges(e,t)})},i.prototype._itemsChanged=function(e){var i=this;this._handleRegistry.removeAll(),e.forEach(function(e){return i._renderOnItemChanges(e)}),this.scheduleRender()},i.prototype._renderActionsSections=function(e,i,t){var n=this,r=i.toArray(),s=r.map(function(i){return l.tsx("ul",{key:i,"class":p.actionsList},n._renderActionSection(e,i))});return l.tsx("div",{role:"group","aria-expanded":e.actionsOpen?"true":"false",key:"esri-layer-list__actions-section",id:t,"class":p.actions,hidden:e.actionsOpen?null:!0},s)},i.prototype._renderActionSection=function(e,i){var t=this,n=i&&i.toArray();return n.map(function(i){return t._renderAction(e,i)})},i.prototype._renderAction=function(e,i){var t=this._getActionImageStyles(i),n=(r={},r[i.className]=!!i.className,r[p.actionImage]=!!t["background-image"],r);return l.tsx("li",{bind:this,"data-item":e,"data-action":i,key:i,onclick:this._triggerAction,onkeydown:this._triggerAction,"class":p.action,tabindex:"0",role:"button",title:i.title,"aria-label":i.title},l.tsx("span",{"aria-hidden":"true","class":p.actionIcon,classes:n,styles:t}),l.tsx("span",{"class":p.actionTitle},i.title));var r},i.prototype._countActions=function(e){return e.reduce(function(e,i){return e+i.length},0)},i.prototype._getActionImageStyles=function(e){var i=e.image||null;return e.className||i||(i=_),{"background-image":i?'url("'+i+'")':null}},i.prototype._toggleActionsOpen=function(e){var i=e.currentTarget,t=i["data-item"];t.actionsOpen=!t.actionsOpen},i.prototype._triggerAction=function(e){var i=e.currentTarget,t=i["data-action"],n=i["data-item"];this.triggerAction(t,n)},i.prototype._labelClick=function(e){var i=e.currentTarget,t=i.getAttribute("data-parent-visibility"),n=i["data-item"];t===h.exclusive&&n.visible||(n.visible=!n.visible)},i.prototype._toggleChildrenClick=function(e){var i=e.currentTarget,t=i["data-item"];t.open=!t.open},n([r.aliasOf("viewModel.createActionsFunction"),l.renderable()],i.prototype,"createActionsFunction",void 0),n([r.property(),l.renderable()],i.prototype,"statusIndicatorsVisible",void 0),n([r.property(),l.renderable()],i.prototype,"errorsVisible",void 0),n([r.aliasOf("viewModel.listItemCreatedFunction"),l.renderable()],i.prototype,"listItemCreatedFunction",void 0),n([r.aliasOf("viewModel.operationalItems"),l.renderable()],i.prototype,"operationalItems",void 0),n([r.aliasOf("viewModel.view"),l.renderable()],i.prototype,"view",void 0),n([l.vmEvent("trigger-action"),r.property({type:d}),l.renderable("viewModel.state")],i.prototype,"viewModel",void 0),n([r.aliasOf("viewModel.triggerAction")],i.prototype,"triggerAction",null),n([l.accessibleHandler()],i.prototype,"_toggleActionsOpen",null),n([l.accessibleHandler()],i.prototype,"_triggerAction",null),n([l.accessibleHandler()],i.prototype,"_labelClick",null),n([l.accessibleHandler()],i.prototype,"_toggleChildrenClick",null),i=n([r.subclass("esri.widgets.LayerList")],i)}(r.declared(s));return y});