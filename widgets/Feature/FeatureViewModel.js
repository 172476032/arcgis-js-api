// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/assignHelper","dojo/i18n!dojo/cldr/nls/number","../../Graphic","../../core/date","../../core/Error","../../core/Handles","../../core/lang","../../core/Logger","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../support/arcadeUtils","./support/featureUtils","./support/RelatedFeatures","../support/widget"],function(e,t,r,i,o,n,a,s,l,p,u,c,f,d,h,m,y,g,_){function v(e,t){var r=t[e];if("string"==typeof r){var i=/\'/g,o=encodeURIComponent(r).replace(i,"&apos;");t[e]=o}}function F(e,t){return e&&"feature"===e.type?e.getField(t):null}function b(e){return(""+e).trim()}function I(e,t,r,i){return t=b(t),u.substitute(t&&"{"===t[0]?r:i,e)}function x(e){return e.replace(/[\u00A0-\u99999<>\&]/gim,function(e){return"&#"+e.charCodeAt(0)+";"})}var w=c.getLogger("esri.widgets.FeatureViewModel"),A=/^\s*expression\//i,C=new l("cancelled-query","cancelled feature query"),E=s.getFormat("short-date-short-time"),N="DateFormat"+E;return function(e){function t(t){var r=e.call(this)||this;return r._handles=new p,r._featurePromise=void 0,r._layerDateFields=[],r.content=null,r.contentEnabled=!0,r.formattedAttributes=null,r.title="",r.view=null,r}return r(t,e),t.prototype.destroy=function(){this._clear(),this._handles.destroy(),this._handles=null,this.view=null,this.graphic=null},Object.defineProperty(t.prototype,"graphic",{get:function(){return this._get("graphic")||null},set:function(e){if(e){var t=y.getSourceLayer(e);this._layerDateFields=t?this._getDateFields(t):[]}this._set("graphic",e),this._graphicChanged(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"waitingForContent",{get:function(){var e=this._featurePromise;return!!e&&!e.isFulfilled()},enumerable:!0,configurable:!0}),t.prototype._clear=function(){this._cancelFeatureQuery(),this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)},t.prototype._graphicChanged=function(e){var t=this,r=this._handles;if(r){r.remove("graphic"),this._clear(),e&&(r.add(d.watch(this,["graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.fieldInfos","contentEnabled"],function(){t._graphicChanged(t.graphic)}),"graphic"),this._featurePromise=this._queryFeature().then(function(){t.notifyChange("waitingForContent")}).catch(function(e){throw t.notifyChange("waitingForContent"),e!==C&&w.log("error","error loading template",e),e}),this.notifyChange("waitingForContent"))}},t.prototype._cancelFeatureQuery=function(){var e=this._featurePromise;e&&!e.isFulfilled()&&e.cancel(C)},t.prototype._compileContent=function(e,t){var r=this;return e&&(e.nodeName||e&&_.isWidgetBase(e)||_.isWidget(e))?e:"string"==typeof e?this._compileText({type:"text",text:e}).text:Array.isArray(e)?e.map(function(e,i){var o=t&&t[i],n=o&&o.value,a=e.type;return"attachments"===a?r._compileAttachments(e,n):"fields"===a?r._compileFields(e):"media"===a?r._compileMedia(e):"text"===a?r._compileText(e):void 0}):void(e&&w.warn("invalid content type."))},t.prototype._compileFields=function(e){var t=this,r=this.graphic,i=u.clone(e),o=r.get("popupTemplate.expressionInfos"),n=i.fieldInfos?void 0:r.get("popupTemplate.fieldInfos"),a=i.fieldInfos||u.clone(n),s=[];return a&&a.forEach(function(e){var r=e.fieldName.toLowerCase();if(!e.hasOwnProperty("visible")||e.visible){var i=t._isExpressionField(r)?t._getExpressionInfo(o,r):null;e.label=i?i.title:e.label,s.push(e)}}),i.fieldInfos=s,i},t.prototype._setImageValue=function(e,t,r){var i=e.linkURL,o=e.sourceURL;e.sourceURL=u.substitute(t,this._fixTokens(o,r)),e.sourceURL&&i&&(e.linkURL=b(u.substitute(t,this._fixTokens(i,r))))},t.prototype._compileMedia=function(e){var t=this,r=this,i=r._layerDateFields,o=r.graphic,n=u.clone(e),a=n.mediaInfos||[],s=o.attributes,l=y.getSourceLayer(o),p=this.formattedAttributes.global,c={dateFormat:{properties:i,formatter:N}};return n.mediaInfos=a.map(function(e){var r=u.clone(e);if(r){var i=r.value,o=r.type,n=r.title?t._processFieldsInLinks(t._fixTokens(r.title,l),s):"",a=r.caption?t._processFieldsInLinks(t._fixTokens(r.caption,l),s):"";return r.title=n?b(u.substitute(p,n,c)):"",r.caption=a?b(u.substitute(p,a,c)):"","image"===o?(t._setImageValue(i,p,l),r):"pie-chart"===o||"line-chart"===o||"column-chart"===o||"bar-chart"===o?(t._setChartValue(i,p,l),r):void 0}}),n},t.prototype._compileText=function(e){var t=this,r=t._layerDateFields,i=t.graphic,o=u.clone(e);if(o&&o.text){var n=y.getSourceLayer(i),a=i.attributes,s=this.formattedAttributes.global,l={dateFormat:{properties:r,formatter:N}},p=this._processFieldsInLinks(this._fixTokens(o.text,n),a);o.text=b(u.substitute(s,p,l))}return o},t.prototype._compileTitle=function(){var e=this,t=e._layerDateFields,r=e.graphic,i=r.get("popupTemplate.title"),o=r.attributes,n=y.getSourceLayer(r),a={dateFormat:{properties:t,formatter:N}},s=this.formattedAttributes.global;if("function"==typeof i)return i.call(null,{graphic:r});if("string"==typeof i&&i){var l=this._processFieldsInLinks(this._fixTokens(i,n),o);return b(u.substitute(s,l,a))}return""},t.prototype._getExpressionInfo=function(e,t){if(this._isExpressionField(t)){var r,i=t.replace(A,"").toLowerCase();return e.some(function(e){if(e.name.toLowerCase()===i)return r=e,!0}),r}},t.prototype._fixTokens=function(e,t){var r=/(\{([^\{\r\n]+)\})/g;return e.replace(r,function(e,r,i){var o=F(t,i);return o?"{"+o.name+"}":r})},t.prototype._encodeAttributes=function(e){var t=e?u.clone(e):{};return Object.keys(t).forEach(function(e){return v(e,t)}),t},t.prototype._formatAttributesToFieldInfos=function(e,t,r){var i=this,o=u.clone(this._layerDateFields);e.forEach(function(n){var a=i._getFixedFieldName(n.fieldName,t);if(n.fieldName=a,r[a]=i._formatValue(r[a],{fieldInfos:e,fieldName:a,layer:t}),o&&n.format&&n.format.dateFormat){var s=o.indexOf(a);s>-1&&o.splice(s,1)}})},t.prototype._getArcadeViewingMode=function(e){return e&&"local"===e.viewingMode?"localScene":"globalScene"},t.prototype._getViewInfo=function(){var e=this.view;if(e){var t="3d"===e.type?this._getArcadeViewingMode(e):"map",r=e.scale,i=e.spatialReference;return m.getViewInfo({viewingMode:t,scale:r,spatialReference:i})}},t.prototype._formatAttributes=function(e,t,r){var i=this,o=this.graphic,n=o.attributes,a=y.getSourceLayer(o),s=n?u.clone(n):{};if(t&&t.forEach(function(e){var t="expression/"+e.name,n=r.get(e.name),a=i._getViewInfo(),l=m.executeFunction(n,m.createExecContext(o,a));s[t]="string"==typeof l?x(l):l}),this.addRelatedFeatureAttributes(s),e&&this._formatAttributesToFieldInfos(e,a,s),a){var l=a.typeIdField;n&&Object.keys(n).forEach(function(e){if(!i.isRelatedField(e)){var t=n[e];if(u.isDefined(t)){var r=i._getDomainName(e,t);if(u.isDefined(r))return void(s[e]=r);if(e===l){var o=i._getTypeName();u.isDefined(o)&&(s[e]=o)}}}})}return s},t.prototype._formatValue=function(e,t){var r=this._layerDateFields,i={dateFormat:{properties:r,formatter:N}},o=t.fieldInfos,a=t.fieldName,l=this._getFieldInfo(o,a),p=u.clone(l),c=t.preventPlacesFormatting,f=t.layer,d=F(f,a);if(d&&"date"===d.type){var h=p.format||{};h.dateFormat=h.dateFormat||"short-date-short-time",p.format=h}var m=p&&p.format;if(!u.isDefined(e)||!p||!u.isDefined(m))return e;var y=[],g=m.hasOwnProperty("places")||m.hasOwnProperty("digitSeparator"),_=!m.hasOwnProperty("digitSeparator")||m.digitSeparator,v=u.isDefined(m.places)&&(!c||m.places>0);g&&v&&y.push("places: "+Number(m.places));var b=g?v?"NumberFormat("+y.join(",")+")":"NumberFormat":m.dateFormat?"DateFormat"+(s.getFormat(m.dateFormat)||E):void 0;if(!b)return e;var I=u.substitute({myKey:e},"{myKey:"+b+"}",i)||"";return g&&!_&&n.group?I.replace(new RegExp("\\"+n.group,"g"),""):I},t.prototype._getDomainName=function(e,t){var r=this.graphic,i=y.getSourceLayer(r);if(!i||"feature"!==i.type)return null;var o=i.getFieldDomain(e,{feature:r});return o&&"coded-value"===o.type?o.getName(t):null},t.prototype._getFieldInfo=function(e,t){if(e&&e.length&&t){var r=t.toLowerCase(),i=void 0;return e.some(function(e){if(e.fieldName&&e.fieldName.toLowerCase()===r)return i=e,!0}),i}},t.prototype._getTypeName=function(){var e=this.graphic,t=y.getSourceLayer(e);if(t&&"feature"===t.type){var r=t.getFeatureType(e);if(r)return r.name}},t.prototype._processFieldsInLinks=function(e,t){var r=this._encodeAttributes(t),i=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi;return e?e.replace(i,function(e,i,o){return I(e,i||o,t,r)}):e},t.prototype._compileAttachments=function(e,t){var r=u.clone(e);return t?(r.attachmentInfos=t,r):r},t.prototype._queryAttachments=function(){var e=this.graphic,t=y.getSourceLayer(e);if(!t)return f.resolve([]);var r="scene"===t.type&&t.associatedLayer?t.associatedLayer:t;return r&&"feature"===r.type?r.queryFeatureAttachments(e):f.resolve([])},t.prototype._queryContentElements=function(e){var t=this;if(!Array.isArray(e))return f.resolve();var r={};return e.forEach(function(e,i){if("attachments"===e.type){var o=t._queryAttachments();o&&(r[i]=o)}}),Object.keys(r).length?f.eachAlways(r):f.resolve()},t.prototype._getContent=function(){var e=this,t=e.contentEnabled,r=e.graphic;if(!t)return f.resolve();var i=r.get("popupTemplate.content"),o="function"==typeof i?i.call(null,{graphic:r}):i;return f.isThenable(o)?o:f.resolve(o)},t.prototype._queryFeature=function(){var e=this;return this._getContent().then(function(t){return e._checkForRelatedFeatures(t).then(function(){return e._set("formattedAttributes",e._createFormattedAttributes(t)),e._set("title",e._compileTitle()),e._queryContentElements(t).then(function(r){var i=e._compileContent(t,r);return e._set("content",i||null),i})})})},t.prototype._isExpressionField=function(e){return A.test(e)},t.prototype._createCompiledExpressionDictionary=function(e){var t=new Map;return e?(e.forEach(function(e){return t.set(e.name,m.createFunction(e.expression))}),t):t},t.prototype._getDateFields=function(e){var t=e.fields;return t?t.filter(function(e){return"date"===e.type}).map(function(e){return e.name}):[]},t.prototype._createFormattedAttributes=function(e){var t=this,r=this.graphic,i=r.get("popupTemplate.fieldInfos"),o=r.get("popupTemplate.expressionInfos"),n=this._createCompiledExpressionDictionary(o),a={global:this._formatAttributes(i,o,n),content:[]};return Array.isArray(e)&&e.forEach(function(e,r){"fields"===e.type&&e.fieldInfos&&(a.content[r]=t._formatAttributes(e.fieldInfos,o,n))}),a},t.prototype._getAllFieldInfos=function(e){var t=this.graphic,r=[],i=t.get("popupTemplate.fieldInfos");return i&&r.push.apply(r,i),e&&Array.isArray(e)?(e.forEach(function(e){var t=e&&e.fieldInfos;r.push.apply(r,t)}),r):r},t.prototype._checkForRelatedFeatures=function(e){var t=this.graphic,r=this._getAllFieldInfos(e);return this.queryRelatedInfos(t,r)},t.prototype._getChartOption=function(e,t,r,i,o){var n=this.graphic,a=y.getSourceLayer(n),s=t.normalizeField,l=t.tooltipField,p=s?this.isRelatedField(s)?r[this.getRelatedFieldInfo(s).fieldName]:r[s]:null,u=parseFloat(r[e]),c=void 0===u?null:u&&p?u/p:u,f={y:c,tooltip:""+c};if(!l)return f;if(this.isRelatedField(l)){var d=this.getRelatedFieldInfo(l).fieldName,h=r[d],m=this._formatValue(c,{fieldInfos:o,fieldName:h,layer:a,preventPlacesFormatting:!!p});return f.tooltip=h+":"+m,f}var g=this._getFieldInfo(o,i),_=this._getFixedFieldName(i,a),v=this._formatValue(c,{fieldInfos:o,fieldName:l,layer:a,preventPlacesFormatting:!!p}),F=g?g.fieldName:_;return f.tooltip=F+":"+v,f},t.prototype._getFixedFieldName=function(e,t){var r=F(t,e);return r?r.name:e},t.prototype._getFixedFieldNames=function(e,t){var r=this;return e&&e.map(function(e){return r._getFixedFieldName(e,t)})},t.prototype._setChartValue=function(e,t,r){var i=this,o=this,n=o.graphic,a=o.relatedInfoCount,s=e.fields,l=e.normalizeField;if(e.fields=this._getFixedFieldNames(s,r),l&&(e.normalizeField=this._getFixedFieldName(l,r)),s.some(function(e){return!!(u.isDefined(t[e])||i.isRelatedField(e)&&a)})){var p=n.get("popupTemplate.fieldInfos");e.chartOptions=e.chartOptions||[],s.forEach(function(r){if(i.isRelatedField(r))return void(e.chartOptions=e.chartOptions.concat(i._getRelatedChartInfos(p,r,e,t)));var o=i._getChartOption(r,e,t,r,p);e.chartOptions.push(o)})}},t.prototype._getRelatedChartInfos=function(e,t,r,i){var o=this,n=[],a=this.getRelatedFieldInfo(t),s=a.layerId,l=a.fieldName,p=this.getRelatedInfo(s);if(!p)return n;var u=p.relatedFeatures,c=p.relation;if(!c||!u)return n;var f=c.cardinality;return u.forEach(function(i){var a=i.attributes;a&&Object.keys(a).forEach(function(i){i===l&&n.push(o._getChartOption(i,r,a,t,e))})}),"one-to-many"===f||"many-to-many"===f?n:[n[0]]},i([h.property({readOnly:!0})],t.prototype,"content",void 0),i([h.property()],t.prototype,"contentEnabled",void 0),i([h.property({readOnly:!0})],t.prototype,"formattedAttributes",void 0),i([h.property({type:a})],t.prototype,"graphic",null),i([h.property({readOnly:!0})],t.prototype,"title",void 0),i([h.property()],t.prototype,"view",void 0),i([h.property({readOnly:!0})],t.prototype,"waitingForContent",null),t=i([h.subclass("esri.widgets.FeatureViewModel")],t)}(h.declared(g))});