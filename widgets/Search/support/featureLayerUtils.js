// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../../core/Error","../../../core/lang","../../../core/promiseUtils","../../../geometry/support/scaleUtils","./geometryUtils","dojo/date/locale"],function(e,r,t,n,i,u,a,o){function l(e){var r=e.exactMatch,n=void 0===r?!1:r,a=e.location,o=e.maxResults,l=e.spatialReference,s=e.source,g=e.sourceIndex,h=e.suggestResult,F=e.view,w=s.featureLayer,b=s.filter,j=s.zoomScale,R=F&&F.scale,P=f(s,F);return d(w).then(function(){var e=y(s),r=p(w,e);if(!r)return i.reject(new t("searchfeaturelayerutils:invalid-field","displayField is invalid."));var f=s.outFields||[e],d=c(f)||m(w,f);if(!d)return i.reject(new t("searchfeaturelayerutils:invalid-field","outField is invalid."));var E=w.createQuery(),S=s.searchQueryParams;if(S&&E.set(S),l){E.outSpatialReference=l;var L=u.getMetersPerUnitForSR(l);L&&(E.maxAllowableOffset=L)}if(E.returnGeometry=!0,f&&(E.outFields=f),a)E.geometry=a;else if(h.key)E.objectIds=[parseInt(h.key,10)];else{var U=s.searchFields||[e],T=m(w,U);if(!T)return i.reject(new t("searchfeaturelayerutils:invalid-field","search field is invalid."));v(w)&&(E.num=o),P&&(E.geometry=P);var q=h.text.trim();if(!q)return i.resolve();var C=s.prefix,D=void 0===C?"":C,N=s.suffix,Q=void 0===N?"":N,k=x(""+D+q+Q),A=I(k,w,U,b,n);if(!A)return i.resolve();E.where=A}return w.queryFeatures(E).then(function(r){return O(r,F,s,g,e,R,j)})})}function s(e){var r=e.source,n=e.spatialReference,u=e.view,a=e.suggestTerm,o=e.maxSuggestions,l=e.sourceIndex,s=r.featureLayer,g=r.filter,h=f(r,u);return d(s).then(function(){if(!v(s))return i.resolve();var e=y(r),u=r.searchFields||[e],f=[];r.suggestionTemplate?r.suggestionTemplate.replace(q,function(e,r){return f.push(r),e}):f.push(e);var d=-1!==f.indexOf(s.objectIdField);d||f.push(s.objectIdField);var F=p(s,e),w=c(f)||m(s,f),b=m(s,u);if(!F)return i.reject(new t("searchfeaturelayerutils:invalid-field","displayField is invalid."));if(!w)return i.reject(new t("searchfeaturelayerutils:invalid-field","outField is invalid."));if(!b)return i.reject(new t("searchfeaturelayerutils:invalid-field","search field is invalid."));var j=s.createQuery(),R=r.suggestQueryParams;R&&j.set(R),j.outSpatialReference=n,j.returnGeometry=!1,j.num=o,j.outFields=f,h&&(j.geometry=h);var P=a.trim();if(!P)return i.resolve();var E=r.prefix,L=void 0===E?"":E,O=r.suffix,U=void 0===O?"":O,T=x(""+L+P+U),C=I(T,s,u,g,!1);return C?(j.where=C,s.queryFeatures(j).then(function(t){return S(t,r,l,e)})):i.resolve()})}function f(e,r){var t=e.filter,n=e.searchExtent,i=e.withinViewEnabled,u=r&&r.extent,a=t&&t.geometry,o=i&&u?u:void 0;return a||n||o}function c(e){return e&&1===e.length&&"*"===e[0]}function d(e){if(!e)return i.resolve();var r=e.loadStatus===U,t=r?e.load():e;return t.then(i.resolve).otherwise(i.reject)}function v(e){return e&&!!e.get("capabilities.query.supportsPagination")}function g(e){var r="";if(e){var t=e.fields;t&&t.some(function(e){return"string"===e.type?(r=e.name,!0):void 0})}return r}function y(e){return e.displayField||e.featureLayer.displayField||g(e.featureLayer)}function m(e,r){return e&&r?r.every(function(r){return p(e,r)}):!1}function p(e,r){return!!e.getField(r)}function h(e){for(var r=0;r<e.length;r++)if(e.charCodeAt(r)>255)return!0;return!1}function F(e,r,t){var n=null,i=e.codedValues;return i&&i.some(function(e){var i=e.name,u=t?i:i.toLowerCase(),a=t?r:r.toLowerCase();return a===u?(n=e.code.toString(),!0):void 0}),n}function x(e){return e.replace(/\'/g,"''")}function w(e,r){var t=r&&r.where;return t?"("+e+") AND ("+t+")":e}function b(e,r,t,n,i){var u=r.type,a=r.name;if("string"===u||"date"===u){if(i)return w(a+" = "+t+"'"+e+"'",n);var o=e.toUpperCase();return w("UPPER("+a+") LIKE "+t+"'%"+o+"%'",n)}if("oid"===u||"small-integer"===u||"integer"===u||"single"===u||"double"===u){var l=parseFloat(e);return isNaN(l)?null:w(a+" = "+l,n)}return w(a+" = "+e,n)}function j(e,r){return e?" OR ("+r+")":"("+r+")"}function I(e,r,t,n,i){var u="";if(e){var a=T.test(r.url)&&h(e)?"N":"";t&&t.forEach(function(t){var o=r.getField(t),l=r.getFieldDomain(t),s=l&&"coded-value"===l.type?F(l,e,i):null,f=s||e||null;if(null!==f){var c=b(f,o,a,n,i);c&&(u+=j(u,c))}})}return u}function R(e,r){var t=null,n=e.codedValues;return n&&n.length&&n.some(function(e){return e.code===r?(t=e.name,!0):void 0}),t}function P(e,r,t,i){var u=e.layer,a=e.attributes,l=u.getFieldDomain(t);if(r)return n.substitute(a,r);if(t&&e.hasOwnProperty("attributes")&&a.hasOwnProperty(t)){var s=a[t],f=u.getField(t);return l&&"coded-value"===l.type?R(l,s):f&&"date"===f.type?o.format(new Date(s)):s}return""}function E(e,r,t,n){var i=e.layer,u=e.attributes,a=i.objectIdField,o=u[a],l=P(e,r.suggestionTemplate,n,r);return{text:l,key:o,sourceIndex:t}}function S(e,r,t,n){return e.features.map(function(e){return E(e,r,t,n)})}function L(e,r,t,n,i,u,o){var l=e.clone(),s=P(e,t.searchTemplate,i,t),f=a.createExtentFromGeometry(l.geometry,r,u),c=o?a.scaleExtent(f.clone(),r,o):f;return{extent:c,feature:l,name:s,sourceIndex:n}}function O(e,r,t,n,i,u,a){return e.features.map(function(e){return L(e,r,t,n,i,u,a)})}Object.defineProperty(r,"__esModule",{value:!0});var U="not-loaded",T=/https?:\/\/services.*\.arcgis\.com/i,q=/(?:\{([^}]+)\})/g;r.getResults=l,r.getSuggestions=s});