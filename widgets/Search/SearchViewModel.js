// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","dojo/has","dojo/i18n!./nls/Search","../../Graphic","../../PopupTemplate","../../core/Accessor","../../core/Collection","../../core/Error","../../core/Evented","../../core/Handles","../../core/Logger","../../core/promiseUtils","../../core/watchUtils","../../core/accessorSupport/decorators","../../geometry/Point","../../geometry/SpatialReference","../../styles/basic","../../symbols/PictureMarkerSymbol","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../symbols/TextSymbol","../../tasks/Locator","./FeatureLayerSearchSource","./LocatorSearchSource","./SearchSource","./support/geometryUtils"],function(e,t,r,o,s,i,n,u,a,c,l,p,h,d,g,y,m,v,f,S,_,x,b,w,R,I,T,P,E,O){function A(e,t){return e.hasOwnProperty(t)&&null!=e[t]&&""!==e[t]}var F=d.getLogger("esri.widgets.Search.SearchViewModel"),G=c.ofType({key:function(e){return e.featureLayer?"feature-layer":"locator"},base:E,typeMap:{"feature-layer":T,locator:P}}),L=f.WGS84,D=/<(?:.|\s)*?>/g;return function(t){function a(r){var o=t.call(this)||this;return o._handles=new h,o._viewReadyPromise=null,o._gotoPromise=null,o._popupTemplate=new u({title:i.searchResult,content:"{Match_addr}"}),o.activeSource=null,o.activeSourceIndex=0,o.allPlaceholder=i.allPlaceholder,o.autoNavigate=!0,o.autoSelect=!0,o.defaultSource=new P({locator:new I({url:"//geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer"}),singleLineFieldName:"SingleLine",outFields:["Addr_type","Match_addr","StAddr","City"],name:i.esriLocatorName,localSearchOptions:{minScale:3e5,distance:5e4},placeholder:i.placeholder,resultSymbol:new _({url:e.toUrl(s("trident")?"../../images/search/search-symbol-32.png":"../../images/search/search-symbol-32.svg"),size:24,width:24,height:24})}),o.locationToAddressDistance=1500,o.maxInputLength=128,o.maxResults=6,o.maxSuggestions=6,o.minSuggestCharacters=1,o.popupOpenOnSelect=!0,o.popupTemplate=null,o.popupEnabled=!0,o.resultGraphicEnabled=!0,o.resultGraphic=null,o.results=null,o.selectedSuggestion=null,o.searchAllEnabled=!0,o.selectedResult=null,o.sources=new G([o.defaultSource]),o.suggestionDelay=150,o.suggestions=null,o.suggestionsEnabled=!0,o.view=null,o}return r(a,t),a.prototype.initialize=function(){var e=this;this._handles.add([y.init(this,"activeSourceIndex",function(){return e._updateActiveSource()}),y.init(this,"searchAllEnabled, sources",function(){return e._setDefaultActiveSourceIndex()})])},a.prototype.destroy=function(){this.clearGraphics(),this._viewReadyPromise&&this._viewReadyPromise.cancel(),this._handles.destroy(),this._handles=null},Object.defineProperty(a.prototype,"placeholder",{get:function(){var e=this,t=e.activeSourceIndex,r=e.allPlaceholder,o=void 0===r?i.allPlaceholder:r;if(-1===t)return o;var s=this.sources.getItemAt(t);return s?s.placeholder:""},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"popup",{get:function(){return this.get("view.popup")||null},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"searchTerm",{get:function(){return this._get("searchTerm")||""},set:function(e){this._set("searchTerm",e||""),this.clearGraphics(),this.selectedSuggestion&&this.selectedSuggestion.text!==e&&this._set("selectedSuggestion",null),""===e&&this._clear()},enumerable:!0,configurable:!0}),a.prototype.clear=function(){this.searchTerm=""},a.prototype.clearGraphics=function(){this._closePopup(),this.view&&this.view.graphics.remove(this.resultGraphic),this._set("resultGraphic",null)},a.prototype.search=function(e){var t=this;this.emit("search-start"),this.clearGraphics();var r=this._createSuggestionForSearch(e);return this._ready(this.view).then(function(){return t._getResultsFromSources(r).then(function(e){var o={activeSourceIndex:t.activeSourceIndex,searchTerm:r.text,numResults:0,numErrors:0,errors:[],results:[]};t._formatResponse(o,e,r);var s=t._getFirstResult(o.results),i=r.location&&s?s.name:r.text,n=i.replace(D,"");return t._set("searchTerm",n),(r.key&&"number"==typeof r.sourceIndex||r.location)&&t._set("selectedSuggestion",r),t._set("results",o.results),t.emit("search-complete",o),t._selectFirstResult(s).then(function(){return o})})})},a.prototype.select=function(e){var t=this;if(this.clearGraphics(),!e)return F.error("missing-parameter: searchResult is required."),g.reject(new l("searchviewmodel:missing-parameter","searchResult is required."));var r=this.view,o=A(e,"sourceIndex")?e.sourceIndex:this._getSourceIndexOfResult(e),s=this.sources.getItemAt(o);if(!s)return F.error("missing-source: source not found for selection."),g.reject(new l("searchviewmodel:missing-source","source not found for selection."));var i=s instanceof T?this._getSourcePopupTemplate(s):null,u=s.resultSymbol||this._getDefaultSymbol(e),a=A(s,"resultGraphicEnabled")?s.resultGraphicEnabled:this.resultGraphicEnabled,c=A(s,"autoNavigate")?s.autoNavigate:this.autoNavigate,p=A(s,"popupOpenOnSelect")?s.popupOpenOnSelect:this.popupOpenOnSelect,h=A(s,"popupEnabled")?s.popupEnabled:this.popupEnabled,d=h?i||this.popupTemplate||this._popupTemplate:null,y=e.feature,m=this.popup,v=y.attributes,f=y.geometry,S=y.sourceLayer;if(!y)return F.error("missing-feature: searchResult must contain a feature for selection."),g.reject(new l("searchviewmodel:missing-feature","searchResult must contain a feature for selection."));var _=O.getPointFromGeometry(f);return(r?O.getPointWithElevation(_,r):g.resolve(_)).then(function(i){u instanceof R&&(u.text=e.name);var l=new n({geometry:f,symbol:u,attributes:v,sourceLayer:S,popupTemplate:d});return(r&&c?t._goToSearchResult(r,e.extent):g.resolve()).then(function(){return t._gotoPromise=null,a&&r&&r.graphics.push(l),m&&h&&p&&m.open({features:[l],location:i}),t._set("selectedResult",e),t._set("resultGraphic",l),t.emit("select-result",{result:e,source:s,sourceIndex:o}),e})})},a.prototype.suggest=function(e,t){var r=this,o=e||this.searchTerm;return this.emit("suggest-start",{searchTerm:o}),this._suggestTimer(t).then(function(){return r._suggestImmediate(o).then(function(e){return r._set("suggestions",e.results),r.emit("suggest-complete",e),e})})},a.prototype._clear=function(){this._gotoPromise&&(this._gotoPromise.cancel(),this._gotoPromise=null),this._set("results",null),this._set("suggestions",null),this._set("selectedResult",null),this._set("selectedSuggestion",null),this.emit("search-clear")},a.prototype._closePopup=function(){var e=this.get("view.popup"),t=this.resultGraphic;if(e&&this.popupEnabled&&t){var r=e.selectedFeature;r&&r===t&&e.close()}},a.prototype._suggestTimer=function(e){var t=null!=e?e:this.suggestionDelay;return g.after(t)},a.prototype._createLocationForSearch=function(e){return e instanceof n?O.getPointFromGeometry(e.geometry):e instanceof v?e:Array.isArray(e)&&2===e.length?new v({longitude:e[0],latitude:e[1]}):void 0},a.prototype._createSuggestionForSearch=function(e){if(e&&A(e,"key")&&A(e,"text")&&A(e,"sourceIndex"))return e;var t=this._createLocationForSearch(e)||null,r="string"==typeof e?e:this.searchTerm,o=this,s=o.selectedSuggestion,i=o.selectedResult,n=!e&&s&&i,u=n&&s.key===i.key&&s.sourceIndex===i.sourceIndex,a=n&&s.location;return u||a?s:{location:t,text:t?"":r,sourceIndex:null,key:null}},a.prototype._getFirstResult=function(e){var t=null;return e&&e.some(function(e){var r=e.results,o=r[0],s=!!o;return s&&(t=o),s}),t},a.prototype._selectFirstResult=function(e){return this.autoSelect&&e?this.select(e):g.resolve()},a.prototype._suggestImmediate=function(e){var t=this;return this._ready(this.view).then(function(){return t._getSuggestionsFromSources(e)}).then(function(r){var o={activeSourceIndex:t.activeSourceIndex,searchTerm:e,numResults:0,numErrors:0,errors:[],results:[]};return t._formatResponse(o,r),o})},a.prototype._formatSourceResponse=function(e,t,r){var o=t&&t.value||[],s=t&&t.error,i=this.sources.getItemAt(r);if(s){var n={sourceIndex:r,source:i,error:s};e.errors.push(n),e.numErrors++}else{var u={sourceIndex:r,source:i,results:o};e.results.push(u),e.numResults+=o.length}},a.prototype._formatResponse=function(e,t,r){var o=this;if(t)if(-1===e.activeSourceIndex){var s=r&&A(r,"sourceIndex")&&-1!==r.sourceIndex?r.sourceIndex:void 0;t.forEach(function(t,r){var i=void 0!==s?s:r;o._formatSourceResponse(e,t,i)})}else this._formatSourceResponse(e,t[0],e.activeSourceIndex)},a.prototype._getResultsFromSources=function(e){var t=this,r=!e.location&&A(e,"sourceIndex")?e.sourceIndex:this.activeSourceIndex,o=[];return-1===r?this.sources.forEach(function(r,s){o.push(t._getResultsFromSource(e,s))}):o.push(this._getResultsFromSource(e,r)),g.eachAlways(o)},a.prototype._getSuggestionsFromSources=function(e){var t=this,r=this.activeSourceIndex,o=[];return-1===r?this.sources.forEach(function(r,s){o.push(t._getSuggestionsFromSource(e,s))}):o.push(this._getSuggestionsFromSource(e,r)),g.eachAlways(o)},a.prototype._getResultsFromSource=function(e,t){var r=this.sources.getItemAt(t),o=e.location,s=void 0===o?null:o,i=this.get("view.spatialReference")||L,n=A(r,"maxResults")?r.maxResults:this.maxResults,u=!!(r instanceof T&&A(r,"exactMatch"))&&r.exactMatch,a=r instanceof P&&A(r,"locationToAddressDistance")?r.locationToAddressDistance:this.locationToAddressDistance,c=this.view;return r.getResults({view:c,sourceIndex:t,location:s,suggestResult:e,spatialReference:i,exactMatch:u,maxResults:n,distance:a})},a.prototype._getSuggestionsFromSource=function(e,t){var r=this.sources.getItemAt(t),o=A(r,"suggestionsEnabled")?r.suggestionsEnabled:this.suggestionsEnabled,s=e.trim().length,i=A(r,"minSuggestCharacters")?r.minSuggestCharacters:this.minSuggestCharacters;if(o&&s>=i){var n=this.get("view.spatialReference")||L,u=A(r,"maxSuggestions")?r.maxSuggestions:this.maxSuggestions,a=this.view;return r.getSuggestions({view:a,sourceIndex:t,suggestTerm:e,spatialReference:n,maxSuggestions:u})}return g.resolve()},a.prototype.createDefaultSymbol=function(e,t){if("point"===t){var r=e;return new w({color:e.color,size:r.size,outline:{color:r.outline.color,width:r.outline.width}})}if("polyline"===t){var o=e;return new b({color:o.color,width:o.width})}if("polygon"===t){var s=e;return new x({color:s.color,outline:{color:s.outline.color,width:s.outline.width}})}},a.prototype._updateActiveSource=function(){var e=this.activeSourceIndex,t=this.sources.getItemAt(e)||null;this._set("activeSource",t)},a.prototype._setDefaultActiveSourceIndex=function(){var e=1===this.sources.length,t=e||!this.searchAllEnabled;this.activeSourceIndex=t?0:-1},a.prototype._getSourcePopupTemplate=function(e){var t=e.featureLayer;if(t)return A(e,"popupTemplate")?e.popupTemplate:t.popupTemplate},a.prototype._getSourceIndexOfResult=function(e){var t=this.results,r=null;return t.some(function(t){return t.results.some(function(o){if(o===e)return r=t.sourceIndex,!0})}),r},a.prototype._goToSearchResult=function(e,t){var r=!!t,o={animate:r},s="3d"===e.type?e.goTo({target:t,tilt:0},o):e.goTo({target:t},o);return r&&(this._gotoPromise=s),s},a.prototype._ready=function(e){if(this._viewReadyPromise&&this._viewReadyPromise.cancel(),e){var t=e.always();return this._viewReadyPromise=t.then(function(){return null}),this._viewReadyPromise}return g.resolve()},a.prototype._getDefaultSymbol=function(e){var t=this.get("view.map.basemap.id"),r=e&&e.feature&&e.feature.geometry&&e.feature.geometry.type;if(r){var o=S.getSchemes({theme:"default",basemap:t||"topo",geometryType:r}),s=o&&o.primaryScheme;if(s)return s.color&&A(s,"opacity")&&(s.color.a=s.opacity),this.createDefaultSymbol(s,r)}return this.get("defaultSource.resultSymbol")},a.ALL_INDEX=-1,o([m.property({readOnly:!0})],a.prototype,"activeSource",void 0),o([m.property()],a.prototype,"activeSourceIndex",void 0),o([m.property()],a.prototype,"allPlaceholder",void 0),o([m.property()],a.prototype,"autoNavigate",void 0),o([m.property()],a.prototype,"autoSelect",void 0),o([m.property({readOnly:!0})],a.prototype,"defaultSource",void 0),o([m.property()],a.prototype,"locationToAddressDistance",void 0),o([m.property()],a.prototype,"maxInputLength",void 0),o([m.property()],a.prototype,"maxResults",void 0),o([m.property()],a.prototype,"maxSuggestions",void 0),o([m.property()],a.prototype,"minSuggestCharacters",void 0),o([m.property({readOnly:!0,dependsOn:["activeSourceIndex","activeSource.placeholder","allPlaceholder","sources"]})],a.prototype,"placeholder",null),o([m.property({dependsOn:["view.popup"],readOnly:!0})],a.prototype,"popup",null),o([m.property()],a.prototype,"popupOpenOnSelect",void 0),o([m.property()],a.prototype,"popupTemplate",void 0),o([m.property()],a.prototype,"popupEnabled",void 0),o([m.property()],a.prototype,"resultGraphicEnabled",void 0),o([m.property({readOnly:!0})],a.prototype,"resultGraphic",void 0),o([m.property({readOnly:!0})],a.prototype,"results",void 0),o([m.property({readOnly:!0})],a.prototype,"selectedSuggestion",void 0),o([m.property()],a.prototype,"searchAllEnabled",void 0),o([m.property({readOnly:!0})],a.prototype,"selectedResult",void 0),o([m.property()],a.prototype,"searchTerm",null),o([m.property({type:G})],a.prototype,"sources",void 0),o([m.property()],a.prototype,"suggestionDelay",void 0),o([m.property({readOnly:!0})],a.prototype,"suggestions",void 0),o([m.property()],a.prototype,"suggestionsEnabled",void 0),o([m.property()],a.prototype,"view",void 0),o([m.property()],a.prototype,"clear",null),a=o([m.subclass("esri.widgets.Search.SearchViewModel")],a)}(m.declared(a,p))});