// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/accessorSupport/decorators","./Print/PrintViewModel","../tasks/support/PrintTemplate","../core/watchUtils","./Widget","./Print/FileLink","../core/urlUtils","./support/widget","dojo/i18n!./Print/nls/Print"],function(t,e,i,n,a,o,s,r,l,d,p,c,u){var h={base:"esri-print esri-widget esri-widget--panel",headerTitle:"esri-print__header-title",inputText:"esri-print__input-text",layoutTabList:"esri-print__layout-tab-list",layoutTab:"esri-print__layout-tab",layoutSection:"esri-print__layout-section",mapOnlySection:"esri-print__map-only-section",scaleInput:"esri-print__scale-input",advancedOptionsButton:"esri-print__advanced-options-button",advancedOptionsButtonContainer:"esri-print__advanced-options-button-container",advancedOptionsButtonTitle:"esri-print__advanced-options-button-title",advancedOptionsButtonIconOpened:"esri-print__advanced-options-button-icon--opened",advancedOptionsButtonIconClosed:"esri-print__advanced-options-button-icon--closed",advancedOptionsButtonIconClosed_RTL:"esri-print__advanced-options-button-icon--closed-rtl",refreshButton:"esri-print__refresh-button",swapButton:"esri-print__swap-button",linkButton:"esri-print__link-button",printButton:"esri-print__export-button",formSectionContainer:"esri-print__form-section-container",advancedOptionsSection:"esri-print__advanced-options-section",advancedOptionsContainer:"esri-print__advanced-options-container",authorInfoContainer:"esri-print__author-info-container",copyrightInfoContainer:"esri-print__copyright-info-container",exportedFilesContainer:"esri-print__export-panel-container",exportedFilesTitle:"esri-print__export-title",exportedFile:"esri-print__exported-file",exportedFileLink:"esri-print__exported-file-link",exportedFileLinkTitle:"esri-print__exported-file-link-title",heightContainer:"esri-print__height-container",legendInfoContainer:"esri-print__legend-info-container",printWidgetContainer:"esri-print__container",panelContainer:"esri-print__panel-container",scaleInfoContainer:"esri-print__scale-info-container",scaleInputContainer:"esri-print__scale-input-container",sizeContainer:"esri-print__size-container",widthContainer:"esri-print__width-container",button:"esri-widget-button",select:"esri-select",disabled:"esri-disabled",panelError:"esri-print__panel--error",exportedFileError:"esri-print__exported-file--error",hide:"esri-hidden",rotate:"esri-rotating",iconCheckMark:"esri-icon-check-mark",iconDownload:"esri-icon-download",iconError:"esri-icon-error",iconPrinter:"esri-icon-printer",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconDownArrow:"esri-icon-down-arrow",iconRefresh:"esri-icon-refresh",iconSpinner:"esri-icon-loading-indicator",iconSwap:"esri-icon-swap",iconLinked:"esri-icon-link-horizontal",iconUnlinked:"esri-icon-unlocked-link-horizontal"},_=function(t){function e(){var e=t.call(this)||this;return e._attribution=!0,e._exportedFileNameMap={},e._layoutTabSelected=!0,e._legend=!0,e._advancedOptionsVisible=!1,e._pendingExportScroll=!1,e._selectedTemplate=new s,e._scaleEnabled=!1,e._templatesInfo=null,e.view=null,e.viewModel=new o,e.printServiceUrl=null,e}return i(e,t),e.prototype.postInitialize=function(){var t=this;r.init(this,"viewModel.templatesInfo",function(e){e&&(t._templatesInfo=e,t._selectedTemplate.layout=t._templatesInfo.layout.defaultValue,t._selectedTemplate.format=t._templatesInfo.format.defaultValue,"MAP_ONLY"===t._selectedTemplate.layout&&(t._layoutTabSelected=!1))}),r.init(this,"viewModel.view.scale",function(e){t._scaleEnabled||(t._scale=e,t.scheduleRender())}),this._width=this._selectedTemplate.exportOptions.width,this._height=this._selectedTemplate.exportOptions.height},e.prototype.render=function(){var t=this,e=c.tsx("div",{key:"title-section","class":h.formSectionContainer},c.tsx("label",null,this._layoutTabSelected?u.title:u.fileName,c.tsx("input",{key:this.id+"__title",name:"title",type:"text",tabIndex:0,placeholder:this._layoutTabSelected?u.titlePlaceHolder:u.fileNamePlaceHolder,"class":h.inputText,oninput:this._updateInputValue,bind:this}))),i=this.get("_templatesInfo.format.choiceList")||[],n=i.length>0?i.map(function(t){return c.tsx("option",{key:t},t)}):c.tsx("option",{key:"format-default-option"},u.formatDefaultOption),a=c.tsx("div",{key:"file-format-section","class":h.formSectionContainer},c.tsx("label",null,u.fileFormatTitle,c.tsx("select",{key:this.id+"__formats","class":h.select,onchange:this._updateFromOption,"data-target-property":"format",bind:this},n))),o=this.get("_templatesInfo.layout.choiceList")||[],s=o.length>0?o.map(function(e){return c.tsx("option",{key:e,bind:t},e)}):c.tsx("option",{key:"layout-default-option"},u.layoutDefaultOption),r=c.tsx("div",{key:"page-setup-section","class":h.formSectionContainer},c.tsx("label",null,u.layoutTitle,c.tsx("select",{key:this.id+"__layouts","class":h.select,onchange:this._updateFromOption,"data-target-property":"layout",bind:this},s))),l=this._advancedOptionsVisible?c.tsx("div",{"aria-labelledby":this.id+"__advancedOptions","class":h.advancedOptionsContainer},c.tsx("div",{"class":c.join(h.scaleInfoContainer,h.formSectionContainer)},c.tsx("label",null,c.tsx("input",{key:this.id+"__scaleEnabled",name:"scaleEnabled",type:"checkbox",tabIndex:0,onchange:this._toggleInputValue,bind:this}),u.scale),c.tsx("div",{"class":h.scaleInputContainer},c.tsx("input",{key:this.id+"__scale","aria-label":u.scaleLabel,"aria-valuenow":""+this._scale,role:"spinbutton",type:"number",name:"scale","class":c.join(h.inputText,h.scaleInput),tabIndex:0,oninput:this._updateInputValue,disabled:!this._scaleEnabled,value:""+this._scale,bind:this}),c.tsx("button",{role:"button","aria-label":u.reset,"class":c.join(h.button,h.refreshButton,h.iconRefresh),tabIndex:0,onclick:this._resetToCurrentScale,bind:this}))),c.tsx("div",{"class":c.join(h.authorInfoContainer,h.formSectionContainer)},c.tsx("label",null,u.author,c.tsx("input",{key:this.id+"__author",type:"text",name:"author","class":h.inputText,tabIndex:0,oninput:this._updateInputValue,bind:this}))),c.tsx("div",{"class":c.join(h.copyrightInfoContainer,h.formSectionContainer)},c.tsx("label",null,u.copyright,c.tsx("input",{key:this.id+"__copyright",type:"text",name:"copyright","class":h.inputText,tabIndex:0,oninput:this._updateInputValue,bind:this}))),c.tsx("div",{"class":c.join(h.legendInfoContainer,h.formSectionContainer)},c.tsx("label",null,c.tsx("input",{key:this.id+"__legend",type:"checkbox",name:"legend",tabIndex:0,checked:!0,onchange:this._toggleInputValue,bind:this}),u.legend))):null,d=this._layoutTabSelected?c.tsx("section",{key:this.id+"__layoutContent",id:this.id+"__layoutContent","aria-labelledby":this.id+"__layoutTab","class":h.layoutSection,role:"tabpanel","aria-selected":this._layoutTabSelected},c.tsx("div",{key:"layout","class":h.panelContainer},e,r,this._layoutTabSelected?a:null),c.tsx("div",{key:"advanced-section","class":c.join(h.panelContainer,h.advancedOptionsSection)},c.tsx("button",{key:this.id+"__advancedOptions","aria-label":u.advancedOptions,"aria-expanded":this._advancedOptionsVisible?"true":"false",role:"button","class":h.advancedOptionsButton,onclick:this._showAdvancedOptions,bind:this},c.tsx("div",{"class":h.advancedOptionsButtonContainer},c.tsx("span",{"aria-hidden":"true","class":c.join(h.iconRightTriangleArrow,h.advancedOptionsButtonIconClosed)}),c.tsx("span",{"aria-hidden":"true","class":c.join(h.iconLeftTriangleArrow,h.advancedOptionsButtonIconClosed_RTL)}),c.tsx("span",{"aria-hidden":"true","class":c.join(h.iconDownArrow,h.advancedOptionsButtonIconOpened)}),c.tsx("span",{"class":h.advancedOptionsButtonTitle},u.advancedOptions))),l)):c.tsx("section",{key:this.id+"__mapOnlyContent",id:this.id+"__mapOnlyContent","aria-selected":!this._layoutTabSelected,"aria-labelledby":this.id+"__mapOnlyTab","class":h.mapOnlySection,role:"tabpanel"},c.tsx("div",{key:"mapOnly","class":h.panelContainer},e,this._layoutTabSelected?null:a,c.tsx("div",{"class":c.join(h.sizeContainer,h.formSectionContainer)},c.tsx("div",{"class":h.widthContainer},c.tsx("label",null,u.width,c.tsx("input",{key:this.id+"__width",type:"text",name:"width","class":h.inputText,onchange:this._updateInputValue,value:""+this._width,tabIndex:0,bind:this}))),c.tsx("div",{"class":h.heightContainer},c.tsx("label",null,u.height,c.tsx("input",{key:this.id+"__height",type:"text",name:"height","class":h.inputText,onchange:this._updateInputValue,value:""+this._height,tabIndex:0,bind:this}))),c.tsx("button",{role:"button","aria-label":u.swap,"class":c.join(h.button,h.swapButton,h.iconSwap),onclick:this._switchInput,tabIndex:0,bind:this})),c.tsx("div",{key:"attribution-container","class":h.formSectionContainer},c.tsx("label",null,c.tsx("input",{key:this.id+"__attribution",name:"attribution",type:"checkbox",onchange:this._toggleInputValue,tabIndex:0,checked:!0,bind:this}),u.attribution)))),p=this.exportedLinks.toArray(),_=this._renderExportedLink(p),b=(m={},m[h.disabled]=!this._selectedTemplate.layout&&!this._selectedTemplate.format,m),x="2d"!==this.get("view.type"),y=c.tsx("div",{key:this.id+"__errorPanel","class":h.panelError},x?u.sceneViewError:u.serviceError),v=c.tsx("div",{key:this.id+"__printPanel"},c.tsx("ul",{"class":h.layoutTabList,role:"tablist",onclick:this._toggleLayoutPanel,onkeydown:this._toggleLayoutPanel,bind:this},c.tsx("li",{id:this.id+"__layoutTab",key:this.id+"__layoutTab","data-tab-id":"layoutTab","class":h.layoutTab,role:"tab",tabIndex:0,"aria-selected":""+this._layoutTabSelected,bind:this},u.layoutTab),c.tsx("li",{id:this.id+"__mapOnlyTab",key:this.id+"__mapOnlyTab","data-tab-id":"mapOnlyTab","class":h.layoutTab,role:"tab",tabIndex:0,"aria-selected":""+!this._layoutTabSelected,bind:this},u.mapOnlyTab)),d,c.tsx("button",{"aria-label":u.exportDescription,role:"button","class":h.printButton,tabIndex:0,classes:b,onclick:this._handlePrintMap,bind:this},u["export"]),c.tsx("div",{key:this.id+"__exportedFilesContainer","class":h.exportedFilesContainer,afterUpdate:this._scrollExportIntoView,onclick:this._removeLink,bind:this},c.tsx("h2",{"class":h.exportedFilesTitle},u.exportText),p.length>0?null:c.tsx("div",{key:"exported-section-hints"},c.tsx("div",null,u.exportHint)),_)),f=c.tsx("div",{key:this.id+"__printContainer"},c.tsx("div",{"class":h.printWidgetContainer},c.tsx("header",{"class":h.headerTitle},u["export"]),this.error||!this.printServiceUrl||x?y:v));return c.tsx("div",{"class":h.base},f);var m},e.prototype._configurePrintTemplate=function(){this._selectedTemplate.attributionVisible=this._attribution,this._width&&(this._selectedTemplate.exportOptions.width=this._width),this._height&&(this._selectedTemplate.exportOptions.height=this._height),this._selectedTemplate.layoutOptions={titleText:this._title||"",authorText:this._author||"",copyrightText:this._copyright||""},this._legend||(this._selectedTemplate.layoutOptions.legendLayers=[]),this.scale=this._scale,this._selectedTemplate.outScale=this.scale;var t=this._title||u.untitled,e=this._selectedTemplate.format.toLowerCase(),i=e.indexOf("png")>-1?"png":e,n=t+i,a=void 0!==this._exportedFileNameMap[n];a?this._exportedFileNameMap[n]++:this._exportedFileNameMap[n]=0,this.exportedLinks.add(new d({name:t,extension:i,count:this._exportedFileNameMap[n]}))},e.prototype._resetToCurrentScale=function(){this._scale=this.viewModel.view.scale},e.prototype._updateInputValue=function(t){var e=t.target,i="_"+e.name;this[i]=e.value},e.prototype._handlePrintMap=function(){this._configurePrintTemplate(),this._pendingExportScroll=!0,this.viewModel.print(this._selectedTemplate)},e.prototype._updateFromOption=function(t){var e=t.target,i=e.selectedOptions.item(0).value,n=this._selectedTemplate,a=e.getAttribute("data-target-property");n[a]=i},e.prototype._switchInput=function(){t=[this._height,this._width],this._width=t[0],this._height=t[1];var t},e.prototype._showAdvancedOptions=function(){this._advancedOptionsVisible=!this._advancedOptionsVisible},e.prototype._scrollExportIntoView=function(t){this._pendingExportScroll&&(this._pendingExportScroll=!1,t.scrollIntoView())},e.prototype._toggleInputValue=function(t){var e=t.target,i="_"+e.name;this[i]=e.checked,"_scaleEnabled"===i&&(this.viewModel.scaleEnabled=this[i],this[i]||this._resetToCurrentScale())},e.prototype._removeLink=function(t){var e=t.target,i=e["data-item"];i&&"error"===i.state&&this.exportedLinks.remove(i)},e.prototype._renderExportedLink=function(t){return t.map(function(t){var e=(o={},o[h.iconSpinner]="pending"===t.state,o[h.rotate]="pending"===t.state,o[h.iconDownload]="ready"===t.state,o[h.iconError]="error"===t.state,o[h.exportedFileError]="error"===t.state,o),i=(s={},s[h.disabled]="pending"===t.state,s[h.exportedFileError]="error"===t.state,s),n=""===t.url?null:t.url;n&&(n=p.addProxy(n));var a;return a="pending"===t.state?u.pending:"ready"===t.state?u.ready:u.error,c.tsx("div",{"aria-label":a,key:t.formattedName,"class":h.exportedFile},c.tsx("a",{"aria-label":t.formattedName+". "+u.linkReady,href:n,tabIndex:0,target:"_blank","class":h.exportedFileLink},c.tsx("span",{"data-item":t,classes:e}),c.tsx("span",{"data-item":t,"class":h.exportedFileLinkTitle,classes:i},t.formattedName)));var o,s})},e.prototype._resetInputValue=function(){this._title="",this._selectedTemplate.format=this._templatesInfo.format.defaultValue},e.prototype._toggleLayoutPanel=function(t){this._resetInputValue();var e=t.target;if(this._layoutTabSelected="layoutTab"===e.getAttribute("data-tab-id"),this._layoutTabSelected){var i=this.get("_templatesInfo.layout.choiceList");this._selectedTemplate.layout=i&&i[0]}else this._selectedTemplate.layout="MAP_ONLY"},n([a.aliasOf("viewModel.view"),c.renderable()],e.prototype,"view",void 0),n([a.property({type:o}),c.renderable(["viewModel.templatesInfo","viewModel.state"])],e.prototype,"viewModel",void 0),n([a.aliasOf("viewModel.printServiceUrl")],e.prototype,"printServiceUrl",void 0),n([a.aliasOf("viewModel.scale"),c.renderable()],e.prototype,"scale",void 0),n([a.aliasOf("viewModel.exportedLinks"),c.renderable()],e.prototype,"exportedLinks",void 0),n([a.aliasOf("viewModel.error")],e.prototype,"error",void 0),n([c.accessibleHandler()],e.prototype,"_toggleLayoutPanel",null),e=n([a.subclass("esri.widgets.Print")],e)}(a.declared(l));return _});