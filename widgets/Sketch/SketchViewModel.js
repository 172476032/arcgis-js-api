// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../geometry","../../Graphic","../../core/Accessor","../../core/Evented","../../core/Handles","../../core/watchUtils","../../core/accessorSupport/decorators","../../layers/GraphicsLayer","../../symbols/SimpleFillSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleMarkerSymbol","../../views/2d/draw/Draw","../../views/2d/draw/VertexMover","./support/sketchUtils"],function(e,t,i,r,o,n,c,a,s,l,p,h,u,y,v,g,f,w){var m=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),r([p.property()],t.prototype,"reset",void 0),t=r([p.subclass()],t)}(p.declared(c,a)),d=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),r([p.property()],t.prototype,"complete",void 0),r([p.property()],t.prototype,"cancel",void 0),t=r([p.subclass()],t)}(p.declared(c,a)),_={redoKey:"r",undoKey:"z",centerKey:"Alt",constraintKey:"Control",snappingKey:"Shift"},G=function(){function e(e){this.tool=e,this.type="draw-start"}return e}(),S=function(){function e(e){this.tool=e,this.type="draw-cancel"}return e}(),x=function(){function e(e){this.geometry=e,this.type="draw-complete"}return e}(),P=function(){function e(e){this.geometry=e,this.type="update-start"}return e}(),b=function(){function e(e){this.geometry=e,this.type="update-cancel"}return e}(),k=function(){function e(e){this.geometry=e,this.type="update-complete"}return e}(),C=function(){function e(){this.type="reset"}return e}();return function(e){function t(t){var i=e.call(this,t)||this;return i._activeLineGraphic=null,i._centerGraphic=null,i._centerSymbol=new v({type:"simple-marker",style:"circle",size:3,color:[255,255,255],outline:{color:[100,100,100]}}),i._defaultGraphicsLayer=new h,i._defaultSegmentOffset=48,i._fillGraphic=null,i._graphics=null,i._handles=new s,i._lineGraphic=null,i._operationHandle=null,i._vertexGraphics=[],i.activeFillSymbol=new u({type:"simple-fill",style:"solid",color:[150,150,150,.2],outline:{color:[0,0,0,0]}}),i.activeLineSymbol=new y({type:"simple-line",color:[12,207,255,1],width:2}),i.activePointSymbol=new v({type:"simple-marker",style:"circle",size:6,color:[12,207,255],outline:{color:[50,50,50],width:1}}),i.draw=null,i.graphic=null,i.hoverVertexSymbol=new v({type:"simple-marker",style:"circle",size:8,color:[33,205,255],outline:{color:[0,12,255],width:1}}),i.layer=null,i.pointSymbol=new v({type:"simple-marker",style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),i.polygonSymbol=new u({type:"simple-fill",color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),i.polylineSymbol=new y({type:"simple-line",color:[130,130,130],width:2}),i.selectedVertexSymbol=new v({type:"simple-marker",style:"circle",size:8,color:[255,255,255],outline:{color:[0,12,255],width:1}}),i.updatePointSymbol=new v({type:"simple-marker",size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),i.updatePolygonSymbol=new u({type:"simple-fill",color:[0,200,255,.5],outline:{join:"round",color:[0,12,255],width:2}}),i.updatePolylineSymbol=new y({type:"simple-line",color:[0,200,255,1],width:2}),i.vertexSymbol=new v({type:"simple-marker",style:"circle",size:6,color:[33,205,255],outline:{color:[0,12,255],width:1}}),i.view=null,i}return i(t,e),t.prototype.initialize=function(){var e=this;this._handles.add([l.whenOnce(this,"view.ready",function(){e._set("draw",new g({view:e.view}))}),l.when(this,["layer","view.ready"],function(){e._graphics=e.layer instanceof h?e.layer:e._defaultGraphicsLayer}),l.when(this,"view.map",function(t,i){i&&i.remove(e._defaultGraphicsLayer),t&&t.add(e._defaultGraphicsLayer)})])},t.prototype.destroy=function(){this.reset(),this._handles.removeAll(),this._handles=null,this.draw&&this.draw.destroy(),this._set("draw",null),this._set("view",null),this.emit("destroy")},Object.defineProperty(t.prototype,"state",{get:function(){return this.get("view.ready")?"ready":"disabled"},enumerable:!0,configurable:!0}),t.prototype.complete=function(){this._operationHandle&&this._operationHandle.complete(),this.draw.reset()},t.prototype.create=function(e,t){var i=this;this._operationHandle&&this._operationHandle.cancel(),this._operationHandle=null;var r;switch(e){case"point":r=this._createPointOperation(t);break;case"polygon":r=this._createPolygonOperation(t);break;case"polyline":r=this._createPolylineOperation(t);break;case"multipoint":r=this._createMultipointOperation(t);break;case"rectangle":r=this._createRectangleOperation(t);break;case"circle":r=this._createCircleOperation(t);break;case"ellipse":r=this._createEllipseOperation(t);break;case"triangle":r=this._createTriangleOperation(t)}if(r)return this.emit("draw-start",new G(e)),r.on("complete",function(){r===i._operationHandle&&(i.emit("draw-complete",new x(i.graphic.geometry.clone())),i._operationHandle=null)}),r.on("cancel",function(){r===i._operationHandle&&(i.emit("draw-cancel",new S(e)),i._operationHandle=null)}),this._operationHandle=r,r},t.prototype.reset=function(){this._clearGraphics(),this._operationHandle&&this._operationHandle.cancel(),this._operationHandle=null,this.view.container.style.cursor="default",this.graphic&&this._graphics.remove(this.graphic),this._set("graphic",null),this.draw.reset(),this.emit("reset",new C)},t.prototype.update=function(e,t){var i=this;if(this._operationHandle&&this._operationHandle.cancel(),this._operationHandle=null,e){var r;switch(e.type){case"point":r=this._updatePointOperation(e,t);break;case"polyline":r=this._updatePolylineOperation(e,t);break;case"polygon":r=this._updatePolygonOperation(e,t)}if(r)return this.emit("update-start",new P(e.clone())),r.on("complete",function(){r===i._operationHandle&&(i.emit("update-complete",new k(i.graphic.geometry.clone())),i._operationHandle=null)}),r.on("cancel",function(){r===i._operationHandle&&(i.emit("update-cancel",new b(i.graphic.geometry.clone())),i._operationHandle=null)}),this._operationHandle=r,r}},t.prototype._createPointOperation=function(e){var t=this,i=this.draw.create("point",e),r=null,c=[i.on("cursor-update",function(e){r=t._displayCrosshairCursor()}),i.on("draw-complete",function(e){t._graphics.remove(t.graphic);var i=e.coordinates,r=i[0],c=i[1];t._set("graphic",new n(new o.Point({x:r,y:c,spatialReference:t.view.spatialReference}),t.pointSymbol)),a&&a.complete()})],a=new d({complete:function(){t._graphics.remove(t.graphic),r&&r.reset(),c.forEach(function(e){return e.remove()}),a.emit("complete")},cancel:function(){t._graphics.remove(t.graphic),r&&r.reset(),c.forEach(function(e){return e.remove()}),a.emit("cancel")}});return a},t.prototype._createPolygonOperation=function(e){var t=this,i=this.draw.create("polygon",e),r=new o.Point,c=null,a=null,s=!1,l=[i.on("vertex-add",function(e){var i=e.vertices;a=e,s&&t._snapLastVertexToAxis(i),t._showPolygonGraphic(i,!1)}),i.on("vertex-remove",function(e){var i=e.vertices;a=e,s&&t._snapLastVertexToAxis(i),t._showPolygonGraphic(i,!1)}),i.on("vertex-update",function(e){var i=e.vertices;a=e,s&&t._snapLastVertexToAxis(i),t._showPolygonGraphic(i,!1)}),i.on("cursor-update",function(e){var i=e.vertices,o=e.native;a=e,t.view.toMap(o.x,o.y,r),s&&t._snapLastVertexToAxis(i),t._showPolygonGraphic(i,!0)}),i.on("draw-complete",function(e){t._graphics.remove(t.graphic),t._set("graphic",new n(w.createPolygon([e.vertices],t.view),t.polygonSymbol)),p&&p.complete()}),i.on("undo",function(e){var i=e.vertices,r=a&&"cursor-update"===a.type;if(!i.length)return void t._clearGraphics();s&&t._snapLastVertexToAxis(i),t._showPolygonGraphic(i,r)}),i.on("redo",function(e){var i=e.vertices,r=a&&"cursor-update"===a.type;s&&t._snapLastVertexToAxis(i),t._showPolygonGraphic(i,r)}),this.view.on("key-down",function(e){var r=i.vertices.slice(0),o=a&&"cursor-update"===a.type;e.key!==_.constraintKey||s?e.key===_.undoKey?(e.stopPropagation(),i.canUndo()&&i.undo()):e.key===_.redoKey&&(e.stopPropagation(),i.canRedo()&&i.redo()):(s=!0,o&&t._snapLastVertexToAxis(r),t._showPolygonGraphic(r,o))}),this.view.on("key-up",function(e){var o=i.vertices.slice(0),n=a&&"cursor-update"===a.type;e.key===_.constraintKey&&(s=!1,o.pop(),o.push([r.x,r.y]),t._showPolygonGraphic(o,n))}),this.view.on("pointer-down",function(e){t.view.hitTest(e).then(function(i){var r=i.results;if(r.length&&r[0].graphic){var o=r[0].graphic;0===t._vertexGraphics.indexOf(o)&&e.stopPropagation()}})}),this.view.on("click",function(e){t.view.hitTest(e).then(function(r){var o=r.results;if(o.length&&o[0].graphic){var n=o[0].graphic;0===t._vertexGraphics.indexOf(n)&&t._vertexGraphics.length>2&&(e.stopPropagation(),a&&"cursor-update"===a.type&&i.vertices.pop(),i.complete())}})}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){c=t._displayCrosshairCursor()})})],p=new d({complete:function(){t._clearGraphics(),t._graphics.remove(t.graphic),c&&c.reset(),l.forEach(function(e){return e.remove()}),p.emit("complete")},cancel:function(){t._clearGraphics(),t._graphics.remove(t.graphic),c&&c.reset(),l.forEach(function(e){return e.remove()}),p.emit("cancel")}});return p},t.prototype._createPolylineOperation=function(e){var t=this,i=this.draw.create("polyline",e),r=new o.Point,c=null,a=null,s=!1,l=[i.on("vertex-add",function(e){var i=e.vertices;c=e,s&&t._snapLastVertexToAxis(i),t._showPolylineGraphic(i,!1)}),i.on("vertex-remove",function(e){var i=e.vertices;c=e,s&&t._snapLastVertexToAxis(i),t._showPolylineGraphic(i,!1)}),i.on("vertex-update",function(e){var i=e.vertices;c=e,s&&t._snapLastVertexToAxis(i),t._showPolylineGraphic(i,!1)}),i.on("cursor-update",function(e){var i=e.vertices,o=e.native;c=e,t.view.toMap(o.x,o.y,r),s&&t._snapLastVertexToAxis(i),t._showPolylineGraphic(i,!0)}),i.on("draw-complete",function(e){t._graphics.remove(t.graphic),t._set("graphic",new n(w.createPolyline([e.vertices],t.view),t.polylineSymbol)),p&&p.complete()}),i.on("undo",function(e){var i=e.vertices,r=c&&"cursor-update"===c.type;if(!i.length)return void t._clearGraphics();s&&t._snapLastVertexToAxis(i),t._showPolylineGraphic(i,r)}),i.on("redo",function(e){var i=e.vertices,r=c&&"cursor-update"===c.type;s&&t._snapLastVertexToAxis(i),t._showPolylineGraphic(i,r)}),this.view.on("key-down",function(e){var r=i.vertices.slice(0),o=c&&"cursor-update"===c.type;e.key!==_.constraintKey||s?e.key===_.undoKey?(e.stopPropagation(),i.canUndo()&&i.undo()):e.key===_.redoKey&&(e.stopPropagation(),i.canRedo()&&i.redo()):(s=!0,o&&t._snapLastVertexToAxis(r),t._showPolylineGraphic(r,o))}),this.view.on("key-up",function(e){var o=i.vertices.slice(0),n=c&&"cursor-update"===c.type;e.key===_.constraintKey&&(s=!1,o.pop(),o.push([r.x,r.y]),t._showPolylineGraphic(o,n))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){a=t._displayCrosshairCursor()})})],p=new d({complete:function(){t._clearGraphics(),t._graphics.remove(t.graphic),a&&a.reset(),l.forEach(function(e){return e.remove()}),p.emit("complete")},cancel:function(){t._clearGraphics(),t._graphics.remove(t.graphic),a&&a.reset(),l.forEach(function(e){return e.remove()}),p.emit("cancel")}});return p},t.prototype._createRectangleOperation=function(e){var t=this,i=this.draw.create("rectangle",e),r=null,o=!1,c=!1,a=[i.on("vertex-add",function(e){t._showRectangleGraphic(e.vertices,c,o)}),i.on("cursor-update",function(e){t._showRectangleGraphic(e.vertices,c,o)}),i.on("draw-complete",function(e){t._graphics.remove(t.graphic);var i=e.vertices.slice(0);if(1===i.length){o=!1,c=!1;var r=t.view.toScreen(i[0][0],i[0][1],null),a=t.view.toMap(r.x-t._defaultSegmentOffset,r.y+t._defaultSegmentOffset),l=t.view.toMap(r.x+t._defaultSegmentOffset,r.y-t._defaultSegmentOffset);i=[[a.x,a.y],[l.x,l.y]]}var p=o?w.createSquare(i,t.view,c):w.createRectangle(i,t.view,c);t._set("graphic",new n(p,t.polygonSymbol)),s&&s.complete()}),this.view.on("key-down",function(e){e.key!==_.constraintKey||o?e.key!==_.centerKey||c||(c=!0,t._showRectangleGraphic(i.vertices,c,o)):(o=!0,t._showRectangleGraphic(i.vertices,c,o))}),this.view.on("key-up",function(e){e.key===_.constraintKey?(o=!1,t._showRectangleGraphic(i.vertices,c,o)):e.key===_.centerKey&&(c=!1,t._showRectangleGraphic(i.vertices,c,o))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){r=t._displayCrosshairCursor()})})],s=new d({complete:function(){t._clearGraphics(),t._graphics.remove(t.graphic),r&&r.reset(),a.forEach(function(e){return e.remove()}),s.emit("complete")},cancel:function(){t._clearGraphics(),t._graphics.remove(t.graphic),r&&r.reset(),a.forEach(function(e){return e.remove()}),s.emit("cancel")}});return s},t.prototype._createMultipointOperation=function(e){var t=this,i=this.draw.create("multipoint",e),r=null,o=[i.on("vertex-add",function(e){t._showMultipointGraphic(e.vertices)}),i.on("vertex-remove",function(e){t._showMultipointGraphic(e.vertices)}),i.on("vertex-update",function(e){t._showMultipointGraphic(e.vertices)}),i.on("cursor-update",function(e){t._showMultipointGraphic(e.vertices)}),i.on("draw-complete",function(e){t._graphics.remove(t.graphic),t._set("graphic",new n(w.createMultipoint(e.vertices,t.view),t.pointSymbol)),c&&c.complete()}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){r=t._displayCrosshairCursor()})})],c=new d({complete:function(){t._clearGraphics(),t._graphics.remove(t.graphic),r&&r.reset(),o.forEach(function(e){return e.remove()}),c.emit("complete")},cancel:function(){t._clearGraphics(),t._graphics.remove(t.graphic),r&&r.reset(),o.forEach(function(e){return e.remove()}),c.emit("cancel")}});return c},t.prototype._createCircleOperation=function(e){var t=this,i=this.draw.create("circle",e),r=null,c=!1,a=!1,s=[i.on("vertex-add",function(e){t._showCircleGraphic(e.vertices,a,c)}),i.on("cursor-update",function(e){t._showCircleGraphic(e.vertices,a,c)}),i.on("draw-complete",function(e){t._graphics.remove(t.graphic);var r=e.vertices.slice(0);if(1===r.length){c=!1,a=!0;var s=t.view.toScreen(r[0][0],r[0][1],null),p=new o.ScreenPoint({x:s.x+t._defaultSegmentOffset,y:s.y});r.push(i.getCoordsFromScreenPoint(p))}var h=c?w.createEllipse(r,t.view,a):w.createCircle(r,t.view,a);t._set("graphic",new n(h,t.polygonSymbol)),l&&l.complete()}),this.view.on("key-down",function(e){e.key!==_.constraintKey||c?e.key!==_.centerKey||a||(a=!0,t._showCircleGraphic(i.vertices,a,c)):(c=!0,t._showCircleGraphic(i.vertices,a,c))}),this.view.on("key-up",function(e){e.key===_.constraintKey?(c=!1,t._showCircleGraphic(i.vertices,a,c)):e.key===_.centerKey&&(a=!1,t._showCircleGraphic(i.vertices,a,c))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){r=t._displayCrosshairCursor()})})],l=new d({complete:function(){t._clearGraphics(),t._graphics.remove(t.graphic),r&&r.reset(),s.forEach(function(e){return e.remove()}),l.emit("complete")},cancel:function(){t._clearGraphics(),t._graphics.remove(t.graphic),r&&r.reset(),s.forEach(function(e){return e.remove()}),l.emit("cancel")}});return l},t.prototype._createEllipseOperation=function(e){var t=this,i=this.draw.create("ellipse",e),r=null,c=!1,a=!1,s=[i.on("vertex-add",function(e){t._showEllipseGraphic(e.vertices,a,c)}),i.on("cursor-update",function(e){t._showEllipseGraphic(e.vertices,a,c)}),i.on("draw-complete",function(e){t._graphics.remove(t.graphic);var r=e.vertices.slice(0);if(1===r.length){c=!0,a=!0;var s=t.view.toScreen(r[0][0],r[0][1],null),p=new o.ScreenPoint({x:s.x+t._defaultSegmentOffset,y:s.y});r.push(i.getCoordsFromScreenPoint(p))}var h=c?w.createCircle(r,t.view,a):w.createEllipse(r,t.view,a);t._set("graphic",new n(h,t.polygonSymbol)),l&&l.complete()}),this.view.on("key-down",function(e){e.key!==_.constraintKey||c?"Alt"!==e.key||a||(a=!0,t._showEllipseGraphic(i.vertices,a,c)):(c=!0,t._showEllipseGraphic(i.vertices,a,c))}),this.view.on("key-up",function(e){e.key===_.constraintKey?(c=!1,t._showEllipseGraphic(i.vertices,a,c)):e.key===_.centerKey&&(a=!1,t._showEllipseGraphic(i.vertices,a,c))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){r=t._displayCrosshairCursor()})})],l=new d({complete:function(){t._clearGraphics(),t._graphics.remove(t.graphic),r&&r.reset(),s.forEach(function(e){return e.remove()}),l.emit("complete")},cancel:function(){t._clearGraphics(),t._graphics.remove(t.graphic),r&&r.reset(),s.forEach(function(e){return e.remove()}),l.emit("cancel")}});return l},t.prototype._createTriangleOperation=function(e){var t=this,i=this.draw.create("triangle",e),r=null,c=!1,a=!1,s=[i.on("vertex-add",function(e){t._showTriangleGraphic(e.vertices,a,c)}),i.on("cursor-update",function(e){t._showTriangleGraphic(e.vertices,a,c)}),i.on("draw-complete",function(e){t._graphics.remove(t.graphic);var r=e.vertices.slice(0);if(1===r.length){c=!0,a=!0;var s=t.view.toScreen(r[0][0],r[0][1],null),p=new o.ScreenPoint({x:s.x+t._defaultSegmentOffset,y:s.y});r.push(i.getCoordsFromScreenPoint(p))}t._set("graphic",new n(w.createTriangle(r,t.view,a,c),t.polygonSymbol)),l&&l.complete()}),this.view.on("key-down",function(e){e.key!==_.constraintKey||c?e.key!==_.centerKey||a||(a=!0,t._showTriangleGraphic(i.vertices,a,c)):(c=!0,t._showTriangleGraphic(i.vertices,a,c))}),this.view.on("key-up",function(e){e.key===_.constraintKey?(c=!1,t._showTriangleGraphic(i.vertices,a,c)):e.key===_.centerKey&&(a=!1,t._showTriangleGraphic(i.vertices,a,c))}),this.view.on("pointer-move",function(e){t.view.hitTest(e).then(function(e){r=t._displayCrosshairCursor()})})],l=new d({complete:function(){t._clearGraphics(),t._graphics.remove(t.graphic),r&&r.reset(),s.forEach(function(e){return e.remove()}),l.emit("complete")},cancel:function(){t._clearGraphics(),t._graphics.remove(t.graphic),r&&r.reset(),s.forEach(function(e){return e.remove()}),l.emit("cancel")}});return l},t.prototype._updatePointOperation=function(e,t){var i=this,r=!1,o=!1,c=null,a=new n(e,this.updatePointSymbol);this._graphics.add(a),this._set("graphic",a.clone());var s=[this.view.on("click",function(t){i.view.hitTest(t).then(function(t){var i=t.results;i.length&&i[0].graphic&&i[0].graphic===a||(a.geometry!==e?l&&l.complete():l&&l.cancel())})}),this.view.on("pointer-down",function(e){o=!1,r=!0,i.view.hitTest(e).then(function(e){r=!(!e.results||!e.results[0]||e.results[0].graphic!==a)})}),this.view.on("pointer-move",function(e){o=!0,i.view.hitTest(e).then(function(e){var t=e.results;if(t.length&&t[0].graphic){t[0].graphic===a?c=i._displayPointerCursor():(c&&c.reset(),c=null)}else c&&c.reset(),c=null})}),this.view.on("pointer-up",function(e){if(r&&(e.stopPropagation(),r=!1,o)){o=!1;var t=i.view.toMap(e.x,e.y);a.set("geometry",t),i.graphic.set("geometry",t)}}),this.view.on("drag",function(e){r&&(e.stopPropagation(),a.set("geometry",i.view.toMap(e.x,e.y)))})],l=new d({complete:function(){i._graphics.remove(a),s.forEach(function(e){return e.remove()}),c&&c.reset(),i.graphic.set("geometry",a.geometry),l.emit("complete")},cancel:function(){i._graphics.remove(a),s.forEach(function(e){return e.remove()}),c&&c.reset(),i.graphic.set("geometry",a.geometry),l.emit("cancel")}});return l},t.prototype._updatePolygonOperation=function(e,t){var i=this,r=w.getVerticesForPolygon(e),c=!1,a=!1,s=null,l=new n(e,this.updatePolygonSymbol);this._graphics.add(l),this._set("graphic",l.clone());var p=new f({pointSymbol:this.vertexSymbol,pointHoverSymbol:this.hoverVertexSymbol,selectedPointSymbol:this.selectedVertexSymbol,layer:this._graphics,view:this.view}),h=p.update({vertices:r,handles:{onMoveStart:function(e){l.set("geometry",new o.Polygon({rings:e.vertices,spatialReference:i.view.spatialReference}))},onMove:function(e){l.set("geometry",new o.Polygon({rings:e.vertices,spatialReference:i.view.spatialReference}))},onMoveStop:function(e){var t=new o.Polygon({rings:e.vertices,spatialReference:i.view.spatialReference});i.graphic.set("geometry",t),l.set("geometry",t)},onSelect:function(e){},onDeselect:function(e){}}}),u=[this.view.on("click",function(t){i.view.hitTest(t).then(function(t){if(t.results.length&&t.results[0].graphic){var i=t.results[0].graphic;if(i===l||p.graphics.indexOf(i)>-1)return}l.geometry!==e?y&&y.complete():y&&y.cancel()})}),this.view.on("pointer-down",function(e){a=!1,c=!1,i.view.hitTest(e).then(function(e){var t=e.results;c=!(!t.length||t[0].graphic!==l)})}),this.view.on("pointer-move",function(e){a=!0,i.view.hitTest(e).then(function(e){var t=e.results;if(t.length&&t[0].graphic){var r=t[0].graphic,o=p.graphics;r===l||o.indexOf(r)>-1?s=i._displayPointerCursor():(s&&s.reset(),s=null)}else s&&s.reset(),s=null})}),this.view.on("pointer-up",function(e){if(c&&a){var t=w.getVerticesForPolygon(l.geometry);i.graphic.set("geometry",l.geometry),p.set("vertices",t),p.refresh()}}),this.view.on("drag",function(e){if(c){e.stopPropagation();var t=e.x-e.origin.x,r=e.y-e.origin.y,o=w.movePolygon(i.graphic.geometry,i.view,t,r);l.set("geometry",o),p.reset()}})],y=new d({complete:function(){p.destroy(),i._graphics.remove(l),h.remove(),u.forEach(function(e){return e.remove()}),s&&s.reset();var e=w.getVerticesForPolygon(l.geometry);i.graphic.set("geometry",w.createPolygon(e,i.view)),y.emit("complete")},cancel:function(){p.destroy(),i._graphics.remove(l),h.remove(),u.forEach(function(e){return e.remove()}),s&&s.reset();var e=w.getVerticesForPolygon(l.geometry);i.graphic.set("geometry",w.createPolygon(e,i.view)),y.emit("cancel")}});return y},t.prototype._updatePolylineOperation=function(e,t){var i=this,r=w.getVerticesForPolyline(e),c=!1,a=!1,s=null,l=new n(e,this.updatePolylineSymbol);this._graphics.add(l),this._set("graphic",l.clone());var p=new f({pointSymbol:this.vertexSymbol,pointHoverSymbol:this.hoverVertexSymbol,selectedPointSymbol:this.selectedVertexSymbol,layer:this._graphics,view:this.view}),h=p.update({vertices:r,handles:{onMoveStart:function(e){l.set("geometry",new o.Polyline({paths:e.vertices,spatialReference:i.view.spatialReference}))},onMove:function(e){l.set("geometry",new o.Polyline({paths:e.vertices,spatialReference:i.view.spatialReference}))},onMoveStop:function(e){var t=new o.Polyline({paths:e.vertices,spatialReference:i.view.spatialReference});i.graphic.set("geometry",t),l.set("geometry",t)},onSelect:function(e){},onDeselect:function(e){}}}),u=[this.view.on("click",function(t){i.view.hitTest(t).then(function(t){if(t.results.length&&t.results[0].graphic){var i=t.results[0].graphic;if(i===l||p.graphics.indexOf(i)>-1)return}l.geometry!==e?y&&y.complete():y&&y.cancel()})}),this.view.on("pointer-down",function(e){a=!1,c=!1,i.view.hitTest(e).then(function(e){var t=e.results;c=!(!t.length||t[0].graphic!==l)})}),this.view.on("pointer-move",function(e){a=!0,i.view.hitTest(e).then(function(e){var t=e.results;if(t.length&&t[0].graphic){var r=t[0].graphic,o=p.graphics;r===l||o.indexOf(r)>-1?s=i._displayPointerCursor():(s&&s.reset(),s=null)}else s&&s.reset(),s=null})}),this.view.on("pointer-up",function(e){if(c&&a){var t=w.getVerticesForPolyline(l.geometry);i.graphic.set("geometry",l.geometry),p.set("vertices",t),p.refresh()}}),this.view.on("drag",function(e){if(c){e.stopPropagation();var t=e.x-e.origin.x,r=e.y-e.origin.y,o=w.movePolyline(i.graphic.geometry,i.view,t,r);l.set("geometry",o),p.reset()}})],y=new d({complete:function(){p.destroy(),i._graphics.remove(l),h.remove(),u.forEach(function(e){return e.remove()}),s&&s.reset();var e=w.getVerticesForPolyline(l.geometry);i.graphic.set("geometry",w.createPolyline(e,i.view)),y.emit("complete")},cancel:function(){p.destroy(),i._graphics.remove(l),h.remove(),u.forEach(function(e){return e.remove()}),s&&s.reset();var e=w.getVerticesForPolyline(l.geometry);i.graphic.set("geometry",w.createPolyline(e,i.view)),y.emit("cancel")}});return y},t.prototype._showPolygonGraphic=function(e,t){var i=this;this._graphics.remove(this.graphic),this._clearGraphics();var r=e.length>2?w.createPolygon([e],this.view):w.createPolyline([e],this.view);if(this._set("graphic",new n(r,this.polygonSymbol)),t){var c=e.map(function(e){return Array.apply([],e)}),a=c.pop(),s=[c[c.length-1],a];e.length>2&&(this._fillGraphic=new n(w.createPolygon([c],this.view),this.activeFillSymbol),this._graphics.add(this._fillGraphic)),e.length>1&&(this._lineGraphic=new n(w.createPolyline([c],this.view),this.polylineSymbol),this._graphics.add(this._lineGraphic),this._activeLineGraphic=new n(w.createPolyline(s,this.view),this.activeLineSymbol),this._graphics.add(this._activeLineGraphic)),c.forEach(function(e,t){var r=t===c.length-1?i.activePointSymbol:i.pointSymbol,a=new n({geometry:new o.Point({x:e[0],y:e[1],spatialReference:i.view.spatialReference}),symbol:r});i._vertexGraphics.push(a),i._graphics.add(a)})}else e.length>2&&(this._fillGraphic=new n(r,this.activeFillSymbol),this._graphics.add(this._fillGraphic)),this._lineGraphic=new n(w.createPolyline([e],this.view),this.polylineSymbol),this._graphics.add(this._lineGraphic),e.forEach(function(t,r){var c=r===e.length-1?i.activePointSymbol:i.pointSymbol,a=new n({geometry:new o.Point({x:t[0],y:t[1],spatialReference:i.view.spatialReference}),symbol:c});i._vertexGraphics.push(a),i._graphics.add(a)})},t.prototype._showPolylineGraphic=function(e,t){var i=this;if(this._graphics.remove(this.graphic),this._clearGraphics(),this._set("graphic",new n(w.createPolyline([e],this.view),this.polylineSymbol)),t){var r=e.map(function(e){return Array.apply([],e)}),c=r.pop(),a=[r[r.length-1],c];e.length>1&&(this._lineGraphic=new n(w.createPolyline(r,this.view),this.polylineSymbol),this._graphics.add(this._lineGraphic),this._activeLineGraphic=new n(w.createPolyline(a,this.view),this.activeLineSymbol),this._graphics.add(this._activeLineGraphic)),r.forEach(function(e,t){var c=t===r.length-1?i.activePointSymbol:i.pointSymbol,a=new n({geometry:new o.Point({x:e[0],y:e[1],spatialReference:i.view.spatialReference}),symbol:c});i._vertexGraphics.push(a),i._graphics.add(a)})}else this._lineGraphic=new n(w.createPolyline([e],this.view),this.polylineSymbol),this._graphics.add(this._lineGraphic),e.forEach(function(t,r){var c=r===e.length-1?i.activePointSymbol:i.pointSymbol,a=new n({geometry:new o.Point({x:t[0],y:t[1],spatialReference:i.view.spatialReference}),symbol:c});i._vertexGraphics.push(a),i._graphics.add(a)})},t.prototype._showRectangleGraphic=function(e,t,i){if(this._graphics.remove(this.graphic),this._clearGraphics(),!(e.length<2)){var r=i?w.createSquare(e,this.view,t):w.createRectangle(e,this.view,t);this._toggleCenterGraphic(r),this._set("graphic",new n(r,this.polygonSymbol)),this._graphics.add(this.graphic)}},t.prototype._showMultipointGraphic=function(e){this._graphics.remove(this.graphic),this._set("graphic",new n(w.createMultipoint(e,this.view),this.pointSymbol)),this._graphics.add(this.graphic)},t.prototype._showCircleGraphic=function(e,t,i){if(this._graphics.remove(this.graphic),this._clearGraphics(),!(e.length<2)){var r=i?w.createEllipse(e,this.view,t):w.createCircle(e,this.view,t);this._toggleCenterGraphic(r),this._set("graphic",new n(r,this.polygonSymbol)),this._graphics.add(this.graphic)}},t.prototype._showEllipseGraphic=function(e,t,i){if(this._graphics.remove(this.graphic),this._clearGraphics(),!(e.length<2)){var r=i?w.createCircle(e,this.view,t):w.createEllipse(e,this.view,t);this._toggleCenterGraphic(r),this._set("graphic",new n(r,this.polygonSymbol)),this._graphics.add(this.graphic)}},t.prototype._showTriangleGraphic=function(e,t,i){if(this._graphics.remove(this.graphic),this._clearGraphics(),!(e.length<2)){var r=w.createTriangle(e,this.view,t,i);this._toggleCenterGraphic(r),this._set("graphic",new n(r,this.polygonSymbol)),this._graphics.add(this.graphic)}},t.prototype._toggleCenterGraphic=function(e){this._graphics.remove(this._centerGraphic),this._centerGraphic=null,e&&e.extent&&e.extent.center&&(this._centerGraphic=new n(e.extent.center,this._centerSymbol),this._graphics.add(this._centerGraphic))},t.prototype._clearGraphics=function(){this._toggleCenterGraphic(),this._graphics.remove(this._fillGraphic),this._fillGraphic=null,this._graphics.remove(this._lineGraphic),this._lineGraphic=null,this._graphics.remove(this._activeLineGraphic),this._activeLineGraphic=null,this._graphics.removeMany(this._vertexGraphics),this._vertexGraphics=[]},t.prototype._snapLastVertexToAxis=function(e){if(!(e.length<2)){var t=e.pop(),i=e[e.length-1],r=this.view.toScreen(t[0],t[1],null),o=this.view.toScreen(i[0],i[1],null),n=Math.abs(r.x-o.x),c=Math.abs(r.y-o.y),a=this.view.toMap(n>c?r.x:o.x,n>c?o.y:r.y);e.push([a.x,a.y])}},t.prototype._displayCrosshairCursor=function(){var e=this;return"crosshair"!==this.view.container.style.cursor&&(this.view.container.style.cursor="crosshair"),new m({reset:function(){"default"!==e.view.container.style.cursor&&(e.view.container.style.cursor="default")}})},t.prototype._displayPointerCursor=function(){var e=this;return"pointer"!==this.view.container.style.cursor&&(this.view.container.style.cursor="pointer"),new m({reset:function(){"default"!==e.view.container.style.cursor&&(e.view.container.style.cursor="default")}})},r([p.property()],t.prototype,"activeFillSymbol",void 0),r([p.property()],t.prototype,"activeLineSymbol",void 0),r([p.property()],t.prototype,"activePointSymbol",void 0),r([p.property({readOnly:!0})],t.prototype,"draw",void 0),r([p.property({readOnly:!0})],t.prototype,"graphic",void 0),r([p.property()],t.prototype,"hoverVertexSymbol",void 0),r([p.property()],t.prototype,"layer",void 0),r([p.property()],t.prototype,"pointSymbol",void 0),r([p.property()],t.prototype,"polygonSymbol",void 0),r([p.property()],t.prototype,"polylineSymbol",void 0),r([p.property()],t.prototype,"selectedVertexSymbol",void 0),r([p.property({dependsOn:["view.ready"],readOnly:!0})],t.prototype,"state",null),r([p.property()],t.prototype,"view",void 0),t=r([p.subclass("esri.widgets.Sketch.SketchViewModel")],t)}(p.declared(c,a))});