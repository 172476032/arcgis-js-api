// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/i18n!../nls/DatePicker","dojo/keys","../../../moment","../../../core/accessorSupport/decorators","../../Widget","./DatePickerViewModel","../../support/widget"],function(e,t,r,a,i,o,s,n,d,c,l){var h={base:"esri-date-picker esri-widget",datePicker:"esri-date-picker__calendar",monthPicker:"esri-date-picker__month-picker",dayPicker:"esri-date-picker__day-picker",week:"esri-date-picker__week-item",nearbyMonth:"esri-date-picker__day-item--nearby-month",activeDay:"esri-date-picker__day-item--active",today:"esri-date-picker__day-item--today",selectedDay:"esri-date-picker__day-item--selected",day:"esri-date-picker__day-item",dayHeader:"esri-date-picker__day-item--header",yearPicker:"esri-date-picker__year-picker",selectedYear:"esri-date-picker__year-picker-item--selected",year:"esri-date-picker__year-picker-item",monthDropdown:"esri-date-picker__month-dropdown",date:"esri-date-picker__date",datePickerToggle:"esri-date-picker__calendar-toggle",openIcon:"esri-icon-down-arrow",closeIcon:"esri-icon-up-arrow",previousIcon:"esri-icon-left",nextIcon:"esri-icon-right",button:"esri-widget-button"},_=[o.DOWN_ARROW,o.END,o.ENTER,o.HOME,o.LEFT_ARROW,o.PAGE_DOWN,o.PAGE_UP,o.RIGHT_ARROW,o.SPACE,o.UP_ARROW];return function(e){function t(t){var r=e.call(this)||this;return r._activeDate=null,r._calendarNode=null,r._closedByUserAction=!1,r._isOpen=!1,r._rootNode=null,r.value=null,r.viewModel=new c,r}return r(t,e),t.prototype.render=function(){var e=this.viewModel.value.format("L"),t=this._isOpen,r=(a={},a[h.openIcon]=!t,a[h.closeIcon]=t,a);return l.tsx("div",{afterCreate:l.storeNode,bind:this,class:h.base,"data-node-ref":"_rootNode"},l.tsx("div",{afterUpdate:this._focusSelectedOrClosed,"aria-pressed":t.toString(),bind:this,class:l.join(h.button,h.datePickerToggle),onclick:this._toggle,onkeydown:this._toggle,role:"button",tabIndex:0},l.tsx("span",{class:h.date},e),l.tsx("span",{"aria-hidden":"true",classes:r})),t?this._renderCalendar():null);var a},t.prototype._focusSelectedOrClosed=function(e){this._closedByUserAction&&(this._closedByUserAction=!1,e.focus())},t.prototype._handleDatePickerKeydown=function(e){e.keyCode===o.ESCAPE&&(this._closedByUserAction=!0,this._close(),e.preventDefault(),e.stopPropagation())},t.prototype._renderCalendar=function(){var e=this._activeDate,t=this.get("viewModel.value");return l.tsx("div",{afterCreate:l.storeNode,bind:this,class:h.datePicker,"data-node-ref":"_calendarNode",key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))},t.prototype._handleDatePickerBlur=function(e){var t=e.relatedTarget;this._calendarNode.contains(t)||this._rootNode.contains(t)||this._close()},t.prototype._renderMonthPicker=function(e){var t=s.months().map(function(t,r){var a=e.month()===r;return l.tsx("option",{selected:a},t)});return l.tsx("div",{class:h.monthPicker},l.tsx("div",{"aria-label":i.goToPreviousMonth,bind:this,class:h.button,onblur:this._handleDatePickerBlur,onclick:this._setPreviousMonth,onkeydown:this._setPreviousMonth,role:"button",tabIndex:0,title:i.goToPreviousMonth},l.tsx("span",{"aria-hidden":"true",class:h.previousIcon})),l.tsx("select",{"aria-live":"assertive",bind:this,class:h.monthDropdown,id:this.id+"__month-picker",onblur:this._handleDatePickerBlur,onchange:this._setMonth,onkeydown:this._setMonth},t),l.tsx("div",{"aria-label":i.goToNextMonth,bind:this,class:h.button,onblur:this._handleDatePickerBlur,onclick:this._setNextMonth,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:i.goToNextMonth},l.tsx("span",{"aria-hidden":"true",class:h.nextIcon})))},t.prototype._renderDayPicker=function(e,t){var r=e.clone().day(s.localeData().firstDayOfWeek()),a=this._getWeekLabels(r),i=this._getDayId(e),o=this._renderMonth(e,t);return l.tsx("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":i,"aria-labelledby":this.id+"__month-picker "+this.id+"__selected-year",bind:this,class:h.dayPicker,id:this.id+"__day-picker",onblur:this._handleDatePickerBlur,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},l.tsx("div",{class:h.week,role:"row"},a.map(function(e){return l.tsx("div",{"aria-label":e.name,class:l.join(h.day,h.dayHeader),role:"columnheader",title:e.name},e.abbr)})),o)},t.prototype._getDayId=function(e){return this.id+"__"+e.format("YYYY-MM-DD")},t.prototype._handleDayPickerCreate=function(e){e.focus()},t.prototype._getWeekLabels=function(e){for(var t=[],r=0;r<7;r++)t.push({name:e.format("dddd"),abbr:e.format("dd")}),e.add(1,"day");return t},t.prototype._handleDayPickerKeydown=function(e){var t=e.keyCode,r=e.ctrlKey,a=e.shiftKey,i=this._activeDate;if(-1!==_.indexOf(t)){if(t===o.LEFT_ARROW)i.subtract(1,"day");else if(t===o.RIGHT_ARROW)i.add(1,"day");else if(t===o.UP_ARROW)i.subtract(1,"week");else if(t===o.DOWN_ARROW)i.add(1,"week");else if(t===o.PAGE_UP){var s=a?"year":"month";i.subtract(1,s)}else if(t===o.PAGE_DOWN){var s=a?"year":"month";i.add(1,s)}else if(t===o.HOME){var s=r?"year":"month";i.startOf(s)}else if(t===o.END){var s=r?"year":"month";i.endOf(s)}else t!==o.ENTER&&t!==o.SPACE||(this.viewModel.value=i.clone(),this._closedByUserAction=!0,this._close());e.preventDefault(),e.stopPropagation()}},t.prototype._renderMonth=function(e,t){for(var r=s(),a=s.localeData(),i=e.clone().startOf("month"),o=e.clone().endOf("month"),n=i.clone().subtract(i.weekday()-a.firstDayOfWeek(),"day"),d=n,c=[],_=0;_<6;_++){for(var p=[],u=0;u<7;u++){var y=d.date(),v=d.isSame(e,"day"),k=d.isSame(t,"day"),f=this._getDayId(d),b=(P={},P[h.nearbyMonth]=!d.isBetween(i,o,null,"[]"),P[h.today]=d.isSame(r,"day"),P[h.activeDay]=v,P[h.selectedDay]=k,P);p.push(l.tsx("div",{"aria-label":y.toString(),"aria-selected":v.toString(),bind:this,class:h.day,"data-iso-date":d.toISOString(),classes:b,id:f,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},y)),d.add(1,"day")}c.push(l.tsx("div",{class:h.week,role:"row"},p))}return c;var P},t.prototype._renderYearPicker=function(e){var t=e.clone(),r=t.format("YYYY"),a=t.add(1,"year").format("YYYY"),o=t.subtract(2,"year").format("YYYY");return l.tsx("div",{class:h.yearPicker},l.tsx("div",{"aria-label":i.goToPreviousYear,bind:this,class:h.year,onblur:this._handleDatePickerBlur,onclick:this._setPreviousYear,onkeydown:this._setPreviousYear,tabIndex:0,title:i.goToPreviousYear},o),l.tsx("div",{class:l.join(h.year,h.selectedYear),id:this.id+"__selected-year"},r),l.tsx("div",{"aria-label":i.goToNextYear,bind:this,class:h.year,onblur:this._handleDatePickerBlur,onclick:this._setNextYear,onkeydown:this._setNextYear,tabIndex:0,title:i.goToNextYear},a))},t.prototype._toggle=function(){if(this._isOpen)return void this._close();this._open(this.viewModel.value.clone())},t.prototype._setMonth=function(e){var t=e.target,r=t.item(t.selectedIndex).value;this._activeDate.month(r)},t.prototype._close=function(){this._activeDate=null,this._isOpen=!1},t.prototype._open=function(e){this._activeDate=e,this._isOpen=!0},t.prototype._setPreviousMonth=function(){this._activeDate.subtract(1,"month")},t.prototype._setNextMonth=function(){this._activeDate.add(1,"month")},t.prototype._setPreviousYear=function(){this._activeDate.subtract(1,"year")},t.prototype._setNextYear=function(){this._activeDate.add(1,"year")},t.prototype._handleSelectedDate=function(e){var t=e.target;this.viewModel.value=s(t.getAttribute("data-iso-date")),this._closedByUserAction=!0,this._close()},a([n.aliasOf("viewModel.value")],t.prototype,"value",void 0),a([n.property({type:c}),l.renderable("viewModel.value")],t.prototype,"viewModel",void 0),a([l.accessibleHandler()],t.prototype,"_toggle",null),a([l.accessibleHandler()],t.prototype,"_setPreviousMonth",null),a([l.accessibleHandler()],t.prototype,"_setNextMonth",null),a([l.accessibleHandler()],t.prototype,"_setPreviousYear",null),a([l.accessibleHandler()],t.prototype,"_setNextYear",null),a([l.accessibleHandler()],t.prototype,"_handleSelectedDate",null),t=a([n.subclass("esri.widgets.Directions.support.DatePicker")],t)}(n.declared(d))});