// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../support/widget","../../../core/accessorSupport/decorators","../../Widget","../../../moment","./DatePickerViewModel","dojo/keys","dojo/i18n!../nls/DatePicker"],function(e,t,r,a,i,o,s,n,d,c,l){var h={base:"esri-date-picker esri-widget",datePicker:"esri-date-picker__calendar",monthPicker:"esri-date-picker__month-picker",dayPicker:"esri-date-picker__day-picker",week:"esri-date-picker__week-item",nearbyMonth:"esri-date-picker__day-item--nearby-month",activeDay:"esri-date-picker__day-item--active",today:"esri-date-picker__day-item--today",selectedDay:"esri-date-picker__day-item--selected",day:"esri-date-picker__day-item",dayHeader:"esri-date-picker__day-item--header",yearPicker:"esri-date-picker__year-picker",selectedYear:"esri-date-picker__year-picker-item--selected",year:"esri-date-picker__year-picker-item",monthDropdown:"esri-date-picker__month-dropdown",date:"esri-date-picker__date",datePickerToggle:"esri-date-picker__calendar-toggle",openIcon:"esri-icon-down-arrow",closeIcon:"esri-icon-up-arrow",previousIcon:"esri-icon-left",nextIcon:"esri-icon-right",button:"esri-widget-button"},_="L",p="YYYY-MM-DD",u=[c.DOWN_ARROW,c.END,c.ENTER,c.HOME,c.LEFT_ARROW,c.PAGE_DOWN,c.PAGE_UP,c.RIGHT_ARROW,c.SPACE,c.UP_ARROW],y=function(e){function t(t){var r=e.call(this)||this;return r._activeDate=null,r._calendarNode=null,r._closedByUserAction=!1,r._isOpen=!1,r._rootNode=null,r.value=null,r.viewModel=new d,r}return r(t,e),t.prototype.render=function(){var e=this.viewModel.value.format(_),t=this._isOpen,r=(a={},a[h.openIcon]=!t,a[h.closeIcon]=t,a);return i.tsx("div",{afterCreate:i.storeNode,bind:this,"class":h.base,"data-node-ref":"_rootNode"},i.tsx("div",{afterUpdate:this._focusSelectedOrClosed,"aria-pressed":t.toString(),bind:this,"class":i.join(h.button,h.datePickerToggle),onclick:this._toggle,onkeydown:this._toggle,role:"button",tabIndex:0},i.tsx("span",{"class":h.date},e),i.tsx("span",{"aria-hidden":"true",classes:r})),t?this._renderCalendar():null);var a},t.prototype._focusSelectedOrClosed=function(e){this._closedByUserAction&&(this._closedByUserAction=!1,e.focus())},t.prototype._handleDatePickerKeydown=function(e){var t=e.keyCode;t===c.ESCAPE&&(this._closedByUserAction=!0,this._close(),e.preventDefault(),e.stopPropagation())},t.prototype._renderCalendar=function(){var e=this._activeDate,t=this.get("viewModel.value");return i.tsx("div",{afterCreate:i.storeNode,bind:this,"class":h.datePicker,"data-node-ref":"_calendarNode",key:"esri-date-picker__calendar",onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))},t.prototype._handleDatePickerBlur=function(e){var t=e.relatedTarget;this._calendarNode.contains(t)||this._rootNode.contains(t)||this._close()},t.prototype._renderMonthPicker=function(e){var t=n.months().map(function(t,r){var a=e.month()===r;return i.tsx("option",{selected:a},t)});return i.tsx("div",{"class":h.monthPicker},i.tsx("div",{"aria-label":l.goToPreviousMonth,bind:this,"class":h.button,onblur:this._handleDatePickerBlur,onclick:this._setPreviousMonth,onkeydown:this._setPreviousMonth,role:"button",tabIndex:0,title:l.goToPreviousMonth},i.tsx("span",{"aria-hidden":"true","class":h.previousIcon})),i.tsx("select",{"aria-live":"assertive",bind:this,"class":h.monthDropdown,id:this.id+"__month-picker",onblur:this._handleDatePickerBlur,onchange:this._setMonth,onkeydown:this._setMonth},t),i.tsx("div",{"aria-label":l.goToNextMonth,bind:this,"class":h.button,onblur:this._handleDatePickerBlur,onclick:this._setNextMonth,onkeydown:this._setNextMonth,role:"button",tabIndex:0,title:l.goToNextMonth},i.tsx("span",{"aria-hidden":"true","class":h.nextIcon})))},t.prototype._renderDayPicker=function(e,t){var r=e.clone().day(n.localeData().firstDayOfWeek()),a=this._getWeekLabels(r),o=this._getDayId(e),s=this._renderMonth(e,t);return i.tsx("div",{afterCreate:this._handleDayPickerCreate,"aria-activedescendant":o,"aria-labelledby":this.id+"__month-picker "+this.id+"__selected-year",bind:this,"class":h.dayPicker,id:this.id+"__day-picker",onblur:this._handleDatePickerBlur,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:0},i.tsx("div",{"class":h.week,role:"row"},a.map(function(e){return i.tsx("div",{"aria-label":e.name,"class":i.join(h.day,h.dayHeader),role:"columnheader",title:e.name},e.abbr)})),s)},t.prototype._getDayId=function(e){return this.id+"__"+e.format(p)},t.prototype._handleDayPickerCreate=function(e){e.focus()},t.prototype._getWeekLabels=function(e){for(var t=[],r="dddd",a="dd",i=0;7>i;i++)t.push({name:e.format(r),abbr:e.format(a)}),e.add(1,"day");return t},t.prototype._handleDayPickerKeydown=function(e){var t=e.keyCode,r=e.ctrlKey,a=e.shiftKey,i=this._activeDate;if(-1!==u.indexOf(t)){if(t===c.LEFT_ARROW)i.subtract(1,"day");else if(t===c.RIGHT_ARROW)i.add(1,"day");else if(t===c.UP_ARROW)i.subtract(1,"week");else if(t===c.DOWN_ARROW)i.add(1,"week");else if(t===c.PAGE_UP){var o=a?"year":"month";i.subtract(1,o)}else if(t===c.PAGE_DOWN){var o=a?"year":"month";i.add(1,o)}else if(t===c.HOME){var o=r?"year":"month";i.startOf(o)}else if(t===c.END){var o=r?"year":"month";i.endOf(o)}else(t===c.ENTER||t===c.SPACE)&&(this.viewModel.value=i.clone(),this._closedByUserAction=!0,this._close());e.preventDefault(),e.stopPropagation()}},t.prototype._renderMonth=function(e,t){for(var r=n(),a=n.localeData(),o=e.clone().startOf("month"),s=e.clone().endOf("month"),d=o.clone().subtract(o.weekday()-a.firstDayOfWeek(),"day"),c=6,l=7,_=d,p=[],u=0;c>u;u++){for(var y=[],v=0;l>v;v++){var k=_.date(),f=_.isSame(e,"day"),b=_.isSame(t,"day"),P=this._getDayId(_),D=(m={},m[h.nearbyMonth]=!_.isBetween(o,s,null,"[]"),m[h.today]=_.isSame(r,"day"),m[h.activeDay]=f,m[h.selectedDay]=b,m);y.push(i.tsx("div",{"aria-label":k.toString(),"aria-selected":f.toString(),bind:this,"class":h.day,"data-iso-date":_.toISOString(),classes:D,id:P,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},k)),_.add(1,"day")}p.push(i.tsx("div",{"class":h.week,role:"row"},y))}return p;var m},t.prototype._renderYearPicker=function(e){var t="YYYY",r=e.clone(),a=r.format(t),o=r.add(1,"year").format(t),s=r.subtract(2,"year").format(t);return i.tsx("div",{"class":h.yearPicker},i.tsx("div",{"aria-label":l.goToPreviousYear,bind:this,"class":h.year,onblur:this._handleDatePickerBlur,onclick:this._setPreviousYear,onkeydown:this._setPreviousYear,tabIndex:0,title:l.goToPreviousYear},s),i.tsx("div",{"class":i.join(h.year,h.selectedYear),id:this.id+"__selected-year"},a),i.tsx("div",{"aria-label":l.goToNextYear,bind:this,"class":h.year,onblur:this._handleDatePickerBlur,onclick:this._setNextYear,onkeydown:this._setNextYear,tabIndex:0,title:l.goToNextYear},o))},t.prototype._toggle=function(){return this._isOpen?void this._close():void this._open(this.viewModel.value.clone())},t.prototype._setMonth=function(e){var t=e.target,r=t.item(t.selectedIndex).value;this._activeDate.month(r)},t.prototype._close=function(){this._activeDate=null,this._isOpen=!1},t.prototype._open=function(e){this._activeDate=e,this._isOpen=!0},t.prototype._setPreviousMonth=function(){this._activeDate.subtract(1,"month")},t.prototype._setNextMonth=function(){this._activeDate.add(1,"month")},t.prototype._setPreviousYear=function(){this._activeDate.subtract(1,"year")},t.prototype._setNextYear=function(){this._activeDate.add(1,"year")},t.prototype._handleSelectedDate=function(e){var t=e.target;this.viewModel.value=n(t.getAttribute("data-iso-date")),this._closedByUserAction=!0,this._close()},a([o.aliasOf("viewModel.value")],t.prototype,"value",void 0),a([o.property({type:d}),i.renderable("viewModel.value")],t.prototype,"viewModel",void 0),a([i.accessibleHandler()],t.prototype,"_toggle",null),a([i.accessibleHandler()],t.prototype,"_setPreviousMonth",null),a([i.accessibleHandler()],t.prototype,"_setNextMonth",null),a([i.accessibleHandler()],t.prototype,"_setPreviousYear",null),a([i.accessibleHandler()],t.prototype,"_setNextYear",null),a([i.accessibleHandler()],t.prototype,"_handleSelectedDate",null),t=a([o.subclass("esri.widgets.Directions.support.DatePicker")],t)}(o.declared(s));return y});