// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["../Widget","../../core/Accessor","../../core/date","../../core/Error","../../core/HandleRegistry","../../core/lang","../../core/Logger","../../core/urlUtils","../../core/promiseUtils","../../core/watchUtils","../../request","../../support/arcadeUtils","../../tasks/support/StatisticDefinition","../../tasks/support/Query","../../tasks/QueryTask","dojo/promise/all","dojo/i18n!dojo/cldr/nls/number","dojox/html/entities"],function(e,t,i,r,n,s,a,o,l,c,f,u,d,h,p,m,_,y){function g(t){return t&&t.isInstanceOf&&t.isInstanceOf(e)}function b(e){return e&&"function"==typeof e.postMixInProperties&&"function"==typeof e.buildRendering&&"function"==typeof e.postCreate&&"function"==typeof e.startup}var F={apostrophe:/\'/g,hrefAttributes:/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,exprField:/^\s*expression\//i,token:/(\{([^\{\r\n]+)\})/g},I={apostrophe:"&apos;",ltr:"&lrm;"},v="expression/",R="relationships/",L={attachments:"attachments",fields:"fields",media:"media",text:"text"},x="esri.widgets.Popup.PopupRendererViewModel",E=a.getLogger(x);return t.createSubclass({declaredClass:x,properties:{content:{readOnly:!0},contentEnabled:!0,contentTypes:{readOnly:!0},formattedAttributes:{readOnly:!0},graphic:{},title:{readOnly:!0},view:{},waitingForContent:{readOnly:!0}},constructor:function(){this._handles=new n},initialize:function(){this._handles.add([c.watch(this,["graphic","graphic.popupTemplate.title","graphic.popupTemplate.content","graphic.popupTemplate.fieldInfos","contentEnabled"],function(){this._updateGraphic(this.graphic,this.contentEnabled)}.bind(this))]),this._updateGraphic(this.graphic,this.contentEnabled)},destroy:function(){this._handles.destroy(),this._handles=null,this._clearRelatedInfo(),this._cancelPromises(),this.graphic=null,this._set("title",null),this._set("content",null),this._set("waitingForContent",null)},content:null,contentEnabled:!0,contentTypes:L,formattedAttributes:null,graphic:null,title:"",view:null,waitingForContent:!1,_handles:null,_contentPromise:null,_contentElementPromises:null,_relatedRecordsPromise:null,_relatedRecordsQueryPromises:[],_relatedLayersInfo:null,_relatedInfo:null,_addValuesToHref:function(e,t,i,r){return t=this._trimString(t),s.substitute((t?"{"!==t[0]:1)?r:i,e)},_cancelPromises:function(){this._contentElementPromises&&(this._contentElementPromises.forEach(function(e){e.cancel()},this),this._contentElementPromises=null),this._contentPromise&&(this._contentPromise.cancel(),this._contentPromise=null),this._relatedRecordsQueryPromises.forEach(function(e){e.cancel()}),this._relatedRecordsQueryPromises.length=0,this._relatedRecordsPromise&&(this._relatedRecordsPromise.cancel(),this._relatedRecordsPromise=null)},_clearRelatedInfo:function(){this._relatedLayersInfo=null,this._relatedInfo=null},_compileContent:function(e,t){var i=e.content;if(i&&(i.nodeName||i&&b(i)||g(i)))return i;if("string"==typeof i)return this._compileText(e,{type:L.text,text:i}).text;if(Array.isArray(i))return i.map(function(i,r){var n=t&&t[r],s=n&&n.value;switch(i.type){case L.attachments:return this._proxyAttachments(i,s);case L.fields:return this._compileFields(e,i);case L.media:return this._compileMedia(e,i);case L.text:return this._compileText(e,i)}},this);if(i)try{throw new r(this.declaredClass+"::invalid content type.")}catch(n){E.warn(n.stack)}},_compileFields:function(e,t){var i=s.clone(t),r=e.template,n=r&&r.expressionInfos,a=r&&s.clone(r.fieldInfos),o=i.fieldInfos||a,l=[];return o&&o.forEach(function(e){var t=e.fieldName.toLowerCase(),i=e.hasOwnProperty("visible")?e.visible:!0;if(i){var r=this._isExpressionField(t)?this._getExpressionInfo(n,t):null;e.label=r?r.title:e.label,l.push(e)}},this),i.fieldInfos=l,i},_compileMedia:function(e,t){var i,r,n=s.clone(t),a=n.mediaInfos,o=e.attributes,l=e.layer,c=this.formattedAttributes.global,f=e.substOptions;return a&&(i=[],a.forEach(function(t){r=0;var n=t.value;switch(t.type){case"image":var a=n.sourceURL;a=a&&this._trimString(s.substitute(o,this._fixTokens(a,l))),r=!!a;break;case"pie-chart":case"line-chart":case"column-chart":case"bar-chart":var u,d=n.normalizeField;n.fields=n.fields.map(function(e){return u=this._getLayerFieldInfo(l,e),u?u.name:e},this),d&&(u=this._getLayerFieldInfo(l,d),n.normalizeField=u?u.name:d),r=n.fields.some(function(e){return s.isDefined(o[e])||-1!==e.indexOf(R)&&this._relatedInfo},this);break;default:return}if(r){t=s.clone(t),n=t.value;var h=t.title?this._processFieldsInLinks(this._fixTokens(t.title,l),o):"",p=t.caption?this._processFieldsInLinks(this._fixTokens(t.caption,l),o):"";if(t.title=h?this._trimString(s.substitute(c,h,f)):"",t.caption=p?this._trimString(s.substitute(c,p,f)):"","image"===t.type)n.sourceURL=s.substitute(o,this._fixTokens(n.sourceURL,l)),n.linkURL&&(n.linkURL=this._trimString(s.substitute(o,this._fixTokens(n.linkURL,l))));else{var m,_=e.template,y=_&&_.fieldInfos;n.fields.forEach(function(e,t){if(-1!==e.indexOf(R)){var i=this._getRelatedChartInfos(l,y,e,n,o,f);Array.isArray(i)?n.fields=i:n.fields[t]=i}else{var r=o[e];r=void 0===r?null:r,m=o[n.normalizeField]||0,r&&m&&(r/=m);var s=y&&this._getFieldInfo(y,e);n.fields[t]={y:r,tooltip:(s&&s.label||e)+":"+this._formatValue(r,{fieldInfos:y,fieldName:e,layer:l,substOptions:f,preventPlacesFormatting:!!m})}}},this)}i.push(t)}},this)),n.mediaInfos=i,n},_compileText:function(e,t){var i=s.clone(t);if(i&&i.text){var r=e.layer,n=e.attributes,a=this.formattedAttributes.global,o=e.substOptions,l=this._processFieldsInLinks(this._fixTokens(i.text,r),n);i.text=this._trimString(s.substitute(a,l,o))}return i},_compileTitle:function(e){var t="",i=e.title,r=e.layer,n=e.attributes,a=e.substOptions,o=this.formattedAttributes.global;if(i&&("function"==typeof i&&(i=i.call(null,{graphic:e.graphic})),"string"==typeof i)){var l=this._processFieldsInLinks(this._fixTokens(i,r),n);t=this._trimString(s.substitute(o,l,a))}return t},_getExpressionInfo:function(e,t){if(this._isExpressionField(t)){t=t.replace(F.exprField,""),t=t.toLowerCase();var i;return e.some(function(e){return e.name.toLowerCase()===t&&(i=e),!!i}),i}},_createGraphicInfo:function(e,t){var r=e.popupTemplate,n=r&&r.title,a=r&&r.content,o=e.layer,l=o&&o._getDateOpts&&o._getDateOpts().properties,c=s.clone(e.attributes)||{},f={dateFormat:{properties:l,formatter:"DateFormat"+i.getFormat("short-date-short-time")}};return{graphic:e,template:r,title:n,content:a,contentEnabled:t,layer:o,attributes:c,properties:l,substOptions:f}},_fixTokens:function(e,t){return e.replace(F.token,function(e,i,r){var n=this._getLayerFieldInfo(t,r);return n?"{"+n.name+"}":i}.bind(this))},_encodeAttributes:function(e){var t=s.clone(e)||{};return Object.keys(t).forEach(function(e){var i=t[e];if("string"==typeof i){var r=encodeURIComponent(i).replace(F.apostrophe,I.apostrophe);t[e]=r}}),t},_formatAttributesToFieldInfos:function(e,t,i,r,n){e.forEach(function(s){var a=s.fieldName,o=this._getLayerFieldInfo(t,a);o&&(a=s.fieldName=o.name);var l=n[a];if(n[a]=this._formatValue(l,{fieldInfos:e,fieldName:a,layer:t,substOptions:i}),r&&s.format&&s.format.dateFormat){var c=r.indexOf(a);c>-1&&r.splice(c,1)}},this)},_getArcadeViewingMode:function(e){return e&&"local"===e.viewingMode?"localScene":"globalScene"},_formatAttributes:function(e,t,i,r,n,a,o,l){var c=s.clone(n);if(o&&o.forEach(function(e){var t=v+e.name,i=l[e.name],r=this.view,n=r&&u.getViewInfo({viewingMode:"3d"===r.type?this._getArcadeViewingMode(r):"map",scale:r.scale,spatialReference:r.spatialReference}),s=u.executeFunction(i&&i.compiledFunc,u.createExecContext(a,n));"string"==typeof s&&(s=y.encode(s)),c[t]=s},this),this._relatedInfo&&Object.keys(this._relatedInfo).forEach(function(e){var t=this._relatedInfo[e],i=this._relatedLayersInfo[e];t&&(t.relatedFeatures.forEach(this._relatedFeaturesAttributes.bind(this,i,n,c)),t.relatedStatsFeatures.forEach(this._relatedStatsAttributes.bind(this,i,n,c)))},this),e&&this._formatAttributesToFieldInfos(e,t,i,r,c),t){var f=t.typeIdField;Object.keys(n).forEach(function(e){if(-1===e.indexOf(R)){var i=n[e];if(s.isDefined(i)){var r=this._getDomainName(t,a,e,i);if(s.isDefined(r))c[e]=r;else if(e===f){var o=this._getTypeName(t,a,i);s.isDefined(o)&&(c[e]=o)}}}},this)}return c},_formatValue:function(e,t){var r=t.fieldInfos,n=t.fieldName,a=t.substOptions,o=r&&this._getFieldInfo(r,n),l=s.clone(o),c=t.preventPlacesFormatting,f=this._getLayerFieldInfo(t.layer,n);if(f&&"date"===f.type){var u=l.format||{};u.dateFormat=u.dateFormat||"short-date-short-time",l.format=u}var d=l&&l.format,h="number"==typeof e&&a.dateFormat.properties&&-1===a.dateFormat.properties.indexOf(n)&&(!d||!d.dateFormat);if(!s.isDefined(e)||!l||!s.isDefined(d))return h?this._forceLTR(e):e;var p="",m=[],y=d.hasOwnProperty("places")||d.hasOwnProperty("digitSeparator"),g=d.hasOwnProperty("digitSeparator")?d.digitSeparator:!0;if(y)p="NumberFormat",s.isDefined(d.places)&&(!c||d.places>0)&&(m.push("places: "+Number(d.places)),p+="("+m.join(",")+")");else{if(!d.dateFormat)return h?this._forceLTR(e):e;p="DateFormat"+i.getFormat(d.dateFormat)||i.getFormat("short-date-short-time")}var b=s.substitute({myKey:e},"{myKey:"+p+"}",a)||"";return y&&!g&&_.group&&(b=b.replace(new RegExp("\\"+_.group,"g"),"")),h?this._forceLTR(b):b},_forceLTR:function(e){return I.ltr+e},_getDomainName:function(e,t,i,r){var n=e.getFieldDomain&&e.getFieldDomain(i,{feature:t});return n&&n.codedValues?n.getName(r):null},_getFieldInfo:function(e,t){for(var i,r=t.toLowerCase(),n=0;n<e.length;n++){var s=e[n];if(s.fieldName&&s.fieldName.toLowerCase()===r){i=s;break}}return i},_getLayerFieldInfo:function(e,t){return t&&e&&e.getField?e.getField(t):null},_getTypeName:function(e,t){var i=e.getType&&e.getType(t);return i&&i.name},_processFieldsInLinks:function(e,t){var i=this._encodeAttributes(t);return e&&(e=e.replace(F.hrefAttributes,function(e,r,n){return this._addValuesToHref(e,r||n,t,i)}.bind(this))),e},_proxyAttachments:function(e,t){var i=s.clone(e);if(t&&!(t instanceof r)&&t.attachmentInfos&&t.attachmentInfos.length){var n=t.attachmentInfos.map(function(e){return e.url=o.addProxy(e.url),e},this);i.attachmentInfos=n}return i},_queryAttachments:function(e){var t=e.layer;if(!t)return l.resolve();"scene"===t.type&&t.associatedLayer&&(t=t.associatedLayer);var i=e.attributes,r=t&&t.objectIdField,n=i&&r&&i[r];return r&&t.get("capabilities.data.supportsAttachment")&&n?this._queryAttachmentInfos(t,n):void 0},_queryAttachmentInfos:function(e,t){var i=e.url+"/"+e.layerId+"/"+t+"/attachments",r=e.token||"";return f(i,{query:{f:"json",token:r},callbackParamName:"callback"}).then(function(e){var n=e.data,s=n.attachmentInfos;return s.forEach(function(e){e.url=i+"/"+e.id,r&&(e.url+="?token="+r),e.objectId=t}),n})},_queryContentElements:function(e){var t=e.content;if(!t||!Array.isArray(t))return l.resolve();var i=[],r={};return t.forEach(function(t,n){if(t.type===L.attachments){var s=this._queryAttachments(e);s&&(r[n]=s,i.push(s))}},this),this._contentElementPromises=i,0===i.length?l.resolve():l.eachAlways(r).always(function(e){return this._contentElementPromises=null,e}.bind(this))},_trimString:function(e){return(e||"").trim()},_getContent:function(e){var t=e.template,i=t&&t.content;return"function"==typeof i&&(i=i.call(null,{graphic:e.graphic})),i&&"function"==typeof i.then?i:l.resolve(i)},_updateContent:function(e){var t;return e.contentEnabled?(t=this._getContent(e).then(function(t){return e.content=t,this._queryContentElements(e)}.bind(this)).then(function(t){this._set("content",this._compileContent(e,t))}.bind(this)).otherwise(function(e){E.log("error loading template",e)}.bind(this)).then(function(){this._contentPromise=null}.bind(this)),this._contentPromise=t,t):t=l.resolve()},_isExpressionField:function(e){return F.exprField.test(e)},_compileExpressions:function(e){if(e){var t={};return e.forEach(function(e){t[e.name]={compiledFunc:u.createFunction(e.expression)}}),t}},_createFormattedAttributes:function(e){var t=e.graphic,i=e.attributes,r=e.layer,n=e.template,s=n&&n.fieldInfos,a=n&&n.expressionInfos,o=this._compileExpressions(a),l=e.substOptions,c=e.properties,f={global:this._formatAttributes(s,r,l,c,i,t,a,o),content:[]},u=n&&n.content;return Array.isArray(u)&&u.forEach(function(e,n){e.type===L.fields&&e.fieldInfos&&(f.content[n]=this._formatAttributes(e.fieldInfos,r,l,c,i,t,a,o))},this),f},_queryGraphicInfo:function(e,t){var i=this._createGraphicInfo(e,t);return this._checkForRelatedRecords(i).then(function(){return this._set("formattedAttributes",this._createFormattedAttributes(i)),this._set("title",this._compileTitle(i)),this._updateContent(i)}.bind(this))},_updateGraphic:function(e,t){if(this._handles&&(this._clearRelatedInfo(),this._cancelPromises(),this._set("title",""),this._set("content",null),this._set("formattedAttributes",null),this._set("waitingForContent",!1),e)){this._set("waitingForContent",!0);var i=this._queryGraphicInfo(e,t).always(function(){this._relatedRecordsPromise=null,this._relatedRecordsQueryPromises.length=0,this._set("waitingForContent",!1)}.bind(this));this._relatedRecordsPromise=i}},_getAllFieldInfos:function(e){var t=[],i=e.template,r=i&&i.fieldInfos,n=e.contentEnabled;if(r&&(t=t.concat(r)),n){var s=i&&i.content;Array.isArray(s)&&s.forEach(function(e){var i=e&&e.fieldInfos;t=t.concat(i)},this)}return t},_checkForRelatedRecords:function(e){var t=this._getAllFieldInfos(e),i=t.filter(function(e){return e&&e.fieldName&&-1!==e.fieldName.indexOf(R)},this);return e.layer&&i&&i.length>0?this._getRelatedRecords({graphic:e.graphic,fieldsInfo:i}):l.resolve()},_relatedFeaturesAttributes:function(e,t,i,r){Object.keys(r.attributes).forEach(function(n){if("esriRelCardinalityOneToOne"===e.relation.cardinality){var s=this._toRelatedFieldName([e.relation.id,n]);t[s]=i[s]=r.attributes[n]}},this)},_relatedStatsAttributes:function(e,t,i,r){Object.keys(r.attributes).forEach(function(n){var s=this._toRelatedFieldName([e.relation.id,n]);t[s]=i[s]=r.attributes[n]},this)},_getRelatedChartInfos:function(e,t,i,r,n,s){var a,o,l,c,f,u,d,h;return a=[],h=this._fromRelatedFieldName(i),u=h[0],o=this._relatedInfo[u],d=this._relatedLayersInfo[u],o&&o.relatedFeatures.forEach(function(o){var l,u=o.attributes;Object.keys(u).forEach(function(o){if(o===h[1]){if(l={},f=u[o],r.normalizeField&&(c=-1!==r.normalizeField.indexOf(R)?u[this._fromRelatedFieldName(r.normalizeField)[1]]:n[r.normalizeField]),f&&c&&(f/=c),r.tooltipField)if(-1!==r.tooltipField.indexOf(R)){var d=this._fromRelatedFieldName(r.tooltipField)[1],p=u[d];l.tooltip=p+": "+this._formatValue(f,{fieldInfos:t,fieldName:p,layer:e,substOptions:s,preventPlacesFormatting:!!c})}else{var m=this._getLayerFieldInfo(e,i);m&&(i=m.name),l.tooltip=i+": "+this._formatValue(f,{fieldInfos:t,fieldName:r.tooltipField,layer:e,substOptions:s,preventPlacesFormatting:!!c})}else l.tooltip=f;l.y=f,a.push(l)}},this)},this),l="esriRelCardinalityOneToMany"===d.relation.cardinality||"esriRelCardinalityManyToMany"===d.relation.cardinality?a:a[0]},_getRelatedRecords:function(e){var t=e.graphic;return this._relatedLayersInfo?this._queryRelatedLayers(t).then(function(e){return this._setRelatedRecords(e),e}.bind(this)):this._getRelatedLayersInfo(e).then(function(e){return Object.keys(e).forEach(function(t){e[t]&&(this._relatedLayersInfo[t].relatedLayerInfo=e[t].data)},this),this._queryRelatedLayers(t).then(function(e){return this._setRelatedRecords(e),e}.bind(this))}.bind(this))},_getRelatedLayersInfo:function(e){var t,i=e.graphic,r=e.fieldsInfo,n={};return t=i.layer,this._relatedLayersInfo||(this._relatedLayersInfo={}),r.forEach(function(e){var i,r,n,s,a;if(i=this._fromRelatedFieldName(e.fieldName),r=i[0],n=i[1],r){if(!this._relatedLayersInfo[r]){var o=t&&t.relationships;o&&o.some(function(e){return e.id==r?(a=e,!0):void 0}),a&&(this._relatedLayersInfo[r]={relation:a,relatedFields:[],outStatistics:[]})}this._relatedLayersInfo[r]&&(this._relatedLayersInfo[r].relatedFields.push(n),e.statisticType&&(s=new d({statisticType:e.statisticType,onStatisticField:n,outStatisticFieldName:n}),this._relatedLayersInfo[r].outStatistics.push(s)))}},this),Object.keys(this._relatedLayersInfo).forEach(function(e){var i,r;this._relatedLayersInfo[e]&&(i=this._relatedLayersInfo[e].relation,r=t.url+"/"+i.relatedTableId,this._relatedLayersInfo[e].relatedLayerUrl=r,n[e]=f(r,{query:{f:"json"},callbackParamName:"callback"}))},this),m(n)},_queryRelatedLayers:function(e){var t={};return Object.keys(this._relatedLayersInfo).forEach(function(i){t[i]=this._queryRelatedLayer({graphic:e,relatedInfo:this._relatedLayersInfo[i]})},this),m(t)},_queryRelatedLayer:function(e){var t,i,r,n,s,a,o,l,c,f,u,d,_,y;return t=e.graphic,i=t.layer,r=i.layerId,d=e.relatedInfo,n=d.relatedLayerInfo,_=d.relatedLayerUrl,y=d.relation,n&&n.relationships&&n.relationships.some(function(e){return e.relatedTableId===parseInt(r,10)?(s=e,!0):void 0}),s&&(n.fields.some(function(e){if(e.name===s.keyField){var t=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"];return a=-1!==t.indexOf(e.type)?"number":"string",!0}}),f="string"===a?s.keyField+"='"+t.attributes[y.keyField]+"'":s.keyField+"="+t.attributes[y.keyField],o=new h({where:f,outFields:d.relatedFields}),d.outStatistics&&d.outStatistics.length>0&&n.supportsStatistics&&(u=new h({where:o.where,outFields:o.outFields,outStatistics:d.outStatistics})),l=new p({url:_}),c=[l.execute(o)],u&&c.push(l.execute(u))),this._relatedRecordsQueryPromises=this._relatedRecordsQueryPromises.concat(c),m(c)},_setRelatedRecords:function(e){this._relatedInfo=[],Object.keys(e).forEach(function(t){if(e[t]){var i=e[t];this._relatedInfo[t]={relatedFeatures:i[0].features},s.isDefined(i[1])&&(this._relatedInfo[t].relatedStatsFeatures=i[1].features)}},this)},_fromRelatedFieldName:function(e){var t=-1!==e.indexOf(R);return t?e.split("/").slice(1):[]},_toRelatedFieldName:function(e){return e&&e.length>0?R+e[0]+"/"+e[1]:""}})});