// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["../Widget","../../core/Accessor","../../core/Error","../../core/HandleRegistry","../../core/lang","../../core/urlUtils","../../core/promiseUtils","../../core/watchUtils","../../request","../../support/arcadeUtils","../../tasks/support/StatisticDefinition","../../tasks/support/Query","../../tasks/QueryTask","dojo/_base/lang","dojo/promise/all","dojo/i18n!dojo/cldr/nls/number","dojox/html/entities"],function(e,t,i,r,n,a,s,o,l,d,c,f,u,h,m,p,_){function y(t){return t&&t.isInstanceOf&&t.isInstanceOf(e)}function g(e){return e&&"function"==typeof e.postMixInProperties&&"function"==typeof e.buildRendering&&"function"==typeof e.postCreate&&"function"==typeof e.startup}var b={apostrophe:/\'/g,hrefAttributes:/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,exprField:/^\s*expression\//i,token:/(\{([^\{\r\n]+)\})/g},F={apostrophe:"&apos;",ltr:"&lrm;"},I="expression/",v="relationships/",R={attachments:"attachments",fields:"fields",media:"media",text:"text"},P={"short-date":"(datePattern: 'M/d/y', selector: 'date')","short-date-le":"(datePattern: 'd/M/y', selector: 'date')","long-month-day-year":"(datePattern: 'MMMM d, y', selector: 'date')","day-short-month-year":"(datePattern: 'd MMM y', selector: 'date')","long-date":"(datePattern: 'EEEE, MMMM d, y', selector: 'date')","short-date-short-time":"(datePattern: 'M/d/y', timePattern: 'h:mm a', selector: 'date and time')","short-date-le-short-time":"(datePattern: 'd/M/y', timePattern: 'h:mm a', selector: 'date and time')","short-date-short-time-24":"(datePattern: 'M/d/y', timePattern: 'H:mm', selector: 'date and time')","short-date-le-short-time-24":"(datePattern: 'd/M/y', timePattern: 'H:mm', selector: 'date and time')","short-date-long-time":"(datePattern: 'M/d/y', timePattern: 'h:mm:ss a', selector: 'date and time')","short-date-le-long-time":"(datePattern: 'd/M/y', timePattern: 'h:mm:ss a', selector: 'date and time')","short-date-long-time-24":"(datePattern: 'M/d/y', timePattern: 'H:mm:ss', selector: 'date and time')","short-date-le-long-time-24":"(datePattern: 'd/M/y', timePattern: 'H:mm:ss', selector: 'date and time')","long-month-year":"(datePattern: 'MMMM y', selector: 'date')","short-month-year":"(datePattern: 'MMM y', selector: 'date')",year:"(datePattern: 'y', selector: 'date')"};return t.createSubclass({declaredClass:"esri.widgets.Popup.PopupRendererViewModel",properties:{content:{readOnly:!0},contentEnabled:!0,contentTypes:{readOnly:!0},formattedAttributes:{readOnly:!0},graphic:{},title:{readOnly:!0},view:{},waitingForContent:{readOnly:!0}},constructor:function(){this._handles=new r},initialize:function(){this._handles.add([o.init(this,["graphic","contentEnabled"],function(){this._updateGraphic(this.graphic,this.contentEnabled)}.bind(this))])},destroy:function(){this._handles.destroy(),this._handles=null,this._clearRelatedInfo(),this._cancelPromises(),this.graphic=null,this._set("title",null),this._set("content",null),this._set("waitingForContent",null)},content:null,contentEnabled:!0,contentTypes:R,formattedAttributes:null,graphic:null,title:"",view:null,waitingForContent:!1,_handles:null,_contentPromise:null,_contentElementPromises:null,_relatedRecordsPromise:null,_relatedRecordsQueryPromises:[],_relatedLayersInfo:null,_relatedInfo:null,_dateFormats:P,_addValuesToHref:function(e,t,i,r){return t=this._trimString(t),n.substitute((t?"{"!==t[0]:1)?r:i,e)},_cancelPromises:function(){this._contentElementPromises&&(this._contentElementPromises.forEach(function(e){e.cancel()},this),this._contentElementPromises=null),this._contentPromise&&(this._contentPromise.cancel(),this._contentPromise=null),this._relatedRecordsQueryPromises.forEach(function(e){e.cancel()}),this._relatedRecordsQueryPromises.length=0,this._relatedRecordsPromise&&(this._relatedRecordsPromise.cancel(),this._relatedRecordsPromise=null)},_clearRelatedInfo:function(){this._relatedLayersInfo=null,this._relatedInfo=null},_compileContent:function(e,t){var r=e.content;if(r&&(r.nodeName||r&&g(r)||y(r)))return r;if("string"==typeof r)return this._compileText(e,{type:R.text,text:r}).text;if(Array.isArray(r))return r.map(function(i,r){var n=t&&t[r],a=n&&n.value;switch(i.type){case R.attachments:return this._proxyAttachments(i,a);case R.fields:return this._compileFields(e,i);case R.media:return this._compileMedia(e,i);case R.text:return this._compileText(e,i)}},this);if(r)try{throw new i(this.declaredClass+"::invalid content type.")}catch(n){console.warn(n.stack)}},_compileFields:function(e,t){var i=h.clone(t),r=e.template,n=r&&r.expressionInfos,a=r&&h.clone(r.fieldInfos),s=i.fieldInfos||a,o=[];return s&&s.forEach(function(e){var t=e.fieldName.toLowerCase(),i=e.hasOwnProperty("visible")?e.visible:!0;if(i){var r=this._isExpressionField(t)?this._getExpressionInfo(n,t):null;e.label=r?r.title:e.label,o.push(e)}},this),i.fieldInfos=o,i},_compileMedia:function(e,t){var i,r,a=h.clone(t),s=a.mediaInfos,o=e.attributes,l=e.layer,d=this.formattedAttributes.global,c=e.substOptions;return s&&(i=[],s.forEach(function(t){r=0;var a=t.value;switch(t.type){case"image":var s=a.sourceURL;s=s&&this._trimString(n.substitute(o,this._fixTokens(s,l))),r=!!s;break;case"pie-chart":case"line-chart":case"column-chart":case"bar-chart":var f,u=a.normalizeField;a.fields=a.fields.map(function(e){return f=this._getLayerFieldInfo(l,e),f?f.name:e},this),u&&(f=this._getLayerFieldInfo(l,u),a.normalizeField=f?f.name:u),r=a.fields.some(function(e){return n.isDefined(o[e])||-1!==e.indexOf(v)&&this._relatedInfo},this);break;default:return}if(r){t=h.clone(t),a=t.value;var m=t.title?this._processFieldsInLinks(this._fixTokens(t.title,l),o):"",p=t.caption?this._processFieldsInLinks(this._fixTokens(t.caption,l),o):"";if(t.title=m?this._trimString(n.substitute(d,m,c)):"",t.caption=p?this._trimString(n.substitute(d,p,c)):"","image"===t.type)a.sourceURL=n.substitute(o,this._fixTokens(a.sourceURL,l)),a.linkURL&&(a.linkURL=this._trimString(n.substitute(o,this._fixTokens(a.linkURL,l))));else{var _,y=e.template,g=y&&y.fieldInfos;a.fields.forEach(function(e,t){if(-1!==e.indexOf(v)){var i=this._getRelatedChartInfos(l,g,e,a,o,c);Array.isArray(i)?a.fields=i:a.fields[t]=i}else{var r=o[e];r=void 0===r?null:r,_=o[a.normalizeField]||0,r&&_&&(r/=_);var n=g&&this._getFieldInfo(g,e);a.fields[t]={y:r,tooltip:(n&&n.label||e)+":"+this._formatValue(r,{fieldInfos:g,fieldName:e,layer:l,substOptions:c,preventPlacesFormatting:!!_})}}},this)}i.push(t)}},this)),a.mediaInfos=i,a},_compileText:function(e,t){var i=h.clone(t);if(i&&i.text){var r=e.layer,a=e.attributes,s=this.formattedAttributes.global,o=e.substOptions,l=this._processFieldsInLinks(this._fixTokens(i.text,r),a);i.text=this._trimString(n.substitute(s,l,o))}return i},_compileTitle:function(e){var t="",i=e.title,r=e.layer,a=e.attributes,s=e.substOptions,o=this.formattedAttributes.global;if(i&&("function"==typeof i&&(i=i.call(null,{graphic:e.graphic})),"string"==typeof i)){var l=this._processFieldsInLinks(this._fixTokens(i,r),a);t=this._trimString(n.substitute(o,l,s))}return t},_getExpressionInfo:function(e,t){if(this._isExpressionField(t)){t=t.replace(b.exprField,""),t=t.toLowerCase();var i;return e.some(function(e){return e.name.toLowerCase()===t&&(i=e),!!i}),i}},_createGraphicInfo:function(e,t){var i=e.popupTemplate,r=i&&i.title,n=i&&i.content,a=e.layer,s=a&&a._getDateOpts&&a._getDateOpts().properties,o=h.clone(e.attributes)||{},l={dateFormat:{properties:s,formatter:"DateFormat"+P["short-date-short-time"]}};return{graphic:e,template:i,title:r,content:n,contentEnabled:t,layer:a,attributes:o,properties:s,substOptions:l}},_fixTokens:function(e,t){return e.replace(b.token,function(e,i,r){var n=this._getLayerFieldInfo(t,r);return n?"{"+n.name+"}":i}.bind(this))},_encodeAttributes:function(e){var t=h.clone(e)||{};return Object.keys(t).forEach(function(e){var i=t[e];if("string"==typeof i){var r=encodeURIComponent(i).replace(b.apostrophe,F.apostrophe);t[e]=r}}),t},_formatAttributesToFieldInfos:function(e,t,i,r,n){e.forEach(function(a){var s=a.fieldName,o=this._getLayerFieldInfo(t,s);o&&(s=a.fieldName=o.name);var l=n[s];if(n[s]=this._formatValue(l,{fieldInfos:e,fieldName:s,layer:t,substOptions:i}),r&&a.format&&a.format.dateFormat){var d=r.indexOf(s);d>-1&&r.splice(d,1)}},this)},_getArcadeViewingMode:function(e){return e&&"local"===e.viewingMode?"localScene":"globalScene"},_formatAttributes:function(e,t,i,r,a,s,o,l){var c=h.clone(a);if(o&&o.forEach(function(e){var t=I+e.name,i=l[e.name],r=this.view,n=r&&d.getViewInfo({viewingMode:"3d"===r.type?this._getArcadeViewingMode(r):"map",scale:r.scale,spatialReference:r.spatialReference}),a=d.executeFunction(i&&i.compiledFunc,d.createExecContext(s,n));"string"==typeof a&&(a=_.encode(a)),c[t]=a},this),this._relatedInfo&&Object.keys(this._relatedInfo).forEach(function(e){var t=this._relatedInfo[e],i=this._relatedLayersInfo[e];t&&(t.relatedFeatures.forEach(this._relatedFeaturesAttributes.bind(this,i,a,c)),t.relatedStatsFeatures.forEach(this._relatedStatsAttributes.bind(this,i,a,c)))},this),e&&this._formatAttributesToFieldInfos(e,t,i,r,c),t){var f=t.typeIdField;Object.keys(a).forEach(function(e){if(-1===e.indexOf(v)){var i=a[e];if(n.isDefined(i)){var r=this._getDomainName(t,s,e,i);if(n.isDefined(r))c[e]=r;else if(e===f){var o=this._getTypeName(t,s,i);n.isDefined(o)&&(c[e]=o)}}}},this)}return c},_formatValue:function(e,t){var i=t.fieldInfos,r=t.fieldName,a=t.substOptions,s=i&&this._getFieldInfo(i,r),o=h.clone(s),l=t.preventPlacesFormatting,d=this._getLayerFieldInfo(t.layer,r);if(d&&"date"===d.type){var c=o.format||{};c.dateFormat=c.dateFormat||"short-date-short-time",o.format=c}var f=o&&o.format,u="number"==typeof e&&a.dateFormat.properties&&-1===a.dateFormat.properties.indexOf(r)&&(!f||!f.dateFormat);if(!n.isDefined(e)||!o||!n.isDefined(f))return u?this._forceLTR(e):e;var m="",_=[],y=f.hasOwnProperty("places")||f.hasOwnProperty("digitSeparator"),g=f.hasOwnProperty("digitSeparator")?f.digitSeparator:!0;if(y)m="NumberFormat",n.isDefined(f.places)&&(!l||f.places>0)&&(_.push("places: "+Number(f.places)),m+="("+_.join(",")+")");else{if(!f.dateFormat)return u?this._forceLTR(e):e;m="DateFormat"+P[f.dateFormat]||P["short-date-short-time"]}var b=n.substitute({myKey:e},"{myKey:"+m+"}",a)||"";return y&&!g&&p.group&&(b=b.replace(new RegExp("\\"+p.group,"g"),"")),u?this._forceLTR(b):b},_forceLTR:function(e){return F.ltr+e},_getDomainName:function(e,t,i,r){var n=e.getDomain&&e.getDomain(i,{feature:t});return n&&n.codedValues?n.getName(r):null},_getFieldInfo:function(e,t){for(var i,r=t.toLowerCase(),n=0;n<e.length;n++){var a=e[n];if(a.fieldName&&a.fieldName.toLowerCase()===r){i=a;break}}return i},_getLayerFieldInfo:function(e,t){return t&&e&&e.getField?e.getField(t):null},_getTypeName:function(e,t){var i=e.getType&&e.getType(t);return i&&i.name},_processFieldsInLinks:function(e,t){var i=this._encodeAttributes(t);return e&&(e=e.replace(b.hrefAttributes,function(e,r,n){return this._addValuesToHref(e,r||n,t,i)}.bind(this))),e},_proxyAttachments:function(e,t){var r=h.clone(e);if(t&&!(t instanceof i)&&t.attachmentInfos&&t.attachmentInfos.length){var n=t.attachmentInfos.map(function(e){return e.url=a.addProxy(e.url),e},this);r.attachmentInfos=n}return r},_queryAttachments:function(e){var t=e.layer;if(!t)return s.resolve();"scene"===t.type&&t.companionFeatureLayer&&(t=t.companionFeatureLayer);var i=e.attributes,r=t&&t.objectIdField,n=i&&r&&i[r];return r&&t.get("capabilities.data.supportsAttachment")&&n?this._queryAttachmentInfos(t,n):void 0},_queryAttachmentInfos:function(e,t){var i=e.url+"/"+e.layerId+"/"+t+"/attachments",r=e.token||"";return l(i,{query:{f:"json",token:r},callbackParamName:"callback"}).then(function(e){var n=e.data,a=n.attachmentInfos;return a.forEach(function(e){e.url=i+"/"+e.id,r&&(e.url+="?token="+r),e.objectId=t}),n})},_queryContentElements:function(e){var t=e.content;if(!t||!Array.isArray(t))return s.resolve();var i=[],r={};return t.forEach(function(t,n){if(t.type===R.attachments){var a=this._queryAttachments(e);a&&(r[n]=a,i.push(a))}},this),this._contentElementPromises=i,0===i.length?s.resolve():s.eachAlways(r).always(function(e){return this._contentElementPromises=null,e}.bind(this))},_trimString:function(e){return(e||"").trim()},_getContent:function(e){var t=e.template,i=t&&t.content;return"function"==typeof i&&(i=i.call(null,{graphic:e.graphic})),i&&"function"==typeof i.then?i:s.resolve(i)},_updateContent:function(e){var t;return e.contentEnabled?(t=this._getContent(e).then(function(t){return e.content=t,this._queryContentElements(e)}.bind(this)).then(function(t){this._set("content",this._compileContent(e,t))}.bind(this)).otherwise(function(e){console.log(this.declaredClass+"::error loading template",e)}.bind(this)).then(function(){this._contentPromise=null}.bind(this)),this._contentPromise=t,t):t=s.resolve()},_isExpressionField:function(e){return b.exprField.test(e)},_compileExpressions:function(e){if(e){var t={};return e.forEach(function(e){t[e.name]={compiledFunc:d.createFunction(e.expression)}}),t}},_createFormattedAttributes:function(e){var t=e.graphic,i=e.attributes,r=e.layer,n=e.template,a=n&&n.fieldInfos,s=n&&n.expressionInfos,o=this._compileExpressions(s),l=e.substOptions,d=e.properties,c={global:this._formatAttributes(a,r,l,d,i,t,s,o),content:[]},f=n&&n.content;return Array.isArray(f)&&f.forEach(function(e,n){e.type===R.fields&&e.fieldInfos&&(c.content[n]=this._formatAttributes(e.fieldInfos,r,l,d,i,t,s,o))},this),c},_queryGraphicInfo:function(e,t){var i=this._createGraphicInfo(e,t);return this._checkForRelatedRecords(i).then(function(){return this._set("formattedAttributes",this._createFormattedAttributes(i)),this._set("title",this._compileTitle(i)),this._updateContent(i)}.bind(this))},_updateGraphic:function(e,t){if(this._handles&&(this._clearRelatedInfo(),this._cancelPromises(),this._set("title",""),this._set("content",null),this._set("formattedAttributes",null),this._set("waitingForContent",!1),e)){this._set("waitingForContent",!0);var i=this._queryGraphicInfo(e,t).always(function(){this._relatedRecordsPromise=null,this._relatedRecordsQueryPromises.length=0,this._set("waitingForContent",!1)}.bind(this));this._relatedRecordsPromise=i}},_getAllFieldInfos:function(e){var t=[],i=e.template,r=i&&i.fieldInfos,n=e.contentEnabled;if(r&&(t=t.concat(r)),n){var a=i&&i.content;Array.isArray(a)&&a.forEach(function(e){var i=e&&e.fieldInfos;t=t.concat(i)},this)}return t},_checkForRelatedRecords:function(e){var t=this._getAllFieldInfos(e),i=t.filter(function(e){return e&&e.fieldName&&-1!==e.fieldName.indexOf(v)},this);return e.layer&&i&&i.length>0?this._getRelatedRecords({graphic:e.graphic,fieldsInfo:i}):s.resolve()},_relatedFeaturesAttributes:function(e,t,i,r){Object.keys(r.attributes).forEach(function(n){if("esriRelCardinalityOneToOne"===e.relation.cardinality){var a=this._toRelatedFieldName([e.relation.id,n]);t[a]=i[a]=r.attributes[n]}},this)},_relatedStatsAttributes:function(e,t,i,r){Object.keys(r.attributes).forEach(function(n){var a=this._toRelatedFieldName([e.relation.id,n]);t[a]=i[a]=r.attributes[n]},this)},_getRelatedChartInfos:function(e,t,i,r,n,a){var s,o,l,d,c,f,u,h;return s=[],h=this._fromRelatedFieldName(i),f=h[0],o=this._relatedInfo[f],u=this._relatedLayersInfo[f],o&&o.relatedFeatures.forEach(function(o){var l,f=o.attributes;Object.keys(f).forEach(function(o){if(o===h[1]){if(l={},c=f[o],r.normalizeField&&(d=-1!==r.normalizeField.indexOf(v)?f[this._fromRelatedFieldName(r.normalizeField)[1]]:n[r.normalizeField]),c&&d&&(c/=d),r.tooltipField)if(-1!==r.tooltipField.indexOf(v)){var u=this._fromRelatedFieldName(r.tooltipField)[1],m=f[u];l.tooltip=m+": "+this._formatValue(c,{fieldInfos:t,fieldName:m,layer:e,substOptions:a,preventPlacesFormatting:!!d})}else{var p=this._getLayerFieldInfo(e,i);p&&(i=p.name),l.tooltip=i+": "+this._formatValue(c,{fieldInfos:t,fieldName:r.tooltipField,layer:e,substOptions:a,preventPlacesFormatting:!!d})}else l.tooltip=c;l.y=c,s.push(l)}},this)},this),l="esriRelCardinalityOneToMany"===u.relation.cardinality||"esriRelCardinalityManyToMany"===u.relation.cardinality?s:s[0]},_getRelatedRecords:function(e){var t=e.graphic;return this._relatedLayersInfo?this._queryRelatedLayers(t).then(function(e){return this._setRelatedRecords(e),e}.bind(this)):this._getRelatedLayersInfo(e).then(function(e){return Object.keys(e).forEach(function(t){e[t]&&(this._relatedLayersInfo[t].relatedLayerInfo=e[t].data)},this),this._queryRelatedLayers(t).then(function(e){return this._setRelatedRecords(e),e}.bind(this))}.bind(this))},_getRelatedLayersInfo:function(e){var t,i=e.graphic,r=e.fieldsInfo,n={};return t=i.layer,this._relatedLayersInfo||(this._relatedLayersInfo={}),r.forEach(function(e){var i,r,n,a,s;if(i=this._fromRelatedFieldName(e.fieldName),r=i[0],n=i[1],r){if(!this._relatedLayersInfo[r]){var o=t&&t.relationships;o&&o.some(function(e){return e.id==r?(s=e,!0):void 0}),s&&(this._relatedLayersInfo[r]={relation:s,relatedFields:[],outStatistics:[]})}this._relatedLayersInfo[r]&&(this._relatedLayersInfo[r].relatedFields.push(n),e.statisticType&&(a=new c({statisticType:e.statisticType,onStatisticField:n,outStatisticFieldName:n}),this._relatedLayersInfo[r].outStatistics.push(a)))}},this),Object.keys(this._relatedLayersInfo).forEach(function(e){var i,r;this._relatedLayersInfo[e]&&(i=this._relatedLayersInfo[e].relation,r=t.url+"/"+i.relatedTableId,this._relatedLayersInfo[e].relatedLayerUrl=r,n[e]=l(r,{query:{f:"json"},callbackParamName:"callback"}))},this),m(n)},_queryRelatedLayers:function(e){var t={};return Object.keys(this._relatedLayersInfo).forEach(function(i){t[i]=this._queryRelatedLayer({graphic:e,relatedInfo:this._relatedLayersInfo[i]})},this),m(t)},_queryRelatedLayer:function(e){var t,i,r,n,a,s,o,l,d,c,h,p,_,y;return t=e.graphic,i=t.layer,r=i.layerId,p=e.relatedInfo,n=p.relatedLayerInfo,_=p.relatedLayerUrl,y=p.relation,n&&n.relationships&&n.relationships.some(function(e){return e.relatedTableId===parseInt(r,10)?(a=e,!0):void 0}),a&&(n.fields.some(function(e){if(e.name===a.keyField){var t=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"];return s=-1!==t.indexOf(e.type)?"number":"string",!0}}),c="string"===s?a.keyField+"='"+t.attributes[y.keyField]+"'":a.keyField+"="+t.attributes[y.keyField],o=new f({where:c,outFields:p.relatedFields}),p.outStatistics&&p.outStatistics.length>0&&n.supportsStatistics&&(h=new f({where:o.where,outFields:o.outFields,outStatistics:p.outStatistics})),l=new u({url:_}),d=[l.execute(o)],h&&d.push(l.execute(h))),this._relatedRecordsQueryPromises=this._relatedRecordsQueryPromises.concat(d),m(d)},_setRelatedRecords:function(e){this._relatedInfo=[],Object.keys(e).forEach(function(t){if(e[t]){var i=e[t];this._relatedInfo[t]={relatedFeatures:i[0].features},n.isDefined(i[1])&&(this._relatedInfo[t].relatedStatsFeatures=i[1].features)}},this)},_fromRelatedFieldName:function(e){var t=-1!==e.indexOf(v);return t?e.split("/").slice(1):[]},_toRelatedFieldName:function(e){return e&&e.length>0?v+e[0]+"/"+e[1]:""}})});