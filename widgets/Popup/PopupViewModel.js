// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["../../core/Accessor","../../core/Collection","../../core/Error","../../core/Evented","../../core/HandleRegistry","../../core/promiseUtils","../../core/watchUtils","../../geometry/geometryEngine","../../geometry/support/webMercatorUtils","../../geometry/Point","../../support/Action","../support/AnchorElementViewModel","dojo/fx/easing","dojo/_base/lang"],function(e,t,i,n,s,o,a,r,l,h,c,u,d,g){function f(e,t){return t.allLayerViews.find(function(t){return t.layer===e})}var p={highlight:"highlight"},_="temporary",m={disabled:"disabled",ready:"ready"},v={id:"zoom-to"};return e.createSubclass([n,u],{declaredClass:"esri.widgets.Popup.PopupViewModel",properties:{actions:{type:t.ofType(c)},animationOptions:{},autoCloseEnabled:{},clear:{},content:{},featureCount:{readOnly:!0},features:{},location:{type:h},next:{},pendingPromisesCount:{readOnly:!0},previous:{},promiseCount:{readOnly:!0,dependsOn:["promises"],get:function(){return this.promises?this.promises.length:0}},promises:{},selectedFeature:{readOnly:!0},selectedFeatureIndex:{},state:{dependsOn:["view.ready"],readOnly:!0},title:{},triggerAction:{},updateLocationEnabled:{},view:{},visible:{},waitingForResult:{dependsOn:["pendingPromisesCount","featureCount"],readOnly:!0},zoomFactor:{}},_handles:null,constructor:function(){this._handles=new s},getDefaults:function(e){return g.mixin(this.inherited(arguments),{actions:[v],animationOptions:{duration:300,easing:d.quadInOut},promises:[]})},initialize:function(){this._handles.add([this.on("view-change",this._autoClose),a.watch(this,"location",this._locationWatcher),a.whenFalse(this,"visible",this._visibleWatcher)])},destroy:function(){this._handles.destroy(),this._handles=null,this.view=null},actions:[v],animationOptions:{duration:300,easing:d.quadInOut},autoCloseEnabled:!1,content:null,featureCount:0,features:null,_featuresSetter:function(e){this._set("features",e),this._updateFeatureCount(e),this.promiseCount||(this.selectedFeatureIndex=-1,e&&e.length&&(this.selectedFeatureIndex=0))},highlightEnabled:!0,_highlightEnabledSetter:function(e){this._set("highlightEnabled",e),this._highlightFeature(this.selectedFeature,this.view)},location:null,_locationSetter:function(e){var t=this.get("view.spatialReference.isWebMercator"),i=e&&e.get("spatialReference.isWGS84");i&&t&&(e=l.geographicToWebMercator(e)),this._set("location",e)},pendingPromisesCount:0,waitingForResult:!1,_waitingForResultGetter:function(){return this.pendingPromisesCount>0&&0===this.featureCount},promiseCount:0,promises:[],_promisesSetter:function(e){var t=this._get("promises"),i=e;t&&t.forEach(function(e){e.cancel()}),this.features=[];var n=i&&i.length;this._set("selectedFeatureIndex",-1),this._set("selectedFeature",null),this._selectedFeatureChange(this.selectedFeature,this.updateLocationEnabled),this._set("pendingPromisesCount",0),this._set("promises",i),i&&i.length&&(this._set("pendingPromisesCount",n),i=i.slice(0),i.forEach(function(e){e.always(function(t){if(!e.isCanceled()){var i=this.pendingPromisesCount-1;this._set("pendingPromisesCount",i),this._updateFeatures(e,t)}}.bind(this))},this),o.eachAlways(i).then(function(){this.featureCount||(this.visible=!1)}.bind(this)))},selectedFeature:null,selectedFeatureIndex:-1,_selectedFeatureIndexSetter:function(e){(isNaN(e)||-1>e)&&(e=-1);var t=null,i=this.features;i&&i.length&&(e=(e+i.length)%i.length,t=i[e]),this._set("selectedFeature",t),this._set("selectedFeatureIndex",e),this._selectedFeatureChange(t,this.updateLocationEnabled)},state:m.disabled,_stateGetter:function(){return this.get("view.ready")?m.ready:m.disabled},title:null,updateLocationEnabled:!1,_updateLocationEnabledSetter:function(e){this._selectedFeatureChange(this.selectedFeature,e),this._set("updateLocationEnabled",e)},view:null,visible:!1,zoomFactor:4,centerAtLocation:function(){return this.location&&this.view?this.view.goTo({target:this.location,scale:this.view.scale},this.animationOptions):o.reject(new i(this.declaredClass+"::Cannot center at location without a location and view."))},clear:function(){this.set({promises:[],features:[],content:null,title:null,location:null})},triggerAction:function(e){var t=this.actions.getItemAt(e);t&&this.emit("trigger-action",{action:t})},next:function(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this},previous:function(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this},zoomToLocation:function(){var e=this.view,t=this.location;if(!t||!e)return o.reject(new i(this.declaredClass+"::Cannot zoom to location without a location and view."));var n,s=e.scale/this.zoomFactor,a=this.selectedFeature,r=a&&a.geometry,l=a&&"3d"===e.type;return r||l?(n={target:a},r&&"point"===r.type&&this._isScreenSize(a)&&(n.scale=s,this.location=r)):n={target:t,scale:s},e.goTo(n,this.animationOptions)},_autoClose:function(){this.autoCloseEnabled&&(this.visible=!1)},_isScreenSize:function(e){if("3d"!==this.view.type||"esri.Graphic"!==e.declaredClass)return!0;var t=!0,i=this.view.getViewForGraphic(e);return i&&i.whenGraphicBounds&&i.whenGraphicBounds(e).then(function(e){t=!e||e[0]===e[3]&&e[1]===e[4]&&e[2]===e[5]}),t},_getSelectedFeatureActions:function(){this._originalActions&&(this.actions=this._originalActions,this._originalActions=null);var e=this.actions.filter(function(e){return!e[_]},this),t=e,i=this.selectedFeature.popupTemplate;if(i&&i.actions){for(var n=i.actions,s=0;s<n.length;s++)n.getItemAt(s)[_]=!0;i.overwriteActions?(this._originalActions=e,t=n):t=e.concat(n)}this.actions=t},_getPointFromGeometry:function(e){var t=e&&e.type;switch(t){case"point":return e;case"extent":return e.center;case"polygon":return e.centroid;case"multipoint":case"polyline":return e.extent.center;default:return null}},_locationWatcher:function(e,t){var i=this.get("view.extent"),n=this.updateLocationEnabled;n&&i&&e&&e!==t&&!r.contains(i,e)&&this.centerAtLocation()},_visibleWatcher:function(e){this._handles.remove(p.highlight)},_highlightFeature:function(e,t){if(this._handles.remove(p.highlight),e&&t&&this.highlightEnabled){var i=e.layer;if(i){var n=f(i,t);if(n){var s="function"==typeof n.highlight;if(s){var o=i.objectIdField,a=e.attributes,r=a&&a[o],l=n.highlight(r||e);this._handles.add(l,p.highlight)}}}}},_selectedFeatureChange:function(e,t){var i=this.view;this._highlightFeature(e,i),e&&(t&&(this.location=this._getPointFromGeometry(e.geometry)),this._getSelectedFeatureActions())},_updateFeatureCount:function(e){var t=0;e&&e.length&&(t=e.length),this._set("featureCount",t)},_updateFeatures:function(e,t){if(e&&this.promises){var n=this._validatePromise(e);if(!n||t instanceof i||t instanceof Error)return;if(t&&t.length){var s={};if(this.features&&this.features.length){var o=t.filter(function(e){return-1===this.features.indexOf(e)},this);s.features=this.features.concat(o)}else s.features=t,s.selectedFeatureIndex=0;this.set(s)}}},_validatePromise:function(e){return this.promises.indexOf(e)>-1}})});