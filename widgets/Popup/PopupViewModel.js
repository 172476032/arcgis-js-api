// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/tsSupport/assignHelper","../../core/Collection","../../core/Error","../../core/HandleRegistry","../../core/promiseUtils","../../core/watchUtils","../../geometry/geometryEngine","../../geometry/support/webMercatorUtils","../../support/Action","../support/AnchorElementViewModel","../../core/accessorSupport/decorators"],function(e,t,o,r,n,i,s,p,a,l,u,c,d,h,y){function f(e,t){return t.allLayerViews.find(function(t){return t.layer===e})}var g="temporary",v=new d({id:"zoom-to"}),m=i.ofType(d),b=new m([v]),w=function(e){function t(t){var o=e.call(this)||this;return o._handles=new p,o._originalActions=null,o.actions=b,o.goToOptions=null,o.autoCloseEnabled=!1,o.content=null,o.highlightEnabled=!0,o.title=null,o.updateLocationEnabled=!0,o.view=null,o.visible=!1,o.zoomFactor=4,o}return o(t,e),t.prototype.initialize=function(){this._handles.add([this.on("view-change",this._autoClose),l.watch(this,["highlightEnabled","selectedFeature","visible","view"],this._highlightFeature),l.watch(this,"selectedFeature.popupTemplate.actions",this._getSelectedFeatureActions),l.watch(this,"selectedFeature.popupTemplate.overwriteActions",this._getSelectedFeatureActions)])},t.prototype.destroy=function(){this._handles.destroy(),this._handles=null,this.view=null},Object.defineProperty(t.prototype,"featureCount",{get:function(){return this.features.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"features",{get:function(){return this._get("features")||[]},set:function(e){var t=e||[];this._set("features",t);var o=this,r=o.pendingPromisesCount,n=o.promiseCount,i=o.selectedFeatureIndex,s=n&&t.length;return s&&r&&-1===i?void(this.selectedFeatureIndex=0):void(s&&-1!==i||(this.selectedFeatureIndex=t.length?0:-1))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"location",{get:function(){return this._get("location")||null},set:function(e){var t=this.get("location"),o=this.get("view.spatialReference.isWebMercator"),r=e&&e.get("spatialReference.isWGS84");r&&o&&(e=c.geographicToWebMercator(e)),this._set("location",e),e!==t&&this._centerAtLocation()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pendingPromisesCount",{get:function(){return this.promises.filter(function(e){return e&&!e.isFulfilled()}).length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"waitingForResult",{get:function(){return this.pendingPromisesCount>0&&0===this.featureCount},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"promiseCount",{get:function(){return this.promises.length},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"promises",{get:function(){return this._get("promises")||[]},set:function(e){var t=this,o=this._get("promises");o.forEach(function(e){e.cancel()}),this.features=[],this._set("promises",e),e.length&&(e=e.slice(0),e.forEach(function(e){e.always(function(o){t.notifyChange("pendingPromisesCount"),t._updateFeatures(e,o)})}),a.eachAlways(e).then(function(){t.featureCount||(t.visible=!1)}))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selectedFeature",{get:function(){var e=this,t=e.features,o=e.selectedFeatureIndex,r=e.updateLocationEnabled;if(-1===o)return null;var n=t[o];return n?(r&&(this.location=this._getPointFromGeometry(n.geometry)),n):null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selectedFeatureIndex",{get:function(){var e=this._get("selectedFeatureIndex");return"number"==typeof e?e:-1},set:function(e){var t=this.featureCount;e=isNaN(e)||-1>e||!t?-1:(e+t)%t,this._set("selectedFeatureIndex",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"state",{get:function(){return this.get("view.ready")?"ready":"disabled"},enumerable:!0,configurable:!0}),t.prototype.centerAtLocation=function(){var e=this,t=e.location,o=e.view;return t&&o?o.goTo({target:t,scale:o.scale},this.goToOptions):a.reject(new s(this.declaredClass+"::Cannot center at location without a location and view."))},t.prototype.clear=function(){this.set({promises:[],features:[],content:null,title:null,location:null})},t.prototype.triggerAction=function(e){var t=this.actions.getItemAt(e);t&&this.emit("trigger-action",{action:t})},t.prototype.next=function(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this},t.prototype.previous=function(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this},t.prototype.zoomToLocation=function(){var e=this,t=this,o=t.location,r=t.selectedFeature,n=t.view,i=t.zoomFactor;if(!o||!n)return a.reject(new s(this.declaredClass+"::Cannot zoom to location without a location and view."));var p=n.scale/i,l=this.get("selectedFeature.geometry"),u=r&&"3d"===n.type,c=l||u,d=c?r:o,h=c&&l&&"point"===l.type&&this._isScreenSize(r),y={target:d,scale:h?p:void 0};return n.goTo(y,this.goToOptions).then(function(){h&&"point"===l.type&&(e.location=l)})},t.prototype._autoClose=function(){this.autoCloseEnabled&&(this.visible=!1)},t.prototype._isScreenSize=function(e){var t=this.view;if("3d"!==t.type||"esri.Graphic"!==e.declaredClass)return!0;var o=t.getViewForGraphic(e);return o&&o.whenGraphicBounds?o.whenGraphicBounds(e).then(function(e){return!e||e[0]===e[3]&&e[1]===e[4]&&e[2]===e[5]}):!0},t.prototype._getSelectedFeatureActions=function(){this._originalActions&&(this.actions=this._originalActions,this._originalActions=null);var e=this.actions.filter(function(e){return!e[g]}),t=this.get("selectedFeature.popupTemplate");t&&t.overwriteActions&&(this._originalActions=e),this.actions=this._getNewActions(t,e)},t.prototype._getNewActions=function(e,t){if(!e||!e.actions)return t;var o=e.actions;return o.forEach(function(e){e[g]=!0}),e.overwriteActions?o:t.concat(o)},t.prototype._getPointFromGeometry=function(e){return e?"point"===e.type?e:"extent"===e.type?e.center:"polygon"===e.type?e.centroid:"multipoint"===e.type?e.extent.center:"polyline"===e.type?e.extent.center:null:null},t.prototype._centerAtLocation=function(){var e=this,t=e.location,o=e.updateLocationEnabled,r=this.get("view.extent");o&&r&&t&&!u.contains(r,t)&&this.centerAtLocation()},t.prototype._highlightFeature=function(){var e="highlight";this._handles.remove(e);var t=this,o=t.selectedFeature,r=t.highlightEnabled,n=t.view,i=t.visible;if(o&&n&&r&&i){var s=o.layer;if(s){var p=f(s,n);if(p){var a="function"==typeof p.highlight;if(a){var l=s.objectIdField,u=o.attributes,c=u&&u[l],d=p.highlight(c||o,{});this._handles.add(d,e)}}}}},t.prototype._updateFeatures=function(e,t){var o=this.features;if(e&&t&&t.length){var r=this._validatePromise(e);if(!(!r||t instanceof s||t instanceof Error)){if(!o.length)return void(this.features=t);var n=t.filter(function(e){return-1===o.indexOf(e)});this.features=o.concat(n)}}},t.prototype._validatePromise=function(e){return!e.isCanceled()&&this.promises.indexOf(e)>-1},r([y.property({type:i.ofType(d)})],t.prototype,"actions",void 0),r([y.property()],t.prototype,"goToOptions",void 0),r([y.property()],t.prototype,"autoCloseEnabled",void 0),r([y.property()],t.prototype,"content",void 0),r([y.property({readOnly:!0,dependsOn:["features"]})],t.prototype,"featureCount",null),r([y.property()],t.prototype,"features",null),r([y.property()],t.prototype,"highlightEnabled",void 0),r([y.property()],t.prototype,"location",null),r([y.property({readOnly:!0,dependsOn:["promises"]})],t.prototype,"pendingPromisesCount",null),r([y.property({readOnly:!0,dependsOn:["featureCount","pendingPromisesCount"]})],t.prototype,"waitingForResult",null),r([y.property({readOnly:!0,dependsOn:["promises"]})],t.prototype,"promiseCount",null),r([y.property()],t.prototype,"promises",null),r([y.property({value:null,readOnly:!0,dependsOn:["features","selectedFeatureIndex","updateLocationEnabled"]})],t.prototype,"selectedFeature",null),r([y.property({value:-1})],t.prototype,"selectedFeatureIndex",null),r([y.property({readOnly:!0,dependsOn:["view.ready"]})],t.prototype,"state",null),r([y.property()],t.prototype,"title",void 0),r([y.property()],t.prototype,"updateLocationEnabled",void 0),r([y.property()],t.prototype,"view",void 0),r([y.property()],t.prototype,"visible",void 0),r([y.property()],t.prototype,"zoomFactor",void 0),r([y.property()],t.prototype,"centerAtLocation",null),r([y.property()],t.prototype,"clear",null),r([y.property()],t.prototype,"triggerAction",null),r([y.property()],t.prototype,"next",null),r([y.property()],t.prototype,"previous",null),r([y.property()],t.prototype,"zoomToLocation",null),t=r([y.subclass("esri.widgets.Popup.PopupViewModel")],t)}(y.declared(h));return w});