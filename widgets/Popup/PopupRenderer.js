// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/accessorSupport/decorators","../support/widget","../Widget","./PopupRendererViewModel","../../core/requireUtils","../support/uriUtils","dojo/i18n!./nls/PopupRenderer","../../core/watchUtils","dojo/keys"],function(e,t,i,r,n,a,o,s,d,p,c,l,m){function u(e){return e&&e.isInstanceOf&&e.isInstanceOf(o)}function h(e){return e&&"function"==typeof e.postMixInProperties&&"function"==typeof e.buildRendering&&"function"==typeof e.postCreate&&"function"==typeof e.startup}function _(e,t){return void 0===t?v+"__"+e:v+"__"+e+"-"+t}var f={iconText:"esri-icon-font-fallback-text",iconLoading:"esri-icon-loading-indicator esri-rotating",iconDownload:"esri-icon-download",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconMedia:"esri-icon-media",iconChart:"esri-icon-chart",base:"esri-popup-renderer",container:"esri-popup-renderer__size-container",main:"esri-popup-renderer__main-container",btn:"esri-popup-renderer__button",icon:"esri-popup-renderer__icon",content:"esri-popup-renderer__content",contentElement:"esri-popup-renderer__content-element",text:"esri-popup-renderer__text",showMediaPagination:"esri-popup-renderer--media-pagination-visible",attachments:"esri-popup-renderer__attachments",attachmentsTitle:"esri-popup-renderer__attachments-title",attachmentsItems:"esri-popup-renderer__attachments-items",attachmentsItem:"esri-popup-renderer__attachments-item",attachmentsItemLink:"esri-popup-renderer__attachments-item-link",attachmentsItemTitle:"esri-popup-renderer__attachments-item-title",attachmentsItemIcon:"esri-popup-renderer__attachments-item-icon",fields:"esri-popup-renderer__fields",fieldHeader:"esri-popup-renderer__field-header",fieldData:"esri-popup-renderer__field-data",fieldDataDate:"esri-popup-renderer__field-data--date",media:"esri-popup-renderer__media",mediaContainer:"esri-popup-renderer__media-container",mediaItemContainer:"esri-popup-renderer__media-item-container",mediaItem:"esri-popup-renderer__media-item",mediaItemTitle:"esri-popup-renderer__media-item-title",mediaItemCaption:"esri-popup-renderer__media-item-caption",mediaPrevious:"esri-popup-renderer__media-previous",mediaPreviousIconLTR:"esri-popup-renderer__media-previous-icon",mediaPreviousIconRTL:"esri-popup-renderer__media-previous-icon--rtl",mediaNext:"esri-popup-renderer__media-next",mediaNextIconLTR:"esri-popup-renderer__media-next-icon",mediaNextIconRTL:"esri-popup-renderer__media-next-icon--rtl",mediaSummary:"esri-popup-renderer__media-summary",mediaCount:"esri-popup-renderer__media-count",mediaImageSummary:"esri-popup-renderer__media-image-summary",mediaImageIcon:"esri-popup-renderer__media-image-icon",mediaChart:"esri-popup-renderer__media-chart",mediaChartSummary:"esri-popup-renderer__media-chart-summary",mediaChartIcon:"esri-popup-renderer__media-chart-icon",loadingSpinnerContainer:"esri-popup-renderer__loading-container",spinner:"esri-popup-renderer__loading-spinner"},v="esri-popup-renderer",y=function(t){function o(e){var i=t.call(this)||this;return i._chartMap=new Map,i._activeMediaMap=new Map,i._chartRequirePromise=null,i._refreshTimers=new Map,i._mediaInfo=new Map,i.contentEnabled=null,i.graphic=null,i.title=null,i.view=null,i.viewModel=new s,i}return i(o,t),o.prototype.postInitialize=function(){var e=this;this.own(l.init(this,"viewModel.content",function(){return e._setupMediaRefreshTimers()}))},o.prototype.destroy=function(){this._clearMediaRefreshTimers(),this._activeMediaMap.clear(),this._activeMediaMap=null,this._cancelChartModules(),this._destroyCharts()},o.prototype.render=function(){var e=a.tsx("div",{key:_("loading-container"),"class":f.loadingSpinnerContainer},a.tsx("span",{"class":a.join(f.iconLoading,f.spinner)})),t=this.viewModel.waitingForContent?e:this._renderContent();return a.tsx("div",{"class":f.base},a.tsx("div",{"class":f.container},a.tsx("div",{"class":f.main},t)))},o.prototype.goToMedia=function(e,t){this._setContentElementMedia(e,t)},o.prototype.nextMedia=function(e){this._pageContentElementMedia(e,"next")},o.prototype.previousMedia=function(e){this._pageContentElementMedia(e,"previous")},o.prototype._cancelChartModules=function(){this._chartRequirePromise&&this._chartRequirePromise.cancel()},o.prototype._destroyChart=function(e){var t=this._chartMap.get(e);t&&(t.chart.destroy(),t.tooltip.destroy()),this._chartMap["delete"](e)},o.prototype._destroyCharts=function(){this._chartMap.forEach(function(e){e.chart.destroy(),e.tooltip.destroy()}),this._chartMap.clear()},o.prototype._renderContent=function(){this._destroyCharts();var e=this.viewModel.content,t="content";return"string"==typeof e?a.tsx("div",{key:_(t+"-string"),innerHTML:e}):u(e)?a.tsx("div",{key:_(t+"-widget")},e.render()):e instanceof HTMLElement?a.tsx("div",{key:_(t+"-html-element"),bind:e,afterUpdate:this._attachToNode,afterCreate:this._attachToNode}):h(e)?a.tsx("div",{key:_(t+"-dijit"),bind:e.domNode,afterUpdate:this._attachToNode,afterCreate:this._attachToNode}):Array.isArray(e)?e.length?a.tsx("div",{key:_(t+"-content-elements")},e.map(this._renderContentElement,this)):null:void 0},o.prototype._renderContentElement=function(e,t){var i=e.type,r=this.viewModel.contentTypes;switch(i){case r.attachments:return this._renderAttachments(e,t);case r.fields:return this._renderFields(e,t);case r.media:return this._renderMedia(e,t);case r.text:return this._renderText(e,t);default:return null}},o.prototype._renderAttachmentInfo=function(e,t){return a.tsx("li",{"class":f.attachmentsItem,key:_("attachment",t)},a.tsx("a",{"class":f.attachmentsItemLink,href:e.url,target:"_blank"},a.tsx("span",{"class":a.join(f.iconDownload,f.attachmentsItemIcon)}),a.tsx("span",{"class":f.attachmentsItemTitle},e.name||c.noTitle)))},o.prototype._renderAttachments=function(e,t){var i=e.attachmentInfos,r=i&&i.length;return r?a.tsx("div",{key:_("attachments-element"),"class":a.join(f.attachments,f.contentElement)},a.tsx("div",{"class":f.attachmentsTitle},c.attach),a.tsx("ul",{"class":f.attachmentsItems},i.map(this._renderAttachmentInfo))):null},o.prototype._renderFieldInfo=function(e,t){var i=this.viewModel,r=i.formattedAttributes.content[t]||i.formattedAttributes.global,n=e.fieldName,o=e.label||n,s=null==r[n]?"":r[n],d=!(!e.format||!e.format.dateFormat),c=p.autoLink(s),l=(m={},m[f.fieldDataDate]=d,m);return a.tsx("tr",{key:_("fields-element-info-row",t)},a.tsx("th",{key:_("fields-element-info-row-header",t),"class":f.fieldHeader,innerHTML:o}),a.tsx("td",{key:_("fields-element-info-row-data",t),"class":f.fieldData,classes:l,innerHTML:c}));var m},o.prototype._renderFields=function(e,t){var i=this,r=e.fieldInfos;return r?a.tsx("div",{key:_("fields-element",t),"class":a.join(f.fields,f.contentElement)},a.tsx("table",{summary:c.fieldsSummary,key:_("fields-element-table",t)},a.tsx("tbody",{key:_("fields-element-table-body",t)},r.map(function(e){return i._renderFieldInfo(e,t)})))):null},o.prototype._shouldOpenInNewTab=function(e){void 0===e&&(e="");var t=/^(?:mailto:|tel:)/;return!t.test(e.trim().toLowerCase())},o.prototype._clearMediaRefreshTimers=function(){this._refreshTimers.forEach(function(e){return clearTimeout(e)}),this._refreshTimers.clear()},o.prototype._clearMediaRefreshTimer=function(e){var t=this._refreshTimers.get(e);t&&(clearTimeout(t),this._refreshTimers["delete"](e))},o.prototype._getImageSource=function(e,t){var i=-1!==e.indexOf("?")?"&":"?",r=e.split("#"),n=r[0],a=r[1],o=void 0===a?"":a,s=o?"#":"";return""+n+i+"timestamp="+t+s+o},o.prototype._setupMediaRefreshTimer=function(e){var t=this.get("viewModel.content");if(Array.isArray(t)){var i=t[e];if(i&&"media"===i.type){var r=this._activeMediaMap.get(e);isNaN(r)&&(r=0);var n=i.mediaInfos[r];n&&"image"===n.type&&n.refreshInterval&&this._setRefreshTimeout(e,n)}}},o.prototype._setupMediaRefreshTimers=function(){var e=this;this._clearMediaRefreshTimers();var t=this.get("viewModel.content");Array.isArray(t)&&t.forEach(function(t,i){return e._setupMediaRefreshTimer(i)})},o.prototype._updateMediaInfoTimestamp=function(e,t){var i=Date.now();this._mediaInfo.set(t,{timestamp:i,sourceURL:this._getImageSource(e,i)}),this.scheduleRender()},o.prototype._setRefreshTimeout=function(e,t){var i=this,r=t.refreshInterval,n=t.value;if(r){var a=6e4*r;this._updateMediaInfoTimestamp(n.sourceURL,e);var o=setInterval(function(){i._updateMediaInfoTimestamp(n.sourceURL,e)},a);this._refreshTimers.set(e,o)}},o.prototype._renderMediaInfoType=function(e,t){var i=e.value,r=e.title,n=void 0===r?"":r,o=e.type,s=e.refreshInterval,d=i.sourceURL,p=i.linkURL;if("image"===o){var c=!this._shouldOpenInNewTab(p),l=c?"_blank":"_self",m=s?this._mediaInfo.get(t):null,u=m?m.timestamp:0,h=m?m.sourceURL:d,v=a.tsx("img",{alt:n,key:_("media-image-"+u,t),src:h}),y=p?a.tsx("a",{title:n,href:p,target:l},v):null;return y?y:v}return-1!==o.indexOf("chart")?a.tsx("div",{key:_("chart",t),bind:this,"data-media-info":e,"data-content-element-index":t,"class":f.mediaChart,afterCreate:this._getChartDependencies,afterUpdate:this._getChartDependencies}):void 0},o.prototype._getChartDependencies=function(t){var i=this,r=t["data-media-info"],n=t["data-content-element-index"],a=r.value,o=a.theme||"Claro",s=r.type,p=["dojox/charting/Chart2D","dojox/charting/action2d/Tooltip"],c=o;"string"==typeof o&&(c=o.replace(/\./g,"/"),-1===c.indexOf("/")&&(c="dojox/charting/themes/"+c)),p.push(c),this._cancelChartModules(),this._chartRequirePromise=d.when(e,p).then(function(e){var r=e[0],o=e[1],d=e[2];i._renderChart(t,n,s,a,r,o,d),i._chartRequirePromise=null})},o.prototype._renderChart=function(e,t,i,r,n,a,o){var s=new n(e,{margins:{l:4,t:4,r:4,b:4}});switch(o&&s.setTheme(o),i){case"pie-chart":s.addPlot("default",{type:"Pie",labels:!1}),s.addSeries("Series A",r.fields);break;case"line-chart":s.addPlot("default",{type:"Markers"}),s.addAxis("x",{min:0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),s.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"}),r.fields.forEach(function(e,t){e.x=t+1}),s.addSeries("Series A",r.fields);break;case"column-chart":s.addPlot("default",{type:"Columns",gap:3}),s.addAxis("y",{includeZero:!0,vertical:!0,fixUpper:"minor"}),s.addSeries("Series A",r.fields);break;case"bar-chart":s.addPlot("default",{type:"Bars",gap:3}),s.addAxis("x",{includeZero:!0,fixUpper:"minor",minorLabels:!1}),s.addAxis("y",{vertical:!0,majorTicks:!1,minorTicks:!1,majorLabels:!1,minorLabels:!1}),s.addSeries("Series A",r.fields)}var d=new a(s);s.render(),this._chartMap.set(t,{chart:s,tooltip:d})},o.prototype._renderMediaInfo=function(e,t){this._destroyChart(t);var i=this._renderMediaInfoType(e,t),r=e.title?a.tsx("div",{key:_("media-title",t),"class":f.mediaItemTitle,innerHTML:e.title}):null,n=e.caption?a.tsx("div",{key:_("media-caption",t),"class":f.mediaItemCaption,innerHTML:e.caption}):null;return a.tsx("div",{key:_("media-container",t),"class":f.mediaItemContainer},a.tsx("div",{key:_("media-item-container",t),"class":f.mediaItem},i),r,n)},o.prototype._renderMediaStatsItem=function(e,t,i){var r="chart"===i?a.join(f.mediaChartIcon,f.iconChart):a.join(f.mediaImageIcon,f.iconMedia);return a.tsx("li",{"class":f.mediaImageSummary},a.tsx("span",{"class":f.mediaCount,"aria-label":e},"("+t+")"),a.tsx("span",{"aria-hidden":"true","class":r}))},o.prototype._renderMediaPageButton=function(e,t){var i="previous"===e,r=i?c.previous:c.next,n=i?a.join(f.btn,f.mediaPrevious):a.join(f.btn,f.mediaNext),o=i?a.join(f.icon,f.mediaPreviousIconLTR,f.iconLeftTriangleArrow):a.join(f.icon,f.mediaNextIconLTR,f.iconRightTriangleArrow),s=i?a.join(f.icon,f.mediaPreviousIconRTL,f.iconRightTriangleArrow):a.join(f.icon,f.mediaNextIconRTL,f.iconLeftTriangleArrow),d=i?"previous":"next",p=i?this._previousClick:this._nextClick;return a.tsx("div",{key:_(d,t),title:r,tabIndex:0,role:"button","class":n,"data-content-element-index":t,bind:this,onkeydown:p,onclick:p},a.tsx("span",{"aria-hidden":"true","class":o}),a.tsx("span",{"aria-hidden":"true","class":s}),a.tsx("span",{"class":f.iconText},r))},o.prototype._handleMediaKeyup=function(e){var t=e.currentTarget,i=t["data-content-element-index"],r=e.keyCode;r===m.LEFT_ARROW&&(e.stopPropagation(),this.previousMedia(i)),r===m.RIGHT_ARROW&&(e.stopPropagation(),this.nextMedia(i))},o.prototype._renderMedia=function(e,t){var i=e.mediaInfos,r=this._getMediaStats(i),n=r.total,o=(u={},u[f.showMediaPagination]=r.total>1,u),s=this._renderMediaStatsItem(c.numImages,r.images,"image"),d=this._renderMediaStatsItem(c.numCharts,r.charts,"chart"),p=this._renderMediaPageButton("previous",t),l=this._renderMediaPageButton("next",t),m=this._activeMediaMap.get(t);return isNaN(m)&&(this._activeMediaMap.set(t,0),m=0),n?a.tsx("div",{key:_("media-element",t),"data-content-element-index":t,bind:this,onkeyup:this._handleMediaKeyup,"class":a.join(f.media,f.contentElement),classes:o},a.tsx("ul",{"class":f.mediaSummary},s,d),a.tsx("div",{key:_("media-element-container",t),"class":f.mediaContainer},p,this._renderMediaInfo(i[m],t),l)):null;var u},o.prototype._renderText=function(e,t){var i=e.text;return i?a.tsx("div",{key:_("text-element",t),innerHTML:e.text,"class":a.join(f.text,f.contentElement)}):null},o.prototype._attachToNode=function(e){var t=this;e.appendChild(t)},o.prototype._getMediaStats=function(e){var t=0,i=0;return e.forEach(function(e){var r=e.type;"image"===r?t++:-1!==r.indexOf("chart")&&i++}),{total:i+t,images:t,charts:i}},o.prototype._setContentElementMedia=function(e,t){this._clearMediaRefreshTimer(e);var i=this.viewModel.content,r=i&&i[e],n=r&&r.mediaInfos;if(n&&n.length){var a=(t+n.length)%n.length;this._activeMediaMap.set(e,a),this._setupMediaRefreshTimer(e),this.scheduleRender()}},o.prototype._pageContentElementMedia=function(e,t){var i="previous"===t?-1:1,r=this._activeMediaMap.get(e)+i;this._setContentElementMedia(e,r)},o.prototype._previousClick=function(e){var t=e.currentTarget,i=t["data-content-element-index"];this.previousMedia(i)},o.prototype._nextClick=function(e){var t=e.currentTarget,i=t["data-content-element-index"];this.nextMedia(i)},r([n.aliasOf("viewModel.contentEnabled")],o.prototype,"contentEnabled",void 0),r([n.aliasOf("viewModel.graphic")],o.prototype,"graphic",void 0),r([n.aliasOf("viewModel.title")],o.prototype,"title",void 0),r([n.aliasOf("viewModel.view")],o.prototype,"view",void 0),r([n.property({type:s}),a.renderable(["viewModel.waitingForContent","viewModel.content"])],o.prototype,"viewModel",void 0),r([a.accessibleHandler()],o.prototype,"_previousClick",null),r([a.accessibleHandler()],o.prototype,"_nextClick",null),o=r([n.subclass("esri.widgets.Popup.PopupRenderer")],o)}(n.declared(o));return y});