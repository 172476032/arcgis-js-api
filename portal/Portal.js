// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/assignHelper","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/paramHelper","../core/accessorSupport/decorators","../core/Error","../config","../kernel","../request","../geometry/Extent","../core/global","../core/JSONSupport","../core/Loadable","./PortalQueryParams","./PortalQueryResult","./PortalUser","../core/promiseUtils","../core/requireUtils","../core/urlUtils","dojo/promise/all","dojo/_base/kernel","dojo/_base/lang","dojo/_base/url"],function(e,t,r,o,p,n,a,i,u,l,s,y,d,c,h,m,f,v,S,P,g,b,_,O,U){var G,M=function(t){function c(e){var r=t.call(this)||this;return r.access=null,r.allSSL=!1,r.authMode="auto",r.authorizedCrossOriginDomains=null,r.basemapGalleryGroupQuery=null,r.bingKey=null,r.canListApps=!1,r.canListData=!1,r.canListPreProvisionedItems=!1,r.canProvisionDirectPurchase=!1,r.canSearchPublic=!1,r.canShareBingPublic=!1,r.canSharePublic=!1,r.canSignInArcGIS=!1,r.canSignInIDP=!1,r.colorSetsGroupQuery=null,r.commentsEnabled=!1,r.created=null,r.culture=null,r.customBaseUrl=null,r.defaultBasemap=null,r.defaultExtent=null,r.defaultVectorBasemap=null,r.description=null,r.featuredGroups=null,r.featuredItemsGroupQuery=null,r.galleryTemplatesGroupQuery=null,r.livingAtlasGroupQuery=null,r.helperServices=null,r.homePageFeaturedContent=null,r.homePageFeaturedContentCount=null,r.httpPort=null,r.httpsPort=null,r.id=null,r.ipCntryCode=null,r.isPortal=!1,r.layerTemplatesGroupQuery=null,r.maxTokenExpirationMinutes=null,r.modified=null,r.name=null,r.portalHostname=null,r.portalMode=null,r.portalProperties=null,r.region=null,r.rotatorPanels=null,r.showHomePageDescription=!1,r.supportsHostedServices=!1,r.symbolSetsGroupQuery=null,r.templatesGroupQuery=null,r.units=null,r.url=u.portalUrl,r.urlKey=null,r.user=null,r.useStandardizedQuery=!1,r.useVectorBasemaps=!1,r.vectorBasemapGalleryGroupQuery=null,r}return o(c,t),h=c,c.prototype.normalizeCtorArgs=function(e){return"string"==typeof e?{url:e}:e},c.prototype.destroy=function(){this._esriId_credentialCreateHandle&&(this._esriId_credentialCreateHandle.remove(),this._esriId_credentialCreateHandle=null)},c.prototype.readAuthorizedCrossOriginDomains=function(e){if(e)for(var t=0,r=e;t<r.length;t++){var o=r[t],p=o;g.hasProtocol(p)||(p=g.appUrl.scheme+"://"+p),g.canUseXhr(p)||u.request.corsEnabledServers.push({host:o,withCredentials:!0})}return e},c.prototype.readDefaultBasemap=function(e){if(e){var t=G.fromJSON(e);return t.portalItem={portal:this},t}return null},c.prototype.readDefaultVectorBasemap=function(e){if(e){var t=G.fromJSON(e);return t.portalItem={portal:this},t}return null},Object.defineProperty(c.prototype,"extraQuery",{get:function(){return this.id&&!this.canSearchPublic?" AND orgid:"+this.id:null},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"isOrganization",{get:function(){return!!this.access},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"restUrl",{get:function(){var e=this.url;if(e){var t=e.indexOf("/sharing");e=t>0?e.substring(0,t):this.url.replace(/\/+$/,""),e+="/sharing/rest"}return e},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"thumbnailUrl",{get:function(){var e=this.restUrl,t=this.thumbnail;return e&&t?this._normalizeSSL(e+"/portals/self/resources/"+t):null},enumerable:!0,configurable:!0}),c.prototype.readUrlKey=function(e){return e?e.toLowerCase():e},c.prototype.readUser=function(e){var t=null;return e&&(t=v.fromJSON(e),t.portal=this),t},c.prototype.load=function(){var t=this,r=P.when(e,"../Basemap").then(function(e){G=e}).then(function(){return t._fetchSelf()}).then(function(e){if(l.id){var r=l.id;t.credential=r.findCredential(t.restUrl),t.credential||t.authMode!==h.AUTH_MODE_AUTO||(t._esriId_credentialCreateHandle=r.on("credential-create",function(){r.findCredential(t.restUrl)&&t._signIn()}))}t.read(e)});return this.addResolvingPromise(r),this},c.prototype.fetchBasemaps=function(e){var t=new m;return t.query=e||(this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),t.disableExtraQuery=!0,this.queryGroups(t).then(function(e){if(t.num=100,t.query='type:"Web Map" -type:"Web Application"',e.total){var r=e.results[0];return t.sortField=r.sortField||"name",t.sortOrder=r.sortOrder||"desc",r.queryItems(t)}return null}).then(function(e){var t;return t=e&&e.total?e.results.filter(function(e){return"Web Map"===e.type}).map(function(e){return new G({portalItem:e})}):[]})},c.prototype.fetchFeaturedGroups=function(){var e=this.featuredGroups,t=new m;if(t.num=100,t.sortField="title",e&&e.length){for(var r=[],o=0,p=e;o<p.length;o++){var n=p[o];r.push('(title:"'+n.title+'" AND owner:'+n.owner+")")}return t.query=r.join(" OR "),this.queryGroups(t).then(function(e){return e.results})}return S.resolve([])},c.getDefault=function(){return h._default||(h._default=new h),h._default},c.prototype.queryGroups=function(e){return this._queryPortal("/community/groups",e,"PortalGroup")},c.prototype.queryItems=function(e){return this._queryPortal("/search",e,"PortalItem")},c.prototype.queryUsers=function(e){return e.sortField||(e.sortField="username"),this._queryPortal("/community/users",e,"PortalUser")},c.prototype.toJSON=function(){throw new i("internal:not-yet-implemented","Portal.toJSON is not yet implemented")},c.prototype._fetchSelf=function(e){void 0===e&&(e=this.authMode);var t=this.restUrl+"/portals/self",r={authMode:e,query:{culture:_.locale}};return"auto"===r.authMode&&(r.authMode="no-prompt"),this._request(t,r)},c.prototype._queryPortal=function(t,r,o){var p=this,n=function(e){return p._request(p.restUrl+t,r.toRequestOptions(p)).then(function(t){var o=r.clone();return o.start=t.nextStart,new f({nextQueryParams:o,queryParams:r,total:t.total,results:h._resultsToTypedArray(e,{portal:p},t)})}).then(function(e){return b(e.results).always(function(){return e})})};return o?P.when(e,"./"+o).then(function(e){return n(e)}):n()},c.prototype._signIn=function(){var e=this;if(this.authMode===h.AUTH_MODE_ANONYMOUS)return S.reject(new i("portal:invalid-auth-mode",'Current "authMode"\' is "'+this.authMode+'"'));if("failed"===this.loadStatus)return S.reject(this.loadError);var t=function(t){return S.resolve().then(function(){return"not-loaded"===e.loadStatus?(t||(e.authMode="immediate"),e.load().then(function(){return null})):"loading"===e.loadStatus?e.load().then(function(){return e.credential?null:(e.credential=t,e._fetchSelf("immediate"))}):e.user&&e.credential===t?null:(e.credential=t,e._fetchSelf("immediate"))}).then(function(t){t&&e.read(t)})};return l.id?l.id.getCredential(this.restUrl).then(function(e){return t(e)}):t(this.credential)},c.prototype._normalizeSSL=function(e){var t=this.allSSL;if(t||("isSecureContext"in d?t=d.isSecureContext:d.location&&d.location.origin&&(t=0===d.location.origin.indexOf("https:"))),this.isPortal){var r=new U(e);return this.portalHostname.toLowerCase().indexOf(r.host.toLowerCase())>-1&&r.port&&"80"!==r.port&&"443"!==r.port?t?"https://"+r.host+(this.httpsPort&&443!==this.httpsPort?":"+this.httpsPort:"")+r.path+"?"+r.query:"http://"+r.host+(this.httpPort&&80!==this.httpPort?":"+this.httpPort:"")+r.path+"?"+r.query:t?e.replace("http:","https:"):e}return t?e.replace("http:","https:"):e},c.prototype._normalizeUrl=function(e){var t=this.credential&&this.credential.token;return this._normalizeSSL(t?e+(e.indexOf("?")>-1?"&":"?")+"token="+t:e)},c.prototype._requestToTypedArray=function(t,r,o){var p=this,n=function(e){return p._request(t,r).then(function(t){var r=h._resultsToTypedArray(e,{portal:p},t);return b(r).always(function(){return r})})};return o?P.when(e,"./"+o).then(function(e){return n(e)}):n()},c.prototype._request=function(e,t){var o=this.authMode===h.AUTH_MODE_ANONYMOUS?"anonymous":"auto",p=null,n="auto",a={f:"json"},i="json";t&&(t.authMode&&(o=t.authMode),t.body&&(p=t.body),t.method&&(n=t.method),t.query&&(a=r({},a,t.query)),t.responseType&&(i=t.responseType));var u={authMode:o,body:p,callbackParamName:"callback",method:n,query:a,responseType:i,timeout:0};return s(this._normalizeSSL(e),u).then(function(e){return e.data})},c._resultsToTypedArray=function(e,t,r){var o;return r?(o=r.listings||r.notifications||r.userInvitations||r.tags||r.items||r.groups||r.comments||r.provisions||r.results||r.relatedItems||r,(e||t)&&(o=o.map(function(r){var o=O.mixin(e?e.fromJSON(r):r,t);return"function"==typeof o.load&&o.load(),o}))):o=[],o},c.AUTH_MODE_ANONYMOUS="anonymous",c.AUTH_MODE_AUTO="auto",c.AUTH_MODE_IMMEDIATE="immediate",p([a.property()],c.prototype,"access",void 0),p([a.property()],c.prototype,"allSSL",void 0),p([a.property()],c.prototype,"authMode",void 0),p([a.property()],c.prototype,"authorizedCrossOriginDomains",void 0),p([a.reader("authorizedCrossOriginDomains")],c.prototype,"readAuthorizedCrossOriginDomains",null),p([a.property()],c.prototype,"basemapGalleryGroupQuery",void 0),p([a.property()],c.prototype,"bingKey",void 0),p([a.property()],c.prototype,"canListApps",void 0),p([a.property()],c.prototype,"canListData",void 0),p([a.property()],c.prototype,"canListPreProvisionedItems",void 0),p([a.property()],c.prototype,"canProvisionDirectPurchase",void 0),p([a.property()],c.prototype,"canSearchPublic",void 0),p([a.property()],c.prototype,"canShareBingPublic",void 0),p([a.property()],c.prototype,"canSharePublic",void 0),p([a.property()],c.prototype,"canSignInArcGIS",void 0),p([a.property()],c.prototype,"canSignInIDP",void 0),p([a.property()],c.prototype,"colorSetsGroupQuery",void 0),p([a.property()],c.prototype,"commentsEnabled",void 0),p([a.property({type:Date})],c.prototype,"created",void 0),p([a.property()],c.prototype,"credential",void 0),p([a.property()],c.prototype,"culture",void 0),p([a.property()],c.prototype,"customBaseUrl",void 0),p([a.property()],c.prototype,"defaultBasemap",void 0),p([a.reader("defaultBasemap")],c.prototype,"readDefaultBasemap",null),p([a.property({type:y})],c.prototype,"defaultExtent",void 0),p([a.property()],c.prototype,"defaultVectorBasemap",void 0),p([a.reader("defaultVectorBasemap")],c.prototype,"readDefaultVectorBasemap",null),p([a.property()],c.prototype,"description",void 0),p([a.property({dependsOn:["id","canSearchPublic"],readOnly:!0})],c.prototype,"extraQuery",null),p([a.property()],c.prototype,"featuredGroups",void 0),p([a.property()],c.prototype,"featuredItemsGroupQuery",void 0),p([a.property()],c.prototype,"galleryTemplatesGroupQuery",void 0),p([a.property()],c.prototype,"livingAtlasGroupQuery",void 0),p([a.property()],c.prototype,"helpBase",void 0),p([a.property()],c.prototype,"helperServices",void 0),p([a.property()],c.prototype,"helpMap",void 0),p([a.property()],c.prototype,"homePageFeaturedContent",void 0),p([a.property()],c.prototype,"homePageFeaturedContentCount",void 0),p([a.property()],c.prototype,"httpPort",void 0),p([a.property()],c.prototype,"httpsPort",void 0),p([a.property()],c.prototype,"id",void 0),p([a.property()],c.prototype,"ipCntryCode",void 0),p([a.property({dependsOn:["access"],readOnly:!0})],c.prototype,"isOrganization",null),p([a.property()],c.prototype,"isPortal",void 0),p([a.property()],c.prototype,"layerTemplatesGroupQuery",void 0),p([a.property()],c.prototype,"maxTokenExpirationMinutes",void 0),p([a.property({type:Date})],c.prototype,"modified",void 0),p([a.property()],c.prototype,"name",void 0),p([a.property()],c.prototype,"portalHostname",void 0),p([a.property()],c.prototype,"portalMode",void 0),p([a.property()],c.prototype,"portalProperties",void 0),p([a.property()],c.prototype,"region",void 0),p([a.property({dependsOn:["url"],readOnly:!0})],c.prototype,"restUrl",null),p([a.property()],c.prototype,"rotatorPanels",void 0),p([a.property()],c.prototype,"showHomePageDescription",void 0),p([a.property()],c.prototype,"staticImagesUrl",void 0),p([a.property()],c.prototype,"stylesGroupQuery",void 0),p([a.property()],c.prototype,"supportsHostedServices",void 0),p([a.property()],c.prototype,"symbolSetsGroupQuery",void 0),p([a.property()],c.prototype,"templatesGroupQuery",void 0),p([a.property()],c.prototype,"thumbnail",void 0),p([a.property({dependsOn:["restUrl","thumbnail"],readOnly:!0})],c.prototype,"thumbnailUrl",null),p([a.property()],c.prototype,"units",void 0),p([a.property()],c.prototype,"url",void 0),p([a.property()],c.prototype,"urlKey",void 0),p([a.reader("urlKey")],c.prototype,"readUrlKey",null),p([a.property()],c.prototype,"user",void 0),p([a.reader("user")],c.prototype,"readUser",null),p([a.property()],c.prototype,"useStandardizedQuery",void 0),p([a.property()],c.prototype,"useVectorBasemaps",void 0),p([a.property()],c.prototype,"vectorBasemapGalleryGroupQuery",void 0),p([n(1,a.cast(m))],c.prototype,"_queryPortal",null),c=h=p([a.subclass("esri.portal.Portal")],c);var h}(a.declared(c,h));return M});