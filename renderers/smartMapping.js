// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
define(["require","module","dojo/_base/array","dojo/_base/lang","dojo/has","dojo/Deferred","dojo/DeferredList","dojo/promise/all","dojo/when","../kernel","../Color","../numberUtils","../styles/type","../styles/size","../styles/choropleth","../styles/heatmap","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","./UniqueValueRenderer","./ClassBreaksRenderer","./HeatmapRenderer","./BlendRenderer","./utils","dojo/i18n!../nls/jsapi"],function(e,a,n,t,r,i,l,o,s,u,c,m,d,f,p,h,g,v,y,b,w,S,z,C,I){function V(n){return e.toAbsMid?e.toAbsMid(n):a.id.replace(/\/[^\/]*$/gi,"/")+n}function M(e,a){e.reject(new Error(a))}function x(e,a,n,t){var r,i;switch(n){case"point":r=new g,r.setColor(a),r.setSize(null!=t?t:e.size),i=new v,i.setColor(e.outline.color),i.setWidth(e.outline.width),r.setOutline(i);break;case"line":r=new v,r.setColor(a),r.setWidth(null!=t?t:e.width);break;case"polygon":r=new y,r.setColor(a),i=new v,i.setColor(e.outline.color),i.setWidth(e.outline.width),r.setOutline(i)}return r}function R(e){var a=e.geometryType;return"esriGeometryPoint"===a||"esriGeometryMultipoint"===a?a="point":"esriGeometryPolyline"===a?a="line":"esriGeometryPolygon"===a&&(a="polygon"),a}function F(e,a){var n=e.scheme;return n?n=d.cloneScheme(n):(n=d.getSchemes({theme:e.theme||ma,basemap:e.basemap,geometryType:a}),n=n&&n.primaryScheme),n}function k(e,a){var n;return n=e.label<a.label?-1:e.label>a.label?1:0}function O(e,a){var n;return n=e.value<a.value?-1:e.value>a.value?1:0}function P(e,a){var n=a.count-e.count;return 0===n&&(n=k(e,a)),n}function D(e,a){var n=a.count-e.count;return 0===n&&(n=O(e,a)),n}function T(e,a,n){var t;"count"===a?(t=D,n&&n.codedValues&&(t=P)):"value"===a&&(t=O,n&&n.codedValues&&(t=k)),t&&e.sort(t)}function B(e,a,r){var i,l,o,s,u=r.layer,c=r.field,m=t.isFunction(c),d=m?null:u.getField(c),f=m?null:u.getDomain(d.name),p=-1,h=null==r.numTypes?10:-1===r.numTypes?e.length:r.numTypes,g=null==r.showOthers?!0:r.showOthers,v=null==r.sortBy?"count":r.sortBy,y=r&&r.labelCallback,w=R(u),S=F(r,w),z=new b(null,c),I={domain:f,fieldInfo:d};for(n.forEach(e,function(e,a){I.value=e.value,e.label=C.createUniqueValueLabel(I),y&&(e.label=y(e)),null===e.value&&(p=a)}),p>-1&&(s=e.splice(p,1)[0]),T(e,v,f),I.dateFormatInterval=C.calculateDateFormatInterval(n.map(n.filter(e,function(e,a){return h>a}),function(e){return e.value})),o=sa.createColors(S.colors,e.length),n.forEach(e,function(e,a){I.value=e.value,e.label=C.createUniqueValueLabel(I),y&&(e.label=y(e)),e.symbol=x(S,o[a],w)}),o=sa.createColors(S.colors,h),i=0;h>i;i++)l=e[i],l&&z.addValue({value:l.value,label:l.label,symbol:x(S,o[i],w)});return g&&(z.defaultSymbol=x(S,S.noDataColor,w),z.defaultLabel=ca.other),s&&(s.symbol=x(S,S.noDataColor,w),e.push(s)),a&&a.widthInfo&&z.setVisualVariables([a.widthInfo]),{renderer:z,uniqueValueInfos:e,othersStartIndex:z.infos.length===e.length?-1:z.infos.length,scheme:F(r,w)}}function j(e,a,n,t){var r=B(e.uniqueValueInfos,a,n);r.source=e.source,t.resolve(r)}function q(e,a,n){var t=e.scheme;return t?t=p.cloneScheme(t):(t=p.getSchemes({theme:n||e.theme||da,basemap:e.basemap,geometryType:a}),t=t&&t.primaryScheme),t}function L(e){var a,n=e.avg,t=n-e.stddev,r=n+e.stddev;return t<e.min&&(t=e.min),r>e.max&&(r=e.max),a=m.round([t,r],{strictBounds:!0}),t=a[0],r=a[1],a=[t,t+(n-t)/2,n,n+(r-n)/2,r],m.round(a,{strictBounds:!0})}function E(e,a,n){var t,r=(a-e)/(n-1),i=[e];for(t=1;n-2>=t;t++)i.push(e+t*r);return i.push(a),m.round(i,{strictBounds:!0})}function H(e,a){var n,t;return null==e.min?(n=0,t=100):e.min===e.max?e.min<0?(n=2*e.min,t=0):e.min>0?(n=0,t=2*e.min):(n=0,t=100):!a||null!=e.avg&&e.stddev||(n=e.min,t=e.max),null!=n?[n,t]:null}function U(e,a,t,r,i){var l=null==r.useDefaultStatistics?!0:r.useDefaultStatistics;if(e&&!e.count&&!l)return void M(i,"smartMapping.createColorInfo: cannot create renderer when statistics.count is 0.");var o,s,u,d=r.layer,f=r.field,p=R(d),h=q(r,p),g=r.semiContinuous,v=a&&a.classBreakInfos,y=v&&v.length,b=a?y:5;if(!h)return void M(i,"smartMapping.createColorInfo: unable to find the specified scheme.");var w=a&&h.id.indexOf("seq-")>-1?Q(h,{length:b}):sa.createColors(h.colors,b);if(w.length<b)return void M(i,"smartMapping.createColorInfo: not enough colors in the scheme.");if(a){o=[];var S;1===y?(s=[v[0].minValue,v[0].maxValue],o=[0,1],S=sa.createColors(w,b)[0],u=[S,new c(S)]):g?(s=[],u=[],n.forEach(v,function(e,a){var n=e.maxValue-e.minValue,t=.1*n;s.push(0===a?e.minValue:e.minValue+t),s.push(a===y-1?e.maxValue:e.maxValue-t),S=new c(w[a]),u.push(S),u.push(new c(S)),o.push(2*a),o.push(2*a+1)})):(s=n.map(v,function(e,a){return o.push(a),(e.minValue+e.maxValue)/2}),u=sa.createColors(w,b)),s=m.round(s,{strictBounds:!0})}else{var z=l?H(e,!0):null;s=z?E(z[0],z[1],5):L(e),o=[0,2,4],u=sa.createColors(w,b)}var I={type:"colorInfo",field:f,normalizationField:t,stops:C.createColorStops({values:s,colors:u,labelIndexes:o})};i.resolve({colorInfo:I,statistics:e,classBreaks:a,scheme:q(r,p)})}function G(e,a,n,t,r,i){var l=r.layer,o=r.field,s=R(l),u=null==r.showOthers?!0:r.showOthers,c=p.cloneScheme(e.scheme),m=new w(null,o);u&&(m.defaultSymbol=x(c,c.noDataColor,s),m.defaultLabel=ca.other),m.addBreak({minValue:-ua,maxValue:ua,symbol:x(c,c.noDataColor,s)}),m.normalizationType=n,m.normalizationField=t;var d=[C.cloneColorInfo(e.colorInfo)];a&&a.widthInfo&&d.push(a.widthInfo),m.setVisualVariables(d),i.resolve({renderer:m,colorInfo:C.cloneColorInfo(e.colorInfo),statistics:e.statistics,classBreaks:e.classBreaks,scheme:p.cloneScheme(e.scheme)})}function W(e,a,n,t){var r=null==n.useDefaultStatistics?!0:n.useDefaultStatistics;if(e&&!e.count&&!r)return void M(t,"smartMapping.createOpacityInfo: cannot create opacityInfo when statistics.count is 0.");var i=n.useStdDev,l=i?L(e):null,o=r?H(e,i):null,s=o||(i?[l[0],l[4]]:[e.min,e.max]),u={type:"opacityInfo",field:n.field,normalizationField:a,stops:[{value:s[0],opacity:.3},{value:s[1],opacity:.7}]};t.resolve({opacityInfo:u,statistics:e,defaultStatistics:!!o})}function A(e,a){var n=e.scheme;return n?n=f.cloneScheme(n):(n=f.getSchemes({theme:e.theme||fa,basemap:e.basemap,geometryType:a}),n=n&&n.primaryScheme),n}function _(e,a){var n;switch(a){case"point":n=[e.minSize,e.maxSize];break;case"line":n=[e.minWidth,e.maxWidth];break;case"polygon":n=[e.marker.minSize,e.marker.maxSize]}return n}function $(e,a,n,t,r){var i=null==t.useDefaultStatistics?!0:t.useDefaultStatistics,l=a&&[a.minSize,a.maxSize];if(e&&!e.count&&!i)return void M(r,"smartMapping.createSizeInfo: cannot create renderer when statistics.count is 0.");var o=t.layer,s=t.field,u=R(o),c=A(t,u),m=l||_(c,u),d=t.useStdDev,f=d?L(e):null,p=i?H(e,d):null,h=p||(d?[f[0],f[4]]:[e.min,e.max]),g={type:"sizeInfo",field:s,valueUnit:"unknown",normalizationField:n,minSize:m[0],maxSize:m[1],minDataValue:h[0],maxDataValue:h[1]};r.resolve({sizeInfo:g,statistics:e,defaultStatistics:!!p,suggestedSizeRange:a,scheme:A(t,u)})}function J(e,a,n,t,r,i){var l=r.layer,o=r.field,s=R(l),u=null==r.showOthers?!0:r.showOthers,c=f.cloneScheme(e.scheme),m="polygon"===s,d=m?c.marker:c,p=m?c.background:null,h="line"===s?d.noDataWidth:d.noDataSize,g=new w(null,o);u&&(g.defaultSymbol=x(d,d.noDataColor,m?"point":s,h),g.defaultLabel=ca.other),g.addBreak({minValue:-ua,maxValue:ua,symbol:x(d,d.color,m?"point":s)}),p&&(g.backgroundFillSymbol=x(p,p.color,s)),g.normalizationType=n,g.normalizationField=t;var v=[C.cloneSizeInfo(e.sizeInfo)];a&&a.widthInfo&&v.push(a.widthInfo),g.setVisualVariables(v),i.resolve({renderer:g,sizeInfo:C.cloneSizeInfo(e.sizeInfo),statistics:e.statistics,defaultStatistics:e.defaultStatistics,suggestedSizeRange:e.suggestedSizeRange,scheme:f.cloneScheme(e.scheme)})}function K(e,a,n){var t,r=[],i=1/(n+1);for(t=1;n>=t;t++)r.push(c.blendColors(e,a,i*t));return r}function N(e,a){var n=[];if(1===a)n=[e[0]];else if(2===a)n=[e[0],e[2]];else if(3===a)n=e;else{var t,r,i=a-e.length,l=i/2;i%2===0?(t=K(e[0],e[1],l),r=K(e[1],e[2],l)):(t=K(e[0],e[1],Math.floor(l)),r=K(e[1],e[2],Math.ceil(l))),n=[e[0]].concat(t).concat([e[1]]).concat(r).concat([e[2]])}return n}function Q(e,a,t){var r,i=a.length,l=-1;if(t&&n.some(a,function(e,a){return e.hasAvg&&(l=a),l>-1}),l>-1){var o=e.colors,s=l+1,u=i-l,c=o.slice(0,3),m=o.slice(2);c.reverse(),c=N(c,s),m=N(m,u),c.reverse(),r=[].concat(c).concat(m.slice(1))}else{var d=e.colorsForClassBreaks;if(d&&d.length>0&&(n.some(d,function(e){return e.numClasses===i&&(r=e.colors),!!r}),!r)){var f=d[d.length-1],p=i-f.numClasses;if(p>0){var h,g=f.colors[f.numClasses-1];for(r=f.colors.splice(0),h=1;p>=h;h++)r.push(g)}}}return r&&(r=sa.createColors(r,r.length)),r}function X(e,a,t,r){var i,l,o,s=t.layer,u=t.field,c=R(s),m=null==t.showOthers?!0:t.showOthers,d=t.classificationMethod||"equal-interval",f="standard-deviation"===d,p=t.normalizationType,h="high-to-low",g=e.classBreakInfos;return(i=q(t,c,h))?(l=Q(i,g),l&&l.length==g.length?(o=new w(null,u),o.classificationMethod=d,o.normalizationType=p,o.normalizationField="field"===p?t.normalizationField:void 0,o.normalizationTotal="percent-of-total"===p?e.normalizationTotal:void 0,m&&(o.defaultSymbol=x(i,i.noDataColor,c),o.defaultLabel=ca.other),n.forEach(g,function(e,a){o.addBreak({minValue:e.minValue,maxValue:e.maxValue,symbol:x(i,l[a],c),label:e.label})}),f||C.setLabelsForClassBreaks({classBreaks:o.infos,classificationMethod:d,normalizationType:p,round:!0}),a&&a.widthInfo&&o.setVisualVariables([a.widthInfo]),e.renderer=o,e.scheme=q(t,c,h),void r.resolve(e)):void M(r,"smartMapping.createClassedColorRenderer: unable to find suitable colors for number of classes.")):void M(r,"smartMapping.createClassedColorRenderer: unable to find suitable style scheme.")}function Y(e,a){return a.layer.statisticsPlugin.getClassBreaks(t.mixin(a,{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:e[0],maxValue:e[1],normalizationTotal:e[0]+e[1]}))}function Z(e){var a=new i,n=e.layer,t=null==e.useDefaultBreaks?!0:e.useDefaultBreaks,r=e.optimizeOutline,o=[n.statisticsPlugin.getClassBreaks(e)];return r&&o.push(n.statisticsPlugin.getSuggestedOutline("object"==typeof r?r:null)),new l(o).then(function(i){var l=i[0],o=i[1],u=r&&o[0]?o[1]:null;if(l[0]||t&&!n.graphics.length){var c=l[1],m=t?H(c?{min:c.minValue,max:c.maxValue}:{}):null;m&&(c=Y(m,e)),s(c).then(function(e){e.defaultStatistics=!!m,a.resolve({cbResponse:e,suggestedOutline:u})}).otherwise(function(){M(a,"smartMapping: error when calculating default class breaks.")})}else M(a,"smartMapping: error when calculating class breaks.")}),a.promise}function ea(e,a,n,t){var r,i=t||_(e,a),l=i[0],o=i[1],s=(o-l)/(n>=4?n-1:n),u=[];for(r=0;n>r;r++)u.push(l+s*r);return u}function aa(e,a,t,r,i){var l,o=r.layer,s=r.field,u=R(o),c=null==r.showOthers?!0:r.showOthers,m=r.classificationMethod||"equal-interval",d=r.normalizationType,f=e.classBreakInfos,p=A(r,u),h=ea(p,u,f.length,a),g="polygon"===u,v=g?p.marker:p,y=g?p.background:null;l=new w(null,s),l.classificationMethod=m,l.normalizationType=d,l.normalizationField="field"===d?r.normalizationField:void 0,l.normalizationTotal="percent-of-total"===d?e.normalizationTotal:void 0,c&&(l.defaultSymbol=x(v,v.noDataColor,g?"point":u),l.defaultLabel=ca.other),y&&(l.backgroundFillSymbol=x(y,y.color,u)),n.forEach(f,function(e,a){l.addBreak({minValue:e.minValue,maxValue:e.maxValue,symbol:x(v,v.color,g?"point":u,h[a]),label:e.label})}),"standard-deviation"!==m&&C.setLabelsForClassBreaks({classBreaks:l.infos,classificationMethod:m,normalizationType:d,round:!0}),t&&t.widthInfo&&l.setVisualVariables([t.widthInfo]),e.renderer=l,e.scheme=A(r,u),i.resolve(e)}function na(e){var a=e.scheme;return a?a=h.cloneScheme(a):(a=h.getSchemes({theme:e.theme||pa,basemap:e.basemap}),a=a&&a.primaryScheme),a}function ta(e,a,t){var r=null==a.useDefaultStatistics?!0:a.useDefaultStatistics;if(!e.count&&!r)return void M(t,"smartMapping.createHeatmapRenderer: cannot create renderer when statistics.count is 0.");var i=e.fieldOffset,l=null==a.blurRadius?10:a.blurRadius,o=null==a.minRatio?.01:a.minRatio,s=null==a.maxRatio?1:a.maxRatio,u=null==a.fadeToTransparent?!0:a.fadeToTransparent,m=na(a),d=m.colors,f=d.length,p=!e.count&&r,h=p?[0,100]:[e.min,e.max],g=new S;g.setBlurRadius(l),g.setField(a.field),null!=i&&g.setFieldOffset(i),g.setMinPixelIntensity(h[0]),g.setMaxPixelIntensity(h[1]);var v=d[0],y=[{ratio:0,color:new c([v.r,v.g,v.b,0])},{ratio:ha,color:new c([v.r,v.g,v.b,0])},{ratio:u?o:ha,color:v}],b=(s-o)/(f-1);d=sa.createColors(d,f),n.forEach(d,function(e,a){y.push({ratio:o+b*a,color:e})}),g.setColorStops(y),t.resolve({renderer:g,statistics:e,defaultStatistics:p,scheme:na(a)})}function ra(e){return function(a){var t,r=a.attributes,i=-1/0,l=null;return r&&n.forEach(e,function(e){t=r[e],null!=t&&(t>i?(i=t,l=e):t===i&&(l=null))}),l}}function ia(e,a){var t={};return n.forEach(e,function(e){var n=a.getField(e.name);t[e.name]=e.label||n&&n.alias||e.name}),function(e){return t[e.value]}}function la(e,a){return function(t){var r,i,l,o=t.attributes,s=0,u=null;return o&&(i=a.getUniqueValueInfo(t),r=i&&o[i.value]),null!=r&&(n.forEach(e,function(e){l=o[e],null!=l&&(s+=l)}),0!==s&&(u=r/s)),u}}function oa(e,a,t,r){var i=t.layer,l=t.fields,o=ra(a),s=n.map(l,function(e){return{value:e.name,count:0}}),u=B(s,null,{layer:i,field:o,labelCallback:ia(l,i),numTypes:-1,showOthers:t.showOthers,sortBy:"value",theme:t.theme,basemap:t.basemap,scheme:t.scheme}),c={renderer:u.renderer,scheme:u.scheme,sampleInfo:e};t&&t.includeOpacityInfo?sa.createOpacityInfo({layer:i,field:la(a,c.renderer),features:e.features,useStdDev:!0}).then(function(e){c.renderer.setVisualVariables([e.opacityInfo]),r.resolve(c)}).otherwise(function(){console.log("smartMapping.createPredominanceRenderer: unable to create oapcityInfo."),r.resolve(c)}):r.resolve(c)}var sa={},ua=Math.pow(2,53)-1,ca=I.smartMapping,ma="default",da="high-to-low",fa="default",pa="default",ha=.01,ga=V("../plugins/FeatureLayerStatistics");return t.mixin(sa,{createColors:function(e,a){var n,t=[],r=e.length;for(n=0;a>n;n++)t.push(new c(e[n%r]));return t},createTypeRenderer:function(e){var a=new i;if(!(e&&e.layer&&e.field&&(e.scheme||e.basemap)))return M(a,"smartMapping.createTypeRenderer: missing parameters."),a.promise;var n=e.layer,t=e.optimizeOutline;return n.addPlugin(ga).then(function(){var r=[n.statisticsPlugin.getUniqueValues({field:e.field,includeAllCodedValues:e.includeAllCodedValues})];t&&r.push(n.statisticsPlugin.getSuggestedOutline("object"==typeof t?t:null)),new l(r).then(function(n){var r=n[0],i=n[1],l=t&&i[0]?i[1]:null;r[0]?j(r[1],l,e,a):M(a,"smartMapping.createTypeRenderer: error when calculating unique values.")})}).otherwise(function(){M(a,"smartMapping.createTypeRenderer: error when adding feature layer statistics plugin.")}),a.promise},createColorInfo:function(e){var a=new i;if(!(e&&e.layer&&e.field))return M(a,"smartMapping.createColorInfo: missing parameters."),a.promise;var n=e.layer,t=e.normalizationField,r=t?"field":void 0;return e.statistics?U(e.statistics,null,t,e,a):n.addPlugin(ga).then(function(){var i="group-similar"===e.theme||e.scheme&&0===e.scheme.id.indexOf("group-similar/"),l=i?n.statisticsPlugin.getClassBreaks({field:e.field,classificationMethod:"natural-breaks",numClasses:e.numGroups||5,normalizationType:r,normalizationField:t,minValue:e.minValue,maxValue:e.maxValue}):n.statisticsPlugin.getFieldStatistics({field:e.field,normalizationType:r,normalizationField:t,minValue:e.minValue,maxValue:e.maxValue});l.then(function(n){var r,l;i?r=n:l=n,U(l,r,t,e,a)}).otherwise(function(){M(a,i?"smartMapping.createColorInfo: error when calculating class breaks.":"smartMapping.createColorInfo: error when calculating field statistics.")})}).otherwise(function(){M(a,"smartMapping.createColorInfo: error when adding feature layer statistics plugin.")}),a.promise},createColorRenderer:function(e){var a=new i;if(!(e&&e.layer&&e.field))return M(a,"smartMapping.createColorRenderer: missing parameters."),a.promise;var n=e.layer,t=e.normalizationField,r=t?"field":void 0,o=e.optimizeOutline;return n.addPlugin(ga).then(function(){var i=[sa.createColorInfo(e)];o&&i.push(n.statisticsPlugin.getSuggestedOutline("object"==typeof o?o:null)),new l(i).then(function(n){var i=n[0],l=n[1],s=o&&l[0]?l[1]:null;i[0]?G(i[1],s,r,t,e,a):M(a,"smartMapping.createColorRenderer: error when calculating colorInfo.")})}).otherwise(function(){M(a,"smartMapping.createColorRenderer: error when adding feature layer statistics plugin.")}),a.promise},createOpacityInfo:function(e){var a=new i;if(!(e&&e.layer&&e.field))return M(a,"smartMapping.createOpacityInfo: missing parameters."),a.promise;var n=e.layer,t=e.normalizationField,r=t?"field":void 0;return e.statistics?W(e.statistics,t,e,a):n.addPlugin(ga).then(function(){n.statisticsPlugin.getFieldStatistics({field:e.field,normalizationType:r,normalizationField:t,minValue:e.minValue,maxValue:e.maxValue,features:e.features}).then(function(n){W(n,t,e,a)}).otherwise(function(){M(a,"smartMapping.createOpacityInfo: error when calculating field statistics.")})}).otherwise(function(){M(a,"smartMapping.createOpacityInfo: error when adding feature layer statistics plugin.")}),a.promise},createBlendRenderer:function(e){var a,t,r=new i,l=this,s=[],u={},m=[],d=[],f=e.opacityValueCombinationMethod||"avg",p={};return e&&e.layer&&e.blendedFields?(e.basemap=e.basemap||"topo",t=R(e.layer),a=F({basemap:e.basemap},t),a.colors=[new c("#e60000"),new c("#0000e6"),new c("#00e600"),new c("#e67300"),new c("#a900e6")],p.fields=[],p.normalizationField=e.normalizationField,p.blendMode=e.blendMode||"source-over",p.symbol=x(a,a.noDataColor,e.markers?"point":t),u.layer=e.layer,u.normalizationField=e.normalizationField,u.useStdDev=e.useStdDev||!1,s=n.map(e.blendedFields,function(e,n){return p.fields.push({field:e,color:a.colors[n]}),u.field=e,l.createOpacityInfo(u)}),o(s).then(function(t){d[0]=t[0].opacityInfo.stops[0].value,d[1]=t[1].opacityInfo.stops[1].value,n.forEach(t.slice(0,1),function(e){var a=e.opacityInfo.stops[0].value,n=e.opacityInfo.stops[1].value;"union"===f?(d[0]=a<d[0]?a:d[0],d[1]=n>d[1]?n:d[1]):"avg"===f&&(d[0]+=e.opacityInfo.stops[0].value,d[1]+=e.opacityInfo.stops[1].value)}),m[0]={value:"avg"===f?d[0]/t.length:d[0],opacity:e.minOpacity?e.minOpacity:t[0].opacityInfo.stops[0].opacity},m[1]={value:"avg"===f?d[1]/t.length:d[1],opacity:e.maxOpacity?e.maxOpacity:t[0].opacityInfo.stops[1].opacity},p.opacityStops=m,r.resolve({renderer:new z(p),scheme:a,opacityInfos:t})}),r.promise):(M(r,"smartMapping.createBlendRenderer: missing parameters."),r.promise)},createSizeInfo:function(e){var a=new i;if(!(e&&e.layer&&e.field))return M(a,"smartMapping.createSizeInfo: missing parameters."),a.promise;var n=e.layer,t=e.normalizationField,r=t?"field":void 0,o=e.optimizeForScale;return e.statistics?$(e.statistics,null,t,e,a):n.addPlugin(ga).then(function(){var i=[n.statisticsPlugin.getFieldStatistics({field:e.field,normalizationType:r,normalizationField:t,minValue:e.minValue,maxValue:e.maxValue})];o&&i.push(n.statisticsPlugin.getSuggestedSizeRange({optimizeForScale:o===!0?"map-scale":o})),new l(i).then(function(n){var r=n[0],i=o&&n[1],l=o&&i[0]?i[1]:null;r[0]?$(r[1],l,t,e,a):M(a,"smartMapping.createSizeInfo: error when calculating field statistics.")})}).otherwise(function(){M(a,"smartMapping.createSizeInfo: error when adding feature layer statistics plugin.")}),a.promise},createSizeRenderer:function(e){var a=new i;if(!(e&&e.layer&&e.field))return M(a,"smartMapping.createSizeRenderer: missing parameters."),a.promise;var n=e.layer,t=e.normalizationField,r=t?"field":void 0,o=e.optimizeOutline;return n.addPlugin(ga).then(function(){var i=[sa.createSizeInfo(e)];o&&i.push(n.statisticsPlugin.getSuggestedOutline("object"==typeof o?o:null)),new l(i).then(function(n){var i=n[0],l=n[1],s=o&&l[0]?l[1]:null;i[0]?J(i[1],s,r,t,e,a):M(a,"smartMapping.createSizeRenderer: error when calculating sizeInfo.")})}).otherwise(function(){M(a,"smartMapping.createSizeRenderer: error when adding feature layer statistics plugin.")}),a.promise},createClassedColorRenderer:function(e){var a,n=new i,r=e.minValue,l=e.maxValue;if(!(e&&e.layer&&e.field))return M(n,"smartMapping.createClassedColorRenderer: missing parameters."),n.promise;if(a=null!=r&&null!=l,!a&&(null!=r||null!=l))return M(n,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),n.promise;e=t.mixin({analyzeData:!a},e);var o=e.layer;return o.addPlugin(ga).then(function(){Z(e).then(function(a){X(a.cbResponse,a.suggestedOutline,e,n)}).otherwise(function(){M(n,"smartMapping.createClassedColorRenderer: error when calculating class breaks.")})}).otherwise(function(){M(n,"smartMapping.createClassedColorRenderer: error when adding feature layer statistics plugin.")}),n.promise},createClassedSizeRenderer:function(e){var a,n=new i,r=e.minValue,l=e.maxValue;if(!(e&&e.layer&&e.field))return M(n,"smartMapping.createClassedSizeRenderer: missing parameters."),n.promise;if(a=null!=r&&null!=l,!a&&(null!=r||null!=l))return M(n,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),n.promise;e=t.mixin({analyzeData:!a},e);var o=e.layer;return o.addPlugin(ga).then(function(){Z(e).then(function(a){e.optimizeForScale?o.statisticsPlugin.getSuggestedSizeRange().then(function(t){var r=[t.minSize,t.maxSize];aa(a.cbResponse,r,a.suggestedOutline,e,n)}).otherwise(function(){aa(a.cbResponse,null,a.suggestedOutline,e,n)}):aa(a.cbResponse,null,a.suggestedOutline,e,n)}).otherwise(function(){M(n,"smartMapping.createClassedSizeRenderer: error when calculating class breaks.")})}).otherwise(function(){M(n,"smartMapping.createClassedSizeRenderer: error when adding feature layer statistics plugin.")}),n.promise},createHeatmapRenderer:function(e){var a=new i;if(!e||!e.layer)return M(a,"smartMapping.createHeatmapRenderer: missing parameters."),a.promise;var n=e.layer;return e.statistics?ta(e.statistics,e,a):n.addPlugin(ga).then(function(){n.statisticsPlugin.getHeatmapStatistics(e).then(function(n){ta(n,e,a)}).otherwise(function(){M(a,"smartMapping.createHeatmapRenderer: error when calculating heatmap statistics.")})}).otherwise(function(){M(a,"smartMapping.createHeatmapRenderer: error when adding feature layer statistics plugin.")}),a.promise},applyHeatmapScheme:function(e){if(!(e&&e.renderer&&e.scheme))return void console.log("smartMapping.applyHeatmapScheme: missing parameters.");var a=na({scheme:e.scheme}),r=e.renderer,i=r.colorStops,l=a.colors;if(i.length!==l.length+3)return void console.log("smartMapping.applyHeatmapScheme: incompatible number of colors in 'colors' and 'renderer.colorStops'.");var o,s=new c(l[0]),u=n.map(i,function(e){return t.mixin({},e)});for(u[0].color=new c([s.r,s.g,s.b,0]),u[1].color=new c([s.r,s.g,s.b,0]),u[2].color=s,o=3;o<u.length;o++)u[o].color=l[o-3];r.setColorStops(u)},sampleSize:500,createPredominanceRenderer:function(e){var a=new i;if(!(e&&e.layer&&e.fields))return M(a,"smartMapping.createPredominanceRenderer: missing parameters."),a.promise;var t=e.layer;return t.addPlugin(ga).then(function(){var r=e&&e.sampleSize||sa.sampleSize,i=n.map(e.fields,function(e){return e.name});t.statisticsPlugin.getSampleFeatures({sampleSize:r,outFields:i,returnGeometry:!1}).then(function(n){oa(n,i,e,a)}).otherwise(function(){M(a,"smartMapping.createPredominanceRenderer: unable to sample features.")})}).otherwise(function(){M(a,"smartMapping.createPredominanceRenderer: error when adding feature layer statistics plugin.")}),a.promise}}),r("extend-esri")&&t.setObject("renderer.smartMapping",sa,u),sa});