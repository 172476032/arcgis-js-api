// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["require","module","dojo/_base/array","dojo/_base/lang","dojo/has","dojo/Deferred","dojo/DeferredList","dojo/promise/all","dojo/when","dojo/on","../kernel","../Color","../numberUtils","../promiseList","../lang","../styles/type","../styles/size","../styles/choropleth","../styles/heatmap","../styles/predominance","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","./UniqueValueRenderer","./ClassBreaksRenderer","./HeatmapRenderer","./BlendRenderer","./utils","dojo/i18n!../nls/jsapi"],function(e,n,a,t,i,r,s,o,l,u,c,p,d,m,f,g,h,v,y,x,b,w,S,z,I,C,E,V,M){function O(a){return e.toAbsMid?e.toAbsMid(a):n.id.replace(/\/[^\/]*$/gi,"/")+a}function T(e,n){e.reject(new Error(n))}function F(e,n){e.loaded?n.call():u.once(e,"load",n)}function R(e,n,a,t){var i,r;switch(a){case"point":i=new b,i.setColor(n),i.setSize(null!=t?t:e.size),r=new w,r.setColor(e.outline.color),r.setWidth(e.outline.width),i.setOutline(r);break;case"line":i=new w,i.setColor(n),i.setWidth(null!=t?t:e.width);break;case"polygon":i=new S,i.setColor(n),r=new w,r.setColor(e.outline.color),r.setWidth(e.outline.width),i.setOutline(r)}return i}function k(e){var n=e.geometryType;return"esriGeometryPoint"===n||"esriGeometryMultipoint"===n?n="point":"esriGeometryPolyline"===n?n="line":"esriGeometryPolygon"===n&&(n="polygon"),n}function P(e,n){var a=e.scheme;return a?a=g.cloneScheme(a):(a=g.getSchemes({theme:e.theme||Ie,basemap:e.basemap,geometryType:n}),a=a&&a.primaryScheme),a}function q(e,n){var a;return a=e.label<n.label?-1:e.label>n.label?1:0}function D(e,n){var a;return a=e.value<n.value?-1:e.value>n.value?1:0}function B(e,n){var a=n.count-e.count;return 0===a&&(a=q(e,n)),a}function j(e,n){var a=n.count-e.count;return 0===a&&(a=D(e,n)),a}function _(e,n,a){var i;t.isFunction(n)?i=n:"count"===n?(i=j,a&&a.codedValues&&(i=B)):"value"===n&&(i=D,a&&a.codedValues&&(i=q)),i&&e.sort(i)}function L(e,n,i){var r,s,o,l,u,c,p=i.layer,d=i.field,m=t.isFunction(d),f=d&&!m?p.getField(d):null,g=f?p.getDomain(f.name):null,h=-1,v=null==i.numTypes?10:-1===i.numTypes?e.length:i.numTypes,y=null==i.showOthers?!0:i.showOthers,b=null==i.sortBy?"count":i.sortBy,w=i&&i.labelCallback,S=k(p),I=P(i,S),C=new z(null,d),E=i.predominanceScheme,M=i.useSizeInfo;if(E){var O="polygon"===S,T=O&&M,F=E.sizeInfo,q=M?O?F.marker:F:null,D=T&&F?F.background:null;D&&(C.backgroundFillSymbol=R(D,D.color,"polygon")),c=O?T?q.size:null:"line"===S?E.width:E.size,u=c,I=E,S=T?"point":S}var B={domain:g,fieldInfo:f};for(a.forEach(e,function(e,n){B.value=e.value,e.label=V.createUniqueValueLabel(B),w&&(e.label=w(e)),null===e.value&&(h=n)}),h>-1&&(l=e.splice(h,1)[0]),_(e,b,g),f&&f.type===ke&&(B.dateFormatInterval=V.calculateDateFormatInterval(a.map(a.filter(e,function(e,n){return v>n}),function(e){return e.value}))),o=we.createColors(I.colors,e.length),a.forEach(e,function(e,n){B.value=e.value,e.label=V.createUniqueValueLabel(B),w&&(e.label=w(e)),e.symbol=R(I,o[n],S,c)}),i.valueExpression&&(C.setValueExpression(i.valueExpression),C.valueExpressionTitle=i.valueExpressionTitle),C.legendOptions=i.legendOptions,o=we.createColors(I.colors,v),r=0;v>r;r++)s=e[r],s&&C.addValue({value:s.value,label:s.label,symbol:R(I,o[r],S,c)});return y&&(C.defaultSymbol=R(I,I.noDataColor,S,u),C.defaultLabel=ze.other),l&&(l.symbol=R(I,I.noDataColor,S,u),e.push(l)),n&&n.widthInfo&&C.setVisualVariables([n.widthInfo]),{renderer:C,uniqueValueInfos:e,othersStartIndex:C.infos.length===e.length?-1:C.infos.length,scheme:E?x.cloneScheme(E):P(i,S)}}function W(e,n,a,t){var i=L(e.uniqueValueInfos,n,a);i.source=e.source,i.partialData=e.partialData,t.resolve(i)}function A(e,n,a){var t=e.scheme;return t?t=v.cloneScheme(t):(t=v.getSchemes({theme:a||e.theme||Ce,basemap:e.basemap,geometryType:n}),t=t&&t.primaryScheme),t}function H(e,n){var a,t=e.avg,i=t-e.stddev,r=t+e.stddev;return i<e.min&&(i=e.min),r>e.max&&(r=e.max),n&&(t=i+(r-i)/2),a=d.round([i,r],{strictBounds:!0}),i=a[0],r=a[1],a=[i,i+(t-i)/2,t,t+(r-t)/2,r],d.round(a,{strictBounds:!0})}function U(e,n,a){var t,i=(n-e)/(a-1),r=[e];for(t=1;a-2>=t;t++)r.push(e+t*i);return r.push(n),d.round(r,{strictBounds:!0})}function G(e,n,a,t){var i,r,s=e.statisticsPlugin.getSuggestedDataRange({statistics:n,isDate:a});return s.defaultStatistics?(i=s.min,r=s.max):!t||null!=n.avg&&n.stddev||(i=n.min,r=n.max),null!=i?[i,r]:null}function Q(e,n,i,r,s){var o=null==r.useDefaultStatistics?!0:r.useDefaultStatistics;if(e&&!e.count&&!o)return void T(s,"smartMapping.createColorInfo: cannot create renderer when statistics.count is 0.");var l,u,c,m=r.layer,f=r.field,g=t.isFunction(f),h=f&&!g?m.getField(f):null,v=h&&h.type===ke,y=k(m),x=A(r,y),b=r.semiContinuous,w=n&&n.classBreakInfos,S=w&&w.length,z=n?S:5;if(!x)return void T(s,"smartMapping.createColorInfo: unable to find the specified scheme.");var I=x.id.indexOf("seq-")>-1,C=n&&I?ne(x,{length:z}):we.createColors(x.colors,z);if(C.length<z)return void T(s,"smartMapping.createColorInfo: not enough colors in the scheme.");if(n){l=[];var E;1===S?(u=[w[0].minValue,w[0].maxValue],l=[0,1],E=we.createColors(C,z)[0],c=[E,new p(E)]):b?(u=[],c=[],a.forEach(w,function(e,n){var a=e.maxValue-e.minValue,t=.1*a;0===n?u.push(e.minValue):u.push(e.minValue+t),n===S-1?u.push(e.maxValue):u.push(e.maxValue-t),E=new p(C[n]),c.push(E),c.push(new p(E)),l.push(2*n),l.push(2*n+1)})):(u=a.map(w,function(e,n){return l.push(n),(e.minValue+e.maxValue)/2}),c=we.createColors(C,z)),u=d.round(u,{strictBounds:!0})}else{var M=o?G(m,e,v,!0):null;u=M?U(M[0],M[1],5):H(e,I),l=[0,2,4],c=we.createColors(C,z)}var O={type:"colorInfo",field:f,valueExpression:r.valueExpression,valueExpressionTitle:r.valueExpressionTitle,normalizationField:i,stops:V.createColorStops({values:u,isDate:v,dateFormatOptions:v?V.timelineDateFormatOptions:null,colors:c,labelIndexes:l}),legendOptions:r.legendOptions};s.resolve({colorInfo:O,statistics:e,classBreaks:n,scheme:A(r,y)})}function N(e,n,a,t,i,r){var s=i.layer,o=i.field,l=k(s),u=null==i.showOthers?!0:i.showOthers,c=v.cloneScheme(e.scheme),p=new I(null,o);i.valueExpression&&p.setValueExpression(i.valueExpression),u&&(p.defaultSymbol=R(c,c.noDataColor,l),p.defaultLabel=ze.other),p.addBreak({minValue:-Se,maxValue:Se,symbol:R(c,c.noDataColor,l)}),p.normalizationType=a,p.normalizationField=t;var d=[V.cloneColorInfo(e.colorInfo)];n&&n.widthInfo&&d.push(n.widthInfo),p.setVisualVariables(d),r.resolve({renderer:p,colorInfo:V.cloneColorInfo(e.colorInfo),statistics:e.statistics,classBreaks:e.classBreaks,scheme:v.cloneScheme(e.scheme)})}function $(e,n,a,i){var r=null==a.useDefaultStatistics?!0:a.useDefaultStatistics;if(e&&!e.count&&!r)return void T(i,"smartMapping.createOpacityInfo: cannot create opacityInfo when statistics.count is 0.");var s=a.layer,o=a.field,l=o&&!t.isFunction(o)?s.getField(o):null,u=l&&l.type===ke,c=a.useStdDev,p=c?H(e):null,d=r?G(s,e,u,c):null,m=d||(c?[p[0],p[4]]:[e.min,e.max]),f={type:"opacityInfo",field:o,valueExpression:a.valueExpression,valueExpressionTitle:a.valueExpressionTitle,normalizationField:n,stops:[{value:m[0],opacity:.3},{value:m[1],opacity:.7}],legendOptions:a.legendOptions};i.resolve({opacityInfo:f,statistics:e,defaultStatistics:!!d})}function J(e,n){var a=e.scheme;return a?a=h.cloneScheme(a):(a=h.getSchemes({theme:e.theme||Ee,basemap:e.basemap,geometryType:n}),a=a&&a.primaryScheme),a}function K(e,n){var a;switch(n){case"point":a=[e.minSize,e.maxSize];break;case"line":a=[e.minWidth,e.maxWidth];break;case"polygon":a=[e.marker.minSize,e.marker.maxSize]}return a}function X(e,n,a,i,r){var s=null==i.useDefaultStatistics?!0:i.useDefaultStatistics,o=n&&[n.minSize,n.maxSize];if(e&&!e.count&&!s)return void T(r,"smartMapping.createSizeInfo: cannot create renderer when statistics.count is 0.");var l=i.layer,u=i.field,c=u&&!t.isFunction(u)?l.getField(u):null,p=c&&c.type===ke,d=k(l),m=J(i,d),f=o||K(m,d),g=i.useStdDev,h=g?H(e):null,v=s?G(l,e,p,g):null,y=v||(g?[h[0],h[4]]:[e.min,e.max]),x={type:"sizeInfo",field:u,valueExpression:i.valueExpression,valueExpressionTitle:i.valueExpressionTitle,valueUnit:"unknown",normalizationField:a,legendOptions:i.legendOptions,minSize:f[0],maxSize:f[1],minDataValue:y[0],maxDataValue:y[1]};r.resolve({sizeInfo:x,statistics:e,defaultStatistics:!!v,suggestedSizeRange:n,scheme:J(i,d)})}function Y(e,n,a,t,i,r){var s=i.layer,o=i.field,l=k(s),u=null==i.showOthers?!0:i.showOthers,c=h.cloneScheme(e.scheme),p="polygon"===l,d=p?c.marker:c,m=p?c.background:null,f="line"===l?d.noDataWidth:d.noDataSize,g=new I(null,o);i.valueExpression&&g.setValueExpression(i.valueExpression),u&&(g.defaultSymbol=R(d,d.noDataColor,p?"point":l,f),g.defaultLabel=ze.other),g.addBreak({minValue:-Se,maxValue:Se,symbol:R(d,d.color,p?"point":l)}),m&&(g.backgroundFillSymbol=R(m,m.color,l)),g.normalizationType=a,g.normalizationField=t;var v=[V.cloneSizeInfo(e.sizeInfo)];n&&n.widthInfo&&v.push(n.widthInfo),g.setVisualVariables(v),r.resolve({renderer:g,sizeInfo:V.cloneSizeInfo(e.sizeInfo),statistics:e.statistics,defaultStatistics:e.defaultStatistics,suggestedSizeRange:e.suggestedSizeRange,scheme:h.cloneScheme(e.scheme)})}function Z(e,n,a){var t,i=[],r=1/(a+1);for(t=1;a>=t;t++)i.push(p.blendColors(e,n,r*t));return i}function ee(e,n){var a=[];if(1===n)a=[e[0]];else if(2===n)a=[e[0],e[2]];else if(3===n)a=e;else{var t,i,r=n-e.length,s=r/2;r%2===0?(t=Z(e[0],e[1],s),i=Z(e[1],e[2],s)):(t=Z(e[0],e[1],Math.floor(s)),i=Z(e[1],e[2],Math.ceil(s))),a=[e[0]].concat(t).concat([e[1]]).concat(i).concat([e[2]])}return a}function ne(e,n,t){var i,r=n.length,s=-1;if(t&&a.some(n,function(e,n){return e.hasAvg&&(s=n),s>-1}),s>-1){var o=e.colors,l=s+1,u=r-s,c=o.slice(0,3),p=o.slice(2);c.reverse(),c=ee(c,l),p=ee(p,u),c.reverse(),i=[].concat(c).concat(p.slice(1))}else{var d=e.colorsForClassBreaks;if(d&&d.length>0&&(a.some(d,function(e){return e.numClasses===r&&(i=e.colors),!!i}),!i)){var m=d[d.length-1],f=r-m.numClasses;if(f>0){var g,h=m.colors[m.numClasses-1];for(i=m.colors.splice(0),g=1;f>=g;g++)i.push(h)}}}return i&&(i=we.createColors(i,i.length)),i}function ae(e,n,t,i){var r,s,o,l=t.layer,u=t.field,c=k(l),p=null==t.showOthers?!0:t.showOthers,d=t.classificationMethod||"equal-interval",m="standard-deviation"===d,f=t.normalizationType,g="high-to-low",h=e.classBreakInfos;return(r=A(t,c,g))?(s=ne(r,h),s&&s.length==h.length?(o=new I(null,u),t.valueExpression&&(o.setValueExpression(t.valueExpression),o.valueExpressionTitle=t.valueExpressionTitle),o.legendOptions=t.legendOptions,o.classificationMethod=d,o.normalizationType=f,o.normalizationField="field"===f?t.normalizationField:void 0,o.normalizationTotal="percent-of-total"===f?e.normalizationTotal:void 0,p&&(o.defaultSymbol=R(r,r.noDataColor,c),o.defaultLabel=ze.other),a.forEach(h,function(e,n){o.addBreak({minValue:e.minValue,maxValue:e.maxValue,symbol:R(r,s[n],c),label:e.label})}),m||V.setLabelsForClassBreaks({classBreaks:o.infos,classificationMethod:d,normalizationType:f,round:!0}),n&&n.widthInfo&&o.setVisualVariables([n.widthInfo]),e.renderer=o,e.scheme=A(t,c,g),void i.resolve(e)):void T(i,"smartMapping.createClassedColorRenderer: unable to find suitable colors for number of classes.")):void T(i,"smartMapping.createClassedColorRenderer: unable to find suitable style scheme.")}function te(e,n){return n.layer.statisticsPlugin.getClassBreaks(t.mixin(n,{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:e[0],maxValue:e[1],normalizationTotal:e[0]+e[1]}))}function ie(e){var n=new r,a=e.layer,t=null==e.useDefaultBreaks?!0:e.useDefaultBreaks,i=e.optimizeOutline,o=[a.statisticsPlugin.getClassBreaks(e)];return i&&o.push(a.statisticsPlugin.getSuggestedOutline("object"==typeof i?i:null)),new s(o).then(function(r){var s=r[0],o=r[1],u=i&&o[0]?o[1]:null;if(s[0]||t&&!a.graphics.length){var c=s[1],p=t?G(a,c?{min:c.minValue,max:c.maxValue}:{}):null;p&&(c=te(p,e)),l(c).then(function(e){e.defaultStatistics=!!p,n.resolve({cbResponse:e,suggestedOutline:u})}).otherwise(function(){T(n,"smartMapping: error when calculating default class breaks.")})}else T(n,"smartMapping: error when calculating class breaks.")}),n.promise}function re(e,n,a,t){var i,r=t||K(e,n),s=r[0],o=r[1],l=(o-s)/(a>=4?a-1:a),u=[];for(i=0;a>i;i++)u.push(s+l*i);return u}function se(e,n,t,i,r){var s,o=i.layer,l=i.field,u=k(o),c=null==i.showOthers?!0:i.showOthers,p=i.classificationMethod||"equal-interval",d=i.normalizationType,m=e.classBreakInfos,f=J(i,u),g=re(f,u,m.length,n),h="polygon"===u,v=h?f.marker:f,y=h?f.background:null;s=new I(null,l),i.valueExpression&&(s.setValueExpression(i.valueExpression),s.valueExpressionTitle=i.valueExpressionTitle),s.legendOptions=i.legendOptions,s.classificationMethod=p,s.normalizationType=d,s.normalizationField="field"===d?i.normalizationField:void 0,s.normalizationTotal="percent-of-total"===d?e.normalizationTotal:void 0,c&&(s.defaultSymbol=R(v,v.noDataColor,h?"point":u),s.defaultLabel=ze.other),y&&(s.backgroundFillSymbol=R(y,y.color,u)),a.forEach(m,function(e,n){s.addBreak({minValue:e.minValue,maxValue:e.maxValue,symbol:R(v,v.color,h?"point":u,g[n]),label:e.label})}),"standard-deviation"!==p&&V.setLabelsForClassBreaks({classBreaks:s.infos,classificationMethod:p,normalizationType:d,round:!0}),t&&t.widthInfo&&s.setVisualVariables([t.widthInfo]),e.renderer=s,e.scheme=J(i,u),r.resolve(e)}function oe(e){var n=e.scheme;return n?n=y.cloneScheme(n):(n=y.getSchemes({theme:e.theme||Ve,basemap:e.basemap}),n=n&&n.primaryScheme),n}function le(e,n,t){var i=null==n.useDefaultStatistics?!0:n.useDefaultStatistics;if(!e.count&&!i)return void T(t,"smartMapping.createHeatmapRenderer: cannot create renderer when statistics.count is 0.");var r=e.fieldOffset,s=null==n.blurRadius?10:n.blurRadius,o=null==n.minRatio?.01:n.minRatio,l=null==n.maxRatio?1:n.maxRatio,u=null==n.fadeToTransparent?!0:n.fadeToTransparent,c=oe(n),d=c.colors,m=d.length,f=!e.count&&i,g=f?[0,100]:[e.min,e.max],h=new C;h.setBlurRadius(s),h.setField(n.field),null!=r&&h.setFieldOffset(r),h.setMinPixelIntensity(g[0]),h.setMaxPixelIntensity(g[1]);var v=d[0],y=[{ratio:0,color:new p([v.r,v.g,v.b,0])},{ratio:Me,color:new p([v.r,v.g,v.b,0])},{ratio:u?o:Me,color:v}],x=(l-o)/(m-1);d=we.createColors(d,m),a.forEach(d,function(e,n){y.push({ratio:o+x*n,color:e})}),h.setColorStops(y),t.resolve({renderer:h,statistics:e,defaultStatistics:f,scheme:oe(n)})}function ue(e,n){var a=e.scheme;return a?a=x.cloneScheme(a):(a=x.getSchemes({theme:e.theme||Ie,basemap:e.basemap,geometryType:n}),a=a&&a.primaryScheme),a}function ce(e,n){var t={};return a.forEach(e,function(e){var a=n.getField(e.name);t[e.name]=e.label||a&&a.alias||e.name}),function(e){return t[e.value]}}function pe(e){return function(n,t){var i=a.indexOf(e,n.value),r=a.indexOf(e,t.value);return i-r}}function de(e,n,t,i,s){var o=new r,l=e.layer;return l.statisticsPlugin.getPredominantCategories({fields:n}).always(function(r){r&&r.predominantCategoryInfos||(r={predominantCategoryInfos:a.map(n,function(e){return{value:e,count:0}})});var u=L(r.predominantCategoryInfos,s,{layer:l,valueExpression:i.valueExpression,labelCallback:ce(e.fields,l),numTypes:-1,showOthers:e.showOthers,sortBy:pe(n),predominanceScheme:t,useSizeInfo:e.includeSizeInfo});u.predominantCategoryInfos=u.uniqueValueInfos,delete u.uniqueValueInfos,u.source=r.source,o.resolve(u)}),o.promise}function me(e,n,a,t){var i=new r;return we.createSizeInfo({layer:e.layer,valueExpression:t.valueExpression,sqlExpression:t.statisticsQuery.sqlExpression,sqlWhere:t.statisticsQuery.sqlWhere,scheme:a,optimizeForScale:e.optimizeForScale}).then(function(e){e.sizeInfo.legendOptions={title:ze.sumOfCategories},i.resolve(e)}).otherwise(function(e){T(i,"smartMapping.createPredominanceRenderer: error when calculating statistics for visual variable(size).")}),i.promise}function fe(e,n,a){var t=new r;return e.layer.statisticsPlugin.getFieldStatistics({valueExpression:a.valueExpression,sqlExpression:a.statisticsQuery.sqlExpression,sqlWhere:a.statisticsQuery.sqlWhere}).then(function(e){var i=null==e.avg||null==e.stddev,r=1/n.length*100,s=i?100:e.avg+1.285*e.stddev;s>100&&(s=100);var o=d.round([r,s],{strictBounds:!0});t.resolve({opacityInfo:{type:"opacityInfo",valueExpression:a.valueExpression,stops:[{value:o[0],opacity:.15},{value:o[1],opacity:1}],legendOptions:{title:ze.strengthOfPredominance}},statistics:e,defaultStatistics:i})}).otherwise(function(e){T(t,"smartMapping.createPredominanceRenderer: error when calculating statistics for visual variable(opacity).")}),t.promise}function ge(e,n,a,t){var i=k(e.layer),r=ue(e,i);e.layer.statisticsPlugin.getPredominanceExpressions({fields:n}).then(function(i){var s,o,l=de(e,n,r,i.predominantCategory,a);e.includeSizeInfo&&(s=me(e,n,r.sizeInfo,i.size)),e.includeOpacityInfo&&(o=fe(e,n,i.opacity)),m([l,s,o]).then(function(e){var n,a=e[0],i=e[1],r=e[2],l=[];if(a instanceof Error)T(t,"smartMapping.createPredominanceRenderer: unable to create unique-value renderer.");else{if(n=a,s){if(i instanceof Error)return void T(t,"smartMapping.createPredominanceRenderer: unable to create visual variable for symbol size.");l.push(V.cloneSizeInfo(i.sizeInfo)),delete i.scheme,n.size=i}if(o){if(r instanceof Error)return void T(t,"smartMapping.createPredominanceRenderer: unable to create visual variable for symbol opacity.");l.push(V.cloneOpacityInfo(r.opacityInfo)),n.opacity=r}if(l.length){var u=n.renderer.visualVariables;u&&(Array.prototype.push.apply(u,l),l=u),n.renderer.setVisualVariables(l)}t.resolve(n)}})}).otherwise(function(e){T(t,"smartMapping.createPredominanceRenderer: unable to generate expressions.")})}function he(e,n,t){var i=e;if("string"==typeof e){var r=t.getField(e);r&&r.type===ke&&(i=t.getFieldLabel(r.name))}else if("number"==typeof e||e instanceof Date){var s=a.indexOf(qe,n)>-1?null:"date";i=V.formatDate(e,{selector:s})}return i}function ve(e,n,a){var i=n.startTime,r=n.endTime,s=n.layer;s.statisticsPlugin.getAgeExpressions({startTime:i,endTime:r,units:e.units}).then(function(n){var o=e,l=o.units,u="ageInfo_"+l;o.legendOptions={title:f.substitute({units:l,startTime:he(i,l,s),endTime:he(r,l,s)},ze[u])},t.mixin(o,n),a.resolve(o)}).otherwise(function(e){T(a,"smartMapping.createAgeInfo: unable to generate expressions to calculate age.")})}function ye(e,n){var t,i,r,s,o,l,u,c,p={};return t=a.filter(e,function(e){return i=e.name,r=i.toLowerCase(),l=i!==n&&-1===a.indexOf(Te,r),l&&(u=u||(a.indexOf(Pe,e.type)>-1?i:null),c=c||("esriFieldTypeString"===e.type?i:null)),l}),a.forEach(t,function(e){i=e.name,r=i.toLowerCase(),s=a.indexOf(Pe,e.type)>-1,s&&(p=xe(i,r,Fe,p,"number")),p.rank&&"string"!==p.fieldType||(o="esriFieldTypeString"===e.type,o&&(p=xe(i,r,Re,p,"string")))}),p.fieldName||u||c}function xe(e,n,a,t,i){var r=be(n,a);return r.exactRank>-1&&(!t.rank||t.fieldType!==i||"exact"===t.matchType&&t.fieldType===i&&t.rank>r.exactRank)?t={rank:r.exactRank,matchType:"exact",fieldType:i,fieldName:e}:r.containRank>-1&&(!t.rank||t.fieldType===i&&"contains"===t.matchType&&t.rank>r.containRank)&&(t={rank:r.containRank,matchType:"contains",fieldType:i,fieldName:e}),t}function be(e,n){var t,i=-1,r=-1;for(i=a.indexOf(n,e),t=0;t<n.length;t++)if(e.indexOf(n[t])>-1){r=t;break}return{exactRank:i,containRank:r}}var we={},Se=Math.pow(2,53)-1,ze=M.smartMapping,Ie="default",Ce="high-to-low",Ee="default",Ve="default",Me=.01,Oe=/(https?:)?\/\/services.*\.arcgis\.com/i,Te=["id","fips","fid","objectid","_objectid","__objectid","x","y","lat","long","latitude","longitude","shape","shape_length","shape_leng","shape_area","perimeter","stretched_value","fnode_","tnode_","lpoly_","rpoly_","poly_","subclass","rings_ok","rings_nok","st_length(shape)","st_area(shape)"],Fe=["count","percent","sum","elevation","value","valore","valoare","total","gesamt","score","income","age","expected","average","median","size","cost","expenditure","revenue","profit","growth","sale","quantity","population","price","unit","length","width","difference","distance"],Re=["type","name","status","class","category","code","value","label","zone","symbol","color","owner","district","group","species","rating","score","party"],ke="esriFieldTypeDate",Pe=["esriFieldTypeInteger","esriFieldTypeDouble","esriFieldTypeSingle","esriFieldTypeSmallInteger"],qe=["hours","minutes","seconds"],De=O("../plugins/FeatureLayerStatistics");return t.mixin(we,{createColors:function(e,n){var a,t=[],i=e.length;for(a=0;n>a;a++)t.push(new p(e[a%i]));return t},createTypeRenderer:function(e){var n=new r;if(!e||!e.layer||!e.field&&!e.valueExpression||!e.scheme&&!e.basemap)return T(n,"smartMapping.createTypeRenderer: missing parameters."),n.promise;var a=e.layer,t=e.optimizeOutline;return a.addPlugin(De).then(function(){var i=[a.statisticsPlugin.getUniqueValues({field:e.field,valueExpression:e.valueExpression,includeAllCodedValues:e.includeAllCodedValues})];t&&i.push(a.statisticsPlugin.getSuggestedOutline("object"==typeof t?t:null)),new s(i).then(function(a){var i=a[0],r=a[1],s=t&&r[0]?r[1]:null;i[0]?W(i[1],s,e,n):T(n,"smartMapping.createTypeRenderer: error when calculating unique values.")})}).otherwise(function(e){T(n,"smartMapping.createTypeRenderer: error when adding feature layer statistics plugin.")}),n.promise},createColorInfo:function(e){var n=new r;if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))return T(n,"smartMapping.createColorInfo: missing parameters."),n.promise;var a=e.layer,t=e.normalizationField,i=t?"field":void 0;return e.statistics?Q(e.statistics,null,t,e,n):a.addPlugin(De).then(function(){var r="group-similar"===e.theme||e.scheme&&0===e.scheme.id.indexOf("group-similar/"),s=r?a.statisticsPlugin.getClassBreaks({field:e.field,valueExpression:e.valueExpression,classificationMethod:"natural-breaks",numClasses:e.numGroups||5,normalizationType:i,normalizationField:t,minValue:e.minValue,maxValue:e.maxValue}):a.statisticsPlugin.getFieldStatistics({field:e.field,valueExpression:e.valueExpression,sqlExpression:e.sqlExpression,sqlWhere:e.sqlWhere,normalizationType:i,normalizationField:t,minValue:e.minValue,maxValue:e.maxValue});s.then(function(a){var i,s;r?i=a:s=a,Q(s,i,t,e,n)}).otherwise(function(e){T(n,r?"smartMapping.createColorInfo: error when calculating class breaks.":"smartMapping.createColorInfo: error when calculating field statistics.")})}).otherwise(function(e){T(n,"smartMapping.createColorInfo: error when adding feature layer statistics plugin.")}),n.promise},createColorRenderer:function(e){var n=new r;if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))return T(n,"smartMapping.createColorRenderer: missing parameters."),n.promise;var a=e.layer,t=e.normalizationField,i=t?"field":void 0,o=e.optimizeOutline;return a.addPlugin(De).then(function(){var r=[we.createColorInfo(e)];o&&r.push(a.statisticsPlugin.getSuggestedOutline("object"==typeof o?o:null)),new s(r).then(function(a){var r=a[0],s=a[1],l=o&&s[0]?s[1]:null;r[0]?N(r[1],l,i,t,e,n):T(n,"smartMapping.createColorRenderer: error when calculating colorInfo.")})}).otherwise(function(e){T(n,"smartMapping.createColorRenderer: error when adding feature layer statistics plugin.")}),n.promise},createOpacityInfo:function(e){var n=new r;if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))return T(n,"smartMapping.createOpacityInfo: missing parameters."),n.promise;var a=e.layer,t=e.normalizationField,i=t?"field":void 0;return e.statistics?$(e.statistics,t,e,n):a.addPlugin(De).then(function(){a.statisticsPlugin.getFieldStatistics({field:e.field,valueExpression:e.valueExpression,sqlExpression:e.sqlExpression,sqlWhere:e.sqlWhere,normalizationType:i,normalizationField:t,minValue:e.minValue,maxValue:e.maxValue,features:e.features}).then(function(a){$(a,t,e,n)}).otherwise(function(e){T(n,"smartMapping.createOpacityInfo: error when calculating field statistics.")})}).otherwise(function(e){T(n,"smartMapping.createOpacityInfo: error when adding feature layer statistics plugin.")}),n.promise},createBlendRenderer:function(e){var n,t,i=new r,s=this,l=[],u={},c=[],d=[],m=e.opacityValueCombinationMethod||"avg",f={};return e&&e.layer&&e.blendedFields?(e.basemap=e.basemap||"topo",t=k(e.layer),n=P({basemap:e.basemap},t),n.colors=[new p("#e60000"),new p("#0000e6"),new p("#00e600"),new p("#e67300"),new p("#a900e6")],f.fields=[],f.normalizationField=e.normalizationField,f.blendMode=e.blendMode||"source-over",f.symbol=R(n,n.noDataColor,e.markers?"point":t),u.layer=e.layer,u.normalizationField=e.normalizationField,u.useStdDev=e.useStdDev||!1,l=a.map(e.blendedFields,function(e,a){return f.fields.push({field:e,color:n.colors[a]}),u.field=e,s.createOpacityInfo(u)}),o(l).then(function(t){d[0]=t[0].opacityInfo.stops[0].value,d[1]=t[1].opacityInfo.stops[1].value,a.forEach(t.slice(0,1),function(e){var n=e.opacityInfo.stops[0].value,a=e.opacityInfo.stops[1].value;"union"===m?(d[0]=n<d[0]?n:d[0],d[1]=a>d[1]?a:d[1]):"avg"===m&&(d[0]+=e.opacityInfo.stops[0].value,d[1]+=e.opacityInfo.stops[1].value)}),c[0]={value:"avg"===m?d[0]/t.length:d[0],opacity:e.minOpacity?e.minOpacity:t[0].opacityInfo.stops[0].opacity},c[1]={value:"avg"===m?d[1]/t.length:d[1],opacity:e.maxOpacity?e.maxOpacity:t[0].opacityInfo.stops[1].opacity},f.opacityStops=c,i.resolve({renderer:new E(f),scheme:n,opacityInfos:t})}),i.promise):(T(i,"smartMapping.createBlendRenderer: missing parameters."),i.promise)},createSizeInfo:function(e){var n=new r;if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))return T(n,"smartMapping.createSizeInfo: missing parameters."),n.promise;var a=e.layer,t=e.normalizationField,i=t?"field":void 0,o=e.optimizeForScale;return e.statistics?X(e.statistics,null,t,e,n):a.addPlugin(De).then(function(){var r=[a.statisticsPlugin.getFieldStatistics({field:e.field,valueExpression:e.valueExpression,sqlExpression:e.sqlExpression,sqlWhere:e.sqlWhere,normalizationType:i,normalizationField:t,minValue:e.minValue,maxValue:e.maxValue})];o&&r.push(a.statisticsPlugin.getSuggestedSizeRange({optimizeForScale:o===!0?"map-scale":o})),new s(r).then(function(a){var i=a[0],r=o&&a[1],s=o&&r[0]?r[1]:null;i[0]?X(i[1],s,t,e,n):T(n,"smartMapping.createSizeInfo: error when calculating field statistics.")})}).otherwise(function(e){T(n,"smartMapping.createSizeInfo: error when adding feature layer statistics plugin.")}),n.promise},createSizeRenderer:function(e){var n=new r;if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))return T(n,"smartMapping.createSizeRenderer: missing parameters."),n.promise;var a=e.layer,t=e.normalizationField,i=t?"field":void 0,o=e.optimizeOutline;return a.addPlugin(De).then(function(){var r=[we.createSizeInfo(e)];o&&r.push(a.statisticsPlugin.getSuggestedOutline("object"==typeof o?o:null)),new s(r).then(function(a){var r=a[0],s=a[1],l=o&&s[0]?s[1]:null;r[0]?Y(r[1],l,i,t,e,n):T(n,"smartMapping.createSizeRenderer: error when calculating sizeInfo.")})}).otherwise(function(e){T(n,"smartMapping.createSizeRenderer: error when adding feature layer statistics plugin.")}),n.promise},createClassedColorRenderer:function(e){var n,a=new r,i=e.minValue,s=e.maxValue;if(!e||!e.layer||!e.field&&!e.valueExpression)return T(a,"smartMapping.createClassedColorRenderer: missing parameters."),a.promise;if(n=null!=i&&null!=s,!n&&(null!=i||null!=s))return T(a,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),a.promise;e=t.mixin({analyzeData:!n},e);var o=e.layer;return o.addPlugin(De).then(function(){ie(e).then(function(n){ae(n.cbResponse,n.suggestedOutline,e,a)}).otherwise(function(e){T(a,"smartMapping.createClassedColorRenderer: error when calculating class breaks.")})}).otherwise(function(e){T(a,"smartMapping.createClassedColorRenderer: error when adding feature layer statistics plugin.")}),a.promise},createClassedSizeRenderer:function(e){var n,a=new r,i=e.minValue,s=e.maxValue;if(!e||!e.layer||!e.field&&!e.valueExpression)return T(a,"smartMapping.createClassedSizeRenderer: missing parameters."),a.promise;if(n=null!=i&&null!=s,!n&&(null!=i||null!=s))return T(a,"smartMapping.createClassedColorRenderer: both minValue and maxValue are required when specifying custom data range."),a.promise;e=t.mixin({analyzeData:!n},e);var o=e.layer;return o.addPlugin(De).then(function(){ie(e).then(function(n){e.optimizeForScale?o.statisticsPlugin.getSuggestedSizeRange().then(function(t){var i=[t.minSize,t.maxSize];se(n.cbResponse,i,n.suggestedOutline,e,a)}).otherwise(function(t){se(n.cbResponse,null,n.suggestedOutline,e,a)}):se(n.cbResponse,null,n.suggestedOutline,e,a)}).otherwise(function(e){T(a,"smartMapping.createClassedSizeRenderer: error when calculating class breaks.")})}).otherwise(function(e){T(a,"smartMapping.createClassedSizeRenderer: error when adding feature layer statistics plugin.")}),a.promise},createHeatmapRenderer:function(e){var n=new r;if(!e||!e.layer)return T(n,"smartMapping.createHeatmapRenderer: missing parameters."),n.promise;var a=e.layer;return e.statistics?le(e.statistics,e,n):a.addPlugin(De).then(function(){a.statisticsPlugin.getHeatmapStatistics(e).then(function(a){le(a,e,n)}).otherwise(function(e){T(n,"smartMapping.createHeatmapRenderer: error when calculating heatmap statistics.")})}).otherwise(function(e){T(n,"smartMapping.createHeatmapRenderer: error when adding feature layer statistics plugin.")}),n.promise},applyHeatmapScheme:function(e){if(!(e&&e.renderer&&e.scheme))return void console.log("smartMapping.applyHeatmapScheme: missing parameters.");var n=oe({scheme:e.scheme}),i=e.renderer,r=i.colorStops,s=n.colors;if(r.length!==s.length+3)return void console.log("smartMapping.applyHeatmapScheme: incompatible number of colors in 'colors' and 'renderer.colorStops'.");var o,l=new p(s[0]),u=a.map(r,function(e){return t.mixin({},e)});for(u[0].color=new p([l.r,l.g,l.b,0]),u[1].color=new p([l.r,l.g,l.b,0]),u[2].color=l,o=3;o<u.length;o++)u[o].color=s[o-3];i.setColorStops(u)},sampleSize:500,createPredominanceRenderer:function(e){var n=new r;if(!(e&&e.layer&&e.fields&&e.fields.length>1))return T(n,"smartMapping.createPredominanceRenderer: missing parameters."),n.promise;if(e.fields.length>5)return T(n,"smartMapping.createPredominanceRenderer: too many fields. Maximum supported is 5."),n.promise;var t=e.layer;return t.addPlugin(De).then(function(){var i=(e.sampleSize||we.sampleSize,a.map(e.fields,function(e){return e.name}));F(t,function(){var r=t.getOutFields()||[],s=-1!==a.indexOf(r,"*"),o=e.optimizeOutline,u=s?null:a.filter(i,function(e){return-1===a.indexOf(r,e)});if(t.url&&!Oe.test(t.url))T(n,"smartMapping.createPredominanceRenderer: predominance renderer is not supported for this layer. Make sure the layer supports advanced SQL expressions and standardized queries.");else if(u&&u.length)T(n,"smartMapping.createPredominanceRenderer: make sure the layer is configured to fetch all fields specified in parameters.");else{var c=o?t.statisticsPlugin.getSuggestedOutline("object"==typeof o?o:null):null;l(c).always(function(a){a&&!a.widthInfo&&(a=null),ge(e,i,a,n)})}})}).otherwise(function(e){T(n,"smartMapping.createPredominanceRenderer: error when adding feature layer statistics plugin.")}),n.promise},createAgeInfo:function(e){var n=new r;if(!(e&&e.layer&&e.startTime&&e.endTime))return T(n,"smartMapping.createAgeInfo: missing parameters."),n.promise;var a=e.layer;return a.addPlugin(De).then(function(){var t=e.units?{units:e.units}:a.statisticsPlugin.getSuggestedAgeUnits({startTime:e.startTime,endTime:e.endTime});l(t).then(function(a){ve(a,e,n)}).otherwise(function(e){T(n,"smartMapping.createAgeInfo: unable to calculate age units.")})}).otherwise(function(e){T(n,"smartMapping.createAgeInfo: error when adding feature layer statistics plugin.")}),n.promise},excludedFields:Te,getSuggestedField:function(e){var n=new r;return e&&(e.layer||e.fields&&e.objectIdField)?(e.layer?F(e.layer,function(){n.resolve(ye(e.layer.fields,e.layer.objectIdField))}):n.resolve(ye(e.fields,e.objectIdField)),n.promise):(T(n,"smartMapping.getSuggestedField: missing parameters."),n.promise)}}),i("extend-esri")&&t.setObject("renderer.smartMapping",we,c),we});