// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","dojox/gfx/_base","../kernel","../Color","./arcadeUtils"],function(t,e,o,i,n,r,a,s){var c=Math.PI,l=1,f=t(null,{declaredClass:"esri.renderer.Renderer",constructor:function(t){if(this._cache={},t&&!t.declaredClass){if(this.rotationInfo=t.rotationInfo,!this.rotationInfo){var o=t.rotationType,i=t.rotationExpression;(o||i)&&(this.rotationInfo={type:o,expression:i})}this.setRotationInfo(this.rotationInfo),this.setSizeInfo(this._readSizeInfo(t.sizeInfo)),this.setColorInfo(this._readColorInfo(t.colorInfo)),this.setOpacityInfo(this._readOpacityInfo(t.transparencyInfo)),this.setVisualVariables(this._readVariables(t.visualVariables)),this.setAuthoringInfo(t.authoringInfo)}this.getSymbol=e.hitch(this,this.getSymbol)},getSymbol:function(t){},_readSizeInfo:function(t){if(t){var e=t.minSize,i=t.maxSize;e&&(t.minSize="number"==typeof e?n.pt2px(e):this._readSizeInfo(e)),i&&(t.maxSize="number"==typeof i?n.pt2px(i):this._readSizeInfo(i)),t.stops&&o.forEach(t.stops,function(t){t.size&&"number"==typeof t.size&&(t.size=n.pt2px(t.size))})}return t},_readColorInfo:function(t){return t&&(o.forEach(t.colors,function(o,i){e.isArray(o)&&(t.colors[i]=a.toDojoColor(o))}),o.forEach(t.stops,function(o,i){o.color&&e.isArray(o.color)&&(t.stops[i].color=a.toDojoColor(o.color))})),t},_readOpacityInfo:function(t){var i;return t&&(i=e.mixin({},t),i.transparencyValues&&(i.opacityValues=o.map(i.transparencyValues,function(t){return 1-t/100}),delete i.transparencyValues),i.stops&&(i.stops=o.map(i.stops,function(t){return t=e.mixin({},t),t.opacity=1-t.transparency/100,delete t.transparency,t}))),i},_readVariables:function(t){return t&&(t=o.map(t,function(t){return"sizeInfo"===t.type?t=this._readSizeInfo(t):"colorInfo"===t.type?t=this._readColorInfo(t):"transparencyInfo"===t.type&&(t=this._readOpacityInfo(t),t.type="opacityInfo"),t},this)),t},setAuthoringInfo:function(t){this.authoringInfo=t},setRotationInfo:function(t){var o=this.rotationInfo="string"==typeof t?{field:t}:t;if(o){if(o.expression&&!e.isFunction(o.expression)&&!o.field){var i=o.expression.match(this.rotationRE);i&&i[1]&&(o.field=i[1])}o.rotationType=o.type}return this._cache.rotationInfo=this._processRotationInfo(o),this},rotationRE:/^\[([^\]]+)\]$/i,_processRotationInfo:function(t){return this._createCache(t)},getRotationAngle:function(t,e){var o=this._getVarInfo(e&&e.rotationInfo,"rotationInfo"),i=o.variable,n=this._cache[o.cacheKey],r="arithmetic"===this._getRotationType(i),a=i.field,s=n&&n.hasExpr,c=null;return(a||s)&&(c=this._getDataValue(t,i,null,n),null!=c&&(c=(c+(r?-90:0))*(r?-1:1))),c},_getRotationType:function(t){return t&&("rotationInfo"===t.type?t.rotationType:t.type)},_getDataValue:function(t,e,o,i,n){if(!i){var r=this._getVarInfo(e,o);e=r.variable,i=this._cache[r.cacheKey],"sizeInfo"===o&&(i=i.root)}return t._getDataValue(e,i,s,n)},setVisualVariables:function(t){var e=this._cache;o.forEach(this.visualVariables,function(t,o){e.hasOwnProperty(o)&&(e[o]=null)},this),this.visualVariables=t;var i=o.some(t,function(t){return!!t.target});return i&&t.sort(function(t,e){var o;return o=t.target===e.target?0:t.target?1:-1}),o.forEach(t,function(t,o){"colorInfo"===t.type?e[o]=this._processColorInfo(t):"opacityInfo"===t.type?e[o]=this._processOpacityInfo(t):"sizeInfo"===t.type?e[o]=this._processSizeInfo(t):"rotationInfo"===t.type&&(e[o]=this._processRotationInfo(t))},this),this},getVisualVariableValues:function(t){var e,i=this.visualVariables;return i&&(e=o.map(i,function(e){var o;switch(e.type){case"sizeInfo":o=this.getSize(t,{sizeInfo:e});break;case"colorInfo":o=this.getColor(t,{colorInfo:e});break;case"opacityInfo":o=this.getOpacity(t,{opacityInfo:e});break;case"rotationInfo":o=this.getRotationAngle(t,{rotationInfo:e})}return{variable:e,value:o}},this)),e},getFieldsUsedInExpressions:function(){var t=[];return o.forEach(this._getCacheObjects(),function(e){e.syntaxTree&&(t=t.concat(s.extractFieldNames(e.syntaxTree)))}),t.sort(),o.filter(t,function(e,o){return 0===o||t[o-1]!==e})},hasVisualVariables:function(t,e){return t?!!this.getVisualVariablesForType(t,e):!!(this.getVisualVariablesForType("sizeInfo",e)||this.getVisualVariablesForType("colorInfo",e)||this.getVisualVariablesForType("opacityInfo",e)||this.getVisualVariablesForType("rotationInfo",e))},getVisualVariablesForType:function(t,e){var i,n=this.visualVariables;return!e&&this[t]?("rotationInfo"===t&&(this[t].rotationType=this[t].type),i=[this[t]]):n&&(i=o.filter(n,function(o){return o.type===t&&("string"==typeof e?o.target===e:e===!1?!o.target:!0)}),i&&0===i.length&&(i=void 0)),i},setSizeInfo:function(t){return this.sizeInfo=this.proportionalSymbolInfo=t,this._cache.sizeInfo=this._processSizeInfo(t),this},_processSizeInfo:function(t){return t&&{root:this._createCache(t),minSize:this._createCache(t.minSize),maxSize:this._createCache(t.maxSize)}},_convertExpressionToArcade:function(t){t&&t.expression&&(t.valueExpression="$view.scale")},_getVarInfo:function(t,e){var i;return t&&t.type===e?(i=o.indexOf(this.visualVariables,t),t=this.visualVariables[i]):(i=e,t=this[e]),{variable:t,cacheKey:i}},setProportionalSymbolInfo:function(t){return this.setSizeInfo(t),this},getSize:function(t,e){var o=this._getVarInfo(e&&e.sizeInfo,"sizeInfo"),i=o.variable,n=this._cache[o.cacheKey],r=null;if(i){var a=i.minSize,s=i.maxSize,c="object"==typeof a&&a?this._getSize(t,a,n&&n.minSize,e):a,l="object"==typeof s&&s?this._getSize(t,s,n&&n.maxSize,e):s;r=this._getSize(t,i,n&&n.root,e,[c,l])}return r},_getSize:function(t,e,o,i,n){var r=e.field,a=e.stops,s=0,l=o&&o.hasExpr,f=o&&o.ipData,u=o&&o.isScaleDriven,p="object"==typeof t&&!!t,h="number"==typeof t?t:null;if(r||u||l){var y,I=i&&i.scale,_=n?n[0]:e.minSize,g=n?n[1]:e.maxSize,m=e.minDataValue,v=e.maxDataValue,z=e.valueUnit||"unknown",d=e.valueRepresentation,V=e.scaleBy,b=i&&i.shape;if(u?h=I:"number"!=typeof h&&p&&(h=this._getDataValue(t,e,null,o)),!this._isValidNumber(h))return null;if(a){var S,x,C=this._lookupData(h,f),O=C[0],w=C[1];O===w?s=a[O].size:(S=a[O].size,x=a[w].size,s=S+(x-S)*C[2])}else if(null!=_&&null!=g&&null!=m&&null!=v)if(m>=h)s=_;else if(h>=v)s=g;else if(y=(h-m)/(v-m),"area"===V&&b){var E="circle"===b,j=E?c*Math.pow(_/2,2):_*_,D=E?c*Math.pow(g/2,2):g*g,T=j+y*(D-j);s=E?2*Math.sqrt(T/c):Math.sqrt(T)}else s=_+y*(g-_);else if("unknown"===z)null!=_&&null!=m&&(_&&m?(y=h/m,s="circle"===b?2*Math.sqrt(y*Math.pow(_/2,2)):"square"===b||"diamond"===b||"image"===b?Math.sqrt(y*Math.pow(_,2)):y*_):s=h+(_||m),s=_>s?_:s,null!=g&&s>g&&(s=g));else{var R=(i&&i.resolution?i.resolution:1)*this._meterIn[z];"area"===d?(s=Math.sqrt(h/c)/R,s*=2):(s=h/R,("radius"===d||"distance"===d)&&(s*=2)),null!=_&&_>s&&(s=_),null!=g&&s>g&&(s=g)}}else s=a&&a[0]&&a[0].size,null==s&&(s=e.minSize);return s=isNaN(s)?0:s},getSizeRangeAtScale:function(t,e){var o,i=this._getVarInfo(t,"sizeInfo"),n=this._cache[i.cacheKey],r={scale:e};if(t=i.variable,t&&e){var a,s,c=t.minSize,l=t.maxSize,f=t.stops;if(f&&f.length?(a=f[0].size,s=f[f.length-1].size):(a="object"==typeof c&&c?this._getSize({},c,n&&n.minSize,r):c,s="object"==typeof l&&l?this._getSize({},l,n&&n.maxSize,r):l),null!=a||null!=s){if(a>s){var u=s;s=a,a=u}o={minSize:a,maxSize:s}}}return o},setColorInfo:function(t){return this.colorInfo=t,this._cache.colorInfo=this._processColorInfo(t),this},prepareForViewChange:function(){o.forEach(this._getCacheObjects(),function(t){(t.dependsOnView||t.isJSFunc)&&(t.version=l++)})},_viewScaleRE:/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,_createCache:function(t){var o=t&&t.valueExpression,i=s.createSyntaxTree(o),n=s.createFunction(i),r=!(!t||!t.expression)||this._viewScaleRE.test(o);return{ipData:this._interpolateData(t),hasExpr:!!o,compiledFunc:n,syntaxTree:i,isScaleDriven:r,dependsOnView:i?s.dependsOnView(i):!1,isJSFunc:e.isFunction(t&&t.field),version:l++}},_getCacheObjects:function(t){var e,o=t||this._cache,i=[];for(e in o){var n=o[e];o.hasOwnProperty(e)&&n&&"object"==typeof n&&(n.hasOwnProperty("version")?i.push(n):i=i.concat(this._getCacheObjects(n)))}return i},_processColorInfo:function(t){return t&&(o.forEach(t.colors,function(o,i){e.isArray(o)&&(t.colors[i]=new a(o))}),o.forEach(t.stops,function(o,i){o.color&&e.isArray(o.color)&&(t.stops[i].color=new a(o.color))})),this._createCache(t)},getColor:function(t,e){var o=this._getVarInfo(e&&e.colorInfo,"colorInfo");return this._getColorComponent(t,o.variable,this._cache[o.cacheKey])},setOpacityInfo:function(t){return this.opacityInfo=t,this._cache.opacityInfo=this._processOpacityInfo(t),this},_processOpacityInfo:function(t){return this._createCache(t)},getOpacity:function(t,e){var o=this._getVarInfo(e&&e.opacityInfo,"opacityInfo");return this._getColorComponent(t,o.variable,this._cache[o.cacheKey],!0)},_getColorComponent:function(t,e,o,i,n){var r,a="object"==typeof t&&!!t,s=e&&e.field,c="number"==typeof t?t:null,l=o&&o.hasExpr,f=o&&o.ipData;if(s||l)"number"!=typeof c&&a&&(c=this._getDataValue(t,e,null,o)),this._isValidNumber(c)||(c=null),null!=c&&(r=i?this._getOpacity(c,e,f):this._getColor(c,e,f));else if(e){var u=e.stops;i?(r=u&&u[0]&&u[0].opacity,null==r&&(r=e.opacityValues&&e.opacityValues[0])):r=u&&u[0]&&u[0].color||e.colors&&e.colors[0]}return n&&(n.data=c,n.value=r),n||r},_isValidNumber:function(t){return"number"==typeof t&&!isNaN(t)&&t!==1/0&&t!==-(1/0)},_interpolateData:function(t){var e;if(t)if(t.colors||t.opacityValues){var i,n=(t.colors||t.opacityValues).length,r=t.minDataValue,a=(t.maxDataValue-r)/(n-1);for(e=[],i=0;n>i;i++)e[i]=r+i*a}else t.stops&&(e=o.map(t.stops,function(t){return t.value}));return e},_getOpacity:function(t,e,o){var i,n=this._lookupData(t,o);if(e=e||this.opacityInfo,n){var r,a,s=n[0],c=n[1];s===c?i=this._getOpacValue(e,s):(r=this._getOpacValue(e,s),a=this._getOpacValue(e,c),i=r+(a-r)*n[2])}return i},_getOpacValue:function(t,e){return t.opacityValues?t.opacityValues[e]:t.stops[e].opacity},_getColor:function(t,e,o){var i,n=this._lookupData(t,o);if(e=e||this.colorInfo,n){var r=n[0],s=n[1];i=r===s?this._getColorObj(e,r):a.blendColors(this._getColorObj(e,r),this._getColorObj(e,s),n[2])}return i},_getColorObj:function(t,e){return t.colors?t.colors[e]:t.stops[e].color},_lookupData:function(t,e){var i;if(e){var n=0,r=e.length-1;o.some(e,function(e,o){return e>t?(r=o,!0):(n=o,!1)}),i=[n,r,(t-e[n])/(e[r]-e[n])]}return i},_meterIn:{inches:1/.0254,feet:1/.3048,yards:1/.9144,miles:1/1609.344,"nautical-miles":1/1852,millimeters:1e3,centimeters:100,decimeters:10,meters:1,kilometers:.001,"decimal-degrees":180/20015077},_writeSizeInfo:function(t){if(t){t=e.mixin({},t),this._convertExpressionToArcade(t);var i=t.minSize,r=t.maxSize;i&&(t.minSize="number"==typeof i?n.px2pt(i):this._writeSizeInfo(i)),r&&(t.maxSize="number"==typeof r?n.px2pt(r):this._writeSizeInfo(r));var a=t.legendOptions;a&&(t.legendOptions=e.mixin({},a),a=a.customValues,a&&(t.legendOptions.customValues=a.slice(0))),t.stops&&(t.stops=o.map(t.stops,function(t){return t=e.mixin({},t),t.size&&"number"==typeof t.size&&(t.size=n.px2pt(t.size)),t}))}return t},_writeColorInfo:function(t){return t&&(t=e.mixin({},t),t.colors&&(t.colors=o.map(t.colors,function(t){return a.toJsonColor(t)})),t.stops&&(t.stops=o.map(t.stops,function(t){return t=e.mixin({},t),t.color&&(t.color=a.toJsonColor(t.color)),t})),t.legendOptions&&(t.legendOptions=e.mixin({},t.legendOptions))),t},_writeOpacityInfo:function(t){var i;return t&&(i=e.mixin({},t),i.opacityValues&&(i.transparencyValues=o.map(i.opacityValues,function(t){return 100*(1-t)}),delete i.opacityValues),i.stops&&(i.stops=o.map(i.stops,function(t){return t=e.mixin({},t),t.transparency=100*(1-t.opacity),delete t.opacity,t})),i.legendOptions&&(i.legendOptions=e.mixin({},i.legendOptions))),i},toJson:function(){var t,i=this.visualVariables,n=e.clone(this.authoringInfo),r=this.getVisualVariablesForType("rotationInfo",!1),a=r&&r[0],s=a&&a.field;return a&&a===this.rotationInfo&&(t=a.expression||s&&(e.isFunction(s)?s:"["+s+"]")),i&&(i=o.map(i,function(t){return"sizeInfo"===t.type?t=this._writeSizeInfo(t):"colorInfo"===t.type?t=this._writeColorInfo(t):"opacityInfo"===t.type?(t=this._writeOpacityInfo(t),t.type="transparencyInfo"):"rotationInfo"===t.type&&(t=e.mixin({},t)),t},this)),n&&o.forEach(n.visualVariables,function(t){"opacityInfo"===t.type&&(t.type="transparencyInfo")}),{rotationType:t&&(this._getRotationType(a)||"geographic"),rotationExpression:t,colorInfo:this._writeColorInfo(this.colorInfo),transparencyInfo:this._writeOpacityInfo(this.opacityInfo),sizeInfo:this._writeSizeInfo(this.sizeInfo),visualVariables:i,authoringInfo:n}}});return i("extend-esri")&&e.setObject("renderer.Renderer",f,r),f});