// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["../core/declare","../core/lang","../core/kebabDictionary","../core/Error","dojo/_base/array","dojo/_base/lang","../support/arcadeUtils","../symbols/support/jsonUtils","../symbols/support/typeUtils","./Renderer"],function(e,a,s,i,n,l,t,o,r,u){var c="log",f="percent-of-total",d="field",m=s({esriNormalizeByLog:c,esriNormalizeByPercentOfTotal:f,esriNormalizeByField:d}),h=s({esriClassifyNaturalBreaks:"natural-breaks",esriClassifyEqualInterval:"equal-interval",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation",esriClassifyGeometricalInterval:"geometrical-interval"}),p=e(u,{declaredClass:"esri.renderers.ClassBreaksRenderer",properties:{backgroundFillSymbol:{value:null,json:{read:o.read,write:function(e,a,s,i){var n=o.write(e,{},i);n&&(a.backgroundFillSymbol=n)}}},classBreakInfos:{set:function(e){e=e?e.slice(0):[],e.forEach(function(e){e.symbol=r.ensureType(e.symbol)}),this._set("classBreakInfos",e)},json:{read:{source:["classBreakInfos","minValue"],reader:function(e,s,i){var n=s.minValue;if(e&&Array.isArray(e)){var l=e[0]&&null!=e[0].classMaxValue;return e.map(function(e){if(e=a.clone(e),l){var t=e.classMaxValue;e.minValue=n,e.maxValue=t,n=t}return e.symbol=o.read(e.symbol,s,i),e})}return e}},write:function(e,s,i,l){var t=this.classBreakInfos||[],r=t[0]&&t[0].minValue;s.minValue=r===-(1/0)?-Number.MAX_VALUE:r,s.classBreakInfos=n.map(t,function(e){return e=a.clone(e),e.symbol&&(e.symbol=o.write(e.symbol,{},l)),e.classMaxValue=e.maxValue===1/0?Number.MAX_VALUE:e.maxValue,delete e.minValue,delete e.maxValue,a.fixJson(e)})}}},classificationMethod:{value:null,json:{read:h.fromJSON,write:function(e,a){var s=h.toJSON(e);s&&(a.classificationMethod=s)}}},defaultLabel:{value:null,json:{write:!0}},defaultSymbol:{types:r.types,value:null,json:{read:o.read,write:function(e,a,s,i){var n=o.write(e,{},i);n&&(a.defaultSymbol=n)}}},valueExpression:{value:null,json:{write:!0}},valueExpressionTitle:{value:null,json:{write:!0}},compiledFunc:{dependsOn:["valueExpression"],get:function(){return t.createFunction(this.valueExpression)}},legendOptions:{value:null,json:{read:function(e){return a.clone(e)},write:function(e,s,n,l){l&&"web-scene"===l.origin?e&&l.messages&&l.messages.push(new i("property:unsupported",this.declaredClass+".legendOptions is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:"legendOptions",context:l})):s.legendOptions=a.clone(e)}}},field:{value:null,json:{write:!0}},isMaxInclusive:!0,normalizationField:{value:null,json:{write:!0}},normalizationTotal:{value:null,json:{write:!0}},normalizationType:{value:null,dependsOn:["normalizationField","normalizationTotal"],get:function(){var e=this._get("normalizationType"),a=!!this.normalizationField,s=null!=this.normalizationTotal;return a||s?(e=a&&d||s&&f,a&&s&&console.warn("warning: both normalizationField and normalizationTotal are set!")):(e===d||e===f)&&(e=null),e},json:{read:m.fromJSON,write:function(e,a){var s=m.toJSON(e);s&&(a.normalizationType=s)}}},requiredFields:{dependsOn:["field","normalizationField","valueExpression"]},type:{value:"class-breaks",json:{write:function(e,a){a.type="classBreaks"}}}},constructor:function(){this.classBreakInfos=[]},addClassBreakInfo:function(e,s,i){var n=l.isObject(e)?a.clone(e):{minValue:e,maxValue:s,symbol:i};n.symbol=r.ensureType(n.symbol),this.classBreakInfos.push(n)},removeClassBreakInfo:function(e,a){var s,i,n=this.classBreakInfos.length;for(i=0;n>i;i++)if(s=[this.classBreakInfos[i].minValue,this.classBreakInfos[i].maxValue],s[0]==e&&s[1]==a){this.classBreakInfos.splice(i,1);break}},getBreakIndex:function(e,a){var s,i,n,o=this.field,r=e.attributes,u=this.classBreakInfos.length,m=this.isMaxInclusive;if(this.valueExpression)s=t.executeFunction(this.compiledFunc,t.createExecContext(e,t.getViewInfo(a)));else if(l.isFunction(o))s=o(e);else{s=parseFloat(r[o]);var h,p,y=this.normalizationType;if(y)if(h=parseFloat(this.normalizationTotal),p=parseFloat(r[this.normalizationField]),y===c)s=Math.log(s)*Math.LOG10E;else if(y!==f||isNaN(h)){if(y===d&&!isNaN(p)){if(isNaN(s)||isNaN(p))return-1;s/=p}}else s=s/h*100}if(null!=s&&!isNaN(s)&&"number"==typeof s)for(i=0;u>i;i++)if(n=[this.classBreakInfos[i].minValue,this.classBreakInfos[i].maxValue],n[0]<=s&&(m?s<=n[1]:s<n[1]))return i;return-1},getClassBreakInfo:function(e,a){var s=this.getBreakIndex(e,a);return-1!==s?this.classBreakInfos[s]:null},getSymbol:function(e,a){var s=this.getBreakIndex(e,a);return s>-1?this.classBreakInfos[s].symbol:this.defaultSymbol},getSymbols:function(){var e=[];return this.classBreakInfos.forEach(function(a){a.symbol&&e.push(a.symbol)}),this.defaultSymbol&&e.push(this.defaultSymbol),e},clone:function(){return new p({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),classificationMethod:this.classificationMethod,defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:a.clone(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:a.clone(this.visualVariables),legendOptions:a.clone(this.legendOptions),authoringInfo:a.clone(this.authoringInfo)})},collectRequiredFields:function(e){this.inherited(arguments),[this.field,this.normalizationField].forEach(function(a){a&&(e[a]=!0)}),this.valueExpression&&t.extractFieldNames(this.valueExpression).forEach(function(a){e[a]=!0})}});return p});