// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["../core/declare","../core/lang","../core/kebabDictionary","../core/Error","../core/Logger","../core/accessorSupport/ensureType","dojo/_base/lang","../support/arcadeUtils","../symbols/Symbol","../symbols/PolygonSymbol3D","../symbols/support/jsonUtils","../symbols/support/typeUtils","./Renderer","./support/LegendOptions","./support/ClassBreakInfo"],function(e,a,i,n,s,t,l,r,o,u,c,f,d,p,m){var h=s.getLogger("esri.renderers.ClassBreaksRenderer");p=p.LegendOptions,m=m.ClassBreakInfo;var y="log",g="percent-of-total",v="field",b=i({esriNormalizeByLog:y,esriNormalizeByPercentOfTotal:g,esriNormalizeByField:v}),k=i({esriClassifyNaturalBreaks:"natural-breaks",esriClassifyEqualInterval:"equal-interval",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation",esriClassifyGeometricalInterval:"geometrical-interval"}),B=t.ensureType(m),I=e(d,{declaredClass:"esri.renderers.ClassBreaksRenderer",properties:{backgroundFillSymbol:{types:{base:o,key:"type",typeMap:{"simple-fill":f.types.typeMap["simple-fill"],"picture-fill":f.types.typeMap["picture-fill"],"polygon-3d":f.types.typeMap["polygon-3d"]}},value:null,json:{origins:{"web-scene":{read:c.read,write:{target:{backgroundFillSymbol:{type:u}},writer:c.writeTarget}}},read:c.read,write:c.writeTarget}},classBreakInfos:{type:[m],json:{read:function(e,a,i){if(Array.isArray(e)){var n=a.minValue;return e.map(function(e){var a=new m;return a.read(e,i),null==a.minValue&&(a.minValue=n),null==a.maxValue&&(a.maxValue=a.minValue),n=a.maxValue,a})}},write:function(e,a,i,n){e=e.map(function(e){return e.write({},n)}),this._areClassBreaksConsecutive()&&e.forEach(function(e){delete e.classMinValue}),a[i]=e}}},minValue:{type:Number,readOnly:!0,dependsOn:["classBreakInfos"],get:function(){return this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0},json:{read:!1,write:{overridePolicy:function(){return 0!==this.classBreakInfos.length&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}},classificationMethod:{type:String,value:null,json:{read:k.fromJSON,write:function(e,a){var i=k.toJSON(e);i&&(a.classificationMethod=i)}}},defaultLabel:{type:String,value:null,json:{write:!0}},defaultSymbol:{types:f.types,value:null,json:{origins:{"web-scene":{read:c.read,write:{target:{defaultSymbol:{types:f.types3D}},writer:c.writeTarget}}},read:c.read,write:c.writeTarget}},valueExpression:{type:String,value:null,json:{write:!0}},valueExpressionTitle:{type:String,value:null,json:{write:!0}},compiledFunc:{dependsOn:["valueExpression"],get:function(){return r.createFunction(this.valueExpression)}},legendOptions:{type:p,value:null,json:{write:!0}},field:{value:null,cast:function(e){return null==e?e:"function"==typeof e?e:t.ensureString(e)},json:{type:String,write:function(e,a,i,s){"string"==typeof e?a[i]=e:s&&s.messages?s.messages.push(new n("property:unsupported","ClassBreaksRenderer.field set to a function cannot be written to JSON")):h.error(".field: cannot write field to JSON since it's not a string value")}}},isMaxInclusive:!0,normalizationField:{type:String,value:null,json:{write:!0}},normalizationTotal:{type:Number,value:null,json:{write:!0}},normalizationType:{type:String,value:null,dependsOn:["normalizationField","normalizationTotal"],get:function(){var e=this._get("normalizationType"),a=!!this.normalizationField,i=null!=this.normalizationTotal;return a||i?(e=a&&v||i&&g,a&&i&&console.warn("warning: both normalizationField and normalizationTotal are set!")):(e===v||e===g)&&(e=null),e},json:{read:b.fromJSON,write:function(e,a){var i=b.toJSON(e);i&&(a.normalizationType=i)}}},requiredFields:{dependsOn:["field","normalizationField","valueExpression"]},type:{value:"class-breaks",json:{write:function(e,a){a.type="classBreaks"}}}},constructor:function(){this.classBreakInfos=[]},addClassBreakInfo:function(e,i,n){var s;s="number"==typeof e?new m({minValue:e,maxValue:i,symbol:n}):B(a.clone(e)),this.classBreakInfos.push(s),1===this.classBreakInfos.length&&this.notifyChange("minValue")},removeClassBreakInfo:function(e,a){var i,n,s=this.classBreakInfos.length;for(n=0;s>n;n++)if(i=[this.classBreakInfos[n].minValue,this.classBreakInfos[n].maxValue],i[0]==e&&i[1]==a){this.classBreakInfos.splice(n,1);break}},getBreakIndex:function(e,a){var i,n,s,t=this.field,o=e.attributes,u=this.classBreakInfos.length,c=this.isMaxInclusive;if(this.valueExpression)i=r.executeFunction(this.compiledFunc,r.createExecContext(e,r.getViewInfo(a)));else if(l.isFunction(t))i=t(e);else{i=parseFloat(o[t]);var f,d,p=this.normalizationType;if(p)if(f=parseFloat(this.normalizationTotal),d=parseFloat(o[this.normalizationField]),p===y)i=Math.log(i)*Math.LOG10E;else if(p!==g||isNaN(f)){if(p===v&&!isNaN(d)){if(isNaN(i)||isNaN(d))return-1;i/=d}}else i=i/f*100}if(null!=i&&!isNaN(i)&&"number"==typeof i)for(n=0;u>n;n++)if(s=[this.classBreakInfos[n].minValue,this.classBreakInfos[n].maxValue],s[0]<=i&&(c?i<=s[1]:i<s[1]))return n;return-1},getClassBreakInfo:function(e,a){var i=this.getBreakIndex(e,a);return-1!==i?this.classBreakInfos[i]:null},getSymbol:function(e,a){var i=this.getBreakIndex(e,a);return i>-1?this.classBreakInfos[i].symbol:this.defaultSymbol},getSymbols:function(){var e=[];return this.classBreakInfos.forEach(function(a){a.symbol&&e.push(a.symbol)}),this.defaultSymbol&&e.push(this.defaultSymbol),e},clone:function(){return new I({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),classificationMethod:this.classificationMethod,defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:a.clone(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:a.clone(this.visualVariables),legendOptions:a.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})},collectRequiredFields:function(e){this.inherited(arguments),[this.field,this.normalizationField].forEach(function(a){a&&(e[a]=!0)}),this.valueExpression&&r.extractFieldNames(this.valueExpression).forEach(function(a){e[a]=!0})},_areClassBreaksConsecutive:function(){for(var e=this.classBreakInfos,a=1;a<e.length;a++)if(e[a-1].maxValue!==e[a].minValue)return!1;return!0}});return I});