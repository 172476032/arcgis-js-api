// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/promiseUtils","../../../../core/Error","../../../../tasks/GenerateRendererTask","./LayerAdapter","../../../../tasks/support/StatisticDefinition","../../../../core/accessorSupport/decorators","../../../../layers/support/arcgisLayerUrl","../../statistics/support/utils","../utils","../../../../layers/support/fieldUtils"],function(e,t,r,s,i,a,n,o,u,l,p,c,d,m){var h=/(https?:)?\/\/services.*\.arcgis\.com/i,y=10,f=function(e){function t(t){var r=e.call(this)||this;return r._layer=t.layer,r}return r(t,e),t.prototype._statisticsFromQuery=function(e){var t=this._layer;if(!t.get("capabilities.query.supportsStatistics")||"multipatch"===this.geometryType&&!p.isHostedAgolService(t.url)&&t.version<10.5)return i.reject(new a("feature-layer-adapter:not-supported","Layer does not support statistics query"));var r=t.createQuery();return r.outStatistics=e.outStatistics,r.groupByFieldsForStatistics=e.groupByFieldsForStatistics,r.orderByFields=e.orderByFields,r.where=c.mergeWhereClauses(r.where,e.where),r.sqlFormat=e.sqlFormat,t.queryFeatures(r)},t.prototype._calcBinsSQL=function(e,t){var r=[],s=t.length;return t.forEach(function(t,i){var a=t[0],n=t[1],o=c.mergeWhereClauses(e+" >= "+a,e+(i===s-1?" <= ":" < ")+n);r.push("WHEN ("+o+") THEN "+(i+1))}),["CASE",r.join(" "),"ELSE 0","END"].join(" ")},t.prototype._getNormalizationTotal=function(e,t){return e&&"percent-of-total"===t?this.summaryStatistics({field:e}).then(function(e){return e.sum}):i.resolve()},t.prototype._getQueryParamsForExpr=function(e,t){var r=e.valueExpression||e.sqlExpression;if(!r){var s=e.field,i=s?this.getField(s):null,a=m.isDateField(i);return{sqlExpression:a?c.msSinceUnixEpochSQL(this,s):c.getFieldExpr(e,t),sqlWhere:a?null:c.getSQLFilterForNormalization(e)}}return{valueExpression:e.valueExpression,sqlExpression:e.sqlExpression,sqlWhere:e.sqlWhere}},t.prototype._getDataRange=function(e,t,r){return null!=t&&null!=r?i.resolve({min:t,max:r}):this.summaryStatistics(e).then(function(e){return{min:e.min,max:e.max}})},t.prototype._histogramForExpr=function(e){var t=this;return this._getNormalizationTotal(e.field,e.normalizationType).then(function(r){return t._getQueryParamsForExpr(e,r)}).then(function(r){return t._getDataRange(r,e.minValue,e.maxValue).then(function(s){var i=s.min,a=s.max,n=e.numBins||y,o=d.getEqualIntervalBins(i,a,n),l=t._calcBinsSQL(r.sqlExpression,o),p="countOFExpr",c=new u({statisticType:"count",outStatisticFieldName:p,onStatisticField:"*"}),m={outStatistics:[c],groupByFieldsForStatistics:[l],orderByFields:[l],where:r.sqlWhere,sqlFormat:"standard"};return t._statisticsFromQuery(m).then(function(e){return d.getHistogramFromFeatureSet(e,i,a,n)})})})},t.prototype._histogramForField=function(e){var t=this,r=null;return r=null!=e.minValue&&null!=e.maxValue?i.resolve({min:e.minValue,max:e.maxValue}):this.summaryStatistics(e).then(function(e){return e.count?{min:e.min,max:e.max}:i.reject(new a("feature-layer-adapter:insufficient-data","Either the layer has no features or none of the features have data for the field"))}),r.then(function(r){return d.getBins({layer:t,field:e.field,numBins:e.numBins},{min:r.min,max:r.max})})},t.prototype.getField=function(e){return void 0===e&&(e=""),this._layer.getField(e)},t.prototype.getFieldUsageInfo=function(e){var t=this.getField(e);return t?{supportsLabelingInfo:!0,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:!0,supportsStatistics:!0}:null},t.prototype.getFieldDomain=function(e,t){return this._layer.getFieldDomain(e,t)},t.prototype.summaryStatistics=function(e){var t=e.field,r=t?this.getField(t):null,s=m.isDateField(r),n="function"==typeof t,o=e.valueExpression||e.sqlExpression;if(this._hasLocalSource||e.features||n)return i.reject(new a("feature-layer-adapter:not-implemented","Client-side calculation is not implemented yet"));if(!this.supportsSQLExpression&&(s||o))return i.reject(new a("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries"));var l=this.supportsSQLExpression&&s?c.msSinceUnixEpochSQL(this,t):e.sqlExpression,p=l||t,h=p?c.getRangeExpr(p,e.minValue,e.maxValue):null,y={sqlFormat:e.sqlExpression?"standard":null,where:c.mergeWhereClauses(e.sqlWhere,h),outStatistics:c.statisticTypes.map(function(e){var t=new u;return t.statisticType="variance"===e?"var":e,t.onStatisticField=p,t.outStatisticFieldName=e+"_value",t})};return this._statisticsFromQuery(y).then(d.getSummaryStatisticsFromFeatureSet).then(d.processSummaryStatisticsResult).then(function(e){return s&&(["min","max","avg","stddev","sum","variance"].forEach(function(t){null!=e[t]&&(e[t]=Math.ceil(e[t]))}),e.min===e.max&&null!=e.min&&(e.avg=e.min,e.stddev=e.variance=0)),e})},t.prototype.uniqueValues=function(e){var t=this,r=e.field,s=e.sqlExpression,n=e.valueExpression&&(!s||!this.supportsSQLExpression);if(this._hasLocalSource||e.features||n)return i.reject(new a("feature-layer-adapter:not-implemented","Client-side calculation is not implemented yet"));var o="countOF"+(r||"Expr"),l=new u;l.statisticType="count",l.onStatisticField=s?"*":r,l.outStatisticFieldName=o;var p={sqlFormat:s?"standard":null,where:e.sqlWhere,outStatistics:[l],groupByFieldsForStatistics:[r||s]};return this._statisticsFromQuery(p).then(function(e){return d.getUniqueValuesFromFeatureSet(e,t,r)})},t.prototype.histogram=function(e){var t=e.field,r=t?this.getField(t):null,s=m.isDateField(r),n=e.valueExpression||e.sqlExpression,o=this.supportsSQLExpression;if(this._hasLocalSource)return i.reject(new a("feature-layer-adapter:not-implemented","Client-side calculation is not implemented yet"));if(n){if(!o)return i.reject(new a("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries"));if(e.normalizationType)return i.reject(new a("feature-layer-adapter:not-supported","Normalization is not allowed when 'valueExpression' or 'sqlExpression' is specified"))}return n||o?this._histogramForExpr(e):s||e.normalizationType?i.reject(new a("feature-layer-adapter:not-supported","Normalization and date field are not allowed when layer does not support standardized SQL expression for queries")):this._histogramForField(e)},t.prototype.queryFeatureCount=function(e){if(this._hasLocalSource)return i.reject(new a("feature-layer-adapter:not-supported","Layer does not support count query"));var t=this._layer,r=t.createQuery();return r.where=c.mergeWhereClauses(r.where,e),t.queryFeatureCount(r)},t.prototype.generateRenderer=function(e){var t=this._layer;if(this._hasLocalSource||t.version<10.1)return i.reject(new a("feature-layer-adapter:not-supported","Layer does not support generateRenderer operation (requires ArcGIS Server version 10.1+)"));var r=new n({url:t.parsedUrl.path,gdbVersion:t.gdbVersion}),s=t.createQuery();return e.where=c.mergeWhereClauses(e.where,s.where),r.execute(e)},t.prototype.getAllFeatures=function(e){return this._hasLocalSource||e?e?e.then(function(){return e.graphics}):this._hasLocalSource?i.resolve(this._layer.source):null:i.reject(new a("feature-layer-adapter:missing-parameters","View is required for service based layers"))},t.prototype.load=function(){var e=this,t=this._layer,r=t.load().then(function(){return e.geometryType=t.geometryType,e.objectIdField=t.objectIdField,e.supportsSQLExpression=h.test(t.url),e._hasLocalSource=!t.url&&!!t.source,e._hasLocalSource?i.reject(new a("feature-layer-adapter:not-supported","Feature collection is not supported")):void 0});return this.addResolvingPromise(r),this},t=s([l.subclass()],t)}(l.declared(o));return f});