// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/declareExtendsHelper","../../../../core/tsSupport/decorateHelper","dojo/_base/lang","../../../../core/Error","../../../../core/Handles","../../../../core/promiseUtils","../../../../core/accessorSupport/decorators","../../../../layers/support/arcgisLayerUrl","../../../../layers/support/fieldUtils","../../statistics/support/utils","../utils","./LayerAdapter","./support/utils","../../../../tasks/GenerateRendererTask","../../../../tasks/support/GenerateRendererParameters","../../../../tasks/support/StatisticDefinition","../../../../tasks/support/UniqueValueDefinition"],function(e,t,r,a,i,n,o,s,l,u,c,m,p,d,f,h,y,v,F){var x=/(https?:)?\/\/services.*\.arcgis\.com/i;return function(e){function t(t){var r=e.call(this)||this;return r._handles=new o,r._layer=t.layer,r}return r(t,e),t.prototype.destroy=function(){this._handles.destroy(),this._handles=null,this._layer=null,this._hasLocalSource=null},t.prototype._summaryStatsFromGenRend=function(e){var t=e.normalizationType,r=e.normalizationField;return this.classBreaks({field:e.field,numClasses:5,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:t,normalizationField:"field"===t?r:void 0,minValue:e.minValue,maxValue:e.maxValue}).then(function(e){var t,r,a;if(e.classBreakInfos.some(function(e){return e.hasAvg&&(t=e),!!t}),t){var i=t.maxValue-t.minValue;r=t.minValue+i/2,a=4*i}var n={min:e.minValue,max:e.maxValue,avg:r,stddev:a};return f.processSummaryStatisticsResult(n)})},t.prototype._summaryStatsFromQuery=function(e,t){var r=e.field,a=this.supportsSQLExpression&&t?f.msSinceUnixEpochSQL(this,r):e.sqlExpression,i=a||r,n=i?m.getRangeExpr(i,e.minValue,e.maxValue):null,o={sqlFormat:e.sqlExpression?"standard":null,where:m.mergeWhereClauses(e.sqlWhere,n),outStatistics:f.statisticTypes.map(function(e){var t=new v;return t.statisticType="variance"===e?"var":e,t.onStatisticField=i,t.outStatisticFieldName=e+"_value",t})};return this._statisticsFromQuery(o).then(f.getSummaryStatisticsFromFeatureSet).then(function(e){return t&&(["min","max","avg","stddev","sum","variance"].forEach(function(t){null!=e[t]&&(e[t]=Math.ceil(e[t]))}),e.min===e.max&&null!=e.min&&(e.avg=e.min,e.stddev=e.variance=0)),f.processSummaryStatisticsResult(e)})},t.prototype._statisticsFromQuery=function(e){var t=this._layer;if(!t.get("capabilities.query.supportsStatistics")||"multipatch"===this.geometryType&&!u.isHostedAgolService(t.url)&&t.version<10.5)return s.reject(new n("feature-layer-adapter:not-supported","Layer does not support statistics query"));var r=t.createQuery();return r.outStatistics=e.outStatistics,r.groupByFieldsForStatistics=e.groupByFieldsForStatistics,r.orderByFields=e.orderByFields,r.where=m.mergeWhereClauses(r.where,e.where),r.sqlFormat=e.sqlFormat,t.queryFeatures(r)},t.prototype._summaryStatsFromMemory=function(e,t){var r=e.field,a="function"==typeof r,o=e.valueExpression,l=o||e.sqlExpression,u=l&&!e.sqlExpression,c=this._hasLocalSource||e.features,m=a||u,p=e.view,d={field:r,valueExpression:o,normalizationField:e.normalizationField,view:p};return(!c&&m?this._fetchFeaturesForStats(d):e.features?s.resolve(e.features):this._fetchFeaturesFromMemory(p)).then(function(a){if(!a||!a.length)return s.reject(new n("feature-layer-adapter:insufficient-data","No features are available to calculate statistics"));var o=i.mixin({},e);if("percent-of-total"===o.normalizationType){var l=f.calculateStatsFromMemory({field:r},a).sum;if(null==l)return s.reject(new n("feature-layer-adapter:invalid","invalid normalizationTotal"));o.normalizationTotal=l}var u=f.calculateStatsFromMemory(o,a,t);return f.processSummaryStatisticsResult(u)})},t.prototype._fetchFeaturesFromMemory=function(e){var t=this,r=this._layer;if(this._hasLocalSource){var a=r.source;return s.resolve(a)}return e?e.whenLayerView(r).then(function(e){var r=s.create(function(r,a){var i=e.watch("updating",function(){t._handles.remove("layerViewUpdate"),e.queryFeatures().then(function(e){r(e)}).catch(function(e){a(e)})});t._handles.add(i,"layerViewUpdate")});return s.timeout(r,1e4,null),r}):s.reject(new n("feature-layer-adapter:insufficient-data","view is required to fetch the features from layerView"))},t.prototype._fetchFeaturesForStats=function(e){var t=this,r=this._layer,a=p.getFieldsList({field:e.field,normalizationField:e.normalizationField,valueExpression:e.valueExpression}),i=r.createQuery();return i.returnGeometry=!1,i.outFields=a,this._layer.queryFeatures(i).then(function(e){return e&&e.features}).catch(function(r){return t._fetchFeaturesFromMemory(e.view)})},t.prototype._uvFromQuery=function(e,t){var r=this,a=e.field,i=e.sqlExpression,n="countOF"+(a||"Expr"),o=new v;o.statisticType="count",o.onStatisticField=i?"*":a,o.outStatisticFieldName=n;var s={sqlFormat:i?"standard":null,where:e.sqlWhere,outStatistics:[o],groupByFieldsForStatistics:[a||i]};return this._statisticsFromQuery(s).then(function(e){return f.getUniqueValuesFromFeatureSet(e,r,a)}).then(function(r){return f.createUVResult(r,"service-query",t,e.returnAllCodedValues)})},t.prototype._uvFromGenRenderer=function(e,t){var r=this,a=e.field,n=new F;n.attributeField=a;var o=new y;return o.classificationDefinition=n,this.generateRenderer(o).then(function(e){var t={},n=r.getField(a),o=c.numericTypes.indexOf(n&&n.type)>-1;return e.uniqueValues.forEach(function(e){var r=e.value;null!=r&&""!==r&&("string"!=typeof r||""!==i.trim(r)&&"<null>"!==r.toLowerCase())||(r=null),null==t[r]?t[r]={count:e.count,data:o&&r?Number(r):r}:t[r].count=t[r].count+e.count}),{count:t}}).then(function(r){return f.createUVResult(r,"service-generate-renderer",t,e.returnAllCodedValues)})},t.prototype._uvFromMemory=function(e,t){var r=e.field,a=e.valueExpression,i=e.sqlExpression,n=e.view,o=a&&!i,l=this._hasLocalSource||e.features,u={field:r,valueExpression:a,view:n};return(!l&&o?this._fetchFeaturesForStats(u):e.features?s.resolve(e.features):this._fetchFeaturesFromMemory(n)).then(function(r){return f.calculateUniqueValuesFromMemory(e,r,t)})},t.prototype._calcBinsSQL=function(e,t){var r=[],a=t.length;return t.forEach(function(t,i){var n=t[0],o=t[1],s=m.mergeWhereClauses(e+" >= "+n,e+(i===a-1?" <= ":" < ")+o);r.push("WHEN ("+s+") THEN "+(i+1))}),["CASE",r.join(" "),"ELSE 0","END"].join(" ")},t.prototype._getNormalizationTotal=function(e,t){return e&&"percent-of-total"===t?this.summaryStatistics({field:e}).then(function(e){return e.sum}):s.resolve()},t.prototype._getQueryParamsForExpr=function(e,t){if(!e.valueExpression&&!e.sqlExpression){var r=e.field,a=r?this.getField(r):null,i=c.isDateField(a),n={field:r,normalizationType:e.normalizationType,normalizationField:e.normalizationField,normalizationTotal:t};return{sqlExpression:i?f.msSinceUnixEpochSQL(this,r):f.getFieldExpr(n),sqlWhere:i?null:m.getSQLFilterForNormalization(e)}}return{valueExpression:e.valueExpression,sqlExpression:e.sqlExpression,sqlWhere:e.sqlWhere}},t.prototype._getDataRange=function(e,t,r){return null!=t&&null!=r?s.resolve({min:t,max:r}):this.summaryStatistics(e).then(function(e){return{min:e.min,max:e.max}})},t.prototype._histogramForExpr=function(e){var t=this;return this._getNormalizationTotal(e.field,e.normalizationType).then(function(r){return t._getQueryParamsForExpr(e,r)}).then(function(r){return t._getDataRange(r,e.minValue,e.maxValue).then(function(a){var i=a.min,n=a.max,o=e.numBins||10,s=f.getEqualIntervalBins(i,n,o),l=t._calcBinsSQL(r.sqlExpression,s),u=new v({statisticType:"count",outStatisticFieldName:"countOFExpr",onStatisticField:"*"}),c={outStatistics:[u],groupByFieldsForStatistics:[l],orderByFields:[l],where:r.sqlWhere,sqlFormat:"standard"};return t._statisticsFromQuery(c).then(function(e){return f.getHistogramFromFeatureSet(e,i,n,o)})})})},t.prototype._histogramForField=function(e){var t=this,r=null;return r=null!=e.minValue&&null!=e.maxValue?s.resolve({min:e.minValue,max:e.maxValue}):this.summaryStatistics(e).then(function(e){return e.count?{min:e.min,max:e.max}:s.reject(new n("feature-layer-adapter:insufficient-data","Either the layer has no features or none of the features have data for the field"))}),r.then(function(r){return t._getBins({min:r.min,max:r.max},e.field,e.numBins)})},t.prototype._getBins=function(e,t,r){void 0===r&&(r=10);var a=e.min,i=e.max,n=e.normTotal,o=e.excludeZerosExpr,s=e.intervals||f.getEqualIntervalBins(a,i,r),l=e.sqlExpr||t;return this._queryBins(s,l,o).then(function(e){return{bins:e.map(function(e,t){return{minValue:s[t][0],maxValue:s[t][1],count:e.value}}),minValue:a,maxValue:i,normalizationTotal:n}})},t.prototype._queryBins=function(e,t,r){for(var a=this,i=[],n=e.length,o=0;o<n;o++){var l=m.mergeWhereClauses(r,m.mergeWhereClauses(t+" >= "+e[o][0],null!==e[o][1]?t+(o===n-1?" <= ":" < ")+e[o][1]:""));i.push(l)}return s.eachAlways(i.map(function(e){return a.queryFeatureCount(e)}))},t.prototype._binParamsFromGenRend=function(e,t){var r=e.field,a=e.normalizationType,i=e.normalizationField,n=m.getSQLFilterForNormalization({field:r,normalizationType:a,normalizationField:i}),o=new y({classificationDefinition:f.createCBDefn({field:r,normalizationType:a,normalizationField:i,classificationMethod:e.classificationMethod,standardDeviationInterval:e.standardDeviationInterval,breakCount:e.numBins||10}),where:m.mergeWhereClauses(n,t)});return this.generateRenderer(o).then(function(e){var t=e.normalizationTotal,o=e.classBreaks;return f.generateBinParams({field:r,normalizationType:a,normalizationField:i,normalizationTotal:t,classBreaks:o,where:n})})},t.prototype._histogramFromMemory=function(e){var t=this,r=e.field,a=e.normalizationField,o=e.normalizationType,l=e.valueExpression,u=e.classificationMethod,c=e.minValue,m=e.maxValue,p=e.view,d=l&&!e.sqlExpression,h=this._hasLocalSource||e.features,y={field:r,valueExpression:l,normalizationField:a,view:p};return(!h&&d?this._fetchFeaturesForStats(y):e.features?s.resolve(e.features):this._fetchFeaturesFromMemory(p)).then(function(a){if(!a||!a.length)return s.reject(new n("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"));var d=!u||"equal-interval"===u,h=null!=c&&null!=m,y=null;if(d&&!o)y=h?s.resolve({min:c,max:m,source:"parameters"}):t.summaryStatistics({field:r,valueExpression:l,features:a,view:p}).then(function(e){return e.count?{min:e.min,max:e.max}:s.reject(new n("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});else{var v=i.mixin({},e);v.features=a,y=t._getBinParamsFromMemory(v)}return y.then(function(t){return f.calculateHistogramFromMemory(e,t,a)})})},t.prototype._getBinParamsFromMemory=function(e){var t=e.field,r=e.valueExpression,a=e.classificationMethod,i=e.standardDeviationInterval,n=e.normalizationType,o=e.normalizationField,s=e.minValue,l=e.maxValue,u=e.features,c=e.view;return this._classBreaksFromMemory({field:t,valueExpression:r,normalizationType:n,normalizationField:o,classificationMethod:a,standardDeviationInterval:i,minValue:s,maxValue:l,numClasses:e.numBins,features:u,view:c}).then(function(e){var r=e.normalizationTotal,a=e.classBreakInfos,i=m.getSQLFilterForNormalization({field:t,normalizationType:n,normalizationField:o});return f.generateBinParams({field:t,normalizationType:n,normalizationField:o,normalizationTotal:r,classBreaks:a,where:i})})},t.prototype._classBreaksFromGenRend=function(e){var t=e.field,r=e.normalizationType,a=e.normalizationField,i=e.normalizationTotal,n=m.getSQLFilterForNormalization({field:t,normalizationType:r,normalizationField:a}),o=f.getFieldExpr({field:t,normalizationType:r,normalizationField:a,normalizationTotal:i}),s=m.getRangeExpr(o,e.minValue,e.maxValue),l=f.createCBDefn({field:t,normalizationType:r,normalizationField:a,classificationMethod:e.classificationMethod,standardDeviationInterval:e.standardDeviationInterval,breakCount:e.numClasses||5}),u=new y;return u.classificationDefinition=l,u.where=m.mergeWhereClauses(n,s),this.generateRenderer(u).then(function(t){return f.resolveCBResult(e,t)})},t.prototype._classBreaksFromInterpolation=function(e){for(var t=e.minValue,r=e.maxValue,a=e.numClasses||5,i=[],n=(r-t)/a,o=0;o<a;o++){var l=t+o*n;i.push({minValue:l,maxValue:l+n})}i[a-1].maxValue=r;var u={classBreaks:i,normalizationTotal:e.normalizationTotal},c=f.resolveCBResult(e,u);return s.resolve(c)},t.prototype._classBreaksFromMemory=function(e){var t=e.field,r=e.normalizationField,a=e.valueExpression,o=e.view,l=this._hasLocalSource||e.features,u={field:t,valueExpression:a,normalizationField:r,view:o};return(!l&&a?this._fetchFeaturesForStats(u):e.features?s.resolve(e.features):this._fetchFeaturesFromMemory(o)).then(function(r){if(!r||!r.length)return s.reject(new n("feature-layer-adapter:insufficient-data","No features are available to calculate statistics"));var a=i.mixin({},e);if("percent-of-total"===a.normalizationType){var o=f.calculateStatsFromMemory({field:t},r).sum;if(null==o)return s.reject(new n("feature-layer-adapter:invalid","invalid normalizationTotal"));a.normalizationTotal=o}return f.calculateClassBreaksFromMemory(a,r)})},t.prototype.getField=function(e){return void 0===e&&(e=""),this._layer.getField(e)},t.prototype.getFieldUsageInfo=function(e){return this.getField(e)?{supportsLabelingInfo:!0,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:!0,supportsStatistics:!0}:null},t.prototype.getFieldDomain=function(e,t){return this._layer.getFieldDomain(e,t)},t.prototype.summaryStatistics=function(e){var t=this,r=e.field,a=r?this.getField(r):null,i=c.isDateField(a),o="function"==typeof r,l=e.valueExpression||e.sqlExpression,u=l&&!e.sqlExpression,m=this._hasLocalSource||e.features,p=o||u;return m||p?this._summaryStatsFromMemory(e,i):this.supportsSQLExpression||!i&&!l?(e.normalizationType?this._summaryStatsFromGenRend(e):this._summaryStatsFromQuery(e,i)).catch(function(r){return t._summaryStatsFromMemory(e,i)}):s.reject(new n("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries"))},t.prototype.uniqueValues=function(e){var t=this,r=e.field,a=e.valueExpression,i=e.sqlExpression,n=r?this.getField(r):null,o=n&&this.getFieldDomain(r),s=a&&(!i||!this.supportsSQLExpression);return this._hasLocalSource||e.features||s?this._uvFromMemory(e,o):this._uvFromQuery(e,o).catch(function(r){return e.field?t._uvFromGenRenderer(e,o):r}).catch(function(r){return t._uvFromMemory(e,o)})},t.prototype.histogram=function(e){var t=this,r=e.field,a=e.normalizationType,i=e.normalizationField,o=e.classificationMethod,l=r?this.getField(r):null,u=c.isDateField(l),p=e.valueExpression||e.sqlExpression,d=p&&!e.sqlExpression,h=this._hasLocalSource||e.features||d,y=this.supportsSQLExpression,v=!o||"equal-interval"===o,F=e.minValue,x=e.maxValue,g=null!=F&&null!=x,_=e.numBins||10;return h?this._histogramFromMemory(e):(p||y)&&v?p&&!y?s.reject(new n("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries")):this._histogramForExpr(e):u&&v?s.reject(new n("feature-layer-adapter:not-supported","Normalization and date field are not allowed when layer does not support standardized SQL expression for queries")):a||!v?this._binParamsFromGenRend(e).then(function(o){if(!g)return t._getBins(o,r,_);if(F>o.max||x<o.min)return s.reject(new n("histogram:insufficient-data","Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field"));if(v)return t._getBins({min:F,max:x,sqlExpr:o.sqlExpr,excludeZerosExpr:o.excludeZerosExpr},r,_);var l={field:r,normalizationType:a,normalizationField:i,normalizationTotal:o.normTotal},u=f.getFieldExpr(l),c=m.getRangeExpr(u,F,x);return t._binParamsFromGenRend(e,c).then(function(e){return t._getBins(e,r,_)})}):this._histogramForField(e)},t.prototype.classBreaks=function(e){var t=this,r=!1!==e.analyzeData,a=this._hasLocalSource||e.features||e.valueExpression;return r&&a?this._classBreaksFromMemory(e):(r?this._classBreaksFromGenRend(e):this._classBreaksFromInterpolation(e)).catch(function(r){return t._classBreaksFromMemory(e)})},t.prototype.queryFeatureCount=function(e){if(this._hasLocalSource)return s.reject(new n("feature-layer-adapter:not-supported","Layer does not support count query"));var t=this._layer,r=t.createQuery();return r.where=m.mergeWhereClauses(r.where,e),t.queryFeatureCount(r)},t.prototype.generateRenderer=function(e){var t=this._layer;if(this._hasLocalSource||t.version<10.1)return s.reject(new n("feature-layer-adapter:not-supported","Layer does not support generateRenderer operation (requires ArcGIS Server version 10.1+)"));var r=new h({url:t.parsedUrl.path,source:t.dynamicDataSource,gdbVersion:t.gdbVersion}),a=t.createQuery();return e.where=m.mergeWhereClauses(e.where,a.where),r.execute(e)},t.prototype.load=function(){var e=this,t=this._layer,r=t.load().then(function(){e.geometryType=t.geometryType,e.objectIdField=t.objectIdField,e.supportsSQLExpression=x.test(t.url),e._hasLocalSource=!t.url&&!!t.source});return this.addResolvingPromise(r),this.when()},t=a([l.subclass()],t)}(l.declared(d))});