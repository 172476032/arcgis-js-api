// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","dojo/string","dojo/_base/lang","../../../../../core/promiseUtils","../../../../../support/arcadeUtils","../../../../../tasks/support/ClassBreaksDefinition","../../../../../tasks/support/generateRendererUtils"],function(e,n,a,t,r,i,o,l){function u(e){var n=e&&e.features,a=n&&n[0]&&n[0].attributes,t={};for(var r in a)t[r.replace(N,"").toLowerCase()]=a[r];return t.min===t.max&&null!=t.min&&null==t.stddev&&(t.stddev=t.variance=0),t}function s(e,n,a){var t=f(e,n);t=c(t,e.minValue,e.maxValue);var r=m(t,!e.normalizationType);return a&&["avg","stddev","variance"].forEach(function(e){null!=r[e]&&(r[e]=Math.ceil(r[e]))}),r}function c(e,n,a){return n=null==n?-1/0:n,a=null==a?1/0:a,e.filter(function(e){if(null!=e&&q(e)&&e>=n&&e<=a)return e})}function f(e,n){var a=e.field,t="function"==typeof a,r=e.valueExpression,o=i.createFunction(r),l=e.normalizationType,u=e.normalizationField,s=e.normalizationTotal,c=[],f=e.view,m=f&&i.getViewInfo({viewingMode:"2d"===f.type?"map":f.viewingMode,scale:f.scale,spatialReference:f.spatialReference});return n?(n.forEach(function(e){var n,f=e.attributes;if(r){var d=i.createExecContext(e,m);n=i.executeFunction(o,d)}else t?n=a.call(null,e):f&&(n=f[a]);if(l&&null!=n&&q(n)){var v=f&&parseFloat(f[u]);"log"===l&&0!==n?n=Math.log(n)*Math.LOG10E:"percent-of-total"===l&&q(s)&&0!==s?n=n/s*100:"field"===l&&q(v)&&0!==v&&(n/=v)}c.push(n)}),c):c}function m(e,n){for(var a=Number.POSITIVE_INFINITY,t=Number.NEGATIVE_INFINITY,r=null,i=null,o=null,l=null,u=0,s=e;u<s.length;u++){var c=s[u];r+=c,a=Math.min(a,c),t=Math.max(t,c)}var f=e.length;if(f){i=r/f;for(var m=0,d=0,v=e;d<v.length;d++){var c=v[d];m+=Math.pow(c-i,2)}l=n?f>1?m/(f-1):0:f>0?m/f:0,o=Math.sqrt(l)}else a=null,t=null;return{avg:i,count:f,max:t,min:a,stddev:o,sum:r,variance:l}}function d(e){var a;for(a in e)n.statisticTypes.indexOf(a)>-1&&(q(e[a])||(e[a]=null));return e}function v(e){var n=e.field,a=e.classificationMethod||A,t=e.normalizationType,r=e.normalizationField,i=new o;return i.classificationField=n,i.breakCount=e.breakCount,i.classificationMethod=a,i.standardDeviationInterval="standard-deviation"===a?e.standardDeviationInterval||G:void 0,i.normalizationType=t,i.normalizationField="field"===t?r:void 0,i}function p(e,n){var a=e.normalizationTotal,t=v({field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,classificationMethod:e.classificationMethod,standardDeviationInterval:e.standardDeviationInterval,breakCount:e.numClasses||R}),r=f(e,n);return r=c(r,e.minValue,e.maxValue),h(e,l.createGenerateRendererClassBreaks({definition:t,values:r,normalizationTotal:a}))}function h(e,n){var a=n.classBreaks,r=a.length,i=a[0].minValue,o=a[r-1].maxValue,l="standard-deviation"===e.classificationMethod,u=L;return a=a.map(function(e){var n=e.label,a={minValue:e.minValue,maxValue:e.maxValue,label:n};if(l&&n){var r=n.match(u),i=r.map(function(e){return+t.trim(e)});2===i.length?(a.minStdDev=i[0],a.maxStdDev=i[1],i[0]<0&&i[1]>0&&(a.hasAvg=!0)):1===i.length&&(n.indexOf("<")>-1?(a.minStdDev=null,a.maxStdDev=i[0]):n.indexOf(">")>-1&&(a.minStdDev=i[0],a.maxStdDev=null))}return a}),{minValue:i,maxValue:o,classBreakInfos:a,normalizationTotal:n.normalizationTotal}}function g(e,n,a){for(var t,r=(n-e)/a,i=[],o=e,l=1;l<=a;l++)t=o+r,t=Number(t.toFixed(16)),i.push([o,t]),o=t;return i}function x(e){var n=[],a=e.classBreaks,t=a[0].minValue,r=a[a.length-1].maxValue;a.forEach(function(e){n.push([e.minValue,e.maxValue])});var i={field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,normalizationTotal:e.normalizationTotal};return{min:t,max:r,intervals:n,sqlExpr:T(i),excludeZerosExpr:e.where,normTotal:e.normalizationTotal}}function T(e){var n=e.field,a=e.normalizationType,t=e.normalizationField,r=e.normalizationTotal,i=n;return"percent-of-total"===a?i="(("+n+" / "+r+") * 100)":"log"===a?i="(log("+n+") * "+_+")":"field"===a&&(i="("+n+" / "+t+")"),i}function V(e,n,a){for(var t=n.min,r=n.max,i=n.normTotal,o=e.numBins||P,l=n.intervals||g(t,r,o),u=l.map(function(e,n){return{minValue:l[n][0],maxValue:l[n][1],count:0}}),s=f(e,a),c=0,m=s;c<m.length;c++){var d=m[c];if(null!=d&&d>=t&&d<=r){var v=y(l,d);v>-1&&u[v].count++}}return{bins:u,minValue:t,maxValue:r,normalizationTotal:i}}function y(e,n){for(var a=-1,t=e.length-1;t>=0;t--){if(n>=e[t][0]){a=t;break}}return a}function F(e,n){var a;if(n=n.toLowerCase(),e)for(var t in e)if(t.toLowerCase()!==n){a=e[t];break}return a}function b(e,n){var a;if(n=n.toLowerCase(),e)for(var t in e)if(t.toLowerCase()===n){a=e[t];break}return a}function z(e,n,a,t){var r={};e&&e.features&&e.features.forEach(function(e){var n=e.attributes,a=F(n,"countOFExpr"),t=b(n,"countOFExpr");0!==a&&(r[a]=t)});var i=[];return g(n,a,t).forEach(function(e,n){var a=(n+1).toString();i.push({minValue:e[0],maxValue:e[1],count:r.hasOwnProperty(a)?r[a]:0})}),{bins:i,minValue:n,maxValue:a}}function E(e,n,a,i){var o=e&&e.features,l="countOF"+(a||"Expr"),u={},s=!1;if(o.forEach(function(e){var n=e.attributes,r=b(n,l),i=a?b(n,a):F(n,l);null===i&&0===r&&(s=!0),(null==i||"string"==typeof i&&""===t.trim(i))&&(i=null),null==u[i]?u[i]={count:r,data:i}:u[i].count=u[i].count+r}),a&&s){var c=a+" is NULL";return n.queryFeatureCount(c).then(function(e){return e=e||0,u.null.count=u.null.count+e,C(u,i)}).catch(function(){return C(u,i)})}return r.resolve(C(u,i))}function C(e,n){if(n)for(var a in e)e[a].label=n[a];return{count:e}}function M(e,n,a,t){var r=e.count,i=[];if(t&&a&&"coded-value"===a.type){a.codedValues.forEach(function(e){var n=e.code;r.hasOwnProperty(n)||(r[n]={data:n,count:0})})}for(var o in r){var l=r[o];i.push({value:l.data,count:l.count,label:l.label})}return{uniqueValueInfos:i}}function S(e,n,a){for(var r=e.features?B:O,i=f(e,n),o={},l=0,u=i;l<u.length;l++){var s=u[l];(null==s||"string"==typeof s&&""===t.trim(s))&&(s=null),null==o[s]?o[s]={count:1,data:s}:o[s].count++}return M({count:o},r,a,e.returnAllCodedValues)}function w(e){return a.pad(e,2,"0")}function I(e,n){var a;return"date"===n||"number"===n?("number"===n&&(e=new Date(e)),a="TIMESTAMP'"+e.getUTCFullYear()+"-"+w(e.getUTCMonth()+1)+"-"+w(e.getUTCDate())+" "+w(e.getUTCHours())+":"+w(e.getUTCMinutes())+":"+w(e.getUTCSeconds())+"'"):a=e,a}function D(e,n){var a;if(n instanceof Date)a="date";else if("number"==typeof n)a="number";else if("string"==typeof n){var t=e.getField(n);"<now>"===n.toLowerCase()?a="":t&&t.type===j&&(a="field")}return a}function k(e,n,a,t){var r="("+I(a,D(e,a))+" - "+I(n,D(e,n))+")",i=H[t],o="/";return i<1&&(i=1/i,o="*"),{sqlExpression:1===i?r:"("+r+" "+o+" "+i+")",sqlWhere:null}}function U(e,n){return k(e,new Date(0),n,"milliseconds").sqlExpression}function q(e){return"number"==typeof e&&!isNaN(e)&&e!==1/0&&e!==-1/0}Object.defineProperty(n,"__esModule",{value:!0});var N=/_value$/i,O="features-in-memory",B="features",L=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,R=5,P=10,_=Math.LOG10E,A="equal-interval",G=1,j="date",H={years:365,months:30,days:1,hours:1/24,minutes:1/1440,seconds:1/86400,milliseconds:1/864e5};n.statisticTypes=["min","max","avg","stddev","count","sum","variance"],n.getSummaryStatisticsFromFeatureSet=u,n.calculateStatsFromMemory=s,n.getDataValues=f,n.processSummaryStatisticsResult=d,n.createCBDefn=v,n.calculateClassBreaksFromMemory=p,n.resolveCBResult=h,n.getEqualIntervalBins=g,n.generateBinParams=x,n.getFieldExpr=T,n.calculateHistogramFromMemory=V,n.getHistogramFromFeatureSet=z,n.getUniqueValuesFromFeatureSet=E,n.createUVResult=M,n.calculateUniqueValuesFromMemory=S,n.msSinceUnixEpochSQL=U,n.isValidNumber=q});