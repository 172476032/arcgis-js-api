// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","dojo/_base/lang","../../../../Color","../../../../core/Error","../../../../core/numberUtils","../../../../core/promiseUtils","../../statistics/classBreaks","../../../support/pointCloud/PointSizeSplatAlgorithm","../../../../symbols/FillSymbol3DLayer","../../../../symbols/IconSymbol3DLayer","../../../../symbols/MeshSymbol3D","../../../../symbols/ObjectSymbol3DLayer","../../../../symbols/PointSymbol3D","../../../../symbols/SimpleFillSymbol","../../../../symbols/SimpleLineSymbol","../../../../symbols/SimpleMarkerSymbol"],function(e,n,i,r,l,t,o,a,s,u,m,c,d,f,y,v,b){function h(e,n){return new l(e,n)}function p(e,n,i){var r,l,t=g({statistics:e,isDate:n});return t.defaultValuesUsed?(r=t.min,l=t.max):!i||null!=e.avg&&e.stddev||(r=e.min,l=e.max),null!=r?[r,l]:null}function g(e){var n=e&&e.statistics;n||(n={});var i,r;if(null==n.min)if(e.isDate){var l=w();i=l[0],r=l[1]}else i=0,r=100;else if(n.min===n.max)if(e.isDate){var t=w(n.min);i=t[0],r=t[1]}else n.min<0?(i=2*n.min,r=0):n.min>0?(i=0,r=2*n.min):(i=0,r=100);return{min:null!=i?i:n.min,max:null!=r?r:n.max,defaultValuesUsed:null!=i||null!=r}}function w(e){var n="number"==typeof e?new Date(e):new Date,i=n.getUTCFullYear(),r=Date.UTC(i,0,1,12,0,0,0),l=Date.UTC(i,11,31,12,0,0,0);return"number"==typeof e&&(e<r&&(r=e),e>l&&(l=e)),[r,l]}function S(e,n){for(var i=[],l=e.length,t=0;t<n;t++)i.push(new r(e[t%l]));return i}function x(e,n){void 0===n&&(n=!0);var i=e.avg,r=i-e.stddev,l=i+e.stddev;r<e.min&&(r=e.min),l>e.max&&(l=e.max),n&&(i=r+(l-r)/2);var o=t.round([r,l],{strictBounds:!0});return r=o[0],l=o[1],o=[r,r+(i-r)/2,i,i+(l-i)/2,l],t.round(o,{strictBounds:!0})}function z(e,n,i,r,l,t,o){var a;switch(i){case"point":case"multipoint":var s=null!=o?o:e.size;if("2d"===r)a=new b({color:n,size:s,outline:{color:e.outline.color,width:e.outline.width}});else if("3d-flat"===r)a=new f({symbolLayers:[new m({size:s,resource:{primitive:"circle"},material:{color:n},outline:{color:e.outline.color,size:e.outline.width}})]});else if(r.indexOf("3d-volumetric")>-1){var h="3d-volumetric-uniform"===r?"sphere":"cylinder";a=new f({symbolLayers:[new d({height:s,resource:{primitive:h},material:{color:n}})]})}break;case"polyline":var p=null!=o?o:e.width;"2d"===r&&(a=new v({color:n,width:p}));break;case"polygon":"2d"===r&&(a=new y({color:n,outline:{color:e.outline.color,width:e.outline.width}}));break;case"mesh":a=new c({symbolLayers:[new u({material:{color:n,colorMixMode:l},edges:null==t||"none"===t?null:{type:t,color:j}})]})}return a}function D(e,n,i){var r=U({layer:e,fields:n});if(r.length)return h(i,"Unknown fields: "+r.join(", ")+". You can only use fields defined in the layer schema");var l=V({layer:e,fields:n});return l.length?h(i,"Unsupported fields: "+l.join(", ")+". You can only use fields that are accessible to the renderer i.e. FieldUsageInfo.supportsRenderer must be true"):void 0}function U(e){var n=e.layer;return e.fields.filter(function(e){return!n.getField(e)})}function V(e){var n=e.layer;return e.fields.filter(function(e){var i=n.getFieldUsageInfo(e);return!i||!i.supportsRenderer})}function F(e){return a(e).then(function(n){var r,l=p({min:n.minValue,max:n.maxValue,avg:null,stddev:null},!1,!1);return r=l?a(i.mixin(e,{classificationMethod:"equal-interval",numClasses:1,analyzeData:!1,minValue:l[0],maxValue:l[1],normalizationTotal:l[0]+l[1]})):o.resolve(n),r.then(function(e){return{result:e,defaultValuesUsed:!!l}})})}function C(e,n){var i=e.minSize,r=e.maxSize;if("height"===n){i=((r-i)/2+i)/4.6,r*=2}return{minSize:i,maxSize:r}}function k(e){return M.test(e)}function L(e){var n=e.match(M),i=Number(n[1]);if("%"===n[3])return new s.default({scaleFactor:i/100,minSize:1.1})}Object.defineProperty(n,"__esModule",{value:!0});var M=/^(\d+(\.\d+)?)\s*(%)$/i,j=[0,0,0,.4];n.createError=h,n.getDefaultDataRange=p,n.createColors=S,n.createStopValues=x,n.createSymbol=z,n.verifyBasicFieldValidity=D,n.getClassBreaks=F,n.getSizeRangeForAxis=C,n.isValidPointSize=k,n.getPointSizeAlgorithm=L});