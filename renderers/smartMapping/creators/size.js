// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","dojo/i18n!../../nls/smartMapping","dojo/_base/lang","../../ClassBreaksRenderer","../statistics/summaryStatistics","../symbology/size","../../support/utils","../../../core/promiseUtils","./support/utils","../support/utils","../../support/utils","../../../core/screenUtils","../../support/AuthoringInfoVisualVariable","../../support/AuthoringInfo","../statistics/support/utils"],function(e,a,r,i,l,n,t,s,o,u,d,m,c,p,y,f){function b(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))return o.reject(u.createError("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));var a=i.mixin({},e),r=[0,1],l=d.createLayerAdapter(a.layer,r);return a.layer=l,l?l.load().then(function(){var e=l.geometryType;if("mesh"===e)return o.reject(u.createError("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type"));if(a.worldScale){if("polyline"===e||"polygon"===e)return o.reject(u.createError("size-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers"));if(!a.view||"3d"!==a.view.type)return o.reject(u.createError("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true"))}var r=d.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}),i=u.verifyBasicFieldValidity(l,r,"size-visual-variable:invalid-parameters");return i?o.reject(i):a}):o.reject(u.createError("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+d.getLayerTypeLabels(r).join(", ")))}function v(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))return o.reject(u.createError("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required"));var a=i.mixin({},e);a.symbolType=a.symbolType||"2d",a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;var r=[0,1],l=d.createLayerAdapter(a.layer,r);return a.layer=l,l?l.load().then(function(){var e=l.geometryType,r=a.symbolType.indexOf("3d")>-1;if("mesh"===e)return o.reject(u.createError("size-continuous-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type"));if(r&&("polyline"===e||"polygon"===e))return o.reject(u.createError("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers"));if(a.symbolType.indexOf("3d-volumetric")>-1&&(!a.view||"3d"!==a.view.type))return o.reject(u.createError("size-continuous-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform"));var i=d.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}),n=u.verifyBasicFieldValidity(l,i,"size-continuous-renderer:invalid-parameters");return n?o.reject(n):a}):o.reject(u.createError("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+d.getLayerTypeLabels(r).join(", ")))}function h(e){if(!(e&&e.layer&&e.field))return o.reject(u.createError("size-class-breaks-renderer:missing-parameters","'layer' and 'field' parameters are required"));var a=i.mixin({},e);a.symbolType=a.symbolType||"2d",a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled,a.classificationMethod=a.classificationMethod||"equal-interval",a.normalizationType=f.getNormalizationType(a);var r=[0,1],l=d.createLayerAdapter(a.layer,r);if(a.layer=l,!l)return o.reject(u.createError("size-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+d.getLayerTypeLabels(r).join(", ")));var n=null!=a.minValue&&null!=a.maxValue;return n||null==a.minValue&&null==a.maxValue?l.load().then(function(){var e=l.geometryType,r=a.symbolType.indexOf("3d")>-1;if("mesh"===e)return o.reject(u.createError("size-class-breaks-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type"));if(r&&("polyline"===e||"polygon"===e))return o.reject(u.createError("size-class-breaks-renderer:not-supported","3d symbols are not supported for polyline and polygon layers"));if(a.symbolType.indexOf("3d-volumetric")>-1&&(!a.view||"3d"!==a.view.type))return o.reject(u.createError("size-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform"));var i=d.getFieldsList({field:a.field,normalizationField:a.normalizationField}),n=u.verifyBasicFieldValidity(l,i,"size-class-breaks-renderer:invalid-parameters");return n?o.reject(n):a}):o.reject(u.createError("size-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range"))}function z(e){var a=i.mixin({},e);delete a.basemap,delete a.sizeScheme,delete a.legendOptions,delete a.symbolType,delete a.defaultSymbolEnabled,delete a.view;var r=a;return r.analyzeData=!(null!=a.minValue&&null!=a.maxValue),r}function S(e){var a=i.mixin({},e),r=a.symbolType.indexOf("3d-volumetric")>-1,l=a;return l.worldScale=r,r&&(l.axis="3d-volumetric-uniform"===a.symbolType?"all":"height"),delete a.symbolType,delete a.defaultSymbolEnabled,l}function g(e){var a=e.sizeScheme,r=e.basemap;if(a)a=t.cloneScheme(a);else{var i=t.getSchemes({basemap:e.basemap,geometryType:e.geometryType,worldScale:e.worldScale,view:e.view});a=i&&i.primaryScheme,r=i&&i.basemapId}return{scheme:a,basemapId:r}}function x(e,a){var r;switch(a){case"point":case"multipoint":var i=e;r=[i.minSize,i.maxSize];break;case"polyline":var l=e;r=[l.minWidth,l.maxWidth];break;case"polygon":var n=e;r=[n.marker.minSize,n.marker.maxSize]}return r}function E(e,a,r){var i=r.layer,l=r.field,n="function"==typeof l,s=l&&!n?i.getField(l):null,d=s&&s.type===I,m=i.geometryType,c=g({basemap:r.basemap,geometryType:m,sizeScheme:r.sizeScheme,worldScale:r.worldScale,view:r.view}),f=c.scheme;if(!f)return o.reject(u.createError("size-visual-variable:insufficient-info","Unable to find size scheme"));var b=x(f,m),v=u.getDefaultDataRange(e,d,!1),h=v||[e.min,e.max],z=[],S=b[0],E=b[1],V=void 0;if("height"===r.axis){var w=2.3;z.push({type:"size",axis:"width-and-depth",minSize:((E-S)/2+S)/(2*w)}),V="height",E*=2}z.unshift({type:"size",field:l,valueExpression:r.valueExpression,valueUnit:"unknown",normalizationField:a,axis:V,minSize:S,maxSize:E,minDataValue:h[0],maxDataValue:h[1],legendOptions:r.legendOptions});var T=new p({type:"size",minSliderValue:e.min,maxSliderValue:e.max}),k=new y({visualVariables:[T]});return o.resolve({basemapId:c.basemapId,visualVariables:z,statistics:e,defaultValuesUsed:!!v,sizeScheme:t.cloneScheme(f),authoringInfo:k})}function V(e,a,i,n){var o=n.layer,d=n.field,m=o.geometryType,c=n.defaultSymbolEnabled,p=t.cloneScheme(e.sizeScheme),y="polygon"===m,f=y?p.marker:p,b=y?p.background:null,v="polyline"===m?f.noDataWidth:f.noDataSize,h=b?u.createSymbol(b,b.color,m,n.symbolType):null,z=new l({backgroundFillSymbol:h,classBreakInfos:[{minValue:-L,maxValue:L,symbol:u.createSymbol(f,f.color,y?"point":m,n.symbolType)}],defaultLabel:c?r.other:null,defaultSymbol:c?u.createSymbol(f,f.noDataColor,y?"point":m,n.symbolType,null,v):null,field:d,normalizationField:i,normalizationType:a,valueExpression:n.valueExpression,visualVariables:e.visualVariables.map(function(e){return s.cloneSizeVariable(e)}),authoringInfo:e.authoringInfo&&e.authoringInfo.clone()});return{renderer:z,visualVariables:e.visualVariables.map(function(e){return s.cloneSizeVariable(e)}),statistics:e.statistics,defaultValuesUsed:e.defaultValuesUsed,sizeScheme:t.cloneScheme(e.sizeScheme),basemapId:e.basemapId}}function w(e,a,r){for(var i=x(e,a),l=c.toPt(i[0]),n=c.toPt(i[1]),t=(n-l)/(r>=4?r-1:r),s=[],o=0;r>o;o++)s.push(l+t*o);return s}function T(e,a){var i=e.layer,n=e.field,s=e.defaultSymbolEnabled,d=i.geometryType,c="polygon"===d,p=g({basemap:e.basemap,geometryType:d,sizeScheme:e.sizeScheme,worldScale:e.symbolType.indexOf("3d-volumetric")>-1,view:e.view}),f=p.scheme,b=a.result,v=b.classBreakInfos,h=e.classificationMethod,z=e.normalizationType,S=w(f,d,v.length),x=c?f.marker:f,E=c?f.background:null,V="polyline"===d?x.noDataWidth:x.noDataSize,T=new l({backgroundFillSymbol:E?u.createSymbol(E,E.color,d,e.symbolType):null,classBreakInfos:v.map(function(a,r){return{minValue:a.minValue,maxValue:a.maxValue,symbol:u.createSymbol(x,x.color,c?"point":d,e.symbolType,null,S[r]),label:a.label}}),defaultLabel:s?r.other:null,defaultSymbol:s?u.createSymbol(x,x.noDataColor,c?"point":d,e.symbolType,null,V):null,field:n,classificationMethod:h,normalizationType:z,normalizationField:e.normalizationField,normalizationTotal:"percent-of-total"===z?b.normalizationTotal:void 0,legendOptions:e.legendOptions,authoringInfo:new y({type:"class-breaks-size",classificationMethod:h,standardDeviationInterval:e.standardDeviationInterval})});return"standard-deviation"!==h&&m.setLabelsForClassBreaks({classBreakInfos:T.classBreakInfos,classificationMethod:h,normalizationType:z,round:!0}),o.resolve({renderer:T,sizeScheme:t.cloneScheme(f),classBreaksResult:b,defaultValuesUsed:a.defaultValuesUsed,basemapId:p.basemapId})}function k(e){return b(e).then(function(e){var a,r=e.normalizationField,i=r?"field":void 0;return a=e.statistics?o.resolve(e.statistics):n({layer:e.layer,field:e.field,valueExpression:e.valueExpression,sqlExpression:e.sqlExpression,sqlWhere:e.sqlWhere,normalizationType:i,normalizationField:r,minValue:e.minValue,maxValue:e.maxValue}),a.then(function(a){return E(a,r,e)})})}function j(e){return v(e).then(function(e){return k(S(e)).then(function(a){var r=e.normalizationField,i=r?"field":void 0;return V(a,i,r,e)})})}function F(e){return h(e).then(function(e){return u.getClassBreaks(z(e)).then(function(a){return T(e,a)})})}Object.defineProperty(a,"__esModule",{value:!0});var I="date",L=Math.pow(2,53)-1;a.createVisualVariables=k,a.createContinuousRenderer=j,a.createClassBreaksRenderer=F});