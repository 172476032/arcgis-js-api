// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","dojo/i18n!../../nls/smartMapping","dojo/_base/lang","../symbology/type","../../../core/promiseUtils","../../../core/lang","../support/utils","./support/utils","../statistics/uniqueValues","../../UniqueValueRenderer","../../support/utils","../../support/LegendOptions","../../PointCloudUniqueValueRenderer"],function(e,r,l,t,a,n,o,i,s,u,c,d,p,y){function m(e){if(!e||!e.layer||!e.field&&!e.valueExpression)return n.reject(s.createError("type-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required"));var r=t.mixin({},e);r.symbolType=r.symbolType||"2d",r.numTypes=null==r.numTypes?10:r.numTypes,r.defaultSymbolEnabled=null==r.defaultSymbolEnabled?!0:r.defaultSymbolEnabled,r.sortBy=null==r.sortBy?"count":r.sortBy,r.statistics=o.clone(r.statistics);var l=[0,1],a=i.createLayerAdapter(r.layer,l);return r.layer=a,a?a.load().then(function(){var e=a.geometryType,l=r.symbolType.indexOf("3d")>-1;if("mesh"===e)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace";else{if(l&&("polyline"===e||"polygon"===e))return n.reject(s.createError("type-renderer:not-supported","3d symbols are not supported for polyline and polygon layers"));if(r.symbolType.indexOf("3d-volumetric")>-1&&(!r.view||"3d"!==r.view.type))return n.reject(s.createError("type-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'"))}var t=i.getFieldsList({field:r.field,valueExpression:r.valueExpression}),o=s.verifyBasicFieldValidity(a,t,"type-renderer:invalid-parameters");return o?n.reject(o):r}):n.reject(s.createError("type-renderer:invalid-parameters","'layer' must be one of these types: "+i.getLayerTypeLabels(l).join(", ")))}function f(e){if(!(e&&e.layer&&e.field))return n.reject(s.createError("type-point-cloud-class-renderer:missing-parameters","'layer' and 'field' parameters are required"));var r=t.mixin({},e);r.statistics=o.clone(r.statistics);var l=[2],a=i.createLayerAdapter(r.layer,l);return r.layer=a,r.density=r.density||25,r.size=r.size||"100%",s.isValidPointSize(r.size)?a?a.load().then(function(){var e=i.getFieldsList({field:r.field}),l=s.verifyBasicFieldValidity(a,e,"type-point-cloud-class-renderer:invalid-parameters");return l?n.reject(l):r}):n.reject(s.createError("type-point-cloud-class-renderer:invalid-parameters","'layer' must be one of these types: "+i.getLayerTypeLabels(l).join(", "))):n.reject(s.createError("type-point-cloud-class-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"))}function v(e){var r=e.typeScheme,l=e.basemap;if(r)r=a.cloneScheme(r);else{var t=a.getSchemes({basemap:e.basemap,geometryType:e.geometryType,theme:e.theme,worldScale:e.worldScale,view:e.view});r=t&&t.primaryScheme,l=t&&t.basemapId}return{scheme:r,basemapId:l}}function b(e,r){var l;return l=e.label<r.label?-1:e.label>r.label?1:0}function h(e,r){var l;return l=e.value<r.value?-1:e.value>r.value?1:0}function g(e,r){var l=r.count-e.count;return 0===l&&(l=b(e,r)),l}function S(e,r){var l=r.count-e.count;return 0===l&&(l=h(e,r)),l}function T(e,r,l){var t;"count"===r?(t=S,l&&l.codedValues&&(t=g)):"value"===r&&(t=h,l&&l.codedValues&&(t=b)),t&&e.sort(t)}function x(e,r){var n,o=e.uniqueValueInfos,i=r.layer,u=r.field,y=u?i.getField(u):null,m=y?i.getFieldDomain(y.name):null,f=-1===r.numTypes?o.length:r.numTypes,b=i.geometryType,h=v({basemap:r.basemap,geometryType:b,typeScheme:r.typeScheme,worldScale:r.symbolType.indexOf("3d-volumetric")>-1,view:r.view}),g=h.scheme,S=new c({field:u}),x=-1,E={value:null,domain:m,fieldInfo:y};if(o.forEach(function(e,r){E.value=e.value,e.label=d.createUniqueValueLabel(E),null===e.value&&(x=r)}),x>-1&&(n=o.splice(x,1)[0]),T(o,r.sortBy,m),y&&y.type===q){var V=o.filter(function(e,r){return f>r}),I=V.map(function(e){return e.value});E.dateFormatInterval=d.calculateDateFormatInterval(I)}var w=s.createColors(g.colors,o.length);o.forEach(function(e,l){E.value=e.value,e.label=d.createUniqueValueLabel(E),e.symbol=s.createSymbol(g,w[l],b,r.symbolType,r.colorMixMode)}),r.valueExpression&&(S.valueExpression=r.valueExpression,S.valueExpressionTitle=r.valueExpressionTitle),r.legendOptions&&(S.legendOptions=new p.LegendOptions(r.legendOptions)),w=s.createColors(g.colors,f);for(var j=0;f>j;j++){var M=o[j];M&&S.addUniqueValueInfo({value:M.value,label:M.label,symbol:s.createSymbol(g,w[j],b,r.symbolType,r.colorMixMode)})}r.defaultSymbolEnabled&&(S.defaultSymbol=s.createSymbol(g,g.noDataColor,b,r.symbolType,r.colorMixMode),S.defaultLabel=l.other),n&&(n.symbol=s.createSymbol(g,g.noDataColor,b,r.symbolType,r.colorMixMode),o.push(n));var L=[],C=S.uniqueValueInfos.length===o.length?-1:S.uniqueValueInfos.length;if(C>-1)for(var j=C;j<o.length;j++)L.push(t.mixin({},o[j]));return{renderer:S,uniqueValueInfos:o,excludedUniqueValueInfos:L,typeScheme:a.cloneScheme(g),basemapId:h.basemapId}}function E(e,r){var l=e.uniqueValueInfos,t=v({basemap:"gray",theme:"point-cloud-class",geometryType:"point",typeScheme:r}),a=t&&t.scheme,n="point-cloud-class"===a.theme,o=n?a.colors:s.createColors(a.colors,l.length);return T(l,"value"),l.map(function(e,r){var l=e.value,t=null;return n?(t=o[l],t||(t=o[o.length-1])):t=o[r],{values:[l],color:t,label:e.label}})}function V(e){return m(e).then(function(e){var r=null!=e.statistics?n.resolve(e.statistics):u({layer:e.layer,field:e.field,valueExpression:e.valueExpression,returnAllCodedValues:e.returnAllCodedValues});return r.then(function(r){return x(r,e)})})}function I(e){return f(e).then(function(e){var r=null!=e.statistics?n.resolve(e.statistics):u({layer:e.layer,field:e.field});return r.then(function(r){var l=new y({field:e.field,pointsPerInch:e.density,pointSizeAlgorithm:s.getPointSizeAlgorithm(e.size),colorUniqueValueInfos:E(r,e.typeScheme)});return{renderer:l}})})}Object.defineProperty(r,"__esModule",{value:!0});var q="date";r.createRenderer=V,r.createPCClassRenderer=I});