// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","dojo/i18n!../../nls/smartMapping","dojo/_base/lang","../symbology/type","../../../core/promiseUtils","../../../core/lang","../support/utils","./support/utils","../../../views/SceneView","../statistics/uniqueValues","../../UniqueValueRenderer","../../support/utils","../../PointCloudUniqueValueRenderer"],function(e,r,l,a,t,n,o,i,s,u,c,d,p,y){function m(e){if(!e||!e.layer||!e.field&&!e.valueExpression)return n.reject(s.createError("type-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required"));var r=a.mixin({},e);r.symbolType=r.symbolType||"2d",r.numTypes=null==r.numTypes?10:r.numTypes,r.defaultSymbolEnabled=null==r.defaultSymbolEnabled?!0:r.defaultSymbolEnabled,r.sortBy=null==r.sortBy?"count":r.sortBy,r.statistics=o.clone(r.statistics);var l=[0,1],t=i.createLayerAdapter(r.layer,l);return r.layer=t,t?t.load().then(function(){var e=t.geometryType,l=r.symbolType.indexOf("3d")>-1;if("mesh"===e)r.symbolType="3d-volumetric",r.colorMixMode=r.colorMixMode||"replace";else{if(l&&("polyline"===e||"polygon"===e))return n.reject(s.createError("type-renderer:not-supported","3d symbols are not supported for polyline and polygon layers"));if(r.symbolType.indexOf("3d-volumetric")>-1&&!(r.view instanceof u))return n.reject(s.createError("type-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'"))}var a=i.getFieldsList({field:r.field,valueExpression:r.valueExpression}),o=s.verifyBasicFieldValidity(t,a,"type-renderer:invalid-parameters");return o?n.reject(o):r}):n.reject(s.createError("type-renderer:invalid-parameters","'layer' must be one of these types: "+i.getLayerTypeLabels(l).join(", ")))}function f(e){if(!(e&&e.layer&&e.field))return n.reject(s.createError("type-point-cloud-class-renderer:missing-parameters","'layer' and 'field' parameters are required"));var r=a.mixin({},e);r.statistics=o.clone(r.statistics);var l=[2],t=i.createLayerAdapter(r.layer,l);return r.layer=t,r.density=r.density||25,r.size=r.size||"100%",s.isValidPointSize(r.size)?t?t.load().then(function(){var e=i.getFieldsList({field:r.field}),l=s.verifyBasicFieldValidity(t,e,"type-point-cloud-class-renderer:invalid-parameters");return l?n.reject(l):r}):n.reject(s.createError("type-point-cloud-class-renderer:invalid-parameters","'layer' must be one of these types: "+i.getLayerTypeLabels(l).join(", "))):n.reject(s.createError("type-point-cloud-class-renderer:invalid-parameters","Invalid 'size' parameter. It should be a string of the form '100%'"))}function v(e){var r=e.typeScheme,l=e.basemap;if(r)r=t.cloneScheme(r);else{var a=t.getSchemes({basemap:e.basemap,geometryType:e.geometryType,theme:e.theme,worldScale:e.worldScale,view:e.view});r=a&&a.primaryScheme,l=a&&a.basemapId}return{scheme:r,basemapId:l}}function b(e,r){var l;return l=e.label<r.label?-1:e.label>r.label?1:0}function h(e,r){var l;return l=e.value<r.value?-1:e.value>r.value?1:0}function g(e,r){var l=r.count-e.count;return 0===l&&(l=b(e,r)),l}function S(e,r){var l=r.count-e.count;return 0===l&&(l=h(e,r)),l}function T(e,r,l){var a;"count"===r?(a=S,l&&l.codedValues&&(a=g)):"value"===r&&(a=h,l&&l.codedValues&&(a=b)),a&&e.sort(a)}function x(e,r){var n,o=e.uniqueValueInfos,i=r.layer,u=r.field,c=u?i.getField(u):null,y=c?i.getFieldDomain(c.name):null,m=-1===r.numTypes?o.length:r.numTypes,f=i.geometryType,b=v({basemap:r.basemap,geometryType:f,typeScheme:r.typeScheme,worldScale:r.symbolType.indexOf("3d-volumetric")>-1,view:r.view}),h=b.scheme,g=new d({field:u}),S=-1,x={value:null,domain:y,fieldInfo:c};if(o.forEach(function(e,r){x.value=e.value,e.label=p.createUniqueValueLabel(x),null===e.value&&(S=r)}),S>-1&&(n=o.splice(S,1)[0]),T(o,r.sortBy,y),c&&c.type===q){var E=o.filter(function(e,r){return m>r}),V=E.map(function(e){return e.value});x.dateFormatInterval=p.calculateDateFormatInterval(V)}var I=s.createColors(h.colors,o.length);o.forEach(function(e,l){x.value=e.value,e.label=p.createUniqueValueLabel(x),e.symbol=s.createSymbol(h,I[l],f,r.symbolType,r.colorMixMode)}),r.valueExpression&&(g.valueExpression=r.valueExpression,g.valueExpressionTitle=r.valueExpressionTitle),g.legendOptions=r.legendOptions,I=s.createColors(h.colors,m);for(var w=0;m>w;w++){var j=o[w];j&&g.addUniqueValueInfo({value:j.value,label:j.label,symbol:s.createSymbol(h,I[w],f,r.symbolType,r.colorMixMode)})}r.defaultSymbolEnabled&&(g.defaultSymbol=s.createSymbol(h,h.noDataColor,f,r.symbolType,r.colorMixMode),g.defaultLabel=l.other),n&&(n.symbol=s.createSymbol(h,h.noDataColor,f,r.symbolType,r.colorMixMode),o.push(n));var M=[],L=g.uniqueValueInfos.length===o.length?-1:g.uniqueValueInfos.length;if(L>-1)for(var w=L;w<o.length;w++)M.push(a.mixin({},o[w]));return{renderer:g,uniqueValueInfos:o,excludedUniqueValueInfos:M,typeScheme:t.cloneScheme(h),basemapId:b.basemapId}}function E(e,r){var l=e.uniqueValueInfos,a=v({basemap:"gray",theme:"point-cloud-class",geometryType:"point",typeScheme:r}),t=a&&a.scheme,n="point-cloud-class"===t.theme,o=n?t.colors:s.createColors(t.colors,l.length);return T(l,"value"),l.map(function(e,r){var l=e.value,a=null;return n?(a=o[l],a||(a=o[o.length-1])):a=o[r],{values:[l],color:a,label:e.label}})}function V(e){return m(e).then(function(e){var r=null!=e.statistics?n.resolve(e.statistics):c({layer:e.layer,field:e.field,valueExpression:e.valueExpression,returnAllCodedValues:e.returnAllCodedValues});return r.then(function(r){return x(r,e)})})}function I(e){return f(e).then(function(e){var r=null!=e.statistics?n.resolve(e.statistics):c({layer:e.layer,field:e.field});return r.then(function(r){var l=new y({field:e.field,pointsPerInch:e.density,pointSizeAlgorithm:s.getPointSizeAlgorithm(e.size),colorUniqueValueInfos:E(r,e.typeScheme)});return{renderer:l}})})}Object.defineProperty(r,"__esModule",{value:!0});var q="date";r.createRenderer=V,r.createPCClassRenderer=I});