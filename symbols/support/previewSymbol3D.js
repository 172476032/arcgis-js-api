// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../core/Logger","../../core/promiseUtils","../../core/Error","../../core/screenUtils","./styleUtils","./symbolUtils","./gfxUtils","./renderUtils","./previewUtils"],function(e,a,r,t,l,s,i,o,n,h,p){function u(e){var a=e.outline,r=e.get("material.color"),t=r&&r.toRgba().toString();if(!a)return"fill"===e.type&&"255,255,255,1"===t?{color:"#bdc3c7",width:.75}:null;var l=s.pt2px(a.size)||0,i=null!=a.color?a.color.toRgba():"255,255,255,1";return{color:"rgba("+i+")",width:Math.min(l,j)}}function c(e,a){var r=a&&a.resource,l=r&&r.href;return e.thumbnail&&e.thumbnail.url?t.resolve(e.thumbnail.url):l&&"object"!==a.type?t.resolve(o.getIconHref(e,a)):e.styleOrigin&&(e.styleOrigin.styleName||e.styleOrigin.styleUrl)?i.resolveWebStyleSymbol(e.styleOrigin,{portal:e.styleOrigin.portal}).always(function(e){return e&&e.thumbnail&&e.thumbnail.url||z}):t.resolve(z)}function m(e,a){var r=.75;return Math.min(Math.max(e+255*a*r,0),255)}function f(e,a){if(!e.material||!e.material.color){var r=n.defaultThematicColor.r,t=m(r,a);return[t,t,t,100]}for(var l=e.material.color.toRgb(),s=0;3>s;s++)l[s]=m(l[s],a);return l.push(e.material.color.a),l}function v(e){return e.outline?u(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function d(e,a){if(!e.material)return{};for(var r=e.material.color.toRgb(),t="rgba(",l=0;3>l;l++)t+=m(r[l],a)+",";t+=e.material.color.a+");";var i=e.size?s.pt2px(e.size):.75;return{color:t,width:Math.min(i,j)}}function y(e,a,r){var t=.75*r;return{type:"linear",x1:t?.25*t:0,y1:t?.5*t:0,x2:t||4,y2:t?.5*t:4,colors:[{color:e,offset:0},{color:a,offset:1}]}}function b(e){var a=e.depth,r=e.height,t=e.width;return t&&a&&r&&t===a&&r>t}function g(e,a,r,t){var l=e&&e.type,s="icon"===l,i="object"===l,o=[];if(s){var n=e,h=0,c=0,m=r,d=r;switch(a){case"circle":o.push({shape:{type:"circle",cx:0,cy:0,r:.5*r},fill:f(n,0),stroke:u(n)});break;case"square":o.push({shape:{type:"path",path:[{command:"M",values:[h,d]},{command:"L",values:[h,c]},{command:"L",values:[m,c]},{command:"L",values:[m,d]},{command:"Z",values:[]}]},fill:f(n,0),stroke:u(n)});break;case"cross":o.push({shape:{type:"path",path:[{command:"M",values:[.5*m,c]},{command:"L",values:[.5*m,d]},{command:"M",values:[h,.5*d]},{command:"L",values:[m,.5*d]},{command:"E",values:[]}]},stroke:v(n)});break;case"x":o.push({shape:{type:"path",path:[{command:"M",values:[h,c]},{command:"L",values:[m,d]},{command:"M",values:[m,c]},{command:"L",values:[h,d]},{command:"E",values:[]}]},stroke:v(n)});break;case"kite":o.push({shape:{type:"path",path:[{command:"M",values:[h,.5*d]},{command:"L",values:[.5*m,c]},{command:"L",values:[m,.5*d]},{command:"L",values:[.5*m,d]},{command:"Z",values:[]}]},fill:f(n,0),stroke:u(n)})}}else if(i){var b=e;switch(a){case"cone":var g=f(b,0),x=f(b,-.6),w=t?D:r,M=y(g,x,w),k=p.getConeShapes(r,t);o.push({shape:k[0],fill:M}),o.push({shape:k[1],fill:M});break;case"inverted-cone":var S=f(b,0),L=f(b,-.6),z=y(S,L,r),U=p.getInvertedConeShapes(r);o.push({shape:U[0],fill:z}),o.push({shape:U[1],fill:S});break;case"cube":var E=p.getCubeShapes(r,t);o.push({shape:E[0],fill:f(b,0)}),o.push({shape:E[1],fill:f(b,-.3)}),o.push({shape:E[2],fill:f(b,-.5)});break;case"cylinder":var j=f(b,0),C=f(b,-.6),I=t?D:r,O=y(j,C,I),P=p.getCylinderShapes(r,t);o.push({shape:P[0],fill:O}),o.push({shape:P[1],fill:O}),o.push({shape:P[2],fill:f(b,0)});break;case"diamond":var R=p.getDiamondShapes(r);o.push({shape:R[0],fill:f(b,-.3)}),o.push({shape:R[1],fill:f(b,0)}),o.push({shape:R[2],fill:f(b,-.3)}),o.push({shape:R[3],fill:f(b,-.7)});break;case"sphere":var A=f(b,0),T=f(b,-.6),q=y(A,T);q.x1=0,q.y1=0,q.x2=.25*r,q.y2=.25*r,o.push({shape:{type:"circle",cx:0,cy:0,r:.5*r},fill:q});break;case"tetrahedron":var H=p.getTetrahedronShapes(r);o.push({shape:H[0],fill:f(b,-.3)}),o.push({shape:H[1],fill:f(b,0)}),o.push({shape:H[2],fill:f(b,-.6)})}}return o}function x(e){return"icon"===e.type?"multiply":"tint"}function w(e){return"icon"===e.type?"circle":"sphere"}function M(e,a){var r,l=a&&a.size?s.pt2px(a.size):null,i=a&&a.maxSize?s.pt2px(a.maxSize):null,o=a&&a.disableUpsampling,n=e.symbolLayers,p=[],m=0,f=0,v=n.getItemAt(n.length-1);return v&&"icon"===v.type&&(r=v.size&&s.pt2px(v.size)),n.forEach(function(n,v){if("icon"===n.type||"object"===n.type){var d="icon"===n.type?n.size&&s.pt2px(n.size):0,y=l||d?Math.ceil(Math.min(l||d,i||E)):U,M=u(n),k=M?M.width:0;if(n&&n.resource&&n.resource.href){var S=c(e,n).then(function(e){var a=n.get("material.color"),r=x(n);return h.tintImageWithColor(e,y,a,r,o)}).then(function(e){var a=e.width,r=e.height;return m=Math.max(m,a+2*k),f=Math.max(f,r+2*k),[{shape:{type:"image",width:a,height:r,src:e.url},fill:null,stroke:null}]});p.unshift(S)}else{var L=n.get("resource.primitive"),z=L||w(n),j=y;"icon"===n.type&&r&&l&&(j=y*(d/r));var C=a&&"tall"===a.symbolConfig||("object"===n.type?b(n):!1);m=Math.max(m,C?D:j+2*k),f=Math.max(f,j+2*k),p.unshift(t.resolve(g(n,z,j,C)))}}}),t.eachAlways(p).then(function(e){var r=[];return e.forEach(function(e){e.value?r.push(e.value):e.error&&I.warn("error while building swatchInfo!",e.error)}),h.renderSymbol(r,[m,f],{node:a&&a.node,scale:!1})})}function k(e,a){var r,l=e.symbolLayers,i=[],n=o.isVolumetricSymbol(e),u=a&&a.size?s.pt2px(a.size):null,c=a&&a.maxSize?s.pt2px(a.maxSize):null,m=c||j,v=0,y=0;return l.forEach(function(e,a){var t=e&&e.type,l="line"===t,s="path"===t;if(l||s){var o=d(e,0),n=o&&o.width||0,h=[];if(l){0===a&&(r=n);var c=Math.min(u||n,m),b=0===a?c:u?c*(n/r):c,g=b>U?2*b:C;y=Math.max(y,b),v=Math.max(v,g),o.width=b,h.push({shape:{type:"path",path:[{command:"M",values:[0,.5*y]},{command:"L",values:[v,.5*y]},{command:"E",values:[]}]},stroke:o})}else{var x=Math.min(u||U,m),w=f(e,0),M=f(e,-.2),k=d(e,-.4),S=1;k.width=S,h.push({shape:p.shapes.pathSymbol3DLayer[0],fill:M,stroke:k}),h.push({shape:p.shapes.pathSymbol3DLayer[1],fill:w,stroke:k}),y=Math.max(y,x+2*S),v=y}i.push(h)}}),t.resolve(h.renderSymbol(i,[v,y],{node:a&&a.node,scale:n}))}function S(e,a){for(var r=e.type,l="mesh-3d"===r,i=e.symbolLayers,o=a&&a.size?s.pt2px(a.size):null,n=a&&a.maxSize?s.pt2px(a.maxSize):null,c=o||U,m=[],v=0,y=0,b=0;b<i.length;b++){var g=i.getItemAt(b),x=g.type,w="fill"===x,M="line"===x,k="extrude"===g.type,S=[];if(l&&!w)return;var L=p.shapes.fill[0];if(w){var z=u(g),j=z&&z.width||0;v=Math.max(v,U+j),y=Math.max(y,U+j),S.push({shape:L,fill:f(g,0),stroke:z})}else if(M){var C=d(g,0),D=C&&C.width||0,I={stroke:C,shape:L};v=Math.max(v,U+D),y=Math.max(y,U+D),S.push(I)}else if(k){var O=d(g,-.4),P=f(g,0),R=f(g,-.2),A=Math.min(c,n||E),T=p.getExtrudeSymbolShapes(A);O.width=1,S.push({shape:T[0],fill:R,stroke:O}),S.push({shape:T[1],fill:R,stroke:O}),S.push({shape:T[2],fill:P,stroke:O});var q=U,H=.7*U+.5*A;v=Math.max(v,q+2*O.width),y=Math.max(y,H+2*O.width)}m.push(S)}return t.resolve(h.renderSymbol(m,[v,y],{node:a&&a.node,scale:!1}))}function L(e,a){if(0===e.symbolLayers.length)return t.reject(new l("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));var r=null;switch(e.type){case"point-3d":r=M(e,a);break;case"line-3d":r=k(e,a);break;case"polygon-3d":case"mesh-3d":r=S(e,a)}return r?r:t.reject(new l("symbolPreview: swatchInfo3D","symbol not supported."))}Object.defineProperty(a,"__esModule",{value:!0});var z=e.toUrl("../../images/Legend/legend3dsymboldefault.png"),U=22,E=120,j=80,C=40,D=20,I=r.getLogger("esri.symbols.support.previewSymbol3D");a.previewSymbol3D=L});