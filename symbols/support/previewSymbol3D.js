// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../core/Logger","../../core/promiseUtils","../../core/Error","../../core/screenUtils","./styleUtils","./symbolUtils","./gfxUtils","./renderUtils","./previewUtils"],function(e,a,r,t,l,s,i,o,n,h,p){function u(e){var a=e.outline,r=e.get("material.color"),t=r&&r.toRgba().toString();if(!a)return"fill"===e.type&&"255,255,255,1"===t?{color:"#bdc3c7",width:.75}:null;var l=s.pt2px(a.size)||0,i=null!=a.color?a.color.toRgba():"255,255,255,1";return{color:"rgba("+i+")",width:Math.min(l,j)}}function c(e,a){var r=a&&a.resource,l=r&&r.href;return l&&"object"!==a.type?t.resolve(o.getIconHref(e,a)):e.thumbnail&&e.thumbnail.url?t.resolve(e.thumbnail.url):e.styleOrigin&&(e.styleOrigin.styleName||e.styleOrigin.styleUrl)?i.resolveWebStyleSymbol(e.styleOrigin,{portal:e.styleOrigin.portal}).always(function(e){return e&&e.thumbnail&&e.thumbnail.url||E}):t.resolve(E)}function m(e,a){var r=.75;return Math.min(Math.max(e+255*a*r,0),255)}function f(e,a){if(!e.material||!e.material.color){var r=n.defaultThematicColor.r,t=m(r,a);return[t,t,t,100]}for(var l=e.material.color.toRgb(),s=0;3>s;s++)l[s]=m(l[s],a);return l.push(e.material.color.a),l}function v(e){return e.outline?u(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function d(e,a){if(!e.material)return{};for(var r=e.material.color.toRgb(),t="rgba(",l=0;3>l;l++)t+=m(r[l],a)+",";t+=e.material.color.a+");";var i=e.size?s.pt2px(e.size):.75;return{color:t,width:Math.min(i,j)}}function y(e,a,r){var t=.75*r;return{type:"linear",x1:t?.25*t:0,y1:t?.5*t:0,x2:t||4,y2:t?.5*t:4,colors:[{color:e,offset:0},{color:a,offset:1}]}}function b(e){var a=e.depth,r=e.height,t=e.width;return t&&a&&r&&t===a&&r>t}function g(e,a,r,t){var l=e&&e.type,s="icon"===l,i="object"===l,o=[];if(s){var n=e,h=0,c=0,m=r,d=r;switch(a){case"circle":o.push({shape:{type:"circle",cx:0,cy:0,r:.5*r},fill:f(n,0),stroke:u(n)});break;case"square":o.push({shape:{type:"path",path:[{command:"M",values:[h,d]},{command:"L",values:[h,c]},{command:"L",values:[m,c]},{command:"L",values:[m,d]},{command:"Z",values:[]}]},fill:f(n,0),stroke:u(n)});break;case"cross":o.push({shape:{type:"path",path:[{command:"M",values:[.5*m,c]},{command:"L",values:[.5*m,d]},{command:"M",values:[h,.5*d]},{command:"L",values:[m,.5*d]},{command:"E",values:[]}]},stroke:v(n)});break;case"x":o.push({shape:{type:"path",path:[{command:"M",values:[h,c]},{command:"L",values:[m,d]},{command:"M",values:[m,c]},{command:"L",values:[h,d]},{command:"E",values:[]}]},stroke:v(n)});break;case"kite":o.push({shape:{type:"path",path:[{command:"M",values:[h,.5*d]},{command:"L",values:[.5*m,c]},{command:"L",values:[m,.5*d]},{command:"L",values:[.5*m,d]},{command:"Z",values:[]}]},fill:f(n,0),stroke:u(n)})}}else if(i){var b=e;switch(a){case"cone":var g=f(b,0),x=f(b,-.6),w=t?O:r,M=y(g,x,w),k=p.getConeShapes(r,t);o.push({shape:k[0],fill:M}),o.push({shape:k[1],fill:M});break;case"inverted-cone":var S=f(b,0),L=f(b,-.6),z=y(S,L,r),U=p.getInvertedConeShapes(r);o.push({shape:U[0],fill:z}),o.push({shape:U[1],fill:S});break;case"cube":var E=p.getCubeShapes(r,t);o.push({shape:E[0],fill:f(b,0)}),o.push({shape:E[1],fill:f(b,-.3)}),o.push({shape:E[2],fill:f(b,-.5)});break;case"cylinder":var C=f(b,0),D=f(b,-.6),j=t?O:r,I=y(C,D,j),P=p.getCylinderShapes(r,t);o.push({shape:P[0],fill:I}),o.push({shape:P[1],fill:I}),o.push({shape:P[2],fill:f(b,0)});break;case"diamond":var R=p.getDiamondShapes(r);o.push({shape:R[0],fill:f(b,-.3)}),o.push({shape:R[1],fill:f(b,0)}),o.push({shape:R[2],fill:f(b,-.3)}),o.push({shape:R[3],fill:f(b,-.7)});break;case"sphere":var T=f(b,0),q=f(b,-.6),A=y(T,q);A.x1=0,A.y1=0,A.x2=.25*r,A.y2=.25*r,o.push({shape:{type:"circle",cx:0,cy:0,r:.5*r},fill:A});break;case"tetrahedron":var H=p.getTetrahedronShapes(r);o.push({shape:H[0],fill:f(b,-.3)}),o.push({shape:H[1],fill:f(b,0)}),o.push({shape:H[2],fill:f(b,-.6)})}}return o}function x(e,a){var r,l=a&&a.size?s.pt2px(a.size):null,i=a&&a.maxSize?s.pt2px(a.maxSize):null,o=a&&a.disableUpsampling,n=e.symbolLayers,p=[],m=0,f=0,v=n.getItemAt(n.length-1);return v&&"icon"===v.type&&(r=v.size&&s.pt2px(v.size)),n.forEach(function(v,d){var y=v&&v.type,x="icon"===y,w="object"===y,M=v,k=x?M.size&&s.pt2px(M.size):0,S=l||k?Math.ceil(Math.min(l||k,i||D)):C;if(x||w){var L=u(v),z=L?L.width:0;if(v&&v.resource&&v.resource.href){var U=c(e,v).then(function(e){return h.tintImageWithColor(e,S,v.get("material.color"),o)}).then(function(e){var a=e.width,r=e.height;return m=Math.max(m,a+2*z),f=Math.max(f,r+2*z),[{shape:{type:"image",width:a,height:r,src:e.url},fill:null,stroke:null}]});p.unshift(U)}else{var E=v.get("resource.primitive"),j=E?E:x?"circle":"sphere",I=S;x&&(I=d<n.length-1&&l?S*(k/r):S);var P=a&&"tall"===a.symbolConfig||(w?b(v):!1);m=Math.max(m,P?O:I+2*z),f=Math.max(f,I+2*z),p.unshift(t.resolve(g(v,j,I,P)))}}}),t.eachAlways(p).then(function(e){var r=[];return e.forEach(function(e){e.value?r.push(e.value):e.error&&P.warn("error while building swatchInfo!",e.error)}),h.renderSymbol(r,[m,f],{node:a&&a.node,scale:!1})})}function w(e,a){var r,l=e.symbolLayers,i=[],n=o.isVolumetricSymbol(e),u=a&&a.size?s.pt2px(a.size):null,c=a&&a.maxSize?s.pt2px(a.maxSize):null,m=c||j,v=0,y=0;return l.forEach(function(e,a){var t=e&&e.type,l="line"===t,s="path"===t;if(l||s){var o=d(e,0),n=o&&o.width||0,h=[];if(l){0===a&&(r=n);var c=Math.min(u||n,m),b=0===a?c:u?c*(n/r):c,g=b>C?2*b:I;y=Math.max(y,b),v=Math.max(v,g),o.width=b,h.push({shape:{type:"path",path:[{command:"M",values:[0,.5*y]},{command:"L",values:[v,.5*y]},{command:"E",values:[]}]},stroke:o})}else{var x=Math.min(u||C,m),w=f(e,0),M=f(e,-.2),k=d(e,-.4),S=1;k.width=S,h.push({shape:p.shapes.pathSymbol3DLayer[0],fill:M,stroke:k}),h.push({shape:p.shapes.pathSymbol3DLayer[1],fill:w,stroke:k}),y=Math.max(y,x+2*S),v=y}i.push(h)}}),t.resolve(h.renderSymbol(i,[v,y],{node:a&&a.node,scale:n}))}function M(e,a){var r=e.type,l=r===U,i=e.symbolLayers,o=a&&a.size?s.pt2px(a.size):null,n=a&&a.maxSize?s.pt2px(a.maxSize):null,c=o||C,m=[],v=0,y=0;return i.forEach(function(e){var a=e.type,r="fill"===a,t="line"===a,s="extrude"===e.type,i=[];if(!l||r){var o=p.shapes.fill[0];if(r){var h=u(e),b=h&&h.width||0;v=Math.max(v,C+b),y=Math.max(y,C+b),i.push({shape:o,fill:f(e,0),stroke:h})}else if(t){var g=d(e,0),x=g&&g.width||0,w={stroke:g,shape:o};v=Math.max(v,C+x),y=Math.max(y,C+x),i.push(w)}else if(s){var M=d(e,-.4),k=f(e,0),S=f(e,-.2),L=Math.min(c,n||D),z=p.getExtrudeSymbolShapes(L);M.width=1,i.push({shape:z[0],fill:S,stroke:M}),i.push({shape:z[1],fill:S,stroke:M}),i.push({shape:z[2],fill:k,stroke:M});var U=C,E=.7*C+.5*L;v=Math.max(v,U+2*M.width),y=Math.max(y,E+2*M.width)}m.push(i)}}),t.resolve(h.renderSymbol(m,[v,y],{node:a&&a.node,scale:!1}))}function k(e,a){var r=e;if(0===r.symbolLayers.length)return t.reject(new l("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));var s=null;switch(e.type){case S:s=x(r,a);break;case L:s=w(r,a);break;case z:case U:s=M(r,a)}return s?s:t.reject(new l("symbolPreview: swatchInfo3D","symbol not supported."))}Object.defineProperty(a,"__esModule",{value:!0});var S="point-3d",L="line-3d",z="polygon-3d",U="mesh-3d",E=e.toUrl("../../images/Legend/legend3dsymboldefault.png"),C=22,D=120,j=80,I=40,O=20,P=r.getLogger("esri.symbols.support.previewSymbol3D");a.previewSymbol3D=k});