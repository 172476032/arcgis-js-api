// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","dojo/_base/lang","./Dictionary","./ImmutableArray","./languageUtils","../geometry/Geometry","../geometry/Point","../geometry/support/jsonUtils"],function(t,e,r,i,a,s,n,o,u){return function(){function t(){this._geometry=null,this.attributes=null,this._layer=null,this._datesfixed=!0,this.immutable=!0,this.immutable=!0}return t.createFromGraphic=function(e){var r=new t;return r._geometry=e.geometry,void 0===e.attributes?r.attributes={}:null===e.attributes?r.attributes={}:r.attributes=e.attributes,e._sourceLayer?(r._layer=e._sourceLayer,r._datesfixed=!1):e._layer?(r._layer=e._layer,r._datesfixed=!1):e.sourceLayer?(r._layer=e.sourceLayer,r._datesfixed=!1):e.layer&&(r._layer=e.layer,r._datesfixed=!1),r},t.createFromArcadeFeature=function(e){var r=new t;return r._datesfixed=e._datesfixed,r.attributes=e.attributes,r._geometry=e._geometry,e._layer&&(r._layer=e._layer),r},t.createFromArcadeDictionary=function(e){var r=new t;return r.attributes=e.field("attributes"),null!==r.attributes&&r.attributes instanceof i?(r.attributes=r.attributes.attributes,null===r.attributes&&(r.attributes={})):r.attributes={},r._geometry=e.field("geometry"),null!==r._geometry&&(r._geometry instanceof i?r._geometry=t.parseGeometryFromDictionary(r._geometry):r._geometry instanceof n||(r._geometry=null)),r},t.createFromGraphicLikeObject=function(e,r,i){void 0===i&&(i=null);var a=new t;return null===r&&(r={}),a.attributes=r,a._geometry=e,a._layer=i,a._layer&&(a._datesfixed=!1),a},t.prototype.repurposeFromGraphicLikeObject=function(t,e,r){void 0===r&&(r=null),null===e&&(e={}),this.attributes=e,this._geometry=t,this._layer=r,this._layer?this._datesfixed=!1:this._datesfixed=!0},t.prototype.castToText=function(){var t="";for(var e in this.attributes){""!==t&&(t+=",");var r=this.attributes[e];null==r?t+=JSON.stringify(e)+":null":s.isBoolean(r)||s.isNumber(r)||s.isString(r)?t+=JSON.stringify(e)+":"+JSON.stringify(r):r instanceof n?t+=JSON.stringify(e)+":"+s.toStringExplicit(r):r instanceof a?t+=JSON.stringify(e)+":"+s.toStringExplicit(r):r instanceof Array?t+=JSON.stringify(e)+":"+s.toStringExplicit(r):r instanceof Date?t+=JSON.stringify(e)+":"+JSON.stringify(r):null!==r&&"object"==typeof r&&void 0!==r.castToText&&(t+=JSON.stringify(e)+":"+r.castToText())}return'{"geometry":'+(null===this.geometry()?"null":s.toStringExplicit(this.geometry()))+',"attributes":{'+t+"}}"},t.prototype._fixDates=function(){for(var t=[],e=0;e<this._layer.fields.length;e++){var r=this._layer.fields[e];"date"!==r.type&&"esriFieldTypeDate"!==r.type||t.push(r.name)}t.length>0&&this._fixDateFields(t),this._datesfixed=!0},t.prototype._fixDateFields=function(t){this.attributes=r.mixin({},this.attributes);for(var e=0;e<t.length;e++){var i=this.attributes[t[e]];if(null===i);else if(void 0===i){for(var a in this.attributes)if(a.toLowerCase()===t[e]){i=this.attributes[a],null!==i&&(i instanceof Date||(this.attributes[a]=new Date(i)));break}}else i instanceof Date||(this.attributes[t[e]]=new Date(i))}},t.prototype.geometry=function(){return null===this._geometry?this._geometry:this._geometry instanceof n?this._geometry:(this._geometry=u.fromJson(this._geometry),this._geometry)},t.prototype.field=function(t){!1===this._datesfixed&&this._fixDates();var e=t.toLowerCase(),r=this.attributes[t];if(void 0!==r)return r;for(var i in this.attributes)if(i.toLowerCase()===e)return this.attributes[i];if(this._hasFieldDefinition(e))return null;throw new Error("Field not Found")},t.prototype._hasFieldDefinition=function(t){if(null===this._layer)return!1;for(var e=0;e<this._layer.fields.length;e++){if(this._layer.fields[e].name.toLowerCase()===t)return!0}return!1},t.prototype._field=function(t){!1===this._datesfixed&&this._fixDates();var e=t.toLowerCase(),r=this.attributes[t];if(void 0!==r)return r;for(var i in this.attributes)if(i.toLowerCase()===e)return this.attributes[i];return null},t.prototype.setField=function(t,e){if(this.immutable)throw new Error("Feature is Immutable");if(!1===s.isSimpleType(e))throw new Error("Illegal Value Assignment to Feature");var r=t.toLowerCase();if(void 0!==this.attributes[t])return void(this.attributes[t]=e);for(var i in this.attributes)if(i.toLowerCase()===r)return void(this.attributes[i]=e);this.attributes[t]=e},t.prototype.hasField=function(t){var e=t.toLowerCase();if(void 0!==this.attributes[t])return!0;for(var r in this.attributes)if(r.toLowerCase()===e)return!0;return!!this._hasFieldDefinition(e)},t.prototype.keys=function(){var t=[],e={};for(var r in this.attributes)t.push(r),e[r.toLowerCase()]=1;if(null!==this._layer)for(var i=0;i<this._layer.fields.length;i++){var a=this._layer.fields[i];1!==e[a.name.toLowerCase()]&&t.push(a.name)}return t=t.sort()},t.parseGeometryFromDictionary=function(e){var r=t.convertDictionaryToJson(e,!0);return void 0!==r.spatialreference&&(r.spatialReference=r.spatialreference,delete r.spatialreference),void 0!==r.rings&&(r.rings=this.fixPathArrays(r.rings,!0===r.hasZ,!0===r.hasM)),void 0!==r.paths&&(r.paths=this.fixPathArrays(r.paths,!0===r.hasZ,!0===r.hasM)),void 0!==r.points&&(r.points=this.fixPointArrays(r.points,!0===r.hasZ,!0===r.hasM)),u.fromJSON(r)},t.fixPathArrays=function(t,e,r){var i=[];if(t instanceof Array)for(var s=0;s<t.length;s++)i.push(this.fixPointArrays(t[s],e,r));else if(t instanceof a)for(var s=0;s<t.length();s++)i.push(this.fixPointArrays(t.get(s),e,r));return i},t.fixPointArrays=function(t,e,r){var i=[];if(t instanceof Array)for(var s=0;s<t.length;s++){var n=t[s];n instanceof o?e&&r?i.push([n.x,n.y,n.z,n.m]):e?i.push([n.x,n.y,n.z]):r?i.push([n.x,n.y,n.m]):i.push([n.x,n.y]):i.push(n)}else if(t instanceof a)for(var s=0;s<t.length();s++){var n=t.get(s);n instanceof o?e&&r?i.push([n.x,n.y,n.z,n.m]):e?i.push([n.x,n.y,n.z]):r?i.push([n.x,n.y,n.m]):i.push([n.x,n.y]):i.push(n)}return i},t.convertDictionaryToJson=function(e,r){void 0===r&&(r=!1);var a={};for(var s in e.attributes){var n=e.attributes[s];n instanceof i&&(n=t.convertDictionaryToJson(n)),r?a[s.toLowerCase()]=n:a[s]=n}return a},t.parseAttributesFromDictionary=function(t){var e={};for(var r in t.attributes){var i=t.attributes[r];if(!s.isSimpleType(i))throw new Error("Illegal Argument");e[r]=i}return e},t.fromJson=function(e){var r=null;null!==e.geometry&&void 0!==e.geometry&&(r=u.fromJSON(e.geometry));var i={};if(null!==e.attributes&&void 0!==e.attributes)for(var a in e.attributes){var n=e.attributes[a];if(!(s.isString(n)||s.isNumber(n)||s.isBoolean(n)||s.isDate(n)))throw new Error("Illegal Argument");i[a]=n}return t.createFromGraphicLikeObject(r,i,null)},t.prototype.domainValueLookup=function(t,e,r){if(null===this._layer)return null;if(!this._layer.fields)return null;var i=s.getDomain(t,this._layer,this,r);if(void 0===e)try{e=this.field(t)}catch(t){return null}return s.getDomainValue(i,e)},t.prototype.domainCodeLookup=function(t,e,r){if(null===this._layer)return null;if(!this._layer.fields)return null;var i=s.getDomain(t,this._layer,this,r);return s.getDomainCode(i,e)},t}()});