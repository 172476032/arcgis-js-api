// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","exports","../geometry/Geometry","../geometry/Polygon","../geometry/Polyline","../geometry/Point","../geometry/Extent","../geometry/Multipoint","../SpatialReference","dojo/promise/all","dojo/Deferred","dojo/promise/Promise","./languageUtils","./treeAnalysis","./Dictionary","./Feature","./FunctionWrapper","./functions/date","./functions/maths","./functions/geometry","./ImmutablePathArray","./ImmutablePointArray","./kernel","./functions/string","./functions/stats","./functions/geomasync"],function(e,r,n,t,a,o,c,i,l,s,u,v,f,p,d,h,b,m,g,k,E,w,N,y,I,O){function R(e){var r=new u;return e instanceof Error?r.reject(e):r.reject(new Error(e)),r.promise}function T(e){var r=new u;return r.resolve(e),r.promise}function S(e,r){for(var n=new u,t=[],a=0;a<r.arguments.length;a++)t.push(A(e,r.arguments[a]));return s(t).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)),n.promise}function M(e,r,n){var t=new u;try{return S(e,r).then(N.callback(function(a){t.resolve(n(e,r,a))},t),N.errback(t)),t.promise}catch(a){return R(a)}}function C(e,r,n){var t=new u;try{return S(e,r).then(N.callback(function(a){var o=n(e,r,a);o instanceof v?o.then(N.callback(function(e){t.resolve(e)},t),N.errback(t)):t.resolve(o)},t),N.errback(t)),t.promise}catch(a){return R(a)}}function A(e,r){try{switch(r.type){case"VariableDeclarator":return re(e,r);case"VariableDeclaration":return ee(e,r,0);case"BlockStatement":return X(e,r);case"FunctionDeclaration":return $(e,r);case"ReturnStatement":return Q(e,r);case"IfStatement":return K(e,r);case"ExpressionStatement":return W(e,r);case"UpdateExpression":return z(e,r);case"AssignmentExpression":return Z(e,r);case"ForStatement":return D(e,r);case"ForInStatement":return q(e,r);case"BreakStatement":var n=new u;return n.resolve(f.breakResult),n.promise;case"EmptyStatement":var t=new u;return t.resolve(f.voidOperation),t.promise;case"ContinueStatement":var a=new u;return a.resolve(f.continueResult),a.promise;case"Identifier":return le(e,r);case"MemberExpression":return te(e,r);case"Literal":return T(r.value);case"ThisExpression":return R(p.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));case"CallExpression":return se(e,r);case"UnaryExpression":return ae(e,r);case"BinaryExpression":return ce(e,r);case"LogicalExpression":return ie(e,r);case"ConditionalExpression":return R(p.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));case"ArrayExpression":return oe(e,r);case"ObjectExpression":return F(e,r);case"Property":return U(e,r);case"Array":return R(p.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));default:return R(p.nodeErrorMessage(r,"RUNTIME","UNREOGNISED"))}}catch(o){return R(o)}}function F(e,r){try{for(var n=new u,t=[],a=0;a<r.properties.length;a++)t.push(A(e,r.properties[a]));return s(t).then(N.callback(function(e){for(var r={},t=0;t<e.length;t++){var a=e[t];if(f.isFunctionParameter(a.value))throw new Error("Illegal Argument");if(f.isString(a.key)===!1)throw new Error("Illegal Argument");a.value===f.voidOperation?r[a.key.toString()]=null:r[a.key.toString()]=a.value}var o=new d(r);o.immutable=!1,n.resolve(o)},n),N.errback(n)),n.promise}catch(o){return R(o)}}function U(e,r){var n=new u;try{A(e,r.value).then(N.callback(function(e){n.resolve({key:"Identifier"===r.key.type?r.key.name:r.key.value,value:e})},n),N.errback(n))}catch(t){n.reject(t)}return n.promise}function j(e,r,n){var t=new u;try{A(e,r.body).then(N.callback(function(a){return n.lastAction=a,n.lastAction===f.breakResult?(n.testResult=!1,void t.resolve(n)):n.lastAction instanceof f.ReturnResult?(n.testResult=!1,void t.resolve(n)):void(null!==r.update?A(e,r.update).then(N.callback(function(e){t.resolve(n)},t),N.errback(t)):t.resolve(n))},t),N.errback(t))}catch(a){t.reject(a)}return t.promise}function x(e,r,n){var t=new u;try{return null!==r.test?(A(e,r.test).then(N.callback(function(a){return e.progressTracker.isCanceled()===!0?void t.reject(new Error("Cancelled")):(n.testResult=a,n.testResult===!1?void t.resolve(n):n.testResult!==!0?void t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION"))):void j(e,r,n).then(N.callback(function(e){t.resolve(e)},t),N.errback(t)))},t),N.errback(t)),t.promise):j(e,r,n)}catch(a){t.reject(a)}return t.promise}function P(e,r,n){var t=new u;try{x(e,r,n).then(N.callback(function(){n.testResult===!0?P(e,r,n).then(N.callback(function(e){t.resolve(e)},t),N.errback(t)):n.lastAction instanceof f.ReturnResult?t.resolve(n.lastAction):t.resolve(f.voidOperation)},t),N.errback(t))}catch(a){t.reject(a)}return t.promise}function D(e,r){var n=new u;try{if(null!==r.init)A(e,r.init).then(N.callback(function(){var t={testResult:!0,lastAction:f.voidOperation};P(e,r,t).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))},n),N.errback(n));else{var t={testResult:!0,lastAction:f.voidOperation};P(e,r,t).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))}}catch(a){n.reject(a)}return n.promise}function L(e,r,n,t,a,o,c){var i=new u;try{if(o>=t)return i.resolve(f.voidOperation),i.promise;"k"===c?a.value=n[o]:a.value=o,A(e,r.body).then(N.callback(function(l){l instanceof f.ReturnResult?i.resolve(l):l===f.breakResult?i.resolve(f.voidOperation):L(e,r,n,t,a,o+1,c).then(N.callback(function(e){i.resolve(e)},i),N.errback(i))},i),N.errback(i))}catch(l){i.reject(l)}return i.promise}function _(e,r,n,t,a,o){var c=new u;try{if(n.length()<=a)return c.resolve(f.voidOperation),c.promise;"k"===o?t.value=n.get(a):t.value=a,A(e,r.body).then(N.callback(function(i){i instanceof f.ReturnResult?c.resolve(i):i===f.breakResult?c.resolve(f.voidOperation):_(e,r,n,t,a+1,o).then(N.callback(function(e){c.resolve(e)},c),N.errback(c))},c),N.errback(c))}catch(i){c.reject(i)}return c.promise}function V(e,r,n,t,a,o){try{if(void 0===o&&(o="i"),0===n.length)return void t.resolve(f.voidOperation);L(e,r,n,n.length,a,0,o).then(N.callback(function(e){t.resolve(e)},t),N.errback(t))}catch(c){t.reject(c)}}function B(e,r,n,t,a,o){try{if(void 0===o&&(o="i"),0===n.length)return void t.resolve(f.voidOperation);_(e,r,n,a,0,o).then(N.callback(function(e){t.resolve(e)},t),N.errback(t))}catch(c){t.reject(c)}}function Y(e,r,n,t,a){try{var o=n.keys();V(e,r,o,t,a,"k")}catch(c){t.reject(c)}}function G(e,r,n,t,a){var o=new u;try{e.next().then(N.callback(function(c){if(null===c)o.resolve(f.voidOperation);else{var i=new h(c.attributes,c.geometry,t);i._underlyingGraphic=c,c=i,a.value=c;var l=A(r,n.body);l.then(N.callback(function(c){c===f.breakResult?o.resolve(f.voidOperation):c instanceof f.ReturnResult?o.resolve(c):G(e,r,n,t,a).then(N.callback(function(e){o.resolve(e)},o),N.errback(o))},o),N.errback(o))}},o),N.errback(o))}catch(c){o.reject(c)}return o.promise}function q(e,r){var n=new u;try{A(e,r.right).then(N.callback(function(t){var a=null;"VariableDeclaration"===r.left.type?a=A(e,r.left):(a=new u,a.resolve(),a=a.promise),a.then(N.callback(function(){var a="VariableDeclaration"===r.left.type?r.left.declarations[0].id.name:r.left.name,o=null;return null!==e.localScope&&void 0!==e.localScope[a]&&(o=e.localScope[a]),null===o&&void 0!==e.globalScope[a]&&(o=e.globalScope[a]),null===o?void n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","VARIABLENOTDECLARED"))):void(f.isArray(t)||f.isString(t)?V(e,r,t,n,o):f.isImmutableArray(t)?B(e,r,t,n,o):t instanceof d||t instanceof h?Y(e,r,t,n,o):f.isFeatureCursor(t)?G(t.iterator(e.progressTracker),e,r,t,o).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):V(e,r,[],n,o))},n),N.errback(n))},n),N.errback(n))}catch(t){n.reject(t)}return n.promise}function z(e,r){var n=new u;try{if("MemberExpression"!==r.argument.type){var t=r.argument.name.toLowerCase(),a=void 0;throw null!==e.localScope&&void 0!==e.localScope[t]&&(a=f.toNumber(e.localScope[t].value),e.localScope[t]={value:"++"===r.operator?a+1:a-1,valueset:!0,node:r},r.prefix===!1?n.resolve(a):n.resolve("++"===r.operator?a+1:a-1)),void 0!==e.globalScope[t]&&(a=f.toNumber(e.globalScope[t].value),e.globalScope[t]={value:"++"===r.operator?a+1:a-1,valueset:!0,node:r},r.prefix===!1?n.resolve(a):n.resolve("++"===r.operator?a+1:a-1)),new Error("Variable not recognised")}A(e,r.argument.object).then(N.callback(function(t){var a=null,o=null;r.argument.computed===!0?o=A(e,r.argument.property):(a=new u,a.resolve(r.argument.property.name),o=a.promise),o.then(N.callback(function(e){var a;if(f.isArray(t)){if(!f.isNumber(e))throw new Error("Invalid Parameter");if(0>e&&(e=t.length+e),0>e||e>=t.length)throw new Error("Assignment outside of array bounds");a=f.toNumber(t[e]),t[e]="++"===r.operator?a+1:a-1}else if(t instanceof d){if(f.isString(e)===!1)throw new Error("Dictionary accessor must be a string");if(t.hasField(e)!==!0)throw new Error("Invalid Parameter");a=f.toNumber(t.field(e)),t.setField(e,"++"===r.operator?a+1:a-1)}else{if(!(t instanceof h))throw f.isImmutableArray(t)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(f.isString(e)===!1)throw new Error("Feature accessor must be a string");if(t.hasField(e)!==!0)throw new Error("Invalid Parameter");a=f.toNumber(t.field(e)),t.setField(e,"++"===r.operator?a+1:a-1)}r.prefix===!1?n.resolve(a):n.resolve("++"===r.operator?a+1:a-1)},n),N.errback(n))},n),N.errback(n))}catch(o){n.reject(o)}return n.promise}function H(e,r,n,t){switch(r){case"=":return e===f.voidOperation?null:e;case"/=":return f.toNumber(n)/f.toNumber(e);case"*=":return f.toNumber(n)*f.toNumber(e);case"-=":return f.toNumber(n)-f.toNumber(e);case"+=":return f.isString(n)||f.isString(e)?f.toString(n)+f.toString(e):f.toNumber(n)+f.toNumber(e);case"%=":return f.toNumber(n)%f.toNumber(e);default:throw new Error(p.nodeErrorMessage(t,"RUNTIME","OPERATORNOTRECOGNISED"))}}function Z(e,r){var n=new u;try{if("MemberExpression"===r.left.type)A(e,r.right).then(N.callback(function(t){A(e,r.left.object).then(N.callback(function(a){var o=null,c=null;r.left.computed===!0?c=A(e,r.left.property):(o=new u,o.resolve(r.left.property.name),c=o.promise),c.then(N.callback(function(e){if(f.isArray(a)){if(!f.isNumber(e))throw new Error("Invalid Parameter");if(0>e&&(e=a.length+e),0>e||e>a.length)throw new Error("Assignment outside of array bounds");if(e===a.length){if("="!==r.operator)throw new Error("Invalid Parameter");a[e]=H(t,r.operator,a[e],r)}else a[e]=H(t,r.operator,a[e],r)}else if(a instanceof d){if(f.isString(e)===!1)throw new Error("Dictionary accessor must be a string");if(a.hasField(e)===!0)a.setField(e,H(t,r.operator,a.field(e),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");a.setField(e,H(t,r.operator,null,r))}}else{if(!(a instanceof h))throw f.isImmutableArray(a)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(f.isString(e)===!1)throw new Error("Feature accessor must be a string");if(a.hasField(e)===!0)a.setField(e,H(t,r.operator,a.field(e),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");a.setField(e,H(t,r.operator,null,r))}}n.resolve(f.voidOperation)},n),N.errback(n))},n),N.errback(n))},n),N.errback(n));else{var t=r.left.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[t])return A(e,r.right).then(N.callback(function(a){e.localScope[t]={value:H(a,r.operator,e.localScope[t].value,r),valueset:!0,node:r.right},n.resolve(f.voidOperation)},n),N.errback(n)),n.promise;if(void 0!==e.globalScope[t])return A(e,r.right).then(N.callback(function(a){e.globalScope[t]={value:H(a,r.operator,e.globalScope[t].value,r),valueset:!0,node:r.right},n.resolve(f.voidOperation)},n),N.errback(n)),n.promise;n.reject(new Error("Cannot assign undeclared variable"))}}catch(a){n.reject(a)}return n.promise}function W(e,r){var n=new u;try{"AssignmentExpression"===r.expression.type?A(e,r.expression).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):"CallExpression"===r.expression.type?A(e,r.expression).then(N.callback(function(e){return e===f.voidOperation?void n.resolve(f.voidOperation):void n.resolve(new f.ImplicitResult(e))},n),N.errback(n)):A(e,r.expression).then(N.callback(function(e){return e===f.voidOperation?void n.resolve(f.voidOperation):void n.resolve(new f.ImplicitResult(e))},n),N.errback(n))}catch(t){n.reject(t)}return n.promise}function K(e,r){var n=new u;try{if("AssignmentExpression"===r.test.type||"UpdateExpression"===r.test.type)return n.reject(new Error(p.nodeErrorMessage(r.test,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),n.promise;A(e,r.test).then(N.callback(function(t){t===!0?A(e,r.consequent).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):t===!1?null!==r.alternate?A(e,r.alternate).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):n.resolve(f.voidOperation):n.reject(new Error(p.nodeErrorMessage(r.test,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION")))},n),N.errback(n))}catch(t){n.reject(t)}return n.promise}function X(e,r){var n=new u;try{J(e,r,0).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))}catch(t){n.reject(t)}return n.promise}function J(e,r,n){var t=new u;try{n>=r.body.length?t.resolve(f.voidOperation):A(e,r.body[n]).then(N.callback(function(a){a instanceof f.ReturnResult||a===f.breakResult||a===f.continueResult?t.resolve(a):n===r.body.length-1?t.resolve(a):J(e,r,n+1).then(N.callback(function(e){t.resolve(e)},t),N.errback(t))},t),N.errback(t))}catch(a){t.reject(a)}return t.promise}function Q(e,r){var n=new u;try{null===r.argument?n.resolve(new f.ReturnResult(f.voidOperation)):A(e,r.argument).then(N.callback(function(e){n.resolve(new f.ReturnResult(e))},n),N.errback(n))}catch(t){n.reject(t)}return n.promise}function $(e,r){var n=new u;try{var t=r.id.name.toLowerCase();e.globalScope[t]={valueset:!0,node:null,value:new b(r,e)},n.resolve(f.voidOperation)}catch(a){n.reject(a)}return n.promise}function ee(e,r,n){var t=new u;try{if(n>=r.declarations.length)return t.resolve(f.voidOperation),t.promise;A(e,r.declarations[n]).then(N.callback(function(a){n===r.declarations.length-1?t.resolve(f.voidOperation):ee(e,r,n+1).then(N.callback(function(e){t.resolve(f.voidOperation)},t),N.errback(t))},t),N.errback(t))}catch(a){t.reject(a)}return t.promise}function re(e,r){var n=new u;try{var t=null;null===r.init?(t=new u,t.resolve(null),t=t.promise):t=A(e,r.init),null!==e.localScope?t.then(N.callback(function(t){t===f.voidOperation&&(t=null);var a=r.id.name.toLowerCase();e.localScope[a]={value:t,valueset:!0,node:r.init},n.resolve(f.voidOperation)},n),N.errback(n)):t.then(N.callback(function(t){var a=r.id.name.toLowerCase();t===f.voidOperation&&(t=null),e.globalScope[a]={value:t,valueset:!0,node:r.init},n.resolve(f.voidOperation)},n),N.errback(n))}catch(a){n.reject(a)}return n.promise}function ne(e,r,n,t){var a;switch(r=r.toLowerCase()){case"hasz":var o=e.hasZ;return void 0===o?!1:o;case"hasm":var c=e.hasM;return void 0===c?!1:c;case"spatialreference":var i=e.spatialReference._arcadeCacheId;if(void 0===i){var l=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(l=!1),l&&(Me++,e.spatialReference._arcadeCacheId=Me,i=Me)}var s=new d({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==i&&(s._arcadeCacheId="SPREF"+i.toString()),s}switch(e.type){case"extent":switch(r){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":var u=e[r];return void 0!==u?u:null;case"type":return"Extent"}break;case"polygon":switch(r){case"rings":a=f.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===a&&(Me++,a=Me,f.isVersion4?e.cache._arcadeCacheId=a:e.setCacheValue("_arcadeCacheId",a));var v=new E(e.rings,e.spatialReference,e.hasZ===!0,e.hasM===!0,a);return v;case"type":return"Polygon"}break;case"point":switch(r){case"x":case"y":case"z":case"m":return void 0!==e[r]?e[r]:null;case"type":return"Point"}break;case"polyline":switch(r){case"paths":a=f.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===a&&(Me++,a=Me,f.isVersion4?e.cache._arcadeCacheId=a:e.setCacheValue("_arcadeCacheId",a));var v=new E(e.paths,e.spatialReference,e.hasZ===!0,e.hasM===!0,a);return v;case"type":return"Polyline"}break;case"multipoint":switch(r){case"points":a=f.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===a&&(Me++,a=Me,f.isVersion4?e.cache._arcadeCacheId=a:e.setCacheValue("_arcadeCacheId",a));var v=new w(e.points,e.spatialReference,e.hasZ===!0,e.hasM===!0,a,1);return v;case"type":return"Multipoint"}}throw new Error(p.nodeErrorMessage(t,"RUNTIME","PROPERTYNOTFOUND"))}function te(e,r){try{var t=new u;return A(e,r.object).then(N.callback(function(a){return null===a?void t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","NOTFOUND"))):void(r.computed===!1?a instanceof d||a instanceof h?t.resolve(a.field(r.property.name)):a instanceof n?t.resolve(ne(a,r.property.name,e,r)):t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))):A(e,r.property).then(N.callback(function(o){if(a instanceof d||a instanceof h)f.isString(o)?t.resolve(a.field(o)):t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(a instanceof n)f.isString(o)?t.resolve(ne(a,o,e,r)):t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(f.isArray(a))if(f.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(0>o&&(o=a.length+o),o>=a.length||0>o)throw new Error(p.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(a[o])}else t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(f.isImmutableArray(a))if(f.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(0>o&&(o=a.length()+o),o>=a.length()||0>o)throw new Error(p.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(a.get(o))}else t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(f.isString(a))if(f.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(0>o&&(o=a.length+o),o>=a.length||0>o)throw new Error(p.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(a[o])}else t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")))},t),N.errback(t)))},t),N.errback(t)),t.promise}catch(a){return R(a)}}function ae(e,r){try{var n=new u;return A(e,r.argument).then(N.callback(function(e){f.isBoolean(e)&&"!"===r.operator?n.resolve(!e):"-"===r.operator?n.resolve(-1*f.toNumber(e)):"+"===r.operator?n.resolve(1*f.toNumber(e)):n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR")))},n),N.errback(n)),n.promise}catch(t){return R(t)}}function oe(e,r){try{for(var n=new u,t=[],a=0;a<r.elements.length;a++)t.push(A(e,r.elements[a]));return s(t).then(N.callback(function(e){for(var t=0;t<e.length;t++){if(f.isFunctionParameter(e[t]))return void n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","FUNCTIONCONTEXTILLEGAL")));e[t]===f.voidOperation&&(e[t]=null)}n.resolve(e)},n),N.errback(n)),n.promise}catch(o){return R(o)}}function ce(e,r){try{var n=new u;return s([A(e,r.left),A(e,r.right)]).then(N.callback(function(e){var t=e[0],a=e[1];switch(r.operator){case"==":n.resolve(f.equalityTest(t,a));break;case"=":n.resolve(f.equalityTest(t,a));break;case"!=":n.resolve(!f.equalityTest(t,a));break;case"<":n.resolve(f.greaterThanLessThan(t,a,r.operator));break;case">":n.resolve(f.greaterThanLessThan(t,a,r.operator));break;case"<=":n.resolve(f.greaterThanLessThan(t,a,r.operator));break;case">=":n.resolve(f.greaterThanLessThan(t,a,r.operator));break;case"+":f.isString(t)||f.isString(a)?n.resolve(f.toString(t)+f.toString(a)):n.resolve(f.toNumber(t)+f.toNumber(a));break;case"-":n.resolve(f.toNumber(t)-f.toNumber(a));break;case"*":n.resolve(f.toNumber(t)*f.toNumber(a));break;case"/":n.resolve(f.toNumber(t)/f.toNumber(a));break;case"%":n.resolve(f.toNumber(t)%f.toNumber(a));break;default:n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","OPERATORNOTRECOGNISED")))}},n),N.errback(n)),n.promise}catch(t){return R(t)}}function ie(e,r){try{var n=new u;return"AssignmentExpression"===r.left.type||"UpdateExpression"===r.left.type?(n.reject(new Error(p.nodeErrorMessage(r.left,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),n.promise):"AssignmentExpression"===r.right.type||"UpdateExpression"===r.right.type?(n.reject(new Error(p.nodeErrorMessage(r.right,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),n.promise):(A(e,r.left).then(N.callback(function(t){if(!f.isBoolean(t))throw new Error(p.nodeErrorMessage(r,"RUNTIME","ONLYBOOLEAN"));switch(r.operator){case"||":t===!0?n.resolve(t):A(e,r.right).then(N.callback(function(e){if(!f.isBoolean(e))throw new Error(p.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"));n.resolve(e)},n),N.errback(n));break;case"&&":t===!1?n.resolve(t):A(e,r.right).then(N.callback(function(e){if(!f.isBoolean(e))throw new Error(p.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"));n.resolve(e)},n),N.errback(n));break;default:throw new Error(p.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"))}},n),N.errback(n)),n.promise)}catch(t){return R(t)}}function le(e,r){try{var n=new u,t=r.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[t]){var a=e.localScope[t];return a.valueset===!0?n.resolve(a.value):null!==a.d?a.d.then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):(a.d=A(e,a.node),a.d.then(N.callback(function(e){a.value=e,a.valueset=!0,n.resolve(e)},n),N.errback(n))),n.promise}if(void 0!==e.globalScope[t]){var o=e.globalScope[t];return o.valueset===!0?n.resolve(o.value):null!==o.d?o.d.then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):(o.d=A(e,o.node),o.d.then(N.callback(function(e){o.value=e,o.valueset=!0,n.resolve(e)},n),N.errback(n))),n.promise}return n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","VARIABLENOTFOUND"))),n.promise}catch(c){return R(c)}}function se(e,r){try{if("Identifier"!==r.callee.type)return R(p.nodeErrorMessage(r,"RUNTIME","ONLYNODESSUPPORTED"));if(null!==e.localScope&&void 0!==e.localScope[r.callee.name.toLowerCase()]){var n=e.localScope[r.callee.name.toLowerCase()];return n.value instanceof f.NativeFunction?n.value.fn(e,r):n.value instanceof b?ge(e,r,n.value.definition):R(p.nodeErrorMessage(r,"RUNTIME","NOTAFUNCTION"))}if(void 0!==e.globalScope[r.callee.name.toLowerCase()]){var n=e.globalScope[r.callee.name.toLowerCase()];return n.value instanceof f.NativeFunction?n.value.fn(e,r):n.value instanceof b?ge(e,r,n.value.definition):R(p.nodeErrorMessage(r,"RUNTIME","NOTAFUNCTION"))}return R(p.nodeErrorMessage(r,"RUNTIME","NOTFOUND"))}catch(t){return R(t)}}function ue(e){return null===e?"":f.isArray(e)?"Array":f.isImmutableArray(e)?"Array":f.isDate(e)?"Date":f.isString(e)?"String":f.isBoolean(e)?"Boolean":f.isNumber(e)?"Number":e instanceof d?"Dictionary":e instanceof h?"Feature":e instanceof o?"Point":e instanceof t?"Polygon":e instanceof a?"Polyline":e instanceof i?"Multipoint":e instanceof c?"Extent":f.isFunctionParameter(e)?"Function":e===f.voidOperation?"":"number"==typeof e&&isNaN(e)?"Number":"Unrecognised Type"}function ve(e,r,n,t){try{var a=new u;return A(e,r.arguments[n]).then(N.callback(function(o){if(f.equalityTest(o,t))A(e,r.arguments[n+1]).then(N.callback(function(e){a.resolve(e)},a),N.errback(a));else{var c=r.arguments.length-n;1===c?A(e,r.arguments[n]).then(N.callback(function(e){a.resolve(e)},a),N.errback(a)):2===c&&a.resolve(null),3===c?A(e,r.arguments[n+2]).then(N.callback(function(e){a.resolve(e)},a),N.errback(a)):ve(e,r,n+2,t).then(N.callback(function(e){a.resolve(e)},a),N.errback(a))}},a),N.errback(a)),a.promise}catch(o){return R(o)}}function fe(e,r,n,t){try{var a=new u;if(t===!0)A(e,r.arguments[n+1]).then(N.callback(function(e){a.resolve(e)},a),N.errback(a));else{var o=r.arguments.length-n;3===o?A(e,r.arguments[n+2]).then(N.callback(function(e){a.resolve(e)},a),N.errback(a)):A(e,r.arguments[n+2]).then(N.callback(function(t){return f.isBoolean(t)===!1?void a.reject(new Error("WHEN needs boolean test conditions")):void fe(e,r,n+2,t).then(N.callback(function(e){a.resolve(e)},a),N.errback(a))},a),N.errback(a))}return a.promise}catch(c){return R(c)}}function pe(e,r){var n=new u;try{var t=e.length,a=Math.floor(t/2);if(0===t)return n.resolve([]),n.promise;if(1===t)return n.resolve([e[0]]),n.promise;var o=[pe(e.slice(0,a),r),pe(e.slice(a,t),r)];s(o).then(N.callback(function(e){de(e[0],e[1],r,[]).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))},n),N.errback(n))}catch(c){n.reject(c)}return n.promise}function de(e,r,n,t){var a=new u;try{var o=t;e.length>0||r.length>0?e.length>0&&r.length>0?n(e[0],r[0]).then(N.callback(function(c){isNaN(c)&&(c=1),0>=c?(o.push(e[0]),e=e.slice(1)):(o.push(r[0]),r=r.slice(1)),de(e,r,n,t).then(N.callback(function(e){a.resolve(e)},a),N.errback(a))},a),N.errback(a)):e.length>0?(o.push(e[0]),e=e.slice(1),de(e,r,n,t).then(N.callback(function(e){a.resolve(e)},a),N.errback(a))):r.length>0&&(o.push(r[0]),r=r.slice(1),de(e,r,n,t).then(N.callback(function(e){a.resolve(e)},a),N.errback(a))):a.resolve(t)}catch(c){a.reject(c)}return a.promise}function he(e,r){var n=e.length,t=Math.floor(n/2);return r||(r=function(e,r){return r>e?-1:e===r?0:1}),0===n?[]:1===n?[e[0]]:be(he(e.slice(0,t),r),he(e.slice(t,n),r),r)}function be(e,r,n){for(var t=[];e.length>0||r.length>0;)if(e.length>0&&r.length>0){var a=n(e[0],r[0]);isNaN(a)&&(a=1),0>=a?(t.push(e[0]),e=e.slice(1)):(t.push(r[0]),r=r.slice(1))}else e.length>0?(t.push(e[0]),e=e.slice(1)):r.length>0&&(t.push(r[0]),r=r.slice(1));return t}function me(e,r,n){var t=new u;try{var a=e.body;if(n.length!==e.params.length)return R(new Error("Invalid Parameter calls to function."));for(var o=0;o<n.length;o++)r.localScope[e.params[o].name.toLowerCase()]={d:null,value:n[o],valueset:!0,node:null};A(r,a).then(N.callback(function(e){return e instanceof f.ReturnResult?void t.resolve(e.value):e===f.breakResult?void t.reject(new Error("Cannot Break from a Function")):e===f.continueResult?void t.reject(new Error("Cannot Continue from a Function")):e instanceof f.ImplicitResult?void t.resolve(e.value):void t.resolve(e)},t),N.errback(t))}catch(c){t.reject(c)}return t.promise}function ge(e,r,n){return C(e,r,function(r,t,a){var o={spatialReference:e.spatialReference,services:e.services,console:e.console,localScope:{},progressTracker:e.progressTracker,globalScope:e.globalScope,depthCounter:e.depthCounter+1};if(o.depthCounter>64)throw new Error("Exceeded maximum function depth");return me(n,o,a)})}function ke(e){var r=function(){var r={applicationCache:void 0===e.context.applicationCache?null:e.context.applicationCache,progressTracker:e.context.progressTracker,spatialReference:e.context.spatialReference,console:e.context.console,services:e.context.services,localScope:{},globalScope:e.context.globalScope,depthCounter:e.context.depthCounter+1};if(r.depthCounter>64)throw new Error("Exceeded maximum function depth");return me(e.definition,r,arguments)};return r}function Ee(e,r){var n=new Ue;(void 0===e||null===e)&&(e={}),(void 0===r||null===r)&&(r={});var t=new d({newline:"\n",tab:"	",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});t.immutable=!1,n.textformatting={value:t,valueset:!0,node:null};for(var a in r)n[a]={value:new f.NativeFunction(r[a]),"native":!0,valueset:!0,node:null};for(var a in e)e[a]&&"esri.Graphic"===e[a].declaredClass?n[a]={value:new h(e[a]),valueset:!0,node:null}:n[a]={value:e[a],valueset:!0,node:null};return n}function we(e){console.log(e)}function Ne(e){for(var r={mode:"async",compiled:!1,functions:{},signatures:[],standardFunction:M,standardFunctionAsync:C,failDefferred:R,evaluateIdentifier:le,arcadeCustomFunctionHandler:ke},n=0;n<e.length;n++)e[n].registerFunctions(r);for(var t in r.functions)Ce[t]={value:new f.NativeFunction(r.functions[t]),valueset:!0,node:null},Ue.prototype[t]=Ce[t];for(var n=0;n<r.signatures.length;n++)p.addFunctionDeclaration(r.signatures[n],"f")}function ye(e,r,n){var t=new u;(null===n||void 0===n)&&(n=new l({wkid:102100}));var a=Ee(r.vars,r.customfunctions),o={spatialReference:n,services:r.services,progressTracker:void 0===r.progressTracker||null===r.progressTracker?t.promise:r.progressTracker,globalScope:a,console:r.console?r.console:we,localScope:null,depthCounter:1};return A(o,e.body[0].body).then(N.callback(function(e){return e instanceof f.ReturnResult&&(e=e.value),e instanceof f.ImplicitResult&&(e=e.value),e===f.voidOperation&&(e=null),e===f.breakResult?void t.reject(new Error("Cannot return BREAK")):e===f.continueResult?void t.reject(new Error("Cannot return CONTINUE")):e instanceof f.NativeFunction?void t.reject(new Error("Cannot return FUNCTION")):e instanceof b?void t.reject(new Error("Cannot return FUNCTION")):void t.resolve(e)},t),N.errback(t)),t.promise}function Ie(e,r){return void 0===r&&(r=!1),p.findFieldLiterals(e,r)}function Oe(e,r){return p.validateScript(e,r,"full")}function Re(e,r){return p.referencesMember(e,r)}function Te(e,r){return p.referencesFunction(e,r)}function Se(e){return p.findFunctionCalls(e,!1)}Object.defineProperty(r,"__esModule",{value:!0});var Me=0,Ce={};m.registerFunctions(Ce,M),y.registerFunctions(Ce,M),g.registerFunctions(Ce,M),k.registerFunctions(Ce,M),I.registerFunctions(Ce,M),O.registerFunctions(Ce,M,C),Ce["typeof"]=function(e,r){return M(e,r,function(e,r,n){f.pcCheck(n,1,1);var t=ue(n[0]);if("Unrecognised Type"===t)throw new Error("Unrecognised Type");return t})},Ce.iif=function(e,r){try{var n=new u;return f.pcCheck(null===r.arguments?[]:r.arguments,3,3),A(e,r.arguments[0]).then(N.callback(function(t){return f.isBoolean(t)===!1?void n.reject(new Error("IF Function must have a boolean test condition")):void(t===!0?A(e,r.arguments[1]).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):A(e,r.arguments[2]).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)))},n),N.errback(n)),n.promise}catch(t){return R(t)}},Ce.decode=function(e,r){try{var n=new u;if(r.arguments.length<2)return R("Missing Parameters");if(2===r.arguments.length)A(e,r.arguments[1]).then(N.callback(function(e){n.resolve(e)},n),N.errback(n));else{if((r.arguments.length-1)%2===0)return R("Must have a default value result.");A(e,r.arguments[0]).then(N.callback(function(t){var a=1;ve(e,r,a,t).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))},n),N.errback(n))}return n.promise}catch(t){return R(t)}},Ce.when=function(e,r){try{var n=new u;return r.arguments.length<3?R("Missing Parameters"):r.arguments.length%2===0?R("Must have a default value result."):(A(e,r.arguments[0]).then(N.callback(function(t){if(f.isBoolean(t)===!1)return void n.reject(new Error("WHEN needs boolean test conditions"));var a=0;fe(e,r,a,t).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))},n),N.errback(n)),n.promise)}catch(t){return R(t)}},Ce.sort=function(e,r){return C(e,r,function(e,r,n){var t=new u;f.pcCheck(n,1,2);var a=n[0];if(f.isImmutableArray(a)&&(a=a.toArray()),f.isArray(a)===!1)return R(Error("Illegal Argument"));if(n.length>1){if(f.isFunctionParameter(n[1])===!1)return R(Error("Illegal Argument"));var o=a,c=ke(n[1]);return pe(o,c).then(N.callback(function(e){t.resolve(e)},t),N.errback(t)),t.promise}var o=a;if(0===o.length)return t.resolve([]),t.promise;for(var i={},l=0;l<o.length;l++){var s=ue(o[l]);""!==s&&(i[s]=!0)}if(i.Array===!0||i.Dictionary===!0||i.Feature===!0||i.Point===!0||i.Polygon===!0||i.Polyline===!0||i.Multipoint===!0||i.Extent===!0||i.Function===!0)return t.resolve(o.slice(0)),t.promise;var v=0,p="";for(var d in i)v++,p=d;return v>1||"String"===p?o=he(o,function(e,r){if(null===e||void 0===e||e===f.voidOperation)return null===r||void 0===r||r===f.voidOperation?0:1;if(null===r||void 0===r||r===f.voidOperation)return-1;var n=f.toString(e),t=f.toString(r);return t>n?-1:n===t?0:1}):"Number"===p?o=he(o,function(e,r){return e-r}):"Boolean"===p?o=he(o,function(e,r){return e===r?0:r?-1:1}):"Date"===p&&(o=he(o,function(e,r){return r-e})),t.resolve(o),t.promise})};var Ae={failDefferred:R,resolveDeffered:T,fixSpatialReference:f.fixSpatialReference,parseArguments:S,standardFunction:M,standardFunctionAsync:C,evaluateIdentifier:le,arcadeCustomFunction:ke};for(var Fe in Ce)Ce[Fe]={value:new f.NativeFunction(Ce[Fe]),valueset:!0,node:null};var Ue=function(){};Ue.prototype=Ce,Ue.prototype.infinity={value:Number.POSITIVE_INFINITY,valueset:!0,node:null},Ue.prototype.pi={value:Math.PI,valueset:!0,node:null},r.functionHelper=Ae,r.extend=Ne,r.executeScript=ye,
r.extractFieldLiterals=Ie,r.validateScript=Oe,r.referencesMember=Re,r.referencesFunction=Te,r.findFunctionCalls=Se});