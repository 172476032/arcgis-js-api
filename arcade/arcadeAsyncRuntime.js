// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","exports","../geometry/Geometry","../geometry/Polygon","../geometry/Polyline","../geometry/Point","../geometry/Extent","../geometry/Multipoint","../SpatialReference","dojo/promise/all","dojo/Deferred","dojo/promise/Promise","./languageUtils","./treeAnalysis","./Dictionary","./Feature","./FunctionWrapper","./functions/date","./functions/maths","./functions/geometry","./ImmutablePathArray","./ImmutablePointArray","./kernel","./functions/string","./functions/stats","./functions/geomasync"],function(e,r,n,t,o,a,c,i,l,s,u,f,v,p,d,h,m,b,g,E,k,w,N,y,I,O){function R(e){var r=new u;return e instanceof Error?r.reject(e):r.reject(new Error(e)),r.promise}function T(e){var r=new u;return r.resolve(e),r.promise}function S(e,r){for(var n=new u,t=[],o=0;o<r.arguments.length;o++)t.push(A(e,r.arguments[o]));return s(t).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)),n.promise}function M(e,r,n){var t=new u;try{return S(e,r).then(N.callback(function(o){t.resolve(n(e,r,o))},t),N.errback(t)),t.promise}catch(e){return R(e)}}function C(e,r,n){var t=new u;try{return S(e,r).then(N.callback(function(o){var a=n(e,r,o);a instanceof f?a.then(N.callback(function(e){t.resolve(e)},t),N.errback(t)):t.resolve(a)},t),N.errback(t)),t.promise}catch(e){return R(e)}}function A(e,r){try{switch(r.type){case"VariableDeclarator":return re(e,r);case"VariableDeclaration":return ee(e,r,0);case"BlockStatement":return X(e,r);case"FunctionDeclaration":return $(e,r);case"ReturnStatement":return Q(e,r);case"IfStatement":return K(e,r);case"ExpressionStatement":return W(e,r);case"UpdateExpression":return z(e,r);case"AssignmentExpression":return Z(e,r);case"ForStatement":return D(e,r);case"ForInStatement":return q(e,r);case"BreakStatement":var n=new u;return n.resolve(v.breakResult),n.promise;case"EmptyStatement":var t=new u;return t.resolve(v.voidOperation),t.promise;case"ContinueStatement":var o=new u;return o.resolve(v.continueResult),o.promise;case"Identifier":return le(e,r);case"MemberExpression":return te(e,r);case"Literal":return T(r.value);case"ThisExpression":return R(p.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));case"CallExpression":return se(e,r);case"UnaryExpression":return oe(e,r);case"BinaryExpression":return ce(e,r);case"LogicalExpression":return ie(e,r);case"ConditionalExpression":return R(p.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));case"ArrayExpression":return ae(e,r);case"ObjectExpression":return F(e,r);case"Property":return U(e,r);case"Array":return R(p.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));default:return R(p.nodeErrorMessage(r,"RUNTIME","UNREOGNISED"))}}catch(e){return R(e)}}function F(e,r){try{for(var n=new u,t=[],o=0;o<r.properties.length;o++)t.push(A(e,r.properties[o]));return s(t).then(N.callback(function(e){for(var r={},t=0;t<e.length;t++){var o=e[t];if(v.isFunctionParameter(o.value))throw new Error("Illegal Argument");if(!1===v.isString(o.key))throw new Error("Illegal Argument");o.value===v.voidOperation?r[o.key.toString()]=null:r[o.key.toString()]=o.value}var a=new d(r);a.immutable=!1,n.resolve(a)},n),N.errback(n)),n.promise}catch(e){return R(e)}}function U(e,r){var n=new u;try{A(e,r.value).then(N.callback(function(e){n.resolve({key:"Identifier"===r.key.type?r.key.name:r.key.value,value:e})},n),N.errback(n))}catch(e){n.reject(e)}return n.promise}function j(e,r,n){var t=new u;try{A(e,r.body).then(N.callback(function(o){return n.lastAction=o,n.lastAction===v.breakResult?(n.testResult=!1,void t.resolve(n)):n.lastAction instanceof v.ReturnResult?(n.testResult=!1,void t.resolve(n)):void(null!==r.update?A(e,r.update).then(N.callback(function(e){t.resolve(n)},t),N.errback(t)):t.resolve(n))},t),N.errback(t))}catch(e){t.reject(e)}return t.promise}function x(e,r,n){var t=new u;try{return null!==r.test?(A(e,r.test).then(N.callback(function(o){return!0===e.progressTracker.isCanceled()?void t.reject(new Error("Cancelled")):(n.testResult=o,!1===n.testResult?void t.resolve(n):!0!==n.testResult?void t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION"))):void j(e,r,n).then(N.callback(function(e){t.resolve(e)},t),N.errback(t)))},t),N.errback(t)),t.promise):j(e,r,n)}catch(e){t.reject(e)}return t.promise}function P(e,r,n,t,o,a){try{x(e,r,n).then(function(){try{!0===n.testResult?(a++,a>Me?(a=0,setTimeout(function(){P(e,r,n,function(e){t(e)},function(e){o(e)},a)})):P(e,r,n,function(e){t(e)},function(e){o(e)},a)):t(n.lastAction instanceof v.ReturnResult?n.lastAction:v.voidOperation)}catch(e){o(e)}},function(e){o(e)})}catch(e){o(e)}}function D(e,r){var n=new u;try{if(null!==r.init)A(e,r.init).then(N.callback(function(){var t={testResult:!0,lastAction:v.voidOperation};P(e,r,t,function(e){n.resolve(e)},function(e){n.reject(e)},0)},n),N.errback(n));else{var t={testResult:!0,lastAction:v.voidOperation};P(e,r,t,function(e){n.resolve(e)},function(e){n.reject(e)},0)}}catch(e){n.reject(e)}return n.promise}function _(e,r,n,t,o,a,c,i,l,s){try{if(t<=a)return void i(v.voidOperation);o.value="k"===c?n[a]:a,A(e,r.body).then(function(u){try{u instanceof v.ReturnResult?i(u):u===v.breakResult?i(v.voidOperation):(s++,s>Me?(s=0,setTimeout(function(){_(e,r,n,t,o,a+1,c,function(e){i(e)},function(e){l(e)},s)})):_(e,r,n,t,o,a+1,c,function(e){i(e)},function(e){l(e)},s))}catch(e){l(e)}},function(e){l(e)})}catch(e){l(e)}}function L(e,r,n,t,o,a,c,i,l){try{if(n.length()<=o)return void c(v.voidOperation);t.value="k"===a?n.get(o):o,A(e,r.body).then(function(s){s instanceof v.ReturnResult?c(s):s===v.breakResult?c(v.voidOperation):(l++,l>Me?(l=0,setTimeout(function(){L(e,r,n,t,o+1,a,function(e){c(e)},function(e){i(e)},l)})):L(e,r,n,t,o+1,a,function(e){c(e)},function(e){i(e)},l))},function(e){i(e)})}catch(e){i(e)}}function V(e,r,n,t,o,a){try{if(void 0===a&&(a="i"),0===n.length)return void t.resolve(v.voidOperation);_(e,r,n,n.length,o,0,a,function(e){t.resolve(e)},function(e){t.reject(e)},0)}catch(e){t.reject(e)}}function B(e,r,n,t,o,a){try{if(void 0===a&&(a="i"),0===n.length)return void t.resolve(v.voidOperation);L(e,r,n,o,0,a,function(e){t.resolve(e)},function(e){t.reject(e)},0)}catch(e){t.reject(e)}}function Y(e,r,n,t,o){try{V(e,r,n.keys(),t,o,"k")}catch(e){t.reject(e)}}function G(e,r,n,t,o,a,c,i){try{e.next().then(function(l){try{if(null===l)a(v.voidOperation);else{var s=new h(l.attributes,l.geometry,t);s._underlyingGraphic=l,o.value=s;A(r,n.body).then(function(l){try{l===v.breakResult?a(v.voidOperation):l instanceof v.ReturnResult?a(l):(i++,i>Me?(i=0,setTimeout(function(){G(e,r,n,t,o,function(e){a(e)},function(e){c(e)},i)})):G(e,r,n,t,o,function(e){a(e)},function(e){c(e)},i))}catch(e){c(e)}},function(e){c(e)})}}catch(e){c(e)}},function(e){c(e)})}catch(e){c(e)}}function q(e,r){var n=new u;try{A(e,r.right).then(N.callback(function(t){var o=null;"VariableDeclaration"===r.left.type?o=A(e,r.left):(o=new u,o.resolve(),o=o.promise),o.then(N.callback(function(){var o="VariableDeclaration"===r.left.type?r.left.declarations[0].id.name:r.left.name,a=null;if(null!==e.localScope&&void 0!==e.localScope[o]&&(a=e.localScope[o]),null===a&&void 0!==e.globalScope[o]&&(a=e.globalScope[o]),null===a)return void n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","VARIABLENOTDECLARED")));v.isArray(t)||v.isString(t)?V(e,r,t,n,a):v.isImmutableArray(t)?B(e,r,t,n,a):t instanceof d||t instanceof h?Y(e,r,t,n,a):v.isFeatureCursor(t)?G(t.iterator(e.progressTracker),e,r,t,a,function(e){n.resolve(e)},function(e){n.reject(e)},0):V(e,r,[],n,a)},n),N.errback(n))},n),N.errback(n))}catch(e){n.reject(e)}return n.promise}function z(e,r){var n=new u;try{if("MemberExpression"!==r.argument.type){var t=r.argument.name.toLowerCase(),o=void 0;if(null!==e.localScope&&void 0!==e.localScope[t])return o=v.toNumber(e.localScope[t].value),e.localScope[t]={value:"++"===r.operator?o+1:o-1,valueset:!0,node:r},!1===r.prefix?n.resolve(o):n.resolve("++"===r.operator?o+1:o-1),n.promise;throw void 0!==e.globalScope[t]&&(o=v.toNumber(e.globalScope[t].value),e.globalScope[t]={value:"++"===r.operator?o+1:o-1,valueset:!0,node:r},!1===r.prefix?n.resolve(o):n.resolve("++"===r.operator?o+1:o-1)),new Error("Variable not recognised")}A(e,r.argument.object).then(N.callback(function(t){var o=null,a=null;!0===r.argument.computed?a=A(e,r.argument.property):(o=new u,o.resolve(r.argument.property.name),a=o.promise),a.then(N.callback(function(e){var o;if(v.isArray(t)){if(!v.isNumber(e))throw new Error("Invalid Parameter");if(e<0&&(e=t.length+e),e<0||e>=t.length)throw new Error("Assignment outside of array bounds");o=v.toNumber(t[e]),t[e]="++"===r.operator?o+1:o-1}else if(t instanceof d){if(!1===v.isString(e))throw new Error("Dictionary accessor must be a string");if(!0!==t.hasField(e))throw new Error("Invalid Parameter");o=v.toNumber(t.field(e)),t.setField(e,"++"===r.operator?o+1:o-1)}else{if(!(t instanceof h))throw v.isImmutableArray(t)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===v.isString(e))throw new Error("Feature accessor must be a string");if(!0!==t.hasField(e))throw new Error("Invalid Parameter");o=v.toNumber(t.field(e)),t.setField(e,"++"===r.operator?o+1:o-1)}!1===r.prefix?n.resolve(o):n.resolve("++"===r.operator?o+1:o-1)},n),N.errback(n))},n),N.errback(n))}catch(e){n.reject(e)}return n.promise}function H(e,r,n,t){switch(r){case"=":return e===v.voidOperation?null:e;case"/=":return v.toNumber(n)/v.toNumber(e);case"*=":return v.toNumber(n)*v.toNumber(e);case"-=":return v.toNumber(n)-v.toNumber(e);case"+=":return v.isString(n)||v.isString(e)?v.toString(n)+v.toString(e):v.toNumber(n)+v.toNumber(e);case"%=":return v.toNumber(n)%v.toNumber(e);default:throw new Error(p.nodeErrorMessage(t,"RUNTIME","OPERATORNOTRECOGNISED"))}}function Z(e,r){var n=new u;try{if("MemberExpression"===r.left.type)A(e,r.right).then(N.callback(function(t){A(e,r.left.object).then(N.callback(function(o){var a=null,c=null;!0===r.left.computed?c=A(e,r.left.property):(a=new u,a.resolve(r.left.property.name),c=a.promise),c.then(N.callback(function(e){if(v.isArray(o)){if(!v.isNumber(e))throw new Error("Invalid Parameter");if(e<0&&(e=o.length+e),e<0||e>o.length)throw new Error("Assignment outside of array bounds");if(e===o.length){if("="!==r.operator)throw new Error("Invalid Parameter");o[e]=H(t,r.operator,o[e],r)}else o[e]=H(t,r.operator,o[e],r)}else if(o instanceof d){if(!1===v.isString(e))throw new Error("Dictionary accessor must be a string");if(!0===o.hasField(e))o.setField(e,H(t,r.operator,o.field(e),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");o.setField(e,H(t,r.operator,null,r))}}else{if(!(o instanceof h))throw v.isImmutableArray(o)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(!1===v.isString(e))throw new Error("Feature accessor must be a string");if(!0===o.hasField(e))o.setField(e,H(t,r.operator,o.field(e),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");o.setField(e,H(t,r.operator,null,r))}}n.resolve(v.voidOperation)},n),N.errback(n))},n),N.errback(n))},n),N.errback(n));else{var t=r.left.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[t])return A(e,r.right).then(N.callback(function(o){e.localScope[t]={value:H(o,r.operator,e.localScope[t].value,r),valueset:!0,node:r.right},n.resolve(v.voidOperation)},n),N.errback(n)),n.promise;if(void 0!==e.globalScope[t])return A(e,r.right).then(N.callback(function(o){e.globalScope[t]={value:H(o,r.operator,e.globalScope[t].value,r),valueset:!0,node:r.right},n.resolve(v.voidOperation)},n),N.errback(n)),n.promise;n.reject(new Error("Cannot assign undeclared variable"))}}catch(e){n.reject(e)}return n.promise}function W(e,r){var n=new u;try{"AssignmentExpression"===r.expression.type?A(e,r.expression).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):(r.expression.type,A(e,r.expression).then(N.callback(function(e){if(e===v.voidOperation)return void n.resolve(v.voidOperation);n.resolve(new v.ImplicitResult(e))},n),N.errback(n)))}catch(e){n.reject(e)}return n.promise}function K(e,r){var n=new u;try{if("AssignmentExpression"===r.test.type||"UpdateExpression"===r.test.type)return n.reject(new Error(p.nodeErrorMessage(r.test,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),n.promise;A(e,r.test).then(N.callback(function(t){!0===t?A(e,r.consequent).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):!1===t?null!==r.alternate?A(e,r.alternate).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):n.resolve(v.voidOperation):n.reject(new Error(p.nodeErrorMessage(r.test,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION")))},n),N.errback(n))}catch(e){n.reject(e)}return n.promise}function X(e,r){var n=new u;try{J(e,r,0).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))}catch(e){n.reject(e)}return n.promise}function J(e,r,n){var t=new u;try{n>=r.body.length?t.resolve(v.voidOperation):A(e,r.body[n]).then(N.callback(function(o){o instanceof v.ReturnResult||o===v.breakResult||o===v.continueResult?t.resolve(o):n===r.body.length-1?t.resolve(o):J(e,r,n+1).then(N.callback(function(e){t.resolve(e)},t),N.errback(t))},t),N.errback(t))}catch(e){t.reject(e)}return t.promise}function Q(e,r){var n=new u;try{null===r.argument?n.resolve(new v.ReturnResult(v.voidOperation)):A(e,r.argument).then(N.callback(function(e){n.resolve(new v.ReturnResult(e))},n),N.errback(n))}catch(e){n.reject(e)}return n.promise}function $(e,r){var n=new u;try{var t=r.id.name.toLowerCase();e.globalScope[t]={valueset:!0,node:null,value:new m(r,e)},n.resolve(v.voidOperation)}catch(e){n.reject(e)}return n.promise}function ee(e,r,n){var t=new u;try{if(n>=r.declarations.length)return t.resolve(v.voidOperation),t.promise;A(e,r.declarations[n]).then(N.callback(function(o){n===r.declarations.length-1?t.resolve(v.voidOperation):ee(e,r,n+1).then(N.callback(function(e){t.resolve(v.voidOperation)},t),N.errback(t))},t),N.errback(t))}catch(e){t.reject(e)}return t.promise}function re(e,r){var n=new u;try{var t=null;null===r.init?(t=new u,t.resolve(null),t=t.promise):t=A(e,r.init),null!==e.localScope?t.then(N.callback(function(t){t===v.voidOperation&&(t=null);var o=r.id.name.toLowerCase();e.localScope[o]={value:t,valueset:!0,node:r.init},n.resolve(v.voidOperation)},n),N.errback(n)):t.then(N.callback(function(t){var o=r.id.name.toLowerCase();t===v.voidOperation&&(t=null),e.globalScope[o]={value:t,valueset:!0,node:r.init},n.resolve(v.voidOperation)},n),N.errback(n))}catch(e){n.reject(e)}return n.promise}function ne(e,r,n,t){var o;switch(r=r.toLowerCase()){case"hasz":var a=e.hasZ;return void 0!==a&&a;case"hasm":var c=e.hasM;return void 0!==c&&c;case"spatialreference":var i=e.spatialReference._arcadeCacheId;if(void 0===i){var l=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(l=!1),l&&(Ce++,e.spatialReference._arcadeCacheId=Ce,i=Ce)}var s=new d({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==i&&(s._arcadeCacheId="SPREF"+i.toString()),s}switch(e.type){case"extent":switch(r){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":var u=e[r];return void 0!==u?u:null;case"type":return"Extent"}break;case"polygon":switch(r){case"rings":o=v.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===o&&(Ce++,o=Ce,v.isVersion4?e.cache._arcadeCacheId=o:e.setCacheValue("_arcadeCacheId",o));var f=new k(e.rings,e.spatialReference,!0===e.hasZ,!0===e.hasM,o);return f;case"type":return"Polygon"}break;case"point":switch(r){case"x":case"y":case"z":case"m":return void 0!==e[r]?e[r]:null;case"type":return"Point"}break;case"polyline":switch(r){case"paths":o=v.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===o&&(Ce++,o=Ce,v.isVersion4?e.cache._arcadeCacheId=o:e.setCacheValue("_arcadeCacheId",o));var f=new k(e.paths,e.spatialReference,!0===e.hasZ,!0===e.hasM,o);return f;case"type":return"Polyline"}break;case"multipoint":switch(r){case"points":o=v.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===o&&(Ce++,o=Ce,v.isVersion4?e.cache._arcadeCacheId=o:e.setCacheValue("_arcadeCacheId",o));var f=new w(e.points,e.spatialReference,!0===e.hasZ,!0===e.hasM,o,1);return f;case"type":return"Multipoint"}}throw new Error(p.nodeErrorMessage(t,"RUNTIME","PROPERTYNOTFOUND"))}function te(e,r){try{var t=new u;return A(e,r.object).then(N.callback(function(o){if(null===o)return void t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","NOTFOUND")));!1===r.computed?o instanceof d||o instanceof h?t.resolve(o.field(r.property.name)):o instanceof n?t.resolve(ne(o,r.property.name,e,r)):t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))):A(e,r.property).then(N.callback(function(a){if(o instanceof d||o instanceof h)v.isString(a)?t.resolve(o.field(a)):t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(o instanceof n)v.isString(a)?t.resolve(ne(o,a,e,r)):t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(v.isArray(o))if(v.isNumber(a)&&isFinite(a)&&Math.floor(a)===a){if(a<0&&(a=o.length+a),a>=o.length||a<0)throw new Error(p.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(o[a])}else t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(v.isImmutableArray(o))if(v.isNumber(a)&&isFinite(a)&&Math.floor(a)===a){if(a<0&&(a=o.length()+a),a>=o.length()||a<0)throw new Error(p.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(o.get(a))}else t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(v.isString(o))if(v.isNumber(a)&&isFinite(a)&&Math.floor(a)===a){if(a<0&&(a=o.length+a),a>=o.length||a<0)throw new Error(p.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(o[a])}else t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")))},t),N.errback(t))},t),N.errback(t)),t.promise}catch(e){return R(e)}}function oe(e,r){try{var n=new u;return A(e,r.argument).then(N.callback(function(e){v.isBoolean(e)&&"!"===r.operator?n.resolve(!e):"-"===r.operator?n.resolve(-1*v.toNumber(e)):"+"===r.operator?n.resolve(1*v.toNumber(e)):n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR")))},n),N.errback(n)),n.promise}catch(e){return R(e)}}function ae(e,r){try{for(var n=new u,t=[],o=0;o<r.elements.length;o++)t.push(A(e,r.elements[o]));return s(t).then(N.callback(function(e){for(var t=0;t<e.length;t++){if(v.isFunctionParameter(e[t]))return void n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","FUNCTIONCONTEXTILLEGAL")));e[t]===v.voidOperation&&(e[t]=null)}n.resolve(e)},n),N.errback(n)),n.promise}catch(e){return R(e)}}function ce(e,r){try{var n=new u;return s([A(e,r.left),A(e,r.right)]).then(N.callback(function(e){var t=e[0],o=e[1];switch(r.operator){case"==":case"=":n.resolve(v.equalityTest(t,o));break;case"!=":n.resolve(!v.equalityTest(t,o));break;case"<":case">":case"<=":case">=":n.resolve(v.greaterThanLessThan(t,o,r.operator));break;case"+":v.isString(t)||v.isString(o)?n.resolve(v.toString(t)+v.toString(o)):n.resolve(v.toNumber(t)+v.toNumber(o));break;case"-":n.resolve(v.toNumber(t)-v.toNumber(o));break;case"*":n.resolve(v.toNumber(t)*v.toNumber(o));break;case"/":n.resolve(v.toNumber(t)/v.toNumber(o));break;case"%":n.resolve(v.toNumber(t)%v.toNumber(o));break;default:n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","OPERATORNOTRECOGNISED")))}},n),N.errback(n)),n.promise}catch(e){return R(e)}}function ie(e,r){try{var n=new u;return"AssignmentExpression"===r.left.type||"UpdateExpression"===r.left.type?(n.reject(new Error(p.nodeErrorMessage(r.left,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),n.promise):"AssignmentExpression"===r.right.type||"UpdateExpression"===r.right.type?(n.reject(new Error(p.nodeErrorMessage(r.right,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),n.promise):(A(e,r.left).then(N.callback(function(t){if(!v.isBoolean(t))throw new Error(p.nodeErrorMessage(r,"RUNTIME","ONLYBOOLEAN"));switch(r.operator){case"||":!0===t?n.resolve(t):A(e,r.right).then(N.callback(function(e){if(!v.isBoolean(e))throw new Error(p.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"));n.resolve(e)},n),N.errback(n));break;case"&&":!1===t?n.resolve(t):A(e,r.right).then(N.callback(function(e){if(!v.isBoolean(e))throw new Error(p.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"));n.resolve(e)},n),N.errback(n));break;default:throw new Error(p.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"))}},n),N.errback(n)),n.promise)}catch(e){return R(e)}}function le(e,r){try{var n=new u,t=r.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[t]){var o=e.localScope[t];return!0===o.valueset?n.resolve(o.value):null!==o.d?o.d.then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):(o.d=A(e,o.node),o.d.then(N.callback(function(e){o.value=e,o.valueset=!0,n.resolve(e)},n),N.errback(n))),n.promise}if(void 0!==e.globalScope[t]){var a=e.globalScope[t];return!0===a.valueset?n.resolve(a.value):null!==a.d?a.d.then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):(a.d=A(e,a.node),a.d.then(N.callback(function(e){a.value=e,a.valueset=!0,n.resolve(e)},n),N.errback(n))),n.promise}return n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","VARIABLENOTFOUND"))),n.promise}catch(e){return R(e)}}function se(e,r){try{if("Identifier"!==r.callee.type)return R(p.nodeErrorMessage(r,"RUNTIME","ONLYNODESSUPPORTED"));if(null!==e.localScope&&void 0!==e.localScope[r.callee.name.toLowerCase()]){var n=e.localScope[r.callee.name.toLowerCase()];return n.value instanceof v.NativeFunction?n.value.fn(e,r):n.value instanceof m?ge(e,r,n.value.definition):R(p.nodeErrorMessage(r,"RUNTIME","NOTAFUNCTION"))}if(void 0!==e.globalScope[r.callee.name.toLowerCase()]){var n=e.globalScope[r.callee.name.toLowerCase()];return n.value instanceof v.NativeFunction?n.value.fn(e,r):n.value instanceof m?ge(e,r,n.value.definition):R(p.nodeErrorMessage(r,"RUNTIME","NOTAFUNCTION"))}return R(p.nodeErrorMessage(r,"RUNTIME","NOTFOUND"))}catch(e){return R(e)}}function ue(e){return null===e?"":v.isArray(e)?"Array":v.isImmutableArray(e)?"Array":v.isDate(e)?"Date":v.isString(e)?"String":v.isBoolean(e)?"Boolean":v.isNumber(e)?"Number":e instanceof d?"Dictionary":e instanceof h?"Feature":e instanceof a?"Point":e instanceof t?"Polygon":e instanceof o?"Polyline":e instanceof i?"Multipoint":e instanceof c?"Extent":v.isFunctionParameter(e)?"Function":e===v.voidOperation?"":"number"==typeof e&&isNaN(e)?"Number":"Unrecognised Type"}function fe(e,r,n,t){try{var o=new u;return A(e,r.arguments[n]).then(N.callback(function(a){if(v.equalityTest(a,t))A(e,r.arguments[n+1]).then(N.callback(function(e){o.resolve(e)},o),N.errback(o));else{var c=r.arguments.length-n;1===c?A(e,r.arguments[n]).then(N.callback(function(e){o.resolve(e)},o),N.errback(o)):2===c&&o.resolve(null),3===c?A(e,r.arguments[n+2]).then(N.callback(function(e){o.resolve(e)},o),N.errback(o)):fe(e,r,n+2,t).then(N.callback(function(e){o.resolve(e)},o),N.errback(o))}},o),N.errback(o)),o.promise}catch(e){return R(e)}}function ve(e,r,n,t){try{var o=new u;if(!0===t)A(e,r.arguments[n+1]).then(N.callback(function(e){o.resolve(e)},o),N.errback(o));else{3===r.arguments.length-n?A(e,r.arguments[n+2]).then(N.callback(function(e){o.resolve(e)},o),N.errback(o)):A(e,r.arguments[n+2]).then(N.callback(function(t){if(!1===v.isBoolean(t))return void o.reject(new Error("WHEN needs boolean test conditions"));ve(e,r,n+2,t).then(N.callback(function(e){o.resolve(e)},o),N.errback(o))},o),N.errback(o))}return o.promise}catch(e){return R(e)}}function pe(e,r){var n=new u;try{var t=e.length,o=Math.floor(t/2);if(0===t)return n.resolve([]),n.promise;if(1===t)return n.resolve([e[0]]),n.promise;var a=[pe(e.slice(0,o),r),pe(e.slice(o,t),r)];s(a).then(N.callback(function(e){de(e[0],e[1],r,[]).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))},n),N.errback(n))}catch(e){n.reject(e)}return n.promise}function de(e,r,n,t){var o=new u;try{var a=t;e.length>0||r.length>0?e.length>0&&r.length>0?n(e[0],r[0]).then(N.callback(function(c){isNaN(c)&&(c=1),c<=0?(a.push(e[0]),e=e.slice(1)):(a.push(r[0]),r=r.slice(1)),de(e,r,n,t).then(N.callback(function(e){o.resolve(e)},o),N.errback(o))},o),N.errback(o)):e.length>0?(a.push(e[0]),e=e.slice(1),de(e,r,n,t).then(N.callback(function(e){o.resolve(e)},o),N.errback(o))):r.length>0&&(a.push(r[0]),r=r.slice(1),de(e,r,n,t).then(N.callback(function(e){o.resolve(e)},o),N.errback(o))):o.resolve(t)}catch(e){o.reject(e)}return o.promise}function he(e,r){var n=e.length,t=Math.floor(n/2);return r||(r=function(e,r){return e<r?-1:e===r?0:1}),0===n?[]:1===n?[e[0]]:me(he(e.slice(0,t),r),he(e.slice(t,n),r),r)}function me(e,r,n){for(var t=[];e.length>0||r.length>0;)if(e.length>0&&r.length>0){var o=n(e[0],r[0]);isNaN(o)&&(o=1),o<=0?(t.push(e[0]),e=e.slice(1)):(t.push(r[0]),r=r.slice(1))}else e.length>0?(t.push(e[0]),e=e.slice(1)):r.length>0&&(t.push(r[0]),r=r.slice(1));return t}function be(e,r,n){var t=new u;try{var o=e.body;if(n.length!==e.params.length)return R(new Error("Invalid Parameter calls to function."));for(var a=0;a<n.length;a++)r.localScope[e.params[a].name.toLowerCase()]={d:null,value:n[a],valueset:!0,node:null};A(r,o).then(N.callback(function(e){return e instanceof v.ReturnResult?void t.resolve(e.value):e===v.breakResult?void t.reject(new Error("Cannot Break from a Function")):e===v.continueResult?void t.reject(new Error("Cannot Continue from a Function")):e instanceof v.ImplicitResult?void t.resolve(e.value):void t.resolve(e)},t),N.errback(t))}catch(e){t.reject(e)}return t.promise}function ge(e,r,n){return C(e,r,function(r,t,o){var a={spatialReference:e.spatialReference,services:e.services,console:e.console,localScope:{},progressTracker:e.progressTracker,globalScope:e.globalScope,depthCounter:e.depthCounter+1};if(a.depthCounter>64)throw new Error("Exceeded maximum function depth");return be(n,a,o)})}function Ee(e){return function(){var r={applicationCache:void 0===e.context.applicationCache?null:e.context.applicationCache,progressTracker:e.context.progressTracker,spatialReference:e.context.spatialReference,console:e.context.console,services:e.context.services,localScope:{},globalScope:e.context.globalScope,depthCounter:e.context.depthCounter+1};if(r.depthCounter>64)throw new Error("Exceeded maximum function depth");return be(e.definition,r,arguments)}}function ke(e,r){var n=new je;void 0!==e&&null!==e||(e={}),void 0!==r&&null!==r||(r={});var t=new d({newline:"\n",tab:"\t",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});t.immutable=!1,n.textformatting={value:t,valueset:!0,node:null};for(var o in r)n[o]={value:new v.NativeFunction(r[o]),native:!0,valueset:!0,node:null};for(var o in e)e[o]&&"esri.Graphic"===e[o].declaredClass?n[o]={value:new h(e[o]),valueset:!0,node:null}:n[o]={value:e[o],valueset:!0,node:null};return n}function we(e){console.log(e)}function Ne(e){for(var r={mode:"async",compiled:!1,functions:{},signatures:[],standardFunction:M,standardFunctionAsync:C,failDefferred:R,evaluateIdentifier:le,arcadeCustomFunctionHandler:Ee},n=0;n<e.length;n++)e[n].registerFunctions(r);for(var t in r.functions)Ae[t]={value:new v.NativeFunction(r.functions[t]),valueset:!0,node:null},je.prototype[t]=Ae[t];for(var n=0;n<r.signatures.length;n++)p.addFunctionDeclaration(r.signatures[n],"f")}function ye(e,r,n){var t=new u;null!==n&&void 0!==n||(n=new l({wkid:102100}));var o=ke(r.vars,r.customfunctions);return A({spatialReference:n,services:r.services,progressTracker:void 0===r.progressTracker||null===r.progressTracker?t.promise:r.progressTracker,globalScope:o,console:r.console?r.console:we,localScope:null,depthCounter:1},e.body[0].body).then(N.callback(function(e){return e instanceof v.ReturnResult&&(e=e.value),e instanceof v.ImplicitResult&&(e=e.value),e===v.voidOperation&&(e=null),e===v.breakResult?void t.reject(new Error("Cannot return BREAK")):e===v.continueResult?void t.reject(new Error("Cannot return CONTINUE")):e instanceof v.NativeFunction?void t.reject(new Error("Cannot return FUNCTION")):e instanceof m?void t.reject(new Error("Cannot return FUNCTION")):void t.resolve(e)},t),N.errback(t)),t.promise}function Ie(e,r){return void 0===r&&(r=!1),p.findFieldLiterals(e,r)}function Oe(e,r){return p.validateScript(e,r,"full")}function Re(e,r){return p.referencesMember(e,r)}function Te(e,r){return p.referencesFunction(e,r)}function Se(e){return p.findFunctionCalls(e,!1)}Object.defineProperty(r,"__esModule",{value:!0});var Me=100,Ce=0,Ae={};b.registerFunctions(Ae,M),y.registerFunctions(Ae,M),g.registerFunctions(Ae,M),E.registerFunctions(Ae,M),I.registerFunctions(Ae,M),O.registerFunctions(Ae,M,C),Ae.typeof=function(e,r){return M(e,r,function(e,r,n){v.pcCheck(n,1,1);var t=ue(n[0]);if("Unrecognised Type"===t)throw new Error("Unrecognised Type");return t})},Ae.iif=function(e,r){try{var n=new u;return v.pcCheck(null===r.arguments?[]:r.arguments,3,3),A(e,r.arguments[0]).then(N.callback(function(t){if(!1===v.isBoolean(t))return void n.reject(new Error("IF Function must have a boolean test condition"));!0===t?A(e,r.arguments[1]).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):A(e,r.arguments[2]).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))},n),N.errback(n)),n.promise}catch(e){return R(e)}},Ae.decode=function(e,r){try{var n=new u;if(r.arguments.length<2)return R("Missing Parameters");if(2===r.arguments.length)A(e,r.arguments[1]).then(N.callback(function(e){n.resolve(e)},n),N.errback(n));else{if((r.arguments.length-1)%2==0)return R("Must have a default value result.");A(e,r.arguments[0]).then(N.callback(function(t){fe(e,r,1,t).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))},n),N.errback(n))}return n.promise}catch(e){return R(e)}},Ae.when=function(e,r){try{var n=new u;return r.arguments.length<3?R("Missing Parameters"):r.arguments.length%2==0?R("Must have a default value result."):(A(e,r.arguments[0]).then(N.callback(function(t){if(!1===v.isBoolean(t))return void n.reject(new Error("WHEN needs boolean test conditions"));ve(e,r,0,t).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))},n),N.errback(n)),n.promise)}catch(e){return R(e)}},Ae.sort=function(e,r){return C(e,r,function(e,r,n){var t=new u;v.pcCheck(n,1,2);var o=n[0];if(v.isImmutableArray(o)&&(o=o.toArray()),!1===v.isArray(o))return R(Error("Illegal Argument"));if(n.length>1){if(!1===v.isFunctionParameter(n[1]))return R(Error("Illegal Argument"));var a=o;return pe(a,Ee(n[1])).then(N.callback(function(e){t.resolve(e)},t),N.errback(t)),t.promise}var a=o;if(0===a.length)return t.resolve([]),t.promise;for(var c={},i=0;i<a.length;i++){var l=ue(a[i]);""!==l&&(c[l]=!0)}if(!0===c.Array||!0===c.Dictionary||!0===c.Feature||!0===c.Point||!0===c.Polygon||!0===c.Polyline||!0===c.Multipoint||!0===c.Extent||!0===c.Function)return t.resolve(a.slice(0)),t.promise;var s=0,f="";for(var p in c)s++,f=p;return s>1||"String"===f?a=he(a,function(e,r){if(null===e||void 0===e||e===v.voidOperation)return null===r||void 0===r||r===v.voidOperation?0:1;if(null===r||void 0===r||r===v.voidOperation)return-1;var n=v.toString(e),t=v.toString(r);return n<t?-1:n===t?0:1}):"Number"===f?a=he(a,function(e,r){return e-r}):"Boolean"===f?a=he(a,function(e,r){return e===r?0:r?-1:1}):"Date"===f&&(a=he(a,function(e,r){return r-e})),t.resolve(a),t.promise})};var Fe={failDefferred:R,resolveDeffered:T,fixSpatialReference:v.fixSpatialReference,parseArguments:S,standardFunction:M,standardFunctionAsync:C,evaluateIdentifier:le,arcadeCustomFunction:Ee};for(var Ue in Ae)Ae[Ue]={value:new v.NativeFunction(Ae[Ue]),valueset:!0,node:null};var je=function(){};je.prototype=Ae,je.prototype.infinity={value:Number.POSITIVE_INFINITY,valueset:!0,node:null},je.prototype.pi={value:Math.PI,valueset:!0,node:null},r.functionHelper=Fe,r.extend=Ne,r.executeScript=ye,r.extractFieldLiterals=Ie,r.validateScript=Oe,r.referencesMember=Re,r.referencesFunction=Te,r.findFunctionCalls=Se});