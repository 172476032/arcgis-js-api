// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../geometry/Geometry","../geometry/Polygon","../geometry/Polyline","../geometry/Point","../geometry/Extent","../geometry/Multipoint","../geometry/SpatialReference","dojo/promise/all","dojo/Deferred","dojo/promise/Promise","./languageUtils","./treeAnalysis","./Dictionary","./Feature","./FunctionWrapper","./functions/date","./functions/maths","./functions/geometry","./ImmutablePathArray","./ImmutablePointArray","./kernel","./functions/string","./functions/stats","./functions/geomasync"],function(e,r,n,t,o,a,c,i,s,l,u,v,f,p,d,h,b,m,g,E,k,w,N,y,I,O){function R(e){var r=new u;return e instanceof Error?r.reject(e):r.reject(new Error(e)),r.promise}function T(e){var r=new u;return r.resolve(e),r.promise}function S(e,r){for(var n=new u,t=[],o=0;o<r.arguments.length;o++)t.push(A(e,r.arguments[o]));return l(t).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)),n.promise}function M(e,r,n){var t=new u;try{return S(e,r).then(N.callback(function(o){t.resolve(n(e,r,o))},t),N.errback(t)),t.promise}catch(o){return R(o)}}function C(e,r,n){var t=new u;try{return S(e,r).then(N.callback(function(o){var a=n(e,r,o);a instanceof v?a.then(N.callback(function(e){t.resolve(e)},t),N.errback(t)):t.resolve(a)},t),N.errback(t)),t.promise}catch(o){return R(o)}}function A(e,r){try{switch(r.type){case"VariableDeclarator":return re(e,r);case"VariableDeclaration":return ee(e,r,0);case"BlockStatement":return X(e,r);case"FunctionDeclaration":return $(e,r);case"ReturnStatement":return Q(e,r);case"IfStatement":return K(e,r);case"ExpressionStatement":return W(e,r);case"UpdateExpression":return z(e,r);case"AssignmentExpression":return Z(e,r);case"ForStatement":return D(e,r);case"ForInStatement":return q(e,r);case"BreakStatement":var n=new u;return n.resolve(f.breakResult),n.promise;case"EmptyStatement":var t=new u;return t.resolve(f.voidOperation),t.promise;case"ContinueStatement":var o=new u;return o.resolve(f.continueResult),o.promise;case"Identifier":return se(e,r);case"MemberExpression":return te(e,r);case"Literal":return T(r.value);case"ThisExpression":return R(p.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));case"CallExpression":return le(e,r);case"UnaryExpression":return oe(e,r);case"BinaryExpression":return ce(e,r);case"LogicalExpression":return ie(e,r);case"ConditionalExpression":return R(p.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));case"ArrayExpression":return ae(e,r);case"ObjectExpression":return F(e,r);case"Property":return U(e,r);case"Array":return R(p.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));default:return R(p.nodeErrorMessage(r,"RUNTIME","UNREOGNISED"))}}catch(a){return R(a)}}function F(e,r){try{for(var n=new u,t=[],o=0;o<r.properties.length;o++)t.push(A(e,r.properties[o]));return l(t).then(N.callback(function(e){for(var r={},t=0;t<e.length;t++){var o=e[t];if(f.isFunctionParameter(o.value))throw new Error("Illegal Argument");if(f.isString(o.key)===!1)throw new Error("Illegal Argument");o.value===f.voidOperation?r[o.key.toString()]=null:r[o.key.toString()]=o.value}var a=new d(r);a.immutable=!1,n.resolve(a)},n),N.errback(n)),n.promise}catch(a){return R(a)}}function U(e,r){var n=new u;try{A(e,r.value).then(N.callback(function(e){n.resolve({key:"Identifier"===r.key.type?r.key.name:r.key.value,value:e})},n),N.errback(n))}catch(t){n.reject(t)}return n.promise}function j(e,r,n){var t=new u;try{A(e,r.body).then(N.callback(function(o){return n.lastAction=o,n.lastAction===f.breakResult?(n.testResult=!1,void t.resolve(n)):n.lastAction instanceof f.ReturnResult?(n.testResult=!1,void t.resolve(n)):void(null!==r.update?A(e,r.update).then(N.callback(function(e){t.resolve(n)},t),N.errback(t)):t.resolve(n))},t),N.errback(t))}catch(o){t.reject(o)}return t.promise}function x(e,r,n){var t=new u;try{return null!==r.test?(A(e,r.test).then(N.callback(function(o){return e.progressTracker.isCanceled()===!0?void t.reject(new Error("Cancelled")):(n.testResult=o,n.testResult===!1?void t.resolve(n):n.testResult!==!0?void t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION"))):void j(e,r,n).then(N.callback(function(e){t.resolve(e)},t),N.errback(t)))},t),N.errback(t)),t.promise):j(e,r,n)}catch(o){t.reject(o)}return t.promise}function P(e,r,n,t,o,a){try{x(e,r,n).then(function(){try{n.testResult===!0?(a++,a>Me?(a=0,setTimeout(function(){P(e,r,n,function(e){t(e)},function(e){o(e)},a)})):P(e,r,n,function(e){t(e)},function(e){o(e)},a)):t(n.lastAction instanceof f.ReturnResult?n.lastAction:f.voidOperation)}catch(c){o(c)}},function(e){o(e)})}catch(c){o(c)}}function D(e,r){var n=new u;try{if(null!==r.init)A(e,r.init).then(N.callback(function(){var t={testResult:!0,lastAction:f.voidOperation};P(e,r,t,function(e){n.resolve(e)},function(e){n.reject(e)},0)},n),N.errback(n));else{var t={testResult:!0,lastAction:f.voidOperation};P(e,r,t,function(e){n.resolve(e)},function(e){n.reject(e)},0)}}catch(o){n.reject(o)}return n.promise}function L(e,r,n,t,o,a,c,i,s,l){try{if(a>=t)return void i(f.voidOperation);"k"===c?o.value=n[a]:o.value=a,A(e,r.body).then(function(u){try{u instanceof f.ReturnResult?i(u):u===f.breakResult?i(f.voidOperation):(l++,l>Me?(l=0,setTimeout(function(){L(e,r,n,t,o,a+1,c,function(e){i(e)},function(e){s(e)},l)})):L(e,r,n,t,o,a+1,c,function(e){i(e)},function(e){s(e)},l))}catch(v){s(v)}},function(e){s(e)})}catch(u){s(u)}}function _(e,r,n,t,o,a,c,i,s){try{if(n.length()<=o)return void c(f.voidOperation);"k"===a?t.value=n.get(o):t.value=o,A(e,r.body).then(function(l){l instanceof f.ReturnResult?c(l):l===f.breakResult?c(f.voidOperation):(s++,s>Me?(s=0,setTimeout(function(){_(e,r,n,t,o+1,a,function(e){c(e)},function(e){i(e)},s)})):_(e,r,n,t,o+1,a,function(e){c(e)},function(e){i(e)},s))},function(e){i(e)})}catch(l){i(l)}}function V(e,r,n,t,o,a){try{if(void 0===a&&(a="i"),0===n.length)return void t.resolve(f.voidOperation);L(e,r,n,n.length,o,0,a,function(e){t.resolve(e)},function(e){t.reject(e)},0)}catch(c){t.reject(c)}}function B(e,r,n,t,o,a){try{if(void 0===a&&(a="i"),0===n.length)return void t.resolve(f.voidOperation);_(e,r,n,o,0,a,function(e){t.resolve(e)},function(e){t.reject(e)},0)}catch(c){t.reject(c)}}function Y(e,r,n,t,o){try{var a=n.keys();V(e,r,a,t,o,"k")}catch(c){t.reject(c)}}function G(e,r,n,t,o,a,c,i){try{e.next().then(function(s){try{if(null===s)a(f.voidOperation);else{var l=new h(s.attributes,s.geometry,t);l._underlyingGraphic=s,o.value=l;var u=A(r,n.body);u.then(function(s){try{s===f.breakResult?a(f.voidOperation):s instanceof f.ReturnResult?a(s):(i++,i>Me?(i=0,setTimeout(function(){G(e,r,n,t,o,function(e){a(e)},function(e){c(e)},i)})):G(e,r,n,t,o,function(e){a(e)},function(e){c(e)},i))}catch(l){c(l)}},function(e){c(e)})}}catch(v){c(v)}},function(e){c(e)})}catch(s){c(s)}}function q(e,r){var n=new u;try{A(e,r.right).then(N.callback(function(t){var o=null;"VariableDeclaration"===r.left.type?o=A(e,r.left):(o=new u,o.resolve(),o=o.promise),o.then(N.callback(function(){var o="VariableDeclaration"===r.left.type?r.left.declarations[0].id.name:r.left.name,a=null;return null!==e.localScope&&void 0!==e.localScope[o]&&(a=e.localScope[o]),null===a&&void 0!==e.globalScope[o]&&(a=e.globalScope[o]),null===a?void n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","VARIABLENOTDECLARED"))):void(f.isArray(t)||f.isString(t)?V(e,r,t,n,a):f.isImmutableArray(t)?B(e,r,t,n,a):t instanceof d||t instanceof h?Y(e,r,t,n,a):f.isFeatureCursor(t)?G(t.iterator(e.progressTracker),e,r,t,a,function(e){n.resolve(e)},function(e){n.reject(e)},0):V(e,r,[],n,a))},n),N.errback(n))},n),N.errback(n))}catch(t){n.reject(t)}return n.promise}function z(e,r){var n=new u;try{if("MemberExpression"!==r.argument.type){var t=r.argument.name.toLowerCase(),o=void 0;if(null!==e.localScope&&void 0!==e.localScope[t])return o=f.toNumber(e.localScope[t].value),e.localScope[t]={value:"++"===r.operator?o+1:o-1,valueset:!0,node:r},r.prefix===!1?n.resolve(o):n.resolve("++"===r.operator?o+1:o-1),n.promise;throw void 0!==e.globalScope[t]&&(o=f.toNumber(e.globalScope[t].value),e.globalScope[t]={value:"++"===r.operator?o+1:o-1,valueset:!0,node:r},r.prefix===!1?n.resolve(o):n.resolve("++"===r.operator?o+1:o-1)),new Error("Variable not recognised")}A(e,r.argument.object).then(N.callback(function(t){var o=null,a=null;r.argument.computed===!0?a=A(e,r.argument.property):(o=new u,o.resolve(r.argument.property.name),a=o.promise),a.then(N.callback(function(e){var o;if(f.isArray(t)){if(!f.isNumber(e))throw new Error("Invalid Parameter");if(0>e&&(e=t.length+e),0>e||e>=t.length)throw new Error("Assignment outside of array bounds");o=f.toNumber(t[e]),t[e]="++"===r.operator?o+1:o-1}else if(t instanceof d){if(f.isString(e)===!1)throw new Error("Dictionary accessor must be a string");if(t.hasField(e)!==!0)throw new Error("Invalid Parameter");o=f.toNumber(t.field(e)),t.setField(e,"++"===r.operator?o+1:o-1)}else{if(!(t instanceof h))throw f.isImmutableArray(t)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(f.isString(e)===!1)throw new Error("Feature accessor must be a string");if(t.hasField(e)!==!0)throw new Error("Invalid Parameter");o=f.toNumber(t.field(e)),t.setField(e,"++"===r.operator?o+1:o-1)}r.prefix===!1?n.resolve(o):n.resolve("++"===r.operator?o+1:o-1)},n),N.errback(n))},n),N.errback(n))}catch(a){n.reject(a)}return n.promise}function H(e,r,n,t){switch(r){case"=":return e===f.voidOperation?null:e;case"/=":return f.toNumber(n)/f.toNumber(e);case"*=":return f.toNumber(n)*f.toNumber(e);case"-=":return f.toNumber(n)-f.toNumber(e);case"+=":return f.isString(n)||f.isString(e)?f.toString(n)+f.toString(e):f.toNumber(n)+f.toNumber(e);case"%=":return f.toNumber(n)%f.toNumber(e);default:throw new Error(p.nodeErrorMessage(t,"RUNTIME","OPERATORNOTRECOGNISED"))}}function Z(e,r){var n=new u;try{if("MemberExpression"===r.left.type)A(e,r.right).then(N.callback(function(t){A(e,r.left.object).then(N.callback(function(o){var a=null,c=null;r.left.computed===!0?c=A(e,r.left.property):(a=new u,a.resolve(r.left.property.name),c=a.promise),c.then(N.callback(function(e){if(f.isArray(o)){if(!f.isNumber(e))throw new Error("Invalid Parameter");if(0>e&&(e=o.length+e),0>e||e>o.length)throw new Error("Assignment outside of array bounds");if(e===o.length){if("="!==r.operator)throw new Error("Invalid Parameter");o[e]=H(t,r.operator,o[e],r)}else o[e]=H(t,r.operator,o[e],r)}else if(o instanceof d){if(f.isString(e)===!1)throw new Error("Dictionary accessor must be a string");if(o.hasField(e)===!0)o.setField(e,H(t,r.operator,o.field(e),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");o.setField(e,H(t,r.operator,null,r))}}else{if(!(o instanceof h))throw f.isImmutableArray(o)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(f.isString(e)===!1)throw new Error("Feature accessor must be a string");if(o.hasField(e)===!0)o.setField(e,H(t,r.operator,o.field(e),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");o.setField(e,H(t,r.operator,null,r))}}n.resolve(f.voidOperation)},n),N.errback(n))},n),N.errback(n))},n),N.errback(n));else{var t=r.left.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[t])return A(e,r.right).then(N.callback(function(o){e.localScope[t]={value:H(o,r.operator,e.localScope[t].value,r),valueset:!0,node:r.right},n.resolve(f.voidOperation)},n),N.errback(n)),n.promise;if(void 0!==e.globalScope[t])return A(e,r.right).then(N.callback(function(o){e.globalScope[t]={value:H(o,r.operator,e.globalScope[t].value,r),valueset:!0,node:r.right},n.resolve(f.voidOperation)},n),N.errback(n)),n.promise;n.reject(new Error("Cannot assign undeclared variable"))}}catch(o){n.reject(o)}return n.promise}function W(e,r){var n=new u;try{"AssignmentExpression"===r.expression.type?A(e,r.expression).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):"CallExpression"===r.expression.type?A(e,r.expression).then(N.callback(function(e){return e===f.voidOperation?void n.resolve(f.voidOperation):void n.resolve(new f.ImplicitResult(e))},n),N.errback(n)):A(e,r.expression).then(N.callback(function(e){return e===f.voidOperation?void n.resolve(f.voidOperation):void n.resolve(new f.ImplicitResult(e))},n),N.errback(n))}catch(t){n.reject(t)}return n.promise}function K(e,r){var n=new u;try{if("AssignmentExpression"===r.test.type||"UpdateExpression"===r.test.type)return n.reject(new Error(p.nodeErrorMessage(r.test,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),n.promise;A(e,r.test).then(N.callback(function(t){t===!0?A(e,r.consequent).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):t===!1?null!==r.alternate?A(e,r.alternate).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):n.resolve(f.voidOperation):n.reject(new Error(p.nodeErrorMessage(r.test,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION")))},n),N.errback(n))}catch(t){n.reject(t)}return n.promise}function X(e,r){var n=new u;try{J(e,r,0).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))}catch(t){n.reject(t)}return n.promise}function J(e,r,n){var t=new u;try{n>=r.body.length?t.resolve(f.voidOperation):A(e,r.body[n]).then(N.callback(function(o){o instanceof f.ReturnResult||o===f.breakResult||o===f.continueResult?t.resolve(o):n===r.body.length-1?t.resolve(o):J(e,r,n+1).then(N.callback(function(e){t.resolve(e)},t),N.errback(t))},t),N.errback(t))}catch(o){t.reject(o)}return t.promise}function Q(e,r){var n=new u;try{null===r.argument?n.resolve(new f.ReturnResult(f.voidOperation)):A(e,r.argument).then(N.callback(function(e){n.resolve(new f.ReturnResult(e))},n),N.errback(n))}catch(t){n.reject(t)}return n.promise}function $(e,r){var n=new u;try{var t=r.id.name.toLowerCase();e.globalScope[t]={valueset:!0,node:null,value:new b(r,e)},n.resolve(f.voidOperation)}catch(o){n.reject(o)}return n.promise}function ee(e,r,n){var t=new u;try{if(n>=r.declarations.length)return t.resolve(f.voidOperation),t.promise;A(e,r.declarations[n]).then(N.callback(function(o){n===r.declarations.length-1?t.resolve(f.voidOperation):ee(e,r,n+1).then(N.callback(function(e){t.resolve(f.voidOperation)},t),N.errback(t))},t),N.errback(t))}catch(o){t.reject(o)}return t.promise}function re(e,r){var n=new u;try{var t=null;null===r.init?(t=new u,t.resolve(null),t=t.promise):t=A(e,r.init),null!==e.localScope?t.then(N.callback(function(t){t===f.voidOperation&&(t=null);var o=r.id.name.toLowerCase();e.localScope[o]={value:t,valueset:!0,node:r.init},n.resolve(f.voidOperation)},n),N.errback(n)):t.then(N.callback(function(t){var o=r.id.name.toLowerCase();t===f.voidOperation&&(t=null),e.globalScope[o]={value:t,valueset:!0,node:r.init},n.resolve(f.voidOperation)},n),N.errback(n))}catch(o){n.reject(o)}return n.promise}function ne(e,r,n,t){var o;switch(r=r.toLowerCase()){case"hasz":var a=e.hasZ;return void 0===a?!1:a;case"hasm":var c=e.hasM;return void 0===c?!1:c;case"spatialreference":var i=e.spatialReference._arcadeCacheId;if(void 0===i){var s=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(s=!1),s&&(Ce++,e.spatialReference._arcadeCacheId=Ce,i=Ce)}var l=new d({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==i&&(l._arcadeCacheId="SPREF"+i.toString()),l}switch(e.type){case"extent":switch(r){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":var u=e[r];return void 0!==u?u:null;case"type":return"Extent"}break;case"polygon":switch(r){case"rings":o=f.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===o&&(Ce++,o=Ce,f.isVersion4?e.cache._arcadeCacheId=o:e.setCacheValue("_arcadeCacheId",o));var v=new k(e.rings,e.spatialReference,e.hasZ===!0,e.hasM===!0,o);return v;case"type":return"Polygon"}break;case"point":switch(r){case"x":case"y":case"z":case"m":return void 0!==e[r]?e[r]:null;case"type":return"Point"}break;case"polyline":switch(r){case"paths":o=f.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===o&&(Ce++,o=Ce,f.isVersion4?e.cache._arcadeCacheId=o:e.setCacheValue("_arcadeCacheId",o));var v=new k(e.paths,e.spatialReference,e.hasZ===!0,e.hasM===!0,o);return v;case"type":return"Polyline"}break;case"multipoint":switch(r){case"points":o=f.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===o&&(Ce++,o=Ce,f.isVersion4?e.cache._arcadeCacheId=o:e.setCacheValue("_arcadeCacheId",o));var v=new w(e.points,e.spatialReference,e.hasZ===!0,e.hasM===!0,o,1);return v;case"type":return"Multipoint"}}throw new Error(p.nodeErrorMessage(t,"RUNTIME","PROPERTYNOTFOUND"))}function te(e,r){try{var t=new u;return A(e,r.object).then(N.callback(function(o){return null===o?void t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","NOTFOUND"))):void(r.computed===!1?o instanceof d||o instanceof h?t.resolve(o.field(r.property.name)):o instanceof n?t.resolve(ne(o,r.property.name,e,r)):t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))):A(e,r.property).then(N.callback(function(a){if(o instanceof d||o instanceof h)f.isString(a)?t.resolve(o.field(a)):t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(o instanceof n)f.isString(a)?t.resolve(ne(o,a,e,r)):t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(f.isArray(o))if(f.isNumber(a)&&isFinite(a)&&Math.floor(a)===a){if(0>a&&(a=o.length+a),a>=o.length||0>a)throw new Error(p.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(o[a])}else t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(f.isImmutableArray(o))if(f.isNumber(a)&&isFinite(a)&&Math.floor(a)===a){if(0>a&&(a=o.length()+a),a>=o.length()||0>a)throw new Error(p.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(o.get(a))}else t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(f.isString(o))if(f.isNumber(a)&&isFinite(a)&&Math.floor(a)===a){if(0>a&&(a=o.length+a),a>=o.length||0>a)throw new Error(p.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(o[a])}else t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else t.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")))},t),N.errback(t)))},t),N.errback(t)),t.promise}catch(o){return R(o)}}function oe(e,r){try{var n=new u;return A(e,r.argument).then(N.callback(function(e){f.isBoolean(e)&&"!"===r.operator?n.resolve(!e):"-"===r.operator?n.resolve(-1*f.toNumber(e)):"+"===r.operator?n.resolve(1*f.toNumber(e)):n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR")))},n),N.errback(n)),n.promise}catch(t){return R(t)}}function ae(e,r){try{for(var n=new u,t=[],o=0;o<r.elements.length;o++)t.push(A(e,r.elements[o]));return l(t).then(N.callback(function(e){for(var t=0;t<e.length;t++){if(f.isFunctionParameter(e[t]))return void n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","FUNCTIONCONTEXTILLEGAL")));e[t]===f.voidOperation&&(e[t]=null)}n.resolve(e)},n),N.errback(n)),n.promise}catch(a){return R(a)}}function ce(e,r){try{var n=new u;return l([A(e,r.left),A(e,r.right)]).then(N.callback(function(e){var t=e[0],o=e[1];switch(r.operator){case"==":n.resolve(f.equalityTest(t,o));break;case"=":n.resolve(f.equalityTest(t,o));break;case"!=":n.resolve(!f.equalityTest(t,o));break;case"<":n.resolve(f.greaterThanLessThan(t,o,r.operator));break;case">":n.resolve(f.greaterThanLessThan(t,o,r.operator));break;case"<=":n.resolve(f.greaterThanLessThan(t,o,r.operator));break;case">=":n.resolve(f.greaterThanLessThan(t,o,r.operator));break;case"+":f.isString(t)||f.isString(o)?n.resolve(f.toString(t)+f.toString(o)):n.resolve(f.toNumber(t)+f.toNumber(o));break;case"-":n.resolve(f.toNumber(t)-f.toNumber(o));break;case"*":n.resolve(f.toNumber(t)*f.toNumber(o));break;case"/":n.resolve(f.toNumber(t)/f.toNumber(o));break;case"%":n.resolve(f.toNumber(t)%f.toNumber(o));break;default:n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","OPERATORNOTRECOGNISED")))}},n),N.errback(n)),n.promise}catch(t){return R(t)}}function ie(e,r){try{var n=new u;return"AssignmentExpression"===r.left.type||"UpdateExpression"===r.left.type?(n.reject(new Error(p.nodeErrorMessage(r.left,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),n.promise):"AssignmentExpression"===r.right.type||"UpdateExpression"===r.right.type?(n.reject(new Error(p.nodeErrorMessage(r.right,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),n.promise):(A(e,r.left).then(N.callback(function(t){if(!f.isBoolean(t))throw new Error(p.nodeErrorMessage(r,"RUNTIME","ONLYBOOLEAN"));switch(r.operator){case"||":t===!0?n.resolve(t):A(e,r.right).then(N.callback(function(e){if(!f.isBoolean(e))throw new Error(p.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"));n.resolve(e)},n),N.errback(n));break;case"&&":t===!1?n.resolve(t):A(e,r.right).then(N.callback(function(e){if(!f.isBoolean(e))throw new Error(p.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"));n.resolve(e)},n),N.errback(n));break;default:throw new Error(p.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"))}},n),N.errback(n)),n.promise)}catch(t){return R(t)}}function se(e,r){try{var n=new u,t=r.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[t]){var o=e.localScope[t];return o.valueset===!0?n.resolve(o.value):null!==o.d?o.d.then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):(o.d=A(e,o.node),o.d.then(N.callback(function(e){o.value=e,o.valueset=!0,n.resolve(e)},n),N.errback(n))),n.promise}if(void 0!==e.globalScope[t]){var a=e.globalScope[t];return a.valueset===!0?n.resolve(a.value):null!==a.d?a.d.then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):(a.d=A(e,a.node),a.d.then(N.callback(function(e){a.value=e,a.valueset=!0,n.resolve(e)},n),N.errback(n))),n.promise}return n.reject(new Error(p.nodeErrorMessage(r,"RUNTIME","VARIABLENOTFOUND"))),n.promise}catch(c){return R(c)}}function le(e,r){try{if("Identifier"!==r.callee.type)return R(p.nodeErrorMessage(r,"RUNTIME","ONLYNODESSUPPORTED"));if(null!==e.localScope&&void 0!==e.localScope[r.callee.name.toLowerCase()]){var n=e.localScope[r.callee.name.toLowerCase()];return n.value instanceof f.NativeFunction?n.value.fn(e,r):n.value instanceof b?ge(e,r,n.value.definition):R(p.nodeErrorMessage(r,"RUNTIME","NOTAFUNCTION"))}if(void 0!==e.globalScope[r.callee.name.toLowerCase()]){var n=e.globalScope[r.callee.name.toLowerCase()];return n.value instanceof f.NativeFunction?n.value.fn(e,r):n.value instanceof b?ge(e,r,n.value.definition):R(p.nodeErrorMessage(r,"RUNTIME","NOTAFUNCTION"))}return R(p.nodeErrorMessage(r,"RUNTIME","NOTFOUND"))}catch(t){return R(t)}}function ue(e){return null===e?"":f.isArray(e)?"Array":f.isImmutableArray(e)?"Array":f.isDate(e)?"Date":f.isString(e)?"String":f.isBoolean(e)?"Boolean":f.isNumber(e)?"Number":e instanceof d?"Dictionary":e instanceof h?"Feature":e instanceof a?"Point":e instanceof t?"Polygon":e instanceof o?"Polyline":e instanceof i?"Multipoint":e instanceof c?"Extent":f.isFunctionParameter(e)?"Function":e===f.voidOperation?"":"number"==typeof e&&isNaN(e)?"Number":"Unrecognised Type"}function ve(e,r,n,t){try{var o=new u;return A(e,r.arguments[n]).then(N.callback(function(a){if(f.equalityTest(a,t))A(e,r.arguments[n+1]).then(N.callback(function(e){o.resolve(e)},o),N.errback(o));else{var c=r.arguments.length-n;1===c?A(e,r.arguments[n]).then(N.callback(function(e){o.resolve(e)},o),N.errback(o)):2===c&&o.resolve(null),3===c?A(e,r.arguments[n+2]).then(N.callback(function(e){o.resolve(e)},o),N.errback(o)):ve(e,r,n+2,t).then(N.callback(function(e){o.resolve(e)},o),N.errback(o))}},o),N.errback(o)),o.promise}catch(a){return R(a)}}function fe(e,r,n,t){try{var o=new u;if(t===!0)A(e,r.arguments[n+1]).then(N.callback(function(e){o.resolve(e)},o),N.errback(o));else{var a=r.arguments.length-n;3===a?A(e,r.arguments[n+2]).then(N.callback(function(e){o.resolve(e)},o),N.errback(o)):A(e,r.arguments[n+2]).then(N.callback(function(t){return f.isBoolean(t)===!1?void o.reject(new Error("WHEN needs boolean test conditions")):void fe(e,r,n+2,t).then(N.callback(function(e){o.resolve(e)},o),N.errback(o))},o),N.errback(o))}return o.promise}catch(c){return R(c)}}function pe(e,r){var n=new u;try{var t=e.length,o=Math.floor(t/2);if(0===t)return n.resolve([]),n.promise;if(1===t)return n.resolve([e[0]]),n.promise;var a=[pe(e.slice(0,o),r),pe(e.slice(o,t),r)];l(a).then(N.callback(function(e){de(e[0],e[1],r,[]).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))},n),N.errback(n))}catch(c){n.reject(c)}return n.promise}function de(e,r,n,t){var o=new u;try{var a=t;e.length>0||r.length>0?e.length>0&&r.length>0?n(e[0],r[0]).then(N.callback(function(c){isNaN(c)&&(c=1),0>=c?(a.push(e[0]),e=e.slice(1)):(a.push(r[0]),r=r.slice(1)),de(e,r,n,t).then(N.callback(function(e){o.resolve(e)},o),N.errback(o))},o),N.errback(o)):e.length>0?(a.push(e[0]),e=e.slice(1),de(e,r,n,t).then(N.callback(function(e){o.resolve(e)},o),N.errback(o))):r.length>0&&(a.push(r[0]),r=r.slice(1),de(e,r,n,t).then(N.callback(function(e){o.resolve(e)},o),N.errback(o))):o.resolve(t)}catch(c){o.reject(c)}return o.promise}function he(e,r){var n=e.length,t=Math.floor(n/2);return r||(r=function(e,r){return r>e?-1:e===r?0:1}),0===n?[]:1===n?[e[0]]:be(he(e.slice(0,t),r),he(e.slice(t,n),r),r)}function be(e,r,n){for(var t=[];e.length>0||r.length>0;)if(e.length>0&&r.length>0){var o=n(e[0],r[0]);isNaN(o)&&(o=1),0>=o?(t.push(e[0]),e=e.slice(1)):(t.push(r[0]),r=r.slice(1))}else e.length>0?(t.push(e[0]),e=e.slice(1)):r.length>0&&(t.push(r[0]),r=r.slice(1));return t}function me(e,r,n){var t=new u;try{var o=e.body;if(n.length!==e.params.length)return R(new Error("Invalid Parameter calls to function."));for(var a=0;a<n.length;a++)r.localScope[e.params[a].name.toLowerCase()]={d:null,value:n[a],valueset:!0,node:null};A(r,o).then(N.callback(function(e){return e instanceof f.ReturnResult?void t.resolve(e.value):e===f.breakResult?void t.reject(new Error("Cannot Break from a Function")):e===f.continueResult?void t.reject(new Error("Cannot Continue from a Function")):e instanceof f.ImplicitResult?void t.resolve(e.value):void t.resolve(e)},t),N.errback(t))}catch(c){t.reject(c)}return t.promise}function ge(e,r,n){return C(e,r,function(r,t,o){var a={spatialReference:e.spatialReference,services:e.services,console:e.console,localScope:{},progressTracker:e.progressTracker,globalScope:e.globalScope,depthCounter:e.depthCounter+1};if(a.depthCounter>64)throw new Error("Exceeded maximum function depth");return me(n,a,o)})}function Ee(e){var r=function(){var r={applicationCache:void 0===e.context.applicationCache?null:e.context.applicationCache,progressTracker:e.context.progressTracker,spatialReference:e.context.spatialReference,console:e.context.console,services:e.context.services,localScope:{},globalScope:e.context.globalScope,depthCounter:e.context.depthCounter+1};if(r.depthCounter>64)throw new Error("Exceeded maximum function depth");return me(e.definition,r,arguments)};return r}function ke(e,r){var n=new je;(void 0===e||null===e)&&(e={}),(void 0===r||null===r)&&(r={});var t=new d({newline:"\n",tab:"	",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});t.immutable=!1,n.textformatting={value:t,valueset:!0,node:null};for(var o in r)n[o]={value:new f.NativeFunction(r[o]),"native":!0,valueset:!0,node:null};for(var o in e)e[o]&&"esri.Graphic"===e[o].declaredClass?n[o]={value:new h(e[o]),valueset:!0,node:null}:n[o]={value:e[o],valueset:!0,node:null};return n}function we(e){console.log(e)}function Ne(e){for(var r={mode:"async",compiled:!1,functions:{},signatures:[],standardFunction:M,standardFunctionAsync:C,failDefferred:R,evaluateIdentifier:se,arcadeCustomFunctionHandler:Ee},n=0;n<e.length;n++)e[n].registerFunctions(r);for(var t in r.functions)Ae[t]={value:new f.NativeFunction(r.functions[t]),valueset:!0,node:null},je.prototype[t]=Ae[t];for(var n=0;n<r.signatures.length;n++)p.addFunctionDeclaration(r.signatures[n],"f")}function ye(e,r,n){var t=new u;(null===n||void 0===n)&&(n=new s({wkid:102100}));var o=ke(r.vars,r.customfunctions),a={spatialReference:n,services:r.services,progressTracker:void 0===r.progressTracker||null===r.progressTracker?t.promise:r.progressTracker,globalScope:o,console:r.console?r.console:we,localScope:null,depthCounter:1};return A(a,e.body[0].body).then(N.callback(function(e){return e instanceof f.ReturnResult&&(e=e.value),e instanceof f.ImplicitResult&&(e=e.value),e===f.voidOperation&&(e=null),e===f.breakResult?void t.reject(new Error("Cannot return BREAK")):e===f.continueResult?void t.reject(new Error("Cannot return CONTINUE")):e instanceof f.NativeFunction?void t.reject(new Error("Cannot return FUNCTION")):e instanceof b?void t.reject(new Error("Cannot return FUNCTION")):void t.resolve(e)},t),N.errback(t)),t.promise}function Ie(e,r){return void 0===r&&(r=!1),p.findFieldLiterals(e,r)}function Oe(e,r){return p.validateScript(e,r,"full")}function Re(e,r){return p.referencesMember(e,r)}function Te(e,r){return p.referencesFunction(e,r)}function Se(e){return p.findFunctionCalls(e,!1)}Object.defineProperty(r,"__esModule",{value:!0});var Me=100,Ce=0,Ae={};m.registerFunctions(Ae,M),y.registerFunctions(Ae,M),g.registerFunctions(Ae,M),E.registerFunctions(Ae,M),I.registerFunctions(Ae,M),O.registerFunctions(Ae,M,C),Ae["typeof"]=function(e,r){return M(e,r,function(e,r,n){f.pcCheck(n,1,1);var t=ue(n[0]);if("Unrecognised Type"===t)throw new Error("Unrecognised Type");return t})},Ae.iif=function(e,r){try{var n=new u;return f.pcCheck(null===r.arguments?[]:r.arguments,3,3),A(e,r.arguments[0]).then(N.callback(function(t){return f.isBoolean(t)===!1?void n.reject(new Error("IF Function must have a boolean test condition")):void(t===!0?A(e,r.arguments[1]).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):A(e,r.arguments[2]).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)))},n),N.errback(n)),n.promise}catch(t){return R(t)}},Ae.decode=function(e,r){try{var n=new u;if(r.arguments.length<2)return R("Missing Parameters");if(2===r.arguments.length)A(e,r.arguments[1]).then(N.callback(function(e){n.resolve(e)},n),N.errback(n));else{if((r.arguments.length-1)%2===0)return R("Must have a default value result.");A(e,r.arguments[0]).then(N.callback(function(t){var o=1;ve(e,r,o,t).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))},n),N.errback(n))}return n.promise}catch(t){return R(t)}},Ae.when=function(e,r){try{var n=new u;return r.arguments.length<3?R("Missing Parameters"):r.arguments.length%2===0?R("Must have a default value result."):(A(e,r.arguments[0]).then(N.callback(function(t){if(f.isBoolean(t)===!1)return void n.reject(new Error("WHEN needs boolean test conditions"));var o=0;fe(e,r,o,t).then(N.callback(function(e){n.resolve(e)},n),N.errback(n))},n),N.errback(n)),n.promise)}catch(t){return R(t)}},Ae.sort=function(e,r){return C(e,r,function(e,r,n){var t=new u;f.pcCheck(n,1,2);var o=n[0];if(f.isImmutableArray(o)&&(o=o.toArray()),f.isArray(o)===!1)return R(Error("Illegal Argument"));if(n.length>1){if(f.isFunctionParameter(n[1])===!1)return R(Error("Illegal Argument"));var a=o,c=Ee(n[1]);return pe(a,c).then(N.callback(function(e){t.resolve(e)},t),N.errback(t)),t.promise}var a=o;if(0===a.length)return t.resolve([]),t.promise;for(var i={},s=0;s<a.length;s++){var l=ue(a[s]);""!==l&&(i[l]=!0)}if(i.Array===!0||i.Dictionary===!0||i.Feature===!0||i.Point===!0||i.Polygon===!0||i.Polyline===!0||i.Multipoint===!0||i.Extent===!0||i.Function===!0)return t.resolve(a.slice(0)),t.promise;var v=0,p="";for(var d in i)v++,p=d;return v>1||"String"===p?a=he(a,function(e,r){if(null===e||void 0===e||e===f.voidOperation)return null===r||void 0===r||r===f.voidOperation?0:1;if(null===r||void 0===r||r===f.voidOperation)return-1;var n=f.toString(e),t=f.toString(r);return t>n?-1:n===t?0:1}):"Number"===p?a=he(a,function(e,r){return e-r}):"Boolean"===p?a=he(a,function(e,r){return e===r?0:r?-1:1}):"Date"===p&&(a=he(a,function(e,r){return r-e})),t.resolve(a),t.promise})};var Fe={failDefferred:R,resolveDeffered:T,fixSpatialReference:f.fixSpatialReference,parseArguments:S,standardFunction:M,standardFunctionAsync:C,evaluateIdentifier:se,arcadeCustomFunction:Ee};for(var Ue in Ae)Ae[Ue]={value:new f.NativeFunction(Ae[Ue]),valueset:!0,node:null};var je=function(){};je.prototype=Ae,je.prototype.infinity={value:Number.POSITIVE_INFINITY,valueset:!0,node:null},je.prototype.pi={
value:Math.PI,valueset:!0,node:null},r.functionHelper=Fe,r.extend=Ne,r.executeScript=ye,r.extractFieldLiterals=Ie,r.validateScript=Oe,r.referencesMember=Re,r.referencesFunction=Te,r.findFunctionCalls=Se});