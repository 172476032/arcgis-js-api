// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../geometry/Geometry","../geometry/Polygon","../geometry/Polyline","../geometry/Point","../geometry/Extent","../geometry/Multipoint","../geometry/SpatialReference","../Graphic","dojo/promise/all","dojo/Deferred","dojo/promise/Promise","./languageUtils","./treeAnalysis","./Dictionary","./Feature","./FunctionWrapper","./functions/date","./functions/maths","./functions/geometry","./ImmutablePathArray","./ImmutablePointArray","./kernel","./functions/string","./functions/stats","./functions/geomasync"],function(e,r,n,t,a,o,c,i,l,s,u,v,f,p,d,h,b,m,g,k,E,w,N,y,I,O,R){function T(e){var r=new v;return e instanceof Error?r.reject(e):r.reject(new Error(e)),r.promise}function S(e){var r=new v;return r.resolve(e),r.promise}function M(e,r){for(var n=new v,t=[],a=0;a<r.arguments.length;a++)t.push(F(e,r.arguments[a]));return u(t).then(y.callback(function(e){n.resolve(e)},n),y.errback(n)),n.promise}function C(e,r,n){var t=new v;try{return M(e,r).then(y.callback(function(a){t.resolve(n(e,r,a))},t),y.errback(t)),t.promise}catch(a){return T(a)}}function A(e,r,n){var t=new v;try{return M(e,r).then(y.callback(function(a){var o=n(e,r,a);o instanceof f?o.then(y.callback(function(e){t.resolve(e)},t),y.errback(t)):t.resolve(o)},t),y.errback(t)),t.promise}catch(a){return T(a)}}function F(e,r){try{switch(r.type){case"VariableDeclarator":return ne(e,r);case"VariableDeclaration":return re(e,r,0);case"BlockStatement":return J(e,r);case"FunctionDeclaration":return ee(e,r);case"ReturnStatement":return $(e,r);case"IfStatement":return X(e,r);case"ExpressionStatement":return K(e,r);case"UpdateExpression":return H(e,r);case"AssignmentExpression":return W(e,r);case"ForStatement":return L(e,r);case"ForInStatement":return z(e,r);case"BreakStatement":var n=new v;return n.resolve(p.breakResult),n.promise;case"EmptyStatement":var t=new v;return t.resolve(p.voidOperation),t.promise;case"ContinueStatement":var a=new v;return a.resolve(p.continueResult),a.promise;case"Identifier":return se(e,r);case"MemberExpression":return ae(e,r);case"Literal":return S(r.value);case"ThisExpression":return T(d.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));case"CallExpression":return ue(e,r);case"UnaryExpression":return oe(e,r);case"BinaryExpression":return ie(e,r);case"LogicalExpression":return le(e,r);case"ConditionalExpression":return T(d.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));case"ArrayExpression":return ce(e,r);case"ObjectExpression":return U(e,r);case"Property":return j(e,r);case"Array":return T(d.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTED"));default:return T(d.nodeErrorMessage(r,"RUNTIME","UNREOGNISED"))}}catch(o){return T(o)}}function U(e,r){try{for(var n=new v,t=[],a=0;a<r.properties.length;a++)t.push(F(e,r.properties[a]));return u(t).then(y.callback(function(e){for(var r={},t=0;t<e.length;t++){var a=e[t];if(p.isFunctionParameter(a.value))throw new Error("Illegal Argument");if(p.isString(a.key)===!1)throw new Error("Illegal Argument");a.value===p.voidOperation?r[a.key.toString()]=null:r[a.key.toString()]=a.value}var o=new h(r);o.immutable=!1,n.resolve(o)},n),y.errback(n)),n.promise}catch(o){return T(o)}}function j(e,r){var n=new v;try{F(e,r.value).then(y.callback(function(e){n.resolve({key:"Identifier"===r.key.type?r.key.name:r.key.value,value:e})},n),y.errback(n))}catch(t){n.reject(t)}return n.promise}function x(e,r,n){var t=new v;try{F(e,r.body).then(y.callback(function(a){return n.lastAction=a,n.lastAction===p.breakResult?(n.testResult=!1,void t.resolve(n)):n.lastAction instanceof p.ReturnResult?(n.testResult=!1,void t.resolve(n)):void(null!==r.update?F(e,r.update).then(y.callback(function(e){t.resolve(n)},t),y.errback(t)):t.resolve(n))},t),y.errback(t))}catch(a){t.reject(a)}return t.promise}function P(e,r,n){var t=new v;try{return null!==r.test?(F(e,r.test).then(y.callback(function(a){return e.progressTracker.isCanceled()===!0?void t.reject(new Error("Cancelled")):(n.testResult=a,n.testResult===!1?void t.resolve(n):n.testResult!==!0?void t.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION"))):void x(e,r,n).then(y.callback(function(e){t.resolve(e)},t),y.errback(t)))},t),y.errback(t)),t.promise):x(e,r,n)}catch(a){t.reject(a)}return t.promise}function D(e,r,n){var t=new v;try{P(e,r,n).then(y.callback(function(){n.testResult===!0?D(e,r,n).then(y.callback(function(e){t.resolve(e)},t),y.errback(t)):n.lastAction instanceof p.ReturnResult?t.resolve(n.lastAction):t.resolve(p.voidOperation)},t),y.errback(t))}catch(a){t.reject(a)}return t.promise}function L(e,r){var n=new v;try{if(null!==r.init)F(e,r.init).then(y.callback(function(){var t={testResult:!0,lastAction:p.voidOperation};D(e,r,t).then(y.callback(function(e){n.resolve(e)},n),y.errback(n))},n),y.errback(n));else{var t={testResult:!0,lastAction:p.voidOperation};D(e,r,t).then(y.callback(function(e){n.resolve(e)},n),y.errback(n))}}catch(a){n.reject(a)}return n.promise}function _(e,r,n,t,a,o,c){var i=new v;try{if(o>=t)return i.resolve(p.voidOperation),i.promise;"k"===c?a.value=n[o]:a.value=o,F(e,r.body).then(y.callback(function(l){l instanceof p.ReturnResult?i.resolve(l):l===p.breakResult?i.resolve(p.voidOperation):_(e,r,n,t,a,o+1,c).then(y.callback(function(e){i.resolve(e)},i),y.errback(i))},i),y.errback(i))}catch(l){i.reject(l)}return i.promise}function V(e,r,n,t,a,o){var c=new v;try{if(n.length()<=a)return c.resolve(p.voidOperation),c.promise;"k"===o?t.value=n.get(a):t.value=a,F(e,r.body).then(y.callback(function(i){i instanceof p.ReturnResult?c.resolve(i):i===p.breakResult?c.resolve(p.voidOperation):V(e,r,n,t,a+1,o).then(y.callback(function(e){c.resolve(e)},c),y.errback(c))},c),y.errback(c))}catch(i){c.reject(i)}return c.promise}function B(e,r,n,t,a,o){try{if(void 0===o&&(o="i"),0===n.length)return void t.resolve(p.voidOperation);_(e,r,n,n.length,a,0,o).then(y.callback(function(e){t.resolve(e)},t),y.errback(t))}catch(c){t.reject(c)}}function Y(e,r,n,t,a,o){try{if(void 0===o&&(o="i"),0===n.length)return void t.resolve(p.voidOperation);V(e,r,n,a,0,o).then(y.callback(function(e){t.resolve(e)},t),y.errback(t))}catch(c){t.reject(c)}}function G(e,r,n,t,a){try{var o=n.keys();B(e,r,o,t,a,"k")}catch(c){t.reject(c)}}function q(e,r,n,t,a){var o=new v;try{e.next().then(y.callback(function(c){if(null===c)o.resolve(p.voidOperation);else{var i=new b(c.attributes,c.geometry,t);i._underlyingGraphic=c,c=i,a.value=c;var l=F(r,n.body);l.then(y.callback(function(c){c===p.breakResult?o.resolve(p.voidOperation):c instanceof p.ReturnResult?o.resolve(c):q(e,r,n,t,a).then(y.callback(function(e){o.resolve(e)},o),y.errback(o))},o),y.errback(o))}},o),y.errback(o))}catch(c){o.reject(c)}return o.promise}function z(e,r){var n=new v;try{F(e,r.right).then(y.callback(function(t){var a=null;"VariableDeclaration"===r.left.type?a=F(e,r.left):(a=new v,a.resolve(),a=a.promise),a.then(y.callback(function(){var a="VariableDeclaration"===r.left.type?r.left.declarations[0].id.name:r.left.name,o=null;return null!==e.localScope&&void 0!==e.localScope[a]&&(o=e.localScope[a]),null===o&&void 0!==e.globalScope[a]&&(o=e.globalScope[a]),null===o?void n.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","VARIABLENOTDECLARED"))):void(p.isArray(t)||p.isString(t)?B(e,r,t,n,o):p.isImmutableArray(t)?Y(e,r,t,n,o):t instanceof h||t instanceof b?G(e,r,t,n,o):p.isFeatureCursor(t)?q(t.iterator(e.progressTracker),e,r,t,o).then(y.callback(function(e){n.resolve(e)},n),y.errback(n)):B(e,r,[],n,o))},n),y.errback(n))},n),y.errback(n))}catch(t){n.reject(t)}return n.promise}function H(e,r){var n=new v;try{if("MemberExpression"!==r.argument.type){var t=r.argument.name.toLowerCase(),a=void 0;throw null!==e.localScope&&void 0!==e.localScope[t]&&(a=p.toNumber(e.localScope[t].value),e.localScope[t]={value:"++"===r.operator?a+1:a-1,valueset:!0,node:r},r.prefix===!1?n.resolve(a):n.resolve("++"===r.operator?a+1:a-1)),void 0!==e.globalScope[t]&&(a=p.toNumber(e.globalScope[t].value),e.globalScope[t]={value:"++"===r.operator?a+1:a-1,valueset:!0,node:r},r.prefix===!1?n.resolve(a):n.resolve("++"===r.operator?a+1:a-1)),new Error("Variable not recognised")}F(e,r.argument.object).then(y.callback(function(t){var a=null,o=null;r.argument.computed===!0?o=F(e,r.argument.property):(a=new v,a.resolve(r.argument.property.name),o=a.promise),o.then(y.callback(function(e){var a;if(p.isArray(t)){if(!p.isNumber(e))throw new Error("Invalid Parameter");if(0>e&&(e=t.length+e),0>e||e>=t.length)throw new Error("Assignment outside of array bounds");a=p.toNumber(t[e]),t[e]="++"===r.operator?a+1:a-1}else if(t instanceof h){if(p.isString(e)===!1)throw new Error("Dictionary accessor must be a string");if(t.hasField(e)!==!0)throw new Error("Invalid Parameter");a=p.toNumber(t.field(e)),t.setField(e,"++"===r.operator?a+1:a-1)}else{if(!(t instanceof b))throw p.isImmutableArray(t)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(p.isString(e)===!1)throw new Error("Feature accessor must be a string");if(t.hasField(e)!==!0)throw new Error("Invalid Parameter");a=p.toNumber(t.field(e)),t.setField(e,"++"===r.operator?a+1:a-1)}r.prefix===!1?n.resolve(a):n.resolve("++"===r.operator?a+1:a-1)},n),y.errback(n))},n),y.errback(n))}catch(o){n.reject(o)}return n.promise}function Z(e,r,n,t){switch(r){case"=":return e===p.voidOperation?null:e;case"/=":return p.toNumber(n)/p.toNumber(e);case"*=":return p.toNumber(n)*p.toNumber(e);case"-=":return p.toNumber(n)-p.toNumber(e);case"+=":return p.isString(n)||p.isString(e)?p.toString(n)+p.toString(e):p.toNumber(n)+p.toNumber(e);case"%=":return p.toNumber(n)%p.toNumber(e);default:throw new Error(d.nodeErrorMessage(t,"RUNTIME","OPERATORNOTRECOGNISED"))}}function W(e,r){var n=new v;try{if("MemberExpression"===r.left.type)F(e,r.right).then(y.callback(function(t){F(e,r.left.object).then(y.callback(function(a){var o=null,c=null;r.left.computed===!0?c=F(e,r.left.property):(o=new v,o.resolve(r.left.property.name),c=o.promise),c.then(y.callback(function(e){if(p.isArray(a)){if(!p.isNumber(e))throw new Error("Invalid Parameter");if(0>e&&(e=a.length+e),0>e||e>a.length)throw new Error("Assignment outside of array bounds");if(e===a.length){if("="!==r.operator)throw new Error("Invalid Parameter");a[e]=Z(t,r.operator,a[e],r)}else a[e]=Z(t,r.operator,a[e],r)}else if(a instanceof h){if(p.isString(e)===!1)throw new Error("Dictionary accessor must be a string");if(a.hasField(e)===!0)a.setField(e,Z(t,r.operator,a.field(e),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");a.setField(e,Z(t,r.operator,null,r))}}else{if(!(a instanceof b))throw p.isImmutableArray(a)?new Error("Array is Immutable"):new Error("Invalid Parameter");if(p.isString(e)===!1)throw new Error("Feature accessor must be a string");if(a.hasField(e)===!0)a.setField(e,Z(t,r.operator,a.field(e),r));else{if("="!==r.operator)throw new Error("Invalid Parameter");a.setField(e,Z(t,r.operator,null,r))}}n.resolve(p.voidOperation)},n),y.errback(n))},n),y.errback(n))},n),y.errback(n));else{var t=r.left.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[t])return F(e,r.right).then(y.callback(function(a){e.localScope[t]={value:Z(a,r.operator,e.localScope[t].value,r),valueset:!0,node:r.right},n.resolve(p.voidOperation)},n),y.errback(n)),n.promise;if(void 0!==e.globalScope[t])return F(e,r.right).then(y.callback(function(a){e.globalScope[t]={value:Z(a,r.operator,e.globalScope[t].value,r),valueset:!0,node:r.right},n.resolve(p.voidOperation)},n),y.errback(n)),n.promise;n.reject(new Error("Cannot assign undeclared variable"))}}catch(a){n.reject(a)}return n.promise}function K(e,r){var n=new v;try{"AssignmentExpression"===r.expression.type?F(e,r.expression).then(y.callback(function(e){n.resolve(e)},n),y.errback(n)):"CallExpression"===r.expression.type?F(e,r.expression).then(y.callback(function(e){return e===p.voidOperation?void n.resolve(p.voidOperation):void n.resolve(new p.ImplicitResult(e))},n),y.errback(n)):F(e,r.expression).then(y.callback(function(e){return e===p.voidOperation?void n.resolve(p.voidOperation):void n.resolve(new p.ImplicitResult(e))},n),y.errback(n))}catch(t){n.reject(t)}return n.promise}function X(e,r){var n=new v;try{if("AssignmentExpression"===r.test.type||"UpdateExpression"===r.test.type)return n.reject(new Error(d.nodeErrorMessage(r.test,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),n.promise;F(e,r.test).then(y.callback(function(t){t===!0?F(e,r.consequent).then(y.callback(function(e){n.resolve(e)},n),y.errback(n)):t===!1?null!==r.alternate?F(e,r.alternate).then(y.callback(function(e){n.resolve(e)},n),y.errback(n)):n.resolve(p.voidOperation):n.reject(new Error(d.nodeErrorMessage(r.test,"RUNTIME","CANNOT_USE_NONBOOLEAN_IN_CONDITION")))},n),y.errback(n))}catch(t){n.reject(t)}return n.promise}function J(e,r){var n=new v;try{Q(e,r,0).then(y.callback(function(e){n.resolve(e)},n),y.errback(n))}catch(t){n.reject(t)}return n.promise}function Q(e,r,n){var t=new v;try{n>=r.body.length?t.resolve(p.voidOperation):F(e,r.body[n]).then(y.callback(function(a){a instanceof p.ReturnResult||a===p.breakResult||a===p.continueResult?t.resolve(a):n===r.body.length-1?t.resolve(a):Q(e,r,n+1).then(y.callback(function(e){t.resolve(e)},t),y.errback(t))},t),y.errback(t))}catch(a){t.reject(a)}return t.promise}function $(e,r){var n=new v;try{null===r.argument?n.resolve(new p.ReturnResult(p.voidOperation)):F(e,r.argument).then(y.callback(function(e){n.resolve(new p.ReturnResult(e))},n),y.errback(n))}catch(t){n.reject(t)}return n.promise}function ee(e,r){var n=new v;try{var t=r.id.name.toLowerCase();e.globalScope[t]={valueset:!0,node:null,value:new m(r,e)},n.resolve(p.voidOperation)}catch(a){n.reject(a)}return n.promise}function re(e,r,n){var t=new v;try{if(n>=r.declarations.length)return t.resolve(p.voidOperation),t.promise;F(e,r.declarations[n]).then(y.callback(function(a){n===r.declarations.length-1?t.resolve(p.voidOperation):re(e,r,n+1).then(y.callback(function(e){t.resolve(p.voidOperation)},t),y.errback(t))},t),y.errback(t))}catch(a){t.reject(a)}return t.promise}function ne(e,r){var n=new v;try{var t=null;null===r.init?(t=new v,t.resolve(null),t=t.promise):t=F(e,r.init),null!==e.localScope?t.then(y.callback(function(t){t===p.voidOperation&&(t=null);var a=r.id.name.toLowerCase();e.localScope[a]={value:t,valueset:!0,node:r.init},n.resolve(p.voidOperation)},n),y.errback(n)):t.then(y.callback(function(t){var a=r.id.name.toLowerCase();t===p.voidOperation&&(t=null),e.globalScope[a]={value:t,valueset:!0,node:r.init},n.resolve(p.voidOperation)},n),y.errback(n))}catch(a){n.reject(a)}return n.promise}function te(e,r,n,t){var a;switch(r=r.toLowerCase()){case"hasz":var o=e.hasZ;return void 0===o?!1:o;case"hasm":var c=e.hasM;return void 0===c?!1:c;case"spatialreference":var i=e.spatialReference._arcadeCacheId;if(void 0===i){var l=!0;Object.freeze&&Object.isFrozen(e.spatialReference)&&(l=!1),l&&(Ce++,e.spatialReference._arcadeCacheId=Ce,i=Ce)}var s=new h({wkt:e.spatialReference.wkt,wkid:e.spatialReference.wkid});return void 0!==i&&(s._arcadeCacheId="SPREF"+i.toString()),s}switch(e.type){case"extent":switch(r){case"xmin":case"xmax":case"ymin":case"ymax":case"zmin":case"zmax":case"mmin":case"mmax":var u=e[r];return void 0!==u?u:null;case"type":return"Extent"}break;case"polygon":switch(r){case"rings":a=p.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===a&&(Ce++,a=Ce,p.isVersion4?e.cache._arcadeCacheId=a:e.setCacheValue("_arcadeCacheId",a));var v=new w(e.rings,e.spatialReference,e.hasZ===!0,e.hasM===!0,a);return v;case"type":return"Polygon"}break;case"point":switch(r){case"x":case"y":case"z":case"m":return void 0!==e[r]?e[r]:null;case"type":return"Point"}break;case"polyline":switch(r){case"paths":a=p.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===a&&(Ce++,a=Ce,p.isVersion4?e.cache._arcadeCacheId=a:e.setCacheValue("_arcadeCacheId",a));var v=new w(e.paths,e.spatialReference,e.hasZ===!0,e.hasM===!0,a);return v;case"type":return"Polyline"}break;case"multipoint":switch(r){case"points":a=p.isVersion4?e.cache._arcadeCacheId:e.getCacheValue("_arcadeCacheId"),void 0===a&&(Ce++,a=Ce,p.isVersion4?e.cache._arcadeCacheId=a:e.setCacheValue("_arcadeCacheId",a));var v=new N(e.points,e.spatialReference,e.hasZ===!0,e.hasM===!0,a,1);return v;case"type":return"Multipoint"}}throw new Error(d.nodeErrorMessage(t,"RUNTIME","PROPERTYNOTFOUND"))}function ae(e,r){try{var t=new v;return F(e,r.object).then(y.callback(function(a){return null===a?void t.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","NOTFOUND"))):void(r.computed===!1?a instanceof h||a instanceof b?t.resolve(a.field(r.property.name)):a instanceof n?t.resolve(te(a,r.property.name,e,r)):t.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE"))):F(e,r.property).then(y.callback(function(o){if(a instanceof h||a instanceof b)p.isString(o)?t.resolve(a.field(o)):t.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(a instanceof n)p.isString(o)?t.resolve(te(a,o,e,r)):t.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(p.isArray(a))if(p.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(0>o&&(o=a.length+o),o>=a.length||0>o)throw new Error(d.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(a[o])}else t.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(p.isImmutableArray(a))if(p.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(0>o&&(o=a.length()+o),o>=a.length()||0>o)throw new Error(d.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(a.get(o))}else t.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else if(p.isString(a))if(p.isNumber(o)&&isFinite(o)&&Math.floor(o)===o){if(0>o&&(o=a.length+o),o>=a.length||0>o)throw new Error(d.nodeErrorMessage(r,"RUNTIME","OUTOFBOUNDS"));t.resolve(a[o])}else t.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")));else t.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","INVALIDTYPE")))},t),y.errback(t)))},t),y.errback(t)),t.promise}catch(a){return T(a)}}function oe(e,r){try{var n=new v;return F(e,r.argument).then(y.callback(function(e){p.isBoolean(e)&&"!"===r.operator?n.resolve(!e):"-"===r.operator?n.resolve(-1*p.toNumber(e)):"+"===r.operator?n.resolve(1*p.toNumber(e)):n.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","NOTSUPPORTEDUNARYOPERATOR")))},n),y.errback(n)),n.promise}catch(t){return T(t)}}function ce(e,r){try{for(var n=new v,t=[],a=0;a<r.elements.length;a++)t.push(F(e,r.elements[a]));return u(t).then(y.callback(function(e){for(var t=0;t<e.length;t++){if(p.isFunctionParameter(e[t]))return void n.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","FUNCTIONCONTEXTILLEGAL")));e[t]===p.voidOperation&&(e[t]=null)}n.resolve(e)},n),y.errback(n)),n.promise}catch(o){return T(o)}}function ie(e,r){try{var n=new v;return u([F(e,r.left),F(e,r.right)]).then(y.callback(function(e){var t=e[0],a=e[1];switch(r.operator){case"==":n.resolve(p.equalityTest(t,a));break;case"=":n.resolve(p.equalityTest(t,a));break;case"!=":n.resolve(!p.equalityTest(t,a));break;case"<":n.resolve(p.greaterThanLessThan(t,a,r.operator));break;case">":n.resolve(p.greaterThanLessThan(t,a,r.operator));break;case"<=":n.resolve(p.greaterThanLessThan(t,a,r.operator));break;case">=":n.resolve(p.greaterThanLessThan(t,a,r.operator));break;case"+":p.isString(t)||p.isString(a)?n.resolve(p.toString(t)+p.toString(a)):n.resolve(p.toNumber(t)+p.toNumber(a));break;case"-":n.resolve(p.toNumber(t)-p.toNumber(a));break;case"*":n.resolve(p.toNumber(t)*p.toNumber(a));break;case"/":n.resolve(p.toNumber(t)/p.toNumber(a));break;case"%":n.resolve(p.toNumber(t)%p.toNumber(a));break;default:n.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","OPERATORNOTRECOGNISED")))}},n),y.errback(n)),n.promise}catch(t){return T(t)}}function le(e,r){try{var n=new v;return"AssignmentExpression"===r.left.type||"UpdateExpression"===r.left.type?(n.reject(new Error(d.nodeErrorMessage(r.left,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),n.promise):"AssignmentExpression"===r.right.type||"UpdateExpression"===r.right.type?(n.reject(new Error(d.nodeErrorMessage(r.right,"RUNTIME","CANNOT_USE_ASSIGNMENT_IN_CONDITION"))),n.promise):(F(e,r.left).then(y.callback(function(t){if(!p.isBoolean(t))throw new Error(d.nodeErrorMessage(r,"RUNTIME","ONLYBOOLEAN"));switch(r.operator){case"||":t===!0?n.resolve(t):F(e,r.right).then(y.callback(function(e){if(!p.isBoolean(e))throw new Error(d.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"));n.resolve(e)},n),y.errback(n));break;case"&&":t===!1?n.resolve(t):F(e,r.right).then(y.callback(function(e){if(!p.isBoolean(e))throw new Error(d.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"));n.resolve(e)},n),y.errback(n));break;default:throw new Error(d.nodeErrorMessage(r,"RUNTIME","ONLYORORAND"))}},n),y.errback(n)),n.promise)}catch(t){return T(t)}}function se(e,r){try{var n=new v,t=r.name.toLowerCase();if(null!==e.localScope&&void 0!==e.localScope[t]){var a=e.localScope[t];return a.valueset===!0?n.resolve(a.value):null!==a.d?a.d.then(y.callback(function(e){n.resolve(e)},n),y.errback(n)):(a.d=F(e,a.node),a.d.then(y.callback(function(e){a.value=e,a.valueset=!0,n.resolve(e)},n),y.errback(n))),n.promise}if(void 0!==e.globalScope[t]){var o=e.globalScope[t];return o.valueset===!0?n.resolve(o.value):null!==o.d?o.d.then(y.callback(function(e){n.resolve(e)},n),y.errback(n)):(o.d=F(e,o.node),o.d.then(y.callback(function(e){o.value=e,o.valueset=!0,n.resolve(e)},n),y.errback(n))),n.promise}return n.reject(new Error(d.nodeErrorMessage(r,"RUNTIME","VARIABLENOTFOUND"))),n.promise}catch(c){return T(c)}}function ue(e,r){try{if("Identifier"!==r.callee.type)return T(d.nodeErrorMessage(r,"RUNTIME","ONLYNODESSUPPORTED"));if(null!==e.localScope&&void 0!==e.localScope[r.callee.name.toLowerCase()]){var n=e.localScope[r.callee.name.toLowerCase()];return n.value instanceof p.NativeFunction?n.value.fn(e,r):n.value instanceof m?ke(e,r,n.value.definition):T(d.nodeErrorMessage(r,"RUNTIME","NOTAFUNCTION"))}if(void 0!==e.globalScope[r.callee.name.toLowerCase()]){var n=e.globalScope[r.callee.name.toLowerCase()];return n.value instanceof p.NativeFunction?n.value.fn(e,r):n.value instanceof m?ke(e,r,n.value.definition):T(d.nodeErrorMessage(r,"RUNTIME","NOTAFUNCTION"))}return T(d.nodeErrorMessage(r,"RUNTIME","NOTFOUND"))}catch(t){return T(t)}}function ve(e){return null===e?"":p.isArray(e)?"Array":p.isImmutableArray(e)?"Array":p.isDate(e)?"Date":p.isString(e)?"String":p.isBoolean(e)?"Boolean":p.isNumber(e)?"Number":e instanceof h?"Dictionary":e instanceof b?"Feature":e instanceof o?"Point":e instanceof t?"Polygon":e instanceof a?"Polyline":e instanceof i?"Multipoint":e instanceof c?"Extent":p.isFunctionParameter(e)?"Function":e===p.voidOperation?"":"number"==typeof e&&isNaN(e)?"Number":"Unrecognised Type"}function fe(e,r,n,t){try{var a=new v;return F(e,r.arguments[n]).then(y.callback(function(o){if(p.equalityTest(o,t))F(e,r.arguments[n+1]).then(y.callback(function(e){a.resolve(e)},a),y.errback(a));else{var c=r.arguments.length-n;1===c?F(e,r.arguments[n]).then(y.callback(function(e){a.resolve(e)},a),y.errback(a)):2===c&&a.resolve(null),3===c?F(e,r.arguments[n+2]).then(y.callback(function(e){a.resolve(e)},a),y.errback(a)):fe(e,r,n+2,t).then(y.callback(function(e){a.resolve(e)},a),y.errback(a))}},a),y.errback(a)),a.promise}catch(o){return T(o)}}function pe(e,r,n,t){try{var a=new v;if(t===!0)F(e,r.arguments[n+1]).then(y.callback(function(e){a.resolve(e)},a),y.errback(a));else{var o=r.arguments.length-n;3===o?F(e,r.arguments[n+2]).then(y.callback(function(e){a.resolve(e)},a),y.errback(a)):F(e,r.arguments[n+2]).then(y.callback(function(t){return p.isBoolean(t)===!1?void a.reject(new Error("WHEN needs boolean test conditions")):void pe(e,r,n+2,t).then(y.callback(function(e){a.resolve(e)},a),y.errback(a))},a),y.errback(a))}return a.promise}catch(c){return T(c)}}function de(e,r){var n=new v;try{var t=e.length,a=Math.floor(t/2);if(0===t)return n.resolve([]),n.promise;if(1===t)return n.resolve([e[0]]),n.promise;var o=[de(e.slice(0,a),r),de(e.slice(a,t),r)];u(o).then(y.callback(function(e){he(e[0],e[1],r,[]).then(y.callback(function(e){n.resolve(e)},n),y.errback(n))},n),y.errback(n))}catch(c){n.reject(c)}return n.promise}function he(e,r,n,t){var a=new v;try{var o=t;e.length>0||r.length>0?e.length>0&&r.length>0?n(e[0],r[0]).then(y.callback(function(c){isNaN(c)&&(c=1),0>=c?(o.push(e[0]),e=e.slice(1)):(o.push(r[0]),r=r.slice(1)),he(e,r,n,t).then(y.callback(function(e){a.resolve(e)},a),y.errback(a))},a),y.errback(a)):e.length>0?(o.push(e[0]),e=e.slice(1),he(e,r,n,t).then(y.callback(function(e){a.resolve(e)},a),y.errback(a))):r.length>0&&(o.push(r[0]),r=r.slice(1),he(e,r,n,t).then(y.callback(function(e){a.resolve(e)},a),y.errback(a))):a.resolve(t)}catch(c){a.reject(c)}return a.promise}function be(e,r){var n=e.length,t=Math.floor(n/2);return r||(r=function(e,r){return r>e?-1:e===r?0:1}),0===n?[]:1===n?[e[0]]:me(be(e.slice(0,t),r),be(e.slice(t,n),r),r)}function me(e,r,n){for(var t=[];e.length>0||r.length>0;)if(e.length>0&&r.length>0){var a=n(e[0],r[0]);isNaN(a)&&(a=1),0>=a?(t.push(e[0]),e=e.slice(1)):(t.push(r[0]),r=r.slice(1))}else e.length>0?(t.push(e[0]),e=e.slice(1)):r.length>0&&(t.push(r[0]),r=r.slice(1));return t}function ge(e,r,n){var t=new v;try{var a=e.body;if(n.length!==e.params.length)return T(new Error("Invalid Parameter calls to function."));for(var o=0;o<n.length;o++)r.localScope[e.params[o].name.toLowerCase()]={d:null,value:n[o],valueset:!0,node:null};F(r,a).then(y.callback(function(e){return e instanceof p.ReturnResult?void t.resolve(e.value):e===p.breakResult?void t.reject(new Error("Cannot Break from a Function")):e===p.continueResult?void t.reject(new Error("Cannot Continue from a Function")):e instanceof p.ImplicitResult?void t.resolve(e.value):void t.resolve(e)},t),y.errback(t))}catch(c){t.reject(c)}return t.promise}function ke(e,r,n){return A(e,r,function(r,t,a){var o={spatialReference:e.spatialReference,services:e.services,console:e.console,localScope:{},progressTracker:e.progressTracker,globalScope:e.globalScope,depthCounter:e.depthCounter+1};if(o.depthCounter>64)throw new Error("Exceeded maximum function depth");return ge(n,o,a)})}function Ee(e){var r=function(){var r={applicationCache:void 0===e.context.applicationCache?null:e.context.applicationCache,progressTracker:e.context.progressTracker,spatialReference:e.context.spatialReference,console:e.context.console,services:e.context.services,localScope:{},globalScope:e.context.globalScope,depthCounter:e.context.depthCounter+1};if(r.depthCounter>64)throw new Error("Exceeded maximum function depth");return ge(e.definition,r,arguments)};return r}function we(e,r){var n=new je;(void 0===e||null===e)&&(e={}),(void 0===r||null===r)&&(r={});var t=new h({newline:"\n",tab:"	",singlequote:"'",doublequote:'"',forwardslash:"/",backwardslash:"\\"});t.immutable=!1,n.textformatting={value:t,valueset:!0,node:null};for(var a in r)n[a]={value:new p.NativeFunction(r[a]),"native":!0,valueset:!0,node:null};for(var a in e)e[a]instanceof s?n[a]={value:new b(e[a]),valueset:!0,node:null}:n[a]={value:e[a],valueset:!0,node:null};return n}function Ne(e){console.log(e)}function ye(e){for(var r={mode:"async",compiled:!1,functions:{},signatures:[],standardFunction:C,standardFunctionAsync:A,failDefferred:T,evaluateIdentifier:se,arcadeCustomFunctionHandler:Ee},n=0;n<e.length;n++)e[n].registerFunctions(r);for(var t in r.functions)Ae[t]={value:new p.NativeFunction(r.functions[t]),valueset:!0,node:null},je.prototype[t]=Ae[t];for(var n=0;n<r.signatures.length;n++)d.addFunctionDeclaration(r.signatures[n],"f")}function Ie(e,r,n){var t=new v;(null===n||void 0===n)&&(n=new l({wkid:102100}));var a=we(r.vars,r.customfunctions),o={spatialReference:n,services:r.services,progressTracker:void 0===r.progressTracker||null===r.progressTracker?t.promise:r.progressTracker,globalScope:a,console:r.console?r.console:Ne,localScope:null,depthCounter:1};return F(o,e.body[0].body).then(y.callback(function(e){return e instanceof p.ReturnResult&&(e=e.value),e instanceof p.ImplicitResult&&(e=e.value),e===p.voidOperation&&(e=null),e===p.breakResult?void t.reject(new Error("Cannot return BREAK")):e===p.continueResult?void t.reject(new Error("Cannot return CONTINUE")):e instanceof p.NativeFunction?void t.reject(new Error("Cannot return FUNCTION")):e instanceof m?void t.reject(new Error("Cannot return FUNCTION")):void t.resolve(e)},t),y.errback(t)),t.promise}function Oe(e,r){return void 0===r&&(r=!1),d.findFieldLiterals(e,r)}function Re(e,r){return d.validateScript(e,r,"full")}function Te(e,r){return d.referencesMember(e,r)}function Se(e,r){return d.referencesFunction(e,r)}function Me(e){return d.findFunctionCalls(e,!1)}Object.defineProperty(r,"__esModule",{value:!0});var Ce=0,Ae={};g.registerFunctions(Ae,C),I.registerFunctions(Ae,C),k.registerFunctions(Ae,C),E.registerFunctions(Ae,C),O.registerFunctions(Ae,C),R.registerFunctions(Ae,C,A),Ae["typeof"]=function(e,r){return C(e,r,function(e,r,n){p.pcCheck(n,1,1);var t=ve(n[0]);if("Unrecognised Type"===t)throw new Error("Unrecognised Type");return t})},Ae.iif=function(e,r){try{var n=new v;return p.pcCheck(null===r.arguments?[]:r.arguments,3,3),F(e,r.arguments[0]).then(y.callback(function(t){return p.isBoolean(t)===!1?void n.reject(new Error("IF Function must have a boolean test condition")):void(t===!0?F(e,r.arguments[1]).then(y.callback(function(e){n.resolve(e)},n),y.errback(n)):F(e,r.arguments[2]).then(y.callback(function(e){n.resolve(e)},n),y.errback(n)))},n),y.errback(n)),n.promise}catch(t){return T(t)}},Ae.decode=function(e,r){try{var n=new v;if(r.arguments.length<2)return T("Missing Parameters");if(2===r.arguments.length)F(e,r.arguments[1]).then(y.callback(function(e){n.resolve(e)},n),y.errback(n));else{if((r.arguments.length-1)%2===0)return T("Must have a default value result.");F(e,r.arguments[0]).then(y.callback(function(t){var a=1;fe(e,r,a,t).then(y.callback(function(e){n.resolve(e)},n),y.errback(n))},n),y.errback(n))}return n.promise}catch(t){return T(t)}},Ae.when=function(e,r){try{var n=new v;return r.arguments.length<3?T("Missing Parameters"):r.arguments.length%2===0?T("Must have a default value result."):(F(e,r.arguments[0]).then(y.callback(function(t){if(p.isBoolean(t)===!1)return void n.reject(new Error("WHEN needs boolean test conditions"));var a=0;pe(e,r,a,t).then(y.callback(function(e){n.resolve(e)},n),y.errback(n))},n),y.errback(n)),n.promise)}catch(t){return T(t)}},Ae.sort=function(e,r){return A(e,r,function(e,r,n){var t=new v;p.pcCheck(n,1,2);var a=n[0];if(p.isImmutableArray(a)&&(a=a.toArray()),p.isArray(a)===!1)return T(Error("Illegal Argument"));if(n.length>1){if(p.isFunctionParameter(n[1])===!1)return T(Error("Illegal Argument"));var o=a,c=Ee(n[1]);return de(o,c).then(y.callback(function(e){t.resolve(e)},t),y.errback(t)),t.promise}var o=a;if(0===o.length)return t.resolve([]),t.promise;for(var i={},l=!0,s=0;s<o.length;s++){var u=ve(o[s]);""!==u?i[u]=!0:l=!0}if(i.Array===!0||i.Dictionary===!0||i.Feature===!0||i.Point===!0||i.Polygon===!0||i.Polyline===!0||i.Multipoint===!0||i.Extent===!0||i.Function===!0)return t.resolve(o.slice(0)),t.promise;var f=0,d="";for(var h in i)f++,d=h;return f>1||"String"===d?o=be(o,function(e,r){if(null===e||void 0===e||e===p.voidOperation)return null===r||void 0===r||r===p.voidOperation?0:1;if(null===r||void 0===r||r===p.voidOperation)return-1;var n=p.toString(e),t=p.toString(r);return t>n?-1:n===t?0:1}):"Number"===d?o=be(o,function(e,r){return e-r}):"Boolean"===d?o=be(o,function(e,r){return e===r?0:r?-1:1}):"Date"===d&&(o=be(o,function(e,r){return r-e})),t.resolve(o),t.promise})};var Fe={failDefferred:T,resolveDeffered:S,fixSpatialReference:p.fixSpatialReference,parseArguments:M,standardFunction:C,standardFunctionAsync:A,evaluateIdentifier:se,arcadeCustomFunction:Ee};for(var Ue in Ae)Ae[Ue]={value:new p.NativeFunction(Ae[Ue]),valueset:!0,node:null};var je=function(){};je.prototype=Ae,je.prototype.infinity={value:Number.POSITIVE_INFINITY,valueset:!0,node:null},je.prototype.pi={value:Math.PI,valueset:!0,node:null},r.functionHelper=Fe,r.extend=ye,r.executeScript=Ie,
r.extractFieldLiterals=Oe,r.validateScript=Re,r.referencesMember=Te,r.referencesFunction=Se,r.findFunctionCalls=Me});