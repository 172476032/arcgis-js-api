// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function a(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();define(["require","exports","dojo/Deferred","../request","./featureSetCollection","./featureset/sources/FeatureLayerDynamic","./featureset/sources/FeatureLayerDynamicMap","./featureset/sources/FeatureLayerMemoryMap","./featureset/support/cache","../layers/FeatureLayer","./polyfill/promiseUtils"],function(e,t,r,a,i,n,o,l,s,u,c){"use strict";function d(){null===s.applicationCache&&(s.applicationCache=new s)}function f(e,t,r,a,i){return void 0===r&&(r=null),void 0===a&&(a=!0),void 0===i&&(i=null),null===r&&(r=["*"]),new n({url:e,outFields:r,spatialReference:t,token:null,includeGeometry:a,lrucache:i})}function h(e,t,r,a,i){if(void 0===t&&(t=null),void 0===r&&(r=null),void 0===a&&(a=!0),void 0===i&&(i=null),!e.getMap())throw new Error("FeatureSets can only be used once the layer is added to a Map");if(e.mode!==u.MODE_SNAPSHOT||e.url){if(e.mode===u.MODE_SNAPSHOT||e.mode===u.MODE_ONDEMAND||e.mode===u.MODE_AUTO)return new o({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:i});throw new Error("FeatureSets only support for Snapshot or OnDemand FeatureSet")}return new l({layer:e,spatialReference:t,outFields:r,includeGeometry:a})}function p(e,t,r){return void 0===r&&(r=null),new _(e,t,r)}function v(e,t,r){return void 0===r&&(r=null),new S(e,t,r)}function m(e,t){var i=t.portalUrl+(t.portalUrl.match(/\/$/)?"":"/")+"content/items/"+e,n=new r;return a({url:i,content:{f:"json"},callbackParamName:"callback",load:function(e){n.resolve({item:e})},error:function(e){n.reject(e)}}),n.promise}function y(e,t,a,i,n,o,l){var u=new r;if(s.applicationCache){var c=s.applicationCache.getLayerInfo(e+":"+o.url);if(c)return c.then(function(e){try{var r=f(e.item.url+"/"+t,a,i,n,l);u.resolve(r)}catch(e){u.reject(e)}},function(e){u.reject(e)}),u.promise}var d=m(e,o);return s.applicationCache&&s.applicationCache.setLayerInfo(e+":"+o.url,d),d.then(function(e){try{var r=f(e.item.url+"/"+t,a,i,n,l);u.resolve(r)}catch(e){u.reject(e)}},function(t){s.applicationCache&&s.applicationCache.clearLayerInfo(e+":"+o.url),u.reject(t)}),u.promise}Object.defineProperty(t,"__esModule",{value:!0}),t.initialiseMetaDataCache=d,t.constructFeatureSetFromUrl=f,t.constructFeatureSet=h;var _=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var i=e.call(this)||this;return i._map=t,i._overridespref=r,i.lrucache=a,i._instantLayers=[],i}return __extends(t,e),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=h(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.makeAndAddFeatureSetTable=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=f(e.url,this._overridespref,r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:{name:e.title,id:e.id},includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.featureSetByName=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null),null===r&&(r=["*"]),r=r.slice(0),r=r.sort();for(var a=JSON.stringify(r),i=0;i<this._instantLayers.length;i++){var n=this._instantLayers[i];if(n.opitem.name===e&&n.includeGeometry===t&&n.outFields===a)return this.resolvePromise(this._instantLayers[i].featureset)}for(var o=null,l=0,s=this._map.graphicsLayerIds;l<s.length;l++){var c=s[l],d=this._map.getLayer(c);if(d instanceof u&&d.name===e){o=d;break}}if(o)return this.resolvePromise(this.makeAndAddFeatureSet(o,t,r));if(this._map.tables){var f=this._map.tables.find(function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)});if(f)return this.resolvePromise(this.makeAndAddFeatureSetTable(f,t,r))}return this.resolvePromise(null)},t.prototype.featureSetById=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=["*"]),null===r&&(r=["*"]),r=r.slice(0),r=r.sort();for(var a=JSON.stringify(r),i=0;i<this._instantLayers.length;i++){var n=this._instantLayers[i];if(n.opitem.id===e&&n.includeGeometry===t&&n.outFields===a)return this.resolvePromise(this._instantLayers[i].featureset)}for(var o=null,l=0,s=this._map.graphicsLayerIds;l<s.length;l++){var c=s[l],d=this._map.getLayer(c);if(d instanceof u&&d.id===e){o=d;break}}if(o)return this.resolvePromise(this.makeAndAddFeatureSet(o,t,r));if(this._map.tables){var f=this._map.tables.find(function(t){return!!(t.id&&t.id===e||t.id&&t.id===e)});if(f)return this.resolvePromise(this.makeAndAddFeatureSetTable(f,t,r))}return this.resolvePromise(null)},t}(i);t.createFeatureSetCollectionFromMap=p;var S=function(e){function t(t,r,a){void 0===r&&(r=null),void 0===a&&(a=null);var i=e.call(this)||this;return i._url=t,i._overridespref=r,i.lrucache=a,i.metadata=null,i._instantLayers=[],i}return __extends(t,e),Object.defineProperty(t.prototype,"url",{get:function(){return this._url},enumerable:!0,configurable:!0}),t.prototype._loadMetaData=function(){var e=this;if(null!==s.applicationCache){var t=s.applicationCache.getLayerInfo(this._url);if(null!==t)return t.then(function(t){return e.metadata=t,c.resolve(e.metadata)})}var i=new r;return null!==s.applicationCache&&s.applicationCache.setLayerInfo(this._url,i.promise),a({url:this._url,content:{f:"json"},callbackParamName:"callback",handleAs:"json"}).then(function(t){t?(e.metadata={layers:t.layers?t.layers:[],tables:t.tables?t.tables:[]},i.resolve(e.metadata)):(e.metadata={layers:[],tables:[]},i.resolve(e.metadata))},function(t){s.applicationCache&&s.applicationCache.clearLayerInfo(e._url),i.reject(t)}),i.promise},t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var a=h(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a},t.prototype.load=function(){return this._loadMetaData()},t.prototype.clone=function(){return new t(this._url,this._overridespref,this.lrucache)},t.prototype.featureSetByName=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=null),null===r&&(r=["*"]),r=r.slice(0),r=r.sort();for(var i=JSON.stringify(r),n=0;n<this._instantLayers.length;n++){var o=this._instantLayers[n];if(o.opitem.name===e&&o.includeGeometry===t&&o.outFields===i)return this.resolvePromise(this._instantLayers[n].featureset)}return this._loadMetaData().then(function(i){for(var n=null,o=0,l=i.layers?i.layers:[];o<l.length;o++){var s=l[o];s.name===e&&(n=s)}if(!n)for(var u=0,c=i.tables?i.tables:[];u<c.length;u++){var s=c[u];s.name===e&&(n=s)}return n?a.resolvePromise(f(a._url+"/"+n.id,a._overridespref,r,t,a.lrucache)):a.resolvePromise(null)})},t.prototype.featureSetById=function(e,t,r){var a=this;void 0===t&&(t=!0),void 0===r&&(r=["*"]),null===r&&(r=["*"]),r=r.slice(0),r=r.sort();var i=JSON.stringify(r);e=null!==e&&void 0!==e?e.toString():"";for(var n=0;n<this._instantLayers.length;n++){var o=this._instantLayers[n];if(o.opitem.id===e&&o.includeGeometry===t&&o.outFields===i)return this.resolvePromise(this._instantLayers[n].featureset)}return this._loadMetaData().then(function(i){for(var n=null,o=0,l=i.layers?i.layers:[];o<l.length;o++){var s=l[o];null!==s.id&&void 0!==s.id&&s.id.toString()===e&&(n=s)}if(!n)for(var u=0,c=i.tables?i.tables:[];u<c.length;u++){var s=c[u];null!==s.id&&void 0!==s.id&&s.id.toString()===e&&(n=s)}return n?a.resolvePromise(f(a._url+"/"+n.id,a._overridespref,r,t,a.lrucache)):a.resolvePromise(null)})},t}(i);t.createFeatureSetCollectionFromService=v,t.constructFeatureSetFromPortalItem=y});