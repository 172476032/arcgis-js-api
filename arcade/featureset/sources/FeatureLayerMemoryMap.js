// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","dojo/Deferred","dojo/promise/all","../../../graphic","../support/FeatureSet","../support/IdSet","../support/shared","../../../geometry/geometryEngineAsync"],function(e,t,r,n,a,s,o,i,l){"use strict";return function(e){function t(t){var r=e.call(this,t)||this;if(r.declaredClass="esri.layers.featureset.sources.FeatureLayerMemory",r._removeGeometry=!1,r._overrideFields=null,r.allf=null,t.spatialReference&&(r.spatialReference=t.spatialReference),r._transparent=!0,r._maxProcessing=1e3,r._layer=t.layer,r._wset=null,!1===r._layer.loaded)throw new Error("Can only create Feature FeatureSets from Loaded FeatureLayers. Use FeatureLayer or FeatureCollection classes");return void 0!==t.outFields&&(r._overrideFields=t.outFields),void 0!==t.includeGeometry&&(r._removeGeometry=!1===t.includeGeometry),r}return __extends(t,e),t.prototype._maxQueryRate=function(){return i.defaultMaxRecords},t.prototype.end=function(){return this._layer},t.prototype.optimisePagingFeatureQueries=function(e){},t.prototype.load=function(){if(null===this._loadPromise){var e=new r;this._loadPromise=e,this._initialiseFeatureSet(),e.resolve(this)}return this._loadPromise.promise},t.prototype._initialiseFeatureSet=function(){if(!this._layer.getMap())throw new Error("Can only use featuresets with layers attached to map");null==this.spatialReference&&(this.spatialReference=this._layer.getMap().spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0);var e=this._layer.getOutFields();if(1===e.length&&"*"===e[0]);else{for(var t=[],r=0,n=this.fields;r<n.length;r++){var a=n[r];if("esriFieldTypeOID"===a.type)t.push(a);else for(var s=0,o=e;s<o.length;s++){var l=o[s];if(l.toLowerCase()===a.name.toLowerCase()){t.push(a);break}}}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{for(var t=[],u=[],c=0,p=this.fields;c<p.length;c++){var a=p[c];if("esriFieldTypeOID"===a.type)t.push(a),u.push(a.name);else for(var h=0,f=this._overrideFields;h<f.length;h++){var l=f[h];if(l.toLowerCase()===a.name.toLowerCase()){t.push(a),u.push(a.name);break}}}this.fields=t,this._overrideFields=u}this.objectIdField=this._layer.objectIdField,this._databaseType=i.FeatureServiceDatabaseType.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types},t.prototype._isInFeatureSet=function(e){return i.IdState.InFeatureSet},t.prototype._transformSetWithIdChanges=function(e){},t.prototype._candidateIdTransform=function(e){return e},t.prototype._getSet=function(e){var t=this,n=new r;return null===this._wset?this._ensureLoaded().then(i.callback(function(){t._getFilteredSet("",null,null,null,e).then(function(e){t._wset=e,n.resolve(e)},i.errback(n))},n),i.errback(n)):n.resolve(this._wset),n.promise},t.prototype._getFilteredSet=function(e,t,n,a,s){var l=this,u=new r;try{this._ensureLoaded().then(i.callback(function(){if(null===l._wset){var r=[];l._allFeatures().forEach(function(e){void 0===e.geometry&&(e.geometry=null);var t=e.attributes[l._layer.objectIdField];r.push(t),l._featureCache[t]=e}),l._wset=new o([],r,!1,null)}var a=l._wset._known.slice(0);l._checkCancelled(s),l.fetchAndRefineFeaturesByWhere(a,n,s).then(i.callback(function(r){l._checkCancelled(s),null!==t?l.fetchAndRefineFeaturesSpatially(r,t,e,s).then(i.callback(function(e){u.resolve(new o([],e,!1,null))},u),i.errback(u)):u.resolve(new o([],r,!1,null))},u),i.errback(u))},u),i.errback(u))}catch(e){u.reject(e)}return u.promise},t.prototype.executeSpatialRelationTest=function(e,t,n,a){if(null===e.geometry){var s=new r;return s.resolve(!1),s.promise}switch(t){case"esriSpatialRelEnvelopeIntersects":var o=i.shapeExtent(n),u=i.shapeExtent(e.geometry);return l.intersects(o,u);case"esriSpatialRelIntersects":return l.intersects(n,e.geometry);case"esriSpatialRelContains":return l.contains(n,e.geometry);case"esriSpatialRelOverlaps":return l.overlaps(n,e.geometry);case"esriSpatialRelWithin":return l.within(n,e.geometry);case"esriSpatialRelTouches":return l.touches(n,e.geometry);case"esriSpatialRelCrosses":return l.crosses(n,e.geometry);case"esriSpatialRelRelation":return l.relate(n,e.geometry,a)}},t.prototype.executeWhereTest=function(e,t){return t.testFeature(e)},t.prototype.fetchAndRefineFeaturesSpatially=function(e,t,a,s){var o=new r,l=[],u=[],c="";a.indexOf("esriSpatialRelRelation")>=0&&(c=a.split(":")[1],a="esriSpatialRelRelation");for(var p=0;p<e.length;p++){var h=this._featureFromCache(e[p]);u.push(this.executeSpatialRelationTest(h,a,t,c))}return 0===u.length?(o.resolve(l),o.promise):(n(u).then(i.callback(function(t){for(var r=0;r<e.length;r++)!0===t[r]&&l.push(e[r]);o.resolve(l)},o),i.errback(o)),o.promise)},t.prototype.fetchAndRefineFeaturesByWhere=function(e,t,n){var a=new r,s=[];if(null===t)a.resolve(e);else{for(var o=0;o<e.length;o++){var i=this._featureFromCache(e[o]);this.executeWhereTest(i,t)&&s.push(e[o])}a.resolve(s)}return a.promise},t.prototype._getFeatures=function(e,t,n,a){var s=new r,o=[];-1!==t&&void 0===this._featureCache[t]&&o.push(t);for(var i=e._lastFetchedIndex;i<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[i]]&&(e._known[i]!==t&&o.push(e._known[i]),o.length>n)));i++);return 0===o.length?s.resolve("success"):s.reject(new Error("Unaccounted for Features. Not in Feature Collection")),s.promise},t.prototype._refineSetBlock=function(e,t,n){var a=new r;return a.resolve(e),a.promise},t.prototype._stat=function(e,t,n,a,s,o,i){var l=new r;return l.resolve({calculated:!1}),l.promise},t.prototype._canDoAggregates=function(e,t,n,a,s){var o=new r;return o.resolve(!1),o.promise},t._cloneAttr=function(e){var t={};for(var r in e)t[r]=e[r];return t},t.prototype.cloneAttr=function(e){for(var t={},r=0,n=this.fields;r<n.length;r++){var a=n[r];t[a.name]=e[a.name]}return t},t.prototype._allFeatures=function(){var e=this;return null==this.allf&&(this.allf=[],this._layer.graphics.forEach(function(t){e.allf.push(new a(!0===e._removeGeometry?null:t.geometry,null,e.cloneAttr(t.attributes)))})),this.allf},t.prototype.canBeBigDataFeatureSet=function(){return!1},t.prototype.shouldBeResolvedAsBigData=function(){return!1},t}(s)});