// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define(["require","exports","dojo/Deferred","dojo/promise/all","../../../graphic","../support/FeatureSet","../support/IdSet","../support/shared","../../../geometry/Geometry","../../../geometry/geometryEngineAsync","../../../geometry/jsonUtils","../../../layers/Field"],function(e,t,r,n,o,i,a,s,l,u,c,p){"use strict";return function(e){function t(t){var r=e.call(this,t)||this;return r.source=[],t.spatialReference&&(r.spatialReference=t.spatialReference),r.types=t.types,r.geometryType=t.geometryType,r.typeIdField=t.typeIdField,r.objectIdField=t.objectIdField,r.fields=t.fields.slice(0),r.source=t.source,r._transparent=!0,r._maxProcessing=1e3,r._wset=null,r}return __extends(t,e),t.prototype._maxQueryRate=function(){return s.defaultMaxRecords},t.prototype.load=function(){if(null===this._loadPromise){var e=new r;this._loadPromise=e,this._initialiseFeatureSet(),e.resolve(this)}return this._loadPromise.promise},t.prototype._initialiseFeatureSet=function(){this._databaseType=s.FeatureServiceDatabaseType.Standardised},t.prototype.optimisePagingFeatureQueries=function(e){},t.prototype._allFeatures=function(){return this.source},t.prototype._isInFeatureSet=function(e){return s.IdState.InFeatureSet},t.prototype.isTable=function(){return null===this.geometryType||""===this.geometryType},t.prototype._transformSetWithIdChanges=function(e){},t.prototype._candidateIdTransform=function(e){return e},t.prototype._getSet=function(e){var t=this,n=new r;return null===this._wset?this._ensureLoaded().then(s.callback(function(){t._getFilteredSet("",null,null,null,e).then(function(e){t._wset=e,n.resolve(e)},s.errback(n))},n),s.errback(n)):n.resolve(this._wset),n.promise},t.prototype._getFilteredSet=function(e,t,n,o,i){var l=this,u=new r;try{this._ensureLoaded().then(s.callback(function(){if(l.isTable()&&t&&null!==e&&""!==e){var r=new a([],[],!0,null);return void u.resolve(r)}if(null===l._wset){var o=[];l._allFeatures().forEach(function(e){void 0===e.geometry&&(e.geometry=null);var t=e.attributes[l.objectIdField];o.push(t),l._featureCache[t]=e}),l._wset=new a([],o,!1,null)}var c=l._wset._known.slice(0);l._checkCancelled(i),l.fetchAndRefineFeaturesByWhere(c,n,i).then(s.callback(function(r){l._checkCancelled(i),null!==t?l.fetchAndRefineFeaturesSpatially(r,t,e,i).then(s.callback(function(e){u.resolve(new a([],e,!1,null))},u),s.errback(u)):u.resolve(new a([],r,!1,null))},u),s.errback(u))},u),s.errback(u))}catch(e){u.reject(e)}return u.promise},t.prototype.executeSpatialRelationTest=function(e,t,n,o){if(null===e.geometry){var i=new r;return i.resolve(!1),i.promise}switch(t){case"esriSpatialRelEnvelopeIntersects":var a=s.shapeExtent(n),l=s.shapeExtent(e.geometry);return u.intersects(a,l);case"esriSpatialRelIntersects":return u.intersects(n,e.geometry);case"esriSpatialRelContains":return u.contains(n,e.geometry);case"esriSpatialRelOverlaps":return u.overlaps(n,e.geometry);case"esriSpatialRelWithin":return u.within(n,e.geometry);case"esriSpatialRelTouches":return u.touches(n,e.geometry);case"esriSpatialRelCrosses":return u.crosses(n,e.geometry);case"esriSpatialRelRelation":return u.relate(n,e.geometry,o)}},t.prototype.executeWhereTest=function(e,t){return t.testFeature(e)},t.prototype.fetchAndRefineFeaturesSpatially=function(e,t,o,i){var a=new r,l=[],u=[],c="";o.indexOf("esriSpatialRelRelation")>=0&&(c=o.split(":")[1],o="esriSpatialRelRelation");for(var p=0;p<e.length;p++){var f=this._featureFromCache(e[p]);u.push(this.executeSpatialRelationTest(f,o,t,c))}return 0===u.length?(a.resolve(l),a.promise):(n(u).then(s.callback(function(t){for(var r=0;r<e.length;r++)!0===t[r]&&l.push(e[r]);a.resolve(l)},a),s.errback(a)),a.promise)},t.prototype.fetchAndRefineFeaturesByWhere=function(e,t,n){var o=new r,i=[];if(null===t)o.resolve(e);else{for(var a=0;a<e.length;a++){var s=this._featureFromCache(e[a]);this.executeWhereTest(s,t)&&i.push(e[a])}o.resolve(i)}return o.promise},t.prototype._getFeatures=function(e,t,n,o){var i=new r,a=[];-1!==t&&void 0===this._featureCache[t]&&a.push(t);for(var s=e._lastFetchedIndex;s<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[s]]&&(e._known[s]!==t&&a.push(e._known[s]),a.length>n)));s++);return 0===a.length?i.resolve("success"):i.reject(new Error("Unaccounted for Features. Not in Feature Collection")),i.promise},t.prototype._refineSetBlock=function(e,t,n){var o=new r;return o.resolve(e),o.promise},t.prototype._stat=function(e,t,n,o,i,a,s){var l=new r;return l.resolve({calculated:!1}),l.promise},t.prototype._canDoAggregates=function(e,t,n,o,i){var a=new r;return a.resolve(!1),a.promise},t._cloneAttr=function(e){var t={};for(var r in e)t[r]=e[r];return t},t.create=function(e,r){var n=r.toJson(),i=e.layerDefinition.objectIdField,a=e.layerDefinition.geometryType;void 0===a&&(a=e.featureSet.geometryType),void 0===a&&(a="");var s=e.featureSet.features;if(""===i||void 0===i){for(var u=!1,f=0,y=e.layerDefinition.fields;f<y.length;f++){var h=y[f];if("oid"===h.type||"esriFieldTypeOID"===h.type){i=h.name,u=!0;break}}if(!1===u){for(var d="FID",v=!0,_=0;v;){for(var g=!0,m=0,F=e.layerDefinition.fields;m<F.length;m++){var h=F[m];if(h.name===d){g=!1;break}}!0===g?v=!1:(_++,d="FID"+_.toString())}e.layerDefinition.fields.push({type:"esriFieldTypeOID",name:d,alias:d});for(var S=[],w=0;w<s.length;w++)S.push({geometry:e.featureSet.features[w].geometry,attributes:e.featureSet.features[w].attributes?this._cloneAttr(e.featureSet.features[w].attributes):{}}),S[w].attributes[d]=w;s=S,i=d}}for(var b=[],R=0,I=e.layerDefinition.fields;R<I.length;R++){var h=I[R];h instanceof p?b.push(h):b.push(new p(h))}for(var k=[],T=0,x=s;T<x.length;T++){var h=x[T];h.geometry&&h.geometry instanceof l==!1&&void 0===h.geometry.spatialReference&&(h.geometry.spatialReference=n),k.push(new o(null===h.geometry||void 0===h.geometry?null:c.fromJson(h.geometry),null,h.attributes))}return new t({source:k,types:e.types,typeIdField:e.typeIdField,fields:b,objectIdField:i,geometryType:a,spatialReference:r})},t.prototype.canBeBigDataFeatureSet=function(){return!1},t.prototype.shouldBeResolvedAsBigData=function(){return!1},t}(i)});