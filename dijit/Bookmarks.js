// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define(["dojo/_base/array","dojo/_base/connect","dojo/_base/declare","dojo/_base/lang","dojo/has","dojo/keys","dojo/on","dojo/query","dojo/window","dojo/dom","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dnd/Avatar","dojo/dnd/Source","dojo/i18n!../nls/jsapi","dijit/a11yclick","dijit/_WidgetBase","../kernel","../domUtils","../Evented","../geometry/Extent","./BookmarkItem"],function(e,o,t,i,s,r,n,a,d,h,k,m,c,l,u,_,p,B,b,f,x,v,g){var N=t([B,x],{declaredClass:"esri.dijit.Bookmarks",bookmarks:[],bookmarkDomNode:null,bookmarkTable:null,initBookmarks:null,editable:null,map:null,_oldGenerateText:null,_customGenerateText:!1,_LTR:!0,_dndSource:null,_inputBox:null,_label:null,_css:{esriBookmarks:"esriBookmarks",esriBookmarksRTL:"esriBookmarksRTL",esriBookmarkList:"esriBookmarkList",esriBookmarkTable:"esriBookmarkTable",esriBookmarkEditImage:"esriBookmarkEditImage",esriBookmarkRemoveImage:"esriBookmarkRemoveImage",esriBookmarkLabel:"esriBookmarkLabel",esriBookmarkItem:"esriBookmarkItem",esriBookmarkHighlight:"esriBookmarkHighlight",esriAddBookmark:"esriAddBookmark",esriBookmarkEditBox:"esriBookmarkEditBox"},_clickHandlers:[],_mouseOverHandlers:[],_mouseOutHandlers:[],_removeHandlers:[],_editHandlers:[],_dndHandlers:[],_eventMap:{click:!0,edit:!0,remove:!0},onClick:function(){},onEdit:function(){},onRemove:function(){},constructor:function(e,o){this.map=e.map,this.editable=e.editable,this.initBookmarks=e.bookmarks,delete e.bookmarks,this.bookmarkDomNode=m.create("div"),k.add(this.bookmarkDomNode,this._css.esriBookmarkList),this.bookmarkTable=m.create("div"),k.add(this.bookmarkTable,this._css.esriBookmarkTable),this.bookmarkDomNode.appendChild(this.bookmarkTable),o=h.byId(o),o.appendChild(this.bookmarkDomNode),this.srcNodeRef=o,k.add(this.srcNodeRef,this._css.esriBookmarks),this._LTR=this.isLeftToRight(),this._LTR||k.add(this.srcNodeRef,this._css.esriBookmarksRTL),this._dndSource=new u(this.bookmarkTable,{creator:this._avatarCreator,singular:!0,checkAcceptance:function(e,o){return this===e?!0:!1}}),this._dndSourceNodes=this._dndSource.getAllNodes(),this._dndHandlers.push(n(this._dndSource,"DndStart",i.hitch(this,function(e){e===this._dndSource&&(this._oldGenerateText=l.prototype._generateText,l.prototype._generateText=i.hitch(this,this._generateText),this._customGenerateText=!0,this._inputBox&&this._inputBox.blur())}))),this._dndHandlers.push(n(this._dndSource,"DndDrop",i.hitch(this,function(e){e===this._dndSource&&(this._syncBookmarksAfterReorder(),this.emit("reorder",this.bookmarks))}))),this._dndHandlers.push(n(this._dndSource,"DndCancel",i.hitch(this,function(){this._customGenerateText&&(l.prototype._generateText=this._oldGenerateText,this._customGenerateText=!1)}))),this._addInitialBookmarks()},destroy:function(){this.map=null,e.forEach(this._clickHandlers,function(e){o.disconnect(e)}),e.forEach(this._mouseOverHandlers,function(e){o.disconnect(e)}),e.forEach(this._mouseOutHandlers,function(e){o.disconnect(e)}),e.forEach(this._removeHandlers,function(e){o.disconnect(e)}),e.forEach(this._editHandlers,function(e){o.disconnect(e)}),m.destroy(this.bookmarkDomNode)},addBookmark:function(e){var t,s,r,n,h,c,l,u,B,b;"esri.dijit.BookmarkItem"===e.declaredClass?t=e:(s=new v(e.extent),t=new g({name:e.name,extent:s})),this.editable?(n=_.widgets.bookmarks,h=n.NLS_bookmark_edit,c=n.NLS_bookmark_remove,r=m.create("div",{innerHTML:'<div tabindex="0" role="button" class=\'esriBookmarkLabel\'>'+e.name+'</div><div tabindex="0" role="button" title=\''+c+"' class='esriBookmarkRemoveImage'><br/></div><div tabindex=\"0\" role=\"button\" title='"+h+"' class='esriBookmarkEditImage'><br/></div>"}),l=a(".esriBookmarkEditImage",r)[0],u=a(".esriBookmarkRemoveImage",r)[0],this._removeHandlers.push(o.connect(u,p,this,"_removeBookmark")),this._editHandlers.push(o.connect(l,p,this,"_editBookmarkLabel"))):r=m.create("div",{innerHTML:"<div tabindex=\"0\" class='esriBookmarkLabel'>"+e.name+"</div>"}),k.add(r,this._css.esriBookmarkItem),B="esri.geometry.Extent"===e.extent.declaredClass?e.extent:new v(e.extent),b=a(".esriBookmarkLabel",r)[0],this._clickHandlers.push(o.connect(b,p,i.hitch(this,"_onClickHandler",e))),this._mouseOverHandlers.push(o.connect(r,"onmouseover",i.hitch(this,function(){k.add(r,this._css.esriBookmarkHighlight)}))),this._mouseOutHandlers.push(o.connect(r,"onmouseout",i.hitch(this,function(){k.remove(r,this._css.esriBookmarkHighlight)}))),this.bookmarks.push(t),this._dndSource.insertNodes(!1,[r]),this._dndSourceNodes=this._dndSource.getAllNodes(),d.scrollIntoView(r),this._syncBookmarksAfterReorder()},removeBookmark:function(o){this._inputBox&&this._inputBox.blur();var t,i=a(".esriBookmarkLabel",this.bookmarkDomNode),s=e.filter(i,function(e){return e.innerHTML===o});for(e.forEach(s,function(e){e.parentNode.parentNode.parentNode.removeChild(e.parentNode.parentNode)}),t=this.bookmarks.length-1;t>=0;t--)this.bookmarks[t].name===o&&this.bookmarks.splice(t,1);this.onRemove()},hide:function(){f.hide(this.bookmarkDomNode)},show:function(){f.show(this.bookmarkDomNode)},_addInitialBookmarks:function(){if(this.editable){var t=_.widgets.bookmarks,s=t.NLS_add_bookmark,r=m.create("div",{tabIndex:0,role:"button",innerHTML:"<div>"+s+"</div>"});k.add(r,this._css.esriBookmarkItem),k.add(r,this._css.esriAddBookmark),this._clickHandlers.push(o.connect(r,p,this,this._newBookmark)),this._mouseOverHandlers.push(o.connect(r,"onmouseover",i.hitch(this,function(){k.add(r,this._css.esriBookmarkHighlight)}))),this._mouseOutHandlers.push(o.connect(r,"onmouseout",i.hitch(this,function(){k.remove(r,this._css.esriBookmarkHighlight)}))),this.srcNodeRef.appendChild(r)}this.bookmarks=[],e.forEach(this.initBookmarks,function(e){this.addBookmark(e)},this)},_newBookmark:function(){var e,o,t,i,s,r,n,d,h,k,m,c,l=this.map,u=_.widgets.bookmarks,p=u.NLS_new_bookmark,B=l.extent;l.spatialReference._isWrappable()?(o=v.prototype._normalizeX(B.xmin,l.spatialReference._getInfo()).x,t=v.prototype._normalizeX(B.xmax,l.spatialReference._getInfo()).x,o>t?(d=l.spatialReference.isWebMercator(),i=d?20037508.342788905:180,s=d?-20037508.342788905:-180,Math.abs(o-i)>Math.abs(t-s)?(r=o,n=i):(r=s,n=t),c=new v(r,B.ymin,n,B.ymax,l.spatialReference)):c=new v(o,B.ymin,t,B.ymax,l.spatialReference)):c=B,h=new g({name:p,extent:c}),this.addBookmark(h),k=a(".esriBookmarkItem",this.bookmarkDomNode),m=k[k.length-1],e={target:{parentNode:null}},e.target.parentNode=m,this._editBookmarkLabel(e)},_removeBookmark:function(e){e.target.parentNode.parentNode.parentNode.removeChild(e.target.parentNode.parentNode),this.removeBookmark(e.target.parentNode.textContent)},_syncBookmarksAfterReorder:function(){var o=[],t=this._dndSource.getAllNodes();e.forEach(t,i.hitch(this,function(e){var t=this._dndSourceNodes.map(function(o,t){return o===e?t:void 0}).filter(isFinite)[0];o.push(this.bookmarks[t])})),this.bookmarks=o,this._dndSourceNodes=t},_generateText:function(){return this._dndSource&&this._dndSource.getSelectedNodes()[0]&&this._dndSource.getSelectedNodes()[0].firstChild.firstChild.innerHTML?this._dndSource.getSelectedNodes()[0].firstChild.firstChild.innerHTML:""},_editBookmarkLabel:function(e){this._inputBox&&this._inputBox.blur();var o,t,s,d=_.widgets.bookmarks,h=d.NLS_new_bookmark,k=e.target.parentNode,l=k.firstChild||a(".esriBookmarkLabel",k)[0],u=c.position(k,!0),p=u.y;this._label=l,s=l.innerHTML!==h?l.textContent:"",t={top:p+"px",left:this._LTR?u.x+"px":"0px"},this._inputBox=m.create("input",{className:"esriBookmarkEditBox",value:s,style:t},this.srcNodeRef),n(this._inputBox,"keyup",i.hitch(this,function(e){switch(e.keyCode){case r.ENTER:this._inputBox.blur()}})),n(this._inputBox,"blur",i.hitch(this,this._finishEdit)),this._inputBox.focus(),this._inputBox.select(),o=c.position(k,!0),this._inputBox.style.left=this._LTR?o.x+"px":"0px",this._inputBox.style.top=o.y+"px"},_finishEdit:function(){if(this._inputBox){var o=_.widgets.bookmarks,t=o.NLS_new_bookmark,i=a(".esriBookmarkLabel",this.bookmarkDomNode),s=this._inputBox.value;if(s===this._label.innerHTML)return this._inputBox.parentNode.removeChild(this._inputBox),void(this._inputBox=null);this._label.textContent=""!==s?s:t,e.forEach(this.bookmarks,function(e,o){e&&i[o]&&(e.name=i[o].innerHTML)}),this._inputBox.parentNode.removeChild(this._inputBox),this._inputBox=null,this.onEdit()}},_avatarCreator:function(e,o){var t=m.create("div");return t.id=dojo.dnd.getUniqueId(),k.add(t,"dojoDndItem"),"avatar"!==o&&m.place(e,t),{node:t,data:e,type:"something"}},_onClickHandler:function(e){var o=e.extent;e.extent.declaredClass||(o=new v(e.extent)),this.map.setExtent(o),this.onClick()},toJson:function(){var o=[];return e.forEach(this.bookmarks,function(e){e&&o.push(e.toJson())}),o}});return s("extend-esri")&&i.setObject("dijit.Bookmarks",N,b),N});