// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.17/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/kernel","dojo/_base/array","dojo/_base/Color","dijit/a11yclick","dijit/_TemplatedMixin","dijit/form/Select","dijit/form/ValidationTextBox","dojo/store/Memory","dojo/data/ObjectStore","dojo/keys","dojo/has","dojo/on","dojo/mouse","dojo/dom","dojo/dom-geometry","dojo/dom-style","dojo/dom-class","dojo/dom-attr","dojo/query","dojo/number","dojo/i18n!../nls/jsapi","dojo/text!./templates/Directions.html","./Search","dojo/dom-construct","dojo/promise/all","dojo/Deferred","dojo/dnd/Source","dojo/json","../kernel","../graphic","../units","../InfoTemplate","../SpatialReference","../layers/ArcGISDynamicMapServiceLayer","../layers/GraphicsLayer","../geometry/webMercatorUtils","../geometry/geodesicUtils","../arcgis/utils","../geometry/Point","../geometry/Extent","../geometry/Polyline","../geometry/mathUtils","../symbols/SimpleMarkerSymbol","../symbols/PictureMarkerSymbol","../symbols/CartographicLineSymbol","../symbols/TextSymbol","../symbols/Font","./_EventedWidget","../tasks/FeatureSet","../tasks/RouteTask","../tasks/RouteParameters","../tasks/GeometryService","../tasks/DistanceParameters","../tasks/PrintTask","../tasks/PrintParameters","../tasks/PrintTemplate","../toolbars/edit","../config","../tasks/ProjectParameters","dojo/uacss"],function(t,e,s,i,o,r,n,a,h,c,u,l,d,p,_,m,g,f,v,S,y,w,b,T,C,M,L,N,D,R,x,P,A,E,I,O,k,U,W,B,G,j,F,q,H,V,K,z,J,$,Q,Z,Y,X,te,ee,se,ie,oe,re,ne,ae){var he=e("esri.dijit.Directions",[Q,a],{templateString:C,mapClickActive:!1,_eventMap:{activate:!0,deactivate:!1,load:!0,"directions-start":!0,"directions-finish":["result"],"directions-clear":!0,"segment-select":["graphic"],"segment-highlight":["graphic"],error:["error"],"stops-update":["stops"],"route-item-created":!0,"route-item-updated":!0,"feature-collection-created":!0},_emptyStop:{name:""},constructor:function(e,i){if(!e.map)throw Error('Required "map" parameter is missing. Cannot instantiate Directions Widget.');if(!i)throw Error('Required "srcNodeRef" parameter is missing. Cannot instantiate Directions Widget.');this._i18n=T,this._css={widgetContainerClass:"esriDirectionsContainer",searchSourceContainerClass:"esriSearchSourceContainer",stopsContainerClass:"esriStopsContainer",stopsTableContainerClass:"esriStopsTableContainer",stopsTableCoverClass:"esriStopsTableCover",reverseStopsClass:"esriStopsReverse",addStopsClass:"esriStopsAdd",stopsClass:"esriStops",stopsRemovableClass:"esriStopsRemovable",stopsButtonContainerClass:"esriStopsButtons",stopsOptionsButtonClass:"esriStopsOptionsButton",stopsAddDestinationClass:"esriStopsAddDestination",stopsAddDestinationBtnClass:"esriStopsAddDestinationBtn",stopsGetDirectionsContainerClass:"esriStopsGetDirectionsContainer",stopsGetDirectionsClass:"esriStopsGetDirections",stopsClearDirectionsClass:"esriStopsClearDirections",stopsInnerGeocoderClass:"esriInnerGeocoder",stopsOptionsOptionsEnabledClass:"esriStopsOptionsEnabled",stopsOptionsMenuClass:"esriStopsOptionsMenu",stopsFindOptimalOrderClass:"esriFindOptimalOrderOption",stopsUseTrafficClass:"esriUseTrafficOption",stopsReturnToStartClass:"esriReturnToStartOption",stopsOptionsCheckboxesClass:"esriOptionsCheckboxes",stopsOptionsToggleContainerClass:"esriOptionsToggleContainer",stopsOptionsUnitsContainerClass:"esriOptionsUnitsContainer",stopsOptionsUnitsMiClass:"esriOptionsUnitsMi",stopsOptionsUnitsKmClass:"esriOptionsUnitsKm",stopsOptionsImpedanceContainerClass:"esriOptionsImpedanceContainer",stopsOptionsImpedanceTimeClass:"esriOptionsImpedanceTime",stopsOptionsImpedanceDistanceClass:"esriOptionsImpedanceDistance",stopClass:"esriStop",stopOriginClass:"esriStopOrigin",stopDestinationClass:"esriStopDestination",stopUnreachedFirstOrLastClass:"esriStopUnreachedFirstOrLast",stopUnreachedClass:"esriStopUnreached",esriStopGeocoderColumnClass:"esriStopGeocoderColumn",esriStopReverseColumnClass:"esriStopReverseColumn",stopDnDHandleClass:"esriStopDnDHandle",stopDnDHandleClassHidden:"esriStopDnDHandleHidden",stopIconColumnClass:"esriStopIconColumn",stopIconClass:"esriStopIcon",stopIconRemoveColumnClass:"esriStopIconRemoveColumn",stopIconRemoveClass:"esriStopIconRemove",stopIconRemoveClassHidden:"esriStopIconRemoveHidden",resultsContainerClass:"esriResultsContainer",resultsLoadingClass:"esriResultsLoading",resultsPrintClass:"esriResultsPrint",resultsSaveClass:"esriResultsSave",resultsSummaryClass:"esriResultsSummary",resultsViewFullRouteClass:"esriResultsViewFullRoute",resultsRouteNameClass:"esriResultsRouteName",resultsRouteButtonContainerClass:"esriResultsButtonsContainer",routesContainerClass:"esriRoutesContainer",routesClass:"esriRoutes",routesErrorClass:"esriRoutesError",routesInfoClass:"esriRoutesInfo",routeClass:"esriRoute",routeTextColumnClass:"esriRouteTextColumn",routeTextClass:"esriRouteText",routeLengthClass:"esriRouteLength",routeOriginClass:"esriDMTStopOrigin",routeDestinationClass:"esriDMTStopDestination",routeLastClass:"esriDMTStopLast",routeInfoClass:"esriRouteInfo",routeIconColumnClass:"esriRouteIconColumn",routeIconClass:"esriRouteIcon",infoWindowRouteClass:"esriInfoWindowRoute",routeZoomClass:"esriRouteZoom",esriPrintPageClass:"esriPrintPage",esriPrintBarClass:"esriPrintBar",esriPrintButtonClass:"esriPrintButton",esriCloseButtonClass:"esriCloseButton",esriPrintMainClass:"esriPrintMain",esriPrintHeaderClass:"esriPrintHeader",esriPrintLogoClass:"esriPrintLogo",esriPrintMapClass:"esriPrintMap",esriPrintNameClass:"esriPrintName",esriPrintNotesClass:"esriPrintNotes",esriPrintLengthClass:"esriPrintLength",esriPrintDirectionsClass:"esriPrintDirections",esriPrintFooterClass:"esriPrintFooter",esriPrintStopLabelClass:"esriPrintStopLabel",clearClass:"esriClear",dndDragBodyClass:"esriDndDragDirection",stopsButtonClass:"esriDirectionsButton",stopsButtonTabClass:"esriDirectionsTabButton",stopsButtonTabLastClass:"esriDirectionsTabLastButton",stopsPressedButtonClass:"esriDirectionsPressedButton",linkButtonClass:"esriLinkButton",activateButtonClass:"esriActivateButton",travelModesContainerClass:"esriTravelModesContainer"},this.options={map:null,autoSolve:!0,minStops:2,maxStops:20,theme:"simpleDirections",alphabet:"1234567890",directions:null,returnToStart:!1,optimalRoute:!1,routeTaskUrl:location.protocol+"//route.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",printTaskUrl:location.protocol+"//utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task",geometryTaskUrl:location.protocol+"//utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",routeParams:{},stops:["",""],searchOptions:{},stopsInfoTemplate:new I(T.widgets.directions.stop,"${address}${error}"),waypointInfoTemplate:new I(T.widgets.directions.maneuver,T.widgets.directions.waypoint),segmentInfoTemplate:new I(T.widgets.directions.maneuver,'<div class="${maneuverType}"><div class="'+this._css.routeIconClass+" "+this._css.infoWindowRouteClass+'"><strong>${step}.</strong> ${formattedText}</div></div>'),textSymbolFont:new $("11px",$.STYLE_NORMAL,$.VARIANT_NORMAL,$.WEIGHT_NORMAL,"Arial, Helvetica, sans-serif"),textSymbolColor:new r([255,255,255]),textSymbolOffset:{x:0,y:10.875},fromSymbol:new K({url:t.toUrl("./images/Directions/greenPoint.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),fromSymbolDrag:new K({url:t.toUrl("./images/Directions/greenPointMove.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),stopSymbol:new K({url:t.toUrl("./images/Directions/bluePoint.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),stopSymbolDrag:new K({url:t.toUrl("./images/Directions/bluePointMove.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),toSymbol:new K({url:t.toUrl("./images/Directions/redPoint.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),toSymbolDrag:new K({url:t.toUrl("./images/Directions/redPointMove.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),unreachedSymbol:new K({url:t.toUrl("./images/Directions/grayPoint.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),unreachedSymbolDrag:new K({url:t.toUrl("./images/Directions/grayPointMove.png"),height:21.75,width:15.75,type:"esriPMS"}).setOffset(0,10.875),waypointSymbol:new V({color:[255,255,255,255],size:10,type:"esriSMS",style:"esriSMSCircle",outline:{color:[20,89,127,255],width:2.5,type:"esriSLS",style:"esriSLSSolid"}}),maneuverSymbol:new V({color:[255,255,255,255],size:4,type:"esriSMS",style:"esriSMSCircle",outline:{color:[30,99,137,255],width:1,type:"esriSLS",style:"esriSLSSolid"}}),routeSymbol:(new z).setColor(new r([20,89,127,1])).setWidth(10).setCap(z.CAP_ROUND).setJoin(z.JOIN_ROUND),segmentSymbol:(new z).setColor(new r([255,255,255,1])).setWidth(6).setCap(z.CAP_ROUND).setJoin(z.JOIN_ROUND),printPage:"",printTemplate:"",focusOnNewStop:!0,dragging:!0,canModifyStops:!0,canModifyWaypoints:!0,directionsLengthUnits:null,directionsLanguage:null,traffic:!1,trafficLayer:null,showPrintPage:!0,showSaveButton:!1,showSegmentPopup:!1,showSegmentHighlight:!0,showReverseStopsButton:!0,showReturnToStartOption:!0,showOptimalRouteOption:!0,showTravelModesOption:!0,showMilesKilometersOption:!0,showClearButton:!1,showActivateButton:!0,loaded:!1,routeLayer:{itemId:null,title:null,isItemOwner:!0,ownerFolder:null}};var o={_waypointName:"DWWP",_solveInProgress:!1,_moveInProgress:!1,_stopSequence:1e3};if(this.defaults=s.mixin({},this.options,e,o),(!this.defaults.minStops||this.defaults.minStops<2)&&(this.defaults.minStops=2),this.defaults.minStops>2&&this.defaults.stops&&","===this.defaults.stops.toString())for(var n=2;n<this.defaults.minStops;n++)this.defaults.stops.splice(0,0,"");this.domNode=i},postCreate:function(){this.inherited(arguments),this.own(_(this._activateButtonNode,n,s.hitch(this,function(){this.mapClickActive?this.deactivate():this.activate()}))),this.own(_(this._addDestinationNode,n,s.hitch(this,this._addStopButton))),this.own(_(this._optionsButtonNode,n,s.hitch(this,this._toggleOptionsMenu))),this.own(_(this._saveMenuButton,n,s.hitch(this,this._toggleSaveMenu))),this.own(_(this._saveButton,n,s.hitch(this,function(){this._saveButton._enabled&&this._storeRouteUI()}))),this.own(_(this._saveAsButton,n,s.hitch(this,function(){s.mixin(this.routeLayer,{itemId:null,title:null,ownerFolder:null}),this._storeRouteUI()}))),this.own(_(this._findOptimalOrderNode,n,s.hitch(this,this._toggleCheckbox))),this.own(_(this._returnToStartNode,n,s.hitch(this,this._toggleCheckbox))),this.own(_(this._useTrafficNode,n,s.hitch(this,this._toggleCheckbox))),this.own(_(this._useMilesNode,n,s.hitch(this,this._toggleUnits))),this.own(_(this._useKilometersNode,n,s.hitch(this,this._toggleUnits))),this.own(_(this._getDirectionsButtonNode,n,s.hitch(this,this.getDirections))),this.own(_(this._clearDirectionsButtonNode,n,s.hitch(this,function(){this.clearDirections()}))),this._symbolEventPaddingDirections=(new z).setColor(new r([0,255,0,0])).setWidth(20).setCap(z.CAP_ROUND),this._stopLayer=new U({id:"directions_stopLayer_"+this.id,displayOnPan:!0}),this._routeLayer=new U({id:"directions_routeLayer_"+this.id,displayOnPan:!0}),this._waypointsEventLayer=new U({id:"directions_waypointsEventLayer_"+this.id,displayOnPan:!0}),this.map.addLayer(this._routeLayer),this.map.addLayer(this._stopLayer),this._snappingManager=this.map.enableSnapping({layerInfos:[{layer:this._waypointsEventLayer,snapToVertex:!1,snapToPoint:!0,snapToEdge:!0}],tolerance:15}),this._setWidgetProperties();var t=new A(null,this.waypointSymbol,{}),e=s.hitch(this,function(){this._moveInProgress||this._solveInProgress||!t._isShown()||(this.editToolbar.deactivate(),this._stopLayer.remove(t),clearTimeout(t._solveTimeout),t._solveTimeout=null,t.attributes.isWaypoint=!0,t._isStopIcon&&this.stopGraphics[t._index]&&(this._stopLayer.add(this.stopGraphics[t._index]),this._stopLayer.add(this.textGraphics[t._index]))),t._showTooltip()});this._handle=s.mixin(t,{_isHandle:!0,_tooltip:L.create("div",{className:this.theme+" esriDirectionsRouteTooltip",onmouseover:e},this.map.container),_showTooltip:s.hitch(this,function(e){t._tooltip.style.display=!e||e instanceof MouseEvent?"none":"inline",e&&(e="string"==typeof e?e:"<table class='esriRoutesTooltip'>"+this._renderDirectionsItemTR(e)+"</table>",t._tooltip.innerHTML!==e&&(t._tooltip.innerHTML=e))}),_isShown:s.hitch(this,function(){return o.indexOf(this._stopLayer.graphics,t)>-1}),_remove:e}),this._activate(this.mapClickActive)},startup:function(){return this.inherited(arguments),this._enqueue(this._init)},destroy:function(){this.deactivate(),this.map.removeLayer(this._routeLayer),this.map.removeLayer(this._stopLayer),this.map.removeLayer(this._waypointsEventLayer),this._disconnectEvents(),L.empty(this.domNode),this.inherited(arguments)},activate:function(){return this._enqueue(function(){this.set("mapClickActive",!0)})},deactivate:function(){return this._enqueue(function(){this.set("mapClickActive",!1)})},clearDirections:function(){return this._enqueue(function(){return this.clearMessages(),this._clearDirections()})},reset:function(){return this._enqueue(this._reset)},modifyStopSequence:function(t,e){return this._enqueue(function(){return this._modifyStopSequence(t,e)})},onActivate:function(){},onDeactivate:function(){},onLoad:function(){this._enableButton(this._getDirectionsButtonNode)},onDirectionsStart:function(){this._clearDisplayBeforeSolve(),this.set("solving",!0),this._showLoadingSpinner(!0)},onDirectionsFinish:function(){this._showLoadingSpinner(!1),this.set("solving",!1)},onDirectionsClear:function(){},onSegmentSelect:function(){},onSegmentHighlight:function(){},onStopsUpdate:function(){},onRouteItemCreated:function(){},onRouteItemUpdated:function(){},onFeatureCollectionCreated:function(){},onError:function(){},removeStops:function(){return this.reset()},removeStop:function(t,e,s){return this._enqueue(function(){return this.clearMessages(),this._removeStop(t,e,s)})},updateStops:function(t){return this._enqueue(function(){return this._updateStops(t)})},addStops:function(t,e){return this._enqueue(function(){return this._addStops(t,e)}).then(s.hitch(this,this.zoomToFullRoute))},addStop:function(t,e){return this._enqueue(function(){return this._addStop(t,e)},{_incrementalSolveStopRange:this._incrementalSolveStopRange})},updateStop:function(t,e,s){return this._enqueue(function(){return this._updateStop(t,e,s)},{_incrementalSolveStopRange:this._incrementalSolveStopRange})},clearMessages:function(){this.messages=[],this._msgNode&&(this._msgNode.innerHTML="")},getDirections:function(t){return this._enqueue(function(){return this._getDirections().then(s.hitch(this,function(){t!==!0&&this.zoomToFullRoute()}))})},selectSegment:function(t){if(!(!this.directions||!this.directions.features||0>t||t>=this.directions.features.length))for(var e=w("[data-segment]",this._resultsNode),s=0;s<e.length;s++){var i=parseInt(y.get(e[s],"data-segment"),10);if(t===i&&e[s]!==this._focusedDirectionsItem){this._focusedDirectionsItem=e[s],this.centerAtSegmentStart(t),this.onSegmentSelect(this.directions.features[t]),e[s].focus();break}}},unhighlightSegment:function(t){var e=this._segmentGraphics;if(e&&(!this._focusedDirectionsItem||t)){for(var s=0;s<e.length;s++)this._routeLayer.remove(e[s]);this._segmentGraphics=[]}},highlightSegment:function(t,e){if(!(this._focusedDirectionsItem&&!e||t>=this.directions.features.length)){t=t||0;var i=s.hitch(this,function(t){var e=this.map.toMap({x:0,y:0});return this.map.toScreen(e.offset(t,0)).x}),o=s.hitch(this,function(t){for(var e=0,s=0;s<t.length;s++)for(var o=1;o<t[s].length;o++){var r=t[s][o-1],n=t[s][o];e+=i(Math.sqrt((r[0]-n[0])*(r[0]-n[0])+(r[1]-n[1])*(r[1]-n[1])))}return e}),n=s.hitch(this,function(t){var e=this.map.toMap({x:0,y:0});return this.map.toMap({x:t,y:0}).x-e.x}),a=function(t,e,s){e=Math.max(1,e);for(var o,r,n,a,h=s?t[0].length-1:0,c=0,u=[[t[0][s?h:0]]];s&&h>0||!s&&h<t[0].length-1;){if(r=t[0][s?h-1:h],n=t[0][s?h:h+1],o=i(Math.sqrt((r[0]-n[0])*(r[0]-n[0])+(r[1]-n[1])*(r[1]-n[1])))){if(!(e>c+o)){a=(e-c)/o,s?u[0].splice(0,0,[n[0]-(n[0]-r[0])*a,n[1]-(n[1]-r[1])*a]):u[0].push([r[0]+(n[0]-r[0])*a,r[1]+(n[1]-r[1])*a]);break}s?u[0].splice(0,0,r):u[0].push(n),c+=o}h+=s?-1:1}return c+o>0?u:t},h=this.get("directions").features[t],c=new q(h.geometry),u=50,l=15,d=22,p=40*Math.PI/180;if(s.mixin(h.attributes,{_index:t}),t){var _=a(this.get("directions").features[t-1].geometry.paths,u/2,!0),m="esriDMTStop"!==h.attributes.maneuverType?a(c.paths,u/2,!1):_,g=m!==_?[_[0].concat(m[0])]:m,f=new q(m).getExtent();if(m[0].length>1&&i(Math.max(f.getWidth(),f.getHeight()))>=l){for(var v,S=Math.cos(p/2)*l,y=Math.sin(p/2)*l,w=m[0].length-2,b=m[0][w+1],T=0;w>=0&&!T;)v=m[0][w],T=i(Math.sqrt((v[0]-b[0])*(v[0]-b[0])+(v[1]-b[1])*(v[1]-b[1]))),w--;if(d>T){var C=T+(d-T)/3,M=T+2*(d-T)/3,L=[b[0]-C/T*(b[0]-v[0]),b[1]-C/T*(b[1]-v[1])],N=[v[0]+M/T*(b[0]-v[0]),v[1]+M/T*(b[1]-v[1])];v=L,b=N,T=d}var D,R,x=S/T,P=[b[0]-(b[0]-v[0])*x,b[1]-(b[1]-v[1])*x];v[1]!==b[1]?(x=(b[0]-v[0])/(b[1]-v[1]),D=n(y/Math.sqrt(1+x*x)),R=x*D):(D=0,R=n(y)),1/0===Math.abs(D)||1/0===Math.abs(R)||isNaN(D)||isNaN(R)||(g[0].push(b),g[0].push([P[0]-D,P[1]+R]),g[0].push([P[0]+D,P[1]-R]),g[0].push(b))}else g=a(g,2*o(m),!0);c.paths=g}this.unhighlightSegment(this._segmentGraphics&&this._segmentGraphics.length);var E=s.clone(this.routeSymbol).setWidth(this.segmentSymbol.width).setColor(new r([parseInt(.9*this.segmentSymbol.color.r),parseInt(.9*this.segmentSymbol.color.g),parseInt(.9*this.segmentSymbol.color.b)]));this._segmentGraphics=[new A(h.geometry,E,h.attributes,this.get("segmentInfoTemplate")),new A(c,this.routeSymbol,h.attributes,this.get("segmentInfoTemplate")),new A(c,this.segmentSymbol,h.attributes,this.get("segmentInfoTemplate"))],this.get("showSegmentHighlight")&&(this._routeLayer.add(this._segmentGraphics[0]),this._routeLayer.add(this._segmentGraphics[1]),this._routeLayer.add(this._segmentGraphics[2]));var I=s.hitch(this,function(t){if(t>0&&t<this.directions.features.length)for(var e=this.directions.features[t]._associatedFeaturesWithWaypoints,s=0;s<e.length;s++)e[s]._associatedSnapFeature&&e[s]._associatedSnapFeature.getDojoShape()&&e[s]._associatedSnapFeature.getDojoShape().moveToFront()});I(t-1),I(t),this.onSegmentHighlight(this.directions.features[t])}},zoomToSegment:function(t){var e,i=new D;return this.directions&&this.directions.features?(e=Math.max(0,Math.min(this.directions.features.length-1,t||0)),this.map.setExtent(this.get("directions").features[e].geometry.getExtent(),!0).promise.always(s.hitch(this,function(){this.highlightSegment(e),i.resolve()}))):i.reject(new Error("No directions.")),i.promise},centerAtSegmentStart:function(t){var e,i=new D;if(this.directions&&this.directions.features){e=Math.max(0,Math.min(this.directions.features.length-1,t||0));var o=this.directions.features[e];this.map.centerAt(o.geometry.getPoint(0,0)).promise.always(s.hitch(this,function(){this.highlightSegment(e,!0),this._showSegmentPopup(o,e),i.resolve()}))}else i.reject(new Error("No directions."));return i.promise},zoomToFullRoute:function(){var t=new D;return this.directions&&this.directions.features?(this._clearInfoWindow(),this.unhighlightSegment(),this.get("map").setExtent(this.get("directions").extent,!0).promise.always(t.resolve)):t.reject(new Error("No directions.")),t.promise},setListIcons:function(){var t,e=this._dnd.getAllNodes();for(t=0;t<e.length;t++){var s=w("."+this._css.stopIconClass,e[t])[0];s&&(s.innerHTML=this._getLetter(t)),S.remove(e[t],this._css.stopOriginClass+" "+this._css.stopDestinationClass+" "+this._css.stopUnreachedClass+" "+this._css.stopUnreachedFirstOrLastClass);var i=this._getStopSymbol(this.stops[t]);i===this.fromSymbol?S.add(e[t],this._css.stopOriginClass):i===this.toSymbol?S.add(e[t],this._css.stopDestinationClass):i===this.unreachedSymbol&&S.add(e[t],this._css.stopUnreachedClass)}var o=w("[data-reverse-td]",this._dndNode)[0];L.destroy(o),this.get("showReverseStopsButton")&&L.create("td",{"data-reverse-td":"true",rowspan:e.length,className:this._css.esriStopReverseColumnClass,innerHTML:'<div role="button" class="'+this._css.reverseStopsClass+'" data-reverse-stops="true" title="'+T.widgets.directions.reverseDirections+'"></div>',onmouseover:function(t){t.stopPropagation()},onmouseout:function(t){t.stopPropagation()}},e[0])},addRouteSymbols:function(){if(this.stopGraphics.length){this._moveLayersToFront();for(var t=0;t<this.stopGraphics.length;t++)if(this.stopGraphics[t]&&(!this._handle._isShown()||this._handle._isShown()&&this._handle._index!==t)){this._stopLayer.add(this.stopGraphics[t]);var e=this.stopGraphics[t].getDojoShape();e&&e.moveToFront(),this._stopLayer.add(this.textGraphics[t]);var s=this.textGraphics[t].getDojoShape();s&&s.moveToFront()}this._moveInProgress&&!this._handle.attributes.isWaypoint&&this._handle.getDojoShape()&&this._handle.getDojoShape().moveToFront()}},createRouteSymbols:function(){this._clearStopGraphics();for(var t=this.stops,e=0;e<t.length;e++){var s=t[e];if(s&&s.feature){var i=s.feature.attributes,o=i?i.Status:void 0,r=null;this._isStopAWaypoint(s)||(r=new J(this._getLetter(e),this.get("textSymbolFont"),this.get("textSymbolColor")),this.get("textSymbolOffset")&&r.setOffset(this.get("textSymbolOffset").x,this.get("textSymbolOffset").y));var n=new A(s.feature.geometry,r,{address:s.name},this.get("stopsInfoTemplate"));n._isStopLabel=!0,n._index=e;var a=new A(s.feature.geometry,this._getStopSymbol(s),{address:s.name,Status:void 0===o?0:o,CurbApproach:i&&i.CurbApproach?i.CurbApproach:null,isWaypoint:this._isStopAWaypoint(s)},this.get(this._isStopAWaypoint(s)?"waypointInfoTemplate":"stopsInfoTemplate"));a._isStopIcon=!0,a._index=e,this.stopGraphics[e]=a,this.textGraphics[e]=n}}this.set("stopGraphics",this.stopGraphics),this.set("textGraphics",this.textGraphics),this.addRouteSymbols(),this.setListIcons()},setTravelMode:function(t){return this._enqueue(function(){return this.clearMessages(),this._travelModeSelector.setValue(t),this._setTravelMode(t)})},getSupportedTravelModeNames:function(){var t=[],e=this.serviceDescription;if(e&&e.supportedTravelModes&&e.supportedTravelModes.length)for(var s=e.supportedTravelModes,i=0;i<s.length;i++)t.push(s[i].name);return t},setDirectionsLengthUnits:function(){var t=1===arguments.length?arguments[0]:this.get("directionsLengthUnits");return this._enqueue(function(){return this.clearMessages(),this._setDirectionsLengthUnits(t)})},setDirectionsLanguage:function(){var t=1===arguments.length?arguments[0]:this.get("directionsLanguage");return this._enqueue(function(){return this.clearMessages(),this._setDirectionsLanguage(t)})},useMyCurrentLocation:function(t){return this.clearMessages(),this._createLocateButton(this.geocoders[t],!0,!0)},loadRoute:function(t){return this._enqueue(s.hitch(this,function(){return this._loadRoute(t)}))},_getStopsAttr:function(){return this.returnToStart&&this._returnToStartStop?this.stops.concat(this._returnToStartStop):this.stops},_reset:function(){var t=this.mapClickActive;return this._setWidgetProperties(),this._init().then(s.hitch(this,function(){this.mapClickActive=t,this._searchSourceSelector&&this._searchSourceSelector.setValue("all")}))},_activate:function(){var t=this.get("mapClickActive"),e=s.hitch(this,function(t){for(var e=t?[this.textGraphics,this.stopGraphics,this.displayedManeuverPointGraphics,this.displayedRouteGraphics]:[this.displayedRouteGraphics,this.displayedManeuverPointGraphics,this.stopGraphics,this.textGraphics],s=0;s<e.length;s++)for(var i=e[s],o=0;o<i.length;o++){var r=i[o].getDojoShape();r&&r[t?"moveToBack":"moveToFront"].call(r)}});this._addStopOnMapClickListener&&this._addStopOnMapClickListener.remove(),t?(this.map.activeDirectionsWidget&&this.map.activeDirectionsWidget!==this&&this.map.activeDirectionsWidget.deactivate(),this.map.activeDirectionsWidget=this,this._addStopOnMapClickListener=_(this.map,"click",s.hitch(this,function(t){this.canModifyStops&&!this._solveInProgress&&(this.map.infoWindow.hide(),this.addStop(new A(t.mapPoint)))})),this.map.addLayer(this._waypointsEventLayer),this._moveLayersToFront(),S.add(this._activateButtonNode,this._css.stopsPressedButtonClass),this.onActivate()):(this.map.removeLayer(this._waypointsEventLayer),S.remove(this._activateButtonNode,this._css.stopsPressedButtonClass),this.onDeactivate()),e(!t),this.emit("map-click-active",{mapClickActive:this.mapClickActive})},_moveLayersToFront:function(){var t=this.get("map"),e=t.graphicsLayerIds.length-1;t.reorderLayer(this._routeLayer,e),t.reorderLayer(this._waypointsEventLayer,e),t.reorderLayer(this._stopLayer,e)},_destroyGeocoders:function(){var t=this.get("geocoders");if(t&&t.length)for(var e=0;e<t.length;e++)t[e]&&t[e].destroy();this.set("geocoders",[])},_disconnectEvents:function(){var t,e=this._clearDirections(!0);if(this._watchEvents&&this._watchEvents.length)for(t=0;t<this._watchEvents.length;t++)this._watchEvents[t].unwatch();if(this._onEvents&&this._onEvents.length)for(t=0;t<this._onEvents.length;t++)this._onEvents[t].remove();if(this._geocoderEvents)for(t=0;t<this._geocoderEvents.length;t++)this._geocoderEvents[t].value.unwatch(),this._geocoderEvents[t].blur.remove(),this._geocoderEvents[t].select.remove(),this._geocoderEvents[t].suggest.remove();return this._onEvents=[],this._watchEvents=[],this._geocoderEvents=[],this._disconnectResults(),this._destroyGeocoders(),this._destroyGlobalGeocoder(),this._destroyDnD(),e},_getDirections:function(){var t=new D;return this._removeEmptyStops(),this._getStopCount()+this._getWaypointCount()>1&&this.loaded?(this.onDirectionsStart(),this.clearMessages(),this._dnd.sync(),this._sortGeocoders(),this._getCandidates(this.stops).then(s.hitch(this,function(e){this.stops=e,this._setStops(),this._configureRoute().always(s.hitch(this,function(e){t.resolve(e)}))}),s.hitch(this,function(e){this.set("directions",null),this._clearRouteGraphics(),t.reject(e),this.onDirectionsFinish(e)}))):this._clearDirections(!0).always(s.hitch(this,function(){this.createRouteSymbols(),t.reject(new Error(this.loaded?T.widgets.directions.error.notEnoughStops:T.widgets.directions.error.notReady))})),t.promise},_clearDirections:function(){var t=new D;return this._handle&&this._handle._remove(),this.get("routeParams")&&this.get("routeParams").stops?this.get("routeParams").stops.features.length?(this.get("routeParams").stops.features=[],this.onDirectionsClear(),t.resolve()):arguments.length?t.resolve():this._reset().then(t.resolve,t.reject):t.resolve(),this.set("directions",null),this._clearDisplayBeforeSolve(),this._clearDisplayAfterSolve(),this._removeTrafficLayer(),this._routeLayer.clear(),this._waypointsEventLayer.clear(),this._stopLayer.clear(),t.promise},_setTravelMode:function(t){var e,s=new D,i=this.serviceDescription,o=function(){s.resolve(t)};if(i&&i.supportedTravelModes&&i.supportedTravelModes.length){var r=i.supportedTravelModes,n=!1;for(e=0;e<r.length;e++)if(r[e].name===t){n=!0,!this.routeParams.travelMode||this.routeParams.travelMode&&this.routeParams.travelMode.name!==t?(this.routeParams.travelMode=r[e].impedanceAttributeName?r[e]:r[e].itemId,this._solveAndZoom().always(o)):o(),this._updateTrafficCheckbox();break}n||s.reject(t)}else s.reject(t);return s.promise},_updateTrafficCheckbox:function(){if(this.serviceDescription){for(var t=this.routeParams.travelMode,e=this.routeParams.impedanceAttribute,s=this.serviceDescription.impedance,i=t?t.impedanceAttributeName:e?e:s,o=this.serviceDescription.networkDataset.networkAttributes,r=!1,n=0;n<o.length;n++)if(o[n].name===i){r=void 0!==o[n].trafficSupport&&"esriNTSNone"!==o[n].trafficSupport||void 0===o[n].trafficSupport&&"TravelTime"===i;break}this._useTrafficNode&&(this._useTrafficNode.disabled=!r,this._useTrafficNode.checked=this._useTrafficNode.checked&&r,r||this._removeTrafficLayer())}},_setDirectionsLengthUnits:function(t){this._clearDisplayBeforeSolve();var e=new D;return S.remove(this._useMilesNode,this._css.stopsPressedButtonClass),S.remove(this._useKilometersNode,this._css.stopsPressedButtonClass),t===E.KILOMETERS?S.add(this._useKilometersNode,this._css.stopsPressedButtonClass):t===E.MILES&&S.add(this._useMilesNode,this._css.stopsPressedButtonClass),t===E.KILOMETERS||t===E.METERS||t===E.MILES||t===E.FEET||t===E.NAUTICAL_MILES?(this.directionsLengthUnits=t,e.resolve(t)):e.reject(t),e.promise},_setDirectionsLanguage:function(t){this._clearDisplayBeforeSolve();var e=new D;return t=this._setDirectionsLanguageByLocale(t),this._solveAndZoom().always(function(){e.resolve(t)},e.reject),e.promise},_showLoadingSpinner:function(t){void 0===t&&(t=this._requestQueueTail&&!this._requestQueueTail.isFulfilled()||this._moveInProgress),t?(S.add(this._widgetContainer,this._css.resultsLoadingClass),S.add(this._resultsNode,"esriRoutesContainerBusy")):(S.remove(this._widgetContainer,this._css.resultsLoadingClass),S.remove(this._resultsNode,"esriRoutesContainerBusy"))},_enqueue:function(t,e){var i=new D;return this._requestQueueTail||(this._requestQueueTail=new D,this._requestQueueTail.resolve()),this._requestQueueTail.promise.always(s.hitch(this,function(){try{s.mixin(this,{_incrementalSolveStopRange:null},e);var o=t.call(this);o&&"object"==typeof o&&o.hasOwnProperty("isFulfilled")?o.then(s.hitch(this,function(t){i.resolve(t),this._showLoadingSpinner()}),s.hitch(this,function(t){i.reject(t),this._showLoadingSpinner()})):(i.resolve(o),this._showLoadingSpinner())}catch(r){i.reject(r),this._showLoadingSpinner()}})),this._requestQueueTail=i,this._showLoadingSpinner(),i.promise},_createDnD:function(){this._dnd=new R(this._dndNode,{skipForm:!0,withHandles:!0})},_destroyDnD:function(){L.empty(this._dndNode),this._dnd&&(this._dnd.destroy(),this._dnd=null)},_usingAGOL:function(){return this.get("routeTaskUrl").search(/^(https?:)*\/\/route*[^.]*\.arcgis\.com.*$/i)>-1},_setSearchOptions:function(){var t={maxResults:1,locationToAddressDistance:100},e={map:this.get("map"),autoNavigate:!1,enableInfoWindow:!1,enableHighlight:!1,enableSourcesMenu:!1};this.searchOptions=s.mixin(t,this.defaults.searchOptions,e)},_setDefaultUnits:function(){if(!this.get("directionsLengthUnits")){var t="EN-US"===i.locale.toUpperCase()?E.MILES:E.KILOMETERS;this.defaults.directionsLengthUnits&&(t=this.defaults.directionsLengthUnits),this.set("directionsLengthUnits",t)}this._setDirectionsLengthUnits(this.directionsLengthUnits)},_setTrafficOptions:function(){this.set("showTrafficOption",!(!this.defaults.showTrafficOption&&this.defaults.hasOwnProperty("showTrafficOption")||"esriNTSHistoricalAndLive"!==this.serviceDescription.trafficSupport&&"esriNTSHistorical"!==this.serviceDescription.trafficSupport&&"esriNTSLive"!==this.serviceDescription.trafficSupport)),this._usingAGOL()&&this.get("showTrafficOption")&&(this.get("trafficLayer")||this.set("trafficLayer",new k(location.protocol+"//traffic.arcgis.com/arcgis/rest/services/World/Traffic/MapServer",{opacity:.4}))),this._optionsMenu()},_updateCanModifyStops:function(){this.canModifyStops||this.canModifyWaypoints||this.set("mapClickActive",!1),arguments[1]||!this.canModifyStops||this.canModifyWaypoints||this.set("mapClickActive",!0),this._showAddDestination(),this._showMapClickActiveButton(),this._stopsTableCover.style.display=this.canModifyStops?"none":"inline"},_updateCanAddWaypoints:function(){this.canModifyStops||this.canModifyWaypoints||this.set("mapClickActive",!1),arguments[1]||this.canModifyStops||!this.canModifyWaypoints||this.set("mapClickActive",!0),this._showMapClickActiveButton(),this._handle._remove()},_setWidgetProperties:function(){this._disconnectEvents(),this.set(this.defaults),this.routeLayer=s.clone(this.defaults.routeLayer),this._folderSelector&&(this._outputLayer.setValue(""),this._outputLayer.set("disabled",!0),this._folderSelector.set("disabled",!0)),this.set("stops",[]),this._updateCanModifyStops()},_updateStops:function(t){var e=new D;return t?this.get("loaded")?this._reset().then(s.hitch(this,function(){this._addStops(t).then(e.resolve,e.reject)}),e.reject):this._addStops(t).then(e.resolve,e.reject):e.reject(),e.promise},_removeStop:function(t,e,i,o){var r=new D,n=s.hitch(this,function(t){this.stops.splice(t,1);
var e=this._dnd.getAllNodes()[t],s=this.get("geocoders");s[t].destroy(),s.splice(t,1),this.set("geocoders",s),this._geocoderEvents[e.id]&&(this._geocoderEvents[e.id].blur.remove(),this._geocoderEvents[e.id].select.remove(),this._geocoderEvents[e.id].suggest.remove(),this._geocoderEvents[e.id].value.unwatch()),L.destroy(e),this._dnd.sync(),this._stopsRemovable(),this._optionsMenu(),this._checkMaxStops(),this.setListIcons(),this._sortGeocoders()});(0>t||t>=this.stops.length||void 0===t)&&(t=this.stops.length-1);for(var a=t,h=!1,c=this.stopGraphics[a]&&this._isStopAWaypoint(this.stops[a])||o;!h;)n(a),c?h=!0:(a-=0>=a||a<this.stops.length&&this._isStopAWaypoint(this.stops[a])?0:1,h=!this._isStopAWaypoint(this.stops[a]));for(;this.stops.length-this._getWaypointCount()<this.minStops;)this._addStop();return this._setStops(),this.createRouteSymbols(),i?(this._clearDisplayBeforeSolve(),this._clearDisplayAfterSolve(),this.createRouteSymbols(),r.resolve()):this._solveAndZoom(e).then(r.resolve,r.reject),r.promise},_removeTrafficLayer:function(){var t=this.get("trafficLayer"),e=this.get("map");t&&e&&e.removeLayer(t),this._trafficLayerAdded=!1},_addStops:function(t,e){var i=new D,o=[],r=this.autoSolve;this.autoSolve=!1,void 0===e&&(e=this._getStopCount());for(var n=0;n<Math.min(t.length,this.maxStops-this._getStopCount());n++){var a=new D;this._addStop(t[n],e+n,!0).always(a.resolve),o.push(a)}return N(o).always(s.hitch(this,function(){this.autoSolve=r,this._getDirections().always(function(){i.resolve(t)})})),i.promise},_addStop:function(t,e,i){var o=new D;return this._checkMaxStops(),this.maxStopsReached?(this._showMessage(T.widgets.directions.error.maximumStops),o.reject(new Error(T.widgets.directions.error.maximumStops))):(void 0===t&&void 0===e&&(e=this.stops.length),t instanceof A&&t.attributes&&t.attributes.isWaypoint&&(!e||e===this.stops.length||this._getStopCount()<2)&&!i?(this._showMessage(T.widgets.directions.error.waypointShouldBeInBetweenStops),o.reject(new Error(T.widgets.directions.error.waypointShouldBeInBetweenStops))):this._getCandidate(t).then(s.hitch(this,function(t){this._insertStop(t,e),this.autoSolve&&""!==t.name?this._getDirections().always(function(){o.resolve(t,e)}):o.resolve(t,e)}),s.hitch(this,function(t){o.reject(t)}))),o.promise},_removeEmptyStops:function(){for(var t=0,e=this.stops.length-this._getWaypointCount()-this.minStops;t<this.stops.length&&e>0;)this.stops[t]&&this.stops[t].name?t++:(this._removeStop(t,!0,!0,!0),e--,this._moveInProgress&&this._handle._index>=t&&this._handle._isStopIcon&&this._handle._index--)},_setReverseGeocode:function(t,e,s){if(t.feature.geometry&&s>-1){var i={address:t.name};this.stopGraphics[s]&&(this.stopGraphics[s].setAttributes(i),this.stopGraphics[s].setGeometry(e)),this.textGraphics[s]&&(this.textGraphics[s].setAttributes(i),this.textGraphics[s].setGeometry(e)),this.set("stopGraphics",this.stopGraphics),this.set("textGraphics",this.textGraphics);var o=this.geocoders[s];return o&&o.inputNode&&(o.value=t.name,o.inputNode.value=t.name),this.stops[s]=t,this.stops[s].feature.setGeometry(e),this._setStops(),this._enqueue(function(){return this._getDirections()})}},_insertStop:function(t,e){var s,i;if(void 0===e){for(s=0;s<this.geocoders.length;s++)if(!this.geocoders[s].get("value")){i=this.geocoders[s];break}}else s=e,this.geocoders[s]&&!this.geocoders[s].get("value")&&(i=this.geocoders[s]);!i||void 0!==e&&e!==s||this._isStopAWaypoint(t)?(void 0===e&&(e=this.geocoders.length),this.stops.splice(e,0,t),this._createGeocoder(t,e)):(this.stops[s]=t,i.set("value",t.name),i._stopReference=t),this._optionsMenu()},_createGeocoder:function(t,e){var i=this._dnd.getAllNodes(),r=!1,n=!1,a=i.length;i[e]?(n=i[e],r=!0):(n=!1,r=!1);var h=s.hitch(this,function(t,e){var s=e?this._css.stopDnDHandleClass:this._css.stopDnDHandleClassHidden,i=e?this._css.stopDnDHandleClassHidden:this._css.stopDnDHandleClass;S.replace(t.children[0],s,i),this.geocoders.length>2&&(s=e?this._css.stopIconRemoveClass:this._css.stopIconRemoveClassHidden,i=e?this._css.stopIconRemoveClassHidden:this._css.stopIconRemoveClass,S.replace(t.children[3].children[0],s,i))}),c=L.create("tr",{className:this._css.stopClass,style:this._isStopAWaypoint(t)?"display:none;":"",onmouseover:function(){h(this,!0)},onmouseout:function(){h(this,!1)}});L.create("td",{className:this._css.stopDnDHandleClassHidden+" dojoDndHandle"},c);var u=L.create("td",{className:this._css.stopIconColumnClass},c);L.create("div",{className:this._css.stopIconClass+" dojoDndHandle",innerHTML:this._getLetter(a),"data-center-at":"true"},u);var l=L.create("td",{className:this._css.esriStopGeocoderColumnClass},c),d=L.create("div",{},l),p=L.create("td",{className:this._css.stopIconRemoveColumnClass},c);L.create("div",{className:this._css.stopIconRemoveClassHidden,role:"button","data-remove":"true"},p),this._dnd.insertNodes(!1,[c],r,n);var _=s.mixin({},this.get("searchOptions"),{value:t.name,activeSourceIndex:this._globalGeocoder.activeSourceIndex}),m=new M(_,d),g=s.hitch(this,function(t,e){this._enqueue(function(){if(e!==t&&m._stopReference&&m._stopReference.name!==e){var s=o.indexOf(this.stops,m._stopReference);this.stops[s]={name:e},this._handle._remove(),this._removeSomeWaypoints(this._markWPsForRemovalAfterUserChangedStopSequence(s)),this._setStops(),this._clearDisplayBeforeSolve(),this._clearDisplayAfterSolve(),this.createRouteSymbols()}})});m._tr=c,m._stopReference=t,m.startup(),this.geocoders.splice(e,0,m),this._geocoderEvents[c.id]={blur:m.on("blur",function(){""!==this.value&&this._stopReference&&!this._stopReference.feature&&this.search()}),select:m.on("select-result",s.hitch(this,function(t){var e=!0;if(t&&(t.results||t.result)){var s=this._dnd.getAllNodes(),i=o.indexOf(s,c),r=m.value,n=t.results&&t.results.results&&t.results.results.length?t.results.results[0]:t.result;n?(n.name=r,this.stops[i]=this._toPointGeometry(n),g("",r)):(this.removeStop(i),this.set("directions",null),this._showMessage(T.widgets.directions.error.unknownStop.replace("<name>",t.target.get("value"))),this._clearRouteGraphics(),e=!1),e&&this.getDirections()}})),suggest:m.on("suggest-results",function(){if(document.activeElement===this.inputNode)for(var t=w("LI[role='menuitem']",this.suggestionsNode),e=0;e<t.length;e++)y.set(t[e],"tabindex",-1);else this._hideSuggestionsMenu()}),value:m.watch("value",function(t,e,s){g(e,s)})},this._checkMaxStops(),this.setListIcons(),this._stopsRemovable(),this._optionsMenu(),this._sortGeocoders()},_blurGeocoders:function(){if(document.activeElement)for(var t=0;t<this.geocoders.length;t++)if(this.geocoders[t].inputNode===document.activeElement){this.geocoders[t]._hideSuggestionsMenu(),this.geocoders[t].inputNode.blur(),this._getStopCount()+this._getWaypointCount()>1&&this.getDirections(!0);break}},_decorateEmptyAGOLGeocoderResponse:function(t){return t&&", , "===t.name&&(t.name=t.feature&&t.feature.attributes&&t.feature.attributes.Match_addr?t.feature.attributes.Match_addr+("POI"===t.feature.attributes.Addr_type&&t.feature.attributes.City&&-1===t.feature.attributes.Match_addr.indexOf(t.feature.attributes.City)?", "+t.feature.attributes.City:""):""),t},_toPointGeometry:function(t){var e=t.feature.geometry;if(e)if(e.getCentroid)t.feature.geometry=e.getCentroid();else if(e.getExtent){var s=e.getExtent();s&&(t.feature.geometry=s.getCenter())}return t},_removeLocateButtonVisibilityEvents:function(){for(var t=0;t<this.geocoders.length;t++){var e=this.geocoders[t];e._onMouseEnter&&e._onMouseEnter.remove(),e._onMouseOut&&e._onMouseOut.remove(),e._onKeyPress&&e._onKeyPress.remove(),e._locateButton&&(e._locateButton._onMouseEnter&&e._locateButton._onMouseEnter.remove(),e._locateButton._onMouseOut&&e._locateButton._onMouseOut.remove())}},_setLocateButtonVisibilityEvents:function(){this._removeLocateButtonVisibilityEvents();for(var t=this,e=function(e){e instanceof FocusEvent?this._geocoder._lbShown_f=!0:this._geocoder._lbShown_g=!0,t._createLocateButton(this._geocoder,!0)},i=function(e){e instanceof FocusEvent?this._geocoder._lbShown_f=!1:this._geocoder._lbShown_g=!1,clearTimeout(this._destroyTimeout),this._destroyTimeout=setTimeout(s.hitch(this,function(){this._geocoder._lbShown_lb||this._geocoder._lbShown_f||t._destroyLocateButton(this._locateButton)}),400)},o=function(){this._geocoder._lbShown_g=!0,clearTimeout(this._destroyTimeout),this._destroyTimeout=setTimeout(s.hitch(this,function(){""===this.value?t._createLocateButton(this._geocoder,!0):t._destroyLocateButton(this._locateButton)}),400)},r=function(){this._geocoder._lbShown_lb=!0,clearTimeout(this._geocoder._destroyTimeout)},n=function(){this._geocoder._lbShown_lb=!1,clearTimeout(this._geocoder._destroyTimeout),this._geocoder._destroyTimeout=setTimeout(s.hitch(this,function(){this._geocoder._lbShown_g||this._geocoder._lbShown_f||t._destroyLocateButton(this._geocoder.inputNode._locateButton)}),400)},a=0;a<this.geocoders.length;a++){var h=this.geocoders[a];if(h&&h.inputNode&&(h.inputNode._geocoder=h,h._onMouseEnter=_(h.inputNode,m.enter,e),h._onMouseOut=_(h.inputNode,[m.leave,"blur"],i),h._onKeyPress=_(h.inputNode,"keydown",o),h.inputNode._locateButton)){var c=h.inputNode._locateButton;c._onMouseEnter=_(c.domNode,m.enter,r),c._onMouseOut=_(c.domNode,m.leave,n)}}},_createLocateButton:function(e,i,r){var a=new D,h=e;return h.inputNode._locateButton&&h.inputNode._locateButton._locating?a.resolve():t(["./LocateButton"],s.hitch(this,function(t){if(this._destroyLocateButton(h.inputNode._locateButton),h&&!this._solveInProgress){var e=L.create("div",{},h.domNode);S.add(h.domNode,this._css.stopsInnerGeocoderClass);var c=new t({map:this.map,highlightLocation:!1,centerAt:!1,setScale:!1,useTracking:!1},e);c.startup(),h.inputNode._locateButton=c,c.domNode._geocoder=h,this._setLocateButtonVisibilityEvents();var u=s.hitch(this,function(){c._locating=!0,h.set("value",""),h.inputNode.placeholder=T.widgets.directions.retrievingMyLocation.toUpperCase()});c._onBeforeLocate=_(c._locateNode,n,u),c._onLocate=_(c,"locate",s.hitch(this,function(t){c._locating=!1,t.graphic?(i&&this._destroyLocateButton(h.inputNode._locateButton),this.updateStop(new A(t.graphic.geometry),o.indexOf(this.geocoders,h)).then(s.hitch(this,function(){this.stopGraphics.length>1?this.getDirections().always(function(){a.resolve(t)}):a.resolve(t)}))):(h.set("value",""),h.inputNode.placeholder=T.widgets.directions.myLocationError.toUpperCase(),console.error(t.error),a.reject(t.error))})),r?(u(),c.locate().then(null,a.reject)):a.resolve()}else a.resolve()})),a.promise},_destroyLocateButton:function(t){if(t){var e=t.domNode._geocoder;clearTimeout(e._destroyTimeout),t._locating?e._destroyTimeout=setTimeout(s.hitch(this,function(){e._lbShown_lb||e._lbShown_f||this._destroyLocateButton(t)}),100):(t.clear(),t._onBeforeLocate.remove(),t._onLocate.remove(),t._onMouseEnter&&t._onMouseEnter.remove(),t._onMouseOut&&t._onMouseOut.remove(),t.destroy(),e.inputNode&&(e.inputNode._locateButton=null,e._setPlaceholder(e.activeSourceIndex)))}},_sortStops:function(){this.stops.length&&(this.stops.sort(s.hitch(this,function(t,e){for(var s,i,o=0;o<this.get("geocoders").length;o++)this.geocoders[o]._stopReference===t?s=o:this.geocoders[o]._stopReference===e&&(i=o);return s>i?1:i>s?-1:0})),this._setStops())},_getCandidate:function(t){var e=new D,i=typeof t;if(t)if("object"===i&&t.hasOwnProperty("feature")&&t.hasOwnProperty("name"))t.name=this._isStopAWaypoint(t)?this._waypointName:String(t.name),"point"!==t.feature.geometry.type&&(t.feature.geometry=new j([t.feature.geometry.x,t.feature.geometry.y],this.map.spatialReference)),e.resolve(t);else if("object"===i&&t.hasOwnProperty("address")&&t.hasOwnProperty("location")){var o=this._globalGeocoder._hydrateResult(t);e.resolve(o)}else"object"!==i||!t.hasOwnProperty("name")||null!==t.name&&""!==t.name?t instanceof A&&t.attributes&&(void 0!==t.attributes.Name||t.attributes.isWaypoint)?e.resolve(this._addStopWrapperToGraphic(t,t.attributes.isWaypoint?this._waypointName:String(t.attributes.Name))):("object"===i&&t.hasOwnProperty("name")&&(t=String(t.name)),this._reverseGeocode(t).then(e.resolve,e.reject)):e.resolve(s.clone(this._emptyStop));else e.resolve(s.clone(this._emptyStop));return e.promise},_reverseGeocode:function(t){var e,i=new D,o=t.geometry?t.geometry:t;if(this._globalGeocoder){var r=s.hitch(this,function(t){var e=new D,s=500;if(this.map){var i=this.map.toScreen(o);if(i.x+=G._calculateClickTolerance([t]),this.map.spatialReference.isWebMercator())s=Math.abs(this.map.toMap(i).x-o.x),e.resolve(s);else if(4326===this.map.spatialReference.wkid)s=Math.abs(W.geographicToWebMercator(this.map.toMap(i)).x-W.geographicToWebMercator(o).x),e.resolve(s);else if(this._geometryService){var r=new ee;r.distanceUnit=te.UNIT_METER,r.geometry1=o,r.geometry2=this.map.toMap(i),this._geometryService.distance(r,function(t){s=t,e.resolve(s)},function(){e.resolve(s)})}}return e.promise}),n=[],a=this._globalGeocoder.sources,h=function(){a[e].featureLayer&&n.push(r(a[e].featureLayer).then(s.hitch(a[e],function(t){this.searchQueryParams=s.mixin(this.searchQueryParams,{distance:t})})))};if("all"===this._globalGeocoder.activeSourceIndex)for(e=0;e<a.length;e++)h();else e=this._globalGeocoder.activeSourceIndex,h();N(n).always(s.hitch(this,function(){this._globalGeocoder.search(o).then(s.hitch(this,function(s){var r=!1;if(s){var n,a=null;for(e=0;e<this._globalGeocoder.sources.length;e++)if(s[e]&&s[e].length){n=s[e];break}if(n.length&&(r=!0,a=n[0],this._globalGeocoder.sources[e].featureLayer)){var h=Number.POSITIVE_INFINITY;for(e=0;e<n.length;e++){n[e]=this._toPointGeometry(n[e]);var c=B.geodesicLengths([new q({paths:[[W.xyToLngLat(o.x,o.y),W.xyToLngLat(n[e].feature.geometry.x,n[e].feature.geometry.y)]],spatialReference:{wkid:this.map.spatialReference.wkid}})],"esriMeters")[0];h>c&&(h=c,a=n[e])}}a=this._decorateEmptyAGOLGeocoderResponse(a),a&&""!==a.name&&null!==a.name&&void 0!==a.name?(a.name=String(a.name),isNaN(o.x)||isNaN(o.y)||this.map.spatialReference.wkid!==o.spatialReference.wkid?!a.feature.geometry||isNaN(a.feature.geometry.x)||isNaN(a.feature.geometry.y)?(this._showMessage(T.widgets.directions.error.locator),i.reject(new Error(T.widgets.directions.error.locator))):i.resolve(a):(a.feature.geometry=o,i.resolve(a))):r=!1}r||(t instanceof j?t=new A(t):t instanceof Array&&(t=new A(new j(t[0],t[1]))),t instanceof A?this._decorateUngeocodedStop(t).then(i.resolve,i.reject):(this._showMessage(T.widgets.directions.error.unknownStop.replace("<name>",t.toString())),i.reject(new Error(T.widgets.directions.error.unknownStop.replace("<name>",t.toString())))))}))}))}else this._showMessage(T.widgets.directions.error.locatorUndefined),i.reject(new Error(T.widgets.directions.error.locatorUndefined));return i.promise},_updateStop:function(t,e,i){var o=new D;return this.stops&&this.stops[e]?t instanceof A&&t.attributes&&t.attributes.isWaypoint&&(!e||e===this.stops.length-1||this._getStopCount()<2)?(this._showMessage(T.widgets.directions.error.waypointShouldBeInBetweenStops),o.reject(new Error(T.widgets.directions.error.waypointShouldBeInBetweenStops))):this._getCandidate(t).then(s.hitch(this,function(t){var s=t.feature,r=s?s.geometry:null,n=this.stops[e].feature,a=n?n.geometry:null,h=r&&a&&(r.x!==a.x||r.y!==a.y)||!r&&a;this.stops[e]=t,this.geocoders[e]||this._createGeocoder(t,e);var c=this.geocoders[e];c._stopReference=t,c._tr.style.display=this._isStopAWaypoint(t)?"none":"",c.value=t.name,c.inputNode&&(c.inputNode.value=t.name),h&&this.autoSolve&&this._getStopCount()+this._getWaypointCount()>1||i?this._getDirections().then(o.resolve,o.reject):(this._setStops(),o.resolve(t))}),s.hitch(this,function(t){o.reject(t)})):(this._showMessage(T.widgets.directions.error.couldNotUpdateStop),o.reject(new Error(T.widgets.directions.error.couldNotUpdateStop))),this._optionsMenu(),o.promise},_renderDirections:function(){var t=this.get("directions"),e="";if(this._resultsNode){if(e+='<div class="'+this._css.resultsRouteNameClass+'">',e+=t.routeName,e+="</div>",e+='<div class="'+this._css.clearClass+'"></div>',t.totalLength||t.totalTime){var i=this._formatDistance(t.totalLength,!0),r=this._formatTime(t.totalTime);e+='<div class="'+this._css.resultsSummaryClass+'">',i&&(e+=i),i&&r&&(e+=" &middot; "),r&&(e+=r),e+="</div>"}e+='<div class="'+this._css.clearClass+'"></div>',e+='<div class="'+this._css.resultsRouteButtonContainerClass+'">',e+='<div tabindex="0" role="button" class="'+this._css.linkButtonClass+" "+this._css.resultsViewFullRouteClass+'" data-full-route="true"" data-blur-on-click="true">'+T.widgets.directions.viewFullRoute+"</div>",e+='<div class="'+this._css.clearClass+'"></div>',e+="</div>",e+='<div class="'+this._css.routesClass+'">',e+='<table summary="'+t.routeName+'">',e+='<tbody role="menu">';for(var n=0;n<t.features.length;n++)e+=this._renderDirectionsItemTR(t.features[n],n);e+="</tbody>",e+="</table>",e+="</div>",this._resultsNode&&(this._resultsNode.innerHTML=e),this._disconnectResults();var a=w("[data-segment]",this._resultsNode);a&&a.length&&o.forEach(a,s.hitch(this,function(t){this._resultEvents.push(_(t,m.enter,s.hitch(this,function(){if(!this._focusedDirectionsItem){var e=parseInt(y.get(t,"data-segment"),10);this.highlightSegment(e)}}))),this._resultEvents.push(_(t,"focusout",s.hitch(this,function(){this._focusedDirectionsItem=null,this.unhighlightSegment(!0)}))),this._resultEvents.push(_(t,m.leave,this.unhighlightSegment)),this._resultEvents.push(_(t,"click, keydown",s.hitch(this,function(e){e&&("click"===e.type||"keydown"===e.type&&e.keyCode===d.ENTER)&&(this._focusedDirectionsItem!==t?this.selectSegment(parseInt(y.get(t,"data-segment"),10)):(t.blur(),this.map.infoWindow.hide(),this._focusedDirectionsItem=null,this.unhighlightSegment(!0)))})))}))}},_renderDirectionsItemTR:function(t){var e=this.directions,s=e?o.indexOf(e.features,t):-1,i="",r=this._css.routeClass,n=t._associatedStopWithReturnToStart&&t._associatedStopWithReturnToStart.attributes;if(s>-1){t.attributes&&(t.attributes.step=s+1),t.attributes.maneuverType&&(r+=" "+t.attributes.maneuverType),n&&null===n.ArriveCurbApproach&&null!==n.DepartCurbApproach?r+=" "+this._css.routeOriginClass:n&&null!==n.ArriveCurbApproach&&null===n.DepartCurbApproach&&(r+=" "+this._css.routeDestinationClass+" "+this._css.routeLastClass),i+='<tr tabindex="0" role="menuitem" class="'+r+" "+this._css.routeZoomClass+'" data-segment="'+s+'">',i+='<td class="'+this._css.routeIconColumnClass+'">',i+='<div class="'+this._css.routeIconClass+'">',i+=this._getLetter(t._associatedStop),i+="</div>",i+="</td>",i+='<td class="'+this._css.routeTextColumnClass+'">',i+='<div class="'+this._css.routeInfoClass+'">',i+='<div class="'+this._css.routeTextClass+'">';var a,h=(e.strings[s]||[]).slice();if("esriDMTDepart"===t.attributes.maneuverType||"esriDMTStop"===t.attributes.maneuverType)for(a=0;a<this.stops.length;a++)this.stops[a]&&this.stops[a].name&&h.push({string:this.stops[a].name});if(h){var c=t.attributes.text;for(a=0;a<h.length;a++)c=this._boldText(c,h[a].string);t.attributes.formattedText=c}else t.attributes.formattedText=t.attributes.text;i+="<strong>"+b.format(t.attributes.step)+".</strong> "+t.attributes.formattedText,i+="</div>";var u=this._formatDistance(t.attributes.length,!1),l=this._formatTime(t.attributes.time);u&&(i+='<div class="'+this._css.routeLengthClass+'">',i+=u,l&&(i+=" &middot; "+l),i+="</div>"),i+="</div>",i+="</td>",i+="</tr>"}return i},_addStopWrapperToGraphic:function(t,e){return{extent:new F({xmin:t.geometry.x-.25,ymin:t.geometry.y-.25,xmax:t.geometry.x+.25,ymax:t.geometry.y+.25,spatialReference:t.geometry.spatialReference}),feature:t,name:e}},_showRoute:function(t){this._clearDisplayAfterSolve();var e=t.routeResults[0].directions,s=new D;if(e){this.set("solveResult",t),this.set("directions",e);var i,o,r=t.routeResults[0].stops;if(r&&r.length){var n=[];for(i=0;i<r.length;i++){var a=r[i];a.attributes.isWaypoint=a.attributes.Name===this._waypointName||a.attributes.isWaypoint;var h=this._addStopWrapperToGraphic(a,a.attributes.Name);this._returnToStartStop&&this._returnToStartStop._resultsStopIndex===i?this._returnToStartStop=h:n.push(h)}if(this.stops.length>n.length)for(i=0;i<this.stops.length;i++)this.stops[i].feature||""!==this.stops[i].name||n.splice(i,0,this._emptyStop);for(this.stops=n,i=0;i<this.stops.length;i++)this._updateStop(this.stops[i],i);this._setStops(),this._setMenuNodeValues()}this.set("mergedRouteGraphic",new A(e.mergedGeometry,this.get("routeSymbol")));var c=[],u=[],l=0;for(i=0;i<e.featuresWithWaypoints.length;i++){var d=e.featuresWithWaypoints[i];if("esriDMTDepart"===d.attributes.maneuverType)for(o=0;o<this.stops.length;o++)if(this.stops[o].feature===d._associatedStop){l=o+1;break}d.setSymbol(this.get("routeSymbol")),this._routeLayer.add(d),c.push(d);var p=d.getDojoShape();p&&p.moveToBack();var _=new A(d.geometry,this._symbolEventPaddingDirections,d.attributes);if(_._nextStopIndex=l-.5,_._isSnapFeature=!0,d._associatedSnapFeature=_,this._waypointsEventLayer.add(_),"esriDMTDepart"!==d.attributes.maneuverType){var m=d.geometry.getPoint(0,0);if(m){var g=new A(m,this.maneuverSymbol);g._directionsFeature=d._associatedFeatureNoWaypoints,u.push(g),this._waypointsEventLayer.add(u[u.length-1])}}}for(this.set("displayedRouteGraphics",c),this.set("displayedManeuverPointGraphics",u),this._renderDirections(),i=0;i<this.stops.length;i++)if(this._isStopAWaypoint(this.stops[i])&&this._modifiedWaypointIndex===i){for(o=0;o<e.featuresWithWaypoints.length;o++){var f=e.featuresWithWaypoints[o];if(f._associatedStop===this.stops[i].feature){("esriDMTStop"===f.attributes.maneuverType||"esriDMTDepart"===f.attributes.maneuverType)&&(this.stops[i].feature.geometry.x=f.geometry.paths[0][0][0],this.stops[i].feature.geometry.y=f.geometry.paths[0][0][1]);break}}this._modifiedWaypointIndex=null;break}v.set(this._savePrintBtnContainer,"display","inline-block"),this.onDirectionsFinish(t),s.resolve()}else{var S=t.routeResults[0].route;S.setSymbol(this.routeSymbol),this._routeLayer.add(S),this._incrementalRouteSegment=S,s.resolve()}return this._moveLayersToFront(),this.createRouteSymbols(),s.promise},_setGeocodersStopReference:function(){if(this.geocoders)for(var t=0;t<this.geocoders.length;t++)this.geocoders[t]&&this.stops[t]&&(this.geocoders[t]._stopReference=this.stops[t])},_setStops:function(){this._setGeocodersStopReference(),this.createRouteSymbols(),this._set("stops",this.stops),this.onStopsUpdate(this.stops)},_getCandidates:function(t){var e=[];if(t&&t.length){for(var s=0;s<t.length;s++)e.push(this._getCandidate(t[s]));return N(e)}var i=new D;return i.resolve([]),i.promise},_clearResultsHTML:function(){this._resultsNode.innerHTML="",v.set(this._savePrintBtnContainer,"display","none")},_showSegmentPopup:function(t){if(t&&this.get("showSegmentPopup")&&this.get("map").infoWindow){var e=t.geometry,s=e.getPoint(0,0),i=new A(s,null,t.attributes,this.get("segmentInfoTemplate")),o=this.get("map").infoWindow;o.setFeatures([i]),o.show(s)}},_addStopButton:function(){this.addStop().then(s.hitch(this,function(){this.get("focusOnNewStop")&&this.geocoders[this.stops.length-1].focus()}))},_sortGeocoders:function(){var t=this._dnd.getAllNodes();this.geocoders.sort(s.hitch(this,function(e,s){return e.domNode&&e.domNode.parentNode&&e.domNode.parentNode.parentNode&&s.domNode&&s.domNode.parentNode&&s.domNode.parentNode.parentNode?o.indexOf(t,e.domNode.parentNode.parentNode)>o.indexOf(t,s.domNode.parentNode.parentNode)?1:-1:0})),this.stops.length===this.geocoders.length&&this._sortStops();for(var e=0;e<this.geocoders.length;e++)this.geocoders[e]&&this.geocoders[e].inputNode&&(this.geocoders[e].inputNode.title=T.widgets.directions.stopNoTitle+(e+1));this._setLocateButtonVisibilityEvents()},_disconnectResults:function(){if(this._resultEvents&&this._resultEvents.length)for(var t=0;t<this._resultEvents.length;t++)this._resultEvents[t]&&this._resultEvents[t].remove();this._resultEvents=[]},_formatArbitraryCostsForRouteTooltip:function(t){var e="",s=this.serviceDescription.networkDataset.networkAttributes;for(var i in t)if(0===i.indexOf("Total_")&&t.hasOwnProperty(i))for(var o=0;o<s.length;o++)s[o].name===i.substr(6)&&"esriNAUTCost"===s[o].usageType&&(e+="esriNAUMinutes"===s[o].units?this._formatTime(t[i]):b.format(t[i],{places:3,locale:"root"})+" "+s[o].units.substr(7).toLowerCase(),e+=e?" &middot; ":"");return e&&(e=T.widgets.directions.toNearbyStops+": <b>"+e.substr(0,e.length-10)+"</b>"),e},_formatTime:function(t){var e,s,i="",o=Math.round(t);return e=Math.floor(o/60),s=Math.floor(o%60),e&&(i+=e+" ",i+=e>1?T.widgets.directions.time.hours:T.widgets.directions.time.hour),e&&s&&(i+=" "),s&&(i+=s+" ",i+=s>1?T.widgets.directions.time.minutes:T.widgets.directions.time.minute),i},_formatDistance:function(t,e,i){var o=this._getUnits(this.get("directionsLengthUnits")),r=i?this._getUnits(s.hitch(this,function(){for(var t="",e=this.serviceDescription.networkDataset.networkAttributes,s=0;s<e.length;s++)if(e[s].name===i&&"esriNAUTCost"===e[s].usageType){t=e[s].units;break}return t})()):o,n=T.widgets.directions.units[o];switch(r+">"+o){case"MILES>KILOMETERS":t*=1.609344;break;case"KILOMETERS>MILES":t/=1.609344;break;case"METERS>KILOMETERS":t/=1e3;break;case"METERS>MILES":t/=1609.344}o=n?e?n.name:n.abbr:o.replace("esri","").toLowerCase();var a=Math.round(100*t)/100;return 0===a?"":b.format(a,{locale:"root"})+" "+o},_editToolbar:function(){this.set("editToolbar",new re(this.get("map")))},_destroyGlobalGeocoder:function(){this._globalGeocoder&&(this._globalGeocoder.destroy(),this._globalGeocoder=null)},_createGlobalGeocoder:function(){var t=new D;return this._globalGeocoder=new M(this.get("searchOptions")),_.once(this._globalGeocoder,"load",s.hitch(this,function(){for(var e=0;e<this._globalGeocoder.sources.length;e++){var s=this._globalGeocoder.sources[e].locator;if(s&&s.url&&(s.url.toUpperCase().indexOf(this._globalGeocoder.defaultSource.locator.url.toUpperCase())>-1||s.url.toUpperCase().indexOf("//GEOCODEDEV.ARCGIS.COM/ARCGIS/REST/SERVICES/WORLD/GEOCODESERVER")>-1)&&!this._globalGeocoder.sources[e].searchTemplate){this._globalGeocoder.sources[e].searchTemplate="${Address}, ${City}, ${Region}";break}}t.resolve()},function(e){t.reject(e)})),this._globalGeocoder.startup(),t.promise},_init:function(){var t=new D;return this.set("loaded",!1),this._enableButton(this._getDirectionsButtonNode,!1),v.set(this._saveAsButton,"display","none"),this.clearMessages(),this.get("map").loaded?this._configure().always(t.resolve):_.once(this.get("map"),"load",s.hitch(this,function(){this._configure().always(t.resolve)})),t.promise},_setDefaultStops:function(){var t=new D;return this.defaults.stops&&this.defaults.stops.length?this._updateStops(this.defaults.stops).then(s.hitch(this,function(){this._removeEmptyStops(),t.resolve()}),t.reject):t.resolve(),t.promise},_configure:function(){var t=new D;return this._handle&&this._handle._remove(),this._createDnD(),this._setSearchOptions(),this._createGlobalGeocoder().then(s.hitch(this,function(){this._editToolbar(),this._usingAGOL()||(this.geometryTaskUrl=null,this.printTaskUrl=null),this._createGeometryTask(),this._createPrintTask(),this._showActivateButton(),this._createTravelModesDDL(),this._createSearchSourceDDL();var e=[this._createRouteTask(),this._setDefaultStops()];N(e).then(s.hitch(this,function(){this._setDefaultUnits(),this._setTrafficOptions(),this._setMenuNodeValues(),this._setupEvents(),this._setDirectionsLanguageByLocale(this.directionsLanguage?this.directionsLanguage:i.locale.toLowerCase()),this._setupTravelModes().then(s.hitch(this,function(){this.set("loaded",!0),this.onLoad(),t.resolve(!0)}),function(e){t.reject(e)})}),function(e){t.reject(e)})}),function(e){t.reject(e)}),this._naRouteSharing=null,t.promise},_setDirectionsLanguageByLocale:function(t){var e=this.serviceDescription.directionsSupportedLanguages,s=function(t){if(e)for(var s=0;s<e.length;s++)if(e[s].toLowerCase().substr(0,2)===t)return e[s];return null},i=s(t);return i||(t=t.substr(0,2),i=s(t)),this.directionsLanguage=i,this.routeParams.directionsLanguage=i,i},_getStopSymbol:function(t,e){var s=t&&(t.feature&&t.feature.attributes||t.attributes),i=this.stopSymbol;return s&&(i=this._isStopAWaypoint(t)?this.waypointSymbol:this.get(void 0===s.Status||0===s.Status||6===s.Status?null===s.ArriveCurbApproach&&null!==s.DepartCurbApproach?e?"fromSymbolDrag":"fromSymbol":null!==s.ArriveCurbApproach&&null===s.DepartCurbApproach?e?"toSymbolDrag":"toSymbol":e?"stopSymbolDrag":"stopSymbol":e?"unreachedSymbolDrag":"unreachedSymbol")),i},_addTrafficLayer:function(){var t=this.get("trafficLayer");t&&!this._trafficLayerAdded&&(this.get("map").addLayer(t),t.show(),this._trafficLayerAdded=!0)},_toggleUnits:function(t){t.target===this._useMilesNode?this.setDirectionsLengthUnits(E.MILES):t.target===this._useKilometersNode&&this.setDirectionsLengthUnits(E.KILOMETERS)},_toggleCheckbox:function(t){var e=y.get(t.target,"checked");t.target===this._findOptimalOrderNode?this.set("optimalRoute",e):t.target===this._useTrafficNode?this.set("traffic",e):t.target===this._returnToStartNode&&this.set("returnToStart",e)},_isStopLocated:function(t){return t&&t.feature&&t.feature.attributes&&(!t.feature.attributes.Status||6===t.feature.attributes.Status)},_configureRouteOptions:function(){var t,e=this.get("routeParams");if(this.get("directionsLengthUnits")?e.directionsLengthUnits=this.get("directionsLengthUnits"):this.set("directionsLengthUnits",e.directionsLengthUnits),e.findBestSequence=this.get("optimalRoute"),e.findBestSequence)for(e.preserveFirstStop=this._isStopLocated(this.stops[0]),e.preserveLastStop=!this.returnToStart&&this._isStopLocated(this.stops[this.stops.length-1])||this.returnToStart&&this._isStopLocated(this.stops[0]),t=0;t<this.stops.length;)this._isStopAWaypoint(this.stops[t])?this._removeStop(t,!0,!0):t++;if(!this.returnToStart&&this.stops.length&&this._isStopAWaypoint(this.stops[this.stops.length-1]))for(t=this.stops.length-1;t>0;)this._isStopAWaypoint(this.stops[t])&&this._removeStop(t,!0,!0),t--;this._updateTrafficCheckbox(),this.get("traffic")&&!this._useTrafficNode.disabled?(e.startTime=new Date,e.startTimeIsUTC=!0,this._addTrafficLayer()):(e.startTime=null,e.startTimeIsUTC=null,this._removeTrafficLayer()),e.returnStops=!0;var s=[];for(t=0;t<this.stopGraphics.length;t++)this.stopGraphics[t]&&s.push(new A(this.stopGraphics[t].toJson()));if(this.get("returnToStart")&&this.stopGraphics.length&&this._isStopLocated(this.stops[0])){var i=new A(this.stopGraphics[0].toJson());this._returnToStartStop=this._addStopWrapperToGraphic(i,i.attributes.Name),s.push(i)}else this._returnToStartStop=null;e.stops.features=s,this.set("routeParams",e)},_configureRoute:function(){var t=new D;if(t.promise.always(s.hitch(this,function(){this._checkMaxStops()})),this.createRouteSymbols(),this._configureRouteOptions(),this.routeParams.returnRoutes&&this._incrementalSolveStopRange){var e=this._incrementalSolveStopRange;e.start<e.end?this.routeParams.stops.features=this.routeParams.stops.features.slice(e.start,e.end+1):e.start>e.end&&(this.routeParams.stops.features=this.routeParams.stops.features.slice(e.start,this.routeParams.stops.features.length-1).concat(this.routeParams.stops.features.slice(0,e.end+1)))}else this._incrementalSolveStopRange=null;var i,o,r,n={},a=this.routeParams.stops.features;for(i=0;i<a.length;i++)r=a[i].attributes.address,o=(i===this._handle._index&&!this._handle.attributes.isWaypoint&&this._incrementalSolveStopRange?this._waypointName:r)+"_"+this._stopSequence++,a[i].attributes.Name=o,n[o]=r,delete a[i].attributes.address,delete a[i].attributes.isWaypoint,delete a[i].attributes.Status;this._solveInProgress=!0;var h={_incrementalSolveStopRange:this._incrementalSolveStopRange};return this.routeTask.solve(this.routeParams,s.hitch(this,function(e){this._solveResultProcessing(e,n,h).then(t.resolve,t.reject)}),s.hitch(this,function(e){s.mixin(this,h),this._solveInProgress=!1;for(var i=0;i<this.stops.length;i++)this.stops[i].feature&&(this.stops[i].feature.attributes=s.mixin(this.stops[i].feature.attributes,{Status:5}));
this.set("directions",null),this._clearDisplayAfterSolve(),this.createRouteSymbols(),this._routeTaskError(e),t.reject(e)})),t.promise},_solveResultProcessing:function(t,e,i){var o=new D;s.mixin(this,i),this._solveInProgress=!1;var r,n=t.routeResults[0],a=n.directions,h=n.stops;if(a){this._solverMessages=t.messages;var c=function(t){for(var s in e)if(t&&0===a.routeName.indexOf(s)||!t&&a.routeName.indexOf(s)>0)return e[s];return""},u=c(!0),l=c(!1);for(a.routeName=(u!==this._waypointName?u:T.widgets.directions.waypoint)+" â "+(l!==this._waypointName?l:T.widgets.directions.waypoint),r=0;r<a.features.length;r++){var d=a.features[r].attributes;if("esriDMTDepart"===d.maneuverType||"esriDMTStop"===d.maneuverType)for(var p in e)if(e.hasOwnProperty(p)&&d.text.indexOf(p)>-1){d.text=d.text.replace(p,e[p]);for(var _=0;_<h.length;_++)if(h[_].attributes.Name===p){s.mixin(a.features[r],{_associatedStop:h[this.returnToStart&&_===h.length-1?0:_],_associatedStopWithReturnToStart:h[_]});break}}}for(r=0;r<h.length;r++)this._returnToStartStop&&h[r].attributes.Name===this._returnToStartStop.feature.attributes.Name&&(this._returnToStartStop._resultsStopIndex=r),h[r].attributes.Name=e[h[r].attributes.Name];this._directionsPostprocessing(a)}return this._showRoute(t).always(s.hitch(this,function(){this._incrementalSolveStopRange=null,o.resolve(t)})),o.promise},_directionsPostprocessing:function(t){var e,i,o=function(e,s){var i=t.features[e]._associatedFeaturesWithWaypoints||[];i.push(t.featuresWithWaypoints[s]),t.features[e]._associatedFeaturesWithWaypoints=i,t.featuresWithWaypoints[s]._associatedFeatureNoWaypoints=t.features[e]},r=s.hitch(this,function(t){return"<div class='"+this.theme+"'><table class='esriRoutesTooltip'>"+this._renderDirectionsItemTR(t._associatedFeatureNoWaypoints)+"</table></div>"});for(t.featuresWithWaypoints=[],e=0;e<t.features.length;e++){var n=new A(t.features[e].toJson());n.setInfoTemplate(new I({title:this._i18n.widgets.directions.maneuver,content:r})),t.featuresWithWaypoints.push(n),t.featuresWithWaypoints[e]._associatedStop=t.features[e]._associatedStop,t.featuresWithWaypoints[e]._associatedStopWithReturnToStart=t.features[e]._associatedStopWithReturnToStart}for(t.stringsWithWaypoints=s.mixin([],t.strings),t.eventsWithWaypoints=s.mixin([],t.events),e=0,i=0;e<t.features.length;)if(t.features[e]._associatedStop&&t.features[e]._associatedStop.attributes.Name===this._waypointName)if(t.features.splice(e,e?2:1),t.strings.splice(e,e?2:1),t.events.splice(e,e?2:1),e&&t.features[e]&&"esriDMTStraight"===t.features[e].attributes.maneuverType){var a=t.features.splice(e,1)[0];t.strings[e-1]=(t.strings[e-1]||[]).concat(t.strings.splice(e,1)[0]||[]),t.strings[e-1].length||(t.strings[e-1]=void 0),t.events[e-1]=(t.events[e-1]||[]).concat(t.events.splice(e,1)[0]||[]),t.events[e-1].length||(t.events[e-1]=void 0),t.features[e-1].attributes.length+=a.attributes.length,t.features[e-1].attributes.time+=a.attributes.time,t.features[e-1].geometry.paths[0]=t.features[e-1].geometry.paths[0].concat(a.geometry.paths[0]),o(e-1,i++),o(e-1,i++),o(e-1,i++)}else e&&o(e-1,i++),e<t.features.length&&o(e,i++);else o(e,i++),e++},_boldText:function(t,e){return t.replace(new RegExp("(^|\\s|\\W)("+e+")(\\W|\\s|$)","ig"),"$1<strong>$2</strong>$3")},_clearStopGraphics:function(){if(this.stopGraphics&&this.stopGraphics.length)for(var t=0;t<this.stopGraphics.length;t++)this._stopLayer.remove(this.stopGraphics[t]),this._stopLayer.remove(this.textGraphics[t]);this.set("stopGraphics",[]),this.set("textGraphics",[])},_clearRouteGraphics:function(){for(var t=this.displayedRouteGraphics,e=this.displayedManeuverPointGraphics,s=this._routeLayer,i=this._waypointsEventLayer,r=0,n=0,a=this._incrementalSolveStopRange?this._incrementalSolveStopRange:{start:0,end:this.stops?this.stops.length:-1};t&&n<t.length;){if(t[n]._associatedStop)for(var h=0;h<this.stops.length;h++)if(this.stops[h].feature===t[n]._associatedStop){r=h;break}r>=a.start&&r<a.end||a.start>=a.end&&(r>=a.start||r<a.end)?(s.remove(t[n]),t.splice(n,1)):n++}s.remove(this._incrementalRouteSegment),this.set("displayedRouteGraphics",t?t:[]),e&&e.length&&o.forEach(e,function(t){i.remove(t)}),this.set("displayedManeuverPointGraphics",[]),this._waypointsEventLayer.clear(),this.unhighlightSegment(!0)},_clearInfoWindow:function(){var t=this.get("map").infoWindow;t&&(t.hide(),t.clearFeatures())},_clearDisplayBeforeSolve:function(){this._toggleSaveMenu(!1),this._clearInfoWindow(),this._clearResultsHTML()},_clearDisplayAfterSolve:function(){this._clearStopGraphics(),this._clearRouteGraphics(),this.clearMessages()},_getLetter:function(t){var e=this.alphabet,i="",o=function(t){var s="";return"0123456789"===e||"1234567890"===e?s=String(t+1):(t=t||0,t>=e.length&&(s=o(Math.floor(t/e.length)-1),t%=e.length),s+=e[t]),s},r=t instanceof A?s.hitch(this,function(){for(var e=this.get("returnToStart")?0:-1,s=0;s<this.stops.length;s++)if(this.stops[s].feature===t){e=s;break}return e})():t;if(r>-1&&e&&e.length){e instanceof Array&&(e=e.toString().replace(/,/g,""));for(var n=-1,a=0;r>=a;a++)n+=this._isStopAWaypoint(this.stops[a])?0:1;i=o(n)}return i},_solveAndZoom:function(t){if(this.autoSolve)return this._getDirections().then(s.hitch(this,function(){t||this.zoomToFullRoute()}));var e=new D;return e.resolve(),e.promise},_setupEvents:function(){this._onEvents.push(_(this.domNode,"[data-blur-on-click]:click",function(){this.blur()})),this._onEvents.push(_(this._dndNode,"[data-reverse-stops]:click, [data-reverse-stops]:keydown",s.hitch(this,function(t){t&&("click"===t.type||"keydown"===t.type&&t.keyCode===d.ENTER)&&this.modifyStopSequence()}))),this._onEvents.push(_(this._printButton,"click, keydown",s.hitch(this,function(t){t&&("click"===t.type||"keydown"===t.type&&t.keyCode===d.ENTER)&&this._printDirections()}))),this._onEvents.push(_(this._resultsNode,"[data-full-route]:click, [data-full-route]:keydown",s.hitch(this,function(t){t&&("click"===t.type||"keydown"===t.type&&t.keyCode===d.ENTER)&&this.zoomToFullRoute()}))),this._onEvents.push(_(this._dndNode,"[data-remove]:click, [data-remove]:keydown",s.hitch(this,function(t){if(t&&("click"===t.type||"keydown"===t.type&&t.keyCode===d.ENTER)){var e=w("[data-remove]",this._dndNode),s=o.indexOf(e,t.target);this.removeStop(s)}}))),this._onEvents.push(_(this._dndNode,"[data-center-at]:click, [data-center-at]:keydown",s.hitch(this,function(t){if(t&&("click"===t.type||"keydown"===t.type&&t.keyCode===d.ENTER)){var e=w("[data-center-at]",this._dndNode),s=o.indexOf(e,t.target);this.stops[s]&&this.stops[s].feature&&this.stops[s].feature.geometry&&this.map.centerAndZoom(this.stops[s].feature.geometry)}}))),this._onEvents.push(_(this.map,"zoom-end",s.hitch(this,function(){var t=this._segmentGraphics;t&&t[0]&&void 0!==t[0].attributes._index&&this.highlightSegment(t[0].attributes._index,!0)}))),this._onEvents.push(_(this._dnd,"Drop",s.hitch(this,function(){this._dnd.sync(),this.set("optimalRoute",!1);var t,e,s=!1,i=[],r=this._dnd.getAllNodes();for(t=0;t<this.geocoders.length;t++)if(e=o.indexOf(r,this.geocoders[t]._tr),e>-1&&t!==e&&t!==e-1){for(;e>0&&this._isStopAWaypoint(this.stops[e]);)e--;s=!0;break}s&&(i=this._markWPsForRemovalAfterUserChangedStopSequence(t,e)),this._sortGeocoders(),this.setListIcons(),this._removeSomeWaypoints(i),this.stops[e].name&&this.getDirections()}))),this._onEvents.push(_(this._dnd,"DndStart",s.hitch(this,function(){var t=w("body")[0];S.add(t,this._css.dndDragBodyClass),this._removeLocateButtonVisibilityEvents()}))),this._onEvents.push(_(this._dnd,"DndDrop, DndCancel",s.hitch(this,function(){var t=w("body")[0];S.remove(t,this._css.dndDragBodyClass),this._setLocateButtonVisibilityEvents()})));var t=this._handle,e=s.hitch(this,function(e){var i=s.hitch(this,function(s,i,o,r,n){var a=t._isShown();if(t.setGeometry(s),t._tooltip.style.left=e.screenPoint.x+"px",t._tooltip.style.top=e.screenPoint.y+"px",!a||t._index===o&&t.attributes.isWaypoint===r||(t._remove(),a=!1),t.setSymbol(i),t._index=o,t._isStopIcon=t._index===Math.floor(t._index),t.attributes.isWaypoint=r,t._isStopIcon&&(t.attributes.address=this.stopGraphics[o].attributes.address,t.setInfoTemplate(this.stopGraphics[o].infoTemplate)),this.canModifyWaypoints||t._isStopIcon){if(!a){this._stopLayer.add(t);var h=t.getDojoShape();h&&h[r?"moveToBack":"moveToFront"].call(h)}this.editToolbar.activate(re.MOVE,t)}var c=r?t._isStopIcon?T.widgets.directions.dragWaypoint:this.canModifyWaypoints?T.widgets.directions.dragRoute:"":T.widgets.directions.dragStop;t._showTooltip(n||c)});if(this.unhighlightSegment(),this.mapClickActive&&this.dragging&&!this._solveInProgress&&!this._moveInProgress&&!t._solveTimeout)if(clearTimeout(t._removeTimeout),(e.graphic._isStopIcon||e.graphic._isStopLabel)&&!e.graphic.attributes.isWaypoint&&this.canModifyStops||e.graphic._isStopIcon&&e.graphic.attributes.isWaypoint&&this.canModifyWaypoints){var r=e.graphic._isStopLabel?this.stopGraphics[e.graphic._index]:e.graphic;i(r.geometry,this._getStopSymbol(this.stops[r._index],!0),r._index,r.attributes.isWaypoint===!0),this._stopLayer.remove(this.stopGraphics[r._index]),this._stopLayer.remove(this.textGraphics[r._index])}else(e.graphic._isSnapFeature||e.graphic._isHandle&&!e.graphic._isStopIcon)&&(this._snappingManager||(this._snappingManager=this.map.snappingManager),this._snappingManager.getSnappingPoint(e.screenPoint).then(s.hitch(this,function(s){if(!this.maxStopsReached&&!this._moveInProgress&&s){for(var r=this.displayedManeuverPointGraphics,n=null,a=0;a<r.length;a++)if(r[a].geometry.x===s.x&&r[a].geometry.y===s.y){n=r[a]._directionsFeature;var h=o.indexOf(this.directions.features,n);h>-1&&this.highlightSegment(h);break}i(s,e.graphic._isHandle?t.symbol:this.waypointSymbol,e.graphic._isHandle?t._index:e.graphic._nextStopIndex,e.graphic._isHandle?t.attributes.isWaypoint:!0,n)}})))}),i=s.hitch(this,function(){clearTimeout(t._removeTimeout),t._removeTimeout=setTimeout(t._remove,100),this.unhighlightSegment()});this._onEvents.push(this._waypointsEventLayer.on("mouse-move",e)),this._onEvents.push(this._waypointsEventLayer.on("mouse-out",i)),this._onEvents.push(this._stopLayer.on("mouse-move",e)),this._onEvents.push(this._stopLayer.on("mouse-out",i)),this._editToolbarEvents(),this._watchEvents.push(this.watch("theme",this._updateThemeWatch)),this._watchEvents.push(this.watch("canModifyStops",this._updateCanModifyStops)),this._watchEvents.push(this.watch("canModifyWaypoints",this._updateCanAddWaypoints)),this._watchEvents.push(this.watch("showReturnToStartOption",this._optionsMenu)),this._watchEvents.push(this.watch("showOptimalRouteOption",this._optionsMenu)),this._watchEvents.push(this.watch("returnToStart",this._setMenuNodeValues)),this._watchEvents.push(this.watch("optimalRoute",this._setMenuNodeValues)),this._watchEvents.push(this.watch("traffic",this._setMenuNodeValues)),this._watchEvents.push(this.watch("trafficLayer",this._trafficLayerUpdate)),this._watchEvents.push(this.watch("routeTaskUrl",s.hitch(this,function(){this._createRouteTask(),this._setTrafficOptions()}))),this._watchEvents.push(this.watch("printTaskUrl",s.hitch(this,function(){this._createPrintTask()}))),this._watchEvents.push(this.watch("geometryTaskUrl",s.hitch(this,function(){this._createGeometryTask()}))),this._watchEvents.push(this.watch("routeParams",s.hitch(this,function(){this._createRouteParams(),this._setDefaultUnits()}))),this._watchEvents.push(this.watch("searchOptions",s.hitch(this,function(){this._setSearchOptions(),this._createGlobalGeocoder();var t=this.get("searchOptions").sources;if(t)for(var e=0;e<this.geocoders.length;e++)this.geocoders[e].set("sources",t)}))),this._watchEvents.push(this.watch("showReverseStopsButton",this.setListIcons)),this._watchEvents.push(this.watch("editToolbar",this._editToolbarEvents)),this._watchEvents.push(this.watch("showTravelModesOption",this._showTravelModesOption)),this._watchEvents.push(this.watch("showMilesKilometersOption",this._showMilesKilometersOption)),this._watchEvents.push(this.watch("showClearButton",this._showClearButton)),this._watchEvents.push(this.watch("directionsLengthUnits",this.setDirectionsLengthUnits)),this._watchEvents.push(this.watch("directionsLanguage",this.setDirectionsLanguage)),this._watchEvents.push(this.watch("mapClickActive",this._activate)),this._watchEvents.push(this.watch("showActivateButton",this._showActivateButton)),this._watchEvents.push(this.watch("showPrintPage",function(){v.set(this._printButton,"display",this.showPrintPage?"inline-block":"none")})),this._watchEvents.push(this.watch("showSaveButton",function(){v.set(this._saveMenuButton,"display",this.showSaveButton&&this.owningSystemUrl?"inline-block":"none")}))},_editToolbarEvents:function(){var t=s.hitch(this,function(t){var e="",s=t.routeResults?t.routeResults[0]:null;if(s&&s.route){var i=s.route.attributes,o=this.routeParams.travelMode;if(o){e+="<b>"+o.name+"</b> "+T.widgets.directions.toNearbyStops+": ";var r=void 0!==i["Total_"+o.timeAttributeName]?this._formatTime(i["Total_"+o.timeAttributeName]):"",n=(void 0!==i["Total_"+o.distanceAttributeName]?this._formatDistance(i["Total_"+o.distanceAttributeName],!1,o.distanceAttributeName):"")+(r?" &middot; "+r:"");e+=n}else e=this._formatArbitraryCostsForRouteTooltip(i)}this._handle._showTooltip(e)}),e=s.hitch(this,function(i,o){var r=new D,n=this._handle,a=this.map.toScreen(n._origPoint).offset(i.transform.dx+n.symbol.xoffset,i.transform.dy+n.symbol.yoffset);if(i.origMapPoint||(i.origMapPoint=this.map.toMap(a)),v.set(n._tooltip,"left",a.x+"px"),v.set(n._tooltip,"top",a.y+"px"),clearTimeout(n._solveTimeout),this._solveInProgress||!this._requestQueueTail.isFulfilled())n._solveTimeout=setTimeout(function(){e(i,o).always(r.resolve)},100);else if(n._isStopIcon){var h=i.graphic._index,c=this.stops[h],u=c?{name:c.name,extent:c.extent,feature:new A(c.feature.toJson())}:null;u?(u.feature.setGeometry(i.origMapPoint),this._modifiedWaypointIndex=this._isStopAWaypoint(this.stops[h])?h:null,this._incrementalSolveStopRange={start:this.returnToStart?(this.stops.length+h-1)%this.stops.length:Math.max(0,h-1),end:this.returnToStart?(h+1)%this.stops.length:Math.min(this.stops.length-1,h+1)},this.updateStop(u,h,o).always(s.hitch(this,function(e){n._solveTimeout=null,e.routeResults&&t(e),r.resolve()}))):r.resolve()}else r.resolve();return r.promise});this._onEvents.push(_(this.editToolbar,"graphic-click",s.hitch(this,function(t){if(t.graphic.attributes.isWaypoint)!t.graphic._isStopIcon||this._moveInProgress||this._solveInProgress||(this._handle._remove(),this._moveInProgress=!0,this.removeStop(t.graphic._index,!0).always(s.hitch(this,function(){this._moveInProgress=!1})));else{var e=this.get("map").infoWindow;e&&(e.setFeatures([t.graphic]),e.show(t.graphic.geometry))}}))),this._onEvents.push(_(this.editToolbar,"graphic-move-start",s.hitch(this,function(t){this._blurGeocoders(),this._moveInProgress=!0,this._removeEmptyStops(),this.routeParams.returnDirections=!1,this.routeParams.returnRoutes=!0;var e=t.graphic;e._origPoint=new j(e.geometry.toJson()),e._maxDeviation=0,e._solveHasHappened=!1,this.map.disableMapNavigation()}))),this._onEvents.push(_(this.editToolbar,"graphic-move-stop",s.hitch(this,function(t){this.map.enableMapNavigation(),this.routeParams.returnDirections=!0,this.routeParams.returnRoutes=!1,this._handle._isStopIcon&&this._handle._solveHasHappened?this._handle.attributes.isWaypoint?e(t,!0).always(s.hitch(this,function(){this._moveInProgress=!1,this._handle._isStopIcon=!0,this._handle._remove(),this._showLoadingSpinner()})):(clearTimeout(this._handle._solveTimeout),this._handle._solveTimeout=null,this._reverseGeocode(new A(t.graphic.toJson())).then(s.hitch(this,function(e){this._setReverseGeocode(e,e.feature.geometry,t.graphic._index).always(s.hitch(this,function(){this._moveInProgress=!1,this._handle._remove(),this._showLoadingSpinner()}))}))):this._moveInProgress=!1}))),this._onEvents.push(_(this.editToolbar,"graphic-move",s.hitch(this,function(t){var s=this._handle,i=t.transform;if(i.dx&&i.dy&&(t.graphic._maxDeviation=Math.max(s._maxDeviation,Math.sqrt(i.dx*i.dx+i.dy*i.dy))),s._maxDeviation>10)if(s._solveHasHappened=!0,t.graphic===s&&s.attributes.isWaypoint&&!s._isStopIcon)this.set("optimalRoute",!1),s._index+=.5,s._isStopIcon=!0,t.graphic._stopIndex=s._index,this._incrementalSolveStopRange={start:this.returnToStart?(this.stops.length+s._index-1)%this.stops.length:Math.max(0,s._index-1),end:this.returnToStart?(s._index+1)%(this.stops.length+1):Math.min(this.stops.length,s._index+1)},this.addStop({name:this._waypointName,feature:new A(s.geometry,s.symbol,{isWaypoint:!0,CurbApproach:3})},t.graphic._stopIndex);else{var o=t.graphic.getDojoShape();o&&o.moveToFront(),e(t)}})))},_isStopAWaypoint:function(t){return t&&t.feature&&t.feature.attributes&&t.feature.attributes.isWaypoint},_getStopCount:function(){var t,e=0;for(t=0;t<this.stops.length;t++)e+=!this._isStopAWaypoint(this.stops[t])&&this.stops[t].name?1:0;return e},_getWaypointCount:function(){var t,e=0;for(t=0;t<this.stops.length;t++)e+=this._isStopAWaypoint(this.stops[t])?1:0;return e},_decorateUngeocodedStop:function(t){var e=new D,i=function(s,i){e.resolve({name:void 0===s?T.widgets.directions.unlocatedStop:s.toFixed(6)+" "+i.toFixed(6),feature:t})};if(t.geometry)if(t.geometry.spatialReference&&4326!==t.geometry.spatialReference.wkid)if(this.map&&this.map.spatialReference&&this.map.spatialReference.isWebMercator()){var o=W.xyToLngLat(t.geometry.x,t.geometry.y);i(o[0],o[1])}else if(this._geometryService){var r=new ae;r.outSR=new O(4326),r.geometries=[t.geometry],this._geometryService.project(r).then(s.hitch(this,function(e){e&&e.length?i(e[0].x,e[0].y):i(t.geometry.x,t.geometry.y)}),s.hitch(this,function(){i()}))}else i(t.geometry.x,t.geometry.y);else i(t.geometry.x,t.geometry.y);else i();return e.promise},_trafficLayerUpdate:function(){var t=arguments[1],e=arguments[2],s=this.get("map");t&&this._trafficLayerAdded&&(s.removeLayer(t),this._trafficLayerAdded=!1),e&&this.get("traffic")&&!this._trafficLayerAdded&&(s.addLayer(e),e.show(),this._trafficLayerAdded=!0)},_routeTaskError:function(t){var e=T.widgets.directions.error.routeTask,s=t.details;s&&1===s.length&&("The distance between any inputs must be less than 50 miles (80 kilometers) when walking."===s[0]?e=T.widgets.directions.error.maxWalkingDistance:"Driving a truck is currently not supported outside of North America and Central America."===s[0]&&(e=T.widgets.directions.error.nonNAmTruckingMode)),this._showMessage(e),this.onDirectionsFinish(t)},_showMessage:function(t,e){var s="";if(this.messages.push({msg:t,error:!e}),this.messages.length){s+="<ul>";for(var i=0;i<this.messages.length;i++)s+='<li class="'+(this.messages[i].error?this._css.routesErrorClass:this._css.routesInfoClass)+'">'+this.messages[i].msg+"</li>";s+="</ul>"}this._msgNode&&(this._msgNode.innerHTML=s),e||this.onError(t)},_getUnits:function(t){switch(t){case"esriNAUKilometers":case E.KILOMETERS:return"KILOMETERS";case"esriNAUMeters":case E.METERS:return"METERS";case"esriNAUNauticalMiles":case E.NAUTICAL_MILES:return"NAUTICAL_MILES";case"esriNAUMiles":case E.MILES:return"MILES";default:return t}},_createRouteTask:function(){var t=new D;return this.set("routeTask",new Y(this.get("routeTaskUrl"))),this._createRouteParams(),this.routeTask.getServiceDescription(this.travelModesServiceUrl,this.doNotFetchTravelModesFromOwningSystem).then(s.hitch(this,function(e){e.networkDataset?(this.set("serviceDescription",e),this.set("maxStops",parseInt(this.defaults.maxStops||e.serviceLimits&&e.serviceLimits.Route_MaxStops||20)),this.defaults.portalUrl?(this.owningSystemUrl=this.defaults.portalUrl,t.resolve()):this.routeTask.getOwningSystemUrl().then(s.hitch(this,function(e){this.owningSystemUrl=e,t.resolve()}),t.reject)):(this._showMessage(T.widgets.directions.error.cantFindRouteServiceDescription),t.reject(new Error(T.widgets.directions.error.cantFindRouteServiceDescription)))}),s.hitch(this,function(){this._showMessage(T.widgets.directions.error.cantFindRouteServiceDescription),t.reject(new Error(T.widgets.directions.error.cantFindRouteServiceDescription)),this.mapClickActive=!1,this._activate()})),t.promise},_createSearchSourceDDL:function(){if(!this._searchSourceSelector&&this._globalGeocoder&&this._globalGeocoder.sources&&this._globalGeocoder.sources.length>1){for(var t=s.hitch(this,function(t){this._searchSourceSelector.domNode.blur(),this._globalGeocoder.set("activeSourceIndex",t);for(var e=0;e<this.geocoders.length;e++)this.geocoders[e].set("activeSourceIndex",t)}),e=[{value:"all",label:T.widgets.Search.main.all,selected:!0}],i=0;i<this._globalGeocoder.sources.length;i++)e.push({value:String(i),label:this._globalGeocoder.sources[i].name});this._searchSourceSelector=new h({className:"esriSearchSourcesDDL",style:"width:100%;",options:e},this._searchSourceSelectorContainer),this._searchSourceSelector.startup(),this._searchSourceSelector.on("change",t),t("all"),this._searchSourceSelector.domNode.style.width=""}else this._globalGeocoder.sources.length<2&&(this._searchSourceContainerNode.style.display="none")},_createTravelModesDDL:function(){this._travelModeSelector||(this._travelModeSelector=new h({className:"esriTravelModesDDL",style:"width:100%;"},this._travelModeSelectorContainer),this._travelModeSelector.startup(),this._travelModeSelector._interractive=!0,this._travelModeSelector.on("change",s.hitch(this,function(t){this._travelModeSelector._interractive?this._enqueue(function(){return this._setTravelMode(t).always(s.hitch(this,function(){this._travelModeSelector._interractive=!0}))}):this._travelModeSelector._interractive=!0})))},_setupTravelModes:function(){var t=this.get("serviceDescription"),e=t.supportedTravelModes,s=new D;if(e&&e.length&&this._travelModeSelector){for(var i=e[0].name,o=[],r=0;r<e.length;r++){for(var n="AUTOMOBILE"===e[r].type?"Driving":"TRUCK"===e[r].type?"Trucking":"WALK"===e[r].type?"Walking":"Other",a="",h=t.networkDataset.networkAttributes,c=0;c<h.length;c++){var d=h[c];if(d.name===e[r].impedanceAttributeName){"esriNAUCentimeters"===d.units||"esriNAUDecimalDegrees"===d.units||"esriNAUDecimeters"===d.units||"esriNAUFeet"===d.units||"esriNAUInches"===d.units||"esriNAUKilometers"===d.units||"esriNAUMeters"===d.units||"esriNAUMiles"===d.units||"esriNAUMillimeters"===d.units||"esriNAUNauticalMiles"===d.units||"esriNAUYards"===d.units?a="Distance":("esriNAUDays"===d.units||"esriNAUHours"===d.units||"esriNAUMinutes"===d.units||"esriNAUSeconds"===d.units)&&(a="Time");break}}o.push({id:e[r].name,label:'<div class="esriTravelModesDirectionsIcon esriTravelModesType'+n+a+'">&nbsp;</div><div class="esriTravelModesTypeName">'+e[r].name+"</div>"}),!t.defaultTravelMode||e[r].id!==t.defaultTravelMode&&e[r].itemId!==t.defaultTravelMode||(i=e[r].name)}this._showTravelModesOption(),this._travelModeSelector.setStore(new l({objectStore:new u({data:o})})),this._travelModeSelector._interractive=!1,this._travelModeSelector.setValue(i),this._setTravelMode(i).always(s.resolve)}else this.set("showTravelModesOption",!1),s.resolve();return s.promise},_createPrintTask:function(){this.printTaskUrl=this._usingAGOL()?this.printTaskUrl:this.defaults.printTaskUrl,this._printService=this.printTaskUrl?new se(this.printTaskUrl,{async:!1}):null;var t=new oe;t.exportOptions={width:670,height:750,dpi:96},t.format="PNG32",t.layout="MAP_ONLY",t.preserveScale=!1,t.showAttribution=!1;var e=new ie;e.map=this.map,e.outSpatialReference=this.map.spatialReference,e.template=t,this._printParams=e},_createGeometryTask:function(){this._geometryService=null,this._usingAGOL()?this._geometryService=new te(this.geometryTaskUrl):(this._geometryService=this.defaults.geometryTaskUrl?new te(this.defaults.geometryTaskUrl):ne.defaults.geometryService,this.geometryTaskUrl=this._geometryService?this._geometryService.url:null)},_showTravelModesOption:function(){var t=this.get("serviceDescription"),e=this.showTravelModesOption&&t&&t.supportedTravelModes&&t.supportedTravelModes.length&&!this.doNotFetchTravelModesFromOwningSystem;v.set(this._travelModeContainerNode,"display",e?"block":"none")},_showMilesKilometersOption:function(){v.set(this._agolDistanceUnitsNode,"display",this.showMilesKilometersOption?"block":"none")},_showClearButton:function(){v.set(this._clearDirectionsButtonNode,"display",this.showClearButton?"inline-block":"none")},_showActivateButton:function(){v.set(this._activateButtonNode,"display",this.showActivateButton?"inline-block":"none"),this.showActivateButton||this.deactivate()},_createRouteParams:function(){var t={outputGeometryPrecision:0,outputGeometryPrecisionUnits:"esriMeters",restrictUTurns:"esriNFSBAtDeadEndsOnly"},e={returnDirections:!0,returnRoutes:!1,outputLines:"esriNAOutputLineTrueShape",preserveFirstStop:!0,preserveLastStop:!0,timeWindowsAreUTC:!0,directionsOutputType:"complete",stops:new Z,ignoreInvalidLocations:!0,doNotLocateOnRestrictedElements:!0,outSpatialReference:this.get("map").spatialReference};this.get("routeParams")||(this.routeParams={});var i=new X;this.routeParams=s.mixin(i,t,this.get("routeParams"),e)},_markWPsForRemovalAfterUserChangedStopSequence:function(t,e){for(var s=t-1,i=[];s>=0&&this._isStopAWaypoint(this.stops[s]);)i.push(this.stops[s]),s--;for(s=t+1;s<this.stops.length&&this._isStopAWaypoint(this.stops[s]);)i.push(this.stops[s]),s++;if(e>t)for(s=e+1;s<this.stops.length&&this._isStopAWaypoint(this.stops[s]);)i.push(this.stops[s]),s++;else if(void 0!==e)for(s=e-1;s>=0&&this._isStopAWaypoint(this.stops[s]);)i.push(this.stops[s]),s--;else if(this.returnToStart&&0===t)for(s=this.stops.length-1;s>=0&&this._isStopAWaypoint(this.stops[s]);)i.push(this.stops[s]),s--;return i},_removeSomeWaypoints:function(t){for(var e=new D,s=[],i=0;i<t.length;i++){var r=o.indexOf(this.stops,t[i]);r>-1&&s.push(this._removeStop(r,!0,!0))}return N(s).always(e.resolve),e.promise},_modifyStopSequence:function(t,e){var i,o=this._dnd.getAllNodes(),r=new D,n=[];if(o.length)if(this._removeLocateButtonVisibilityEvents(),arguments.length&&void 0!==t)if(t>=0&&e>=0&&t<this.stops.length&&e<this.stops.length&&t!==e){var a=this._markWPsForRemovalAfterUserChangedStopSequence(t,e),h=this.stops.splice(t,1);for(this.stops.splice(e,0,h[0]),i=0;i<this.stops.length;i++)n.push(this._updateStop(this.stops[i],i));n.push(this._removeSomeWaypoints(a)),N(n).always(s.hitch(this,function(){this._solveAndZoom().always(r.resolve)}))}else r.reject("Invalid From and To values.");else{for(i=0;i<this.stops.length;)this._isStopAWaypoint(this.stops[i])?n.push(this._removeStop(i,!0,!0)):i++;N(n).always(s.hitch(this,function(){for(n=[],this.stops.reverse(),i=0;i<this.stops.length;i++)n.push(this._updateStop(this.stops[i],i));N(n).always(s.hitch(this,function(){this._solveAndZoom().always(r.resolve)}))}))}else r.resolve();return r.promise},_setMenuNodeValues:function(){this._clearDisplayBeforeSolve();var t=this.get("optimalRoute");if(this._findOptimalOrderNode&&y.set(this._findOptimalOrderNode,"checked",t),this._returnToStartNode){var e=this.returnToStart&&!this.maxStopsReached&&this.stops[0]&&(!this.stops[0].feature||this._isStopLocated(this.stops[0]));y.set(this._returnToStartNode,"checked",e),this.set("returnToStart",e),this.maxStopsReached&&this.returnToStart&&this._showMessage(T.widgets.directions.error.maximumStops)}if(!this.returnToStart&&!this._incrementalSolveStopRange&&this.directions){this._incrementalSolveStopRange={start:this.stops.length-1,end:this.stops.length},this._clearRouteGraphics(),this._incrementalSolveStopRange=null;for(var s=this.stops.length;s-->0&&this._isStopAWaypoint(this.stops[s]);)this._removeSomeWaypoints([this.stops[s]])}var i=this.get("traffic");this._useTrafficNode&&(y.set(this._useTrafficNode,"checked",i),i?this._addTrafficLayer():this._removeTrafficLayer());var o=this.get("directionsLengthUnits");switch(o){case E.KILOMETERS:y.set(this._useKilometersNode,"checked",!0),y.set(this._useMilesNode,"checked",!1);break;case E.MILES:y.set(this._useKilometersNode,"checked",!1),y.set(this._useMilesNode,"checked",!0)}v.set(this._printButton,"display",this.showPrintPage?"inline-block":"none"),v.set(this._saveMenuButton,"display",this.showSaveButton&&this.owningSystemUrl?"inline-block":"none"),this._showMilesKilometersOption(),this._showClearButton()},_optionsMenu:function(){if(this._useTrafficItemNode&&v.set(this._useTrafficItemNode,"display",this.get("showTrafficOption")?"block":"none"),this._returnToStartItemNode&&v.set(this._returnToStartItemNode,"display",this.get("showReturnToStartOption")?"block":"none"),this._findOptimalOrderItemNode&&v.set(this._findOptimalOrderItemNode,"display",this.get("showOptimalRouteOption")&&this._getStopCount()>3?"block":"none"),this.stops.length>=this.get("minStops"))S.add(this._widgetContainer,this._css.stopsOptionsOptionsEnabledClass);else{if(S.remove(this._widgetContainer,this._css.stopsOptionsOptionsEnabledClass),this._optionsMenuNode){var t=v.get(this._optionsMenuNode,"display");"block"===t&&this._toggleOptionsMenu()}this._configureRouteOptions()}},_stopsRemovable:function(){this._dnd.getAllNodes().length-this._getWaypointCount()>2?S.add(this._widgetContainer,this._css.stopsRemovableClass):S.remove(this._widgetContainer,this._css.stopsRemovableClass)},_checkMaxStops:function(){this.set("maxStopsReached",this._getStopCount()+this._getWaypointCount()+(this.returnToStart?1:0)>=this.maxStops),this._showAddDestination()},_updateThemeWatch:function(){var t=arguments[1],e=arguments[2];S.remove(this.domNode,t),S.add(this.domNode,e)},_toggleOptionsMenu:function(){var t=v.get(this._optionsMenuNode,"display");"block"===t?(v.set(this._optionsMenuNode,"display","none"),this._optionsButtonNode.innerHTML=T.widgets.directions.showOptions):(v.set(this._optionsMenuNode,"display","block"),this._optionsButtonNode.innerHTML=T.widgets.directions.hideOptions)},_toggleSaveMenu:function(t){var e=v.get(this._saveMenuNode,"display");"block"===e||t===!1?(v.set(this._saveMenuNode,"display","none"),S.remove(this._saveMenuButton,this._css.stopsPressedButtonClass)):(this.clearMessages(),v.set(this._saveMenuNode,"display","block"),S.add(this._saveMenuButton,this._css.stopsPressedButtonClass),this._enableSharing().then(s.hitch(this,function(){if(this._outputLayer.setValue(this.routeLayer.title?this.routeLayer.title:this.directions&&this.directions.routeName),this.routeLayer.ownerFolder)for(var t=this._folderSelector.store.objectStore.data,e=0;e<t.length;e++)if(t[e].folderId===this.routeLayer.ownerFolder){this._folderSelector.getValue()!==t[e].id&&(this._folderSelector._interractive=!1,this._folderSelector.setValue(t[e].id));break}this._enableButton(this._saveButton,this.routeLayer.isItemOwner||!this._userCanCreatePortalItem),this._outputLayer.set("disabled",!1)})))},_showToolbar:function(){S[this.stops.length<this.maxStops&&this.canModifyStops||this.canModifyWaypoints?"add":"remove"].call(L,this._widgetContainer,this._css.addStopsClass)},_showAddDestination:function(){this._showToolbar(),this._addDestinationNode.style.display=this.stops.length<this.maxStops&&this.canModifyStops?"inline":"none"},_showMapClickActiveButton:function(){this._showToolbar(),this._activateButtonNode.style.display=this.canModifyStops||this.canModifyWaypoints?"inline-block":"none"},_getAbsoluteUrl:function(e){return e=t.toUrl(e),/^https?\:/i.test(e)?e:/^\/\//i.test(e)?window.location.protocol+e:/^\//i.test(e)?window.location.protocol+"//"+window.location.host+e:e},_getManeuverImage:function(t){if(t){var e="./images/Directions/maneuvers/",s=".png";return"esriDMTStop"===t||"esriDMTDepart"===t?"":this._getAbsoluteUrl(e+t+s)}return""},_loadPrintDirections:function(t){var e=this.get("printTemplate"),i=new D;this.directionsLengthUnits!==this.routeParams.directionsLengthUnits?this.getDirections().then(i.resolve,i.reject):i.resolve(),i.then(s.hitch(this,function(){if(!e&&this.directions){var i,r=this._getAbsoluteUrl("./css/Directions.css"),n=this._getAbsoluteUrl("./css/DirectionsPrint.css"),a=this._getAbsoluteUrl("./images/Directions/print-logo.png");i=f.isBodyLtr()?"ltr":"rtl",e="",e+="<!DOCTYPE HTML>",e+='<html lang="en" class="'+this.get("theme")+'" dir="'+i+'">',e+="<head>",e+='<meta charset="utf-8">',e+='<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">',e+="<title>"+this.get("directions").routeName+"</title>",e+='<link rel="stylesheet" media="screen" type="text/css" href="'+r+'" />',e+='<link rel="stylesheet" media="print" type="text/css" href="'+n+'" />',e+="</head>",e+='<body class="'+this._css.esriPrintPageClass+'">',e+='<div class="'+this._css.esriPrintBarClass+'">',e+='<div class="'+this._css.esriCloseButtonClass+'" title="'+T.common.close+'" onclick="window.close();">'+T.common.close+"</div>",e+='<div id="printButton" class="'+this._css.esriPrintButtonClass+'" title="'+T.widgets.directions.print+'" onclick="window.print();">'+T.widgets.directions.print+"</div>",e+="</div>",e+='<div class="'+this._css.esriPrintMainClass+'">',e+='<div class="'+this._css.esriPrintHeaderClass+'">',e+='<img class="'+this._css.esriPrintLogoClass+'" src="'+a+'" />',e+='<div class="'+this._css.esriPrintNameClass+'">'+this.get("directions").routeName+"</div>",e+='<div class="'+this._css.esriPrintLengthClass+'">'+this._formatDistance(this.get("directions").totalLength,!0)+" &middot; "+this._formatTime(this.get("directions").totalTime)+"</div>",t&&(e+='<div id="divMap" class="esriPrintMap esriPrintWait"></div>',e+='<hr class="esriNoPrint"/>'),e+='<div id="print_helper"></div>',e+='<textarea onkeyup="document.getElementById(\'print_helper\').innerHTML=this.value;" id="print_area" class="'+this._css.esriPrintNotesClass+'" placeholder="'+T.widgets.directions.printNotes+'"></textarea>',e+='<div class="'+this._css.clearClass+'"></div>',e+="</div>",e+='<div class="'+this._css.esriPrintDirectionsClass+'">',e+="<table>",e+="<tbody>",o.forEach(this.directions.features,s.hitch(this,function(t,s){var i,o=(this.directions.strings[s]||[]).slice();
if("esriDMTDepart"===t.attributes.maneuverType||"esriDMTStop"===t.attributes.maneuverType)for(i=0;i<this.stops.length;i++)this.stops[i]&&this.stops[i].name&&o.push({string:this.stops[i].name});if(o){var r=t.attributes.text;for(i=0;i<o.length;i++)r=this._boldText(r,o[i].string);t.attributes.formattedText=r}else t.attributes.formattedText=t.attributes.text;var n="";this.get("directions").features.length===s+1&&(n=this._css.routeLastClass),t.attributes&&(t.attributes.step=s+1),e+='<tr class="'+n+'">',e+='<td class="'+this._css.routeIconColumnClass+'">';var a=this._getManeuverImage(t.attributes.maneuverType),h=this._getLetter(t._associatedStop);a?e+='<img src="'+a+'" />':h&&(e+='<div class="'+this._css.esriPrintStopLabelClass+'">',e+=h,e+="</div>"),e+="</td>",e+='<td class="'+this._css.routeTextColumnClass+'">',e+="<div><strong>"+b.format(t.attributes.step)+".</strong> "+t.attributes.formattedText+"</div>",e+="</td>",e+='<td class="'+this._css.routeTextColumnClass+'">';var c=this._formatTime(t.attributes.time),u=this._formatDistance(t.attributes.length,!1)+(c?" &middot; "+c:"");e+='<div class="'+this._css.routeLengthClass+'">'+u+"</div>",e+="</td>",e+="</tr>"})),e+="</tbody>",e+="</table>",e+="</div>",e+='<div class="'+this._css.esriPrintFooterClass+'">',e+="<p>"+T.widgets.directions.printDisclaimer+"</p>",e+="</div>",e+="</div>",e+="</body>",e+="</html>"}this._printWindow.document.open("text/html","replace"),this._printWindow.document.write(e),this._printWindow.document.close()}))},_printDirections:function(){if(this.directions){var e=screen.width/2,i=screen.height/1.5,o=screen.width/2-e/2,r=screen.height/2-i/2,n="toolbar=no, location=no, directories=no, status=yes, menubar=no, scrollbars=yes, resizable=yes, width="+e+", height="+i+", top="+r+", left="+o;this.get("printPage")?(window.directions=this.get("directions"),window.open(this.get("printPage"),"directions_widget_print",n,!0)):(this._printWindow=window.open("","directions_widget_print",n,!0),this._loadPrintDirections(!!this._printService),this._printService&&t(["dojo/_base/window"],s.hitch(this,function(t){this.zoomToFullRoute().then(s.hitch(this,function(){this._printService.execute(this._printParams,s.hitch(this,function(e){t.withDoc(this._printWindow.document,function(){var t=g.byId("divMap");t&&(S.remove(t,"esriPrintWait"),S.add(t,"esriPageBreak"),L.create("img",{src:e.url,"class":"esriPrintMapImg"},t))})}),s.hitch(this,function(e){t.withDoc(this._printWindow.document,function(){var t=g.byId("divMap");t&&S.remove(t,"esriPrintWait")}),console.error("Error while calling print service:\n "+e)}))}))})))}},_enableButton:function(t,e){var s=e||void 0===e;S[s?"remove":"add"].apply(this,[t,"esriDisabledDirectionsButton"]),t._enabled=s},_enableSharing:function(){var e=new D;return!this._naRouteSharing&&this.owningSystemUrl?t(["../tasks/NARouteSharing"],s.hitch(this,function(t){this._naRouteSharing=new t(this.owningSystemUrl),this._folderSelector||(this._folderSelector=new h({className:"esriFoldersDDL",style:"width: 100%;",sortByLabel:!1,disabled:!0,_interractive:!0,onChange:s.hitch(this,function(){this._folderSelector._interractive?this._enableButton(this._saveButton,!this.routeLayer.itemId):this._folderSelector._interractive=!0})},this._folderSelectorContainer),this._folderSelector.startup(),this._outputLayer=new c({style:"width: 100%",required:!0,trim:!0,regExp:'[^:|&|<|>|%|#|?|\\|"|/|+]+',maxLength:98,disabled:!0,onKeyPress:s.hitch(this,function(){this._enableButton(this._saveButton,!this.routeLayer.itemId||!this._userCanCreatePortalItem)})},this._outputLayerContainer),this._outputLayer.startup()),this._naRouteSharing.getFolders().then(s.hitch(this,function(t){for(var i=[],o=0;o<t.length;o++)i.push({id:t[o].url,folderId:t[o].id,label:t[o].title});this._folderSelector.setStore(new l({objectStore:new u({data:i})})),this._naRouteSharing.canCreateItem().then(s.hitch(this,function(t){this._folderSelector.set("disabled",!t),this._userCanCreatePortalItem=t})),this._enableButton(this._saveButton),e.resolve()}),s.hitch(this,function(t){console.log(t),this._naRouteSharing=null,this._toggleSaveMenu(!1),e.reject(t)}))})):this.owningSystemUrl?e.resolve():(e.reject(new Error("Owning system is not defined, or the Directions widget is not done initializing.")),this._naRouteSharing=null),e.promise},_storeRouteUI:function(){var t=new D;return this._outputLayer&&this._outputLayer.isValid()?this._storeRoute(this._outputLayer.getValue(),this._folderSelector.getValue(),this._folderSelector.store.objectStore.get(this._folderSelector.getValue()).folderId).then(t.resolve,t.reject):(this._outputLayer&&this._outputLayer.focus(),t.reject(new Error("Need result layer name specified."))),t.promise},_storeRoute:function(t,e,i){var r=new D,n=this.directions;if(this._savingRoute||!this._naRouteSharing)return this._saveButton.blur(),r.reject(new Error("Not ready to store route.")),r.promise;if(this.clearMessages(),r.then(null,s.hitch(this,function(t){console.log("ERR",t),this._showMessage(T.widgets.directions.error.cantSaveRoute)})),r.promise.always(s.hitch(this,function(){this._enableButton(this._saveButton),v.set(this._saveAsButton,"display",this.routeLayer.itemId&&this._userCanCreatePortalItem?"inline-block":"none"),this._showLoadingSpinner(),this._savingRoute=!1})),n&&n.features&&n.features.length&&this.stops&&this.stops.length)if(this.owningSystemUrl)if(this.routeParams&&this.routeParams.travelMode)if(t&&e){var a,h,c,u=s.hitch(this,function(t){return this._naRouteSharing.getAttributeUnits(t,this.serviceDescription)}),l=this.routeParams.travelMode.timeAttributeName,d=this.routeParams.travelMode.distanceAttributeName,p=u(l),_=u(d),m=this.routeParams.directionsLengthUnits||this.serviceDescription.directionsLengthUnits,g=this._naRouteSharing.toMeters,f=this._naRouteSharing.toMinutes,S=function(t,e,s){var i;for(var r in t)t.hasOwnProperty(r)&&0===r.indexOf(e)&&-1===o.indexOf(s,r.substr(e.length))&&(i=i||{},i[r]=t[r]);return i},y=[],w=[],b=[];if(l&&p&&d&&_){var C=[l,d],M=this.routeParams.accumulateAttributes||this.serviceDescription.accumulateAttributeNames||[],L=this.serviceDescription.networkDataset.networkAttributes;for(a=0;a<L.length;a++)"esriNAUTCost"===L[a].usageType&&-1===o.indexOf(M,L[a].name)&&C.push(L[a].name);var N=this.get("stops"),R={xmin:1/0,ymin:1/0,xmax:-1/0,ymax:-1/0};for(a=0;a<N.length;a++)if(N[a].feature&&N[a].feature.toJson){var P=N[a].feature.toJson(),A=P.attributes,E=P.geometry,I=this._naRouteSharing.getUTCOffset(A.ArriveTime,A.ArriveTimeUTC),O=this._naRouteSharing.getUTCOffset(A.DepartTime,A.DepartTimeUTC);s.mixin(R,{xmin:R.xmin>E.x?E.x:R.xmin,ymin:R.ymin>E.y?E.y:R.ymin,xmax:R.xmax<E.x?E.x:R.xmax,ymax:R.ymax<E.y?E.y:R.ymax}),P.attributes={CurbApproach:A.CurbApproach,ArrivalCurbApproach:A.ArriveCurbApproach,DepartureCurbApproach:A.DepartCurbApproach,Name:A.Name!==this._waypointName?A.Name:T.widgets.directions.waypoint,Sequence:A.Sequence,Status:A.Status,LocationType:A.isWaypoint?1:0,TimeWindowStart:A.TimeWindowStart,TimeWindowEnd:A.TimeWindowEnd,ServiceMinutes:f(A["Attr_"+l],p),ServiceMeters:g(A["Attr_"+d],_),ServiceOtherCosts:x.stringify(S(A,"Attr_",C)),CumulativeMinutes:f(A["Cumul_"+l],p),CumulativeMeters:g(A["Cumul_"+d],_),CumulativeOtherCosts:x.stringify(S(A,"Cumul_",C)),LateMinutes:f(A["Violation_"+l],p),WaitMinutes:f(A["Wait_"+l],p),ArrivalTime:this._naRouteSharing.toUTCTime(A.ArriveTime,I),DepartureTime:this._naRouteSharing.toUTCTime(A.DepartTime,O),ArrivalUTCOffset:I,DepartureUTCOffset:O},y.push(P)}var k=0,U=function(t){var e;try{t.strings=x.parse(t.strings)}catch(s){q.strings=void 0}if(t.strings&&t.strings.length){for(var i=0;i<t.strings.length;i++)if("esriDSTGeneral"===t.strings[i].stringType){e=t.strings[i].string,t.strings.splice(i,1);break}t.strings=x.stringify(t.strings)}return e};for(a=0;a<n.featuresWithWaypoints.length;a++){var W=n.featuresWithWaypoints[a],B=W.toJson(),G=B.attributes,j=B.geometry&&B.geometry.paths&&B.geometry.paths[0]||[];c=this._naRouteSharing.getUTCOffset(G.ETA,G.arriveTimeUTC),B.attributes={Sequence:a+1,StopSequence:W._associatedStopWithReturnToStart&&W._associatedStopWithReturnToStart.attributes.Sequence,ArrivalTime:this._naRouteSharing.toUTCTime(G.ETA,c),UTCOffset:c,ManeuverType:G.maneuverType,Meters:g(G.length,m),Minutes:f(G.time,p),DirectionText:W._associatedStopWithReturnToStart&&W._associatedStopWithReturnToStart.attributes.isWaypoint?G.text.replace(this._waypointName,T.widgets.directions.waypoint):G.text,ManeuverMessages:x.stringify(n.stringsWithWaypoints[a])},delete B.symbol,delete B.infoTemplate;var F=!0;for(h=0;h<j.length-1;h++)if(j[h][0]!==j[h+1][0]||j[h][1]!==j[h+1][1]){F=!1;break}F&&delete B.geometry,w.push(B);var q=n.eventsWithWaypoints[B.attributes.Sequence]||[];for(h=0;h<q.length;h++){var H=q[h].toJson(),V=H.attributes;c=this._naRouteSharing.getUTCOffset(V.ETA,V.arriveTimeUTC),H.attributes={DirectionSequence:B.attributes.Sequence,Sequence:++k,ArrivalTime:this._naRouteSharing.toUTCTime(V.ETA,c),UTCOffset:c,EventText:U(V),EventMessages:V.strings},b.push(H)}}var K={geometry:n.mergedGeometry,attributes:{RouteName:n.routeName,TotalMinutes:f(n.totalTime,p),TotalMeters:g(n.totalLength,m),TotalLateMinutes:function(){for(var t=0,e=0;e<y.length;e++)t+=y[e].attributes.LateMinutes||0;return t}(),TotalWaitMinutes:function(){for(var t=0,e=0;e<y.length;e++)t+=y[e].attributes.WaitMinutes||0;return t}(),OtherCosts:y[y.length-1].attributes.CumulativeOtherCosts,StartTime:y[0].attributes.ArrivalTime,EndTime:y[y.length-1].attributes.DepartureTime,StartUTCOffset:y[0].attributes.ArrivalUTCOffset,EndUTCOffset:y[y.length-1].attributes.DepartureUTCOffset,Messages:x.stringify(this._solverMessages),AnalysisSettings:x.stringify({travelMode:s.hitch(this,function(){var t=s.clone(this.routeParams.travelMode);return"&lt;"===t.name.substr(0,4)&&"&gt;"===t.name.substr(t.name.length-4,4)&&(t.name=t.name.substr(4,t.name.length-8)),t})(),directionsLanguage:this.routeParams.directionsLanguage||this.serviceDescription.directionsLanguage,startTime:this.routeParams.startTime instanceof Date?this.routeParams.startTime.getTime():this.routeParams.startTime,startTimeIsUTC:this.routeParams.startTimeIsUTC,timeWindowsAreUTC:this.routeParams.timeWindowsAreUTC,findBestSequence:this.routeParams.findBestSequence,preserveFirstStop:this.routeParams.preserveFirstStop,preserveLastStop:this.routeParams.preserveLastStop,accumulateAttributeNames:this.routeParams.accumulateAttributes||this.serviceDescription.accumulateAttributeNames})}};this._enableButton(this._saveButton,!1),this._savingRoute=!0,this._showLoadingSpinner(!0),s.hitch(this,function(){var t=new D;return this._printService?this.zoomToFullRoute().then(s.hitch(this,function(){var e=this._printParams.template,s=e.exportOptions;e.exportOptions={width:200,height:133,dpi:96},this._printService.execute(this._printParams,function(i){e.exportOptions=s,t.resolve(i.url)},function(i){e.exportOptions=s,console.error("Error while calling print service:\n "+i),t.resolve()})})):t.resolve(),t.promise})().then(s.hitch(this,function(o){var a={folder:e,name:t,stops:y,directions:w,directionEvents:b,extent:function(){return s.mixin(s.clone(n.extent),{xmin:R.xmin>n.extent.xmin?n.extent.xmin:R.xmin,ymin:R.ymin>n.extent.ymin?n.extent.ymin:R.ymin,xmax:R.xmax<n.extent.xmax?n.extent.xmax:R.xmax,ymax:R.ymax<n.extent.ymax?n.extent.ymax:R.ymax})}(),routeInfo:K,thumbnail:o};this._userCanCreatePortalItem?this._naRouteSharing.store(a,this.routeLayer.itemId).then(s.hitch(this,function(t){if(t.success){var e=this._naRouteSharing.portal,o="//"+(e.isPortal?e.portalHostname:e.urlKey+"."+e.customBaseUrl);this._toggleSaveMenu(),this._showMessage(T.widgets.directions.routeIsSaved+"<br/><a class='esriLinkButton' target='_blank' href='"+o+"/home/item.html?id="+t.id+"'>"+T.widgets.directions.share+"</a>",!0),this.routeLayer.itemId?this.onRouteItemUpdated(t.id):this.onRouteItemCreated(t.id),s.mixin(this.routeLayer,{itemId:t.id,title:a.name,isItemOwner:!0,ownerFolder:i}),r.resolve(t)}else r.reject(t)}),r.reject):this._naRouteSharing.createFeatureCollection(a).then(s.hitch(this,function(t){r.resolve(t),this._toggleSaveMenu(),this.onFeatureCollectionCreated(t)}),r.reject)}))}else r.reject(new Error("Cannot deduce the impedance used."))}else r.reject(new Error("Missing required parameter: layerName, folder must be specified."));else r.reject(new Error("Shared route must be built using a Travel Mode."));else r.reject(new Error("Cannot store route: owning system to store routes is not defined. Please specify Portal or ArcGIS Online Url in constructor."));else r.reject(new Error("No route to share. Build a route first."));return r.promise},_loadRoute:function(t){var e=new D;return e.promise.always(s.hitch(this,function(){this._showLoadingSpinner(!1),v.set(this._saveAsButton,"display",this.routeLayer.itemId&&this._userCanCreatePortalItem?"inline-block":"none"),this._enableButton(this._saveButton,this.routeLayer.isItemOwner)})),this._reset().then(s.hitch(this,function(){this._showLoadingSpinner(!0),this._enableSharing().then(s.hitch(this,function(){var i=s.clone(this.serviceDescription);i.directionsLengthUnits=this.directionsLengthUnits,this._naRouteSharing.load(t,i).then(s.hitch(this,function(i){var o,r,n,a,h,c,d=1/0,p=-1/0,_=i.solveResult.routeResults[0].stops,m=i.solveResult.routeResults[0].directions.features,g={};for(o=0;o<_.length;o++){var f=_[o].attributes;if(f.isWaypoint)for(r=0;r<m.length;r++)a=m[r].attributes,a._stopSequence===f.Sequence&&(a.text=a.text.replace(f.Name,this._waypointName));n=f.Name+"_"+this._stopSequence++,g[n]=f.isWaypoint?this._waypointName:f.Name,f.Name=n,f.Sequence<d&&(null!==f.ArriveCurbApproach||null!==f.DepartCurbApproach)&&(h=f.Name,d=f.Sequence),f.Sequence>p&&(null!==f.ArriveCurbApproach||null!==f.DepartCurbApproach)&&(c=f.Name,p=f.Sequence)}for(n=h+" - "+c,i.solveResult.routeResults[0].routeName=n,i.solveResult.routeResults[0].directions.routeName=n,o=0;o<m.length;o++)if(a=m[o].attributes,void 0!==a._stopSequence)for(r=0;r<_.length;r++)if(a._stopSequence===_[r].attributes.Sequence){n=_[r].attributes.Name,a.text=(a.text||"").replace(g[n],n),delete a._stopSequence;break}s.mixin(this.routeParams,i.routeParameters),this.set("optimalRoute",this.routeParams.findBestSequence),this.set("traffic",null!==this.routeParams.startTime);var v=_[_.length-1];_[0].geometry.x===v.geometry.x&&_[0].geometry.y===v.geometry.y&&(this._returnToStartStop=this._addStopWrapperToGraphic(new A(v.geometry,null,v.attributes),g[v.attributes.Name]),this.set("returnToStart",!0));var S=this._travelModeSelector.store.objectStore.data.slice(),y=i.routeParameters.travelMode,w="AUTOMOBILE"===y.type?"Driving":"TRUCK"===y.type?"Trucking":"WALK"===y.type?"Walking":"Other",b="",T=this.serviceDescription.networkDataset.networkAttributes;for(r=0;r<T.length;r++){var C=T[r];if(C.name===y.impedanceAttributeName){"esriNAUCentimeters"===C.units||"esriNAUDecimalDegrees"===C.units||"esriNAUDecimeters"===C.units||"esriNAUFeet"===C.units||"esriNAUInches"===C.units||"esriNAUKilometers"===C.units||"esriNAUMeters"===C.units||"esriNAUMiles"===C.units||"esriNAUMillimeters"===C.units||"esriNAUNauticalMiles"===C.units||"esriNAUYards"===C.units?b="Distance":("esriNAUDays"===C.units||"esriNAUHours"===C.units||"esriNAUMinutes"===C.units||"esriNAUSeconds"===C.units)&&(b="Time");break}}y.name="&lt;"+y.name+"&gt;",this.serviceDescription.supportedTravelModes=(this.serviceDescription.supportedTravelModes||[]).concat(y),S.push({id:y.name,label:'<div class="esriTravelModesDirectionsIcon esriTravelModesType'+w+b+'">&nbsp;</div><div class="esriTravelModesTypeName">'+y.name+"</div>"}),this._travelModeSelector.setStore(new l({objectStore:new u({data:S})})),this._travelModeSelector._interractive=!1,this._travelModeSelector.setValue(y.name),this._solveResultProcessing(i.solveResult,g).then(s.hitch(this,function(){s.mixin(this.routeLayer,{itemId:t,title:i.title,isItemOwner:i.isItemOwner,ownerFolder:i.ownerFolder});for(var o=0;o<i.loadMessages.length;o++)this._showMessage(i.loadMessages[o].message);this.zoomToFullRoute(),e.resolve(i)}),e.reject)}),s.hitch(this,function(t){e.reject(t),this._showMessage("GWM_0003"===t.messageCode?T.widgets.directions.error.accessDenied+this._naRouteSharing.portal.getPortalUser().username:T.widgets.directions.error.loadError)}))}),e.reject)}),e.reject),e.promise}});return p("extend-esri")&&s.setObject("dijit.Directions",he,P),he});