// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/has","dojo/query","dojo/_base/array","dojo/store/Memory","dojo/data/ObjectStore","dojo/dom-style","dijit/form/Select","dijit/form/TextBox","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","../../kernel","dojo/text!./templates/RFxBandCombinationEditor.html","dojo/i18n!../../nls/jsapi"],function(t,e,s,n,a,i,o,d,h,r,l,u,m,b,c,g){var v=t("RFxBandCombinationEditor",[l,u,m],{baseClass:"esriRFxBandCombinationEditor",templateString:c,schemaArgDefinitions:{},inputArgs:{},rasterArgs:{},rasterFunctionSchema:null,rasterFunctionEnums:null,rasterSelect:null,constructor:function(e){this.inherited(arguments),t.safeMixin(this,e),this._i18n=g.widgets.rasterFunctionEditor.rfxBandCombinationEditor},postCreate:function(){this.inherited(arguments),this._processRasterArgs(),this._bandControls=[this.bandNameSelect,this.bandWavelengthSelect,this.bandIdSelect],this._setupBandComboStore(),this._setArgVisibilities(),this._setupValues()},_setupValues:function(){var t=this.inputArgs;t&&t.Method&&void 0!==t.Method.value?this.methodSelect.set("value",t.Method.value.toString()):(!t.BandIds||t.BandNames||t.BandWavelengths?!t.BandNames||t.BandIds||t.BandWavelengths?!t.bandWavelengths||t.BandIds||t.BandNames||this.methodSelect.set("value","1"):this.methodSelect.set("value","0"):this.methodSelect.set("value","2"),this.methodSelect.set("disabled",!0)),0===this.method&&t.BandNames&&t.BandNames.value&&t.BandNames.value.length?this.bandCombinationTextbox.set("value",t.BandNames.value.join(" ")):1===this.method&&t.BandWavelengths&&t.BandWavelengths.value&&t.BandWavelengths.value.length?this.bandCombinationTextbox.set("value",t.BandWavelengths.value.join(" ")):2===this.method&&t.BandIds&&t.BandIds.value&&t.BandIds.value.length&&this.bandCombinationTextbox.set("value",t.BandIds.value.join(" "))},_setArgVisibilities:function(){var t,e=this.inputArgs;this._show(e.Method)||(t=n("."+this.baseClass+"--method"),a.forEach(t,function(t){d.set(t,"display","none")})),this._show(e.BandIds)||this._show(e.BandNames)||this._show(e.BandWavelengths)||(t=n("."+this.baseClass+"--band"),t=t.concat(n("."+this.baseClass+"--combination")),a.forEach(t,function(t){d.set(t,"display","none")}))},_show:function(t){return t?t.hasOwnProperty("isPublic")&&!t.isPublic?!1:!0:!1},_processRasterArgs:function(){if(this.rasterArgs){this.rasterArg=this.rasterArgs.Raster;var t=this.rasterArg&&this.rasterArg.input;t&&(this._updateRasterArg(t.value),t.on("change",e.hitch(this,this._updateRasterArg)))}},_updateRasterArg:function(t){var e=this.rasterArg&&this.rasterArg.input;if(e&&e.store){var s=e.store.get(t);this.layer=s,this._updateBands()}},_updateBands:function(){if(this.layer){var t=[],s=[];this.layer.getKeyProperties({renderingRule:this.layer.renderingRule}).then(e.hitch(this,function(e){a.forEach(e.BandProperties,function(e,n){t.push({label:String(n+1)}),e.BandName&&s.push({label:e.BandName})}),this.bandNameSelect.set("store",new o(new i({data:s,idProperty:"label"}))),this.bandIdSelect.set("store",new o(new i({data:t,idProperty:"label"})))}))}},_setupBandComboStore:function(){if(this.rasterFunctionEnums){var t=[];a.forEach(this.rasterFunctionEnums.bandComboMethods,function(e){t.push({key:e.key+"",label:e.label})}),this.methodSelect.set("labelAttr","label"),this.methodSelect.set("store",new o(new i({idProperty:"key",data:t}))),this.onBandComboMethodChange(this.methodSelect.value)}},onBandComboMethodChange:function(t){this.method=parseInt(t,10),this.inputArgs&&this.inputArgs.Method&&(this.inputArgs.Method.value=this.method),a.forEach(this._bandControls,function(t,e){return e===this.method?d.set(t.domNode,"display",""):void d.set(t.domNode,"display","none")},this)},onBandChange:function(t){var e=this.bandCombinationTextbox.value;e.length?this.bandCombinationTextbox.set("value",e+" "+t):this.bandCombinationTextbox.set("value",t)},onBandCombinationChange:function(){var t=this.bandCombinationTextbox.value,e=a.indexOf(t,",")>0?t.split(","):t.split(" ");a.forEach(e,function(t,s){1===this.method?e[s]=parseFloat(t):2===this.method?e[s]=parseInt(t,10)-1:e[s]=t.trim()},this),this.inputArgs&&(0===this.method&&this.inputArgs.BandNames?this.inputArgs.BandNames.value=e:1===this.method&&this.inputArgs.BandWavelengths?this.inputArgs.BandWavelengths.value=e:2===this.method&&this.inputArgs.BandIds&&(this.inputArgs.BandIds.value=e))}});return s("extend-esri")&&e.setObject("dijit.RasterFunctionEditor.RFxBandCombinationEditor",v,b),v});