// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/has","dojo/string","dojo/i18n!../../nls/jsapi","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/store/Memory","dojo/data/ObjectStore","dojo/json","../../lang","../../kernel","../../layers/RasterFunction","dojo/text!../../layers/support/rasterFunctionSchema.json","dojo/text!../../layers/support/rasterFunctionResources.json","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/form/TextBox","dijit/form/CheckBox","dijit/form/NumberTextBox","dijit/form/Select","dijit/TitlePane","dijit/Tooltip","./RFxArgSlider","./RFxBandMatrix","./RFxRasterArrayEditor","./RFxStatisticsGrid","./RFxBandIndexPicker","./RFxRasterInput","./RFxFeatureSelect","./RFxFieldSelect","./utils","../ColorRampSelector","../../renderers/colorRampUtils"],function(e,t,r,i,a,n,s,o,u,l,c,d,g,h,f,p,m,_,v,y,A,x,R,b,F,T,w,S,E,I,j,k,O,N,C,L){var D,W,U,B,P={argsTable:"esriRFxArgsEditor__table",argTableRow:"esriRFxArgsEditor__tr",argNameTableRow:"esriRFxArgsEditor__tr--arg-name",argWidgetTableRow:"esriRFxArgsEditor__tr--arg-widget",fxDesc:"esriRFxArgsEditor__label--fx-desc",warningIcon:"esriRFxArgsEditor__icon--warning"},V="RasterFunctionTemplate",H="RasterFunctionVariable",M=e([_,v],{declaredClass:"esri.dijit.RasterFunctionEditor.RFxArgsEditor",widgetsInTemplate:!0,templateString:"<div class='esriRFxArgsEditor'><div data-dojo-attach-point='_argsContainterNode'></div></div>",_inputWidgets:[],_supportedDataTypes:["raster","long","double","string","longarray","stringarray","doublearray","rasterarray","colorramp","boolean","rasterstatisticsarray","arrayofrasterstatistics","cellsize","featureclass"],constructor:function(r){e.safeMixin(this,r),this._i18n=n.widgets.rasterFunctionEditor.rfxArgsEditor,this._rfxTemplate=t.clone(this.rfxTemplate),D=d.parse(a.substitute(p,n,t.hitch(this,this._substituteString))),W=d.parse(a.substitute(m,n,t.hitch(this,this._substituteString))),U=W&&W.enums,B=W&&W.dataTypes},startup:function(e){this.inherited(arguments)},postCreate:function(e){this.inherited(arguments),this.rfxTemplate&&(this._honorIsPublic=this._getHonorIsPublic(this.rfxTemplate),this._populateUI())},destroy:function(){this._destroyInputWidgets(),this.inherited(arguments)},reset:function(){},getName:function(){return this._rfxTemplate&&this._rfxTemplate.name},getRFT:function(){return this._getRFT(this._rfxTemplate)},_getRFT:function(e){if(e){var t=e.arguments,r=this._getFunctionSchema(e);return t&&(this._isRFxArg(t)?e.arguments=this._getUpdatedRFxArg(t,"Raster",r):Object.keys(t).forEach(function(e){if("type"!==e){var i=t[e];i&&(t[e]=this._getUpdatedRFxArg(i,e,r))}},this)),this._cloneRFT(e,["input","uxBlocks"])}},_isRFxArg:function(e){var t=e.type;return[V,H].indexOf(t)>=0||this._isColorRamp(e)||this._isRecordSet(e)},_getUpdatedRFxArg:function(e,t,i){if(!e||!this._isRFxArg(e))return e;var a=this._getArgRFT(e),n=i&&i.rasterFunctionArguments,s=this._getCaseInsenstitiveArg(t,n);if(s&&(s.key=t),a)return e.type===H?(e.value=this._getRFT(a),e):this._getRFT(a);if(this._hasRFTElements(e)&&!this._isShown(e)){var o=e.value&&e.value.elements?e.value.elements:e.value;return r.forEach(o,function(e,t){a=this._getArgRFT(e),a?o[t]=this._getRFT(a):e.type===H?e.value=this._getArgumentValue(e,s):o[t]=this._getArgumentValue(e,s)},this),e}return e.type!==H&&!this._isRecordSet(e)||this._isColorRamp(e)?this._isColorRamp(e)?this._getArgumentValue(e,s):void 0:(e.value=this._getArgumentValue(e,s),e)},_substituteString:function(e,t){if(void 0===e)throw new Error(" RFxArgsEditor: "+t);return null===e?"":this._escapeValue(String(e))},_getHonorIsPublic:function(e){var i=e&&e.arguments;if(!e||!i)return!1;if(e.aliases)return!0;var a=t.hitch(this,function(e){if(!e)return!1;if(this._hasRasterElements(e)){var t=e.value&&e.value.elements?e.value.elements:e.value;return r.some(t,function(e){return this._getHonorIsPublic(this._getArgRFT(e))},this)}return this._getHonorIsPublic(this._getArgRFT(e))});return this._isRFxArg(i)?a(i):r.some(Object.keys(i),function(e){var t=i[e];if(this._isRFxArg(t))return a(t)},this)},_hasRFTElements:function(e){if(!e||!e.value)return!1;var t=e.value.elements?e.value.elements:e.value;return Array.isArray(t)?t.some(function(e){return e&&e.type===V}):void 0},_hasRasterElements:function(e){if(!e||!e.value)return!1;var t=e.value.elements?e.value.elements:e.value,r=t[0];return r&&(r.isDataset||r.type===V)},_isRecordSet:function(e){return e.type&&e.type.toLowerCase().indexOf("recordset")>=0},_isColorRamp:function(e){return!!e&&(!!(e.type&&e.type.toLowerCase().indexOf("colorramp")>=0)||(!!(e.value&&e.value.type&&e.value.type.toLowerCase().indexOf("colorramp")>=0)||void 0))},_getArgRFT:function(e){if(e)return e.type===V?e:e.value&&e.value.type===V?e.value:void 0},_cloneRFT:function(e,i){var a={};if("object"==typeof e&&null!==e&&!Array.isArray(e)){for(var n in e)e.hasOwnProperty(n)&&r.indexOf(i,n)<0&&(a[n]=this._cloneRFT(e[n],i));return a}return Array.isArray(e)?e.map(t.hitch(this,function(e){return this._cloneRFT(e,i)})):t.clone(e)},_populateUI:function(){this._destroyInputWidgets(),u.empty(this._argsContainterNode),this._buildRFxTemplateUI(this._rfxTemplate)},_buildRFxTemplateUI:function(e){var t=e.arguments;e.function&&e.name&&t&&this._buildRFxUI(e),t&&(this._isRFxArg(t)?this._buildArgRFTUI(t):Object.keys(t).forEach(function(e){if("type"!==e){var r=t[e];this._isRFxArg(r)&&this._buildArgRFTUI(r)}},this))},_buildArgRFTUI:function(e){if(e){var t=this._getArgRFT(e);if(t)this._buildRFxTemplateUI(t);else if(this._hasRasterElements(e)){var i=e&&e.value.elements?e.value.elements:e.value;r.forEach(i,function(e){(t=this._getArgRFT(e))&&this._buildRFxTemplateUI(t)},this)}}},_getFunctionSchema:function(e){if(e&&e.function&&e.function.type){var t,r,i=e.function.type;return"gpadapterfunction"===i.toLowerCase()?(t=e&&e.arguments&&e.arguments.ToolName,t=t.value&&t.value.replace("_sa",""),D[t]):"pythonadapterfunction"===i.toLowerCase()?(r=e&&e.arguments&&e.arguments.ClassName,"object"==typeof r?D[r.value]:D[r]):D[i]}},_getSchemaArgKey:function(e,t){if(e){var i,a=Object.keys(e);return void 0===t&&1===a.length?a[0]:(r.some(a,function(e){e.toLowerCase()===(t&&t.toLowerCase())&&(i=e)}),i)}},_buildRFxArgUI:function(e){e=e||{};var t,i,a=[],n=e.rfxArg,s=e.rfxArgName,o=e.functionSchemaArgs,u=e.schemaEditorOverrides,l=e.rfxArgs,c=e.container,d=e.overriddenArgNames,g=e.triggerArgs;if(n)return o&&(t=this._getSchemaArgKey(o,s),(i=o[t])&&(i.key=t)),u&&r.some(u,function(e){r.indexOf(e.argumentNames,t)>=0&&this._isOverrideWidgetShown(e.argumentNames,l)&&r.indexOf(d,t)<0&&(d=d.concat(e.argumentNames),this._buildOverrideWidgetLayout(e,l,c,o))},this),r.indexOf(d,t)<0&&n.type&&n.type!==V&&this._isShown(n,i)&&(i&&r.indexOf(this._supportedDataTypes,i.dataType)<0?a.push(n.name||i.displayName):this._buildRFxArgLayout(n,c,i,l)),i&&i.editorStateTrigger&&i.editorStateTrigger.active&&g.push({rfxArg:n,schemaArgDef:i}),{overriddenArgNames:d,unsupportedDataTypeArgs:a}},_buildRFxUI:function(e){function i(e){if(e){var t=e.overriddenArgNames,r=e.unsupportedDataTypeArgs;t&&(s=s.concat(t),m.overriddenArgNames=s),r&&(o=o.concat(r),m.unsupportedDataTypeArgs=o)}}var a,n=e.arguments,s=[],o=[],l=[],c=this._getFunctionSchema(e),d=c&&c.rasterFunctionArguments,g=c&&c.editorArgumentOverride&&c.editorArgumentOverride.active?c.editorArgumentOverride.overrides:null,h=u.create("table",{class:P.argsTable}),f=u.create("tbody",null,h),p=u.create("div",null,this._argsContainterNode,"first"),m={functionSchema:c,functionSchemaArgs:d,schemaEditorOverrides:g,rfxArgs:n,container:f,triggerArgs:l,overriddenArgNames:s};n&&(this._isRFxArg(n)?(a=this._buildRFxArgUI(t.mixin({rfxArg:n},m)),i(a)):Object.keys(n).forEach(function(e){var r=n[e];r&&this._isRFxArg(r)&&(a=this._buildRFxArgUI(t.mixin({rfxArg:r,rfxArgName:e},m)),i(a))},this),Object.keys(n).forEach(function(e){var t=n[e];t&&t.input&&t.input.declaredClass.indexOf("RFxFieldSelect")>0&&t.input.setFieldOptions()}),r.forEach(l,function(e){var t=e.rfxArg,r=t&&t.value;this._handleEditorStateTriggers(n,r,e.schemaArgDef)},this)),f.childNodes&&f.childNodes.length&&this._buildTitlePane(h,p,e.function,o)},_isOverrideWidgetShown:function(e,t){var i;return r.some(e,function(e){if(i=this._getCaseInsenstitiveArg(e,t),this._isShown(i))return!0},this)},_isShown:function(e,t){return!!e&&(!(this._honorIsPublic&&!e.isPublic)&&(!t||!t.hidden))},_buildTitlePane:function(e,r,i,a){var n=new b({title:i&&i.name,content:e},r);n.startup();var s=t.hitch(this,function(e,t){this.own(new F({connectId:[e],label:"<div class='"+P.fxDesc+"'>"+t+"</div>"})),e.onclick=function(e){e.stopPropagation()}});if(n.titleNode){if(s(u.create("a",{class:"esriFloatTrailing helpIcon",style:"float: right; margin-right: -6px;"},n.titleNode),i&&i.description),a&&a.length){s(u.create("a",{class:P.warningIcon},n.titleNode),this._i18n.unsupportedDataTypeWarning+"<br><br><strong>"+a.join(", ")+"</strong>")}}},_buildRFxArgLayout:function(e,t,r,i){var a,n,s;return n=(r&&r.dataType)===B.boolean,s=this._useRFxArgWidget(r),(s||n)&&(a=u.create("tr",{class:P.argTableRow},t),e.uxBlocks=[a]),s?this._buildRFxWidgetLayout(a,e,r,i):n?this._buildBooleanLayout(a,e,r,i):this._buildStdTwoRowLayout(t,e,r,i)},_useRFxArgWidget:function(e){return e&&e.domain&&"range"===e.domain.type},_createInputWidget:function(e,t,r,i){var a=this._getWidget(e,t,r,i);a.startup(),e.input=a,this._inputWidgets.push(a)},_createOverrideWidget:function(e,i,a){var n=new e(i,a),s=i&&i.inputArgs;n.startup(),this._inputWidgets.push(n),n.on("drawtool-activate",t.hitch(this,function(e){this.emit("drawtool-activate",e)})),n.on("drawtool-deactivate",t.hitch(this,function(e){this.emit("drawtool-deactivate",e)})),n.on("add-layer",t.hitch(this,function(e){this.emit("add-ready-to-use-layer",e)})),n.domNode&&s&&r.forEach(Object.keys(s),function(e){var t=s[e];t&&(t.uxBlocks=[n.domNode])})},_buildOverrideWidgetLayout:function(e,i,a,n){if(e){var s,o,l={},c={};r.forEach(e.argumentNames,function(e){s=this._getCaseInsenstitiveArg(e,i);var t=n[e];t&&(t.key=e),s&&(s.displayName=this._getArgDisplayName(s.name,t),c[e]=s)},this),r.forEach(Object.keys(n),function(e){o=n[e],o.dataType===B.raster&&(s=this._getCaseInsenstitiveArg(e,i))&&(l[e]=s)},this);try{require([e.widget.path],t.hitch(this,function(e){var r,i,n=u.create("tr",{class:P.argTableRow},a);r=u.create("td",null,n),i=u.create("div",null,r),this._createOverrideWidget(e,{rasterFunctionEnums:U,rasterFunctions:D,rasterArgs:l,inputArgs:c,inputLayers:this.inputLayers,browseProperties:{map:this.map,portalUrl:this.portalUrl,portalSelf:this.portalSelf},allowScalar:!1,isShownFx:t.hitch(this,this._isShown)},i)}))}catch(e){console.error(e),r.forEach(Object.keys(c),function(e){s=c[e],o=this._getCaseInsenstitiveArg(e,n),this._buildRFxArgLayout(s,a,o,i)},this)}}},_buildBooleanLayout:function(e,t,r,i){var a,n;a=u.create("td",{innerHTML:this._getArgDisplayName(t.name,r)},e),n=u.create("div",null,a,"first"),this._createInputWidget(t,n,r,i)},_buildStdTwoRowLayout:function(e,t,r,i){var a,n,s,o;a=u.create("tr",{class:P.argNameTableRow},e),u.create("td",{innerHTML:this._getArgDisplayName(t.name,r)},a),n=u.create("tr",{class:P.argWidgetTableRow},e),o=u.create("td",null,n),s=u.create("div",null,o),t.uxBlocks=[a,n],this._createInputWidget(t,s,r,i)},_getArgDisplayName:function(e,t){var r=t&&t.key;return!t||e!==r&&void 0!==e&&""!==e?e:t.displayName},_buildRFxWidgetLayout:function(e,t,r,i){var a,n;a=u.create("td",null,e),n=u.create("div",null,a),this._createInputWidget(t,n,r,i)},_getDatasetOptions:function(){if(this.inputLayers)return this._inputLayerStore=new c(new l({data:this.inputLayers})),this._inputLayerStore},_destroyInputWidgets:function(){var e=this._inputWidgets;r.forEach(e,function(e){if(e&&e.destroy)try{e.destroy()}catch(e){console.log(e)}}),this._inputWidgets=[]},_getWidget:function(e,r,i,a){if(e){var n,s=i&&i.dataType,o=e.value,u=i&&i.domain,l=i&&i.dataTypeAttributes,c=this._getArgRFT(e);if(c){var d=c.function&&c.function.name;n=new y({value:"<"+d+"."+this._i18n.outputRaster+">",disabled:!0},r)}return e.isDataset&&!n&&(n=new j({inputLayers:this.inputLayers,value:o,allowScalar:!i||i.allowScalar,browseProperties:{map:this.map,portalUrl:this.portalUrl,portalSelf:this.portalSelf}},r)),n||(n=u?this._getDomainBasedWidget(u,e,a,r):this._getDataTypeBasedWidget(s,l,e,a,r,i)),n&&(n.on("change",t.partial(t.hitch(this,this._onArgumentValueChange),e,i,a)),n.on("add-layer",t.hitch(this,function(e){this.emit("add-ready-to-use-layer",e)}))),n}},_getDataTypeBasedWidget:function(e,r,i,a,n,s){var o,u=i.value;if(r&&"bandmatrix"===r.type)return this._getDataTypeAttributeBasedWidget(e,r,i,a,n);switch(e){case B.raster:i.isDataset||(o=new x({value:u&&u.length?u[0]:void 0},n));break;case B.rasterArray:o=new S({inputLayers:this.inputLayers,value:u,getRFT:t.hitch(this,this._getRFT),allowScalar:s.allowScalar,browseProperties:{map:this.map,portalUrl:this.portalUrl,portalSelf:this.portalSelf}},n);break;case B.string:o=new y({value:u},n);break;case B.double:o=new x({value:u},n);break;case B.long:o=new x({constraints:{places:0},value:u},n);break;case B.colorRamp:var l=N.getColorRampFromArg(i);o=new C({style:"text-indent: 0; height: 2.2em;",maxHeight:200,includeDefault:!1,colorRamp:l},n);break;case B.boolean:o=new A({checked:u},n);break;case B.stringArray:case B.doubleArray:case B.longArray:u&&u.length&&(u=u.join(",")),o=new y({value:u},n);break;case B.rasterStatisticsArray:case B.arrayOfRasterStatistics:o=new E({value:u},n);break;case B.cellSize:case void 0:o=new y({},n);try{"string"==typeof u?o.set("value",u):o.set("value",d.stringify(u))}catch(e){o.set("value",u)}break;case B.featureClass:o=new k({inputLayers:this.featureLayers,geometryType:r?r.type:null,browseProperties:{map:this.map,portalUrl:this.portalUrl,portalSelf:this.portalSelf}},n);break;default:o=new y({value:String(u)},n)}return o},_getDomainBasedWidget:function(e,t,r,i){if(e&&t){var a,n=e&&e.type,s=t.value;if("numlist"===n){var o=new c(new l({idProperty:"key",data:this._getNumListData(e)}));a=new R({store:o,labelAttr:"key"},i),g.isDefined(s)&&a.set("value",s.toString())}else if("list"===n){var u=this._getEnumData(U[e.enum]),d=new c(new l({idProperty:"key",data:u}));a=new R({store:d,labelAttr:"label",maxHeight:200},i),g.isDefined(s)&&a.set("value",s.toString())}else if("range"===n)a=new T({min:e.min,max:e.max,label:t.name,value:s},i);else if("bandIndex"===n){var h=this._getCaseInsenstitiveArg(e.argumentName,r);a=new I({nBandsArg:h,value:s},i)}else if("fields"===n){var f=this._getCaseInsenstitiveArg(e.argumentName,r);a=new O({layerArg:f},i)}return a}},_getDataTypeAttributeBasedWidget:function(e,t,r,i,a){var n=this._getCaseInsenstitiveArg(t.nBands,i);return new w({nBandsArg:n,nCols:t.cols,displayNames:t.displayNames,value:r.value},a)},_getNumListData:function(e){if(e){for(var t=[],r=e.start,i=0;i<e.count;r+=e.inc,i++)t.push({key:r.toString()});return t}},_getEnumData:function(e){return r.forEach(e,function(e){e.key=e.key.toString()}),e},_onArgumentValueChange:function(e,t,r,i){(e&&e.input)instanceof R&&t&&t.dataType===B.long&&(i=parseInt(i,10)),Object.keys(r).forEach(function(t){var i=r[t]&&r[t].input;i&&i.declaredClass.indexOf("RFxFieldSelect")>0&&i.layerArg&&i.layerArg.name===e.name&&i.setFieldOptions()}),this._handleEditorStateTriggers(r,i,t)},_handleEditorStateTriggers:function(e,t,i){i&&i.editorStateTrigger&&i.editorStateTrigger.active&&e&&r.forEach(i.editorStateTrigger.triggers,function(i){var a,n,o,u,l,c,d=i.autoRevert;for(var g in e)e.hasOwnProperty(g)&&(a=e[g],(l=a.uxBlocks)&&(n=r.indexOf(i.values,t)>=0,o=this._containsArgName(i.active,g),u=this._containsArgName(i.inactive,g),(o&&n||u&&!n&&d)&&(c=l&&l[0]&&"TR"===l[0].tagName?"table-row":"block"),(u&&n||o&&!n&&d)&&(c="none"),r.forEach(l,function(e){e&&c&&s.set(e,"display",c)}),c=null))},this)},_containsArgName:function(e,t){if(!e||!t)return!1;var i=t.toLowerCase();return r.some(e,function(e){return e.toLowerCase()===i})},_getArgumentValue:function(e,t){function i(e){return r.some(e,function(e){if(u instanceof e)return!0})}if(e){var a,n,s,o,u=e.input,l=t&&t.dataType;if(!u)return e.value;var c=[x,R,y],g=[A],h=[T,w,S,E,j,k];if(i([C]))return N.getRFxArgColorRampValue(u.colorRamp);if(i(h))return u.get("value");if(i(c))switch(n=u.value,l&&l.indexOf("array")>=0&&n&&"string"==typeof n&&(a=n.indexOf(",")>=0?n.split(","):n.split(" ")),l){case B.raster:if(!e.isDataset)return{value:n,type:"Scalar"};break;case B.longArray:return r.forEach(a,function(e,t){a[t]=parseInt(e,10)}),a;case B.doubleArray:return r.forEach(a,function(e,t){a[t]=parseFloat(e)}),a;case B.stringArray:case B.rasterArray:return r.forEach(a,function(e,t){a[t]=e.trim()}),a;case B.long:return parseInt(n,10);case B.cellSize:try{return d.parse(n)}catch(e){return n}return n;case void 0:return n=n&&n.trim(),s=/^[+-]?(\d+)?(\.\d+)?$/.test(n),o=r.indexOf(["true","false"],n)>=0,s?parseFloat(n):o?"true"===n:n;default:return n}else if(i(g))return u.checked}},_getCaseInsenstitiveArg:function(e,t){if(e&&t)return r.some(Object.keys(t),function(t){if(t.toLowerCase()===e.toLowerCase())return e=t,!0}),t[e]},_selectInputDataset:function(e,t){if(e&&e.options.length&&t){var i=t,a=null;"object"==typeof t&&(i=t.url,a=t.name);var n=g.isDefined(a);r.forEach(e.options,function(e){e.selected=e.item.url===i&&(!n||n&&a===e.item.name)},this)}}});return i("extend-esri")&&t.setObject("dijit.RasterFunctionEditor.RFxArgsEditor",M,h),M});