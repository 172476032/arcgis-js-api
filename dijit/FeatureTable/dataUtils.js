// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define(["dojo/_base/array","dojo/_base/lang","dojo/Deferred","dojo/string","dojo/date/locale","dojo/promise/all","../../config","../../numberUtils","../../request","../../layers/FeatureLayer","../../geometry/Extent","../../tasks/query","../../tasks/StatisticDefinition","../../tasks/QueryTask","../../tasks/RelationshipQuery","dojo/i18n!../../nls/jsapi"],function(e,t,r,n,i,a,u,l,o,s,d,y,c,f,m,h){var p={i18nStrings:h.widgets.FeatureTable,numericFieldTypes:["esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeSmallInteger"],statisticDefinitions:[{type:"count",name:"countField"},{type:"sum",name:"sumField"},{type:"min",name:"minField"},{type:"max",name:"maxField"},{type:"avg",name:"avgField"},{type:"stddev",name:"stddevField"}],getOrderByString:function(e,t){var r=t?" DESC":" ASC";return e+r},getWhereString:function(e,t){return e+"='"+t+"'"},getRelationshipWhereClause:function(r){var n,i,a,u,l,s,d,y=r.layer,c=r.originRelationship,f=r.destinationRelationship,m=r.keyValue,h=y._url.path,p=h.substring(0,h.lastIndexOf("/")+1),F=[],g="";return a=c.relationshipTableId||c.relatedTableId,u=c.keyFieldInRelationshipTable||c.keyField,l=f.keyFieldInRelationshipTable||f.keyField,p=p+a+"/query",i=y.layerId===a?l:u,n=this.getWhereString(i,m),o({url:p,content:{f:"json",outFields:[u,l],returnGeometry:!1,where:n},handleAs:"json",callbackParamName:"callback"}).then(t.hitch(this,function(t){return t&&t.features?(d=t.features,d.length>0?(e.forEach(d,function(t,r){s=t.attributes[l],-1===e.indexOf(F,s)&&(F.length>0&&r<d.length&&(g=g.concat(" OR ")),F.push(s),g=g.concat(this.getWhereString(f.keyField,s)))},this),g):null):null}))},isValueEmpty:function(e){return null===e||" "===e||""===e||"undefined"==typeof e},findFirst:function(t,r,n){var i=e.filter(t,function(e){return e.hasOwnProperty(r)&&e[r]===n});return i[0]||null},findFirstNumberColumn:function(t,r){var n;return e.some(t,function(t,i){return-1===e.indexOf(this.numericFieldTypes,t.type)||t.field===r||t.hidden?void 0:(n=t,!0)},this),n},getRoundingPrecision:function(e){return e>=1e3?0:e>=10?2:e>=0?4:6},generateLinkFromString:function(e){var t,r,n;return"string"==typeof e&&(t=e.indexOf("http:"),-1===t&&(t=e.indexOf("https:")),t>-1&&-1===e.indexOf("href=")&&(r=e.indexOf(" ",t),-1===r&&(r=e.length),n=e.substring(t,r),e=e.substring(0,t)+"<a href='"+n+"' target='_blank'>"+n+"</a>"+e.substring(r,e.length))),e||""},isNumericFieldType:function(t){return-1!==e.indexOf(this.numericFieldTypes,t)},isIntegerFieldType:function(e){return"esriFieldTypeInteger"===e||"esriFieldTypeSmallInteger"===e},isFloatFieldType:function(e){return"esriFieldTypeDouble"===e||"esriFieldTypeSingle"===e},getDomainValueFromRow:function(e){var t,r=e.fieldInfo.name,n=e.fieldInfo.domain,i=e.row;return"range"===n.type?i[r]:(t=p.findFirst(n.codedValues,"code",i[r]),t?t.name:"")},getTypeValueFromRow:function(e){var t,r,n,i,a,u=e.layerInfo,l=u.types,o=e.fieldInfo,s=e.row,d=l&&l[0];return d&&(r=s[o.name],n=p.isNumericFieldType(o.type),i="string"==typeof d.id,a=i&&n?r.toString():r,t=p.findFirst(l,"id",a),t=t?t.name:null),t},getSubtypeDomainValue:function(e){var t,r,n,i=e.layerInfo,a=e.fieldInfo.name,u=i.types,l=e.row;return n=p.findFirst(u,"id",l[i.typeIdField]),t=n?n.domains:null,n&&t?(t[a]&&t[a].codedValues&&(r=this.findFirst(t[a].codedValues,"code",l[a])),r?r.name:l[a]):l[a]},mergeDictionaries:function(e,t){if(null===e||null===t)return e;for(var r in t){e[r]||(e[r]={});for(var n in t[r])e[r][n]=t[r][n]}return e},isCyclicalRelationship:function(e){return"esriRelCardinalityOneToOne"===e.cardinality||"esriRelCardinalityOneToMany"===e.cardinality&&"esriRelRoleDestination"===e.role},formatNumberForLocale:function(e,t){return isNaN(e)||null===e?null:l.format(e,t)},getCombinedDateTime:function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes(),t.getSeconds())},formatDateForLocale:function(e){var t,r,n,a=e.dateOptions||{},u=e.timestamp,l=e.fieldInfo,o=!1,s=!1,d={};return t=l&&l.dateOptions?l.dateOptions:!1,r=t||a,o=t&&this.isValueEmpty(r.dateEnabled)?!0:!!r.dateEnabled,s=!!r.timeEnabled,this.isValueEmpty(r.datePattern)||(d.datePattern=r.datePattern),this.isValueEmpty(r.timeEnabled)||this.isValueEmpty(r.timePattern)||(d.timePattern=r.timePattern),n=o&&s?"date and time":o&&!s?"date":!o&&s?"time":"date",d.selector=n,i.format(new Date(u),d)},calculateExtentFromFeatures:function(e){var t,r,n,i,a,u=e[0].geometry;if(null===u&&1===e.length)return null;for(i=e.length-1;i>=0;i--)null===e[i].geometry&&e.splice(i,1);for(u=e[0].geometry,t=u.getExtent(),n=e.length,null===t&&(t=new d(u.x,u.y,u.x,u.y,u.spatialReference)),a=1;n>a;a++)u=e[a].geometry,r=u.getExtent(),null===r&&(r=new d(u.x,u.y,u.x,u.y,u.spatialReference)),t=t.union(r);return t},initFeatureLayer:function(e,t){var r=e._url.path;return r=r.substring(0,r.lastIndexOf("/")+1),r+=t,new s(r,{mode:s.MODE_ONDEMAND,outFields:["*"],visible:!0})},applyEdits:function(t){var n=[],i=new r;return!t||t.length<=0?(i.reject(),i):(e.forEach(t,function(e){e.layer&&n.push(e.layer.applyEdits(e.adds,e.updates,e.deletes))}),n.length>0?a(n).then(i.resolve,i.reject):i.reject(),i)},applyEditsFromRow:function(e){var r=e.layer,n=e.idProperty,i=e.row;return this.queryLayerForFeature({layer:r,id:i[n]}).then(t.hitch(this,function(e){var t=e.features[0];return t.attributes=i,this.applyEdits([{layer:r,updates:[t]}],null)}))},queryLayer:function(e){var t=e.layer,r=e.ids||null,n=new y;return n.where="1=1",n.returnGeometry=!1,n.objectIds=r,t.queryFeatures(n)},queryLayerForFeature:function(e){return this.queryLayerForFeatures({layer:e.layer,ids:[e.id]})},queryLayerForFeatures:function(e){var t=e.layer,r=e.ids,n=new y;return n.objectIds=r,n.outFields=["*"],t.queryFeatures(n,function(e){return e.features})},queryLayerForCount:function(e){var t=e.layer,r=e.layerInfo,n=new y,i=e.where||"1=1",a=6e4,l=1e4;return n.returnGeometry=!1,n.returnCountOnly=!0,n.where=i,u.defaults.io.timeout=l,t.queryCount(n).then(function(e){return e}).otherwise(function(){return r.isFeatureCollection?t.graphics.length:2e3}).always(function(e){return u.defaults.io.timeout=a,e})},queryLayerForIds:function(e){var t=e.layer,r=e.idProperty,n=new y;return n.returnGeometry=!1,n.outFields=[r],n.where="1=1",n.returnIdsOnly=!0,t.queryIds(n)},queryLayerForAttachments:function(e){var t=e.layer,r=e.ids,n=t._url.path+"/queryAttachments";return o({url:n,content:{f:"json",objectIds:r},handleAs:"json",callbackParamName:"callback"})},queryLayerForAttachmentById:function(e){var t=e.layer,r=e.id||0;return t.queryAttachmentInfos(r)},addAttachmentToLayer:function(e){var t=e.layer,r=e.featureId,n=e.formData;return t.addAttachment(r,n)},deleteAttachmentFromLayer:function(e){var t=e.layer,r=e.attachmentId,n=e.featureId;return t.deleteAttachments(n,[r])},queryLayerForRelatedRecords:function(e){var t=e.layer,r=e.ids,n=e.outFields||["*"],i=e.relationship,a=e.returnCountOnly||!1,u=new m;return u.outFields=n,u.returnGeometry=!1,u.relationshipId=i.id,u.returnCountOnly=a,u.objectIds=r,t.queryRelatedFeatures(u)},queryLayerForRelatedRecordCount:function(e){var t=e.layer,r=e.objectIds,n=e.relationship,i=e.outFields,a=t._url.path+"/queryRelatedRecords";return o({url:a,content:{f:"json",objectIds:r.toString(),outFields:i,returnGeometry:!1,relationshipId:n.id,returnCountOnly:!0},handleAs:"json",callbackParamName:"callback"})},getFieldStatistics:function(t){var n,i,a,u=new r,l=t.grid,o=t.layer,s=t.idProperty,d=t.where||"1=1",m=t.filterIds,h=t.columnId,p=l.columns[h].field,F=[];return n=new y,n.outFields=[p],n.outStatistics=[],n.where=d,a=e.map(this.statisticDefinitions,function(e){var t=new c;return t.onStatisticField=p,t.displayFieldName=p,t.outStatisticFieldName=e.name,t.statisticType=e.type,t}),n.outStatistics=a,m&&m.length>0&&(F=m),n.where&&F.length>0&&(n.where="("+n.where+") AND ("+s+" IN ("+F.toString()+"))"),i=new f(o.url),i.execute(n).then(function(e){u.resolve(e)}).otherwise(function(){u.reject()}),u},selectFeaturesById:function(e){var t=e.grid,r=t.layer,n=t.layerInfo,i=e.map,a=e.ids,u=e.id,l=new y;return l.returnGeometry=!!i,l.objectIds=a||[u],n.isFeatureCollection||(l.where="1=1"),r.selectFeatures(l,s.SELECTION_NEW)}};return p});