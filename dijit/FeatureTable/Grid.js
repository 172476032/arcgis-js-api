// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["../../kernel","./dataUtils","./dialogUtils","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/aspect","dojo/has","dojo/keys","dojo/on","dojo/string","dojo/dom-class","dojo/dom-construct","dojo/Deferred","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_WidgetBase","dijit/a11yclick","dijit/focus","dijit/Menu","dijit/MenuItem","dijit/Tooltip","dijit/form/Button","dijit/form/DateTextBox","dijit/form/DropDownButton","dijit/form/NumberTextBox","dijit/form/Select","dijit/form/TimeTextBox","dijit/form/ValidationTextBox","dijit/layout/BorderContainer","dijit/layout/ContentPane","dgrid/OnDemandGrid","dgrid/Selection","dgrid/selector","dgrid/Keyboard","dgrid/editor","dgrid/extensions/Pagination","dgrid/extensions/DijitRegistry","dgrid/extensions/ColumnHider","dgrid/extensions/ColumnResizer","dojo/i18n!../../nls/jsapi","dojo/text!./templates/Grid.html"],function(e,t,i,n,s,l,o,r,a,d,h,c,u,f,m,p,g,y,_,I,C,w,b,v,R,T,S,F,H,L,N,M,E,D,O,V,k,G,x,U,A,P){var B=n([g,m,p],{declaredClass:"esri.dijit.FeatureTable.Grid",baseClass:"esri-feature-table-grid",templateString:P,map:null,layer:null,layerInfo:null,idProperty:"id",sort:null,defaultSort:null,filterIds:null,where:null,batchCount:50,editable:!1,editOn:"dblclick, keypress",css:null,showAttachments:!1,showRelatedRecords:!1,showCyclicalRelationships:!1,showStatistics:!1,showFieldDetails:!1,showGridHeader:!0,showGridMenu:!0,showFilterMenuItems:!0,showDefaultSortMenuItem:!0,showFeatureCount:!0,showDataTypes:!1,showColumnHeaderTooltips:!1,showColumnHider:!1,syncSelection:!1,menuFunctions:null,columnMenuFunctions:null,gridOptions:null,dateOptions:null,visibleLayerIds:null,loaded:!1,store:null,columns:null,fieldInfos:null,customFieldInfos:null,noDataMessage:"",featureCount:0,selectedFeatureCount:0,selectedRows:null,selectedRowIds:null,optionsMenu:null,optionsMenuAnchor:null,columnMenu:null,rollbackInfos:null,attachmentInfos:null,relatedRecordInfos:null,relatedRecordCounts:null,_i18nStrings:A.widgets.FeatureTable,_numericFieldTypes:["esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeSmallInteger"],_unsupportedFieldTypes:["esriFieldTypeGUID","esriFieldTypeRaster","esriFieldTypeBlob","esriFieldTypeGeometry","esriFieldTypeXML"],_activeEditors:null,_relationshipColumnLimit:5,_nullConstant:"ft_null",_watchers:null,_columnHiderButton:null,_tableTitle:null,_previousSelectedRowIds:null,postMixInProperties:function(){this.inherited(arguments),this.set({sort:{},columns:[],fieldInfos:[],selectedRows:[],selectedRowIds:[],rollbackInfos:{},attachmentInfos:{},relatedRecordInfos:{},relatedRecordCounts:{},_watchers:[],_previousSelectedRowIds:[]})},startup:function(){this.inherited(arguments),this.dGrid=this._createGrid(),this._cleanUpGrid(),this.dGrid.startup(),this.dGrid.resize(),this.showLoadingIndicator(),this.updateHeaderText(),this.showGridHeader||this.hideHeader(),this._generateOptionsMenu(),this.showGridMenu||this.hideOptionsMenu(),this._generateColumnHiderButton(),this.showColumnHider||this.hideColumnHiderButton(),this._addGridListeners()},destroy:function(){this.inherited(arguments),this.optionsMenu&&this.optionsMenu.destroy(),this.columnMenu&&this.columnMenu.destroyRecursive(),l.forEach(this._watchers,function(e){e.remove()})},resize:function(){this._gridBorderContainerNode&&this._gridBorderContainerNode.resize(),this._gridHeaderNode&&this._gridHeaderNode.resize(),this._gridContentPaneNode&&this._gridContentPaneNode.resize(),this.dGrid&&this.dGrid.resize()},setHeaderTitle:function(e){this._gridTitleNode&&(this._gridTitleNode.innerHTML=e)},showHeader:function(){c.remove(this._gridHeaderNode.domNode,this.css.hidden),this.resize()},hideHeader:function(){c.add(this._gridHeaderNode.domNode,this.css.hidden),this.resize()},showLoadingIndicator:function(){this._gridLoadingIndicatorNode&&c.remove(this._gridLoadingIndicatorNode,this.css.hidden)},hideLoadingIndicator:function(){this._gridLoadingIndicatorNode&&c.add(this._gridLoadingIndicatorNode,this.css.hidden)},showOptionsMenu:function(){this._menuNode&&c.remove(this._menuNode,this.css.hidden)},hideOptionsMenu:function(){this._menuNode&&c.add(this._menuNode,this.css.hidden)},updateNoDataMessage:function(e){this.dGrid.set("noDataMessage",e)},showColumnHiderMenu:function(){this.gridOptions.columnHider&&this.dGrid._toggleColumnHiderMenu()},showColumnHiderButton:function(){this._columnHiderButton&&c.remove(this._columnHiderButton,this.css.hidden)},hideColumnHiderButton:function(){this._columnHiderButton&&c.add(this._columnHiderButton,this.css.hidden)},refresh:function(){this.dGrid&&this.dGrid.refresh(),0===this.featureCount&&this.hideLoadingIndicator(),this._updateSelection().then(s.hitch(this,this.updateHeaderText))},getRowById:function(e){return this.dGrid.row(e)||{}},getRowDataById:function(e){var t=this.getRowById(e);return t&&t.data?t.data:{}},emptyStore:function(){this.updateNoDataMessage(""),this.updateStore(null)},updateStore:function(e){this.set("store",e),this.dGrid.set("store",e)},updateSort:function(e){this.set("sort",e[0]),this.dGrid.set("sort",e)},updateSelectionMode:function(e){this.dGrid.set("selectionMode",e)},getColumns:function(){return this.dGrid.columns},styleColumn:function(e,t){return this.dGrid.styleColumn(e,t)},clearSelection:function(){this.dGrid.clearSelection(),this._updateSelection().then(s.hitch(this,this.updateHeaderText)),this.emit("clear-selection")},centerOnSelection:function(){var e=this.map,i=this.layer,n=this.selectedRowIds;if(e&&n&&0!==n.length)return t.queryLayerForFeatures({layer:i,ids:n}).then(s.hitch(function(i){var n=i.features;n&&n.length>0&&e.setExtent(t.calculateExtentFromFeatures(n))}))},selectRows:function(e,t,i){var n,o=this.dGrid,r=[];this._closeCellEditors(),this.clearSelection(),e instanceof Array?(l.forEach(e,function(e){o._select(e),r.push(this.getRowById(e))},this),n=e[0]):(o._select(e),n=e,r=[this.getRowById(e)]),this._updateSelection().then(s.hitch(this,function(){this.updateHeaderText(),i||this.emit("row-select",{rows:r,grid:this.dGrid}),t&&this._scrollToRow(n)}))},_createGrid:function(){var e=this._generateGridClass();return new e({columns:this.columns,sort:[this.defaultSort],noDataMessage:this.noDataMessage,selectionMode:this.gridOptions.selectionMode,allowSelectAll:this.gridOptions.allowSelectAll,allowTextSelection:this.gridOptions.allowTextSelection,cellNavigation:this.gridOptions.cellNavigation,keepScrollPosition:this.gridOptions.keepScrollPosition,pageSizeOptions:this.gridOptions.pageSizeOptions,queryRowsOverlap:this.gridOptions.queryRowsOverlap,minRowsPerPage:this.batchCount,maxRowsPerPage:this.batchCount,pagingDelay:this.pagingDelay,query:s.hitch(this,this._getQueryForGrid)},this._gridNode)},_generateGridClass:function(){var e=[G,M,E,V,D,O];return this.gridOptions.pagination&&e.push(k),this.gridOptions.columnHider&&e.push(x),this.gridOptions.columnResizer&&e.push(U),n(e)},_getQueryForGrid:function(e){return!this.filterIds||-1!==l.indexOf(this.filterIds,e[this.idProperty])},_cleanUpGrid:function(){var e=this.dGrid,t=o.before(e,"removeRow",s.hitch(this,function(t){l.forEach(this.columns.length,function(i,n){var s=e.cell(t,n).element,l=s.contents||s,o=l.widget;o&&o.destroyRecursive()})})),i=o.after(e,"renderHeader",function(){e._sortListener.remove()});this._watchers.push(t,i)},_setUpColumns:function(e){var t=this._generateFieldInfos(e),i=this._generateColumns(t);return this.set({columns:i,fieldInfos:t}),this.dGrid.set("columns",i),{fieldInfos:t,columns:i}},_generateFieldInfos:function(e){if(e&&0!==e.length&&this.layerInfo){var i,n,s,o,r,a,d,h,c,u,f,m,p,g,y=this._orderFieldsForDisplay(e),_=this.layer,I=this.layerInfo,C=this.idProperty,w=[],b=this.customFieldInfos,v=this.outFields,R=this.hiddenFields;l.forEach(y,function(e){s=e.length||null,p=t.findFirst(_.fields,"name",e.name)||{},g=t.findFirst(b,"name",e.name)||t.findFirst(b,"fieldName",e.name),i=g&&(g.label||g.alias)||p.alias,r=_.getDomain&&_.getDomain(e.name)?_.getDomain(e.name):!1,o=!(!I.typeIdField||e.name!==I.typeIdField),a=I.types&&l.some(I.types,function(t){return t.domains&&t.domains[e.name]&&t.domains[e.name].name?!0:void 0}),d=!this._getFieldVisibility({field:e,hiddenFields:R,customFieldInfo:g,outFields:v}),f=I.editable&&I.editCapabilities.canUpdate,m=g&&("undefined"!=typeof g.editable&&p.editable!==!1||"undefined"!=typeof g.isEditable&&p.isEditable!==!1),h=f&&e.name!==C&&p&&"undefined"!==p.editable?m?!!g.editable||!!g.isEditable:!!p.editable:!1,n=g&&g.format?g.format:null,c=!!p.nullable,u=g&&(g.dateOptions||g.format&&g.format.dateFormat)||null,w.push({name:e.name,alias:i,length:s,type:e.type,hidden:d,editable:h,nullable:c,domain:r,typeId:o,subtypeDomain:a,format:n,dateOptions:u})},this);var T=l.every(w,function(e){return e.hidden});if(T){var S=t.findFirst(w,"name",this.idProperty);S.hidden=!1}return this.showRelatedRecords&&this._generateRelatedRecordFieldInfos({fieldInfos:w,relationships:_.relationships}),this.showAttachments&&w.push({alias:this._i18nStrings.photosAndFiles,name:"esriAttachments",type:"esriAttachments",editable:I.editable}),w}},_destroyColumns:function(){this.dGrid&&this.dGrid._destroyColumns()},_getFieldVisibility:function(e){var t,i,n,s,o,r,a=e.field,d=e.hiddenFields,h=e.outFields,c=e.customFieldInfo;return i=-1!==l.indexOf(d,a.name),o=!(!c||c.visible!==!1),r="*"!==h[0]&&-1===l.indexOf(h,a.name),n="esriFieldTypeOID"===a.type||"esriFieldTypeGlobalID"===a.type,s=n&&(o||r),t=i||s||o||r,!t},_applyEdits:function(e){var i=e.row,n=e.rollbackInfo;return this.showLoadingIndicator(),n&&this._updateRollbackInfos(n),t.applyEditsFromRow({layer:this.layer,idProperty:this.idProperty,row:i}).then(function(){}).otherwise(s.hitch(this,function(){n&&(i=this.getRowDataById(n.rowId),i[n.fieldName]=n.oldValue,this.dGrid.updateDirty(n.rowId,n.fieldName,n.oldValue),this.refresh()),this.hideLoadingIndicator(),this.emit("error",{message:this._i18nStrings.errorUpdateFailed})}))},_updateRollbackInfos:function(e){if(e){var t=e.rowId;this.rollbackInfos[t]||(this.rollbackInfos[t]=[]),this.rollbackInfos[t].push(e)}},_updateSelection:function(){var e,t,i,n,s,l=this.dGrid.selection,o=new f,r=[],a=[];for(i in l)l.hasOwnProperty(i)&&(n=parseInt(i,10),a.push(n),e=this.dGrid.row(n),t=e.data,t&&r.push(t));return s={selectedRows:r,selectedRowIds:a,selectedFeatureCount:a.length},this.set(s),o.resolve(s),o},_scrollToRow:function(e){var t,i,n,s=this.store,o=this.dGrid,r=o.row(e),a=this.sort;if(r&&s){if(r.element)return void r.element.scrollIntoView();t=s.data[e]||r.data,t&&(i=a&&a.attribute===this.idProperty&&a.descending?s.data.length-l.indexOf(s.data,t):l.indexOf(s.data,t),n=o.rowHeight*i-o.rowHeight,o.scrollTo({x:0,y:n}),r.element?r.element.scrollIntoView():setTimeout(function(){r.element&&r.element.scrollIntoView()},200))}},_generateColumns:function(e){var t=s.clone(e)||[],i=[];return l.forEach(t,function(e){"esriAttachments"===e.type?i.push(this._generateAttachmentsColumn(e)):"esriRelatedRecords"===e.type?i.push(this._generateRelatedRecordsColumn(e)):"esriFieldTypeDate"===e.type?this.dateOptions.timeEnabled?i.push(this._generateDateTimeColumn(e)):i.push(this._generateDateColumn(e)):e.typeId?i.push(this._generateTypeColumn(e)):e.domain?i.push(this._generateDomainColumn(e)):e.subtypeDomain&&!e.typeId?i.push(this._generateSubtypeDomainColumn(e)):l.indexOf(this._numericFieldTypes,e.type)>-1?i.push(this._generateNumberColumn(e)):-1===l.indexOf(this._unsupportedFieldTypes,e.type)&&i.push(this._generateStringColumn(e))},this),i},_orderFieldsForDisplay:function(e){var i=this.outFields,n=this.idProperty,o=[];return i&&"*"===i[0]?o=s.clone(e):(t.isValueEmpty(n)||-1!==l.indexOf(i,n)||o.push(t.findFirst(e,"name",n)),l.forEach(i,function(i){var s=t.findFirst(e,"name",i)||null;s&&i.name!==n&&-1===l.indexOf(o,s)&&o.push(s)}),l.forEach(e,function(e){-1===l.indexOf(o,e)&&o.push(s.clone(e))})),o},_generateDateColumn:function(e){var i=e.dateOptions&&e.dateOptions.datePattern?e.dateOptions.datePattern:this.dateOptions.datePattern,n=e.dateOptions||this.dateOptions;return new V({label:e.alias,field:e.name,type:e.type,editorArgs:{required:!e.nullable,constraints:{datePattern:i}},editOn:this.editOn,hidden:e.hidden,formatter:function(i){return t.isValueEmpty(i)?null:t.formatDateForLocale({dateOptions:n,timestamp:i,fieldInfo:e})},get:function(i){return t.isValueEmpty(i[e.name])?null:new Date(i[e.name])},renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})})},v)},_generateDateTimeColumn:function(e){var i=e.dateOptions||this.dateOptions;return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:s.hitch(this,function(n){return t.isValueEmpty(n[e.name])?null:t.formatDateForLocale({dateOptions:i,timestamp:new Date(n[e.name]),fieldInfo:e})}),renderCell:s.hitch(this,function(i,n,s){var l=u.create("div",{innerHTML:t.isValueEmpty(n)?"":n},s);this._setUpDateTimeCell({row:i,cellNode:s,fieldInfo:e,container:l})}),renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})})}},_generateDomainColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:function(i){return t.getDomainValueFromRow({fieldInfo:e,row:i})},renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})}),renderCell:s.hitch(this,function(t,i,n){var s=u.create("div");if(e.domain.codedValues)i=this._formatStringCellContent({fieldInfo:e,value:i}),this._setUpCodedValueDomainCell({row:t,cellNode:n,fieldInfo:e,container:s});else{if("range"!==e.domain.type)return void this.emit("error",{message:this._i18nStrings.errorDomainType});i=this._formatNumberCellContent({fieldInfo:e,value:i}),this._setUpRangeDomainCell({row:t,cellNode:n,fieldInfo:e,container:s})}s.innerHTML=i,u.place(s,n)})}},_generateTypeColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:s.hitch(this,function(i){var n=t.getTypeValueFromRow({layerInfo:this.layerInfo,fieldInfo:e,row:i});return t.isValueEmpty(n)?i[e.name]:n}),renderCell:s.hitch(this,function(t,i,n){i=this._formatStringCellContent({fieldInfo:e,value:i});var s=u.create("div",{innerHTML:i},n);this._setUpTypeCell({row:t,cellNode:n,fieldInfo:e,container:s})}),renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})})}},_generateSubtypeDomainColumn:function(e){var i={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,editOn:this.editOn,editor:"text",get:s.hitch(this,function(i){return t.getSubtypeDomainValue({layerInfo:this.layerInfo,fieldInfo:e,row:i})}),renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})}),renderCell:s.hitch(this,function(t,i,n){i=this._formatStringCellContent({fieldInfo:e,value:i});var s=u.create("div",{innerHTML:i},n);this._setUpSubtypeDomainCell({row:t,cellNode:n,fieldInfo:e,container:s})})};return i},_generateNumberColumn:function(e){var t={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})}),renderCell:s.hitch(this,function(t,i,n){var s=this._formatNumberCellContent({fieldInfo:e,value:i}),l=u.create("div",{innerHTML:s},n);this._setUpNumberCell({row:t,cellNode:n,fieldInfo:e,container:l})})};return t},_generateStringColumn:function(e){var t={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})}),renderCell:s.hitch(this,function(t,i,n){i=this._formatStringCellContent({fieldInfo:e,value:i});var s=u.create("div",{innerHTML:i},n);this._setUpStringCell({row:t,cellNode:n,fieldInfo:e,container:s})})};return t},_generateAttachmentsColumn:function(e){var t=this.layerInfo||{};return{label:e.alias,field:e.name,type:"esriAttachments",get:s.hitch(this,function(e){var i,n,s=e[this.idProperty],l=this.attachmentInfos[s];return n=t.queryAttachmentsSupported?0:null,i=l&&l.attachments?l.attachments.length:n}),renderCell:s.hitch(this,function(t,i,n){this._generateAttachmentsCell({row:t,fieldInfo:e,cellValue:i,cellNode:n})}),renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e,cssClass:this.css.attachmentsTitle})})}},_generateRelatedRecordsColumn:function(e){return{label:e.alias,field:e.name,type:"esriRelatedRecords",hidden:e.hidden,get:s.hitch(this,function(t){return this._getRelatedRecordsCount({featureId:t[this.idProperty],relationshipId:e.relationship.id})}),renderCell:s.hitch(this,function(t,i,n){this._generateRelatedRecordsCell({row:t,fieldInfo:e,cellValue:i,cellNode:n})}),renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e,cssClass:this.css.relatedRecordsTitle})})}},_closeCellEditors:function(){var e=this._activeEditors;l.forEach(e,function(e){e.widget.onBlur()}),this.set("_activeEditors",[])},_getColumnHeaderCellContent:function(e){var t,i,n=e.fieldInfo,s=e.cssClass||null,l=this.css,o=l.lockedIconContainer+" "+l.lockedIcon,r="esriRelatedRecords"===n.type||"esriAttachments"===n.type;return i=u.create("div",{className:l.columnHeader}),t=s?l.columnHeaderTitle+" "+s:l.columnHeaderTitle,!n.editable&&this.editable&&this.layerInfo.editable&&u.create("span",{className:o},i),u.create("div",{innerHTML:n.alias||n.name,className:t},i),u.create("div",{className:l.columnHeaderClear},i),this.showColumnHeaderTooltips&&this.own(new w({connectId:[i],label:n.alias||n.name})),this.showDataTypes&&!r&&(u.create("div",{innerHTML:n.type.replace("esriFieldType",""),className:l.columnHeaderType},i),u.create("div",{className:l.columnHeaderClear},i)),i},_setUpNumberCell:function(e){var i,n,l=e.row,o=e.cellNode,r=e.fieldInfo,h=e.container,c=this.idProperty,u=t.isIntegerFieldType(r.type)?0:"0,20";d(o,this.editOn,s.hitch(this,function(){if(this.editable&&r.editable){var e=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);(this.editOn!=y||e)&&(n&&n.destroy(),this._closeCellEditors(),h.innerHTML="",n=new T({value:l[r.name],required:!r.nullable,constraints:{places:u}}),n.placeAt(h),n.focus(),n.textbox.select(),this.emit("editor-show",{cell:o,editor:n,grid:this}),n.on("blur",s.hitch(this,function(){h.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:l[r.name]}),o.focus()})),n.on("keydown",function(e){e.keyCode===a.ENTER&&n.isValid()&&n.focusNode.blur()}),n.on("change",s.hitch(this,function(e){i={fieldName:r.name,oldValue:l[r.name],rowId:l[c],row:l},(""===e||isNaN(e))&&(e=null),n.isValid()?(l[r.name]=e,h.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:e}),this._applyEdits({row:l,rollbackInfo:i})):h.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:l[r.name]}),this.emit("editor-hide",{cell:o,editor:n,grid:this}),n.destroy()})),this._activeEditors.push({id:l[c],widget:n}))}}))},_setUpDateTimeCell:function(e){var i,n,o,r,a,h,c,u=e.row,f=e.cellNode,m=e.fieldInfo,p=e.container,g=this.idProperty;d(f,this.editOn,s.hitch(this,function(){if(this.editable&&m.editable){var e=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=y||e){n&&n.destroy(),o&&o.destroy(),this._closeCellEditors(),p.innerHTML="",r=m.dateOptions&&m.dateOptions.datePattern?m.dateOptions.datePattern:this.dateOptions.datePattern,a=m.dateOptions&&m.dateOptions.timePattern?m.dateOptions.timePattern:this.dateOptions.timePattern,i=t.isValueEmpty(u[m.name])?null:new Date(u[m.name]),n=new v({value:i,constraints:{datePattern:r}}),o=new F({value:i,constraints:{timePattern:a}}),n.placeAt(p),o.placeAt(p),n.focus(),n.textbox.select(),n.on("change",s.hitch(this,function(e){if(n.isValid()){var i=o.getValue();if(c={fieldName:m.name,oldValue:u[m.name],rowId:u[g],row:u},null===e||""===e)return o.setValue(null),void(u[m.name]=null);null===i&&(i=new Date(0,0),o.setValue(i)),h=t.getCombinedDateTime(e,i).getTime(),u[m.name]=h,this._applyEdits({row:u,rollbackInfo:c})}})),o.on("change",s.hitch(this,function(e){if(o.isValid()){var i=n.getValue();if(c={fieldName:m.name,oldValue:u[m.name],rowId:u[g],row:u},null===e||""===e)return n.setValue(null),void(u[m.name]=null);null===i&&(i=new Date(0,0),n.setValue(i)),h=t.getCombinedDateTime(i,e).getTime(),u[m.name]=h,this._applyEdits({row:u,rollbackInfo:c})}}));var d=_.watch("activeStack",s.hitch(this,function(e,i,s){if((-1!==l.indexOf(i,n.id)||-1!==l.indexOf(i,o.id))&&-1===l.indexOf(s,n.id)&&-1===l.indexOf(s,o.id)){d.remove();var r,a=n.getValue(),h=o.getValue(),c={fieldName:m.name,oldValue:u[m.name],rowId:u[g],row:u};o.isValid()&&n.isValid()?(a&&h?(r=t.getCombinedDateTime(a,h).getTime(),p.innerHTML=t.formatDateForLocale({dateOptions:this.dateOptions,timestamp:new Date(r),fieldInfo:m})):(r=null,p.innerHTML=""),u[m.name]=r,this._applyEdits({row:u,rollbackInfo:c})):p.innerHTML=t.formatDateForLocale({dateOptions:this.dateOptions,timestamp:u[m.name],fieldInfo:m})}}))}}}))},_setUpCodedValueDomainCell:function(e){var i,n,o,r=e.row,h=e.cellNode,c=e.fieldInfo,u=c.domain.codedValues,f=e.container,m=this.idProperty,p=[];l.forEach(u,function(e){r[c.name]===e.code?p.push({label:e.name,value:e.code,selected:!0}):p.push({label:e.name,value:e.code})}),t.isValueEmpty(r[c.name])&&c.nullable?p.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0}):t.isValueEmpty(r[c.name])&&!c.nullable?p.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):c.nullable&&p.push({label:this._i18nStrings.empty,value:this._nullConstant}),d(h,this.editOn,s.hitch(this,function(){if(this.editable&&c.editable){var e=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);(this.editOn!=y||e)&&(o&&o.destroy(),this._closeCellEditors(),f.innerHTML="",o=new S({options:p,"class":this.css.select,style:{width:"100%"}}),o.placeAt(f),o.focus(),this.emit("editor-show",{cell:h,editor:o,grid:this}),o.on("blur",s.hitch(this,function(){var e=t.getDomainValueFromRow({fieldInfo:c,row:r});f.innerHTML=this._formatStringCellContent({fieldInfo:c,value:e})})),o.on("keydown",function(e){e.keyCode===a.ENTER&&o.focusNode.blur()}),o.on("change",s.hitch(this,function(e){n={fieldName:c.name,oldValue:r[c.name],rowId:r[m],row:r},e===this._nullConstant&&(e=null),r[c.name]=e,i=t.getDomainValueFromRow({fieldInfo:c,row:r}),f.innerHTML=this._formatStringCellContent({fieldInfo:c,value:i}),this._applyEdits({row:r,rollbackInfo:n}),this.emit("editor-hide",{cell:h,editor:o,grid:this}),o.destroy()})),this._activeEditors.push({id:r[m],widget:o}))}}))},_setUpRangeDomainCell:function(e){var i,n,l=e.row,o=e.cellNode,r=e.fieldInfo,h=e.container,c=r.domain.minValue,u=r.domain.maxValue,f=this.idProperty,m=t.isIntegerFieldType(r.type)?0:"0,20";d(o,this.editOn,s.hitch(this,function(){if(this.editable&&r.editable){var e=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);(this.editOn!=y||e)&&(i&&i.destroy(),this._closeCellEditors(),h.innerHTML="",i=new T({value:l[r.name],required:!r.nullable,constraints:{min:c,max:u,places:m}}),i.placeAt(h),i.focus(),i.textbox.select(),this.emit("editor-show",{cell:o,editor:i,grid:this}),i.on("blur",s.hitch(this,function(){h.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:l[r.name]})})),i.on("keydown",function(e){e.keyCode===a.ENTER&&i.isValid()&&i.focusNode.blur()}),i.on("change",s.hitch(this,function(e){n={fieldName:r.name,oldValue:l[r.name],rowId:l[f],row:l},i.isValid()?(l[r.name]=e,h.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:e}),this._applyEdits({row:l,rollbackInfo:n})):h.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:l[r.name]}),this.emit("editor-hide",{cell:o,editor:i,grid:this}),i.destroy()})),this._activeEditors.push({id:l[f],widget:i}))}}))},_setUpTypeCell:function(e){var i,n,o,r=e.row,h=e.cellNode,c=e.fieldInfo,u=e.container,f=this.idProperty,m=this.layerInfo,p=m.types;d(h,this.editOn,s.hitch(this,function(){if(this.editable&&c.editable){var e=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds),d=r[c.name],g=[],_=t.isValueEmpty(t.getTypeValueFromRow({layerInfo:this.layerInfo,fieldInfo:c,row:r}));(this.editOn!=y||e)&&(o&&o.destroy(),this._closeCellEditors(),l.forEach(p,function(e){r[c.name]===e.id?g.push({label:e.name,value:e.id,selected:!0}):g.push({label:e.name,value:e.id})}),t.isValueEmpty(r[c.name])?g.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):_&&g.push({label:d,value:d,selected:!0,disabled:!0}),u.innerHTML="",o=new S({options:g,"class":this.css.select,style:{width:"100%"}}),o.placeAt(u),o.focus(),this.emit("editor-show",{cell:h,editor:o,grid:this}),o.on("blur",s.hitch(this,function(){var e=t.getTypeValueFromRow({layerInfo:m,fieldInfo:c,row:r});u.innerHTML=this._formatStringCellContent({fieldInfo:c,value:e||d})})),o.on("keydown",function(e){e.keyCode===a.ENTER&&o.focusNode.blur()}),o.on("change",s.hitch(this,function(e){n={fieldName:c.name,oldValue:r[c.name],rowId:r[f],row:r},e===this._nullConstant&&(e=null),r[c.name]=e,i=t.getTypeValueFromRow({layerInfo:this.layerInfo,fieldInfo:c,row:r}),u.innerHTML=this._formatStringCellContent({fieldInfo:c,value:i}),this._applyEdits({row:r,rollbackInfo:n}),this.emit("editor-hide",{cell:h,editor:o,grid:this.grid}),o.destroy()})),this._activeEditors.push({id:r[f],widget:o}))}}))},_setUpSubtypeDomainCell:function(e){var i,n,o,r,h,c,u,f,m,p=e.row,g=e.cellNode,_=e.fieldInfo,I=e.container,C=this.idProperty,w=this.layerInfo,b=w.types;d(g,this.editOn,s.hitch(this,function(){if(this.editable&&_.editable){var e=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=y||e)if(h&&h.destroy(),c&&c.destroy(),this._closeCellEditors(),i=[],I.innerHTML="",n=t.findFirst(b,"id",p[w.typeIdField]),o=n.domains[_.name]){if(u=n.domains[_.name].codedValues,f=t.findFirst(u,"code",p[_.name]),l.forEach(u,function(e){p[_.name]===e.code?i.push({label:e.name,value:e.code,selected:!0}):i.push({label:e.name,value:e.code}),e.code===f&&(m=!0)}),t.isValueEmpty(p[_.name])&&_.nullable?i.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0}):t.isValueEmpty(p[_.name])&&!_.nullable?i.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):_.nullable&&i.push({label:this._i18nStrings.empty,value:this._nullConstant}),!m&&!f&&null!==p[_.name]){var d=p[_.name];i.push({label:d.toString(),value:"N/A",selected:!0,disabled:!0})}h=new S({options:i,"class":this.css.select,style:{width:"100%"}}),h.placeAt(I),h.focus(),this.emit("editor-show",{cell:g,editor:h,grid:this}),h.on("blur",s.hitch(this,function(){var e=t.findFirst(u,"code",p[_.name]);e?I.innerHTML=this._formatStringCellContent({fieldInfo:_,value:e.name}):I.innerHTML=this._formatStringCellContent({fieldInfo:_,value:p[_.name]})})),h.on("keydown",function(e){e.keyCode===a.ENTER&&h.focusNode.blur()}),h.on("change",s.hitch(this,function(e){r={fieldName:_.name,oldValue:p[_.name],rowId:p[C],row:p},e===this._nullConstant&&(e=null),p[_.name]=e;var i=t.findFirst(u,"code",e);i?I.innerHTML=this._formatStringCellContent({fieldInfo:_,value:i.name}):I.innerHTML="",this.emit("editor-hide",{cell:g,editor:h,grid:this}),h.destroy(),this._applyEdits({row:p,rollbackInfo:r})})),this._activeEditors.push({id:p[C],widget:h})}else c=new T({value:p[_.name],required:!_.nullable}),c.placeAt(I),c.focus(),c.textbox.select(),this.emit("editor-show",{cell:g,editor:c,grid:this}),c.on("blur",s.hitch(this,function(){I.innerHTML=p[_.name]})),c.on("keydown",function(e){e.keyCode===a.ENTER&&c.isValid()&&c.focusNode.blur()}),c.on("change",s.hitch(this,function(e){r={fieldName:_.name,oldValue:p[_.name],rowId:p[C],row:p},c.isValid()?(p[_.name]=e,I.innerHTML=e,this._applyEdits({row:p,rollbackInfo:r})):I.innerHTML=p[_.name]})),this._activeEditors.push({id:p[C],widget:c}),c.destroy()}}))},_setUpStringCell:function(e){var i,n,l=e.row,o=e.cellNode,r=e.fieldInfo,h=e.container,c=this.idProperty;d(o,this.editOn,s.hitch(this,function(){if(this.editable&&r.editable){var e=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);(this.editOn!=y||e)&&(n&&n.destroy(),this._closeCellEditors(),h.innerHTML="",n=new H({value:l[r.name],required:!r.nullable,maxLength:r.length?r.length:null}),n.placeAt(h),n.focus(),n.textbox.select(),this.emit("editor-show",{cell:o,editor:n,grid:this}),n.on("blur",s.hitch(this,function(){h.innerHTML=this._formatStringCellContent({fieldInfo:r,value:l[r.name]}),o.focus()})),n.on("keydown",function(e){e.keyCode===a.ENTER&&n.isValid()&&n.focusNode.blur()}),n.on("change",s.hitch(this,function(e){i={fieldName:r.name,oldValue:l[r.name],rowId:l[c],row:l},""===e&&(e=null),n.isValid()?(l[r.name]=e,h.innerHTML=this._formatStringCellContent({fieldInfo:r,value:e}),this._applyEdits({row:l,rollbackInfo:i})):h.innerHTML=this._formatStringCellContent({fieldInfo:r,value:l[r.name]})})),this._activeEditors.push({id:l[c],widget:n}))}}))},_formatStringCellContent:function(e){var i=e.value,n=e.fieldInfo,s=n?n.format:null;return s&&(s.embeddedHTML||s.link===!1)?t.isValueEmpty(i)?"":i:s&&s.template?t.isValueEmpty(i)?"":h.substitute(s.template,{value:i}):t.generateLinkFromString(i)},_formatNumberCellContent:function(e){var i=e.value,n=e.fieldInfo,s=n.format,l=s?s.template:null;return null!==i?l?h.substitute(l,{value:t.formatNumberForLocale(i,s)}):t.formatNumberForLocale(i,s):null===i?"":t.formatNumberForLocale(i)},_generateAttachmentsCell:function(e){if(this.layerInfo){var i,n,l,o=e.row,r=e.cellValue,a=e.cellNode,c=e.fieldInfo,f=this.layerInfo,m=this.css,p=this._i18nStrings;l=t.isValueEmpty(r)?"":h.substitute(p.parenValue,{value:r}),i=u.create("div",{innerHTML:l,className:m.attachmentsCell},a),n=r>0||!f.queryAttachmentsSupported?" "+p.show:this.editable&&f.editable?" "+p.add:"",u.create("span",{innerHTML:n,className:m.attachmentsLink},i),d(i,y,s.hitch(this,function(){this._showAttachmentsHandler({row:o,fieldInfo:c,cellValue:r,cellNode:a,textContainer:i})}))}},_generateRelatedRecordsCell:function(e){var i,n,l=e.row,o=e.cellValue,r=e.cellNode,a=e.fieldInfo,c=this.css,f=this._i18nStrings;n=t.isValueEmpty(o)?"":h.substitute(f.parenValue,{value:o})+" ",i=u.create("div",{innerHTML:n,className:c.relatedRecordsCell},r),u.create("span",{innerHTML:o>0?f.show:"",className:c.relatedRecordsLink},i),d(r,y,s.hitch(this,function(e){if(o>0){var t=this.dGrid.cell(e).column;this._showRelatedRecordsHandler({row:l,fieldInfo:a,column:t,count:o})}}))},updateHeaderText:function(e){var i=e?e.count:null,n=e?e.selectedCount:null,s=e?e.title:null,l=e?e.showFilterCount:!0;s=t.isValueEmpty(s)?this._tableTitle||this.layer.name||this._i18nStrings.untitled:s,i=t.isValueEmpty(i)?this.featureCount:i,n=t.isValueEmpty(n)?this.selectedFeatureCount:n,this.filterIds&&this.filterIds.length>0&&l&&(i=this.filterIds.length),this.showFeatureCount?this.setHeaderTitle(h.substitute(this._i18nStrings.gridHeader,{gridTitle:s,featureCount:i,featureSelectedCount:n})):this.setHeaderTitle(s)},_generateOptionsMenu:function(){var e,t,i,n=[];t=new I({className:this.css.optionsMenu}),this.showDefaultSortMenuItem&&n.push({label:this._i18nStrings.defaultSort,callback:this._sortFieldDefaultCallback}),this.showFilterMenuItems?n.push({label:this._i18nStrings.showSelected,callback:this._showSelectedRecordsCallback},{label:this._i18nStrings.clearSelection,callback:this._clearFilterCallback}):n.push({label:this._i18nStrings.clearSelection,callback:this.clearSelection}),this.gridOptions.columnHider&&n.push({label:this._i18nStrings.toggleColumns,callback:this.showColumnToggleMenu}),this.map&&this.syncSelection&&n.push({label:this._i18nStrings.centerOnSelection,callback:this.centerOnSelection}),this.menuFunctions&&this.menuFunctions.length>0&&l.forEach(this.menuFunctions,function(e){n.push({label:e.label,callback:e.callback})},this),l.forEach(n,function(i){e=new C({label:i.label,baseClass:this.css.menuItem,onClick:s.hitch(this,i.callback)}),t.addChild(e)},this),i=new R({label:this._i18nStrings.options,dropDown:t},this._gridMenuNode),this.set({optionsMenu:t,optionsMenuAnchor:i})},_sortFieldDefaultCallback:function(){var e=this.defaultSort.attribute,i=this.defaultSort.descending;this.set("sort",{field:e,descending:i
}),this.emit("sort",{field:e,descending:i,orderByFields:[t.getOrderByString(e,i)]})},_showSelectedRecordsCallback:function(){0!==this.selectedRowIds.length&&this.emit("show-selected-records",{ids:this.selectedRowIds})},_clearFilterCallback:function(){this.emit("clear-selection"),this.emit("clear-filter")},showColumnToggleMenu:function(){this.dGrid._toggleColumnHiderMenu()},_generateColumnMenu:function(e){var i=this.dGrid.cell(e),n=i?i.column:null;if(n){var o,r=this.dGrid,a=r.columns,d=this.fieldInfos,h=this.columnMenu,c=this.columnMenuFunctions,u=h,f=n.id,m=a[f],p=t.findFirst(d,"name",m.field),g="esriRelatedRecords"===m.type||"esriAttachments"===m.type;h&&this.set("columnMenu",null),g||m.sortable!==!1&&(o=new I,this._generateSortMenuItems({menu:o,columnId:f}),this._generateStatisticsMenuItem({menu:o,fieldInfo:p,columnId:f}),this._generateFieldDetailsMenuItem({menu:o,fieldInfo:p,column:m}),c&&c.length>0&&l.forEach(c,function(e){o.addChild(new C({label:e.label,iconClass:e.iconClass||"",baseClass:e.baseClass||"",onClick:s.hitch(this,e.callback,p)}))}),o.startup(),this._showColumnMenu({menu:o,cell:i,evt:e,fieldInfo:p,previousMenu:u}),this.set("columnMenu",o))}},_showColumnMenu:function(e){var t,i,n,s=e.menu,l=e.cell,o=e.evt,r=e.previousMenu;t=l.element.getBoundingClientRect(),i=t.right-t.width,n=t.top+t.height,s._openMyself({target:o.target,delegatedTarget:l,iframe:null,coords:{x:i,y:n}}),d(s,"close",function(){r&&(r.destroyRecursive(),r=null)})},_generateSortMenuItems:function(e){var t=e.menu,i=e.columnId,n=this.css;t.addChild(new C({label:this._i18nStrings.sortAsc,iconClass:n.sortAscendingIcon,baseClass:n.menuItem,onClick:s.hitch(this,this._sortFieldAscendingHandler,i)})),t.addChild(new C({label:this._i18nStrings.sortDesc,iconClass:n.sortDescendingIcon,baseClass:n.menuItem,onClick:s.hitch(this,this._sortFieldDescendingHandler,i)}))},_sortFieldAscendingHandler:function(e){var i=this.dGrid.columns[e];this.emit("sort",{column:i,id:e,field:i.field,descending:!1,orderByFields:[t.getOrderByString(i.field,!1)]})},_sortFieldDescendingHandler:function(e){var i=this.dGrid.columns[e];this.emit("sort",{column:i,id:e,field:i.field,descending:!0,orderByFields:[t.getOrderByString(i.field,!0)]})},_generateStatisticsMenuItem:function(e){var i=e.menu,n=e.fieldInfo,l=this.css,o=this.layer,r=this.layerInfo,a=!!r.isFeatureCollection,d=o.advancedQueryCapabilities.supportsStatistics||o.supportsStatistics;!this.showStatistics||!d||!n||n.domain&&n.domain.codedValues||n.subtypeDomain||n.typeId||a||t.isNumericFieldType(n.type)&&i.addChild(new C({label:this._i18nStrings.statistics,iconClass:l.statisticsIcon,baseClass:l.menuItem,onClick:s.hitch(this,this._showStatisticsHandler,e)}))},_generateFieldDetailsMenuItem:function(e){if(this.showFieldDetails){var t=e.menu,i=e.fieldInfo,n=e.column,o=parseInt(n.id,10),r=this.css,a="esriFieldTypeOID"!==i.type&&"esriFieldTypeGlobalID"!==i.type&&-1===l.indexOf(this._unsupportedFieldTypes,i.type);a&&t.addChild(new C({label:this._i18nStrings.showDetailedView,iconClass:r.propertiesIcon,baseClass:r.menuItem,onClick:s.hitch(this,function(){this.emit("show-detailed-field-view",{columnId:o,fieldInfo:i})})}))}},_generateColumnHiderButton:function(){var e,t=this.css,i=t.menuItem+" "+t.button+" "+t.menuIcon;e=u.create("div",{className:i,tabIndex:0}),u.place(e,this._gridTitleNode,"before"),d(e,y,s.hitch(this,this.showColumnHiderMenu)),this._columnHiderButton=e},_fetchAttachments:function(e){return t.queryLayerForAttachments({layer:this.layer,ids:e||null})},_showAttachmentsHandler:function(e){var t,n,l,o,r=e.row,a=e.fieldInfo,d=e.cellValue,h=e.cellNode,c=this.layerInfo,u=this.idProperty,f=r[u];(0!==d||c.editCapabilities.canCreate)&&(t=this.attachmentInfos[f]?this.attachmentInfos[f].attachments:[],n=i.generateAttachmentsDialog({layer:this.layer,featureId:f,attachments:t,editable:this.editable&&c.editable,css:this.css}),o=n.featureAttachments,l=o.attachments,this.own(o.on("add-complete",s.hitch(this,function(e){this.attachmentInfos[f]||(this.attachmentInfos[f]={}),this.attachmentInfos[f].attachments=e.attachments,d+=1,h.innerHTML="",this._generateAttachmentsCell({row:r,fieldInfo:a,cellValue:d,cellNode:h})})),o.on("delete-complete",s.hitch(this,function(e){this.attachmentInfos[f].attachments=e.attachments,d-=1,h.innerHTML="",this._generateAttachmentsCell({row:r,fieldInfo:a,cellValue:d,cellNode:h})}))),this.emit("show-attachments",{featureId:f,attachments:l,dialog:n.dialog}))},_updateAttachmentInfos:function(e){return s.mixin(this.attachmentInfos,e)},_fetchRelatedRecords:function(e){var i=e.ids||null,n=e.relationship,s=e.outFields||["*"];return t.queryLayerForRelatedRecords({layer:this.layer,ids:i,relationship:n,outFields:s})},_showRelatedRecordsHandler:function(e){var i,n,s,o=e.row,r=this.idProperty,a=o[r],d=e.fieldInfo,h=d.relationship,c=e.count,u=this.columns,f=this.layer,m=f.getField(h.keyField),p=m?m.name:null,g=p?o[p]:null;n=l.filter(u,function(e){return!e.hidden}),i=[t.findFirst(n,"field",f.displayField),t.findFirst(n,"field",p),t.findFirst(n,"type","esriFieldTypeString"),t.findFirstNumberColumn(u,r),t.findFirst(n,"type","esriFieldTypeDate")],l.some(i,function(e){return this._validateRelatedColumnDisplay(e)?(s=l.indexOf(u,e),!0):void 0},this),t.isValueEmpty(s)&&(s=0),this.emit("show-related-records",{row:o,featureId:a,keyField:p,keyFieldValue:g,columnId:s,relationship:h,count:c})},_setUpRelatedRecordInfos:function(e){var t=e.relationships,i=e.records,n=this.relatedRecordInfos;return l.forEach(t,function(e,t){n[e.id]=i[t]}),n},_updateRelatedRecordInfos:function(e){var i=this.relatedRecordInfos;this.relatedRecordInfos=t.mergeDictionaries(i,e)},_updateRelatedRecordCounts:function(e){var i=this.relatedRecordCounts,n=this.layer.relationships,s={};l.forEach(n,function(t){var i=e[t.id],n=i.relatedRecordGroups;s[t.id]={},l.forEach(n,function(e){s[t.id][e.objectId]={count:e.count}})}),this.relatedRecordCounts=t.mergeDictionaries(i,s)},_getRelatedRecordsById:function(e){var t=e.featureId,i=e.relationshipId;return this.relatedRecordInfos[i]?this.relatedRecordInfos[i][t]:[]},_getRelatedRecordsCount:function(e){var t,i=e.featureId,n=e.relationshipId;return this.layerInfo.supportsAdvancedQueryRelated?(t=this.relatedRecordCounts[n]?this.relatedRecordCounts[n][i]:{},t?t.count:0):(t=this._getRelatedRecordsById({featureId:i,relationshipId:n}),t&&t.features?t.features.length:0)},_generateRelatedRecordFieldInfos:function(e){var i,n,s=e.fieldInfos,o=e.relationships,r=this.visibleLayerIds,a=!1;l.some(o,function(e,l){l===this._relationshipColumnLimit&&(a=!0),n=t.isCyclicalRelationship(e),i=r?r[r.length-1]===e.relatedTableId:!1,i&&n&&!this.showCyclicalRelationships||s.push({alias:e.name,name:e.name,type:"esriRelatedRecords",hidden:a,relatedIndex:l,relationship:e})},this)},_validateRelatedColumnDisplay:function(e){return!(!e||e.hidden||-1===l.indexOf(this.columns,e)||"esriFieldTypeOID"===e.type||"esriFieldTypeGlobalID"===e.type)},_showStatisticsHandler:function(e){var n,l,o=e.columnId,r=e.fieldInfo;n=this.where||this.layer.getDefinitionExpression?this.layer.getDefinitionExpression():"1=1",t.getFieldStatistics({grid:this.dGrid,layer:this.layer,fieldInfo:r,idProperty:this.idProperty,filterIds:this.filterIds,where:n,columnId:o}).then(s.hitch(this,function(e){l=i.generateStatisticsDialog({data:e,fieldName:r.name,css:this.css}),this.emit("show-statistics",l)}))},_addGridListeners:function(){this._setUpRowSelectListener(),this._setUpRowDeselectListener(),this._setUpDataChangeListener(),this._setUpRefreshListener(),this._setUpColumnClickListener(),this._setUpColumnStateChangeListener(),this._setUpColumnResizeListener(),this._setUpErrorListener(),this._setUpSortListener(),this._setUpFilterListener(),this._setUpEditorShowListener(),this._setUpEditorHideListener(),this.own(this._setUpStoreLoadListener(),this._setUpLayerEditsCompleteListener(),this._setUpLayerClickListener(),this._setUpLayerSelectionCompleteListener(),this._setUpLayerSelectionClearListener(),this._setUpLayerUpdateEndListener())},_setUpStoreLoadListener:function(){var e=this.watch("store",s.hitch(this,function(t,i,n){null===i&&n&&(this.set("loaded",!0),this.emit("load",{loaded:!0}),e.remove())}));return e},_setUpRowSelectListener:function(){return this.dGrid.on("dgrid-select",s.hitch(this,function(e){this._updateSelection().then(s.hitch(this,function(){this.updateHeaderText(),this.emit("row-select",e)}))}))},_setUpRowDeselectListener:function(){return this.dGrid.on("dgrid-deselect",s.hitch(this,function(e){this._previousSelectedRowIds=this.selectedRowIds,this._updateSelection().then(s.hitch(this,function(){this.updateHeaderText(),this.emit("row-deselect",e)}))}))},_setUpDataChangeListener:function(){var e=this.dGrid;return e.on("dgrid-datachange",s.hitch(this,function(e){var i=this.fieldInfos,n=e.cell.column.field,l=t.findFirst(i,"name",n),o=e.cell.row.data,r=o[this.idProperty],a=e.value,d=e.oldValue,h=t.isIntegerFieldType(l.type),c=t.isFloatFieldType(l.type),u={oldValue:d,fieldName:n,rowId:r,row:o};""===a&&(a=null),h&&null!==a&&(a=parseInt(a,10)),c&&null!==a&&(a=parseFloat(a)),a&&a.getTime&&a.getTime()?o[n]=a.getTime():o[n]=a,this.showLoadingIndicator(),this._updateSelection().then(s.hitch(this,function(){this.updateHeaderText(),this._applyEdits({row:o,rollbackInfo:u})})),this.emit("data-change",{row:o,rollbackInfo:u})}))},_setUpRefreshListener:function(){return this.dGrid.on("dgrid-refresh-complete",s.hitch(this,function(e){this.dGrid.columns[0]&&this.emit("refresh",e)}))},_setUpColumnClickListener:function(){return this.dGrid.on(".dgrid-header .dgrid-cell:click",s.hitch(this,this._generateColumnMenu))},_setUpColumnStateChangeListener:function(){return this.dGrid.on("dgrid-columnstatechange",s.hitch(this,function(e){this.emit("column-state-change",e)}))},_setUpColumnResizeListener:function(){return this.dGrid.on("dgrid-columnresize",s.hitch(this,function(e){this.emit("column-resize",e)}))},_setUpErrorListener:function(){return this.dGrid.on("dgrid-error",s.hitch(this,function(e){this.emit("error",e)}))},_setUpSortListener:function(){return this.dGrid.on("dgrid-sort",s.hitch(this,function(e){this.emit("sort",e)}))},_setUpFilterListener:function(){return this.dGrid.on("dgrid-filter",s.hitch(this,function(e){this.emit("filter",e)}))},_setUpEditorShowListener:function(){return this.dGrid.on("dgrid-editor-show",s.hitch(this,function(e){this.emit("editor-show",e)}))},_setUpEditorHideListener:function(){return this.dGrid.on("dgrid-editor-hide",s.hitch(this,function(e){this.emit("editor-hide",e)}))},_setUpLayerClickListener:function(){return d(this.layer,"click",s.hitch(this,function(e){this.emit("layer-click",e)}))},_setUpLayerSelectionCompleteListener:function(){return d(this.layer,"selection-complete",s.hitch(this,function(e){this.emit("layer-selection-complete",e)}))},_setUpLayerSelectionClearListener:function(){return d(this.layer,"selection-clear",s.hitch(this,function(e){this.emit("layer-selection-clear",e)}))},_setUpLayerUpdateEndListener:function(){return d(this.layer,"update-end",s.hitch(this,function(e){this.emit("layer-update-end",e)}))},_setUpLayerEditsCompleteListener:function(){return d(this.layer,"edits-complete",s.hitch(this,function(e){var t,i,n,s=e.updates||[],o=this.rollbackInfos;s&&s.length&&l.forEach(s,function(e){t=o[e.objectId],i=t[t.length-1]||null,e.success||(e.error?this.emit("error",{message:e.error}):this.emit("error",{message:this._i18nStrings.errorUpdateFailed}),i?(n=this.getRowDataById(i.rowId),n[this.idProperty]===e.objectId?(n[i.fieldName]=i.oldValue,this.dGrid.updateDirty(i.rowId,i.fieldName,i.oldValue),this.refresh()):this.emit("error",{message:this._i18nStrings.errorRollback})):this.emit("error",{message:this._i18nStrings.errorRollback})),this.emit("edits-complete",{update:{success:e.success,field:i.fieldName,value:this.getRowDataById(i.rowId)[i.fieldName],previousValue:i.oldValue}})},this),this.hideLoadingIndicator()}))}});return r("extend-esri")&&s.setObject("dijit.Grid",B,e),B});