// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["../../kernel","./dataUtils","./dialogUtils","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/aspect","dojo/has","dojo/keys","dojo/on","dojo/string","dojo/dom-class","dojo/dom-construct","dojo/Deferred","dojox/html/entities","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_WidgetBase","dijit/a11yclick","dijit/focus","dijit/Menu","dijit/MenuItem","dijit/Tooltip","dijit/form/Button","dijit/form/DateTextBox","dijit/form/DropDownButton","dijit/form/NumberTextBox","dijit/form/Select","dijit/form/TimeTextBox","dijit/form/ValidationTextBox","dijit/layout/BorderContainer","dijit/layout/ContentPane","dgrid/OnDemandGrid","dgrid/Selection","dgrid/selector","dgrid/Keyboard","dgrid/editor","dgrid/extensions/Pagination","dgrid/extensions/DijitRegistry","dgrid/extensions/ColumnHider","dgrid/extensions/ColumnResizer","dojo/i18n!../../nls/jsapi","dojo/text!./templates/Grid.html"],function(e,t,i,n,s,l,o,r,a,d,h,c,u,f,m,p,g,y,I,_,C,w,b,v,F,R,T,S,E,L,H,N,M,O,D,V,x,k,G,U,A,P,j){var B=n([y,p,g],{declaredClass:"esri.dijit.FeatureTable.Grid",baseClass:"esri-feature-table-grid",templateString:j,map:null,layer:null,layerInfo:null,idProperty:"id",sort:null,defaultSort:null,filterIds:null,where:null,batchCount:50,editable:!1,editOn:"dblclick, keypress",css:null,showAttachments:!1,showRelatedRecords:!1,showCyclicalRelationships:!1,showStatistics:!1,showFieldDetails:!1,showGridHeader:!0,showGridMenu:!0,showFilterMenuItems:!0,showDefaultSortMenuItem:!0,showFeatureCount:!0,showDataTypes:!1,showColumnHeaderTooltips:!1,showColumnHider:!1,syncSelection:!1,menuFunctions:null,columnMenuFunctions:null,gridOptions:null,dateOptions:null,visibleLayerIds:null,showExpressionFields:!1,loaded:!1,store:null,columns:null,fieldInfos:null,customFieldInfos:null,expressionInfos:null,expressionCache:{},noDataMessage:"",featureCount:0,selectedFeatureCount:0,selectedRows:null,selectedRowIds:null,optionsMenu:null,optionsMenuAnchor:null,columnMenu:null,rollbackInfos:null,attachmentInfos:null,relatedRecordInfos:null,relatedRecordCounts:null,_i18nStrings:P.widgets.FeatureTable,_numericFieldTypes:["esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeSmallInteger","number"],_unsupportedFieldTypes:["esriFieldTypeGUID","esriFieldTypeRaster","esriFieldTypeBlob","esriFieldTypeGeometry","esriFieldTypeXML"],_activeEditors:[],_relationshipColumnLimit:5,_nullConstant:"ft_null",_watchers:null,_tableTitle:null,_previousSelectedRowIds:null,postMixInProperties:function(){this.inherited(arguments),this.set({sort:{},columns:[],fieldInfos:[],selectedRows:[],selectedRowIds:[],rollbackInfos:{},attachmentInfos:{},relatedRecordInfos:{},relatedRecordCounts:{},_watchers:[],_previousSelectedRowIds:[]})},startup:function(){this.inherited(arguments),this.showExpressionFields&&this.expressionInfos&&(this.expressionCache=t.compileExpressions(this.expressionInfos)),this.dGrid=this._createGrid(),this._cleanUpGrid(),this.dGrid.startup(),this.dGrid.resize(),this.showLoadingIndicator(),this.updateHeaderText(),this.showGridHeader||this.hideHeader(),this._generateOptionsMenu(),this.showGridMenu||this.hideOptionsMenu(),this._addGridListeners()},destroy:function(){this.inherited(arguments),this.optionsMenu&&this.optionsMenu.destroy(),this.columnMenu&&this.columnMenu.destroyRecursive(),l.forEach(this._watchers,function(e){e.remove()})},resize:function(){this._gridBorderContainerNode&&this._gridBorderContainerNode.resize(),this._gridHeaderNode&&this._gridHeaderNode.resize(),this._gridContentPaneNode&&this._gridContentPaneNode.resize(),this.dGrid&&this.dGrid.resize()},setHeaderTitle:function(e){this._gridTitleNode&&(this._gridTitleNode.innerHTML=e)},showHeader:function(){c.remove(this._gridHeaderNode.domNode,this.css.hidden),this.resize()},hideHeader:function(){c.add(this._gridHeaderNode.domNode,this.css.hidden),this.resize()},showLoadingIndicator:function(){this._gridLoadingIndicatorNode&&c.remove(this._gridLoadingIndicatorNode,this.css.hidden)},hideLoadingIndicator:function(){this._gridLoadingIndicatorNode&&c.add(this._gridLoadingIndicatorNode,this.css.hidden)},showOptionsMenu:function(){this._menuNode&&c.remove(this._menuNode,this.css.hidden)},hideOptionsMenu:function(){this._menuNode&&c.add(this._menuNode,this.css.hidden)},updateNoDataMessage:function(e){this.dGrid.set("noDataMessage",e)},showColumnHiderMenu:function(){this.gridOptions.columnHider&&this.dGrid._toggleColumnHiderMenu()},refresh:function(){this.dGrid&&this.dGrid.refresh(),0===this.featureCount&&this.hideLoadingIndicator(),this._updateSelection().then(s.hitch(this,this.updateHeaderText))},getRowById:function(e){return this.dGrid.row(e)||{}},getRowDataById:function(e){var t=this.getRowById(e);return t&&t.data?t.data:{}},emptyStore:function(){this.updateNoDataMessage(""),this.updateStore(null)},updateStore:function(e){this.set("store",e),this.dGrid.set("store",e)},updateSort:function(e){this.set("sort",e[0]),this.dGrid.set("sort",e)},updateSelectionMode:function(e){this.dGrid.set("selectionMode",e)},getColumns:function(){return this.dGrid.columns},styleColumn:function(e,t){return this.dGrid.styleColumn(e,t)},clearSelection:function(){this.dGrid.clearSelection(),this._updateSelection().then(s.hitch(this,this.updateHeaderText)),this.emit("clear-selection")},centerOnSelection:function(){var e=this.map,i=this.layer,n=this.selectedRowIds;if(e&&n&&0!==n.length)return t.queryLayerForFeatures({layer:i,ids:n}).then(s.hitch(function(i){var n=i.features;n&&n.length>0&&e.setExtent(t.calculateExtentFromFeatures(n))}))},selectRows:function(e,t,i){var n,o=this.dGrid,r=[];this._closeCellEditors(),this.clearSelection(),e instanceof Array?(l.forEach(e,function(e){o._select(e),r.push(this.getRowById(e))},this),n=e[0]):(o._select(e),n=e,r=[this.getRowById(e)]),this._updateSelection().then(s.hitch(this,function(){this.updateHeaderText(),i||this.emit("row-select",{rows:r,grid:this.dGrid}),t&&this._scrollToRow(n)}))},_createGrid:function(){var e=this._generateGridClass();return new e({columns:this.columns,sort:[this.defaultSort],noDataMessage:this.noDataMessage,selectionMode:this.gridOptions.selectionMode,allowSelectAll:this.gridOptions.allowSelectAll,allowTextSelection:this.gridOptions.allowTextSelection,cellNavigation:this.gridOptions.cellNavigation,keepScrollPosition:this.gridOptions.keepScrollPosition,pageSizeOptions:this.gridOptions.pageSizeOptions,queryRowsOverlap:this.gridOptions.queryRowsOverlap,minRowsPerPage:this.batchCount,maxRowsPerPage:this.batchCount,pagingDelay:this.pagingDelay,query:s.hitch(this,this._getQueryForGrid)},this._gridNode)},_generateGridClass:function(){var e=[G,M,O,x,D,V];return this.gridOptions.pagination&&e.push(k),this.gridOptions.columnHider&&e.push(U),this.gridOptions.columnResizer&&e.push(A),n(e)},_getQueryForGrid:function(e){return!this.filterIds||-1!==l.indexOf(this.filterIds,e[this.idProperty])},_cleanUpGrid:function(){var e=this.dGrid,t=o.before(e,"removeRow",s.hitch(this,function(t){l.forEach(this.columns.length,function(i,n){var s=e.cell(t,n).element,l=s.contents||s,o=l.widget;o&&o.destroyRecursive()})})),i=o.after(e,"renderHeader",function(){e._sortListener.remove()});this._watchers.push(t,i)},_setUpColumns:function(e){var t=this._generateFieldInfos(e),i=this._generateColumns(t);return this.set({columns:i,fieldInfos:t}),this.dGrid.set("columns",i),{fieldInfos:t,columns:i}},_generateFieldInfos:function(e){if(e&&0!==e.length&&this.layerInfo){var i=this._orderFieldsForDisplay(e),n=this.layer,s=this.layerInfo,o=[],r=this.customFieldInfos;l.forEach(i,function(e){var i=e.name,a=e.length||null,d=t.findFirst(n.fields,"name",i)||{},h=t.findFirst(r,"name",i)||t.findFirst(r,"fieldName",i),c=t.isExpressionField(i);if(c){var u=t.getExpressionInfo(this.expressionInfos,i);o.push({name:u.name,expression:!0,length:a,hidden:!h.visible,alias:e.alias,type:e.type,editable:e.editable,nullable:e.nullable,domain:!1,typeId:!1,subtypeDomain:!1,format:h.format||null,dateOptions:null})}else{var f,m,p,g,y,I,_,C,w,b,v,F=this.idProperty,R=this.outFields,T=this.hiddenFields;p=h&&(h.label||h.alias)||d.alias,g=n.getDomain&&n.getDomain(i)?n.getDomain(i):!1,y=!(!s.typeIdField||i!==s.typeIdField),I=s.types&&l.some(s.types,function(e){return e.domains&&e.domains[i]&&e.domains[i].name?!0:void 0}),_=!this._getFieldVisibility({field:e,hiddenFields:T,customFieldInfo:h,outFields:R}),f=s.editable&&s.editCapabilities.canUpdate,m=h&&("undefined"!=typeof h.editable&&d.editable!==!1||"undefined"!=typeof h.isEditable&&d.isEditable!==!1),C=f&&i!==F&&d&&"undefined"!==d.editable?m?!!h.editable||!!h.isEditable:!!d.editable:!1,w=h&&h.format?h.format:null,b=!!d.nullable,v=h&&(h.dateOptions||h.format&&h.format.dateFormat)||null,o.push({name:i,alias:p,length:a,type:e.type,hidden:_,editable:C,nullable:b,domain:g,typeId:y,subtypeDomain:I,format:w,dateOptions:v})}},this);var a=l.every(o,function(e){return e.hidden});if(a){var d=t.findFirst(o,"name",this.idProperty);d.hidden=!1}if(this.showRelatedRecords){var h=this._generateRelatedRecordFieldInfos({relationships:n.relationships});o=o.concat(h)}return this.showAttachments&&o.push({alias:this._i18nStrings.photosAndFiles,name:"esriAttachments",type:"esriAttachments",editable:s.editable}),o}},_destroyColumns:function(){this.dGrid&&this.dGrid._destroyColumns()},_getFieldVisibility:function(e){var t,i,n,s,o,r,a=e.field,d=e.hiddenFields,h=e.outFields,c=e.customFieldInfo;return i=-1!==l.indexOf(d,a.name),o=!(!c||c.visible!==!1),r="*"!==h[0]&&-1===l.indexOf(h,a.name),n="esriFieldTypeOID"===a.type||"esriFieldTypeGlobalID"===a.type,s=n&&(o||r),t=i||s||o||r,!t},_applyEdits:function(e){var i=e.row,n=e.rollbackInfo;return this.showLoadingIndicator(),n&&this._updateRollbackInfos(n),this.emit("data-change",{row:i,rollbackInfo:n}),t.applyEditsFromRow({layer:this.layer,idProperty:this.idProperty,row:i}).then(s.hitch(this,function(e){var t=e.updates||[];t&&t.length&&l.forEach(t,function(e){e.success||(e.error?this.emit("error",{message:e.error}):this.emit("error",{message:this._i18nStrings.errorUpdateFailed}),n?(i=this.getRowDataById(n.rowId),i[n.fieldName]=n.oldValue,this.dGrid.updateDirty(n.rowId,n.fieldName,n.oldValue),this.refresh()):this.emit("error",{message:this._i18nStrings.errorRollback}))},this),this.hideLoadingIndicator(),this.emit("edits-complete",e)})).otherwise(s.hitch(this,function(){n&&(i=this.getRowDataById(n.rowId),i[n.fieldName]=n.oldValue,this.dGrid.updateDirty(n.rowId,n.fieldName,n.oldValue),this.refresh()),this.hideLoadingIndicator(),this.emit("error",{message:this._i18nStrings.errorUpdateFailed})}))},_updateRollbackInfos:function(e){if(e){var t=e.rowId;this.rollbackInfos[t]||(this.rollbackInfos[t]=[]),this.rollbackInfos[t].push(e)}},_updateSelection:function(){var e,t,i,n,s,l=this.dGrid.selection,o=new f,r=[],a=[];for(i in l)l.hasOwnProperty(i)&&(n=parseInt(i,10),a.push(n),e=this.dGrid.row(n),t=e.data,t&&r.push(t));return s={selectedRows:r,selectedRowIds:a,selectedFeatureCount:a.length},this.set(s),o.resolve(s),o},_scrollToRow:function(e){var t,i,n,s=this.store,o=this.dGrid,r=o.row(e),a=this.sort;if(r&&s){if(r.element)return void r.element.scrollIntoView();t=s.data[e]||r.data,t&&(i=a&&a.attribute===this.idProperty&&a.descending?s.data.length-l.indexOf(s.data,t):l.indexOf(s.data,t),n=o.rowHeight*i-o.rowHeight,o.scrollTo({x:0,y:n}),r.element?r.element.scrollIntoView():setTimeout(function(){r.element&&r.element.scrollIntoView()},200))}},_generateColumns:function(e){var t=s.clone(e)||[],i=[];return l.forEach(t,function(e){e.expression?i.push(this._generateExpressionColumn(e)):"esriAttachments"===e.type?i.push(this._generateAttachmentsColumn(e)):"esriRelatedRecords"===e.type?i.push(this._generateRelatedRecordsColumn(e)):"esriFieldTypeDate"===e.type?this.dateOptions.timeEnabled?i.push(this._generateDateTimeColumn(e)):i.push(this._generateDateColumn(e)):e.typeId?i.push(this._generateTypeColumn(e)):e.domain?i.push(this._generateDomainColumn(e)):e.subtypeDomain&&!e.typeId?i.push(this._generateSubtypeDomainColumn(e)):l.indexOf(this._numericFieldTypes,e.type)>-1?i.push(this._generateNumberColumn(e)):-1===l.indexOf(this._unsupportedFieldTypes,e.type)&&i.push(this._generateStringColumn(e))},this),i},_orderFieldsForDisplay:function(e){var i=this.outFields,n=this.idProperty,o=[];return i&&"*"===i[0]?o=s.clone(e):(t.isValueEmpty(n)||-1!==l.indexOf(i,n)||o.push(t.findFirst(e,"name",n)),l.forEach(i,function(i){var s=t.findFirst(e,"name",i);s&&i!==n&&-1===l.indexOf(o,s)&&o.push(s)},this),l.forEach(e,function(e){-1===l.indexOf(o,e)&&o.push(s.clone(e))})),o},_generateDateColumn:function(e){var i=e.dateOptions||this.dateOptions;return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,className:this.css.dateValue,get:s.hitch(this,function(n){return t.isValueEmpty(n[e.name])?null:t.formatDateForLocale({dateOptions:i,timestamp:new Date(n[e.name]),fieldInfo:e})}),renderCell:s.hitch(this,function(i,n,s){var l=u.create("div",{innerHTML:t.isValueEmpty(n)?"":n},s);this._setUpDateCell({row:i,cellNode:s,fieldInfo:e,container:l})}),renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})})}},_generateDateTimeColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,className:this.css.dateValue,get:s.hitch(this,function(i){return t.isValueEmpty(i[e.name])?null:t.formatDateForLocale({dateOptions:e.dateOptions||this.dateOptions,timestamp:new Date(i[e.name]),fieldInfo:e})}),renderCell:s.hitch(this,function(i,n,s){var l=u.create("div",{innerHTML:t.isValueEmpty(n)?"":n},s);this._setUpDateTimeCell({row:i,cellNode:s,fieldInfo:e,container:l})}),renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})})}},_generateDomainColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:function(i){return t.getDomainValueFromRow({fieldInfo:e,row:i})},renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})}),renderCell:s.hitch(this,function(t,i,n){var s=u.create("div");if(e.domain.codedValues)i=this._formatStringCellContent({fieldInfo:e,value:i}),this._setUpCodedValueDomainCell({row:t,cellNode:n,fieldInfo:e,container:s});else{if("range"!==e.domain.type)return void this.emit("error",{message:this._i18nStrings.errorDomainType});i=this._formatNumberCellContent({fieldInfo:e,value:i}),this._setUpRangeDomainCell({row:t,cellNode:n,fieldInfo:e,container:s})}s.innerHTML=i,u.place(s,n)})}},_generateTypeColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:s.hitch(this,function(i){var n=t.getTypeValueFromRow({layerInfo:this.layerInfo,fieldInfo:e,row:i});return t.isValueEmpty(n)?i[e.name]:n}),renderCell:s.hitch(this,function(t,i,n){i=this._formatStringCellContent({fieldInfo:e,value:i});var s=u.create("div",{innerHTML:i},n);this._setUpTypeCell({row:t,cellNode:n,fieldInfo:e,container:s})}),renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})})}},_generateSubtypeDomainColumn:function(e){var i={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,editOn:this.editOn,editor:"text",get:s.hitch(this,function(i){return t.getSubtypeDomainValue({layerInfo:this.layerInfo,fieldInfo:e,row:i})}),renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})}),renderCell:s.hitch(this,function(t,i,n){i=this._formatStringCellContent({fieldInfo:e,value:i});var s=u.create("div",{innerHTML:i},n);this._setUpSubtypeDomainCell({row:t,cellNode:n,fieldInfo:e,container:s})})};return i},_generateNumberColumn:function(e){var t={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})}),renderCell:s.hitch(this,function(t,i,n){var s=this._formatNumberCellContent({fieldInfo:e,value:i}),l=u.create("div",{innerHTML:s},n);this._setUpNumberCell({row:t,cellNode:n,fieldInfo:e,container:l})})};return t},_generateStringColumn:function(e){var t={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e})}),renderCell:s.hitch(this,function(t,i,n){i=this._formatStringCellContent({fieldInfo:e,value:i});var s=u.create("div",{innerHTML:i},n);this._setUpStringCell({row:t,cellNode:n,fieldInfo:e,container:s})})};return t},_generateAttachmentsColumn:function(e){var t=this.layerInfo||{};return{label:e.alias,field:e.name,type:"esriAttachments",sortable:!1,get:s.hitch(this,function(e){var i,n,s=e[this.idProperty],l=this.attachmentInfos[s];return n=t.queryAttachmentsSupported?0:null,i=l&&l.attachments?l.attachments.length:n}),renderCell:s.hitch(this,function(t,i,n){this._generateAttachmentsCell({row:t,fieldInfo:e,cellValue:i,cellNode:n})}),renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e,cssClass:this.css.attachmentsTitle})})}},_generateRelatedRecordsColumn:function(e){return{label:e.alias,field:e.name,type:"esriRelatedRecords",hidden:e.hidden,sortable:!1,get:s.hitch(this,function(t){return this._getRelatedRecordsCount({featureId:t[this.idProperty],relationshipId:e.relationship.id})}),renderCell:s.hitch(this,function(t,i,n){this._generateRelatedRecordsCell({row:t,fieldInfo:e,cellValue:i,cellNode:n})}),renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e,cssClass:this.css.relatedRecordsTitle})})}},_generateExpressionColumn:function(e){return{label:e.alias,field:e.name,type:"esriExpressions",sortable:!1,get:s.hitch(this,function(i){var n=i[this.idProperty],s=this.store.data[n],l=this.expressionCache[e.name],o=t.getExpressionValue(s,l);return o}),renderCell:s.hitch(this,function(t,i,n){var s;"number"==e.type?s=this._formatNumberCellContent({fieldInfo:e,value:i}):(s=this._formatStringCellContent({fieldInfo:e,value:i}),s=String(s),s=m.encode(s)),u.create("div",{innerHTML:s},n)}),renderHeaderCell:s.hitch(this,function(){return this._getColumnHeaderCellContent({fieldInfo:e,cssClass:this.css.expressionsTitle})})}},_closeCellEditors:function(){var e=this._activeEditors;l.forEach(e,function(e){e.widget.onBlur()}),this.set("_activeEditors",[])},_getColumnHeaderCellContent:function(e){var t,i,n,s,l=e.fieldInfo,o=e.cssClass||null,r=this.css;return s=u.create("div",{className:r.columnHeader}),n=o?r.columnHeaderTitle+" "+o:r.columnHeaderTitle,!l.editable&&this.editable&&this.layerInfo.editable&&u.create("span",{className:r.lockedIconContainer+" "+r.lockedIcon},s),i=m.encode(l.alias||l.name),u.create("div",{innerHTML:i,className:n},s),u.create("div",{className:r.columnHeaderClear},s),this.showColumnHeaderTooltips&&this.own(new b({connectId:[s],label:i})),t="esriExpressions"===l.type||"esriRelatedRecords"===l.type||"esriAttachments"===l.type,this.showDataTypes&&!t&&(u.create("div",{innerHTML:l.type.replace("esriFieldType",""),className:r.columnHeaderType},s),u.create("div",{className:r.columnHeaderClear},s)),s},_setUpNumberCell:function(e){var i,n,l=e.row,o=e.cellNode,r=e.fieldInfo,h=e.container,c=this.idProperty,u=t.isIntegerFieldType(r.type)?0:"0,20";d(o,this.editOn,s.hitch(this,function(){var e=t.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:l});if(this.editable&&r.editable&&e!==!1){var d=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);(this.editOn!=I||d)&&(i&&i.destroy(),this._closeCellEditors(),h.innerHTML="",i=new T({value:l[r.name],required:!r.nullable,constraints:{places:u}}),i.placeAt(h),i.focus(),i.textbox.select(),this.emit("editor-show",{cell:o,editor:i,grid:this}),i.on("blur",s.hitch(this,function(){h.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:l[r.name]}),o.focus(),this.emit("editor-hide",{cell:o,editor:i,grid:this})})),i.on("keydown",function(e){e.keyCode===a.ENTER&&i.isValid()&&i.focusNode.blur()}),i.on("change",s.hitch(this,function(e){n={fieldName:r.name,oldValue:l[r.name],rowId:l[c],row:l},(""===e||isNaN(e))&&(e=null),i.isValid()?(l[r.name]=e,h.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:e}),this._applyEdits({row:l,rollbackInfo:n})):h.innerHTML=this._formatNumberCellContent({fieldInfo:r,value:l[r.name]}),i.destroy()})),this._activeEditors.push({id:l[c],widget:i}))}}))},_setUpDateCell:function(e){var i,n,l=e.row,o=e.cellNode,r=e.fieldInfo,h=e.container,c=this.idProperty;d(o,this.editOn,s.hitch(this,function(){var e=t.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:l});if(this.editable&&r.editable&&e!==!1){var d=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=I||d){this._closeCellEditors(),h.innerHTML="",n=r.dateOptions&&r.dateOptions.datePattern?r.dateOptions.datePattern:this.dateOptions.datePattern,i=t.isValueEmpty(l[r.name])?null:new Date(l[r.name]);var u=new F({value:i,constraints:{datePattern:n}});u.placeAt(h),u.focus(),u.textbox.select(),this.emit("editor-show",{cell:o,editor:u,grid:this}),u.on("blur",s.hitch(this,function(){h.innerHTML=t.isValueEmpty(l[r.name])?null:t.formatDateForLocale({dateOptions:this.dateOptions,timestamp:l[r.name],fieldInfo:r}),o.focus(),this.emit("editor-hide",{cell:o,editor:u,grid:this})})),u.on("keydown",function(e){e.keyCode===a.ENTER&&u.isValid()&&u.focusNode.blur()}),u.on("change",s.hitch(this,function(e){if(u.isValid()){var i={fieldName:r.name,oldValue:l[r.name],rowId:l[c],row:l};l[r.name]=t.isValueEmpty(e)?null:e.getTime(),h.innerHTML=t.isValueEmpty(l[r.name])?null:t.formatDateForLocale({dateOptions:this.dateOptions,timestamp:l[r.name],fieldInfo:r}),this._applyEdits({row:l,rollbackInfo:i})}else h.innerHTML=t.isValueEmpty(l[r.name])?null:t.formatDateForLocale({dateOptions:this.dateOptions,timestamp:l[r.name],fieldInfo:r})}))}}}))},_setUpDateTimeCell:function(e){var i,n,o,r=e.row,a=e.cellNode,h=e.fieldInfo,c=e.container,u=this.idProperty;d(a,this.editOn,s.hitch(this,function(){var e=t.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:r});if(this.editable&&h.editable&&e!==!1){var d=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=I||d){this._closeCellEditors(),c.innerHTML="",n=h.dateOptions&&h.dateOptions.datePattern?h.dateOptions.datePattern:this.dateOptions.datePattern,o=h.dateOptions&&h.dateOptions.timePattern?h.dateOptions.timePattern:this.dateOptions.timePattern,i=t.isValueEmpty(r[h.name])?null:new Date(r[h.name]);var f=new F({value:i,constraints:{datePattern:n}}),m=new E({value:i,constraints:{timePattern:o}});f.placeAt(c),m.placeAt(c),f.focus(),f.textbox.select(),this.emit("editor-show",{cell:a,editor:[f,m],grid:this}),f.on("change",s.hitch(this,function(e){if(f.isValid()){if(null===e||""===e)return void m.setValue(null);var t=m.getValue();null===t&&(t=new Date(0,0),m.setValue(t))}})),m.on("change",s.hitch(this,function(e){if(m.isValid()){if(null===e||""===e)return void f.setValue(null);var t=f.getValue();null===t&&(t=new Date(0,0),f.setValue(t))}}));var p=_.watch("activeStack",s.hitch(this,function(e,i,n){var s=-1!==l.indexOf(i,f.id)||-1!==l.indexOf(i,m.id),o=-1===l.indexOf(n,f.id)&&-1===l.indexOf(n,m.id);if(s&&o){p.remove(),this.emit("editor-hide",{cell:a,editor:[f,m],grid:this});var d,g=f.getValue(),y=m.getValue(),I=r[h.name];if(m.isValid()&&f.isValid()){if(g&&y?(d=t.getCombinedDateTime(g,y).getTime(),c.innerHTML=t.formatDateForLocale({dateOptions:this.dateOptions,timestamp:new Date(d),fieldInfo:h})):(d=null,c.innerHTML=""),r[h.name]===d)return;r[h.name]=d,this._applyEdits({row:r,rollbackInfo:{fieldName:h.name,oldValue:I,rowId:r[u],row:r}})}else null===I?c.innerHTML="":c.innerHTML=t.formatDateForLocale({dateOptions:this.dateOptions,timestamp:r[h.name],fieldInfo:h});f.destroy(),m.destroy()}}))}}}))},_setUpCodedValueDomainCell:function(e){var i,n=e.row,o=e.cellNode,r=e.fieldInfo,h=r.domain.codedValues,c=e.container,u=this.idProperty,f=[];l.forEach(h,function(e){n[r.name]===e.code?f.push({label:e.name,value:e.code,selected:!0}):f.push({label:e.name,value:e.code})}),t.isValueEmpty(n[r.name])&&r.nullable?f.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0}):t.isValueEmpty(n[r.name])&&!r.nullable?f.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):r.nullable&&f.push({label:this._i18nStrings.empty,value:this._nullConstant}),d(o,this.editOn,s.hitch(this,function(){var e=t.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:n});if(this.editable&&r.editable&&e!==!1){var l=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=I||l){this._closeCellEditors(),c.innerHTML="";var d=new S({options:f,"class":this.css.select,style:{width:"100%"}});d.placeAt(c),d.focus(),this.emit("editor-show",{cell:o,editor:d,grid:this}),d.on("blur",s.hitch(this,function(){var e=t.getDomainValueFromRow({fieldInfo:r,row:n});c.innerHTML=this._formatStringCellContent({fieldInfo:r,value:e}),this.emit("editor-hide",{cell:o,editor:d,grid:this}),this._activeEditors.pop()})),d.on("keydown",function(e){e.keyCode===a.ENTER&&d.focusNode.blur()}),d.on("change",s.hitch(this,function(e){i={fieldName:r.name,oldValue:n[r.name],rowId:n[u],row:n},e===this._nullConstant&&(e=null),n[r.name]=e,d.onBlur(),this._applyEdits({row:n,rollbackInfo:i}),d.destroy(),d=null})),this._activeEditors.push({id:n[u],widget:d})}}}))},_setUpRangeDomainCell:function(e){var i,n=e.row,l=e.cellNode,o=e.fieldInfo,r=e.container,h=o.domain.minValue,c=o.domain.maxValue,u=this.idProperty,f=t.isIntegerFieldType(o.type)?0:"0,20";d(l,this.editOn,s.hitch(this,function(){var e=t.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:n});if(this.editable&&o.editable&&e!==!1){var d=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=I||d){this._closeCellEditors(),r.innerHTML="";var m=new T({value:n[o.name],required:!o.nullable,constraints:{min:h,max:c,places:f}});m.placeAt(r),m.focus(),m.textbox.select(),this.emit("editor-show",{cell:l,editor:m,grid:this}),m.on("blur",s.hitch(this,function(){r.innerHTML=this._formatNumberCellContent({fieldInfo:o,value:n[o.name]}),this.emit("editor-hide",{cell:l,editor:m,grid:this}),this._activeEditors.pop()})),m.on("keydown",function(e){e.keyCode===a.ENTER&&m.isValid()&&m.focusNode.blur()}),m.on("change",s.hitch(this,function(e){i={fieldName:o.name,oldValue:n[o.name],rowId:n[u],row:n},m.isValid()&&(n[o.name]=e,this._applyEdits({row:n,rollbackInfo:i})),m.onBlur(),m.destroy(),m=null})),this._activeEditors.push({id:n[u],widget:m})}}}))},_setUpTypeCell:function(e){var i,n=e.row,o=e.cellNode,r=e.fieldInfo,h=e.container,c=this.idProperty,u=this.layerInfo,f=u.types;d(o,this.editOn,s.hitch(this,function(){var e=t.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:n});if(this.editable&&r.editable&&e!==!1){var d=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds),m=n[r.name],p=[],g=t.isValueEmpty(t.getTypeValueFromRow({layerInfo:this.layerInfo,fieldInfo:r,row:n}));if(this.editOn!=I||d){this._closeCellEditors(),l.forEach(f,function(e){n[r.name]===e.id?p.push({label:e.name,value:e.id,selected:!0}):p.push({label:e.name,value:e.id})}),t.isValueEmpty(n[r.name])?p.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):g&&p.push({label:m,value:m,selected:!0,disabled:!0}),h.innerHTML="";var y=new S({options:p,"class":this.css.select,style:{width:"100%"}});y.placeAt(h),y.focus(),this.emit("editor-show",{cell:o,editor:y,grid:this}),y.on("blur",s.hitch(this,function(){var e=t.getTypeValueFromRow({layerInfo:u,fieldInfo:r,row:n});h.innerHTML=this._formatStringCellContent({fieldInfo:r,value:e||m}),this.emit("editor-hide",{cell:o,editor:y,grid:this.grid}),this._activeEditors.pop()})),y.on("keydown",function(e){e.keyCode===a.ENTER&&y.focusNode.blur()}),y.on("change",s.hitch(this,function(e){i={fieldName:r.name,oldValue:n[r.name],rowId:n[c],row:n},e===this._nullConstant&&(e=null),n[r.name]=e,y.onBlur(),this._applyEdits({row:n,rollbackInfo:i}),y.destroy(),y=null})),this._activeEditors.push({id:n[c],widget:y})}}}))},_setUpSubtypeDomainCell:function(e){var i,n,o,r,h,c=e.row,u=e.cellNode,f=e.fieldInfo,m=e.container,p=this.idProperty,g=this.layerInfo,y=g.types;d(u,this.editOn,s.hitch(this,function(){var e=t.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:c});if(this.editable&&f.editable&&e!==!1){var d=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=I||d)if(this._closeCellEditors(),i=[],m.innerHTML="",n=t.findFirst(y,"id",c[g.typeIdField]),o=n.domains[f.name]){var _=n.domains[f.name].codedValues,C=t.findFirst(_,"code",c[f.name]);if(l.forEach(_,function(e){c[f.name]===e.code?i.push({label:e.name,value:e.code,selected:!0}):i.push({label:e.name,value:e.code}),e.code===C&&(h=!0)}),t.isValueEmpty(c[f.name])&&f.nullable?i.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0}):t.isValueEmpty(c[f.name])&&!f.nullable?i.push({label:this._i18nStrings.empty,value:this._nullConstant,selected:!0,disabled:!0}):f.nullable&&i.push({label:this._i18nStrings.empty,value:this._nullConstant}),!h&&!C&&null!==c[f.name]){var w=c[f.name];i.push({label:w.toString(),value:"N/A",selected:!0,disabled:!0})}var b=new S({options:i,"class":this.css.select,style:{width:"100%"}});b.placeAt(m),b.focus(),this.emit("editor-show",{cell:u,editor:b,grid:this}),b.on("blur",s.hitch(this,function(){var e=t.findFirst(_,"code",c[f.name]);e?m.innerHTML=this._formatStringCellContent({fieldInfo:f,value:e.name}):m.innerHTML=this._formatStringCellContent({fieldInfo:f,value:c[f.name]}),this.emit("editor-hide",{cell:u,editor:b,grid:this}),this._activeEditors.pop()})),b.on("keydown",function(e){e.keyCode===a.ENTER&&b.focusNode.blur()}),b.on("change",s.hitch(this,function(e){r={fieldName:f.name,oldValue:c[f.name],rowId:c[p],row:c},e===this._nullConstant&&(e=null),c[f.name]=e,b.onBlur(),this._applyEdits({row:c,rollbackInfo:r}),b.destroy(),b=null})),this._activeEditors.push({id:c[p],widget:b})}else{var v=new T({value:c[f.name],required:!f.nullable});v.placeAt(m),v.focus(),v.textbox.select(),this.emit("editor-show",{cell:u,editor:v,grid:this}),v.on("blur",s.hitch(this,function(){m.innerHTML=c[f.name],this._activeEditors.pop()})),v.on("keydown",function(e){e.keyCode===a.ENTER&&v.isValid()&&v.focusNode.blur()}),v.on("change",s.hitch(this,function(e){r={fieldName:f.name,oldValue:c[f.name],rowId:c[p],row:c},v.isValid()&&(c[f.name]=e,this._applyEdits({row:c,rollbackInfo:r})),v.onBlur(),v.destroy(),v=null})),this._activeEditors.push({id:c[p],widget:v})}}}))},_setUpStringCell:function(e){var i=e.row,n=e.cellNode,l=e.fieldInfo,o=e.container,r=this.idProperty;d(n,this.editOn,s.hitch(this,function(){var e=t.isFeatureEditable({layer:this.layer,layerInfo:this.layerInfo,attributes:i});if(this.editable&&l.editable&&e!==!1){var d=t.compareIntArrays(this.selectedRowIds,this._previousSelectedRowIds);if(this.editOn!=I||d){this._closeCellEditors(),o.innerHTML="";var h=new L({value:i[l.name],required:!l.nullable,maxLength:l.length?l.length:null});h.placeAt(o),h.focus(),h.textbox.select(),this.emit("editor-show",{cell:n,editor:h,grid:this}),h.on("blur",s.hitch(this,function(){o.innerHTML=this._formatStringCellContent({fieldInfo:l,value:i[l.name]}),n.focus(),this.emit("editor-hide",{cell:n,editor:h,grid:this}),this._activeEditors.pop()})),h.on("keydown",function(e){e.keyCode===a.ENTER&&h.isValid()&&h.focusNode.blur()}),h.on("change",s.hitch(this,function(e){var t={fieldName:l.name,oldValue:i[l.name],rowId:i[r],row:i};""===e&&(e=null),h.isValid()&&(i[l.name]=e,this._applyEdits({row:i,rollbackInfo:t})),o.innerHTML=this._formatStringCellContent({fieldInfo:l,value:i[l.name]}),h.destroy(),h=null})),this._activeEditors.push({id:i[r],widget:h})}}}))},_formatStringCellContent:function(e){var i=e.value,n=e.fieldInfo,s=n?n.format:null;return s&&(s.embeddedHTML||s.link===!1)?t.isValueEmpty(i)?"":i:s&&s.template?t.isValueEmpty(i)?"":h.substitute(s.template,{value:i}):t.generateLinkFromString(i)},_formatNumberCellContent:function(e){var i=e.value,n=e.fieldInfo,s=n.format,l=s?s.template:null;
return null!==i?l?h.substitute(l,{value:t.formatNumberForLocale(i,s)}):t.formatNumberForLocale(i,s):null===i?"":t.formatNumberForLocale(i)},_generateAttachmentsCell:function(e){if(this.layerInfo){var i,n,l,o=e.row,r=e.cellValue,a=e.cellNode,c=e.fieldInfo,f=this.layerInfo,m=this.css,p=this._i18nStrings;l=t.isValueEmpty(r)?"":h.substitute(p.parenValue,{value:r}),i=u.create("div",{innerHTML:l,className:m.attachmentsCell},a),n=r>0||!f.queryAttachmentsSupported?" "+p.show:this.editable&&f.editable?" "+p.add:"",u.create("span",{innerHTML:n,className:m.attachmentsLink},i),d(i,I,s.hitch(this,function(){this._showAttachmentsHandler({row:o,fieldInfo:c,cellValue:r,cellNode:a,textContainer:i})}))}},_generateRelatedRecordsCell:function(e){var i,n,l=e.row,o=e.cellValue,r=e.cellNode,a=e.fieldInfo,c=this.css,f=this._i18nStrings;n=t.isValueEmpty(o)?"":h.substitute(f.parenValue,{value:o})+" ",i=u.create("div",{innerHTML:n,className:c.relatedRecordsCell},r),u.create("span",{innerHTML:o>0?f.show:"",className:c.relatedRecordsLink},i),d(r,I,s.hitch(this,function(e){if(o>0){var t=this.dGrid.cell(e).column;this._showRelatedRecordsHandler({row:l,fieldInfo:a,column:t,count:o})}}))},updateHeaderText:function(e){var i=e?e.count:null,n=e?e.selectedCount:null,s=e?e.title:null,l=e?e.showFilterCount:!0;s=t.isValueEmpty(s)?this._tableTitle||this.layer.name||this._i18nStrings.untitled:s,i=t.isValueEmpty(i)?this.featureCount:i,n=t.isValueEmpty(n)?this.selectedFeatureCount:n,this.filterIds&&this.filterIds.length>0&&l&&(i=this.filterIds.length),this.showFeatureCount?this.setHeaderTitle(h.substitute(this._i18nStrings.gridHeader,{gridTitle:s,featureCount:i,featureSelectedCount:n})):this.setHeaderTitle(s)},_generateOptionsMenu:function(){var e,t=this.css,i=this._i18nStrings,n=t.menuItem+" "+t.button+" "+t.menuIcon;e=u.create("div",{className:n,title:i.options,"aria-label":i.options,tabIndex:0},this._gridMenuNode),d(e,[I,"keydown"],s.hitch(this,function(e){"Tab"!==e.key&&this._showOptionsMenu(e)})),this.optionsMenuAnchor=e},_showOptionsMenu:function(e){var t,i,n,o,r,a=this.optionsMenuAnchor,d=this.css;this.optionsMenu&&(this.optionsMenu.destroy(),this.optionsMenu=null),n=a.getBoundingClientRect(),o=n.top+n.height,r=this.isLeftToRight()?n.left+n.width:n.right-n.width,t=new C({className:d.optionsMenu}),i=this._generateOptionsMenuItems(),l.forEach(i,function(e){var i=new w({label:e.label,baseClass:d.menuItem,onClick:s.hitch(this,e.callback)});t.addChild(i)},this),t._openMyself({target:e.target,delegatedTarget:a,iframe:null,coords:{x:r,y:o}}),this.optionsMenu=t},_generateOptionsMenuItems:function(){var e=[];return this.showDefaultSortMenuItem&&e.push({label:this._i18nStrings.defaultSort,callback:this._sortFieldDefaultCallback}),this.showFilterMenuItems?e.push({label:this._i18nStrings.showSelected,callback:this._showSelectedRecordsCallback},{label:this._i18nStrings.clearSelection,callback:this._clearFilterCallback}):e.push({label:this._i18nStrings.clearSelection,callback:this.clearSelection}),this.gridOptions.columnHider&&e.push({label:this._i18nStrings.toggleColumns,callback:this.showColumnToggleMenu}),this.map&&this.syncSelection&&e.push({label:this._i18nStrings.centerOnSelection,callback:this.centerOnSelection}),this.menuFunctions&&this.menuFunctions.length>0&&l.forEach(this.menuFunctions,function(t){e.push({label:t.label,callback:t.callback})},this),e},_sortFieldDefaultCallback:function(){var e=this.defaultSort.attribute,i=this.defaultSort.descending;this.set("sort",{field:e,descending:i}),this.emit("sort",{field:e,descending:i,orderByFields:[t.getOrderByString(e,i)]})},_showSelectedRecordsCallback:function(){0!==this.selectedRowIds.length&&this.emit("show-selected-records",{ids:this.selectedRowIds})},_clearFilterCallback:function(){this.emit("clear-selection"),this.emit("clear-filter")},showColumnToggleMenu:function(){this.dGrid._toggleColumnHiderMenu()},_generateColumnMenu:function(e){var i=this.dGrid.cell(e),n=i?i.column:null;if(n){var o,r=this.dGrid,a=r.columns,d=this.fieldInfos,h=this.columnMenu,c=this.css,u=this.columnMenuFunctions,f=h,m=n.id,p=a[m],g=t.findFirst(d,"name",p.field);h&&this.set("columnMenu",null),p.sortable!==!1&&(o=new C({className:c.columnMenu}),this._generateSortMenuItems({menu:o,columnId:m}),this._generateStatisticsMenuItem({menu:o,fieldInfo:g,columnId:m}),this._generateFieldDetailsMenuItem({menu:o,fieldInfo:g,column:p}),u&&u.length>0&&l.forEach(u,function(e){o.addChild(new w({label:e.label,iconClass:e.iconClass||"",baseClass:e.baseClass||"",onClick:s.hitch(this,e.callback,g)}))}),o.startup(),this._showColumnMenu({menu:o,cell:i,evt:e,fieldInfo:g,previousMenu:f}),this.set("columnMenu",o))}},_showColumnMenu:function(e){var t,i,n,s=e.menu,l=e.cell,o=e.evt,r=e.previousMenu;t=l.element.getBoundingClientRect(),n=t.top+t.height,i=this.isLeftToRight()?t.right-t.width:t.right,s._openMyself({target:o.target,delegatedTarget:l,iframe:null,coords:{x:i,y:n}}),d(s,"close",function(){r&&(r.destroyRecursive(),r=null)})},_generateSortMenuItems:function(e){var t=e.menu,i=e.columnId,n=this.css;t.addChild(new w({label:this._i18nStrings.sortAsc,iconClass:n.sortAscendingIcon,baseClass:n.menuItem,onClick:s.hitch(this,this._sortFieldAscendingHandler,i)})),t.addChild(new w({label:this._i18nStrings.sortDesc,iconClass:n.sortDescendingIcon,baseClass:n.menuItem,onClick:s.hitch(this,this._sortFieldDescendingHandler,i)}))},_sortFieldAscendingHandler:function(e){var i=this.dGrid.columns[e];this.emit("sort",{column:i,id:e,field:i.field,descending:!1,orderByFields:[t.getOrderByString(i.field,!1)]})},_sortFieldDescendingHandler:function(e){var i=this.dGrid.columns[e];this.emit("sort",{column:i,id:e,field:i.field,descending:!0,orderByFields:[t.getOrderByString(i.field,!0)]})},_generateStatisticsMenuItem:function(e){var i=e.menu,n=e.fieldInfo,l=this.css,o=this.layer,r=this.layerInfo,a=!!r.isFeatureCollection,d=o.advancedQueryCapabilities.supportsStatistics||o.supportsStatistics;!this.showStatistics||!d||!n||n.domain&&n.domain.codedValues||n.subtypeDomain||n.typeId||a||t.isNumericFieldType(n.type)&&i.addChild(new w({label:this._i18nStrings.statistics,iconClass:l.statisticsIcon,baseClass:l.menuItem,onClick:s.hitch(this,this._showStatisticsHandler,e)}))},_generateFieldDetailsMenuItem:function(e){if(this.showFieldDetails){var t=e.menu,i=e.fieldInfo,n=e.column,o=parseInt(n.id,10),r=this.css,a="esriFieldTypeOID"!==i.type&&"esriFieldTypeGlobalID"!==i.type&&-1===l.indexOf(this._unsupportedFieldTypes,i.type);a&&t.addChild(new w({label:this._i18nStrings.showDetailedView,iconClass:r.propertiesIcon,baseClass:r.menuItem,onClick:s.hitch(this,function(){this.emit("show-detailed-field-view",{columnId:o,fieldInfo:i})})}))}},_fetchAttachments:function(e){return t.queryLayerForAttachments({layer:this.layer,ids:e||null})},_showAttachmentsHandler:function(e){var t,n,l,o,r=e.row,a=e.fieldInfo,d=e.cellValue,h=e.cellNode,c=this.layerInfo,u=this.idProperty,f=r[u];(0!==d||c.editCapabilities.canCreate)&&(t=this.attachmentInfos[f]?this.attachmentInfos[f].attachments:[],n=i.generateAttachmentsDialog({layer:this.layer,featureId:f,attachments:t,editable:this.editable&&c.editable,css:this.css}),o=n.featureAttachments,l=o.attachments,this.own(o.on("add-complete",s.hitch(this,function(e){this.attachmentInfos[f]||(this.attachmentInfos[f]={attachments:[]}),this.attachmentInfos[f].attachments=e.attachments,c.queryAttachmentsSupported&&(d+=1),h.innerHTML="",this._generateAttachmentsCell({row:r,fieldInfo:a,cellValue:d,cellNode:h})})),o.on("delete-complete",s.hitch(this,function(e){this.attachmentInfos[f]||(this.attachmentInfos[f]={attachments:[]}),this.attachmentInfos[f].attachments=e.attachments,c.queryAttachmentsSupported&&(d-=1),h.innerHTML="",this._generateAttachmentsCell({row:r,fieldInfo:a,cellValue:d,cellNode:h})}))),this.emit("show-attachments",{featureId:f,attachments:l,dialog:n.dialog}))},_updateAttachmentInfos:function(e){return s.mixin(this.attachmentInfos,e)},_fetchRelatedRecords:function(e){var i=e.ids||null,n=e.relationship,s=e.outFields||["*"];return t.queryLayerForRelatedRecords({layer:this.layer,ids:i,relationship:n,outFields:s})},_showRelatedRecordsHandler:function(e){var i,n,s,o=e.row,r=this.idProperty,a=o[r],d=e.fieldInfo,h=d.relationship,c=e.count,u=this.columns,f=this.layer,m=f.getField(h.keyField),p=m?m.name:null,g=p?o[p]:null;n=l.filter(u,function(e){return!e.hidden}),i=[t.findFirst(n,"field",f.displayField),t.findFirst(n,"field",p),t.findFirst(n,"type","esriFieldTypeString"),t.findFirstNumberColumn(u,r),t.findFirst(n,"type","esriFieldTypeDate")],l.some(i,function(e){return this._validateRelatedColumnDisplay(e)?(s=l.indexOf(u,e),!0):void 0},this),t.isValueEmpty(s)&&(s=0),this.emit("show-related-records",{row:o,featureId:a,keyField:p,keyFieldValue:g,columnId:s,relationship:h,count:c})},_setUpRelatedRecordInfos:function(e){var t=e.relationships,i=e.records,n=this.relatedRecordInfos;return l.forEach(t,function(e,t){n[e.id]=i[t]}),n},_updateRelatedRecordInfos:function(e){var i=this.relatedRecordInfos;this.relatedRecordInfos=t.mergeDictionaries(i,e)},_updateRelatedRecordCounts:function(e){var i=this.relatedRecordCounts,n=this.layer.relationships,s={};l.forEach(n,function(t){var i=e[t.id],n=i.relatedRecordGroups;s[t.id]={},l.forEach(n,function(e){s[t.id][e.objectId]={count:e.count}})}),this.relatedRecordCounts=t.mergeDictionaries(i,s)},_getRelatedRecordsById:function(e){var t=e.featureId,i=e.relationshipId;return this.relatedRecordInfos[i]?this.relatedRecordInfos[i][t]:[]},_getRelatedRecordsCount:function(e){var t,i=e.featureId,n=e.relationshipId;return this.layerInfo.supportsAdvancedQueryRelated?(t=this.relatedRecordCounts[n]?this.relatedRecordCounts[n][i]:{},t?t.count:0):(t=this._getRelatedRecordsById({featureId:i,relationshipId:n}),t&&t.features?t.features.length:0)},_generateRelatedRecordFieldInfos:function(e){var i,n,s=[],o=e.relationships,r=this.visibleLayerIds,a=!1;return l.some(o,function(e,l){l===this._relationshipColumnLimit&&(a=!0),n=t.isCyclicalRelationship(e),i=r?r[r.length-1]===e.relatedTableId:!1,i&&n&&!this.showCyclicalRelationships||s.push({alias:e.name,name:e.name,type:"esriRelatedRecords",hidden:a,relatedIndex:l,relationship:e})},this),s},_validateRelatedColumnDisplay:function(e){return!(!e||e.hidden||-1===l.indexOf(this.columns,e)||"esriFieldTypeOID"===e.type||"esriFieldTypeGlobalID"===e.type)},_showStatisticsHandler:function(e){var n,l,o=e.columnId,r=e.fieldInfo;n=this.where||this.layer.getDefinitionExpression?this.layer.getDefinitionExpression():"1=1",t.getFieldStatistics({grid:this.dGrid,layer:this.layer,fieldInfo:r,idProperty:this.idProperty,filterIds:this.filterIds,where:n,columnId:o}).then(s.hitch(this,function(e){l=i.generateStatisticsDialog({data:e,fieldInfo:r,css:this.css}),this.emit("show-statistics",l)}))},_addGridListeners:function(){this._setUpRowSelectListener(),this._setUpRowDeselectListener(),this._setUpDataChangeListener(),this._setUpRefreshListener(),this._setUpColumnClickListener(),this._setUpColumnStateChangeListener(),this._setUpColumnResizeListener(),this._setUpErrorListener(),this._setUpSortListener(),this._setUpFilterListener(),this._setUpEditorShowListener(),this._setUpEditorHideListener(),this.own(this._setUpStoreLoadListener(),this._setUpLayerClickListener(),this._setUpLayerSelectionCompleteListener(),this._setUpLayerSelectionClearListener(),this._setUpLayerUpdateEndListener())},_setUpStoreLoadListener:function(){var e=this.watch("store",s.hitch(this,function(t,i,n){null===i&&n&&(this.set("loaded",!0),this.emit("load",{loaded:!0}),e.remove())}));return e},_setUpRowSelectListener:function(){return this.dGrid.on("dgrid-select",s.hitch(this,function(e){this._updateSelection().then(s.hitch(this,function(){this.updateHeaderText(),this.emit("row-select",e)}))}))},_setUpRowDeselectListener:function(){return this.dGrid.on("dgrid-deselect",s.hitch(this,function(e){this._previousSelectedRowIds=this.selectedRowIds,this._updateSelection().then(s.hitch(this,function(){this.updateHeaderText(),this.emit("row-deselect",e)}))}))},_setUpDataChangeListener:function(){var e=this.dGrid;return e.on("dgrid-datachange",s.hitch(this,function(e){var i=this.fieldInfos,n=e.cell.column.field,l=t.findFirst(i,"name",n),o=e.cell.row.data,r=o[this.idProperty],a=e.value,d=e.oldValue,h=t.isIntegerFieldType(l.type),c=t.isFloatFieldType(l.type),u={oldValue:d,fieldName:n,rowId:r,row:o};""===a&&(a=null),h&&null!==a&&(a=parseInt(a,10)),c&&null!==a&&(a=parseFloat(a)),a&&a.getTime&&a.getTime()?o[n]=a.getTime():o[n]=a,this.showLoadingIndicator(),this._updateSelection().then(s.hitch(this,function(){this.updateHeaderText(),this._applyEdits({row:o,rollbackInfo:u})})),this.emit("data-change",{row:o,rollbackInfo:u})}))},_setUpRefreshListener:function(){return this.dGrid.on("dgrid-refresh-complete",s.hitch(this,function(e){this.dGrid.columns[0]&&this.emit("refresh",e)}))},_setUpColumnClickListener:function(){return this.dGrid.on(".dgrid-header .dgrid-cell:click",s.hitch(this,this._generateColumnMenu))},_setUpColumnStateChangeListener:function(){return this.dGrid.on("dgrid-columnstatechange",s.hitch(this,function(e){this.emit("column-state-change",e)}))},_setUpColumnResizeListener:function(){return this.dGrid.on("dgrid-columnresize",s.hitch(this,function(e){this.emit("column-resize",e)}))},_setUpErrorListener:function(){return this.dGrid.on("dgrid-error",s.hitch(this,function(e){this.emit("error",e)}))},_setUpSortListener:function(){return this.dGrid.on("dgrid-sort",s.hitch(this,function(e){this.emit("sort",e)}))},_setUpFilterListener:function(){return this.dGrid.on("dgrid-filter",s.hitch(this,function(e){this.emit("filter",e)}))},_setUpEditorShowListener:function(){return this.dGrid.on("dgrid-editor-show",s.hitch(this,function(e){this.emit("editor-show",e)}))},_setUpEditorHideListener:function(){return this.dGrid.on("dgrid-editor-hide",s.hitch(this,function(e){this.emit("editor-hide",e)}))},_setUpLayerClickListener:function(){return d(this.layer,"click",s.hitch(this,function(e){this.emit("layer-click",e)}))},_setUpLayerSelectionCompleteListener:function(){return d(this.layer,"selection-complete",s.hitch(this,function(e){this.emit("layer-selection-complete",e)}))},_setUpLayerSelectionClearListener:function(){return d(this.layer,"selection-clear",s.hitch(this,function(e){this.emit("layer-selection-clear",e)}))},_setUpLayerUpdateEndListener:function(){return d(this.layer,"update-end",s.hitch(this,function(e){this.emit("layer-update-end",e)}))}});return r("extend-esri")&&s.setObject("dijit.Grid",B,e),B});