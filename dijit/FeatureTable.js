// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["../kernel","../lang","./FeatureTable/Grid","./FeatureTable/storeUtils","./FeatureTable/dataUtils","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/aspect","dojo/debounce","dojo/has","dojo/on","dojo/string","dojo/promise/all","dojo/Deferred","dojo/Evented","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/fx","dojo/text!../dijit/FeatureTable/templates/FeatureTable.html","dojo/i18n!../nls/jsapi","dijit/_WidgetBase","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/a11yclick","dijit/Menu","dijit/MenuItem","dgrid/util/misc","dijit/layout/BorderContainer","dijit/layout/TabContainer","dijit/layout/ContentPane","dojo/query!css2","dojo/domReady!"],function(e,t,i,s,r,n,o,a,d,l,h,u,c,f,m,g,p,y,_,w,I,F,b,C,R,S,v,M,D,P,G,E,T){var H=p([b,C,R,S,g],{declaredClass:"esri.dijit.FeatureTable.Grid",baseClass:"esri-feature-table",templateString:I,featureLayer:null,map:null,fieldInfos:null,gridOptions:null,dateOptions:null,editable:!1,editOn:null,hiddenFields:null,outFields:null,menuFunctions:null,columnMenuFunctions:null,batchCount:50,syncSelection:!1,zoomToSelection:!1,showDataTypes:!1,showGridHeader:!0,showGridMenu:!0,showFeatureCount:!0,showColumnHeaderTooltips:!1,showAttachments:!1,showStatistics:!0,showRelatedRecords:!1,showCyclicalRelationships:!1,filterIds:null,showFieldDetails:!1,showColumnHiderButton:!1,showDefaultSortMenuItem:!0,showExpressionFields:!1,loaded:!1,grid:null,layerInfo:null,dataStore:null,columns:null,featureCount:0,idProperty:"id",gridMenu:null,gridMenuAnchor:null,selectedRows:null,selectedRowIds:null,css:{button:"esri-feature-table-button",hidden:"esri-feature-table-hidden",select:"esri-feature-table-select",borderContainer:"esri-feature-table-border-container",contentPane:"esri-feature-table-content-pane",grid:"esri-feature-table-grid",title:"esri-feature-table-title",loadingIndicator:"esri-feature-table-loading-indicator",menu:"esri-feature-table-menu",menuItem:"esri-feature-table-menu-item",menuOptions:"esri-feature-table-menu-options",columnHeader:"esri-feature-table-column-header",columnHeaderTitle:"esri-feature-table-column-header-title",columnHeaderType:"esri-feature-table-column-header-type",columnHeaderClear:"esri-feature-table-column-header-clear",columnMenu:"esri-feature-table-column-menu",sortAscendingIcon:"esri-icon-ascending icon-ui-ascending",sortDescendingIcon:"esri-icon-descending icon-ui-descending",filterIcon:"esri-icon-filter icon-ui-filter",propertiesIcon:"esri-icon-properties icon-ui-properties",statisticsIcon:"esri-icon-statistics icon-ui-statistics",settingsIcon:"esri-icon-settings icon-ui-settings",lockedIcon:"esri-icon-locked icon-ui-locked",lockedIconContainer:"esri-locked-icon-container",downIcon:"esri-icon-down icon-ui-down",menuIcon:"esri-icon-menu icon-ui-menu",closeIcon:"esri-icon-close icon-ui-close",optionsMenu:"esri-feature-table-options-menu-container",relatedRecordsCell:"esri-feature-table-related-records-cell",relatedRecordsTitle:"esri-feature-table-related-records-title",relatedRecordsLink:"esri-related-records-link",attachmentsCell:"esri-feature-table-attachments-cell",attachmentsTitle:"esri-feature-table-attachments-title",attachmentsLink:"esri-attachments-link",expressionsTitle:"esri-feature-table-expressions-title",dialog:"esri-feature-table-dialog",closeButton:"esri-dialog-close-button dijitButton",statisticsTableContainer:"esri-feature-table-statistics",statisticsHeader:"esri-statistics-header",statisticsBreak:"esri-break",statisticsHorizontalBreak:"esri-horizontal-break",statisticsAttrTable:"esri-attribute-table",statisticsAttrName:"esri-attribute-name",statisticsAttrValue:"esri-attribute-value",leftMargin:"esri-feature-table-left-margin",dateValue:"esri-date-value"},_i18nStrings:F.widgets.FeatureTable,_layerInfos:null,_fieldInfos:null,_cachedIds:null,_defaultBatchCount:50,_defaultFeatureCount:2e3,_defaultDateOptions:{timeEnabled:!0,dateEnabled:!0,timePattern:null,datePattern:null},_defaultGridOptions:{allowSelectAll:!1,cellNavigation:!0,selectionMode:"extended",pagination:!1,allowTextSelection:!1,pageSizeOptions:[10,25,50],columnHider:!0,columnResizer:!0,pagingDelay:300,keepScrollPosition:!0,queryRowsOverlap:0,sort:{field:"id",descending:!1}},_defaultSort:null,_defaultEditOn:"dblclick, keypress",_orderByFields:null,_showRelatedRecords:!1,_showAttachments:!1,_rollbackInfos:null,_statisticsDialog:null,_attachmentsDialog:null,_columnRules:null,_relatedGridInfos:null,_popupDateFormats:{shortDate:{datePattern:"M/d/y"},shortDateLE:{datePattern:"d/M/y"},longMonthDayYear:{datePattern:"MMMM d, y"},dayShortMonthYear:{datePattern:"d MMM y"},longDate:{datePattern:"EEEE, MMMM d, y",selector:"date"},shortDateShortTime:{datePattern:"M/d/y",timePattern:"h:mm a",timeEnabled:!0},shortDateLEShortTime:{datePattern:"d/M/y",timePattern:"h:mm a",timeEnabled:!0},shortDateShortTime24:{datePattern:"M/d/y",timePattern:"H:mm",timeEnabled:!0},shortDateLEShortTime24:{datePattern:"d/M/y",timePattern:"H:mm",timeEnabled:!0},shortDateLongTime:{datePattern:"M/d/y",timePattern:"h:mm:ss a",timeEnabled:!0},shortDateLELongTime:{datePattern:"d/M/y",timePattern:"h:mm:ss a",timeEnabled:!0},shortDateLongTime24:{datePattern:"M/d/y",timePattern:"H:mm:ss",timeEnabled:!0},shortDateLELongTime24:{datePattern:"d/M/y",timePattern:"H:mm:ss",timeEnabled:!0},longMonthYear:{datePattern:"MMMM y"},shortMonthYear:{datePattern:"MMM y"},year:{datePattern:"y"}},constructor:function(e,t){t&&(this._rowSelectHandler=l(this._rowSelectHandler,0),this._rowDeselectHandler=l(this._rowDeselectHandler,0),this._refreshHandler=l(this._refreshHandler,0))},postMixInProperties:function(){this.inherited(arguments),this.set({columns:[],layerInfo:{},selectedRows:[],selectedRowIds:[],hiddenFields:this.hiddenFields||[],outFields:this.outFields||["*"],fieldInfos:this.fieldInfos||[],menuFunctions:this.menuFunctions||[],columnMenuFunctions:this.columnMenuFunctions||[],gridOptions:y.mixin({},this._defaultGridOptions,this.gridOptions),dateOptions:y.mixin({},this._defaultDateOptions,this.dateOptions),_fieldInfos:[],_cachedIds:[],_columnRules:{},_relatedGridInfos:[]}),h("touch")&&!this.editOn?this.set("editOn",v):this.editOn||this.set("editOn",this._defaultEditOn),this.filterIds&&0===this.filterIds.length&&(this.filterIds=null),this._noDataMessage=this.gridOptions.noDataMessage||this._i18nStrings.noData},startup:function(){this.inherited(arguments);var e=this.featureLayer;return e&&e.loadError?void this._showLoadError():void(this.domNode&&e.loaded?this._setUpDataForMainGrid():this.own(u(e,"load",y.hitch(this,function(){this._setUpDataForMainGrid()})),u(e,"error",y.hitch(this,function(){e.loaded||this._showLoadError()}))))},destroy:function(){this.inherited(arguments),this._statisticsDialog&&this._statisticsDialog.destroy(),this._attachmentsDialog&&this._attachmentsDialog.destroy(),this._grid&&this._grid._destroyColumns()},refresh:function(e){var t,i=e||this._grid,s=this._relatedGridInfos,r=s.length;return i===this._grid&&r>0&&_.forEach(s,function(e,i){t=s[r-1-i],t&&t.grid&&this._removeGrid(t.grid)},this),this._refreshStore({grid:i}).then(function(){i.refresh()})},resize:function(e){this._gridBorderContainerNode&&this._gridBorderContainerNode.resize();var t=e&&e.resize?e:this._grid;t&&t.resize()},clearSelection:function(e){var t=e||this._grid;t&&t.clearSelection()},getRowDataById:function(e,t){var i=t||this._grid;return i?i.getRowDataById(e):void 0},filterSelectedRecords:function(e,t){var i=t||this._grid,s=i?i.selectedRowIds:[];i&&s&&s.length&&this.filterRecordsByIds(i.selectedRowIds)},filterRecordsByIds:function(e,t){var i,s=t||this._grid;s&&(this.filterIds=e,s.filterIds=e,this._refreshStore({grid:s}),i=e||[],this.emit("filter",{ids:i}))},clearFilter:function(e){var t=e||this._grid;t&&this.filterRecordsByIds(null,t)},getFeatureDataById:function(e){return e instanceof Array?r.queryLayerForFeature({layer:this.featureLayer,id:e}):r.queryLayerForFeatures({layer:this.featureLayer,ids:e})},selectRows:function(e,t,i){var s=i||this._grid;s&&s.selectRows(e,t)},sort:function(e,t,i){var s,n,o=i||this._grid;o&&e&&(s=r.getOrderByString(e,t),n=r.getColumnFromFieldName({fieldName:e,grid:o}),this._sortField(o,{field:e,descending:t,column:n,orderByFields:[s]}))},centerOnSelection:function(e){var t=e||this._grid;return t.centerOnSelection()},_setUpMainGrid:function(e){var t,i=e.layer,s=e.layerInfo,n=this._getCustomFieldInfos(i),o=this._getExpressionInfos(i);t=this._generateGrid({map:this.map,layer:i,layerInfo:s,idProperty:s.idProperty,customFieldInfos:n||this.fieldInfos,expressionInfos:o,defaultSort:this._defaultSort,outFields:this.outFields,hiddenFields:this.hiddenFields,filterIds:this.filterIds,gridOptions:this.gridOptions,dateOptions:this.dateOptions,batchCount:this.batchCount,editable:this.editable,editOn:this.editOn,css:this.css,showAttachments:this._showAttachments,showRelatedRecords:this._showRelatedRecords,showCyclicalRelationships:this.showCyclicalRelationships,showStatistics:this.showStatistics,showFieldDetails:this.showFieldDetails,showGridHeader:this.showGridHeader,showGridMenu:this.showGridMenu,showFeatureCount:this.showFeatureCount,showDataTypes:this.showDataTypes,showColumnHeaderTooltips:this.showColumnHeaderTooltips,showColumnHider:this.showColumnHiderButton,syncSelection:this.syncSelection,menuFunctions:this.menuFunctions,showDefaultSortMenuItem:this.showDefaultSortMenuItem,columnMenuFunctions:this.columnMenuFunctions,showFilterMenuItems:this.showFilterMenuItems,showExpressionFields:this.showExpressionFields,node:this._gridNode}),this.set({_grid:t,grid:t.dGrid,gridMenu:t.optionsMenu,gridMenuAnchor:t.optionsMenuAnchor}),this._wireUpGridEvents(t),t.showLoadingIndicator(),t.updateNoDataMessage(""),t.setHeaderTitle(this._i18nStrings.loadingData),t.resize(),this._setUpColumns({grid:t,layer:i}),r.queryLayerForCount({layer:i,layerInfo:s}).then(y.hitch(this,function(e){t.set("featureCount",e),t.updateHeaderText(),this._generateStore({grid:t,layer:i,layerInfo:s,count:e,filterIds:this.filterIds}).then(y.hitch(this,function(e){t.updateStore(e),t.updateNoDataMessage(this._noDataMessage),this.set({dataStore:e,layerInfo:y.clone(t.layerInfo)}),t.hideLoadingIndicator(),setTimeout(y.hitch(this,function(){this.resize()},200))}))})).otherwise(y.hitch(this,function(){this._showLoadError(),t.updateNoDataMessage(this._noDataMessage)}))},_generateGrid:function(e){var t=new i(e,e.node);return t.startup(),t},_setUpDataForMainGrid:function(){var e,t,i,s,n=this.featureLayer,o=n.objectIdField,a=this.gridOptions,d=this.outFields;this._generateLayerInfo({layer:n,idProperty:o}).then(y.hitch(this,function(l){l.hasRelatedRecords&&(this._showRelatedRecords=!!this.showRelatedRecords),l.hasAttachments&&(this._showAttachments=!!this.showAttachments),t=a.sort&&a.sort.field?r.findFirst(n.fields,"name",a.sort.field):null,e=t&&t.name?t.name:o,i=!(!a.sort||!a.sort.descending),s=r.getOrderByString(e,i),d=_.filter(d,function(e){return!!r.findFirst(n.fields,"name",e)},this),0===d.length&&d.push("*"),this.set({layerInfo:l,idProperty:o,_orderByFields:[s],_defaultSort:{attribute:e,descending:i}}),this._setUpMainGrid({layer:n,layerInfo:l})}))},_getCustomFieldInfos:function(e){var t=this._getPopupInfo(e),i=t&&t.fieldInfos?this._updatePopupInfosDateFormat(t.fieldInfos):null;return i},_getExpressionInfos:function(e){var t=this._getPopupInfo(e);return t&&t.expressionInfos?t.expressionInfos:null},_getPopupInfo:function(e){var t=isNaN(e.layerId)||null===e.layerId?null:e.layerId,i=this._layerInfos?this._layerInfos[t]:null;return i?i.popupInfo:null},_generateLayerInfo:function(e){var t=new m,i=e.layer,s=e.idProperty,r=i.id||i.layerId,n={idProperty:s,layerId:r,userIds:{}};return i.credential&&(n.userIds[r]=i.credential.userId),n.userId&&(n.userIds[r]=n.userId),n.isFeatureCollection=i._collection&&i._collection===!0||null===i.url&&null===i._url,n.typeIdField=i.typeIdField,n.types=i.types,n.editable=i.isEditable?i.isEditable():!!i.userIsAdmin||!1,n.editCapabilities=i.getEditCapabilities?i.getEditCapabilities():{},n.hasRelatedRecords=i.relationships&&i.relationships.length>0,n.supportsAdvancedQueryRelated=!(!i.advancedQueryCapabilities||!i.advancedQueryCapabilities.supportsAdvancedQueryRelated),n.hasAttachments=i.hasAttachments,n.queryAttachmentsSupported=!0,n=y.clone(n),t.resolve(n),t},_setUpColumns:function(e){var i,s,n,o,a=e.grid,d=e.layer,l=d.fields;if(i=d.getOutFields?d.getOutFields():["*"],s=i&&i[0]&&"*"===i[0]?l:_.filter(l,function(e){return-1!==_.indexOf(i,e.name)}),a===this._grid&&"*"!==this.outFields[0]&&(s=_.filter(s,y.hitch(this,function(e){return-1!==_.indexOf(this.outFields,e.name)}))),t.isDefined(d.objectIdField)&&!r.findFirst(s,"name",d.objectIdField)&&(n=r.findFirst(l,"name",d.objectIdField),s.unshift(n)),this.showExpressionFields){var h=this._getPopupInfo(d);if(h&&h.expressionInfos){var u=this._getCustomFieldInfos(d);_.forEach(u,function(e){var t=r.getExpressionInfo(h.expressionInfos,e.fieldName);t&&s.push({name:e.fieldName,alias:t.title,editable:!1,nullable:!1,type:t.returnType})})}}o=a._setUpColumns(s),a===this._grid&&this.set({columns:o.columns,_fieldInfos:o.fieldInfos})},_showLoadError:function(e){var t=e&&e.grid?e.grid:this._grid,i=e&&e.error?e.error:this._i18nStrings.dataError;t&&(t.hideLoadingIndicator(),t.setHeaderTitle(i)),this.emit("error",{message:i})},_wireUpGridEvents:function(e){e&&(e.on("load",y.hitch(this,function(t){e===this._grid&&this.set("loaded",t.loaded),this.emit("load",t.loaded)})),e.on("error",y.hitch(this,function(e){this.emit("error",e)})),e.on("row-select",y.hitch(this,this._rowSelectHandler,e)),e.on("row-deselect",y.hitch(this,this._rowDeselectHandler,e)),e.on("refresh",y.hitch(this,this._refreshHandler,e)),e.on("sort",y.hitch(this,this._sortField,e)),e.on("filter",y.hitch(this,function(e){this.emit("filter",e)})),e.on("column-resize",y.hitch(this,function(e){this.emit("column-resize",e)})),e.on("column-state-change",y.hitch(this,function(e){this.emit("column-state-change",e)})),e.on("editor-show",y.hitch(this,function(e){this.emit("editor-show",e)})),e.on("editor-hide",y.hitch(this,function(e){this.emit("editor-hide",e)})),e.on("data-change",y.hitch(this,function(e){this.emit("data-change",e)})),e.on("edits-complete",y.hitch(this,function(e){this.emit("edits-complete",e)})),e.on("layer-click",y.hitch(this,function(e){this.emit("layer-click",e)})),e.on("layer-selection-complete",y.hitch(this,function(t){e===this._grid&&this.syncSelection&&this._syncSelectionFromLayer({grid:e,features:t.features}),this.emit("layer-selection-complete",t)})),e.on("layer-selection-clear",y.hitch(this,function(t){e===this._grid&&this.syncSelection&&this.clearSelection(),this.emit("layer-selection-clear",t)})),e.on("layer-update-end",y.hitch(this,function(e){this.emit("layer-update-end",e)})),e.on("show-selected-records",y.hitch(this,function(t){this.emit("show-selected-records",{grid:e,ids:t.ids}),this.filterRecordsByIds(t.ids,e)})),e.on("clear-selection",y.hitch(this,function(){this.emit("clear-selection")})),e.on("clear-filter",y.hitch(this,this.clearFilter,e)),e.on("show-statistics",y.hitch(this,function(e){this._statisticsDialog=e.dialog,this.emit("show-statistics",{dialog:e.dialog,statistics:e.statistics})})),e.on("show-attachments",y.hitch(this,function(e){this._attachmentsDialog=e.dialog,this.emit("show-attachments",{featureId:e.featureId,dialog:e.dialog,attachments:e.attachments})})),e.on("show-related-records",y.hitch(this,this._showRelatedRecordsCallback,e)),e.on("show-detailed-field-view",y.hitch(this,this._showDetailedFieldViewCallback,e)))},_wireUpRelatedGridEvents:function(e){var t=e.grid,i=e.parentGrid;t.own(u(i,"row-select",this._updateRelatedGridsHandler.bind(this,e)))},_updateRelatedGridsHandler:function(e,t){var i,s,n,o,a,d,l,h,u,c,f,m=e.grid,g=e.parentGrid,p=e.relationship,w=this._relatedGridInfos,I=t.rows,F=I[0];F&&(d=parseInt(F.id,10),l=w[w.length-1],h=l?l.grid:null,h&&F.data&&(u=m===h,n=r.findFirst(m.layer.relationships,"id",p.id),c=r.findFirst(w,"grid",m),f=_.indexOf(w,c),s=g.relatedRecordCounts,i=s[p.id]&&s[p.id][d]&&!r.isValueEmpty(s[p.id][d].count)?s[p.id][d].count:r.isValueEmpty(F.data[n.keyField])?0:g._getRelatedRecordsCount({featureId:F.data[m.idProperty],relationshipId:n.id}),i>0?(u||_.forEach(w,function(e,t){e.grid&&t>=f&&(e.grid.emptyStore(),e.grid.set("featureCount",0),e.grid.updateHeaderText())}),o=p.keyField,"undefined"==typeof F.data[o]&&(o=g.layer.getField(o).name),a=F.data[o],r.getRelationshipWhereClause({layer:m.layer,originRelationship:p,destinationRelationship:n,keyValue:a}).then(y.hitch(this,function(e){m.set({where:e,featureCount:i}),m.updateHeaderText(),this._refreshStore({grid:m}).then(function(e){u||setTimeout(function(){if(m.store){var e,t,i=m.store.data;e=i?i[Object.keys(i)[0]]:null,e&&(t=e.attributes[m.idProperty],m.selectRows(t,!1))}},600)})}))):u?(m.emptyStore(),m.set("featureCount",0),m.updateHeaderText(),m.refresh()):(m.set("featureCount",0),m.updateHeaderText(),c=r.findFirst(w,"grid",m),f=_.indexOf(w,c),_.forEach(w,function(e,t){var i=e.grid;f>t||(i.emptyStore(),i.set("featureCount",0),i.updateHeaderText(),i.refresh())}))))},_generateStore:function(e){var t=e.grid,i=e.layer,s=e.layerInfo,r=e.store||t.store||null,n=e.where||null,o=e.orderByFields||null,a=e.count||null,d=e.filterIds||null;return r&&t.emptyStore(),s.isFeatureCollection?this._generateStoreForFeatureCollection({grid:t,layer:i,layerInfo:s}):i.advancedQueryCapabilities&&!i.advancedQueryCapabilities.supportsPagination?this._generateStoreForNonPaginatedLayer({grid:t,layer:i,layerInfo:s,where:n,orderByFields:o,count:a,filterIds:d}):this._generateCacheStore({grid:t,where:n,orderByFields:o,count:a,ids:d})},_generateCacheStore:function(e){var i,n,o,a,l,h,u=new m,c=e.grid,f=e.ids,g=e.where,p=e.orderByFields,y=e.count;return i=p?p:c===this._grid?this._orderByFields&&this._orderByFields.length?this._orderByFields:[r.getOrderByString(this._defaultSort.attribute,this._defaultSort.descending)]:null,n=t.isDefined(c.layer.maxRecordCount)?c.layer.maxRecordCount:this._defaultBatchCount,o=Math.min(n,this.batchCount),l=this.showAttachments&&c.layerInfo.hasAttachments,h=this.showRelatedRecords&&c.layerInfo.hasRelatedRecords,a=s.generateCacheStore({grid:c,layer:c.layer,ids:f,where:g,orderByFields:i,count:y,getAttachments:l,getRelatedRecords:h}),d.before(a,"query",function(e,t){c.showLoadingIndicator()}),d.after(a,"query",function(e){return e.then(function(e){e.attachmentInfos?c._updateAttachmentInfos(e.attachmentInfos):c.layerInfo.queryAttachmentsSupported=!1,e.relatedRecordInfos&&(c.layerInfo.supportsAdvancedQueryRelated?c._updateRelatedRecordCounts(e.relatedRecordInfos):c._updateRelatedRecordInfos(e.relatedRecordInfos)),c.hideLoadingIndicator()}).otherwise(function(){c.hideLoadingIndicator()}),e}),u.resolve(a),u},_generateMemoryStore:function(e){var t=e.grid,i=e.features,r=new m,n=s.generateMemoryStore({features:i,idProperty:this.get("idProperty")});return n.query=y.hitch(this,s.generateSort,t.dGrid,n),r.resolve(n),r},_generateStoreForFeatureCollection:function(e){var t=e.grid,i=e.layer;return this._generateMemoryStore({grid:t,features:i.graphics})},_generateStoreForNonPaginatedLayer:function(e){var t=e.grid,i=e.layer,s=e.layerInfo,n=e.where||null,o=e.orderByFields||null,a=e.filterIds||null;return a&&a.length?this._generateCacheStore({grid:t,ids:a,where:n,orderByFields:o}):r.queryLayerForIds({layer:i,idProperty:s.idProperty,where:n}).then(y.hitch(this,function(e){return s._cachedIds=e,t.layerInfo.cachedIds=e,this._generateCacheStore({grid:t,ids:e,where:n,orderByFields:o})})).otherwise(y.hitch(this,function(){this._showLoadError()}))},_refreshStore:function(e){var t=e.grid,i=t.filterIds,s=e.where||t.where||null,n=e.orderByFields,o=t.layer,a=t.layerInfo;return t.showLoadingIndicator(),t.updateNoDataMessage(""),t.setHeaderTitle(this._i18nStrings.loadingData),r.queryLayerForCount({layer:o,layerInfo:a,where:s}).then(y.hitch(this,function(e){return t.set("featureCount",e),t.updateHeaderText(),this._generateStore({grid:t,layer:o,layerInfo:a,orderByFields:n,where:s,count:e,filterIds:i}).then(y.hitch(this,function(e){return t===this._grid&&this.set("dataStore",e),t.updateStore(e),t.hideLoadingIndicator(),e}))})).otherwise(y.hitch(this,function(){return this._showLoadError(),t.updateNoDataMessage(this._noDataMessage),null}))},_setEditableAttr:function(e){this._grid&&this._grid.set("editable",!!e),_.forEach(this._relatedGridInfos,function(t){t.grid.set("editable",!!e)})},_sortField:function(e,t){var i=t.column,s=parseInt(t.id,10),r=t.field,n=t.descending,o=t.orderByFields;e===this._grid&&(this._orderByFields=o),e.emptyStore(),i?e.updateSort([{attribute:r,columnId:s,fieldType:i.type,descending:n}]):e.updateSort([{attribute:r,descending:n}]),this._refreshStore({grid:e,orderByFields:o}).then(y.hitch(this,function(){this.emit("sort",{field:r,descending:n})}))},_rowSelectHandler:function(e,t){this.syncSelection&&this._syncSelectionFromGrid({grid:e,ids:e.selectedRowIds}),e===this._grid&&(this.set({selectedRows:e.selectedRows,selectedRowIds:e.selectedRowIds}),this.emit("row-select",t))},_rowDeselectHandler:function(e,t){var i=e.selectedRows;this.syncSelection&&(i.length>0?this._syncSelectionFromGrid({grid:e,ids:e.selectedRowIds}):e.layer.clearSelection(!0)),e===this._grid&&(this.set({selectedRows:i,selectedRowIds:e.selectedRowIds}),this.emit("row-deselect",t))},_refreshHandler:function(e,t){e===this._grid&&this.emit("refresh",t)},_syncSelectionFromLayer:function(e){var t,i,s=e.grid||this._grid,n=e.features||[],o=s.idProperty;return 0===n.length?void this.clearSelection():(t=_.map(n,function(e){return e.attributes[o]}),void(r.compareIntArrays(t,this.selectedRowIds)||(this.map&&this.zoomToSelection&&n.length>0&&(i=r.calculateExtentFromFeatures(n),this.map.setExtent(i)),this.selectRows(t,!0))))},_syncSelectionFromGrid:function(e){var t,i,s=e.grid||this._grid,n=s.layer,o=e.ids,a=n.getSelectedFeatures(),d=s.idProperty;t=_.map(a,function(e){return e.attributes[d]}),r.compareIntArrays(o,t)||r.queryLayerForFeatures({grid:s,layer:n,ids:o}).then(y.hitch(this,function(e){if(e&&e.features){var t=e.features;t.length&&(this.map&&this.zoomToSelection&&(i=r.calculateExtentFromFeatures(t),this.map.setExtent(i)),r.selectFeaturesById({grid:s,ids:o}))}}))},_showRelatedRecordsCallback:function(e,t){var i,s,n,o,a=t.columnId,d=t.relationship,l=t.keyFieldValue,h=t.row,u=t.count,c=[];e===this._grid?(n=this._centerPaneNode,o=this._leadingPaneNode):(s=this._relatedGridInfos.length-1,i=this._relatedGridInfos[s],n=i.layout.centerContentPane,o=i.layout.leadingContentPane,this._removeButtonNode(i.closeButton),i.closeButton=null),this._addSmallRelatedRecordsColumn({grid:e,relationship:d}),e.refresh(),e.showFieldDetails=!1,e.showFeatureCount=!1,e.updateHeaderText(),e.hideOptionsMenu(),c=[this._shrinkGrid({grid:e,centerPane:n,leadingPane:o,columnId:a}),this._setUpDataForRelatedGrid({parentGrid:e,relationship:d})],f(c).then(y.hitch(this,function(t){var i,s,o=t[1].layer,c=o.objectIdField,f=n;this._addHiddenColumnRules({grid:e,columnId:a}),e.updateSelectionMode("single"),e.refresh(),e.selectRows(h[e.idProperty],!0,!0),this._showPane(f),s=this._generateSubLayout(f.domNode),this.resize(),this._generateLayerInfo({layer:o,idProperty:c}).then(y.hitch(this,function(t){this.emit("show-related-records",{grid:e,relationship:d,row:h}),setTimeout(function(){e._scrollToRow(h[e.idProperty])},200),i=r.findFirst(o.relationships,"id",d.id),r.getRelationshipWhereClause({layer:o,originRelationship:d,destinationRelationship:i,keyValue:l}).then(y.hitch(this,function(i){this._setUpRelatedGrid({parentGrid:e,layer:o,layerInfo:t,relationship:d,where:i,layout:s,count:u})}))}))}))},_setUpDataForRelatedGrid:function(e){var t=e.parentGrid,i=t.layer,s=e.relationship,r=s.relatedTableId;return this._setUpRelatedLayer({baseLayer:i,layerId:r}).then(function(e){return{layer:e,layerId:r}})},_generateSubLayout:function(e){var t,i,s,r,n=this.css,a=n.borderContainer+" "+n.leftMargin,d=n.contentPane+" "+n.hidden;return t=new G({className:a,gutters:!1,design:"headline"}),i=new T({className:n.contentPane,region:"leading"}),s=new T({className:d,region:"center"}),r=o.create("div",null,i.domNode),t.addChild(i),t.addChild(s),t.placeAt(e),t.startup(),{borderContainer:t,leadingContentPane:i,centerContentPane:s,containerNode:r}},_setUpRelatedGrid:function(e){var t,i,s,n,o,a,d,l,h=this,u=e.layer,c=e.layerInfo,f=c.idProperty,m=e.parentGrid,g=e.relationship,p=e.layout,w=e.where||null,I=e.count||null;return n=_.map(this._relatedGridInfos,function(e){return e.grid.layer.layerId}),n.unshift(this._grid.layer.layerId),s=[{label:this._i18nStrings.close,callback:function(){h._removeGrid(this)}}],t=this._getCustomFieldInfos(u),i=!(!this.showAttachments||!c.hasAttachments),o=this._generateGrid({map:this.map,layer:u,layerInfo:c,idProperty:f,customFieldInfos:t,expressionInfos:this._getExpressionInfos(u),defaultSort:{attribute:f,descending:!1},outFields:["*"],where:w,gridOptions:this.gridOptions,dateOptions:this.dateOptions,batchCount:this.batchCount,editable:this.editable,editOn:this.editOn,css:this.css,showAttachments:i,showRelatedRecords:!0,showCyclicalRelationships:this.showCyclicalRelationships,showStatistics:this.showStatistics,showFieldDetails:!1,showGridHeader:this.showGridHeader,showGridMenu:this.showGridMenu,showFeatureCount:this.showFeatureCount,showDataTypes:this.showDataTypes,showColumnHeaderTooltips:this.showColumnHeaderTooltips,showColumnHider:this.showColumnHiderButton,menuFunctions:s,showFilterMenuItems:!1,showDefaultSortMenuItem:this.showDefaultSortMenuItem,syncSelection:!1,showExpressionFields:this.showExpressionFields,visibleLayerIds:n,node:p.containerNode}),this._wireUpGridEvents(o),this._wireUpRelatedGridEvents({grid:o,parentGrid:m,relationship:g}),o.showLoadingIndicator(),o.updateNoDataMessage(""),o.setHeaderTitle(this._i18nStrings.loadingData),o.resize(),d=this._generateColumnSwitcherButton(m),l=this._generateGridCloseButton(o),this._relatedGridInfos.push({grid:o,parentGrid:m,layout:p,relationship:g,pickerButton:d,closeButton:l}),this._setUpColumns({grid:o,layer:u}),r.isValueEmpty(I)?r.queryLayerForCount({layer:u,layerInfo:c}).then(y.hitch(this,function(e){o.set("featureCount",e),o.updateHeaderText(),this._generateStore({grid:o,layer:u,layout:p,layerInfo:c,where:w,count:e,filterIds:a}).then(y.hitch(this,function(e){o.updateStore(e),o.updateNoDataMessage(this._noDataMessage),o.hideLoadingIndicator()}))})).otherwise(y.hitch(this,function(){this._showLoadError(),o.updateNoDataMessage(this._noDataMessage)})):(o.set("featureCount",I),o.updateHeaderText(),this._generateStore({grid:o,layer:u,layout:p,layerInfo:c,where:w,count:I,filterIds:a}).then(y.hitch(this,function(e){o.updateStore(e),o.updateNoDataMessage(this._noDataMessage),o.hideLoadingIndicator()})).otherwise(y.hitch(this,function(){this._showLoadError(),o.updateNoDataMessage(this._noDataMessage)})),void 0)},_setUpRelatedLayer:function(e){var t=new m,i=e.baseLayer,s=e.layerId,n=r.initFeatureLayer(i,s);return n.loaded?t.resolve(n):u(n,"load",function(){t.resolve(n)}),t},_showPane:function(e){e&&e.domNode&&n.remove(e.domNode,this.css.hidden)},_hidePane:function(e){e&&e.domNode&&n.add(e.domNode,this.css.hidden)},_shrinkGrid:function(e){var t,i=new m,s=e.grid,r=e.leadingPane,n=e.finalWidth||220;return t=w.animateProperty({node:r.id,properties:{width:{start:function(){return r.domNode.getBoundingClientRect().width},end:function(){return n}}}}).play(),u(t,"End",function(){i.resolve(s)}),i},_growGrid:function(e){var t,i,s,r,n=e.grid;this._removeSmallRelatedRecordsColumn(n),this._removeHiddenColumnRules(n),n.showColumnHider&&n.showColumnHiderButton(),n===this._grid?(s=this._centerPaneNode,r=this._leadingPaneNode,n.showFieldDetails=this.showFieldDetails,this.emit("hide-related-records")):(t=this._relatedGridInfos.length-1,i=this._relatedGridInfos[t],s=i.layout.centerContentPane,r=i.layout.leadingContentPane,i.closeButton=this._generateGridCloseButton(n)),this._hidePane(s),r.domNode&&a.set(r.domNode,"width","100%"),n.updateSelectionMode(this.gridOptions.selectionMode),n.showFeatureCount=this.showFeatureCount,n.updateHeaderText(),this.showGridMenu&&n.showOptionsMenu(),n.resize(),this.resize()},_removeGrid:function(e){if(e!==this._grid){var t=r.findFirst(this._relatedGridInfos,"grid",e),i=t.parentGrid,s=t.layout.borderContainer,n=t.layout.leadingContentPane,o=t.layout.centerContentPane;this._hidePane(o),n.domNode&&a.set(n.domNode,"width","100%"),this._removeButtonNode(t.pickerButton),this._relatedGridInfos.pop(),e.destroy(),s.destroy(),this._growGrid({grid:i})}},_addHiddenColumnRules:function(e){var t,i=e.grid,s=e.columnId,r=i.getColumns(),n=Object.keys(r),o=[];o=_.map(n,function(e,r){return t=r===s?"display: table-cell;":"display: none;",i.styleColumn(e,t)}),this._columnRules[i.id]=o},_removeHiddenColumnRules:function(e){var t=this._columnRules[e.id];_.forEach(t,function(e){e.remove()}),this._columnRules[e.id]=[]},_addSmallRelatedRecordsColumn:function(e){var t=e.grid,i=e.relationship,s=i.id,r=t.columns,n=t.idProperty;r.push({unhidable:!0,label:"esriRelatedRecordsSmall",field:"esriRelatedRecordsSmall",get:function(e){var i=t._getRelatedRecordsCount({featureId:e[n],relationshipId:s});return c.substitute(t._i18nStrings.parenValue,{value:i})}})},_removeSmallRelatedRecordsColumn:function(e){var t=e.columns,i=t&&t[t.length-1]?t[t.length-1].field:null;"esriRelatedRecordsSmall"===i&&(t.pop(),e.refresh())},_generateGridCloseButton:function(e){var t,i=this.css,s=i.menuItem+" "+i.button+" "+i.closeIcon;return t=o.create("div",{className:s,tabIndex:0}),o.place(t,e._menuNode,"before"),u(t,v,y.hitch(this,function(){this._removeGrid(e)})),t},_generateColumnSwitcherButton:function(e){var t,i=e._gridHeaderNode.domNode,s=this._generateColumnSwitcherMenu(e),r=this.css,n=this._i18nStrings,a=r.menuItem+" "+r.button+" "+r.menuIcon;return t=o.create("div",{title:n.columnSelectionMenu,"aria-label":n.columnSelectionMenu,className:a,tabIndex:0},i),u(t,[v,"keydown"],y.hitch(this,function(e){var i=t.getBoundingClientRect(),r=i.top+i.height,n=this.isLeftToRight()?i.right-i.width:i.right;s._openMyself({target:e.target,delegatedTarget:t,iframe:null,coords:{x:n,y:r}})})),t},_generateColumnSwitcherMenu:function(e){var t,i,s=e.fieldInfos,n=this.css;return t=new M({className:n.optionsMenu}),_.forEach(e.columns,function(o){var a=parseInt(o.id,10),d=r.findFirst(s,"name",o.field),l="esriRelatedRecords"===o.type||"esriRelatedRecordsSmall"===o.field||"esriAttachments"===o.type||"esriFieldTypeGUID"===d.type||"esriFieldTypeGlobalID"===d.type||-1!==_.indexOf(e._unsupportedFieldTypes,d.type)||!!o.hidden;l||(i=new D({label:o.label||o.field,baseClass:n.menuItem,tabIndex:1}),u(i,v,y.hitch(this,function(){this._removeHiddenColumnRules(e),this._addHiddenColumnRules({grid:e,columnId:a}),this.emit("column-focus-change",{fieldInfo:d,column:o})})),t.addChild(i))},this),t.startup(),t},_removeButtonNode:function(e){e&&e&&e.parentNode&&e.parentNode.removeChild(e)},_showDetailedFieldViewCallback:function(e,t){var i,s=t.columnId,r=t.fieldInfo,n=this._centerPaneNode,o=this._leadingPaneNode,a=o.domNode.getBoundingClientRect().width/6;e.showFeatureCount=!1,e.showFieldDetails=!1,e.updateHeaderText(),e.hideOptionsMenu(),this._shrinkGrid({grid:e,centerPane:n,leadingPane:o,columnId:s,finalWidth:a}).then(y.hitch(this,function(){i=this._generateColumnSwitcherButton(e),this._addHiddenColumnRules({grid:e,columnId:s}),e.updateSelectionMode("single"),e.refresh(),this.resize(),this.emit("show-detailed-field-view",{columnId:s,grid:e,fieldInfo:r,pickerButton:i})}))},_updatePopupInfosDateFormat:function(e){return _.forEach(e,function(e){e.format&&e.format.dateFormat&&(e.format.dateFormat=this._popupDateFormats[e.format.dateFormat])},this),e}});return h("extend-esri")&&y.setObject("dijit.FeatureTable",H,e),H});