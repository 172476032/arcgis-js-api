// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.17/esri/copyright.txt for details.

define(["dojo/aspect","dojo/on","dojo/Deferred","dojo/DeferredList","dojo/promise/all","dojo/Evented","dojo/has","dojo/date/locale","dojo/query","dojo/io-query","dojo/number","dojo/string","dojo/dom-construct","dojo/dom-class","dojo/dom-style","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/text!../dijit/FeatureTable/templates/FeatureTable.html","dojo/i18n!../nls/jsapi","dojo/store/Cache","dojo/store/Memory","dojo/store/Observable","dojo/store/util/QueryResults","dijit/_WidgetBase","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/a11yclick","dijit/Dialog","dijit/Menu","dijit/MenuItem","dijit/Tooltip","dijit/focus","dijit/form/DropDownButton","dijit/form/TimeTextBox","dijit/form/DateTextBox","dijit/form/NumberTextBox","dijit/form/Button","dijit/form/Select","dgrid/OnDemandGrid","dgrid/Selection","dgrid/selector","dgrid/Keyboard","dgrid/editor","dgrid/extensions/Pagination","dgrid/extensions/DijitRegistry","dgrid/extensions/ColumnHider","dgrid/extensions/ColumnResizer","../kernel","../lang","../config","../request","../numberUtils","../geometry/Extent","../layers/FeatureLayer","../tasks/query","../tasks/StatisticDefinition","../tasks/QueryTask","../tasks/RelationshipQuery","../dijit/FeatureLayerQueryStore","dijit/layout/BorderContainer","dijit/layout/TabContainer","dijit/layout/ContentPane","dojo/query!css2","dojo/domReady!"],function(e,t,i,n,s,r,a,o,d,l,h,u,c,f,m,g,p,_,y,b,v,I,C,w,S,F,T,L,D,R,O,E,H,M,x,N,P,A,k,j,G,V,B,q,z,Q,U,W,K,X,Y,J,Z,$,et,tt,it,nt,st,rt,at,ot,dt,lt){var ht=g([S,F,T,L,r],{baseClass:"esri-feature-table",loaded:!1,templateString:y,i18n:b,dataStore:null,columns:null,featureCount:0,idProperty:"id",grid:null,gridMenu:null,gridMenuAnchor:null,css:{featureTableColumnHeader:"esri-feature-table-column-header",featureTableColumnHeaderTitle:"esri-feature-table-column-header-title",featureTableColumnHeaderType:"esri-feature-table-column-header-type",featureTableColumnHeaderClear:"esri-feature-table-column-header-clear",headerGear:"esri-feature-table-gear",settingsIcon:"esri-icon-settings",lockedIcon:"esri-icon-locked",optionsMenu:"esri-feature-table-options-menu-container",menuItem:"esri-feature-table-menu-item",dialog:"esri-feature-table-dialog",embeddedTitle:"esri-embedded-grid-title",relatedRecordsCell:"esri-feature-table-related-records-cell",relatedRecordsTitle:"esri-feature-table-related-records-title",relatedRecordsLink:"esri-related-records-link",attachmentsCell:"esri-feature-table-attachments-cell",attachmentsTitle:"esri-feature-table-attachments-title",attachmentsLink:"esri-attachments-link",attachmentsContainer:"esri-attachments-container",attachmentsTabContainer:"esri-attachments-tab-container",attachmentsIcon:"esri-attachments-icon",attachmentsSize:"esri-attachments-size",attachmentsNode:"esri-attachments-node",attachmentsNodeIcon:"esri-attachments-node-icon",attachmentsNodeIconArchive:"esri-attachments-node-icon-archive",attachmentsNodeIconAudioVideo:"esri-attachments-node-icon-audiovideo",attachmentsNodeIconDocument:"esri-attachments-node-icon-document",attachmentsNodeIconImage:"esri-attachments-node-icon-image",attachmentsNodeIconOther:"esri-attachments-node-icon-other",attachmentsNodeTextContainer:"esri-attachments-node-text-container",attachmentsNodeTextName:"esri-attachments-node-text-name",attachmentsNodeTextSize:"esri-attachments-node-text-size",attachmentsNodeDelete:"esri-attachments-node-delete",attachementsViewPane:"esri-attachments-view-pane",attachementsViewPaneContent:"esri-attachments-view-pane-content",attachementsAddPane:"esri-attachments-add-pane",attachementsAddPaneContent:"esri-attachments-add-pane-content",attachmentsFeedbackText:"esri-attachments-feedback-text"},featureLayer:null,map:null,layerInfo:null,fieldInfos:null,gridOptions:null,dateOptions:null,selectedRows:null,selectedRowIds:null,hiddenFields:null,outFields:null,editable:!1,syncSelection:!0,zoomToSelection:!0,showDataTypes:!1,showGridHeader:!0,showGridMenu:!0,showFeatureCount:!0,showColumnHeaderTooltips:!1,showRelatedRecords:!1,showAttachments:!1,showStatistics:!0,menuFunctions:null,batchCount:50,showFieldDetails:!1,visibleLayerIds:null,showCyclicalRelationships:!1,filterIds:null,editOn:null,_defaultDateOptions:{timeEnabled:!1,timePattern:null,datePattern:null},_defaultGridOptions:{allowSelectAll:!1,cellNavigation:!0,selectionMode:"extended",pagination:!1,allowTextSelection:!1,pageSizeOptions:[10,25,50],columnHider:!0,columnResizer:!0,pagingDelay:300},_defaultSortField:null,_defaultEditOn:"dblclick, keypress",_queryStore:null,_memoryStore:null,_featureSet:null,_orderByFields:null,_supportRelatedRecords:!1,_supportAttachments:!1,_editorTrackingInfos:null,_userIds:null,_featureSelectedCount:0,_filteredRowIds:null,_gridQuery:!1,_activeEditors:null,_rollbackInfos:null,_defaultBatchCount:2e3,_defaultFeatureCount:2e3,_expandedNodes:null,_nestedGrids:null,_i18nStrings:b.widgets.FeatureTable,_numericFieldTypes:["esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeSmallInteger"],_unsupportedFieldTypes:["esriFieldTypeGUID","esriFieldTypeRaster","esriFieldTypeBlob","esriFieldTypeGeometry","esriFieldTypeXML"],_attachmentInfos:null,_relatedRecordInfos:null,_supportedAttachmentTypes:[["zip","7z","gz","gtar","tar","tgz"],["wmf","wps","avi","mpg","mpe","mpeg","mov","wmv","aif","mid","rmi","mp2","mp3","mp4","mpa","mpv2","qt","ra","ram","wav","wma"],["doc","docx","dot","xls","xlsx","xlt","pdf","ppt","pptx","txt"],["bmp","ecw","emf","eps","ps","gif","img","jp2","jpc","j2k","jpf","jpg","jpeg","jpe","png","psd","raw","sid","tif","tiff"],["vrml","gml","json","xml","mdb","gdb","geodatabase"]],_statisticsDialog:null,_numRelationshipColumns:5,constructor:function(e,t){},postMixInProperties:function(){this.inherited(arguments),this.set({columns:[],layerInfo:{idArray:[],fieldInfos:[]},selectedRows:[],selectedRowIds:[],_editorTrackingInfos:{},_userIds:{},_filteredRowIds:[],_activeEditors:[],_rollbackInfos:[],_expandedNodes:[],_nestedGrids:[],_attachmentInfos:{},_relatedRecordInfos:{},hiddenFields:this.hiddenFields||[],outFields:this.outFields||["*"],fieldInfos:this.fieldInfos||[],menuFunctions:this.menuFunctions||[],gridOptions:p.mixin({},this._defaultGridOptions,this.gridOptions),dateOptions:p.mixin({},this._defaultDateOptions,this.dateOptions)}),this._GridDefinition=this._generateGridDefinition(),this._noDataMessage=this.gridOptions.noDataMessage||this._i18nStrings.noData,a("touch")&&!this.editOn?this.set("editOn",D):this.editOn||this.set("editOn",this._defaultEditOn)},postCreate:function(){this.inherited(arguments)},startup:function(){this.inherited(arguments);var e=this.get("featureLayer");return e&&e.loadError?void this._showLoadError():void(this.domNode&&e.loaded?this._init():this.own(t(e,"load",p.hitch(this,function(){this._init()})),t(e,"error",p.hitch(this,function(){e.loadError,this._showLoadError()}))))},refresh:function(){this.grid.refresh()},destroy:function(){this.inherited(arguments),this.gridMenu&&this.gridMenu.destroy(),this._statisticsDialog&&this._statisticsDialog.destroy(),this.columnMenu&&this.columnMenu.destroyRecursive(),this.grid&&this.grid._destroyColumns(),delete this.columns,delete this.layerInfo},resize:function(){this._resize()},selectRows:function(e,t){var i,n,s,r,a=[],o=[];this._closeEditors(),this.grid.clearSelection(),e[0]&&"esri.Graphic"===e[0].declaredClass&&(a=_.map(e,function(e){return e.attributes[this.idProperty]},this),e=a),1===e.length?(i=e[0],s=this.dataStore.get(e),r=_.indexOf(this.dataStore.data,s),this.grid.select(i),this._updateGridSelection().then(p.hitch(this,function(){this._updateGridHeaderText(),t&&(this.grid.scrollTo({x:0,y:this.grid.rowHeight*r}),n=this.grid.row(i),n&&n.element&&n.element.scrollIntoView())}))):(_.forEach(e,function(e){o.push(e)},this),this.grid.select(o),this._updateGridSelection().then(p.hitch(this,function(){this._updateGridHeaderText()})))},filterSelectedRecords:function(e){e?this._showSelectedRecords():(this.grid.set("query",{}),this.set("_gridQuery",!1))},clearSelection:function(){this._clearSelection()},getRowDataById:function(e){return this.grid.row(e).data},getFeatureDataById:function(e){var t=new it;return t.objectIds=[e],t.outFields=["*"],this.featureLayer.queryFeatures(t,p.hitch(this,function(e){return e.features[0]}))},_init:function(){this.set("idProperty",this.featureLayer.objectIdField),this._getLayerInfo().then(p.hitch(this,function(){this._getEditingInfo();var e=this.gridOptions.sort&&this._findFirst(this.featureLayer.fields,"name",this.gridOptions.sort);this._defaultSortField=e?e.name:this.idProperty,this.grid=this._generateGrid(),this.grid.startup(),this.grid.resize(),this.grid.set("noDataMessage",""),this._gridTitleNode.innerHTML=this._i18nStrings.loadingData,this._toggleLoadingIndicator(!0),this.showGridMenu&&this._generateTableMenu(),this.showGridHeader||m.set(this._gridHeaderNode.domNode,"display","none"),this.own(this._addGridSelectListener(),this._addGridDeselectListener(),this._addGridDataChangeListener(),this._addGridRefreshListener(),this._addGridColumnStateChangeListener(),this._addGridColumnResizeListener(),this._addGridErrorListener(),this._addGridSortListener(),this._addGridFilterListener(),this._addGridEditorShowListener(),this._addGridEditorHideListener(),this._addGridColumnClickCallback(),this._addGridLayerClickCallback(),this._addGridApplyEditsListener()),this._resize(),this.featureLayer.relationships&&this.featureLayer.relationships.length>0&&this.get("showRelatedRecords")&&(this._supportRelatedRecords=!0),this.featureLayer.hasAttachments&&this.get("showAttachments")&&(this._supportAttachments=!0);var t=this.watch("dataStore",p.hitch(this,function(e,i,n){null===i&&n&&(this.set("loaded",!0),this.emit("load",this.loaded),t.remove())}));this._generateStore()}))},_generateGridDefinition:function(){var e=[U,G,V,z,B,q];return this.gridOptions.pagination&&e.push(Q),this.gridOptions.columnHider&&e.push(W),this.gridOptions.columnResizer&&e.push(K),g(e)},_generateGrid:function(){var t=this.get("gridOptions"),i=this.get("columns"),n=this._GridDefinition,s=Y.isDefined(this.featureLayer.maxRecordCount)?this.featureLayer.maxRecordCount:this._defaultBatchCount,r=Math.min(s,this.batchCount),a=new n({columns:i,sort:this._defaultSortField,noDataMessage:"",selectionMode:t.selectionMode,allowSelectAll:t.allowSelectAll,allowTextSelection:t.allowTextSelection,cellNavigation:t.cellNavigation,keepScrollPosition:!0,pageSizeOptions:t.pageSizeOptions,minRowsPerPage:r,maxRowsPerPage:r,queryRowsOverlap:0,pagingDelay:t.pagingDelay,query:p.hitch(this,function(e){return!this.filterIds||-1!==this.filterIds.indexOf(e[this.idProperty])})},this._gridNode);return e.before(a,"removeRow",p.hitch(this,function(e){_.forEach(i.length,function(t,i){var n=a.cell(e,i).element,s=n.contents||n,r=s.widget;r&&r.destroyRecursive()},this)})),e.after(a,"renderHeader",p.hitch(this,function(){a._sortListener.remove()})),a},_generateStore:function(){var e=this.get("featureLayer"),t=this.get("grid");this.get("dataStore")&&(this.layerInfo.fieldInfos=[],this._emptyStore()),this._getFeatureCount().then(p.hitch(this,function(i){if(this.set("featureCount",i),this.layerInfo)if(this.layerInfo.isFeatureCollection)t.set("noDataMessage",this._noDataMessage),this._updateFieldInfos(this.featureLayer.fields),this._generateColumnsFromFieldInfos(),t.set("columns",this.get("columns")),this._updateGridHeaderText(),this.layerInfo.features=this.featureLayer.graphics,this.set("dataStore",this._generateMemoryStore(this.featureLayer.graphics)),t.set("store",this.dataStore),this._toggleLoadingIndicator(!1);else if(this.featureCount>e.maxRecordCount)if(this._updateFieldInfos(e.fields),this._generateColumnsFromFieldInfos(),t.set("columns",this.get("columns")),this._updateGridHeaderText(),e.advancedQueryCapabilities&&!e.advancedQueryCapabilities.supportsPagination){var n=this.filterIds||this.layerInfo.idArray||null;if(n&&n.length)return this.set("dataStore",this._generateCacheStore(n)),void t.set("store",this.dataStore);this._getAllIds().then(p.hitch(this,function(e){this.layerInfo.idArray=e,this.set("dataStore",this._generateCacheStore(e)),t.set("store",this.dataStore)})).otherwise(p.hitch(this,function(){this._showLoadError()}))}else this.set("dataStore",this._generateCacheStore(this.filterIds)),t.set("store",this.dataStore);else this._queryFeatureLayer().then(p.hitch(this,function(i){var n=i.fields||e.fields;this._updateFieldInfos(n),this._generateColumnsFromFieldInfos(),t.set("columns",this.get("columns")),this._updateGridHeaderText(),this._supportAttachments&&this._supportRelatedRecords?s([this._getAllIds(),this._getAttachments()]).then(p.hitch(this,function(n){var r,a=e.relationships;return r=_.map(a,function(e){return this._queryRelatedRecords(n[0],e)},this),s(r).then(p.hitch(this,function(){this.set("dataStore",this._generateMemoryStore(i.features)),t.set("store",this.dataStore)}))})).otherwise(p.hitch(this,function(){this.set("dataStore",this._generateMemoryStore(i.features)),t.set("store",this.dataStore)})):this._supportAttachments?this._getAttachments().then(p.hitch(this,function(){this.set("dataStore",this._generateMemoryStore(i.features)),t.set("store",this.dataStore)})).otherwise(p.hitch(this,function(){this.set("dataStore",this._generateMemoryStore(i.features)),t.set("store",this.dataStore)})):this._supportRelatedRecords?this._getAllIds().then(p.hitch(this,function(n){var r=[],a=e.relationships;_.forEach(a,function(e){r.push(this._queryRelatedRecords(n,e))},this),s(r).then(p.hitch(this,function(){this.set("dataStore",this._generateMemoryStore(i.features)),t.set("store",this.dataStore)})).otherwise(p.hitch(this,function(){this.set("dataStore",this._generateMemoryStore(i.features)),t.set("store",this.dataStore)}))})).otherwise(p.hitch(this,function(){this.emit("error",{message:this._i18nStrings.errorGenerateStore}),this._showLoadError()})):(this.set("dataStore",this._generateMemoryStore(i.features)),t.set("store",this.dataStore))})).otherwise(p.hitch(this,function(){this._showLoadError(),t.set("noDataMessage",this._noDataMessage)}))})).otherwise(p.hitch(this,function(){this.emit("error",{message:this._i18nStrings.errorFeatureInfo}),this._showLoadError()}))},_emptyStore:function(){this._toggleLoadingIndicator(!0),this._gridTitleNode.innerHTML=this._i18nStrings.loadingData,this.grid.set({store:null,noDataMessage:""}),this.set("dataStore",null)},_queryFeatureLayer:function(e){var t=new it;return t.where="1=1",t.returnGeometry=!1,t.objectIds=e,this.featureLayer.queryFeatures(t)},_getFeatureCount:function(){var e=new it;return e.returnGeometry=!1,e.returnCountOnly=!0,e.where="1=1",J.defaults.io.timeout=1e4,this.featureLayer.queryCount(e).then(p.hitch(this,function(e){return J.defaults.io.timeout=6e4,e}),p.hitch(this,function(){return J.defaults.io.timeout=6e4,this.layerInfo.isFeatureCollection?this.featureLayer.graphics.length:this._defaultFeatureCount}))},_getAllIds:function(){var e=new it;return e.returnGeometry=!1,e.outFields=[this.idProperty],e.where="1=1",e.returnIdsOnly=!0,this.featureLayer.queryIds(e)},_queryAttachmentInfos:function(e){var t=e||0;return this.featureLayer.queryAttachmentInfos(t)},_getAttachments:function(e){var t=new i;return this._queryAttachments(e).then(p.hitch(this,function(e){var i=e.attachmentGroups;i||(this.layerInfo.queryAttachmentsSupported=!1),_.forEach(i,function(e){var t=e.parentObjectId,i=e.attachmentInfos;this._attachmentInfos[t]={attachments:i}},this),t.resolve(this._attachmentInfos)})).otherwise(p.hitch(this,function(e){this.layerInfo.queryAttachmentsSupported=!1,t.reject(e)})),t},_queryAttachments:function(e){var t=this.featureLayer._url.path+"/queryAttachments";return Z({url:t,content:{f:"json",objectIds:e},handleAs:"json",callbackParamName:"callback"})},_queryRelatedRecords:function(e,t){var i=new rt;return i.outFields=["*"],i.returnGeometry=!1,i.relationshipId=t.id,i.objectIds=e,this.featureLayer.queryRelatedFeatures(i).then(p.hitch(this,function(e){return this._relatedRecordInfos[t.id]=e,e}))},_getRelatedRecordsByIds:function(e,t){return this._relatedRecordInfos[t]?this._relatedRecordInfos[t][e]:[]},_generateCacheStore:function(t){var i,n,s,r=t&&t.length?t.length:this.featureCount,a=this._orderByFields&&this._orderByFields.length?this._orderByFields:[this._defaultSortField+" ASC"];return i=new at({layer:this.featureLayer,objectIds:t,totalCount:r,batchCount:this.batchCount,where:"1=1",orderByFields:a,getAttachments:this._supportAttachments,getRelatedRecords:this._supportRelatedRecords}),n=new I,s=new v(i,n,{}),this.set({_queryStore:i,_memoryStore:n}),this.grid.set("noDataMessage",this._noDataMessage),e.before(s,"query",p.hitch(this,function(){this._toggleLoadingIndicator(!0)})),e.after(s,"query",p.hitch(this,function(e){return e.then(p.hitch(this,function(e){e.attachmentInfos?this._attachmentInfos=p.mixin(this._attachmentInfos,e.attachmentInfos):e.attachmentInfos||(this.layerInfo.queryAttachmentsSupported=!1),e.relatedRecordInfos&&(this._relatedRecordInfos=this._mergeRelatedRecordInfos(this._relatedRecordInfos,e.relatedRecordInfos)),this._toggleLoadingIndicator(!1)})),e})),s},_mergeRelatedRecordInfos:function(e,t){if(null===e||null===t)return e;for(var i in t){e[i]||(e[i]={});for(var n in t[i])e[i][n]=t[i][n]}return e},_generateMemoryStore:function(e){var t,i=[];return _.forEach(e,function(e){i.push(e.attributes)},this),t=new C(new I({data:i,idProperty:this.get("idProperty")})),t.query=p.hitch(this,this._generateStoreSort),this.grid.set("noDataMessage",this._noDataMessage),this._toggleLoadingIndicator(!1),t},_generateStoreSort:function(e,t){var i=p.hitch(this,function(){return p.hitch(this,function(e,t){var i,s,r,a=n[0],o=a.columnId;return"ft_attachments"!==a.attribute&&"ft_related-records"!==a.fieldType||"undefined"==typeof o?(i=e[a.attribute]&&e[a.attribute].toLowerCase?e[a.attribute].toLowerCase():e[a.attribute],s=t[a.attribute]&&t[a.attribute].toLowerCase?t[a.attribute].toLowerCase():t[a.attribute]):(o=parseInt(o,10),i=this.grid.columns[o].get(e),s=this.grid.columns[o].get(t)),i=null!==i?i.valueOf():i,s=null!==s?s.valueOf():s,r=null===i&&null!==s?a.descending?-1:1:null!==i&&null===s?a.descending?1:-1:i===s?0:(i>s?1:-1)*(a.descending?-1:1)})}),n=t&&t.sort;return n&&"function"!=typeof n&&(t.sort=i()),new w(this.dataStore.queryEngine(e,t)(this.dataStore.data))},_getLayerInfo:function(){var e=new i,t={},n=this.featureLayer,s=n.id||n.layerId;return n.credential&&(this._userIds[s]=this.featureLayer.credential.userId),t.userId&&(this._userIds[s]=t.userId),t.isFeatureCollection=n._collection&&n._collection===!0||null===n.url&&null===n._url?!0:!1,t.idProperty=this.get("idProperty"),t.layerId=s,t.fieldInfos=[],t.hasAttachments=n.hasAttachments,t.typeIdField=n.typeIdField,t.types=n.types,t.editCapabilities={},t.editable=n.isEditable(),t.queryAttachmentsSupported=!0,this.set("layerInfo",p.clone(t)),e.resolve(this.layerInfo),e},_getEditingInfo:function(){var e=[];this.featureLayer.getEditCapabilities&&(this.layerInfo.editCapabilities=this.featureLayer.getEditCapabilities()),this.featureLayer.editFieldsInfo&&(this.featureLayer.editFieldsInfo.creatorField&&e.push(this.featureLayer.editFieldsInfo.creatorField),this.featureLayer.editFieldsInfo.creationDateField&&e.push(this.featureLayer.editFieldsInfo.creationDateField),this.featureLayer.editFieldsInfo.editorField&&e.push(this.featureLayer.editFieldsInfo.editorField),this.featureLayer.editFieldsInfo.editDateField&&e.push(this.featureLayer.editFieldsInfo.editDateField)),this._editorTrackingInfos[this.featureLayer.id]=e},_updateFieldInfos:function(e){if(e&&0!==e.length&&null!==this.layerInfo){var t=this._generateColumnOrder(e);_.forEach(t,function(e,t){var i,n,s,r,a,o,d,l,h=!1,u=this._findFirst(this.featureLayer.fields,"name",e.name)||{},c=this._findFirst(this.fieldInfos,"name",e.name)||this._findFirst(this.fieldInfos,"fieldName",e.name);i=c&&(c.label||c.alias)||u.alias,r=u.domain||!1,s=this.layerInfo.typeIdField&&e.name===this.layerInfo.typeIdField||!1,this.layerInfo&&this.layerInfo.types&&_.forEach(this.layerInfo.types,function(t){return t.domains&&t.domains[e.name]?void(h=!0):void 0},this),a=-1!==_.indexOf(this.hiddenFields,e.name)||"esriFieldTypeOID"===e.type||"esriFieldTypeGlobalID"===e.type||c&&c.visible===!1||"*"!==this.outFields[0]&&-1===_.indexOf(this.outFields,e.name),o=this.editable&&e.name!==this.idProperty&&this.layerInfo.editable&&this.layerInfo.editCapabilities.canUpdate&&u&&"undefined"!=typeof u.editable?c&&"undefined"!=typeof c.editable&&u.editable!==!1?c.editable||!1:u.editable:!1,n=c&&c.format?c.format:null,d=u.nullable||!1,l=c&&(c.dateOptions||c.format&&c.format.dateFormat)||null;var f={idx:t,name:e.name,alias:i,length:e.length||null,type:e.type,hidden:a,editable:o,nullable:d,domain:r,typeId:s,subtypeDomain:h,format:n,dateOptions:l};this.layerInfo.fieldInfos[t]=p.clone(f)},this),this.get("showRelatedRecords")&&_.some(this.featureLayer.relationships,function(e,t){if(t===this._numRelationshipColumns)return!0;var i="esriRelCardinalityOneToOne"===e.cardinality||"esriRelCardinalityOneToMany"===e.cardinality&&"esriRelRoleDestination"===e.role,n=this.visibleLayerIds?this.visibleLayerIds[this.visibleLayerIds.length-1]===e.relatedTableId:!1;!this.showCyclicalRelationships&&i&&n||this.layerInfo.fieldInfos.push({alias:e.name,name:e.name,type:"ft_related-records",relatedIndex:t,relationship:e})},this),this.get("showAttachments")&&this.featureLayer.hasAttachments&&this.layerInfo.fieldInfos.push({alias:this._i18nStrings.photosAndFiles,name:"ft_attachments",type:"ft_attachments",editable:this.featureLayer.hasAttachments&&this.editable&&this.layerInfo.editable})}},_generateColumnOrder:function(e){var t=[],i=this.outFields;return"*"!==i[0]?(-1===_.indexOf(i,this.idProperty)&&t.push(this._findFirst(e,"name",this.idProperty)),_.forEach(i,function(i){var n=this._findFirst(e,"name",i)||null;n&&i.name!==this.idProperty&&-1===_.indexOf(t,n)&&t.push(n)},this),_.forEach(e,function(e){-1===_.indexOf(t,e)&&t.push(e)},this)):t=p.clone(e),t},_generateColumnsFromFieldInfos:function(){var e=p.clone(this.layerInfo.fieldInfos)||[],t=[];_.forEach(e,function(e){"ft_attachments"===e.type?t.push(this._generateAttachmentsColumn(e)):"ft_related-records"===e.type?t.push(this._generateRelatedRecordsColumn(e)):"esriFieldTypeDate"===e.type?t.push(e.editable?this._generateDateTimeEditorColumn(e):this._generateDateTimeColumn(e)):e.domain?t.push(e.editable?this._generateDomainEditorColumn(e):this._generateDomainColumn(e)):e.typeId?t.push(e.editable?this._generateTypeEditorColumn(e):this._generateTypeColumn(e)):e.subtypeDomain?t.push(e.editable?this._generateSubtypeDomainEditorColumn(e):this._generateSubtypeDomainColumn(e)):_.indexOf(this._numericFieldTypes,e.type)>-1?t.push(e.editable?this._generateNumberEditorColumn(e):this._generateNumberColumn(e)):-1===_.indexOf(this._unsupportedFieldTypes,e.type)&&t.push(e.editable?this._generateStringEditorColumn(e):this._generateStringColumn(e))},this),this.set("columns",t),this.layerInfo.fieldInfos=p.clone(e)},_generateRelatedRecordsColumn:function(e){var t={label:e.alias,field:e.name,type:"ft_related-records",get:p.hitch(this,function(t){var i=this._getRelatedRecordsByIds(t[this.idProperty],e.relationship.id);return i&&i.features?i.features.length:0}),renderCell:p.hitch(this,function(t,i,n){var s=this._getRelatedRecordsByIds(t[this.idProperty],e.relationship.id),r=s&&s.features?s.features:s;this._generateRelatedRecordsCell(t,i,n,this.grid,this.layerInfo,e,r)}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e,this.css.relatedRecordsTitle)})};return t},_generateAttachmentsColumn:function(e){var t={label:e.alias,field:e.name,type:"ft_attachments",get:p.hitch(this,function(e){var t=e[this.idProperty],i=this._attachmentInfos[t];return i&&i.attachments?i.attachments.length:this.layerInfo&&this.layerInfo.queryAttachmentsSupported===!1?null:0}),renderCell:p.hitch(this,function(e,t,i){this._generateAttachmentsCell(e,t,i)}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e,this.css.attachmentsTitle)})};return t},_getDomainValueFromRow:function(e,t){if("range"===e.domain.type)return t[e.name];var i=this._findFirst(e.domain.codedValues,"code",t[e.name]);return i?i.name:""},_generateDomainColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:p.hitch(this,function(t){return this._getDomainValueFromRow(e,t)}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})}},_generateDomainEditorColumn:function(e){var i={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:p.hitch(this,function(t){return this._getDomainValueFromRow(e,t)}),renderCell:p.hitch(this,function(i,n,s){var r=c.create("div",{innerHTML:n},s),a=[];if(r.innerHTML=n,e.domain.codedValues)_.forEach(e.domain.codedValues,function(t){a.push(i[e.name]===t.code?{label:t.name,value:t.code,selected:!0}:{label:t.name,value:t.code})}),this._isValueEmpty(i[e.name])&&e.nullable?a.push({label:this._i18nStrings.empty,value:"ft_null",selected:!0}):this._isValueEmpty(i[e.name])&&!e.nullable?a.push({label:this._i18nStrings.empty,value:"ft_null",selected:!0,disabled:!0}):e.nullable&&a.push({label:this._i18nStrings.empty,value:"ft_null"}),t(s,this.editOn,p.hitch(this,function(){this._closeEditors(),r.innerHTML="";var n=new j({options:a,style:{width:"100%"}});n.placeAt(r),this.emit("editor-show",{cell:s,editor:n,grid:this.grid}),t(n,"blur",p.hitch(this,function(){var t=this._findFirst(e.domain.codedValues,"code",i[e.name]);r.innerHTML=t?t.name:""})),t(n,"keydown",function(e){13===e.keyCode&&n.focusNode.blur()}),t(n,"change",p.hitch(this,function(t){var a={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i};"ft_null"===t&&(t=null),i[e.name]=t;var o=this._findFirst(e.domain.codedValues,"code",t);r.innerHTML=o?o.name:"",n.destroy(),this._applyEditsByRow(i,a),this.emit("editor-hide",{cell:s,editor:n,grid:this.grid})})),this._activeEditors.push({id:i[this.idProperty],widget:n})}));else{if("range"!==e.domain.type)return void this.emit("error",{message:this._i18nStrings.errorDomainType});var o=e.domain.minValue,d=e.domain.maxValue;t(s,this.editOn,p.hitch(this,function(){this._closeEditors(),r.innerHTML="";var n=new A({value:i[e.name],required:!e.nullable,constraints:{min:o,max:d}});n.placeAt(r),n.focus(),n.textbox.select(),this.emit("editor-show",{cell:s,editor:n,grid:this.grid}),t(n,"blur",p.hitch(this,function(){r.innerHTML=i[e.name]})),t(n,"keydown",function(e){13===e.keyCode&&n.isValid()&&n.focusNode.blur()}),t(n,"change",p.hitch(this,function(t){var a={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i};n.isValid()?(i[e.name]=t,r.innerHTML=t,n.destroy(),this._applyEditsByRow(i,a)):(r.innerHTML=i[e.name],n.destroy(),this.emit("editor-hide",{cell:s,editor:n,grid:this.grid}))})),this._activeEditors.push({id:i[this.idProperty],widget:n})}))}}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return i},_getTypeValueFromRow:function(e,t){var i,n,s,r,a,o=this.layerInfo.types,d=o&&o[0];return d&&(n=t[e.name],s=-1!==_.indexOf(this._numericFieldTypes,e.type),r="string"==typeof d.id,a=r&&s?n.toString():n,i=this._findFirst(o,"id",a),i=i?i.name:null),i},_generateTypeColumn:function(e){return{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:p.hitch(this,function(t){return this._getTypeValueFromRow(e,t)}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})}},_generateTypeEditorColumn:function(e){var i={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:p.hitch(this,function(t){return this._getTypeValueFromRow(e,t)}),renderCell:p.hitch(this,function(i,n,s){var r=c.create("div",{innerHTML:n},s),a=[];r.innerHTML=n,_.forEach(this.layerInfo.types,function(t){a.push(i[e.name]===t.id?{label:t.name,value:t.id,selected:!0}:{label:t.name,value:t.id})},this),this._isValueEmpty(i[e.name])&&e.nullable?a.push({label:this._i18nStrings.empty,value:"ft_null",selected:!0}):this._isValueEmpty(i[e.name])&&!e.nullable?a.push({label:this._i18nStrings.empty,value:"ft_null",selected:!0,disabled:!0}):e.nullable&&a.push({label:this._i18nStrings.empty,value:"ft_null"}),t(s,this.editOn,p.hitch(this,function(){this._closeEditors(),r.innerHTML="";var n=new j({options:a,style:{width:"100%"}});n.placeAt(r),this.emit("editor-show",{cell:s,editor:n,grid:this.grid}),t(n,"blur",p.hitch(this,function(){var t=this._findFirst(this.layerInfo.types,"id",i[e.name]);r.innerHTML=t?t.name:null})),t(n,"keydown",function(e){13===e.keyCode&&n.focusNode.blur()}),t(n,"change",p.hitch(this,function(t){var a={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i};"ft_null"===t&&(t=null),i[e.name]=t;var o=this._findFirst(this.layerInfo.types,"id",t);r.innerHTML=o?o.name:null,n.destroy(),this._applyEditsByRow(i,a),this.emit("editor-hide",{cell:s,editor:n,grid:this.grid})})),this._activeEditors.push({id:i[this.idProperty],widget:n})}))}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return i},_generateSubtypeDomainColumn:function(e){var t={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:p.hitch(this,function(t){var i,n=this._findFirst(this.layerInfo.types,"id",t[this.layerInfo.typeIdField]);return n&&n.domains&&n.domains[e.name]&&n.domains[e.name].codedValues&&(i=this._findFirst(n.domains[e.name].codedValues,"code",t[e.name])),i?i.name:t[e.name]}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return t},_generateSubtypeDomainEditorColumn:function(e){var i={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,editOn:this.editOn,editor:"text",get:p.hitch(this,function(t){var i,n=this._findFirst(this.layerInfo.types,"id",t[this.layerInfo.typeIdField]);return n&&n.domains&&n.domains[e.name]&&n.domains[e.name].codedValues&&(i=this._findFirst(n.domains[e.name].codedValues,"code",t[e.name])),i?i.name:t[e.name]}),renderCell:p.hitch(this,function(i,n,s){var r=c.create("div",{innerHTML:n},s),a=!1;return r.innerHTML=n,t(s,this.editOn,p.hitch(this,function(){this._closeEditors();var n,o,d=this._findFirst(this.layerInfo.types,"id",i[this.layerInfo.typeIdField]),l=d.domains[e.name],h=[];if(l){n=d.domains[e.name].codedValues,o=this._findFirst(n,"code",i[e.name]),_.forEach(n,function(t){h.push(i[e.name]===t.code?{label:t.name,value:t.code,selected:!0}:{label:t.name,value:t.code}),t.code===o&&(a=!0)}),this._isValueEmpty(i[e.name])&&e.nullable?h.push({label:this._i18nStrings.empty,value:"ft_null",selected:!0}):this._isValueEmpty(i[e.name])&&!e.nullable?h.push({label:this._i18nStrings.empty,value:"ft_null",selected:!0,disabled:!0}):e.nullable&&h.push({label:this._i18nStrings.empty,value:"ft_null"}),a||o||null===i[e.name]||h.push({label:i[e.name],value:"N/A",selected:!0,disabled:!0}),r.innerHTML="";var u=new j({options:h,style:{width:"100%"}});u.placeAt(r),this.emit("editor-show",{cell:s,editor:u,grid:this.grid}),t(u,"blur",p.hitch(this,function(){var t=this._findFirst(n,"code",i[e.name]);r.innerHTML=t?t.name:i[e.name]})),t(u,"keydown",function(e){13===e.keyCode&&u.focusNode.blur()}),t(u,"change",p.hitch(this,function(t){var a={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i};"ft_null"===t&&(t=null),i[e.name]=t;var o=this._findFirst(n,"code",t);r.innerHTML=o?o.name:null,u.destroy(),this._applyEditsByRow(i,a),this.emit("editor-hide",{cell:s,editor:u,grid:this.grid})})),this._activeEditors.push({id:i[this.idProperty],widget:u})}else{r.innerHTML="";var c=new A({value:i[e.name],required:!e.nullable});c.placeAt(r),c.focus(),c.textbox.select(),this.emit("editor-show",{cell:s,editor:c,grid:this.grid}),t(c,"blur",p.hitch(this,function(){r.innerHTML=i[e.name]})),t(c,"keydown",function(e){13===e.keyCode&&c.isValid()&&c.focusNode.blur()}),t(c,"change",p.hitch(this,function(t){var n={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i};c.isValid()?(i[e.name]=t,r.innerHTML=t,c.destroy(),this._applyEditsByRow(i,n)):(r.innerHTML=i[e.name],c.destroy()),this.emit("editor-hide",{cell:s,editor:c,grid:this.grid})
})),this._activeEditors.push({id:i[this.idProperty],widget:c})}})),n}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return i.formatter=e.format&&e.format.embeddedHTML?p.hitch(this,function(e){return e||null}):e.format&&e.format.template?p.hitch(this,function(t){var i;return t&&(i=u.substitute(e.format.template,{value:t})),i||null}):e.format&&e.format.link===!1?p.hitch(this,function(e){return e}):p.hitch(this,function(e){return this._generateLinkFromString(e)}),i},_generateStringColumn:function(e){var t={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return t.formatter=e.format&&e.format.embeddedHTML?p.hitch(this,function(e){return e||null}):e.format&&e.format.template?p.hitch(this,function(t){var i;return t&&(i=u.substitute(e.format.template,{value:t})),i||null}):e.format&&e.format.link===!1?p.hitch(this,function(e){return e}):p.hitch(this,function(e){return this._generateLinkFromString(e)}),t},_generateStringEditorColumn:function(e){var t=new z({label:e.alias,field:e.name,type:e.type,hidden:e.hidden,editorArgs:{required:!e.nullable},editOn:this.editOn,editor:"text",renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})});return t.formatter=e.format&&e.format.embeddedHTML?p.hitch(this,function(e){return e||null}):e.format&&e.format.template?p.hitch(this,function(t){var i;return t&&(i=u.substitute(e.format.template,{value:t})),i||null}):e.format&&e.format.link===!1?p.hitch(this,function(e){return e}):p.hitch(this,function(e){return this._generateLinkFromString(e)}),t},_getLocaleFormattedNumber:function(e){return isNaN(e)||null===e?null:$.format(e)},_generateNumberColumn:function(e){var t={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:p.hitch(this,function(t){return this._getLocaleFormattedNumber(t[e.name])}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})};return e.format&&e.format.template&&(t.formatter=p.hitch(this,function(t){var i;return t&&(i=u.substitute(e.format.template,{value:t})),i||null})),t},_generateNumberEditorColumn:function(e){var i={label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:p.hitch(this,function(t){return this._getLocaleFormattedNumber(t[e.name])}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)}),renderCell:p.hitch(this,function(i,n,s){var r=c.create("div",{innerHTML:n},s),a=null,o={};o.places="esriFieldTypeInteger"===e.type||"esriFieldTypeSmallInteger"===e.type?0:"0,20",a=e.format&&e.format.template&&null!==n?u.substitute(e.format.template,{value:n}):null===n?"":n,r.innerHTML=a,t(s,this.editOn,p.hitch(this,function(){this._closeEditors(),r.innerHTML="";var n=new A({value:i[e.name],required:!e.nullable,constraints:o});n.placeAt(r),n.focus(),n.textbox.select(),this.emit("editor-show",{cell:s,editor:n,grid:this.grid}),t(n,"blur",p.hitch(this,function(){var t=i[e.name],n=null;n=e.format&&e.format.template&&null!==t?u.substitute(e.format.template,{value:this._getLocaleFormattedNumber(t)}):null===t?"":this._getLocaleFormattedNumber(t),r.innerHTML=n,s.focus()})),t(n,"keydown",function(e){13===e.keyCode&&n.isValid()&&n.focusNode.blur()}),t(n,"change",p.hitch(this,function(t){var a={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i},o=null,d=null;(""===t||isNaN(t))&&(t=null),n.isValid()?(i[e.name]=t,null!==t&&(d=this._getLocaleFormattedNumber(t)),o=e.format&&e.format.template&&null!==t?u.substitute(e.format.template,{value:d}):null===t?"":d,r.innerHTML=o,n.destroy(),this._applyEditsByRow(i,a)):(null!==i[e.name]&&(d=this._getLocaleFormattedNumber(i[e.name])),o=e.format&&e.format.template&&null!==i[e.name]?u.substitute(e.format.template,{value:d}):null===i[e.name]?"":d,r.innerHTML=o,n.destroy(),this.emit("editor-hide",{cell:s,editor:n,grid:this.grid}))})),this._activeEditors.push({id:i[this.idProperty],widget:n})}))})};return e.format&&e.format.template&&(i.formatter=p.hitch(this,function(t){var i;return t&&(i=u.substitute(e.format.template,{value:t})),i||null})),i},_generateDateTimeColumn:function(e){var t={},i=e.dateOptions&&e.dateOptions.hasOwnProperty("timeEnabled")?e.dateOptions.timeEnabled:this.dateOptions.timeEnabled;return t=i?{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:p.hitch(this,function(t){return""===t[e.name]||null===t[e.name]?null:this._generateDateFromLocale(new Date(t[e.name]),e)}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})}:{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:p.hitch(this,function(t){return""===t[e.name]||null===t[e.name]?null:this._generateDateFromLocale(new Date(t[e.name]),e)}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})}},_generateDateTimeEditorColumn:function(e){var i,n=e.dateOptions&&e.dateOptions.hasOwnProperty("timeEnabled")?e.dateOptions.timeEnabled:this.dateOptions.timeEnabled;return i=n?{label:e.alias,field:e.name,type:e.type,hidden:e.hidden,get:p.hitch(this,function(t){return""===t[e.name]||null===t[e.name]?null:this._generateDateFromLocale(new Date(t[e.name]),e)}),renderCell:p.hitch(this,function(i,n,s){var r,a;n&&c.create("div",{innerHTML:n},s),t(s,this.editOn,p.hitch(this,function(){this._closeEditors(),r=new P({value:new Date(i[e.name]),constraints:{datePattern:e.dateOptions&&e.dateOptions.datePattern?e.dateOptions.datePattern:this.dateOptions.datePattern}}),r.on("change",p.hitch(this,function(t){if(r.isValid()){var n,s=a.getValue(),o={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i};if(null===t||""===t)return a.setValue(null),i[e.name]=null,void this._applyEditsByRow(i,o);null===s&&(s=new Date(0,0),a.setValue(s)),n=this._getCombinedDateTime(t,s).getTime(),i[e.name]=n,this._applyEditsByRow(i,o)}})),a=new N({value:new Date(i[e.name]),constraints:{timePattern:e.dateOptions&&e.dateOptions.timePattern?e.dateOptions.timePattern:this.dateOptions.timePattern}}),a.on("change",p.hitch(this,function(t){if(a.isValid()){var n,s=r.getValue(),o={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i};if(null===t||""===t)return r.setValue(null),void(i[e.name]=null);null===s&&(s=new Date(0,0),r.setValue(s)),n=this._getCombinedDateTime(s,t).getTime(),i[e.name]=n,this._applyEditsByRow(i,o)}})),s.innerHTML="";var t=c.create("div",{style:{"float":"left",display:"inline"}},s);r.placeAt(t),a.placeAt(t);var n=M.watch("activeStack",p.hitch(this,function(t,o,d){if((-1!==_.indexOf(o,r.id)||-1!==_.indexOf(o,a.id))&&-1===_.indexOf(d,r.id)&&-1===_.indexOf(d,a.id)){n.remove();var l,h=r.getValue(),u=a.getValue(),c={fieldName:e.name,oldValue:i[e.name],rowId:i[this.idProperty],rowObject:i};a.isValid()&&r.isValid()?(h&&u?(l=this._getCombinedDateTime(h,u).getTime(),s.innerHTML=this._generateDateFromLocale(new Date(l),e)):(l=null,s.innerHTML=""),i[e.name]=l,this._applyEditsByRow(i,c)):s.innerHTML=this._generateDateFromLocale(i[e.name],e)}}));r.focus(),r.textbox.select()}))}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})}:new z({label:e.alias,field:e.name,type:e.type,editorArgs:{required:!e.nullable,constraints:{datePattern:e.dateOptions&&e.dateOptions.datePattern?e.dateOptions.datePattern:this.dateOptions.datePattern}},editOn:this.editOn,hidden:e.hidden,formatter:p.hitch(this,function(t){return t?this._generateDateFromLocale(t,e):null}),get:p.hitch(this,function(t){return""===t[e.name]||null===t[e.name]?null:new Date(t[e.name])}),renderHeaderCell:p.hitch(this,function(t){return this._getColumnHeaderCell(t,e)})},P)},_closeEditors:function(){var e=this._activeEditors;_.forEach(e,function(e){e.widget.onBlur()}),this.set("_activeEditors",[])},_getColumnHeaderCell:function(e,t,i){var n=i?this.css.featureTableColumnHeaderTitle+" "+i:this.css.featureTableColumnHeaderTitle,s=c.create("div",{className:this.css.featureTableColumnHeader});return!t.editable&&this.editable&&this.layerInfo.editable&&c.create("span",{className:this.css.headerGear+" "+this.css.lockedIcon},s),c.create("div",{innerHTML:t.alias,className:n},s),c.create("div",{className:this.css.featureTableColumnHeaderClear},s),this.showColumnHeaderTooltips&&this.own(new H({connectId:[s],label:t.alias})),this.showDataTypes&&"ft_related-records"!==t.type&&"ft_attachments"!==t.type&&c.create("div",{innerHTML:t.type.replace("esriFieldType",""),className:this.css.featureTableColumnHeaderType},s),s},_generateAttachmentsCell:function(e,i,n){if(this.layerInfo){var s,r=null!==i&&"undefined"!=typeof i?u.substitute(this._i18nStrings.parenValue,{value:i}):null,a=c.create("div",{innerHTML:r?r+" ":"",className:this.css.attachmentsCell},n),o=this.layerInfo,d=this._i18nStrings;s=i>0||!o.queryAttachmentsSupported?d.show:o.editable?d.add:"";{c.create("span",{innerHTML:s,className:this.css.attachmentsLink},a)}t(a,"click",p.hitch(this,function(){return 0!==i||this.layerInfo.editCapabilities.canCreate?this.layerInfo.queryAttachmentsSupported?void this._showAttachmentsDialog(e,i,n,a):void this._queryAttachmentInfos(e[this.idProperty]).then(p.hitch(this,function(t){this._attachmentInfos[e[this.idProperty]]={attachments:t},n.removeChild(n.firstChild),this._generateAttachmentsCell(e,t.length,n),this._showAttachmentsDialog(e,t.length,n,a)})):void 0}))}},_generateRelatedRecordsCell:function(e,i,n,s,r,a,o){{var d=null!==i&&"undefined"!=typeof i?u.substitute(this._i18nStrings.parenValue,{value:i}):null,l=c.create("div",{innerHTML:d?d+" ":null,className:this.css.relatedRecordsCell},n);c.create("span",{innerHTML:i>0?this._i18nStrings.show:"",className:this.css.relatedRecordsLink},l)}i>0&&t(n,"click",p.hitch(this,function(t){var i=this.grid.cell(t),n=i.column;this._showRelatedRecords(e,a,o,n)}))},_selectFeaturesFromIds:function(e){if(e||0!==this.selectedRowIds.length){var t=new it;return t.returnGeometry=!!this.map,t.objectIds=e||this.selectedRowIds,this.layerInfo.isFeatureCollection||(t.where="1=1"),this.featureLayer.selectFeatures(t,tt.SELECTION_NEW)}},_updateGridSelection:function(){var e,t,n=this.grid.selection,s=new i,r=[],a=[];for(e in n)n.hasOwnProperty(e)&&(t=parseInt(e,10),a.push(t),r.push(this.grid.row(t).data));return this.set({selectedRows:r,selectedRowIds:a,_featureSelectedCount:a.length}),s.resolve(),s},_applyEdits:function(e,t){if(e=e||[],!(e.length<=0)){var i=[];_.forEach(e,function(e){e.layer&&i.push(e.layer.applyEdits(e.adds,e.updates,e.deletes))}),i.length>0?s(i).then(function(){t&&t()}).otherwise(p.hitch(this,function(){this.emit("error",{message:this._i18nStrings.errorUpdateFailed}),this._toggleLoadingIndicator(!1)})):this._toggleLoadingIndicator(!1)}},_applyEditsByRow:function(e,t){t&&this._rollbackInfos.push({id:t.rowId,data:t}),this.getFeatureDataById(e[this.idProperty]).then(p.hitch(this,function(t){this._toggleLoadingIndicator(!0);var i=t.features[0];i.attributes=e,this._applyEdits([{layer:this.featureLayer,updates:[i]}],null)}))},_addGridApplyEditsListener:function(){var e=t(this.featureLayer,"edits-complete",p.hitch(this,function(e){this.emit("edits-complete",e);var t,i,n,s,r=e.updates||[],a=this._rollbackInfos;r&&r.length&&_.forEach(r,function(e){t=this._findFirst(a,"id",e.objectId),i=t.data,e.success||(e.error?this.emit("error",{message:e.error}):this.emit("error",{message:this._i18nStrings.errorUpdateFailed}),i?(n=this.grid.row(i.rowId),s=n.data,s[this.idProperty]===e.objectId?(s[i.fieldName]=i.oldValue,this.grid.updateDirty(i.rowId,i.fieldName,i.oldValue),this.grid.refresh()):this.emit("error",{message:this._i18nStrings.errorRollback})):this.emit("error",{message:this._i18nStrings.errorRollback})),this._rollbackInfos.splice(_.indexOf(this._rollbackInfos,t),1),this._toggleLoadingIndicator(!1)},this),this.layerInfo.isFeatureCollection&&this._generateStore(),this._toggleLoadingIndicator(!1)}));return e},_addGridLayerClickCallback:function(){var e=t(this.featureLayer,"click",p.hitch(this,function(e){if(this.syncSelection&&e.graphic&&e.graphic.attributes&&e.graphic.attributes[this.idProperty]){this.grid.clearSelection(),this.featureLayer.clearSelection();var i=e.graphic,n=i.attributes[this.idProperty];this._selectFeaturesFromIds([n]).then(p.hitch(this,function(e){if(e.length){if(this.map&&this.zoomToSelection){var i=this._calcGraphicsExtent(e);if(i){var s=i.getCenter();this.map.centerAt(s).then(function(){_.forEach(e,function(e){e.getDojoShape()&&e.getDojoShape().moveToFront()})})}else this.emit("error",{message:this._i18nStrings.errorValidExtent})}var r=this.dataStore.get(n),a=_.indexOf(this.dataStore.data,r);("undefined"==typeof r||-1===a)&&this.emit("error",this._i18nStrings.errorLoadRow),this.grid.select(n),this._updateGridSelection().then(p.hitch(this,function(){this._updateGridHeaderText(),t.once(this.grid,"scroll",p.hitch(this,function(){this.grid.row(n).element&&this.grid.row(n).element.scrollIntoView()})),this.grid.scrollTo({x:0,y:this.grid.rowHeight*a})}))}}),p.hitch(this,function(){this.emit("error",{message:this._i18nStrings.errorSelectFeatures})}))}}));return e},_addGridRefreshListener:function(){var e=t(this.grid,"dgrid-refresh-complete",p.hitch(this,function(e){this.grid.columns[0]&&this.emit("refresh",e)}));return e},_addGridDataChangeListener:function(){var e=t(this.grid,"dgrid-datachange",p.hitch(this,function(e){var t=e.cell.column.field,i=e.value,n=parseInt(e.rowId,10),s=this.grid.row(n).data,r=this._findFirst(this.layerInfo.fieldInfos,"name",t),a={oldValue:e.oldValue,fieldName:t,rowId:n,rowObject:s};this.emit("data-change",e),""===i&&(i=null),"esriFieldTypeInteger"!==r.type&&"esriFieldTypeSmallInteger"!==r.type||null===i||(i=parseInt(i,10)),"esriFieldTypeDouble"!==r.type&&"esriFieldTypeSingle"!==r.type||null===i||(i=parseFloat(i)),s[t]=i&&i.getTime&&i.getTime()?i.getTime():i,this._updateGridSelection().then(p.hitch(this,function(){this._updateGridHeaderText(),this._applyEditsByRow(s,a)}))}));return e},_addGridSelectListener:function(){var e=t(this.grid,"dgrid-select",p.hitch(this,function(e){this._activeEditors[0]&&this._activeEditors[0].id&&e.rows[0]&&Number(e.rows[0].id)!==Number(this._activeEditors[0].id)&&this._closeEditors(),this._updateGridSelection().then(p.hitch(this,function(){this.emit("row-select",e.rows),this._updateGridHeaderText(),this.map&&this.syncSelection&&this._selectFeaturesFromIds().then(p.hitch(this,function(e){if(this.zoomToSelection){var t=this._calcGraphicsExtent(e);if(t){var i=t.getCenter();this.map.centerAt(i).then(function(){_.forEach(e,function(e){e.getDojoShape()&&e.getDojoShape().moveToFront()})})}else this.emit("error",{message:this._i18nStrings.errorValidExtent})}}),p.hitch(this,function(){this.emit("error",{message:this._i18nStrings.errorSelectFeatures})}))}))}));return e},_addGridDeselectListener:function(){var e=t(this.grid,"dgrid-deselect",p.hitch(this,function(e){this._updateGridSelection().then(p.hitch(this,function(){this.emit("row-deselect",e.rows),this._updateGridHeaderText(),this._selectFeaturesFromIds()}))}));return e},_addGridColumnStateChangeListener:function(){var e=t(this.grid,"dgrid-columnstatechange",p.hitch(this,function(e){this.emit("column-state-change",e)}));return e},_addGridColumnResizeListener:function(){var e=t(this.grid,"dgrid-columnresize",p.hitch(this,function(e){this.emit("column-resize",e)}));return e},_addGridErrorListener:function(){var e=t(this.grid,"dgrid-error",p.hitch(this,function(e){this.emit("error",e)}));return e},_addGridSortListener:function(){var e=t(this.grid,"dgrid-sort",p.hitch(this,function(e){this.emit("sort",e)}));return e},_addGridFilterListener:function(){var e=t(this.grid,"dgrid-filter",p.hitch(this,function(e){this.emit("filter",e)}));return e},_addGridEditorShowListener:function(){var e=t(this.grid,"dgrid-editor-show",p.hitch(this,function(e){this.emit("editor-show",e)}));return e},_addGridEditorHideListener:function(){var e=t(this.grid,"dgrid-editor-hide",p.hitch(this,function(e){this.emit("editor-hide",e)}));return e},_addGridColumnClickCallback:function(){var e=this.grid;return e.on(".dgrid-header .dgrid-cell:click",p.hitch(this,this._showColumnMenu))},_resize:function(){this._gridBorderContainer.resize(),this._gridHeaderNode.resize(),this._gridContentPane.resize(),this.grid&&this.grid.resize()},_updateGridHeaderText:function(){return this._gridTitleNode?this.showFeatureCount?void(this._gridTitleNode.innerHTML=u.substitute(this._i18nStrings.gridHeader,{gridTitle:this.featureLayer.name||this._i18nStrings.untitled,featureCount:this.filterIds?this.filterIds.length:this.featureCount,featureSelectedCount:this._featureSelectedCount})):void(this._gridTitleNode.innerHTML=this.featureLayer.name||this._i18nStrings.untitled):void 0},_toggleLoadingIndicator:function(e){this._gridLoadingIndicatorNode&&(this._gridLoadingIndicatorNode.style.display=e?"block":"none")},_showLoadError:function(){this._toggleLoadingIndicator(!1),this._gridTitleNode&&(this._gridTitleNode.innerHTML=this._i18nStrings.dataError)},_generateDialog:function(e){var t=new R({title:e.title,content:e.content,baseClass:this.css.dialog});return c.create("div",{className:"break"},t.containerNode),t},_showAttachmentsDialog:function(e,i,n){var s,r,a,o,d,l,h=e[this.idProperty],u=this._attachmentInfos[h]?this._attachmentInfos[h].attachments:[],f=c.create("div",{});s=this._tabContainer=new dt({"class":this.css.attachmentsTabContainer},c.create("div",null,f)),r=this._viewPane=new lt({title:this._i18nStrings.view,content:this._generateViewAttachmentContent(e,n,h,u),"class":this.css.attachementsViewPane,selected:i>0?!0:!1,disabled:i>0?!1:!0}),a=this._addPane=new lt({title:this._i18nStrings.add,content:this._generateAddAttachmentContent(),"class":this.css.attachementsAddPane,selected:0===i?!0:!1,disabled:!(this.layerInfo.editable&&this.editable)}),s.addChild(r),s.addChild(a),s.startup(),d=c.create("button",{type:"button"},f),this._closeButton=new k({label:this._i18nStrings.close,baseClass:"esri-attachments-dialog-button primary cancel dijitButton",onClick:p.hitch(this,function(){this._attachmentsDialog.hide()})},d),o=c.create("button",{type:"button"},f),this._addButton=new k({label:this._i18nStrings.upload,baseClass:"esri-attachments-dialog-button primary dijitButton",style:i>0?"display:none;":"",disabled:!0,onClick:p.hitch(this,function(){if(this._addAttachmentInput.files&&this._addAttachmentInput.files[0]){var t=this._addAttachmentInput.files[0];l.innerHTML=this._i18nStrings.uploading,this._closeButton.setDisabled(!0),this._addButton.setDisabled(!0);var i=new FormData;i.append("attachment",t,t.name),this.featureLayer.addAttachment(h,i).then(p.hitch(this,function(t){t.success?(this._closeButton.setDisabled(!1),this._addAttachmentInput.value="",r.disabled===!0&&r.set("disabled",!1),l.innerHTML=this._i18nStrings.uploadSuccess,this._queryAttachmentInfos(h).then(p.hitch(this,function(t){r.setContent(this._generateViewAttachmentContent(e,n,h,t)),this._attachmentInfos[h]={attachments:t},n.removeChild(n.firstChild),this._generateAttachmentsCell(e,t.length,n)}))):(this._addAttachmentInput.value="",l.innerHTML=this._i18nStrings.uploadFail,this._closeButton.setDisabled(!1))})).otherwise(p.hitch(this,function(){this._addAttachmentInput.value="",l.innerHTML=this._i18nStrings.uploadFail,this._closeButton.setDisabled(!1)}))}})},o),s.watch("selectedChildWidget",p.hitch(this,function(e,t,i){this._attachmentFeedbackNode.innerHTML="",m.set(this._addButton.domNode,"display",i==a?"inline-block":"none")})),l=this._attachmentFeedbackNode=c.create("div",{innerHTML:"","class":this.css.attachmentsFeedbackText},f),this._attachmentsDialog=this._generateDialog({title:this._i18nStrings.photosAndFiles,content:f}),t(this._attachmentsDialog,"hide",p.hitch(this,function(){this._attachmentsDialog.destroyRecursive(),this._attachmentsDialog=null})),this._attachmentsDialog.show()},_generateViewAttachmentContent:function(e,i,n,s){var r={},a=this.featureLayer._url.path+"/"+n+"/attachments/",o=c.create("div",{"class":this.css.attachementsViewPaneContent}),d=l.objectToQuery({gdbVersion:this.featureLayer.gdbVersion,token:this.featureLayer._getToken()}),h=d?"?"+d:"";return _.forEach(s,function(d,l){var u,f,g,_,y,b,v,I,C=d.id,w=d.name,S=d.contentType,F=this._toAttachmentTypeIconClass(w,S),T=d.size,L=a+C+h;u=c.create("div",{"class":this.css.attachmentsNode},o),r[C]=u,f=c.create("div",{"class":this.css.attachmentsNodeIcon+" "+F},u),g=c.create("div",{"class":this.css.attachmentsNodeTextContainer},u),_=c.create("span",{"class":this.css.attachmentsNodeTextName},g),y=c.create("a",{href:L,title:w,innerHTML:w,target:"_blank"},_),b=c.create("span",{"class":this.css.attachmentsNodeTextSize,innerHTML:this._parseAttachmentSize(T)},g),v=c.create("div",{"class":this.css.attachmentsNodeDelete},u),this.layerInfo.editable&&(I=c.create("span",{"class":"icon-ui-close-circled"},v),t(v,"click",p.hitch(this,function(){m.set(this._attachmentFeedbackNode,"display","inline"),this._attachmentFeedbackNode.innerHTML=this._i18nStrings.deleting,this.featureLayer.deleteAttachments(n,[C]).then(p.hitch(this,function(t){if(t[0]&&t[0].success){var n=r[C];n.parentNode.removeChild(n),s.splice(l,1),0===s.length&&(this._viewPane.set("disabled",!0),this._addPane.set("selected",!0),this._tabContainer.selectChild(this._addPane)),this._attachmentFeedbackNode.innerHTML=this._i18nStrings.deleteSuccess,i.removeChild(i.firstChild),this._generateAttachmentsCell(e,s.length,i)}else this._attachmentFeedbackNode.innerHTML=this._i18nStrings.deleteFail}))})))},this),o},_generateAddAttachmentContent:function(){var e=c.create("div",{"class":this.css.attachementsAddPaneContent}),i=this._addAttachmentInput=c.create("input",{type:"file",name:"ft_attachment_input",size:"40","class":"drag-drop"},e);return t(i,"change",p.hitch(this,function(){this._attachmentFeedbackNode.innerHTML="",this._addButton.setDisabled(i.value.length>0?!1:!0)})),e},_showRelatedRecords:function(e,t,i,n){var s,r=e[this.idProperty],a=t.relationship,o=this.featureLayer.getField(a.keyField),d=o?o.name:null,l=this.columns,h=_.filter(l,function(e){return!e.hidden}),u=this._findFirst(h,"field",this.featureLayer.displayField),c=this._findFirst(h,"field",d),f=this._findFirst(h,"type","esriFieldTypeString"),m=this._findFirstNumberColumn(),g=this._findFirst(h,"type","esriFieldTypeDate");s=l.indexOf(this._validateRelatedColumnDisplay(u)?u:this._validateRelatedColumnDisplay(c)?c:this._validateRelatedColumnDisplay(f)?f:this._validateRelatedColumnDisplay(m)?m:this._validateRelatedColumnDisplay(g)?g:n),this.emit("show-related-records",{row:e,featureId:r,records:i,keyField:d,columnId:s,relationship:a})},_findFirstNumberColumn:function(){var e;return _.some(this.columns,function(t){return-1===_.indexOf(this._numericFieldTypes,t.type)||t.field===this.idProperty||t.hidden?void 0:(e=t,!0)},this),e},_validateRelatedColumnDisplay:function(e){return!(!e||e.hidden||-1===this.columns.indexOf(e)||"esriFieldTypeOID"===e.type||"esriFieldTypeGlobalID"===e.type)},_showStatisticsDialog:function(e,t){var i,n,s,r,a=e.features[0].attributes,o={pattern:"#,###,###,##0.########"},d={};this._statisticsDialog&&this._statisticsDialog.destroy();for(i in a)a.hasOwnProperty(i)&&(d[i.toLowerCase()]=a[i]);var l=[{title:this._i18nStrings.numberOfValues,value:Y.isDefined(d.countfield)?h.format(d.countfield,o):""},{title:this._i18nStrings.sumOfValues,value:Y.isDefined(d.sumfield)?h.format(d.sumfield,o):""},{title:this._i18nStrings.minimum,value:Y.isDefined(d.minfield)?h.format(d.minfield,o):""},{title:this._i18nStrings.maximum,value:Y.isDefined(d.maxfield)?h.format(d.maxfield,o):""},{title:this._i18nStrings.average,value:Y.isDefined(d.avgfield)?h.format(h.round(d.avgfield,this._roundPos(d.avgfield)),o):""},{title:this._i18nStrings.standardDeviation,value:Y.isDefined(d.stddevfield)?h.format(h.round(d.stddevfield,this._roundPos(d.stddevfield)),o):""}];n=c.create("div",{className:"esriAGOTableStatistics"}),c.create("div",{className:"header",innerHTML:u.substitute(this._i18nStrings.fieldLabel,{fieldName:t})},n),c.create("div",{className:"hzLine"},n),s=c.create("table",{className:"attrTable",style:{cellpadding:0,cellspacing:0}},n),r=c.create("tbody",{},s),_.forEach(l,function(e){var t=c.create("tr",{valign:"top"},r);c.create("td",{"class":"attrName",innerHTML:e.title},t),c.create("td",{"class":"attrValue",innerHTML:e.value},t)}),c.create("div",{className:"break"},n);var f=c.create("button",{type:"button"},n);this._closeButton=new k({label:this._i18nStrings.close,baseClass:"btn primary dijitButton",onClick:p.hitch(this,function(){var e=this._statisticsDialog;e.hide().then(p.hitch(this,function(){e.destroyRecursive(),this._closeButton=null}))})},f),this._statisticsDialog=this._generateDialog({title:this._i18nStrings.statistics,content:n}),this._statisticsDialog.show(),this.emit("show-statistics",{dialog:this._statisticsDialog,statistics:a})},_getColumnStats:function(e){var t,i,n=this.columns[e].field,s=[],r=["count","sum","min","max","avg","stddev"],a=["countField","sumField","minField","maxField","avgField","stddevField"];t=new it,t.outFields=[n],t.outStatistics=[],t.where="1=1",_.forEach(r,function(e,i){var s=new nt;s.statisticType=e,s.onStatisticField=n,s.outStatisticFieldName=a[i],s.displayFieldName=n,t.outStatistics.push(s)},this),this._filteredRowIds.length>0&&(s=this._filteredRowIds),t.where&&s.length>0&&(t.where="("+t.where+") AND ("+this.idProperty+" IN ("+s.toString()+"))"),i=new st(this.featureLayer.url),i.execute(t).then(p.hitch(this,function(e){e.features&&e.features.length&&this._showStatisticsDialog(e,n)}),function(){this.emit("error",{message:this._i18nStrings.errorSelectFeatures})})},_showColumnMenu:function(e){var i=this.grid.cell(e),n=i.column;if(n){var s,r,a,o=this.get("columnMenu"),d=o,l=n.id,h=this.columns[l],u=this._findFirst(this.layerInfo.fieldInfos,"name",h.field),c=u.type;o&&this.set("columnMenu",null);var f=new O({});if(h.sortable!==!1&&(!(this.dataStore instanceof at)||"ft_related-records"!==h.type&&"ft_attachments"!==h.type)){if((this.featureCount<=this.featureLayer.maxRecordCount||this.featureLayer.advancedQueryCapabilities.supportsPagination)&&(s=[this._i18nStrings.sortAsc,this._i18nStrings.sortDesc],r=["iconSortAscending","iconSortDescending"],a=[this._sortAscending,this._sortDescending],_.forEach(s,function(e,t){var i=new E({label:e,iconClass:r[t],baseClass:this.css.menuItem,onClick:p.hitch(this,a[t],l)});f.addChild(i)},this)),this.showStatistics&&this.featureLayer.supportsStatistics&&u&&!u.domain&&-1!==_.indexOf(this._numericFieldTypes,c)){var m=new E({label:this._i18nStrings.statistics,iconClass:"iconTableStatistics",baseClass:this.css.menuItem,onClick:p.hitch(this,this._getColumnStats,l)});f.addChild(m)}if(this.showFieldDetails&&"ft_related-records"!==h.type&&"ft_attachments"!==h.type&&"esriFieldTypeOID"!==u.type&&"esriFieldTypeGUID"!==u.type&&"esriFieldTypeGlobalID"!==u.type&&-1===_.indexOf(this._unsupportedFieldTypes,u.type)){var g=new E({label:this._i18nStrings.showDetailedView,iconClass:"iconProperties",baseClass:this.css.menuItem,onClick:p.hitch(this,function(){this.emit("show-detailed-field-view",{columnId:parseInt(l,10),fieldInfo:u})})});f.addChild(g)}f.startup();var y=i.element.getBoundingClientRect(),b=y.right-y.width,v=y.top+y.height;f._openMyself({target:e.target,delegatedTarget:i,iframe:null,coords:{x:b,y:v}}),t(f,"close",p.hitch(this,function(){d&&(d.destroyRecursive(),d=null)})),this.set("columnMenu",f)}}},_sortAscending:function(e){var t=this._findFirst(this.layerInfo.fieldInfos,"name",this.columns[e].field).type;this.dataStore instanceof at&&(this.set("_orderByFields",[this.columns[e].field+" ASC"]),this._generateStore()),this.grid.set("sort",[{attribute:this.columns[e].field,descending:!1,columnId:e,fieldType:t}]),this.emit("sort",{field:this.columns[e].field,descending:!1,columnId:e})},_sortDescending:function(e){var t=this._findFirst(this.layerInfo.fieldInfos,"name",this.columns[e].field).type;this.dataStore instanceof at&&(this.set("_orderByFields",[this.columns[e].field+" DESC"]),this._generateStore()),this.grid.set("sort",[{attribute:this.columns[e].field,descending:!0,columnId:e,fieldType:t}]),this.emit("sort",{field:this.columns[e].field,descending:!0,columnId:e})},_generateTableMenu:function(){this.gridMenu=new O({className:this.css.optionsMenu});var e=[this._i18nStrings.defaultSort,this._i18nStrings.showSelected,this._i18nStrings.clearSelection],t=[this._defaultSortOrder,this._showSelectedRecords,this._clearSelection];this.map&&this.syncSelection&&(e.push(this._i18nStrings.centerOnSelection),t.push(this._centerOnSelection)),this.gridOptions.columnHider&&(e.push(this._i18nStrings.toggleColumns),t.push(this._showHideColumns)),this.menuFunctions.length>0&&_.forEach(this.menuFunctions,function(i){e.push(i.label),t.push(i.callback)},this),_.forEach(e,function(e,i){var n=new E({label:e,baseClass:this.css.menuItem,onClick:p.hitch(this,t[i])});this.gridMenu.addChild(n)},this),this.gridMenuAnchor=new x({label:b.widgets.geocodeMatch.match.tableOptionsLabel,dropDown:this.gridMenu},this._gridMenuNode),this.gridMenu.startup()},_defaultSortOrder:function(){this.dataStore instanceof at&&(this.set("_orderByFields",null),this._generateStore()),this.grid.set("sort",[{attribute:this._defaultSortField,descending:!1}]),this.emit("sort",{field:this._defaultSortField,descending:!1})},_filterRecordsByIds:function(e){if(e&&e.length>0){if(this.set({_filteredRowIds:e,_gridQuery:!0}),this.dataStore instanceof at){var t=this._generateCacheStore(e);this.grid.set("store",t),this.set("dataStore",t)}else this.grid.set("query",p.hitch(this,function(t){return-1!==_.indexOf(e,t[this.idProperty])?!0:!1}));this.emit("filter",e)}},_showSelectedRecords:function(){this._filterRecordsByIds(this.selectedRowIds)},_centerOnSelection:function(){var e=this.selectedRowIds,t=new it;t.objectIds=e,t.outFields=["*"],this.selectedRows.length>0&&this.selectedRowIds.length>0&&this.featureLayer.queryFeatures(t,p.hitch(this,function(e){this.map.setExtent(this._calcGraphicsExtent(e.features))}))},_clearSelection:function(){this.set("_filteredRowIds",[]),this._gridQuery&&(this.grid.set("query",{}),this.set("_gridQuery",!1)),this.grid.clearSelection(),this._updateGridSelection().then(p.hitch(this,function(){this._updateGridHeaderText(),this.featureLayer.clearSelection()})),this.emit("filter",{})},_showHideColumns:function(){this.grid._toggleColumnHiderMenu()},_roundPos:function(e){return e>=1e3?0:e>=10?2:e>=0?4:6},_generateLinkFromString:function(e){if(e&&"string"==typeof e){var t=e.indexOf("http:");if(-1===t&&(t=e.indexOf("https:")),t>-1&&-1===e.indexOf("href=")){var i=e.indexOf(" ",t);-1===i&&(i=e.length);var n=e.substring(t,i);e=e.substring(0,t)+"<a href='"+n+"' target='_blank'>"+n+"</a>"+e.substring(i,e.length)}}return e||""},_calcGraphicsExtent:function(e){var t,i,n,s,r=e[0].geometry;if(null===r&&1===e.length)return null;for(var a=e.length-1;a>=0;a--)null===e[a].geometry&&e.splice(a,1);t=e[0].geometry,i=t.getExtent(),s=e.length,null===i&&(i=new et(t.x,t.y,t.x,t.y,t.spatialReference));for(var o=1;s>o;o++)r=e[o].geometry,n=r.getExtent(),null===n&&(n=new et(r.x,r.y,r.x,r.y,r.spatialReference)),i=i.union(n);return i},_generateDateFromLocale:function(e,t){var i=this.dateOptions,n=t&&t.dateOptions?t.dateOptions:!1,s=!1,r=!1,a={};return n?("undefined"!=typeof n.datePattern&&n.datePattern!==!1?(a.datePattern=n.datePattern||i.datePattern,s=!0):i&&null!==i.datePattern&&(a.datePattern=i.datePattern,s=n.datePattern===!1?!1:!0),n.timeEnabled||i.timeEnabled?(a.timePattern=n.timePattern||i.timePattern,r="undefined"!=typeof n.timeEnabled?n.timeEnabled:i.timeEnabled):i&&"undefined"!=typeof i.timeEnabled&&null!==i.timePattern&&(a.timePattern=i.timePattern,r=i.timeEnabled)):(i&&null!==i.datePattern&&(a.datePattern=i.datePattern,s=!0),i&&"undefined"!=typeof i.timeEnabled&&null!==i.timePattern&&(a.timePattern=i.timePattern,r=i.timeEnabled)),s&&r?a.selector="date and time":s&&!r?a.selector="date":!s&&r?a.selector="time":a.selecter="date",o.format(new Date(e),a)},_getCombinedDateTime:function(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes(),t.getSeconds())
},_toAttachmentTypeIconClass:function(e){var t=-1,i=e.substr(e.lastIndexOf(".")+1),n=["archive","audioVideo","document","image","other"],s={archive:this.css.attachmentsNodeIconArchive,audioVideo:this.css.attachmentsNodeIconAudioVideo,document:this.css.attachmentsNodeIconDocument,image:this.css.attachmentsNodeIconImage,other:this.css.attachmentsNodeIconOther};return _.some(this._supportedAttachmentTypes,function(e,n){return-1!==e.indexOf(i.toLowerCase())?(t=n,!0):void 0}),s[n[t]?n[t]:"other"]},_parseAttachmentSize:function(e){var t=this._i18nStrings,i=[t.kB,t.MB,t.GB,t.TB],n=1e3,s=-1;if(Math.abs(e)<n)return u.substitute(t.B,{fileSize:e});do e/=n,++s;while(Math.abs(e)>=n&&s<i.length-1);return u.substitute(i[s],{fileSize:e.toFixed(1)})},_isValueEmpty:function(e){return null===e||" "===e||""===e||"undefined"==typeof e},_findFirst:function(e,t,i){var n=_.filter(e,function(e){return e.hasOwnProperty(t)&&e[t]===i});return n[0]||null}});return a("extend-esri")&&p.setObject("dijit.FeatureTable",ht,X),ht});