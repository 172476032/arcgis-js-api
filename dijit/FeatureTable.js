// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define(["../kernel","../lang","./FeatureTable/Grid","./FeatureTable/storeUtils","./FeatureTable/dataUtils","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/aspect","dojo/debounce","dojo/has","dojo/on","dojo/string","dojo/promise/all","dojo/Deferred","dojo/Evented","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/fx","dojo/text!../dijit/FeatureTable/templates/FeatureTable.html","dojo/i18n!../nls/jsapi","dijit/_WidgetBase","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/a11yclick","dijit/Menu","dijit/MenuItem","dgrid/util/misc","dijit/layout/BorderContainer","dijit/layout/TabContainer","dijit/layout/ContentPane","dojo/query!css2","dojo/domReady!"],function(e,t,i,r,s,n,o,a,d,l,h,u,c,f,g,m,y,p,_,w,I,F,C,R,b,S,v,M,D,P,G,H,T){var B=y([C,R,b,S,m],{declaredClass:"esri.dijit.FeatureTable.Grid",baseClass:"esri-feature-table",templateString:I,featureLayer:null,map:null,fieldInfos:null,gridOptions:null,dateOptions:null,editable:!1,editOn:null,hiddenFields:null,outFields:null,menuFunctions:null,batchCount:50,syncSelection:!1,zoomToSelection:!1,showDataTypes:!1,showGridHeader:!0,showGridMenu:!0,showFeatureCount:!0,showColumnHeaderTooltips:!1,showAttachments:!1,showStatistics:!0,showRelatedRecords:!1,showCyclicalRelationships:!1,filterIds:null,showFieldDetails:!1,showColumnHiderButton:!1,loaded:!1,grid:null,layerInfo:null,dataStore:null,columns:null,featureCount:0,idProperty:"id",gridMenu:null,gridMenuAnchor:null,selectedRows:null,selectedRowIds:null,css:{button:"esri-feature-table-button",hidden:"esri-feature-table-hidden",select:"esri-feature-table-select",borderContainer:"esri-feature-table-border-container",contentPane:"esri-feature-table-content-pane",grid:"esri-feature-table-grid",title:"esri-feature-table-title",loadingIndicator:"esri-feature-table-loading-indicator",menu:"esri-feature-table-menu",menuItem:"esri-feature-table-menu-item",menuOptions:"esri-feature-table-menu-options",columnHeader:"esri-feature-table-column-header",columnHeaderTitle:"esri-feature-table-column-header-title",columnHeaderType:"esri-feature-table-column-header-type",columnHeaderClear:"esri-feature-table-column-header-clear",sortAscendingIcon:"esri-icon-ascending",sortDescendingIcon:"esri-icon-descending",filterIcon:"esri-icon-filter",propertiesIcon:"esri-icon-properties",statisticsIcon:"esri-icon-statistics",settingsIcon:"esri-icon-settings",lockedIcon:"esri-icon-locked",lockedIconContainer:"esri-locked-icon-container",downIcon:"esri-icon-down",menuIcon:"esri-icon-menu",closeIcon:"esri-icon-close",optionsMenu:"esri-feature-table-options-menu-container",relatedRecordsCell:"esri-feature-table-related-records-cell",relatedRecordsTitle:"esri-feature-table-related-records-title",relatedRecordsLink:"esri-related-records-link",attachmentsCell:"esri-feature-table-attachments-cell",attachmentsTitle:"esri-feature-table-attachments-title",attachmentsLink:"esri-attachments-link",dialog:"esri-feature-table-dialog",closeButton:"esri-dialog-close-button dijitButton",statisticsTableContainer:"esri-feature-table-statistics",statisticsHeader:"esri-statistics-header",statisticsBreak:"esri-break",statisticsHorizontalBreak:"esri-horizontal-break",statisticsAttrTable:"esri-attribute-table",statisticsAttrName:"esri-attribute-name",statisticsAttrValue:"esri-attribute-value",leftMargin:"esri-feature-table-left-margin"},_i18nStrings:F.widgets.FeatureTable,_layerInfos:null,_fieldInfos:null,_cachedIds:null,_defaultBatchCount:50,_defaultFeatureCount:2e3,_defaultDateOptions:{timeEnabled:!0,dateEnabled:!0,timePattern:null,datePattern:null},_defaultGridOptions:{allowSelectAll:!1,cellNavigation:!0,selectionMode:"extended",pagination:!1,allowTextSelection:!1,pageSizeOptions:[10,25,50],columnHider:!0,columnResizer:!0,pagingDelay:300,keepScrollPosition:!0,queryRowsOverlap:0,sort:{field:"id",descending:!1}},_defaultSort:null,_defaultEditOn:"dblclick, keypress",_orderByFields:null,_showRelatedRecords:!1,_showAttachments:!1,_rollbackInfos:null,_statisticsDialog:null,_attachmentsDialog:null,_columnRules:null,_relatedGridInfos:null,_popupDateFormats:{shortDate:{datePattern:"M/d/y"},shortDateLE:{datePattern:"d/M/y"},longMonthDayYear:{datePattern:"MMMM d, y"},dayShortMonthYear:{datePattern:"d MMM y"},longDate:{datePattern:"EEEE, MMMM d, y",selector:"date"},shortDateShortTime:{datePattern:"M/d/y",timePattern:"h:mm a",timeEnabled:!0},shortDateLEShortTime:{datePattern:"d/M/y",timePattern:"h:mm a",timeEnabled:!0},shortDateShortTime24:{datePattern:"M/d/y",timePattern:"H:mm",timeEnabled:!0},shortDateLEShortTime24:{datePattern:"d/M/y",timePattern:"H:mm",timeEnabled:!0},shortDateLongTime:{datePattern:"M/d/y",timePattern:"h:mm:ss a",timeEnabled:!0},shortDateLELongTime:{datePattern:"d/M/y",timePattern:"h:mm:ss a",timeEnabled:!0},shortDateLongTime24:{datePattern:"M/d/y",timePattern:"H:mm:ss",timeEnabled:!0},shortDateLELongTime24:{datePattern:"d/M/y",timePattern:"H:mm:ss",timeEnabled:!0},longMonthYear:{datePattern:"MMMM y"},shortMonthYear:{datePattern:"MMM y"},year:{datePattern:"y"}},constructor:function(e,t){t&&(this._rowSelectHandler=l(this._rowSelectHandler,0),this._rowDeselectHandler=l(this._rowDeselectHandler,0),this._refreshHandler=l(this._refreshHandler,0))},postMixInProperties:function(){this.inherited(arguments),this.set({columns:[],layerInfo:{},selectedRows:[],selectedRowIds:[],hiddenFields:this.hiddenFields||[],outFields:this.outFields||["*"],fieldInfos:this.fieldInfos||[],menuFunctions:this.menuFunctions||[],gridOptions:p.mixin({},this._defaultGridOptions,this.gridOptions),dateOptions:p.mixin({},this._defaultDateOptions,this.dateOptions),_fieldInfos:[],_cachedIds:[],_columnRules:{},_relatedGridInfos:[]}),h("touch")&&!this.editOn?this.set("editOn",v):this.editOn||this.set("editOn",this._defaultEditOn),this.filterIds&&0===this.filterIds.length&&(this.filterIds=null),this._noDataMessage=this.gridOptions.noDataMessage||this._i18nStrings.noData},startup:function(){this.inherited(arguments);var e=this.featureLayer;return e&&e.loadError?void this._showLoadError():void(this.domNode&&e.loaded?this._setUpDataForMainGrid():this.own(u(e,"load",p.hitch(this,function(){this._setUpDataForMainGrid()})),u(e,"error",p.hitch(this,function(){e.loaded||this._showLoadError()}))))},destroy:function(){this.inherited(arguments),this._statisticsDialog&&this._statisticsDialog.destroy(),this._attachmentsDialog&&this._attachmentsDialog.destroy(),this._grid&&this._grid._destroyColumns()},refresh:function(e){var t,i=e||this._grid,r=this._relatedGridInfos,s=r.length;return i===this._grid&&s>0&&_.forEach(r,function(e,i){t=r[s-1-i],t&&t.grid&&this._removeGrid(t.grid)},this),this._refreshStore({grid:i}).then(function(){i.refresh()})},resize:function(e){this._gridBorderContainerNode.resize();var t=e&&e.resize?e:this._grid;t&&t.resize()},clearSelection:function(e){var t=e||this._grid;t&&t.clearSelection()},getRowDataById:function(e,t){var i=t||this._grid;return i?i.getRowDataById(e):void 0},filterSelectedRecords:function(e,t){var i=t||this._grid,r=i?i.selectedRowIds:[];i&&r&&r.length&&this.filterRecordsByIds(i.selectedRowIds)},filterRecordsByIds:function(e,t){var i,r=t||this._grid;r&&(this.filterIds=e,r.filterIds=e,this._refreshStore({grid:r}),i=e||[],this.emit("filter",{ids:i}))},clearFilter:function(e){var t=e||this._grid;t&&this.filterRecordsByIds(null,t)},getFeatureDataById:function(e){return e instanceof Array?s.queryLayerForFeature({layer:this.featureLayer,id:e}):s.queryLayerForFeatures({layer:this.featureLayer,ids:e})},selectRows:function(e,t,i){var r=i||this._grid;r&&r.selectRows(e,t)},sort:function(e,t,i){var r=i||this._grid,n=s.getOrderByString(e,t);r&&e&&this._sortField(r,{field:e,descending:t,orderByField:[n]})},centerOnSelection:function(e){var t=e||this._grid;return t.centerOnSelection()},_setUpMainGrid:function(e){var t,i=e.layer,r=e.layerInfo,n=this._getCustomFieldInfos(i);t=this._generateGrid({map:this.map,layer:i,layerInfo:r,idProperty:r.idProperty,customFieldInfos:n||this.fieldInfos,defaultSort:this._defaultSort,outFields:this.outFields,hiddenFields:this.hiddenFields,filterIds:this.filterIds,gridOptions:this.gridOptions,dateOptions:this.dateOptions,batchCount:this.batchCount,editable:this.editable,editOn:this.editOn,css:this.css,showAttachments:this._showAttachments,showRelatedRecords:this._showRelatedRecords,showCyclicalRelationships:this.showCyclicalRelationships,showStatistics:this.showStatistics,showFieldDetails:this.showFieldDetails,showGridHeader:this.showGridHeader,showGridMenu:this.showGridMenu,showFeatureCount:this.showFeatureCount,showDataTypes:this.showDataTypes,showColumnHeaderTooltips:this.showColumnHeaderTooltips,showColumnHider:this.showColumnHiderButton,syncSelection:this.syncSelection,menuFunctions:this.menuFunctions,node:this._gridNode}),this.set({_grid:t,grid:t.dGrid,gridMenu:t.optionsMenu,gridMenuAnchor:t.optionsMenuAnchor}),this._wireUpGridEvents(t),t.showLoadingIndicator(),t.updateNoDataMessage(""),t.setHeaderTitle(this._i18nStrings.loadingData),t.resize(),this._setUpColumns({grid:t,layer:i}),s.queryLayerForCount({layer:i,layerInfo:r}).then(p.hitch(this,function(e){t.set("featureCount",e),t.updateHeaderText(),this._generateStore({grid:t,layer:i,layerInfo:r,count:e,filterIds:this.filterIds}).then(p.hitch(this,function(e){t.updateStore(e),t.updateNoDataMessage(this._noDataMessage),this.set({dataStore:e,layerInfo:p.clone(t.layerInfo)}),t.hideLoadingIndicator(),setTimeout(p.hitch(this,function(){this.resize()},200))}))})).otherwise(p.hitch(this,function(){this._showLoadError(),t.updateNoDataMessage(this._noDataMessage)}))},_generateGrid:function(e){var t=new i(e,e.node);return t.startup(),t},_setUpDataForMainGrid:function(){var e,t,i,r,n=this.featureLayer,o=n.objectIdField,a=this.gridOptions,d=this.outFields;this._generateLayerInfo({layer:n,idProperty:o}).then(p.hitch(this,function(l){l.hasRelatedRecords&&(this._showRelatedRecords=!!this.showRelatedRecords),l.hasAttachments&&(this._showAttachments=!!this.showAttachments),t=a.sort&&a.sort.field?s.findFirst(n.fields,"name",a.sort.field):null,e=t&&t.name?t.name:o,i=!(!a.sort||!a.sort.descending),r=s.getOrderByString(e,i),_.forEach(d,function(e,t){var i=s.findFirst(n.fields,"name",e);i||d.splice(t)},this),0===d.length&&d.push("*"),this.set({layerInfo:l,idProperty:o,_orderByFields:[r],_defaultSort:{attribute:e,descending:i}}),this._setUpMainGrid({layer:n,layerInfo:l})}))},_getCustomFieldInfos:function(e){var t,i,r,n,o=this._layerInfos,a=isNaN(e.layerId)||null===e.layerId?null:e.layerId;return!o||s.isValueEmpty(a)?null:(r=o[a]||null,t=r?r.popupInfo:null,i=t?t.fieldInfos:null,n=i?this._updatePopupInfosDateFormat(i):null)},_generateLayerInfo:function(e){var t=new g,i=e.layer,r=e.idProperty,s=i.id||i.layerId,n={idProperty:r,layerId:s,userIds:{}};return i.credential&&(n.userIds[s]=i.credential.userId),n.userId&&(n.userIds[s]=n.userId),n.isFeatureCollection=i._collection&&i._collection===!0||null===i.url&&null===i._url,n.typeIdField=i.typeIdField,n.types=i.types,n.editable=i.isEditable(),n.editCapabilities=i.getEditCapabilities?i.getEditCapabilities():{},n.hasRelatedRecords=i.relationships&&i.relationships.length>0,n.supportsAdvancedQueryRelated=!(!i.advancedQueryCapabilities||!i.advancedQueryCapabilities.supportsAdvancedQueryRelated),n.hasAttachments=i.hasAttachments,n.queryAttachmentsSupported=!0,n=p.clone(n),t.resolve(n),t},_setUpColumns:function(e){var t,i,r,n=e.grid,o=e.layer,a=o.fields,d=o.getOutFields();t=d&&d[0]&&"*"===d[0]?a:_.filter(a,function(e){return-1!==_.indexOf(d,e.name)}),n===this._grid&&"*"!==this.outFields[0]&&(t=_.filter(t,p.hitch(this,function(e){return-1!==_.indexOf(this.outFields,e.name)}))),s.findFirst(t,"name",o.objectIdField)||(i=s.findFirst(a,"name",o.objectIdField),t.unshift(i)),r=n._setUpColumns(t),n===this._grid&&this.set({columns:r.columns,_fieldInfos:r.fieldInfos})},_showLoadError:function(e){var t=e&&e.grid?e.grid:this._grid,i=e&&e.error?e.error:this._i18nStrings.dataError;t&&(t.hideLoadingIndicator(),t.setHeaderTitle(i)),this.emit("error",{message:i})},_wireUpGridEvents:function(e){e&&(e.on("load",p.hitch(this,function(t){e===this._grid&&this.set("loaded",t.loaded),this.emit("load",t.loaded)})),e.on("error",p.hitch(this,function(e){this.emit("error",e)})),e.on("row-select",p.hitch(this,this._rowSelectHandler,e)),e.on("row-deselect",p.hitch(this,this._rowDeselectHandler,e)),e.on("refresh",p.hitch(this,this._refreshHandler,e)),e.on("sort",p.hitch(this,this._sortField,e)),e.on("filter",p.hitch(this,function(e){this.emit("filter",e)})),e.on("column-resize",p.hitch(this,function(e){this.emit("column-resize",e)})),e.on("column-state-change",p.hitch(this,function(e){this.emit("column-state-change",e)})),e.on("editor-show",p.hitch(this,function(e){this.emit("editor-show",e)})),e.on("editor-hide",p.hitch(this,function(e){this.emit("editor-hide",e)})),e.on("data-change",p.hitch(this,function(e){this.emit("data-change",e)})),e.on("edits-complete",p.hitch(this,function(e){this.emit("edits-complete",e)})),e.on("layer-click",p.hitch(this,function(e){this.emit("layer-click",e)})),e.on("layer-selection-complete",p.hitch(this,function(t){e===this._grid&&this.syncSelection&&this._syncSelectionFromLayer({grid:e,features:t.features}),this.emit("layer-selection-complete",t)})),e.on("layer-selection-clear",p.hitch(this,function(t){e===this._grid&&this.syncSelection&&this.clearSelection(),this.emit("layer-selection-clear",t)})),e.on("layer-update-end",p.hitch(this,function(e){this.emit("layer-update-end",e)})),e.on("show-selected-records",p.hitch(this,function(t){this.emit("show-selected-records",{grid:e,ids:t.ids}),this.filterRecordsByIds(t.ids,e)})),e.on("clear-selection",p.hitch(this,function(){this.emit("clear-selection")})),e.on("clear-filter",p.hitch(this,this.clearFilter,e)),e.on("show-statistics",p.hitch(this,function(e){this._statisticsDialog=e.dialog,this.emit("show-statistics",{dialog:e.dialog,statistics:e.statistics})})),e.on("show-attachments",p.hitch(this,function(e){this._attachmentsDialog=e.dialog,this.emit("show-attachments",{featureId:e.featureId,dialog:e.dialog,attachments:e.attachments})})),e.on("show-related-records",p.hitch(this,this._showRelatedRecordsCallback,e)),e.on("show-detailed-field-view",p.hitch(this,this._showDetailedFieldViewCallback,e)))},_wireUpRelatedGridEvents:function(e){var t=e.grid,i=e.parentGrid;t.own(u(i,"row-select",this._updateRelatedGridsHandler.bind(this,e)))},_updateRelatedGridsHandler:function(e,t){var i,r,n,o,a,d,l,h,u,c,f=e.grid,g=e.parentGrid,m=e.relationship,y=this._relatedGridInfos,w=t.rows,I=w[0];I&&(a=parseInt(I.id,10),d=y[y.length-1],l=d?d.grid:null,l&&(h=f===l,i=g.relatedRecordCounts[m.id][a]?g.relatedRecordCounts[m.id][a].count:0,u=s.findFirst(y,"grid",f),c=_.indexOf(y,u),i>0&&I.data?(r=s.findFirst(f.layer.relationships,"id",m.id),h||_.forEach(y,function(e,t){e.grid&&t>=c&&(e.grid.emptyStore(),e.grid.set("featureCount",0),e.grid.updateHeaderText())}),n=m.keyField,o=I.data[n],s.getRelationshipWhereClause({layer:f.layer,originRelationship:m,destinationRelationship:r,keyValue:o}).then(p.hitch(this,function(e){f.set({where:e,featureCount:i}),f.updateHeaderText(),this._refreshStore({grid:f}).then(function(e){h||setTimeout(function(){if(f.store){var e,t,i=f.store.data;e=i?i[Object.keys(i)[0]]:null,e&&(t=e.attributes[f.idProperty],f.selectRows(t,!1))}},600)})}))):h?(f.emptyStore(),f.set("featureCount",0),f.updateHeaderText(),f.refresh()):(f.set("featureCount",0),f.updateHeaderText(),u=s.findFirst(y,"grid",f),c=_.indexOf(y,u),_.forEach(y,function(e,t){var i=e.grid;c>t||(i.emptyStore(),i.set("featureCount",0),i.updateHeaderText(),i.refresh())}))))},_generateStore:function(e){var t=e.grid,i=e.layer,r=e.layerInfo,s=e.store||t.store||null,n=e.where||null,o=e.orderByFields||null,a=e.count||null,d=e.filterIds||null;return s&&t.emptyStore(),r.isFeatureCollection?this._generateStoreForFeatureCollection({grid:t,layer:i,layerInfo:r}):i.advancedQueryCapabilities&&!i.advancedQueryCapabilities.supportsPagination?this._generateStoreForNonPaginatedLayer({grid:t,layer:i,layerInfo:r,where:n,orderByFields:o,count:a,filterIds:d}):this._generateCacheStore({grid:t,where:n,orderByFields:o,count:a,ids:d})},_generateCacheStore:function(e){var i,n,o,a,l,h,u=new g,c=e.grid,f=e.ids,m=e.where,y=e.orderByFields,p=e.count;return i=y?y:c===this._grid?this._orderByFields&&this._orderByFields.length?this._orderByFields:[s.getOrderByString(this._defaultSort.attribute,this._defaultSort.descending)]:null,n=t.isDefined(c.layer.maxRecordCount)?c.layer.maxRecordCount:this._defaultBatchCount,o=Math.min(n,this.batchCount),l=this.showAttachments&&c.layerInfo.hasAttachments,h=this.showRelatedRecords&&c.layerInfo.hasRelatedRecords,a=r.generateCacheStore({grid:c,layer:c.layer,ids:f,where:m,orderByFields:i,count:p,getAttachments:l,getRelatedRecords:h}),d.before(a,"query",function(e,t){c.showLoadingIndicator()}),d.after(a,"query",function(e){return e.then(function(e){e.attachmentInfos?c._updateAttachmentInfos(e.attachmentInfos):c.layerInfo.queryAttachmentsSupported=!1,e.relatedRecordInfos&&(c.layerInfo.supportsAdvancedQueryRelated?c._updateRelatedRecordCounts(e.relatedRecordInfos):c._updateRelatedRecordInfos(e.relatedRecordInfos)),c.hideLoadingIndicator()}).otherwise(function(){c.hideLoadingIndicator()}),e}),u.resolve(a),u},_generateMemoryStore:function(e){var t=e.grid,i=e.features,s=new g,n=r.generateMemoryStore({features:i,idProperty:this.get("idProperty")});return n.query=p.hitch(this,r.generateSort,t.dGrid,n),s.resolve(n),s},_generateStoreForFeatureCollection:function(e){var t=e.grid,i=e.layer;return this._generateMemoryStore({grid:t,features:i.graphics})},_generateStoreForNonPaginatedLayer:function(e){var t=e.grid,i=e.layer,r=e.layerInfo,n=e.where||null,o=e.orderByFields||null,a=e.filterIds||null;return a&&a.length?this._generateCacheStore({grid:t,ids:a,where:n,orderByFields:o}):s.queryLayerForIds({layer:i,idProperty:r.idProperty}).then(p.hitch(this,function(e){return r._cachedIds=e,t.layerInfo.cachedIds=e,this._generateCacheStore({grid:t,ids:e,where:n,orderByFields:o})}))},_refreshStore:function(e){var t=e.grid,i=t.filterIds,r=e.where||t.where||null,n=e.orderByFields,o=t.layer,a=t.layerInfo;return t.showLoadingIndicator(),t.updateNoDataMessage(""),t.setHeaderTitle(this._i18nStrings.loadingData),s.queryLayerForCount({layer:o,layerInfo:a,where:r}).then(p.hitch(this,function(e){return t.set("featureCount",e),t.updateHeaderText(),this._generateStore({grid:t,layer:o,layerInfo:a,orderByFields:n,where:r,count:e,filterIds:i}).then(p.hitch(this,function(e){return t===this._grid&&this.set("dataStore",e),t.updateStore(e),t.hideLoadingIndicator(),e}))})).otherwise(p.hitch(this,function(){return this._showLoadError(),t.updateNoDataMessage(this._noDataMessage),null}))},_setEditableAttr:function(e){this._grid&&this._grid.set("editable",!!e),_.forEach(this._relatedGridInfos,function(t){t.grid.set("editable",!!e)})},_sortField:function(e,t){var i=t.column,r=parseInt(t.id,10),s=t.field,n=t.descending,o=t.orderByFields;e===this._grid&&(this._orderByFields=o),i?e.updateSort([{attribute:s,columnId:r,fieldType:i.type,descending:n}]):e.updateSort([{attribute:s,descending:n}]),this._refreshStore({grid:e,orderByFields:o}).then(p.hitch(this,function(){this.emit("sort",{field:s,descending:n})}))},_rowSelectHandler:function(e,t){this.syncSelection&&this._syncSelectionFromGrid({grid:e,ids:e.selectedRowIds}),e===this._grid&&(this.set({selectedRows:e.selectedRows,selectedRowIds:e.selectedRowIds}),this.emit("row-select",t))},_rowDeselectHandler:function(e,t){var i=e.selectedRows;this.syncSelection&&(i.length>0?this._syncSelectionFromGrid({grid:e,ids:e.selectedRowIds}):e.layer.clearSelection(!0)),e===this._grid&&(this.set({selectedRows:i,selectedRowIds:e.selectedRowIds}),this.emit("row-deselect",t))},_refreshHandler:function(e,t){e===this._grid&&this.emit("refresh",t)},_syncSelectionFromLayer:function(e){var t,i,r,n,o=e.grid||this._grid,a=e.features||[],d=o.idProperty;return 0===a.length?void this.clearSelection():(t=_.map(a,function(e){return e.attributes[d]}),t.sort(),this.selectedRowIds.sort(),i=_.every(this.selectedRowIds,function(e){return-1!==_.indexOf(t,e)},this),r=_.every(t,function(e){return-1!==_.indexOf(this.selectedRowIds,e)},this),void(i&&r||(this.map&&this.zoomToSelection&&a.length>0&&(n=s.calculateExtentFromFeatures(a),this.map.setExtent(n)),this.selectRows(t,!0))))},_syncSelectionFromGrid:function(e){var t,i,r,n,o=e.grid||this._grid,a=o.layer,d=e.ids,l=a.getSelectedFeatures(),h=o.idProperty;t=_.map(l,function(e){return e.attributes[h]}),d.sort(),t.sort(),i=_.every(d,function(e){return-1!==_.indexOf(t,e)},this),r=_.every(t,function(e){return-1!==_.indexOf(d,e)},this),i&&r||s.selectFeaturesById({grid:o,ids:d}).then(p.hitch(this,function(e){this.map&&this.zoomToSelection&&e.length>0&&(n=s.calculateExtentFromFeatures(e),this.map.setExtent(n))}))},_showRelatedRecordsCallback:function(e,t){var i,r,n,o,a=t.columnId,d=t.relationship,l=t.keyFieldValue,h=t.row,u=t.count,c=[];e===this._grid?(n=this._centerPaneNode,o=this._leadingPaneNode):(r=this._relatedGridInfos.length-1,i=this._relatedGridInfos[r],n=i.layout.centerContentPane,o=i.layout.leadingContentPane,this._removeButtonNode(i.closeButton),i.closeButton=null),this._addSmallRelatedRecordsColumn({grid:e,relationship:d}),e.refresh(),e.showFieldDetails=!1,e.showFeatureCount=!1,e.updateHeaderText(),e.hideOptionsMenu(),c=[this._shrinkGrid({grid:e,centerPane:n,leadingPane:o,columnId:a}),this._setUpDataForRelatedGrid({parentGrid:e,relationship:d})],f(c).then(p.hitch(this,function(t){var i,r,o,c=t[1].layer,f=c.objectIdField,g=n;this._addHiddenColumnRules({grid:e,columnId:a}),e.hideColumnHiderButton(),e.updateSelectionMode("single"),e.refresh(),e.selectRows(h[e.idProperty],!0,!0),this._showPane(g),o=this._generateSubLayout(g.domNode),this.resize(),this._generateLayerInfo({layer:c,idProperty:f}).then(p.hitch(this,function(t){this.emit("show-related-records",{grid:e,relationship:d,row:h}),setTimeout(function(){e._scrollToRow(h[e.idProperty])},200),i=s.findFirst(c.relationships,"id",d.id),r=i.keyField,s.getRelationshipWhereClause({layer:c,originRelationship:d,destinationRelationship:i,keyValue:l}).then(p.hitch(this,function(i){this._setUpRelatedGrid({parentGrid:e,layer:c,layerInfo:t,relationship:d,where:i,layout:o,count:u})}))}))}))},_setUpDataForRelatedGrid:function(e){var t=e.parentGrid,i=t.layer,r=e.relationship,s=r.relatedTableId;return this._setUpRelatedLayer({baseLayer:i,layerId:s}).then(function(e){return{layer:e,layerId:s}})},_generateSubLayout:function(e){var t,i,r,s,n=this.css,a=n.borderContainer+" "+n.leftMargin,d=n.contentPane+" "+n.hidden;return t=new G({className:a,gutters:!1,design:"headline"}),i=new T({className:n.contentPane,region:"leading"}),r=new T({className:d,region:"center"}),s=o.create("div",null,i.domNode),t.addChild(i),t.addChild(r),t.placeAt(e),t.startup(),{borderContainer:t,leadingContentPane:i,centerContentPane:r,containerNode:s}},_setUpRelatedGrid:function(e){var t,i,r,n,o,a,d,l,h=this,u=e.layer,c=e.layerInfo,f=c.idProperty,g=e.parentGrid,m=e.relationship,y=e.layout,w=e.where||null,I=e.count||null;return n=_.map(this._relatedGridInfos,function(e){return e.grid.layer.layerId}),n.unshift(this._grid.layer.layerId),r=[{label:this._i18nStrings.close,callback:function(){h._removeGrid(this)}}],t=this._getCustomFieldInfos(u),i=!(!this.showAttachments||!c.hasAttachments),o=this._generateGrid({map:this.map,layer:u,layerInfo:c,idProperty:f,customFieldInfos:t,defaultSort:{attribute:f,descending:!1},outFields:["*"],where:w,gridOptions:this.gridOptions,dateOptions:this.dateOptions,batchCount:this.batchCount,editable:this.editable,editOn:this.editOn,css:this.css,showAttachments:i,showRelatedRecords:!0,showCyclicalRelationships:this.showCyclicalRelationships,showStatistics:this.showStatistics,showFieldDetails:!1,showGridHeader:this.showGridHeader,showGridMenu:this.showGridMenu,showFeatureCount:this.showFeatureCount,showDataTypes:this.showDataTypes,showColumnHeaderTooltips:this.showColumnHeaderTooltips,showColumnHider:this.showColumnHiderButton,menuFunctions:r,showFilterMenuItems:!1,syncSelection:!1,visibleLayerIds:n,node:y.containerNode}),this._wireUpGridEvents(o),this._wireUpRelatedGridEvents({grid:o,parentGrid:g,relationship:m}),o.showLoadingIndicator(),o.updateNoDataMessage(""),o.setHeaderTitle(this._i18nStrings.loadingData),o.resize(),d=this._generateColumnSwitcherButton(g),l=this._generateGridCloseButton(o),this._relatedGridInfos.push({grid:o,parentGrid:g,layout:y,relationship:m,pickerButton:d,closeButton:l}),this._setUpColumns({grid:o,layer:u}),s.isValueEmpty(I)?s.queryLayerForCount({layer:u,layerInfo:c}).then(p.hitch(this,function(e){o.set("featureCount",e),o.updateHeaderText(),this._generateStore({grid:o,layer:u,layout:y,layerInfo:c,where:w,count:e,filterIds:a}).then(p.hitch(this,function(e){o.updateStore(e),o.updateNoDataMessage(this._noDataMessage),o.hideLoadingIndicator()}))})).otherwise(p.hitch(this,function(){this._showLoadError(),o.updateNoDataMessage(this._noDataMessage)})):(o.set("featureCount",I),o.updateHeaderText(),this._generateStore({grid:o,layer:u,layout:y,layerInfo:c,where:w,count:I,filterIds:a}).then(p.hitch(this,function(e){o.updateStore(e),o.updateNoDataMessage(this._noDataMessage),o.hideLoadingIndicator()})).otherwise(p.hitch(this,function(){this._showLoadError(),o.updateNoDataMessage(this._noDataMessage)})),void 0)},_setUpRelatedLayer:function(e){var t=new g,i=e.baseLayer,r=e.layerId,n=s.initFeatureLayer(i,r);return n.loaded?t.resolve(n):u(n,"load",function(){t.resolve(n)}),t},_showPane:function(e){e&&e.domNode&&n.remove(e.domNode,this.css.hidden)},_hidePane:function(e){e&&e.domNode&&n.add(e.domNode,this.css.hidden)},_shrinkGrid:function(e){var t,i=new g,r=e.grid,s=e.leadingPane,n=e.finalWidth||220;return t=w.animateProperty({node:s.id,properties:{width:{start:function(){return s.domNode.getBoundingClientRect().width},end:function(){return n}}}}).play(),u(t,"End",function(){i.resolve(r)}),i},_growGrid:function(e){var t,i,r,s,n=e.grid;this._removeSmallRelatedRecordsColumn(n),this._removeHiddenColumnRules(n),n.showColumnHider&&n.showColumnHiderButton(),n===this._grid?(r=this._centerPaneNode,s=this._leadingPaneNode,n.showFieldDetails=this.showFieldDetails):(t=this._relatedGridInfos.length-1,i=this._relatedGridInfos[t],r=i.layout.centerContentPane,s=i.layout.leadingContentPane,i.closeButton=this._generateGridCloseButton(n)),this._hidePane(r),s.domNode&&a.set(s.domNode,"width","100%"),n.updateSelectionMode(this.gridOptions.selectionMode),n.showFeatureCount=this.showFeatureCount,n.updateHeaderText(),this.showGridMenu&&n.showOptionsMenu(),n.resize(),this.resize()},_removeGrid:function(e){if(e!==this._grid){var t=s.findFirst(this._relatedGridInfos,"grid",e),i=t.parentGrid,r=t.layout.borderContainer,n=t.layout.leadingContentPane,o=t.layout.centerContentPane;this._hidePane(o),n.domNode&&a.set(n.domNode,"width","100%"),this._removeButtonNode(t.pickerButton),this._relatedGridInfos.pop(),e.destroy(),r.destroy(),this._growGrid({grid:i})}},_addHiddenColumnRules:function(e){var t,i=e.grid,r=e.columnId,s=i.getColumns(),n=Object.keys(s),o=[];o=_.map(n,function(e,s){return t=s===r?"display: table-cell;":"display: none;",i.styleColumn(e,t)}),this._columnRules[i.id]=o},_removeHiddenColumnRules:function(e){var t=this._columnRules[e.id];_.forEach(t,function(e){e.remove()}),this._columnRules[e.id]=[]},_addSmallRelatedRecordsColumn:function(e){var t=e.grid,i=e.relationship,r=i.id,s=t.columns,n=t.idProperty;s.push({unhidable:!0,label:"esriRelatedRecordsSmall",field:"esriRelatedRecordsSmall",get:function(e){var i=t._getRelatedRecordsCount({featureId:e[n],relationshipId:r});return c.substitute(t._i18nStrings.parenValue,{value:i})}})},_removeSmallRelatedRecordsColumn:function(e){var t=e.columns,i=t&&t[t.length-1]?t[t.length-1].field:null;"esriRelatedRecordsSmall"===i&&(t.pop(),e.refresh())},_generateGridCloseButton:function(e){var t,i=this.css,r=i.menuItem+" "+i.button+" "+i.closeIcon;return t=o.create("div",{className:r,tabIndex:0}),o.place(t,e._gridTitleNode,"before"),u(t,v,p.hitch(this,function(){this._removeGrid(e)})),t},_generateColumnSwitcherButton:function(e){var t,i=e._gridHeaderNode.domNode,r=this._generateColumnSwitcherMenu(e),s=this.css,n=s.menuItem+" "+s.button+" "+s.downIcon;return t=o.create("div",{className:n,tabIndex:0},i),u(t,v,function(e){r._openMyself({target:e.target,delegatedTarget:t,iframe:null,coords:{x:e.pageX,y:e.pageY}})}),t},_generateColumnSwitcherMenu:function(e){var t,i,r=e.fieldInfos,n=this.css;return t=new M({className:n.optionsMenu}),_.forEach(e.columns,function(o){var a=parseInt(o.id,10),d=s.findFirst(r,"name",o.field),l="esriRelatedRecords"===o.type||"esriRelatedRecordsSmall"===o.field||"esriAttachments"===o.type||"esriFieldTypeGUID"===d.type||"esriFieldTypeGlobalID"===d.type||-1!==_.indexOf(e._unsupportedFieldTypes,d.type)||!!o.hidden;l||(i=new D({label:o.label||o.field,baseClass:n.menuItem}),u(i,v,p.hitch(this,function(){this._removeHiddenColumnRules(e),this._addHiddenColumnRules({grid:e,columnId:a}),this.emit("column-focus-change",{fieldInfo:d,column:o})})),t.addChild(i))},this),t.startup(),t},_removeButtonNode:function(e){e&&e&&e.parentNode&&e.parentNode.removeChild(e)},_showDetailedFieldViewCallback:function(e,t){var i,r=t.columnId,s=t.fieldInfo,n=this._centerPaneNode,o=this._leadingPaneNode,a=o.domNode.getBoundingClientRect().width/6;e.showFeatureCount=!1,e.showFieldDetails=!1,e.updateHeaderText(),e.hideOptionsMenu(),this._shrinkGrid({grid:e,centerPane:n,leadingPane:o,columnId:r,finalWidth:a}).then(p.hitch(this,function(){i=this._generateColumnSwitcherButton(e),this._addHiddenColumnRules({grid:e,columnId:r}),e.hideColumnHiderButton(),e.updateSelectionMode("single"),e.refresh(),this.resize(),this.emit("show-detailed-field-view",{columnId:r,grid:e,fieldInfo:s,pickerButton:i})}))},_updatePopupInfosDateFormat:function(e){return _.forEach(e,function(e){e.format&&e.format.dateFormat&&(e.format.dateFormat=this._popupDateFormats[e.format.dateFormat])},this),e}});return h("extend-esri")&&p.setObject("dijit.FeatureTable",B,e),B});