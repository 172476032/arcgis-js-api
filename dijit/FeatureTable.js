// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
define(["dojo/aspect","dojo/on","dojo/Evented","dojo/has","dojo/number","dojo/string","dojo/dom-construct","dojo/dom-class","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/text!../dijit/FeatureTable/templates/FeatureTable.html","dojo/i18n!../nls/jsapi","dojo/store/Cache","dojo/store/Memory","dojo/store/Observable","dojo/fx/Toggler","dijit/_WidgetBase","dijit/_OnDijitClickMixin","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/Dialog","dijit/Menu","dijit/MenuItem","dijit/form/DropDownButton","dijit/form/TimeTextBox","dijit/form/DateTextBox","dijit/form/Button","dgrid/OnDemandGrid","dgrid/Selection","dgrid/Keyboard","dgrid/editor","dgrid/extensions/DijitRegistry","dgrid/extensions/ColumnHider","dgrid/extensions/ColumnResizer","../kernel","../lang","../config","../Color","../geometry/Extent","../layers/FeatureLayer","../symbols/SimpleMarkerSymbol","../symbols/SimpleLineSymbol","../symbols/SimpleFillSymbol","../symbols/CartographicLineSymbol","../tasks/query","../tasks/StatisticDefinition","../tasks/QueryTask","../dijit/FeatureLayerQueryStore","dijit/layout/BorderContainer","dijit/layout/ContentPane","dojo/query!css2","dojo/domReady!"],function(e,t,i,s,r,a,n,o,d,l,h,u,c,f,g,_,m,y,p,S,b,F,C,w,L,I,T,v,D,M,x,E,H,j,k,N,O,R,G,P,B,A,q,V,z,Q,W,Y,U){var $=d([y,p,S,b,i],{baseClass:"esriFeatureTable",loaded:!1,templateString:u,widgetsInTemplate:!0,i18n:c,map:null,idProperty:"id",columns:[],dataStore:null,grid:null,gridMenu:null,featureLayer:null,dateOptions:{timeEnabled:!1,timePattern:"HH:mm:ss",datePattern:"YYYY-MM-DD"},hiddenFields:[],outFields:["*"],readOnly:!1,noDataMessage:"No Data",allowSelectAll:!1,cellNavigation:!1,selectionMode:"extended",enableLayerClick:!1,enableLayerSelection:!1,_isFeatureCollection:!1,_qStore:null,_mStore:null,_featureSet:null,_orderByFields:null,_layerInfo:{},_editorTrackingInfos:{},_gridHeaderText:"${gridTitle} (${featureCount} features, ${featureSelectedCount} selected)",_featureCount:0,_featureSelectedCount:0,_currentSelectedRows:[],_currentSelectedRowIds:[],_filteredRowIds:[],_gridQuery:!1,_batchCount:0,_defaultBatchCount:25,_defaultFeatureCount:2e3,_toggler:null,constructor:function(e,t){t&&(this.set({gridId:t+"_grid",bcNodeId:t+"_bcNode",gridMenuId:t+"_gridMenu",gridContainerId:t+"_gridContainer",optionNodeId:t+"_optionNode"}),this.StandardGrid=d([H,D,M,x,j,k]))},postCreate:function(){this.inherited(arguments),this._listenerHandles=[]},startup:function(){return this.inherited(arguments),this.featureLayer&&this.featureLayer.loadError?void this._showLoadError(this.featureLayer.loadError.message):void(this.domNode&&this.featureLayer.loaded?this._init():(t(this.featureLayer,"load",l.hitch(this,function(){this._init()})),t(this.featureLayer,"error",l.hitch(this,function(){this._showLoadError(this.featureLayer.loadError?this.featureLayer.loadError.message:"")}))))},destroy:function(){this.inherited(arguments),h.forEach(this._listenerHandles,function(e){e.remove()}),this.map&&(this.map.infoWindow.clearFeatures(),this.map.infoWindow.hide()),this.grid&&(this.grid._destroyColumns(),this.grid.destroy()),this.gridMenu&&this.gridMenu.destroy(),this.statisticsDialog&&this.statisticsDialog.destroy(),this.columnMenu&&this.columnMenu.destroyRecursive(),delete this.columns,delete this._layerInfo},resize:function(){this._resize()},selectRows:function(e){var t,i=[],s=[];if(this.grid.clearSelection(),e[0]&&"esri.Graphic"===e[0].declaredClass&&(h.forEach(e,l.hitch(this,function(e){s.push(e.attributes[this.idProperty])})),e=s),1===e.length){t=e[0];var r=this.dataStore.get(e),a=this.dataStore.data.indexOf(r);this.grid.select(t),this._updateGridSelection(),this._updateGridHeaderText(),this.grid.scrollTo({x:0,y:this.grid.rowHeight*a}),this.grid.row(t).element&&this.grid.row(t).element.scrollIntoView()}else h.forEach(e,l.hitch(this,function(e){i.push(this.dataStore.get(e))})),this._updateGridSelection(),this._updateGridHeaderText()},filterSelectedRecords:function(e){e?this._showSelectedRecords():(this.grid.set("query",{}),this.set("_gridQuery",!1))},clearSelection:function(){this._clearSelection()},_init:function(){this._userIds={};var e=this.featureLayer.id;this.featureLayer.credential&&(this._userIds[e]=this.featureLayer.credential.userId),this._layerInfo.userId&&(this._userIds[e]=this._layerInfo.userId),(this.featureLayer._collection&&this.featureLayer._collection===!0||null===this.featureLayer.url&&null===this.featureLayer._url)&&this.set("_isFeatureCollection",!0),this._layerInfo.isEditable=this.featureLayer.isEditable()?O.isDefined(this._layerInfo.isEditable)?this._layerInfo.isEditable:!0:!1,this._layerInfo.typeIdField=this.featureLayer.typeIdField,this._layerInfo.types=this.featureLayer.types,this._layerInfo._fieldInfo=[],this._getEditingInfo(),this.set("idProperty",this.featureLayer.objectIdField),"*"!==this.outFields[0]&&-1==this.outFields.indexOf(this.idProperty)&&this.outFields.push(this.idProperty),this.grid=this._generateGrid(),this.grid.startup(),this.grid.resize(),this._listenerHandles.push(this._gridSelectCallback(),this._gridDeselectCallback(),this._gridRefreshCallback()),this._createTableMenu(),this._toggler=this._createTableToggle(),this._listenerHandles.push(this._tableToggleClickCallback(),this._columnClickCallback(),this._layerClickCallback(),this._appyEditsCallback()),this.set("loaded",!0),this.emit("load",this.loaded),this.grid.set("noDataMessage",""),this._gridHeaderNode.innerHTML=c.widgets.FeatureTable.loadingData,this._resize(),this._toggleLoadingIndicator(!0),this._createStoreFromDataQuery(),this._setSelectionSymbol()},_getEditingInfo:function(){var e=[];this.featureLayer.editFieldsInfo&&(this.featureLayer.editFieldsInfo.creatorField&&e.push(this.featureLayer.editFieldsInfo.creatorField),this.featureLayer.editFieldsInfo.creationDateField&&e.push(this.featureLayer.editFieldsInfo.creationDateField),this.featureLayer.editFieldsInfo.editorField&&e.push(this.featureLayer.editFieldsInfo.editorField),this.featureLayer.editFieldsInfo.editDateField&&e.push(this.featureLayer.editFieldsInfo.editDateField)),this._editorTrackingInfos[this.featureLayer.id]=e},_generateGrid:function(){this.dataStore=new _(new g({data:null,idProperty:this.idProperty}));var t=new this.StandardGrid({store:this.dataStore,columns:this.columns,noDataMessage:this.noDataMessage,selectionMode:this.selectionMode,allowSelectAll:this.allowSelectAll,cellNavigation:this.cellNavigation},this.gridId);return e.before(t,"removeRow",l.hitch(this,function(e){h.forEach(this.columns.length,l.hitch(this,function(i,s){var r=t.cell(e,s).element,a=(r.contents||r).widget;a&&a.destroyRecursive()}))})),e.after(t,"renderHeader",l.hitch(this,function(){t._sortListener.remove()})),t},_createStoreFromDataQuery:function(){this.dataStore&&(this._toggleLoadingIndicator(!0),this._gridHeaderNode.innerHTML=c.widgets.FeatureTable.loadingData,this.grid.set({store:null,noDataMessage:""}),this.set("dataStore",null)),this._getFeatureCount().then(l.hitch(this,this._queryFeatureLayer))},_getFeatureCount:function(){var e=new Q;return e.returnGeometry=!1,e.returnIdsOnly=!1,e.where="1=1",R.defaults.io.timeout=1e4,this.featureLayer.queryCount(e).then(l.hitch(this,function(e){return R.defaults.io.timeout=6e4,this._featureCount=e,e}),l.hitch(this,function(){return R.defaults.io.timeout=6e4,this.set("_featureCount",this._isFeatureCollection?this.featureLayer.graphics.length:this._defaultFeatureCount),this._featureCount}))},_queryFeatureLayer:function(){if(this._isFeatureCollection)return void this._queryFeatureCollection();var e=new Q;e.where="1=1",e.outFields=this.outFields,e.returnGeometry=!1,this.featureLayer.queryFeatures(e,l.hitch(this,function(e){var t=O.isDefined(this.featureLayer.maxRecordCount)?this.featureLayer.maxRecordCount:1e3;this._batchCount=Math.min(t,this._defaultBatchCount),this._toggleLoadingIndicator(!1),this.grid.set("noDataMessage",this.noDataMessage),this.set("_featureSet",e),this._generateColumnsFromFields(e.fields),this.grid.set("columns",this.columns),this._updateGridHeaderText(),e.exceededTransferLimit?this._generateCacheStore():this._generateMemoryStore(e.features),this._layerInfo._features=e.features,this.grid.set("store",this.dataStore)}),l.hitch(this,function(e){this._showLoadError(e.message)}))},_queryFeatureCollection:function(){this._toggleLoadingIndicator(!1),this.grid.set("noDataMessage",this.noDataMessage),this.set("_featureSet",this.featureLayer.graphics),this._generateColumnsFromFields(this.featureLayer.fields),this.grid.set("columns",this.columns),this._updateGridHeaderText(),this._generateMemoryStore(this.featureLayer.graphics),this._layerInfo._features=this.featureLayer.graphics,this.grid.set("store",this.dataStore)},_generateCacheStore:function(){var e,t,i;e=new U({layer:this.featureLayer,objectIds:null,totalCount:this._featureCount,batchCount:this._batchCount,where:"1=1",orderByFields:this._orderByFields}),t=new g,i=new f(e,t,{}),this.set({_qStore:e,_mStore:t,dataStore:i})},_generateMemoryStore:function(e){var t=[];h.forEach(e,l.hitch(this,function(e){t.push(e.attributes)})),this.dataStore=new _(new g({data:t,idProperty:this.idProperty}))},_generateColumnsFromFields:function(e){var t=[];h.forEach(e,l.hitch(this,function(e,i){var s,r,a,n,o,d,u;s=this._findFirst(this.featureLayer.fields,"name",e.name),r=this._layerInfo.typeIdField&&e.name===this._layerInfo.typeIdField||!1,a=s.domain||!1,n=-1!==h.indexOf(this.hiddenFields,e.name)||"esriFieldTypeOID"===e.type||"esriFieldTypeGlobalID"===e.type||-1!==h.indexOf(this._editorTrackingInfos[this.featureLayer.id],e.name),o=this._layerInfo.isEditable&&this._layerInfo.isEditable&&e.name!==this.idProperty&&this.readOnly===!1,d=s.nullable||!1,u="esriFieldTypeDate"===e.type,this._layerInfo._fieldInfo[i]={idx:i,name:e.name,type:e.type,isDomainField:a,isTypeIdField:r,isHidden:n,isEditable:o,isNullable:d,isDate:u},t.push(u?o?this.dateOptions.timeEnabled?this._generateDateTimeEditorColumn(e,this._layerInfo._fieldInfo[i]):this._generateDateTimeEditorColumn(e,this._layerInfo._fieldInfo[i]):this._generateDateTimeColumn(e,this._layerInfo._fieldInfo[i]):a?{label:e.alias,field:e.name,type:e.type,hidden:n,get:l.hitch(this,function(t){var i=this._findFirst(s.domain.codedValues,"code",t[e.name]);return null!==i?i.name:null})}:r?{label:e.alias,field:e.name,type:e.type,hidden:n,get:l.hitch(this,function(t){var i=this._findFirst(this._layerInfo.types,"id",t[e.name]);return null!==i?i.name:null})}:{label:e.alias,field:e.name,type:e.type,hidden:n,get:l.hitch(this,function(t){var i,s=this._findFirst(this._layerInfo.types,"id",t[this._layerInfo.typeIdField]);return s&&s.domains&&s.domains[e.name]&&s.domains[e.name].codedValues&&(i=this._findFirst(s.domains[e.name].codedValues,"code",t[e.name])),i?i.name:t[e.name]})})})),this.set("columns",t)},_generateDateTimeColumn:function(e,t){var i={label:e.alias,field:e.name,type:e.type,hidden:t.isHidden,get:l.hitch(this,function(t){var i=""===t[e.name]?null:new Date(t[e.name]);return this.dateOptions.timeEnabled||(i=i.toDateString()),i})};return i},_generateDateTimeEditorColumn:function(e,t){var i;return i=this.dateOptions.timeEnabled?{label:e.alias,field:e.name,type:e.type,hidden:t.isHidden,get:l.hitch(this,function(t){return""===t[e.name]?null:new Date(t[e.name])}),renderCell:l.hitch(this,function(e,t,i){var s=new T({value:t,datePattern:this.dateOptions.datePattern});s.placeAt(i);var r=new I({value:t,timePattern:this.dateOptions.timePattern});r.placeAt(i)})}:E({label:e.alias,field:e.name,type:e.type,hidden:t.isHidden,get:l.hitch(this,function(t){return""===t[e.name]?null:new Date(t[e.name])})},T)},_selectFeaturesFromIds:function(e){var t=new Q;return t.returnGeometry=this.map?!0:!1,t.objectIds=e?e:this._currentSelectedRowIds,this.featureLayer.selectFeatures(t,B.SELECTION_NEW)},_updateGridSelection:function(){var e=this.grid.selection,t=[],i=[];for(var s in e)i.push(parseInt(s)),t.push(this.grid.row(parseInt(s)).data);this.set({_currentSelectedRows:t,_currentSelectedRowIds:i,_featureSelectedCount:i.length})},_appyEditsCallback:function(){var e=t(this.featureLayer,"edits-complete",l.hitch(this,function(){this._createStoreFromDataQuery()}));return e},_layerClickCallback:function(){var e=t(this.featureLayer,"click",l.hitch(this,function(e){if(this.enableLayerClick&&e.graphic&&e.graphic.attributes&&e.graphic.attributes[this.idProperty]){this.grid.clearSelection(),this.featureLayer.clearSelection();var t=e.graphic,i=t.attributes[this.idProperty];this._selectFeaturesFromIds([i]).then(l.hitch(this,function(e){if(e.length){if(this.map){var t=this._calcGraphicsExtent(e).getCenter();this.map.centerAt(t).then(function(){h.forEach(e,function(e){e.getDojoShape()&&e.getDojoShape().moveToFront()})})}var s=this.dataStore.get(i),r=this.dataStore.data.indexOf(s);if("undefined"==s||-1==r)return;this.grid.select(i),this._updateGridSelection(),this._updateGridHeaderText(),this.grid.scrollTo({x:0,y:this.grid.rowHeight*r}),this.grid.row(i).element&&this.grid.row(i).element.scrollIntoView()}}))}}));return e},_gridRefreshCallback:function(){var e=t(this.grid,"dgrid-refresh-complete",l.hitch(this,function(e){this.grid.columns[0]&&this.emit("dgrid-refresh-complete",e)}));return e},_gridSelectCallback:function(){var e=t(this.grid,"dgrid-select",l.hitch(this,function(e){this.emit("dgrid-select",e.rows),this._updateGridSelection(),this._updateGridHeaderText(),this.map&&this.enableLayerSelection&&(this.map.infoWindow.clearFeatures(),this.map.infoWindow.hide(),this._selectFeaturesFromIds().then(l.hitch(this,function(e){var t=this._calcGraphicsExtent(e).getCenter();this.map.centerAt(t).then(function(){h.forEach(e,function(e){e.getDojoShape()&&e.getDojoShape().moveToFront()})})})))}));return e},_gridDeselectCallback:function(){var e=t(this.grid,"dgrid-deselect",l.hitch(this,function(e){this.emit("dgrid-deselect",e.rows),this._updateGridSelection(),this._updateGridHeaderText(),this._selectFeaturesFromIds()}));return e},_columnClickCallback:function(){return t(this.grid,".dgrid-header .dgrid-cell:click",l.hitch(this,this._showColumnMenu))},_tableToggleClickCallback:function(){var e=t(this.tableCloseButton,"click",l.hitch(this,function(){this._toggleOpened?(o.remove(this.tableCloseButton,"toggleOpened"),o.add(this.tableCloseButton,"toggleClosed"),this._toggler.hide(),this._gridContainer.domNode.style.display="none",this._resize()):(o.remove(this.tableCloseButton,"toggleClosed"),o.add(this.tableCloseButton,"toggleOpened"),this._toggler.show(),this._gridContainer.domNode.style.display="block",this._resize()),this._toggleOpened=!this._toggleOpened}));return e},_resize:function(){this._bcNode.resize(),this._gridMenu.resize(),this._gridContainer.resize(),this.grid&&this.grid.resize()},_updateGridHeaderText:function(){this._gridHeaderNode.innerHTML=a.substitute(this._gridHeaderText,{gridTitle:this.featureLayer.name||c.widgets.FeatureTable.untitled,featureCount:this._featureCount,featureSelectedCount:this._featureSelectedCount})},_createTableToggle:function(){var e=new m({node:this.gridContainerId});return this._toggleOpened=!0,e},_toggleLoadingIndicator:function(e){this._gridLoadingIndicatorNode.style.display=e?"block":"none"},_showLoadError:function(){this._toggleLoadingIndicator(!1),this._gridHeaderNode.innerHTML=c.widgets.FeatureTable.dataError},_showInfoWindow:function(){},_hideInfoWindow:function(){},_showColumnMenu:function(e){var i,s,r,a,n,o;if(this.columnMenu&&(this.set("_oldColumnMenu",this.columnMenu),this.set("columnMenu",null)),this.columnMenu=new C({}),i=this.grid.cell(e),s=i.column.id,r=this.columns[s].type,a=[c.widgets.FeatureTable.sortAsc,c.widgets.FeatureTable.sortDesc],n=["iconSortAscending","iconSortDescending"],o=[this._sortAscending,this._sortDescending],h.forEach(a,l.hitch(this,function(e,t){var i=new w({label:e,iconClass:n[t],baseClass:"esriFeatureTable_menuItem",onClick:l.hitch(this,o[t],s)});this.columnMenu.addChild(i)})),this.featureLayer.supportsStatistics&&this.featureLayer.fields[s]&&"object"!=typeof this.featureLayer.fields[s].domain&&("esriFieldTypeDouble"===r||"esriFieldTypeSingle"===r||"esriFieldTypeInteger"===r||"esriFieldTypeSmallInteger"===r)){var d=new w({label:c.widgets.FeatureTable.statistics,iconClass:"iconTableStatistics",baseClass:"esriFeatureTable_menuItem",onClick:l.hitch(this,this._getColumnStats,s)});this.columnMenu.addChild(d)}this.columnMenu.startup(),this.columnMenu._openMyself({target:e.target,delegatedTarget:i,iframe:null,coords:{x:e.pageX,y:e.pageY}}),t(this.columnMenu,"close",l.hitch(this,function(){this._oldColumnMenu&&(this._oldColumnMenu.destroyRecursive(),this._oldColumnMenu=null)}))},_sortAscending:function(e){this.dataStore instanceof U&&(this.set("_orderByFields",[this.columns[e].field+" ASC"]),this._createStoreFromDataQuery()),this.grid.set("sort",[{attribute:this.columns[e].field,ascending:!0}])},_sortDescending:function(e){this.dataStore instanceof U&&(this.set("_orderByFields",[this.columns[e].field+" DESC"]),this._createStoreFromDataQuery()),this.grid.set("sort",[{attribute:this.columns[e].field,descending:!0}])},_getColumnStats:function(e){var t,i,s,r,a=this.columns[e].field,n=[];t=new Q,t.outFields=[a],t.outStatistics=[],t.where="1=1",i=["count","sum","min","max","avg","stddev"],s=["countField","sumField","minField","maxField","avgField","stddevField"],h.forEach(i,l.hitch(this,function(e,i){var r=new W;r.statisticType=e,r.onStatisticField=a,r.outStatisticFieldName=s[i],r.displayFieldName=a,t.outStatistics.push(r)})),this._filteredRowIds.length>0&&(n=this._filteredRowIds),t.where&&n.length>0&&(t.where="("+t.where+") AND ("+this.idProperty+" IN ("+n.toString()+"))"),r=new Y(this.featureLayer.url),r.execute(t).then(l.hitch(this,function(e){e.features&&e.features.length&&this._showStatisticsDialog(e,a)}),function(e){console.log("Could not get statistics.",e?e.message:e)})},_showStatisticsDialog:function(e,t){var i,s,a,o,d,l,h,u,f,g=e.features[0].attributes,_={};this.statisticsDialog&&this.statisticsDialog.destroy(),i={pattern:"#,###,###,##0.########"},s=["count","sum","min","max","avg","stddev"],a=["Number of Values","Sum of Values","Minimum","Maximum","Average","Standard Deviation"],o=n.create("div",{className:"esriAGOTableStatistics",innerHTML:""}),n.create("div",{className:"header",innerHTML:"Field: "+t},o),n.create("div",{className:"hzLine",innerHTML:""},o),d=n.create("table",{className:"attrTable",innerHTML:"",style:{cellpadding:0,cellspacing:0}},o);for(var m in g)g.hasOwnProperty(m)&&(_[m.toLowerCase()]=g[m]);l=n.create("tbody",{},d),h=n.create("tr",{valign:"top"},l),n.create("td",{"class":"attrName",innerHTML:a[0]},h),n.create("td",{"class":"attrValue",innerHTML:O.isDefined(_.countfield)?r.format(_.countfield,i):""},h),h=n.create("tr",{valign:"top"},l),n.create("td",{"class":"attrName",innerHTML:a[1]},h),n.create("td",{"class":"attrValue",innerHTML:O.isDefined(_.sumfield)?r.format(_.sumfield,i):""},h),h=n.create("tr",{valign:"top"},l),n.create("td",{"class":"attrName",innerHTML:a[2]},h),n.create("td",{"class":"attrValue",innerHTML:O.isDefined(_.minfield)?r.format(_.minfield,i):""},h),h=n.create("tr",{valign:"top"},l),n.create("td",{"class":"attrName",innerHTML:a[3]},h),n.create("td",{"class":"attrValue",innerHTML:O.isDefined(_.maxfield)?r.format(_.maxfield,i):""},h),h=n.create("tr",{valign:"top"},l),n.create("td",{"class":"attrName",innerHTML:a[4]},h),n.create("td",{"class":"attrValue",innerHTML:O.isDefined(_.avgfield)?r.format(r.round(_.avgfield,this._roundPos(_.avgfield)),i):""},h),h=n.create("tr",{valign:"top"},l),n.create("td",{"class":"attrName",innerHTML:a[5]},h),n.create("td",{"class":"attrValue",innerHTML:O.isDefined(_.stddevfield)?r.format(r.round(_.stddevfield,this._roundPos(_.stddevfield)),i):""},h),n.create("div",{className:"break",innerHTML:""},o),this.statisticsDialog=new F({title:c.widgets.FeatureTable.statistics,content:o,baseClass:"esriFeatureTable_dialog"}),u=n.create("button",{type:"button"},this.statisticsDialog.containerNode);var y=this;f=new v({label:c.widgets.FeatureTable.close,baseClass:"primary dijitButton",onClick:function(){var e=y.statisticsDialog;e.hide().then(function(){e.destroyRecursive()})}},u),this.statisticsDialog.show()},_createTableMenu:function(){this.gridMenu=new C({});var e=[c.widgets.FeatureTable.defaultSort,c.widgets.FeatureTable.showSelected,c.widgets.FeatureTable.clearSelection,c.widgets.FeatureTable.toggleColumns],t=[this._defaultSortOrder,this._showSelectedRecords,this._clearSelection,this._showHideColumns];this.map&&this.enableLayerClick&&(e.push("Center on Selection"),t.push(this._centerOnSelection)),this._externalMenuFunctions&&h.forEach(this._externalMenuFunctions,l.hitch(this,function(i){e.push(i.label),t.push(i.functionReference)})),h.forEach(e,l.hitch(this,function(e,i){var s=new w({label:e,baseClass:"esriFeatureTable_menuItem",onClick:l.hitch(this,t[i])});this.gridMenu.addChild(s)}));new L({label:c.widgets.geocodeMatch.match.tableOptionsLabel,dropDown:this.gridMenu},this.optionNodeId);this.gridMenu.startup()},_defaultSortOrder:function(){this.dataStore instanceof U&&(this.set("_orderByFields",null),this._createStoreFromDataQuery()),this.grid.set("sort",[{attribute:this.idProperty,ascending:!0}])},_filterRows:function(){},_showSelectedRecords:function(){var e=this._filteredRowIds=this._currentSelectedRowIds;e&&e.length>0&&(this.dataStore instanceof U?console.log("Unable to show current selection <beta>."):(this.grid.set("query",l.hitch(this,function(t){return~e.indexOf(t[this.idProperty])?!0:!1})),this._gridQuery=!0))},_centerOnSelection:function(){var e=this._currentSelectedRowIds,t=new Q;t.objectIds=e,t.outFields=["*"],this._currentSelectedRows.length>0&&this._currentSelectedRowIds.length>0&&this.featureLayer.queryFeatures(t,l.hitch(this,function(e){this.map.setExtent(this._calcGraphicsExtent(e.features))}))},_clearSelection:function(){this.set("_filteredRowIds",[]),this._gridQuery&&(this.grid.set("query",{}),this.set("_gridQuery",!1)),this.grid.clearSelection(),this._updateGridSelection(),this._updateGridHeaderText(),this.featureLayer.clearSelection(),this.map&&(this.map.infoWindow.clearFeatures(),this.map.infoWindow.hide())},_deleteSelectedFeatures:function(){},_showAttachments:function(){},_showHideColumns:function(){this.grid._toggleColumnHiderMenu()},_exportToCSV:function(){},_roundPos:function(e){return e>=1e3?0:e>=10?2:e>=0?4:6},_calcGraphicsExtent:function(e){var t,i,s=e[0].geometry,r=s.getExtent(),a=e.length;for(null===r&&(r=new P(s.x,s.y,s.x,s.y,s.spatialReference)),i=1;a>i;i++)s=e[i].geometry,t=s.getExtent(),null===t&&(t=new P(s.x,s.y,s.x,s.y,s.spatialReference)),r=r.union(t);return r},_setSelectionSymbol:function(){var e=this.featureLayer;if(!e.getSelectionSymbol())if("esriGeometryPoint"===e.geometryType){var t=new A;t.setStyle(A.STYLE_TARGET),t._setDim(16,16,0),t.setOutline(new z(q.STYLE_SOLID,new G([0,255,255]),2,z.CAP_ROUND,z.JOIN_ROUND)),t.setColor(new G([0,0,0,0])),e.setSelectionSymbol(t)}else e.setSelectionSymbol("esriGeometryPolyline"===e.geometryType?q(q.STYLE_SOLID,new G([0,255,255]),2):new V(V.STYLE_NULL,new q(q.STYLE_SOLID,new G([0,255,255]),2),new G([0,0,0,0])))},_findFirst:function(e,t,i){var s=h.filter(e,function(e){return e.hasOwnProperty(t)&&e[t]===i});return s&&s.length?s[0]:null}});return s("extend-esri")&&l.setObject("dijit.FeatureTable",$,N),$});