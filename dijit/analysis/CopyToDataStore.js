// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","dojo/aspect","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/Color","dojo/_base/connect","dojo/_base/json","dojo/has","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/Button","dijit/form/CheckBox","dijit/form/Form","dijit/form/Select","dijit/form/TextBox","dijit/form/ToggleButton","dijit/form/ValidationTextBox","dijit/layout/ContentPane","dijit/form/FilteringSelect","dijit/Dialog","../../kernel","../../lang","../../layers/FeatureLayer","./AnalysisBase","./utils","./CreditEstimator","./ExpressionForm","../../geometry/Extent","../../geometry/ScreenPoint","../../symbols/CartographicLineSymbol","../../symbols/SimpleMarkerSymbol","../../symbols/SimpleLineSymbol","../../symbols/SimpleFillSymbol","../../tasks/query","../../renderers/jsonUtils","./_AnalysisOptions","dojo/i18n!../../nls/jsapi","dojo/text!./templates/CopyToDataStore.html"],function(e,t,i,s,n,r,a,o,l,h,u,p,c,y,d,m,L,_,f,b,x,S,g,C,w,F,j,I,A,v,D,T,E,N,O,k,M,B,Q,R,H,P,U,G,q,J,Y,z,V,W){var K=i([L,_,f,b,x,z,k],{declaredClass:"esri.dijit.analysis.CopyToDataStore",templateString:W,widgetsInTemplate:!0,inputLayer:null,outputLayerName:null,i18n:null,toolName:"CopyToDataStore",helpFileName:"CopyToDataStore",resultParameter:"output",primaryActionButttonClass:"esriAnalysisSubmitButton",_isAttrFlag:!1,selectionLayer:null,constructor:function(e){this._pbConnects=[],this._statsRows=[],e.containerNode&&(this.container=e.containerNode),this._expression=null},destroy:function(){this.inherited(arguments),n.forEach(this._pbConnects,a.disconnect),delete this._pbConnects},postMixInProperties:function(){this.inherited(arguments),s.mixin(this.i18n,V.copytoDatastoreTool),s.mixin(this.i18n,V.expressionGrid)},postCreate:function(){this.inherited(arguments),m.add(this._form.domNode,"esriSimpleForm"),this._outputLayerInput.set("validator",s.hitch(this,this.validateServiceName)),this._buildUI()},startup:function(){},_onClose:function(e){this._aspectHandle&&(this._aspectHandle.remove(),this._aspectHandle=null),e&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:e}),this.selectionLayer&&(this.selectionLayer.clearSelection(),this.map.removeLayer(this.selectionLayer),this.selectionLayer=null),this._mapClickHandle&&delete this._mapClickHandle},clear:function(){this.selectionLayer&&(this.selectionLayer.clearSelection(),this.map.removeLayer(this.selectionLayer),this.selectionLayer=null),this._mapClickHandle&&delete this._mapClickHandle},_buildJobParams:function(){var e,t={},i=this.constructAnalysisInputLyrObj(this.inputLayer,!0);return this.inputLayer.type&&(this.doRefreshItem="table"!==this.inputLayer.type.toLowerCase()),this.get("inputQuery")&&(i.filter=i.filter?i.filter+" AND "+this.inputQuery:this.inputQuery,this._expression&&this._expression.expression&&(t.attributeExprObj=o.toJson(this._expression.expression._attributeExprObj))),t.inputLayer=i,this.returnFeatureCollection||(t.OutputName=o.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}})),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(t.context=o.toJson({extent:this.map.extent._normalize(!0)})),this.returnFeatureCollection&&(e={outSR:this.map.spatialReference},this.showChooseExtent&&this._useExtentCheck.get("checked")&&(e.extent=this.map.extent._normalize(!0)),t.context=o.toJson(e)),t},_handleSaveBtnClick:function(){var e={};this._form.validate()&&(this._saveBtn.set("disabled",!0),e.jobParams=this._buildJobParams(),this.showGeoAnalyticsParams&&this._datastoreSelect&&(e.isSpatioTemporalDataStore="BDS"===this._datastoreSelect.get("value")),e.itemParams={description:u.substitute(this.i18n.itemDescription,{inputLayerName:this.inputLayer.name}),tags:u.substitute(this.i18n.itemTags,{inputLayerName:this.inputLayer.name}),snippet:this.i18n.itemSnippet},this.showSelectFolder&&(e.itemParams.folder=this.get("folderId")),this.execute(e))},_handleShowCreditsClick:function(e){e.preventDefault(),this._form.validate()&&this.getCreditsEstimate(this.toolName,this._buildJobParams()).then(s.hitch(this,function(e){this._usageForm.set("content",e),this._usageDialog.show()}))},_handleBrowseItemsSelect:function(e){e&&e.selection&&M.addAnalysisReadyLayer({item:e.selection,layers:this._isAnalysisSelect?this.inputLayers:this.polygonLayers,layersSelect:this._isAnalysisSelect?this._analysisSelect:this._layersSelect,browseDialog:e.dialog||this._browsedlg,widget:this}).always(s.hitch(this,this._updateAnalysisLayerUI,!0))},_save:function(){},_buildUI:function(){var e=!0;M.initHelpLinks(this.domNode,this.showHelp),this.get("showSelectAnalysisLayer")&&(this.inputLayers&&this.inputLayer&&!M.isLayerInLayers(this.inputLayer,this.inputLayers)&&this.inputLayers.push(this.inputLayer),!this.get("inputLayer")&&this.get("inputLayers")&&this.set("inputLayer",this.inputLayers[0]),M.populateAnalysisLayers(this,"inputLayer","inputLayers")),M.addReadyToUseLayerOption(this,[this._analysisSelect]),this.outputLayerName&&(this._outputLayerInput.set("value",this.outputLayerName),e=!1),N.isDefined(this.isSpatioTemporalDataStore)&&this._datastoreSelect.set("value",this.isSpatioTemporalDataStore?"BDS":"GDB"),p.set(this._chooseFolderRow,"display",this.showSelectFolder===!0?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(s.hitch(this,function(e){this.folderStore=e,M.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})),p.set(this._showCreditsLink,"display",this.showCredits===!0?"block":"none"),this._selectBtn.set("disabled",0===this.inputLayers.length),this._queryBtn.set("disabled",0===this.inputLayers.length),this._updateAnalysisLayerUI(e),this._loadConnections()},_loadConnections:function(){this.on("start",s.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",s.hitch(this,"_onClose",!1)),this._expressionForm.on("add-expression",s.hitch(this,this._handleExpressionFormAdd)),this._expressionForm.on("cancel-expression",s.hitch(this,this._handleExpressionFormCancel))},_handleAnalysisLayerChange:function(e){var t;"browse"===e?(this._isAnalysisSelect=!0,this._browsedlg.show()):"browselayers"===e?(this.showGeoAnalyticsParams&&(t=this._browseLyrsdlg.browseItems.get("query"),t.types.push('type:"Big Data File Share"'),this._browseLyrsdlg.browseItems.set("query",t),this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!1,this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!0),this._isAnalysisSelect=!0,this._browseLyrsdlg.show()):(this.inputLayer=this.inputLayers[e],this.inputQuery&&(this.clear(),this.set("inputQuery",null),this._expression=null,c.set(this._filterLabel,"innerHTML","")),this._updateAnalysisLayerUI(!0))},_updateAnalysisLayerUI:function(e){var t=this.inputLayer&&"featureClass"===this.inputLayer.type;if(this.inputLayer){e&&(this.outputLayerName=u.substitute(this.i18n.outputLayerName,{inputLayerName:this.inputLayer.name}),this._outputLayerInput.set("value",this.outputLayerName));var i="featureClass"===this.inputLayer.type||"table"===this.inputLayer.type;i||this.set("selectionLayer"),e||(this.inputLayer&&this.inputLayer.filter&&-1!==this.inputLayer.filter.indexOf(" AND ")?(this.set("inputQuery",this.inputLayer.filter.substring(this.inputLayer.filter.indexOf(" AND ")+" AND ".length)),c.set(this._filterLabel,"innerHTML",u.trim(this.inputQuery)),t||this.inputLayer.setDefinitionExpression(this.inputLayer.filter.substring(0,this.inputLayer.filter.indexOf(" AND ")))):this.inputLayer&&this.inputLayer.filter&&-1===this.inputLayer.filter.indexOf(" AND ")&&(this.set("inputQuery",this.inputLayer.filter),c.set(this._filterLabel,"innerHTML",u.trim(this.inputQuery)),t||this.inputLayer.setDefinitionExpression(null)),this.inputQuery&&!e&&(this._isAttrFlag=!0,this._expression={action:"add",expression:{layer:0,where:this.inputQuery,_attributeText:this.inputQuery,_attributeExprObj:this.attributeExprObj}})),this._selectBtn.set("disabled",i),this._queryBtn.set("disabled",0===this.inputLayers.length),this._expressionForm.set("showUnique",!i),this._expressionForm.set("showFirstRow",!1),this._expressionForm.set("firstOperands",[this.inputLayer]),this._expressionForm.set("inputOperands",[this.inputLayer]),this._expressionForm.set("selectedFirstOperand",this.inputLayer),this._expressionForm.init()}},_handleQueryButtonClick:function(){this._expDialog.set("title",this.i18n.query),this._selectBtn.set("checked",!1),this._isAttrFlag=!0;var e=this.inputLayer&&("featureClass"===this.inputLayer.type||"table"===this.inputLayer.type);this._expressionForm.set("showUnique",!e),this._expression?(this._expressionForm.set("action","edit"),this._expressionForm.set("expression",this._expression.expression)):this._expressionForm.set("action","add"),this._expDialog.show()},_handleExpressionFormAdd:function(e){if(this.selectionLayer&&this.selectionLayer.clearSelection(),"add"===e.action||"edit"===e.action){c.set(this._filterLabel,"innerHTML",u.trim(e.expression._attributeText)),this._expression=e;var t;t=new J,t.returnGeometry=!0,t.where=e.expression.where,this.selectionLayer&&this.selectionLayer.selectFeatures(t,O.SELECTION_ADD)}this._expDialog.hide(),this.set("inputQuery",e.expression.where)},_handleExpressionFormCancel:function(){this._expDialog.hide()},_setAnalysisGpServerAttr:function(e){e&&(this.analysisGpServer=e,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},_setInputLayerAttr:function(e){this.inputLayer=e},_setDisableRunAnalysisAttr:function(e){this._saveBtn.set("disabled",e)},validateServiceName:function(e){return M.validateServiceName(e,{textInput:this._outputLayerInput})},_setInputLayersAttr:function(e){N.isDefined(e)&&(this.inputLayers=e)},_setInputQueryAttr:function(e){this.inputQuery=e},_getInputQueryAttr:function(){return this.inputQuery},_setSelectionLayerAttr:function(){this.get("inputLayer")&&(this.selectionLayer=new O(this.inputLayer.url&&!this.inputLayer._collection?this.inputLayer.url:this.inputLayer.toJson(),{outFields:["*"],mode:this.inputLayer.url&&!this.inputLayer._collection?O.MODE_SELECTION:O.MODE_SNAPSHOT}),this.selectionLayer.setRenderer(null),this.selectionLayer.on("selection-complete",s.hitch(this,this._handleInputLayerSelectionComplete)),this.selectionLayer.loaded?this._onSelectionLayerLoad(this.inputLayer,this.selectionLayer):this.selectionLayer.on("load",s.hitch(this,this._onSelectionLayerLoad,this.inputLayer,this.selectionLayer)))},_onSelectionLayerLoad:function(e,t){var i;if(e.renderer&&(t.setRenderer(Y.fromJson(e.renderer.toJson())),N.isDefined(e.renderer.isMaxInclusive)&&(t.renderer.isMaxInclusive=e.renderer.isMaxInclusive)),t.setScaleRange(e.minScale,e.maxScale),this._connect(e,"onScaleRangeChange",s.hitch(this,function(e,t){e.setScaleRange(t.minScale,t.maxScale)},t,e)),this.map.addLayer(t),"esriGeometryPoint"===t.geometryType||"esriGeometryMultPoint"===t.geometryType?(i=new U,i.setStyle(U.STYLE_TARGET),i._setDim(16,16,0),i.setOutline(new P(G.STYLE_SOLID,new r([0,255,255]),2,P.CAP_ROUND,P.JOIN_ROUND)),i.setColor(new r([0,0,0,0])),t.setSelectionSymbol(i)):"esriGeometryPolyline"===t.geometryType?t.setSelectionSymbol(new G(G.STYLE_SOLID,new r([0,255,255]),2)):"esriGeometryPolygon"===t.geometryType&&t.setSelectionSymbol(new q(q.STYLE_NULL,new G(G.STYLE_SOLID,new r([0,255,255]),2),new r([0,0,0,0]))),this.selectionLayer&&this.inputQuery){this.inputQuery.match(/ OR /g)?this._isAttrFlag=!1:(this._isAttrFlag=!0,c.set(this._filterLabel,"innerHTML",u.trim(this.inputQuery)),this._expression={action:"edit",expression:{layer:0,where:this.inputQuery,_attributeText:this.inputQuery,_attributeExprObj:this.attributeExprObj}});var n=new J;n.returnGeometry=!0,n.where=this.inputQuery,this.selectionLayer.selectFeatures(n,O.SELECTION_ADD)}},_connect:function(e,t,i){this._pbConnects.push(a.connect(e,t,i))},_handleSelectionButtonClick:function(e){e&&!this._mapClickHandle?(this._mapClickHandle=this.map.on("click",s.hitch(this,this._handleMapClick)),this.emit("selecttool-activate",{}),this._isAttrFlag=!1):(this._mapClickHandle.remove(),this._mapClickHandle=null,this.emit("selecttool-deactivate",{}))},_handleMapClick:function(e){var t,i,r,a,o,l,h,u;!this._isAttrFlag&&this._expression&&this.selectionLayer.clearSelection(),i=6,h=this.inputLayer.renderer,h&&"esri.renderer.SimpleRenderer"===h.declaredClass?(u=h.symbol,u.xoffset&&(i=Math.max(i,Math.abs(u.xoffset))),u.yoffset&&(i=Math.max(i,Math.abs(u.yoffset)))):!h||"esri.renderer.UniqueValueRenderer"!==h.declaredClass&&"esri.renderer.ClassBreaksRenderer"!==h.declaredClass||n.forEach(h.infos,function(e){u=e.symbol,u.xoffset&&(i=Math.max(i,Math.abs(u.xoffset))),u.yoffset&&(i=Math.max(i,Math.abs(u.yoffset)))}),t=e.screenPoint,r=this.map.toMap(new H(t.x-i,t.y+i)),a=this.map.toMap(new H(t.x+i,t.y-i)),o=new R(r.x,r.y,a.x,a.y,this.map.spatialReference),l=new J,l.returnGeometry=!0,l.geometry=o,l.where=this.inputLayer.getDefinitionExpression(),this.inputLayer.queryFeatures(l).then(s.hitch(this,function(e){if(e){var t,i,s,r;r=[],t=[],this.selectionLayer&&this.selectionLayer.getSelectedFeatures().length>0&&(s=n.map(this.selectionLayer.getSelectedFeatures(),function(e){return e.attributes[this.selectionLayer.objectIdField]},this)),n.forEach(e.features,function(e){s?s&&-1===n.indexOf(s,e.attributes[this.selectionLayer.objectIdField])?t.push(e.attributes[this.selectionLayer.objectIdField]):r.push(e.attributes[this.selectionLayer.objectIdField]):t.push(e.attributes[this.selectionLayer.objectIdField])},this),t.length>0&&(i=new J,i.returnGeometry=!0,i.objectIds=t,this.selectionLayer.selectFeatures(i,O.SELECTION_ADD)),r.length>0&&(i=new J,i.returnGeometry=!0,i.objectIds=r,this.selectionLayer.selectFeatures(i,O.SELECTION_SUBTRACT))}}))},_handleInputLayerSelectionComplete:function(e){var t,i,s=this.selectionLayer.getSelectedFeatures();!this._isAttrFlag&&s.length>0&&(i="",t=n.map(s,function(e){return i+=this.selectionLayer.objectIdField+" = "+e.attributes[this.selectionLayer.objectIdField]+" OR ",e.attributes[this.selectionLayer.objectIdField]},this),i=i.substring(0,i.lastIndexOf(" OR ")),c.set(this._filterLabel,"innerHTML",u.substitute(this.i18n.selectedFeaturesLabel,{total:s.length})),this.set("inputQuery",i),this._expression=null),this._isAttrFlag||0!==s.length||(c.set(this._filterLabel,"innerHTML",""),this.set("inputQuery",null),this._expression=null)}});return l("extend-esri")&&s.setObject("dijit.analysis.CopyToDataStore",K,E),K});