// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/has","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/NodeList","dojo/NodeList-dom","dojo/on","dojo/Deferred","dojo/promise/all","dojo/Evented","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/Button","dijit/form/CheckBox","dijit/form/Form","dijit/form/Select","dijit/form/TextBox","dijit/form/ValidationTextBox","dijit/layout/ContentPane","dijit/form/FilteringSelect","dijit/form/RadioButton","dijit/form/DateTextBox","dijit/form/NumberTextBox","dijit/form/TimeTextBox","dijit/Dialog","dijit/InlineEditBox","./_Widget","./AnalysisBase","./_AnalysisOptions","./GPWidgetViewModel","./customgp/editorManager","./customgp/resultRendererManager","./customgp/common/dijit/Message","../../kernel","../../lang","../../tasks/Geoprocessor","../../tasks/GPMessage","../../tasks/JobInfo","../../layers/ImageParameters","../../graphicsUtils","dojo/i18n!../../nls/jsapi","dojo/i18n!./customgp/common/nls/main","dojo/i18n!./customgp/nls/strings","dojo/text!./templates/GPWidget.html"],function(e,t,i,s,a,o,n,r,l,h,u,d,c,p,m,g,f,v,_,j,M,b,y,I,w,P,N,R,T,x,L,S,E,C,G,B,D,A,O,U,W,k,F,H,J,V,q,Y,z,K,Q,X,Z,$,ee,te,ie,se){var ae=W.createSubclass([b,y,I,w,j,F],{declaredClass:"esri.dijit.analysis.GPWidget",templateString:se,widgetsInTemplate:!0,viewModelType:H,i18n:null,toolName:"GPWidget",helpFileName:"GPWidget",constructor:function(e){e.containerNode&&(this.container=e.containerNode)},destroy:function(){this._clearLastInput(),this._clearLastResult(),this._clearMessageInterval(),this.inherited(arguments)},_onClose:function(e){e||(this._clearLastInput(),this._clearLastResult(),this._clearMessageInterval())},postMixInProperties:function(){this.inherited(arguments),this.i18n={},i.mixin(this.i18n,ee.common),i.mixin(this.i18n,ee.analysisTools),i.mixin(this.i18n,ee.analysisMsgCodes),i.mixin(this.i18n,ee.analysisSettings),i.mixin(this.i18n,ee.aggregatePointsTool),i.mixin(this.i18n,te.common),i.mixin(this.i18n,te.units),i.mixin(this.i18n,ie),this._initModelWatchers()},postCreate:function(){this.inherited(arguments),this._loadConnections(),this.renderUI()},_loadConnections:function(){a.connect(this._closeBtn,"onclick",i.hitch(this,this._onClose,!1)),this.own(this.on("start",i.hitch(this,this._onClose,!0)))},startup:function(){},renderUI:function(){J.setMap(this.viewModel.map),J.setNls(this.i18n),V.setMap(this.viewModel.map),V.setNls(this.i18n),this.viewModel.title&&this._updateTitle(),this.viewModel.inputParams&&this._createInputNodes(),this.viewModel.taskUrl&&this._setUpGP()},_initModelWatchers:function(){this.own(this.viewModel.watch("title",i.hitch(this,this._updateTitle)),this.viewModel.watch("inputParams",i.hitch(this,this._createInputNodes)),this.viewModel.watch("taskUrl",i.hitch(this,this._setUpGP)))},_setUpGP:function(){this.gp=new K(this.viewModel.taskUrl),this.gp.setOutSpatialReference(this.viewModel.map.spatialReference),this.own(f(this.gp,"execute-complete",i.hitch(this,this.onExecuteComplete))),this.own(f(this.gp,"job-complete",i.hitch(this,this.onJobComplete))),this.own(f(this.gp,"job-cancel",i.hitch(this,this.onJobCancel))),this.own(f(this.gp,"status-update",i.hitch(this,this.onStatusUpdate))),this.own(f(this.gp,"get-result-data-complete",i.hitch(this,this.onGetResultDataComplate))),this.own(f(this.gp,"get-result-image-layer-complete",i.hitch(this,this.onGetResultImageLayerComplete))),this.own(f(this.gp,"error",i.hitch(this,this.onError)))},_createInputNodes:function(){this.inputNodes&&this.inputNodes.length>0&&s.forEach(this.inputNodes,function(e,t){d.destroy(e)},this),this.inputNodes=[],this.drawnLayers=[],s.forEach(this.viewModel.inputParams,function(e,t){this._createInputNode(e,t)},this)},_createInputNode:function(e,t){var i=d.create("div",{"class":"esriAnalysisPadding1"},this.inputSectionNode),s=d.create("div",{"class":"esriAnalysisStepsLabel",title:e.tooltip||e.label||""},i);d.create("span",{"class":"esriTrailingMargin025 esriAnalysisNumberLabel",innerHTML:t+1+""},s),d.create("span",{"class":"",innerHTML:e.label},s),e.required&&d.create("span",{"class":"label-star",innerHTML:"*"},s);var a=d.create("div",{"class":"esriLeadingMargin1"},i),o=J.createEditor(e,"input","widget",{uid:this.id,config:this.viewModel});return o.placeAt(a),"SelectFeatureSetFromDraw"===o.editorName&&this.drawTools.push(o.drawBox),i.param=e,i.inputEditor=o,this.inputNodes.push(i),e.visible===!1&&h.set(i,"display","none"),i},_handleSaveBtnClick:function(){this._form.validate()&&(this.set("disableRunAnalysis",!0),this._clearLastResult(),this._getInputParamValues().then(i.hitch(this,function(e){console.log(e),this.inputValues=e,this.viewModel.serverInfo.isSynchronous?this.gp.execute(e):this.gp.submitJob(e),console.log("Success")})))},_getInputParamValues:function(){var e,t=new v,a={},o=[],n="";return s.forEach(this.inputNodes,function(t){e=t.inputEditor.getGPValue(),e.param=t.param,o.push(e)},this),_(o).then(i.hitch(this,function(e){for(var i=0;i<e.length;i++){if(o[i].param.required&&(null===e[i]||void 0===e[i]))return n=o[i].param.label+" "+this.i18n.requiredInfo,void t.reject(n);a[o[i].param.name]=e[i]}t.resolve(a)}),function(e){t.reject(e)}),t},_createOutputNodes:function(e){var t=[];this.resultNodes=[],this.resultLayers=[],s.forEach(this.viewModel.outputParams,function(i,s){t.push(this._createOutputNode(i,e[s]))},this);var a=s.some(t,function(e){return null!==e});if(a){var o=[];if(s.forEach(e,i.hitch(this,function(e){if("GPFeatureRecordSetLayer"===e.dataType){var t=e.value&&e.value.features;t&&t.length>0&&(o=o.concat(t))}})),o.length>0)try{var n=$.graphicsExtent(o);n&&this.viewModel.map.setExtent(n.expand(1.4))}catch(r){console.error(r)}}},_createOutputNode:function(e,t){var i;if(e.visible){try{i=V.createResultRenderer(e,t,{uid:this.id,config:this.viewModel})}catch(s){console.error(s),i=V.createResultRenderer("error",t,{uid:this.id,config:this.viewModel})}var a=d.create("div",{"class":"output-node"},this.outputSectionNode);this.resultNodes.push(a);var o=d.create("div",{"class":"output-label",title:e.tooltip||e.label||"",innerHTML:e.label},a);a.param=e,a.labelNode=o;var n=d.create("div",{"class":"renderer-container"},a);return i.placeAt(n),i.startup(),a.resultRenderer=i,a}return null},_updateTitle:function(){u.set(this._titleLbl,"innerHTML",this.viewModel.title)},_setDisableRunAnalysisAttr:function(e){this._saveBtn.set("disabled",e),this._saveBtn.set("iconClass",e?"esriLoading":"")},onExecuteComplete:function(e){this.set("disableRunAnalysis",!1);var t;e.messages&&e.messages.length>0&&(t=s.filter(e.messages,function(e){return e.type===Q.TYPE_WARNING||e.type===Q.TYPE_ERROR}),t.length>0&&this._createErrorMessages(t)),this._createOutputNodes(e.results),console.log(e.results)},onJobComplete:function(e){if(this.set("disableRunAnalysis",!1),this._clearMessageInterval(),e.jobInfo.jobStatus!==X.STATUS_SUCCEEDED)return void this._createErrorMessages(e.jobInfo.messages);if(e.jobParams=this.inputParams,this.viewModel.serverInfo.useResultMapServer){var t=[];s.some(this.viewModel.outputParams,function(e){return"MapServiceLayer"===e.dataType?(t=e.layerNames,!0):void 0});var i=new Z({imageSpatialReference:this.viewModel.map.spatialReference}),a=this._getResultMapServiceParam();a&&a.visible!==!0||(this.gp.getResultImageLayer(e.jobInfo.jobId,null,i),s.forEach(this.viewModel.outputParams,function(i){t.indexOf(i.name)<0&&t.indexOf(i.label)<0&&("GPFeatureRecordSetLayer"===i.dataType||"GPRasterDataLayer"===i.dataType||"GPRecordSet"===i.dataType)&&this.gp.getResultData(e.jobInfo.jobId,i.name)},this)),s.forEach(this.viewModel.outputParams,function(t){t.visible&&"GPFeatureRecordSetLayer"!==t.dataType&&"GPRasterDataLayer"!==t.dataType&&"GPRecordSet"!==t.dataType&&this.gp.getResultData(e.jobInfo.jobId,t.name)},this)}else s.forEach(this.viewModel.outputParams,function(t){t.visible&&this.gp.getResultData(e.jobInfo.jobId,t.name)},this)},onJobCancel:function(e){this.infoTextNode.innerHTML="Canceled",this._clearMessageInterval()},onStatusUpdate:function(e){this.jobId=e.jobInfo.jobId,e.jobInfo.jobStatus===X.STATUS_SUCCEEDED?(this.set("disableRunAnalysis",!1),this._clearMessageInterval()):console.log(e.jobInfo.jobStatus),!this.messageInterval&&this.jobId&&this._setupMessageInterval(),e.jobParams=this.inputParams},onGetResultDataComplate:function(e){this._createOutputNode(this._getOutputParamByName(e.result.paramName),e.result)},onGetResultImageLayerComplete:function(e){var t=e.layer;if(t){var i=t.url.substring(t.url.lastIndexOf("/")+1),s={name:i,title:i,tooltip:i,dataType:"result map service",visible:!0};t._wab_type="ArcGISDynamicMapServiceLayer";var a=this._getResultMapServiceParam();a&&(s.label=a.label,s.tooltip=a.tooltip,t.title=a.label);var o=this._createOutputNode(s,t);null!==o&&this.resultLayers.push(t)}},onError:function(e){this.infoTextNode.innerHTML=e.error.message,this._clearMessageInterval()},_createErrorMessages:function(e){console.log(e)},_setupMessageInterval:function(){this.messageInterval=setInterval(i.hitch(this,this._updateJobMessage),3e3)},_clearMessageInterval:function(){this.jobId="",this.messageInterval&&(clearInterval(this.messageInterval),this.messageInterval=null)},_getResultMapServiceParam:function(){var e;return s.some(this.viewModel.outputParams,function(t){return"MapServiceLayer"===t.dataType?(e=t,!0):void 0}),e},_getOutputParamByName:function(e){for(var t=0;t<this.viewModel.outputParams.length;t++)if(this.viewModel.outputParams[t].name===e)return this.viewModel.outputParams[t]},_clearLastInput:function(){s.forEach(this.inputNodes,function(e){e.inputEditor.clear&&i.isFunction(e.inputEditor.clear)&&e.inputEditor.clear()},this)},_clearLastResult:function(){d.empty(this.infoTextNode),s.forEach(this.resultNodes,function(e){d.destroy(e.labelNode),e.resultRenderer&&e.resultRenderer.destroy(),d.destroy(e)}),s.forEach(this.resultLayers,function(e){null!==e&&this.viewModel.map.removeLayer(e)},this),this.resultNodes=[],this.resultLayers=[]},_showLoading:function(){},_hideLoading:function(){}});return n("extend-esri")&&i.setObject("dijit.analysis.GPWidget",ae,Y),ae});