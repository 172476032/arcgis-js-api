// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["require","dojo/aspect","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/_base/kernel","dojo/has","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/promise/all","dojo/store/Memory","dojo/store/Observable","dojo/data/ObjectStore","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/Button","dijit/form/CheckBox","dijit/form/Form","dijit/form/Select","dijit/form/TextBox","dijit/form/ValidationTextBox","dijit/layout/ContentPane","dijit/form/FilteringSelect","dijit/Dialog","dgrid1/OnDemandGrid","dgrid1/Editor","dgrid1/Keyboard","dgrid1/Selection","dgrid1/Selector","dgrid1/extensions/ColumnResizer","dgrid1/extensions/DijitRegistry","dstore/Filter","../../kernel","../../lang","../../request","./AnalysisBase","./utils","./CreditEstimator","./_AnalysisOptions","./storeUtils","./ItemTypes","../../tasks/Geoprocessor","dojo/i18n!../../nls/jsapi","dojo/i18n!./nls/countries","dojo/text!./templates/GeocodeLocationsFromTable.html"],function(t,e,i,s,o,a,n,l,r,h,d,u,c,p,m,b,y,_,f,g,w,T,S,v,F,L,C,I,j,G,A,P,x,N,D,R,k,E,U,O,J,z,M,B,W,X,H,q,V,K,Q,Y,Z,$,tt,et){var it=i([R,k,E,U,O,J,z]),st=i([w,T,S,v,F,K,H],{declaredClass:"esri.dijit.analysis.GeocodeLocationsFromTable",templateString:et,widgetsInTemplate:!0,inputTable:null,inputTables:[],outputLayerName:null,i18n:null,toolName:"BatchGeocode",analyzeToolName:"AnalyzeGeocodeInput",helpFileName:"GeocodeLocationsfromTable",resultParameter:"geocodeResult",checkCreditLimits:!1,allowWorldGeocoder:!0,showChooseExtent:!1,constructor:function(t){this._pbConnects=[],t.containerNode&&(this.container=t.containerNode)},destroy:function(){this.inherited(arguments),o.forEach(this._pbConnects,a.disconnect),delete this._pbConnects},postMixInProperties:function(){this.inherited(arguments),s.mixin(this.i18n,$.geocodeFromTableTool),s.mixin(this.i18n,tt)},postCreate:function(){this.inherited(arguments),b.add(this._form.domNode,"esriSimpleForm"),this._outputLayerInput.set("validator",s.hitch(this,this.validateServiceName)),this.set("disableRunAnalysis",this.showGeoAnalyticsParams),this.inputTable&&this.inputTable.itemid?(this.inputTable.itemId=this.inputTable.itemid,this.signInPromise.then(s.hitch(this,function(){this.getItemInfo(this.inputTable.itemId).then(s.hitch(this,function(t){this.inputTable=s.mixin(this.inputTable,t),this.inputTable.name=t.title,this.inputTable&&!q.isLayerInLayers(this.inputTable,this.inputTables)&&this.inputTables.push(this.inputTable),this._buildUI()}),s.hitch(this,function(t){console.log(t)}))}))):this._buildUI()},startup:function(){},_buildJobParams:function(){var t,e={};return this.inputTable.itemId&&-1!==o.indexOf([Y.CSV,Y.XLS],this.inputTable.type)?e.inputFileItem=n.toJson({itemid:this.inputTable.itemId}):e.inputTable=this.constructAnalysisInputLyrObj(this.inputTable,!0),e.geocodeServiceUrl=this.locator.url,e.geocodeParameters=n.toJson(this.get("geocodeParameters")),e.outputType=this._formatSelect.get("value"),q.isEsriWorldGeocoder(e.geocodeServiceUrl)&&(e.sourceCountry="world"===this._countryCodes.get("value")?"":this._countryCodes.get("value")),this.returnFeatureCollection||"Feature Service"!==e.outputType?this.returnFeatureCollection||"Feature Service"===e.outputType||(e.OutputName={itemProperties:{title:this._outputLayerInput.get("value"),description:d.substitute(this.i18n.itemDescription,{inputTableName:this.inputTable.name}),tags:d.substitute(this.i18n.itemTags,{inputTableName:this.inputTable.name}),snippet:this.i18n.itemSnippet}},this.showSelectFolder&&(e.OutputName.itemProperties.folderId=this.get("folderId")),e.OutputName=n.toJson(e.OutputName)):e.OutputName=n.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}}),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(e.context=n.toJson({extent:this.map.extent._normalize(!0)})),this.returnFeatureCollection&&(t={outSR:this.map.spatialReference},this.showChooseExtent&&this._useExtentCheck.get("checked")&&(t.extent=this.map.extent._normalize(!0)),e.context=n.toJson(t)),e},_onClose:function(t){this._aspectHandle&&(this._aspectHandle.remove(),this._aspectHandle=null),t&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:t})},_handleSaveBtnClick:function(){var t={};this._form.validate()&&(this.set("disableRunAnalysis",!0),t.jobParams=this._buildJobParams(),t.jobParams.OutputName&&n.fromJson(t.jobParams.OutputName).serviceProperties&&(t.itemParams={description:d.substitute(this.i18n.itemDescription,{inputTableName:this.inputTable.name}),tags:d.substitute(this.i18n.itemTags,{inputTableName:this.inputTable.name}),snippet:this.i18n.itemSnippet},this.showSelectFolder&&(t.itemParams.folder=this.get("folderId"))),this.execute(t))},_handleShowCreditsClick:function(t){t.preventDefault(),this._form.validate()&&this.getCreditsEstimate(this.toolName,this._buildJobParams()).then(s.hitch(this,function(t){this._usageForm.set("content",t),this._usageDialog.show()}))},_handleBrowseItemsSelect:function(t){t&&t.selection&&q.addAnalysisReadyLayer({item:t.selection,layers:this.inputTables,layersSelect:this._analysisSelect,browseDialog:t.dialog||this._browsedlg,widget:this}).always(s.hitch(this,this._updateAnalysisLayerUI,!0))},_save:function(){},_buildUI:function(){this._standardUX=[this._chooseOutputTypeLblRow,this._chooseOutputTypeRow],q.updateDisplay(this._standardUX,!this.get("showGeoAnalyticsParams"),"table-row"),this._loadConnections();var t=!0,e=0;q.initHelpLinks(this.domNode,this.showHelp),u.set(this._chooseExtentDiv,"display",this.showChooseExtent===!0?"inline-block":"none"),this.get("showSelectAnalysisLayer")&&(this.get("inputTable")||!this.get("inputTables")||this.rerun||this.set("inputTable",this.inputTables[0]),q.populateAnalysisLayers(this,"inputTable","inputTables")),q.addReadyToUseLayerOption(this,[this._analysisSelect]),this.helperServices&&this.helperServices.geocode&&(this.locators=o.filter(this.helperServices.geocode,function(t){var e=!!t.batch;return q.isEsriWorldGeocoder(t.url)?this.allowWorldGeocoder&&e:e},this),o.forEach(this.locators,function(t,i){var s=this.geocodeServiceUrl&&this.geocodeServiceUrl==t.url;s&&(e=""+i),this._locatorSelect.addOption({value:""+i,label:t.name,selected:s})},this),this._locatorSelect.set("value",e)),this.outputType&&this._formatSelect.set("value",this.outputType),this.outputLayerName&&(this._outputLayerInput.set("value",this.outputLayerName),t=!1),u.set(this._chooseFolderRow,"display",this.showSelectFolder===!0?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(s.hitch(this,function(t){this.folderStore=t,q.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})),u.set(this._showCreditsLink,"display",this.showCredits===!0?"block":"none"),this._outputNumLabel&&this.showGeoAnalyticsParams&&c.set(this._outputNumLabel,"innerHTML",this.i18n.threeLabel),this._buildCountryList(),this._updateAnalysisLayerUI(t)},_buildDataFields:function(t){this._showLoading(!1),this.set("disableRunAnalysis",!1),q.updateDisplay([this._dataFieldErrorRow],!1,"table-row"),q.hideMessages(this._dataErrorMessagePane),q.updateDisplay([this._dataGridRow,this._dataFieldSelectRow],!0,"table-row"),Q.createStore(t);var e,i={identifier:"name",label:"alias",items:[{name:this.i18n.notUsed,alias:this.i18n.notUsed}].concat(this.inputTable.fields)},s=new g({objectStore:f(new _({data:i})),labelProperty:"alias"}),a=[{label:this.i18n.locatorInputs,field:"locatorField"},{label:this.i18n.dataFields,field:"mappedField",editor:G,editOn:"click",editorArgs:{store:s,style:"width:120px;",maxHeight:-1},autoSave:!0}];e=o.filter(t,function(t){return this._multipleswitch.checked?!t.isSingle:t.isSingle},this),this._curdata=t,this.dataFieldGrid?(this.dataFieldGrid.set("columns",a),this.dataFieldGrid.set("collection",Q.createStore(e))):(this.dataFieldGrid=new it({collection:Q.createStore(e),cellNavigation:!1,columns:a,selectionMode:"single"},this._dataGridDiv),this.dataFieldGrid.startup())},_handleSwitchChange:function(t){this._curdata&&this._buildDataFields(this._curdata)},_buildCountryList:function(){var t=[],e={},i=e.user||{},s=i.region||e.region||e.ipCntryCode||"";""===this.sourceCountry&&(this.sourceCountry="world");for(var o in this.i18n.countryCodes)t.push({label:this.i18n.countryCodes[o],value:o.toLowerCase(),selected:this.sourceCountry&&this.sourceCountry===o.toLowerCase()});t=t.sort(function(t,e){return t.label<e.label?-1:t.label>e.label?1:0}),this._countryCodes.set("options",t),this._countryCodes.set("value",this.i18n.countryCodes[s]?s.toLowerCase():"world")},_loadConnections:function(){this.on("start",s.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",s.hitch(this,"_onClose",!1)),this.own(this.watch("locator",s.hitch(this,this._locatorWatcher)),this.watch("inputTable",s.hitch(this,this.analyzeGeocodeInput)),this.watch("locator",s.hitch(this,this.analyzeGeocodeInput)))},_handleAnalysisLayerChange:function(t){var e;"browselayers"===t?(e=this._browseLyrsdlg.browseItems.get("query"),e.custom=['typekeywords:"'+Y.TABLE+'"','typekeywords:"'+Y.CSV+'"','typekeywords:"'+Y.XLS+'"'],e.types.push('type:"'+Y.CSV+'"'),e.types.push('type:"'+Y.XLS+'"'),this.showGeoAnalyticsParams&&e.types.push('type:"'+Y.BIGDATA+'"'),this._browseLyrsdlg.browseItems.set("query",e),this._browseLyrsdlg.browseItems.plugIn.layerTypes=this._browseLyrsdlg.browseItems.plugIn.layerTypes.concat([Y.CSV,Y.XLS]),this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!1,this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!0,this._isAnalysisSelect=!0,this._browseLyrsdlg.show()):(this.set("inputTable",this.inputTables[t]),this._updateAnalysisLayerUI(!0))},_handleLocatorChange:function(t){this.set("locator",this.locators[t])},_updateAnalysisLayerUI:function(t){this.inputTable&&t&&(this.outputLayerName=d.substitute(this.i18n.outputLayerName,{inputTableName:this.inputTable.name}),this._outputLayerInput.set("value",this.outputLayerName))},_locatorWatcher:function(t,e,i){var s=!1;i&&i.url&&(s=q.isEsriWorldGeocoder(i.url),this._countryRow&&q.updateDisplay([this._countryRow],s,"table-row"))},analyzeGeocodeInput:function(){this.locator&&this.inputTable&&this.analysisGpServer&&this.signInPromise.then(s.hitch(this,function(){var t={geocodeServiceUrl:this.locator.url,locale:l.locale};this.inputTable.itemId&&-1!==o.indexOf([Y.CSV,Y.XLS],this.inputTable.type)?(t.inputFileItem=n.toJson({itemid:this.inputTable.itemId}),t.inputFileParameters=n.toJson({fileType:this.inputTable.type===Y.XLS?"xlsx":this.inputTable.type.toLowerCase(),headerRowExists:"true",columnDelimiter:"",textQualifier:""})):t.inputTable=this.constructAnalysisInputLyrObj(this.inputTable,!0),this.analyzeGP=new Z(this.analysisGpServer+"/"+this.analyzeToolName),this.analyzeGP.setUpdateDelay(1e3),this._showLoading(!0),this.analyzeGP.submitJob(t,s.hitch(this,this._getAnalyzeGeocodeData),s.hitch(this,this._analyzeJobFailed),s.hitch(this,this._analyzeJobFailed))}))},_getAnalyzeGeocodeData:function(t){var e=[];"esriJobSucceeded"===t.jobStatus&&(e.push(X({url:this.locator.url,content:{f:"json"}})),e.push(this.analyzeGP.getResultData(t.jobId,"geocodeParameters")),y(e).then(s.hitch(this,this._handleAnalyzeReponse)))},_analyzeJobFailed:function(t){("esriJobFailed"===t.jobStatus||"esriJobCancelled"===t.jobStatus)&&(this._showLoading(!1),q.updateDisplay([this._dataGridRow,this._dataFieldSelectRow],!1,"table-row"),q.updateDisplay([this._dataFieldErrorRow],!0,"table-row"),q.showMessages("Mapping locator fields with input data fields failed, please use another locator.",this._bodyNode,this._dataErrorMessagePane),this.set("disableRunAnalysis",!0))},_handleAnalyzeReponse:function(t){var e={locatorFields:t&&t[0]&&t[0].addressFields?t[0].addressFields:null,fieldMap:t&&t[1].value&&t[1].value.field_mapping?n.fromJson(t[1].value.field_mapping):null},i=[],s=[],a=[];e.locatorFields&&(i=o.map(e.locatorFields,function(t){return t.name},this),e.fieldMap&&e.fieldMap.length>0&&(o.forEach(e.fieldMap,function(t){var s=-1;t[1]&&(s=o.indexOf(i,t[1])),-1!==s&&(e.locatorFields[s].map=t[0]),a.push({name:t[0],alias:t[0]})}),s=o.map(e.locatorFields,function(t){return{locatorField:t.name,mappedField:t.map||this.i18n.notUsed,isSingle:!1}},this))),t&&t[0]&&t[0].singleLineAddressField&&s.push({locatorField:t[0].singleLineAddressField.name,mappedField:this.i18n.notUsed,isSingle:!0}),!this.inputTable.fields&&a&&(this.inputTable.fields=a),this.set("geocodeParameters",t[1].value),this._buildDataFields(s)},_checkFieldInDataField:function(t){return this._curdata?o.some(this._curdata,function(e){return e.mappedField===t}):!1},_setAnalysisGpServerAttr:function(t){t&&(this.analysisGpServer=t,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},_setInputTableAttr:function(t){W.isDefined(t)&&this._set("inputTable",t)},_setinputTablesAttr:function(t){W.isDefined(t)&&this._set("inputTables",t)},_setLocatorAttr:function(t){this._set("locator",t)},_setGeocodeParametersAttr:function(t){this._set("geocodeParameters",t)},_getGeocodeParametersAttr:function(){var t,e,i=new M,s=[];return this.geocodeParameters?(this.dataFieldGrid&&(o.forEach(n.fromJson(this.geocodeParameters.field_mapping),function(o){t=i.eq("mappedField",o[0]),e=this.dataFieldGrid.collection.filter(t);var a=!1;e.forEach(function(t){t&&t.locatorField&&(o[1]=t.locatorField,a=!0)},this),!a&&this._checkFieldInDataField(o[0])&&""!==o[1]&&(o[1]=""),s.push(o)},this),this.geocodeParameters.field_mapping=n.toJson(s)),this.geocodeParameters):null},_setDisableRunAnalysisAttr:function(t){this.showGeoAnalyticsParams?this._saveBtn.set("disabled",this.showGeoAnalyticsParams):this._saveBtn.set("disabled",t)},_setAllowWorldGeocoderAttr:function(t){this._set("allowWorldGeocoder",t)},validateServiceName:function(t){return q.validateServiceName(t,{textInput:this._outputLayerInput})},_connect:function(t,e,i){this._pbConnects.push(a.connect(t,e,i))},_showLoading:function(t){q.updateDisplay([this._dataGridRow,this._dataFieldSelectRow,this._dataFieldErrorRow],!t,"table-row"),q.updateDisplay([this._dataLoadingRow],t,"table-row"),this.set("disableRunAnalysis",t),this._locatorSelect.set("disabled",t),this._analysisSelect.set("disabled",t)}});return r("extend-esri")&&s.setObject("dijit.analysis.GeocodeLocationsFromTable",st,B),st});