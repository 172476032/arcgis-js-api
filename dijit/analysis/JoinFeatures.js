// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.25/esri/copyright.txt for details.

define(["esri/layers/FeatureLayer","require","dojo/aspect","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/has","dojo/on","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/store/Memory","dojo/_base/fx","dojo/fx/easing","dojo/Deferred","dojo/promise/all","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/layout/AccordionContainer","dijit/TitlePane","dijit/form/FilteringSelect","dijit/form/Select","dijit/form/TextBox","dijit/Dialog","../../kernel","../../lang","./utils","./AnalysisBase","./CreditEstimator","./_AnalysisOptions","../CalculateField","../../geometry/Point","../../geometry/Polyline","../../geometry/Polygon","../../SpatialReference","./AnalysisRegistry","./ItemTypes","./ViewJsonTypes","dojo/i18n!../../nls/jsapi","dojo/text!./templates/JoinFeatures.html"],function(e,t,i,s,a,n,r,o,l,h,d,u,c,p,y,m,g,_,f,b,L,w,v,S,T,j,R,A,J,O,F,C,I,x,D,P,N,E,G,k,U,M,q,V,H,B,W,Y,K,z){var $=s([v,S,T,j,R,k,E],{declaredClass:"esri.dijit.analysis.JoinFeatures",templateString:z,widgetsInTemplate:!0,showGeoAnalyticsParams:!0,showTemporalJoin:!0,showAttributeJoin:!0,showSpatialJoin:!0,showJoinCondition:!0,allowAllAttributesTypes:!0,i18n:null,toolName:"JoinFeatures",helpFileName:"JoinFeatures",resultParameter:"output",constructor:function(e,t){this.targetLayers=[],this.joinLayers=[],this._pbConnects=[],this._statsRows=[],this._attrJoinRows=[],e.containerNode&&(this.container=e.containerNode)},postCreate:function(){this.inherited(arguments),this._buildUI()},postMixInProperties:function(){this.inherited(arguments),a.mixin(this.i18n,K.expressionForm),a.mixin(this.i18n,K.joinFeaturesTool),this.joinOperation||(this.joinOperation="JoinOneToOne"),this.joinOperationTypes=[{value:"JoinOneToOne",label:this.i18n.oneToOneLabel},{value:"JoinOneToMany",label:this.i18n.oneToManyLabel}],this.spatialDistance=this.spatialRelationshipDistance||this.spatialNearDistance||0,this.spatialUnit=this.spatialRelationshipDistanceUnits||this.spatialNearDistanceUnit||this.i18n.feet,this.spatialUnitTypes=[{value:"Miles",label:this.i18n.miles},{value:"Yards",label:this.i18n.yards},{value:"Feet",label:this.i18n.feet},{value:"NauticalMiles",label:this.i18n.nautMiles},{type:"separator"},{value:"Kilometers",label:this.i18n.kilometers},{value:"Meters",label:this.i18n.meters}],this.temporalDistance=0,this.temporalUnit=this.i18n.years,this.temporalUnitTypes=[{value:"Years",label:this.i18n.years},{value:"Months",label:this.i18n.months},{value:"Weeks",label:this.i18n.weeks},{value:"Days",label:this.i18n.days},{value:"Hours",label:this.i18n.hours},{value:"Minutes",label:this.i18n.minutes},{value:"Seconds",label:this.i18n.seconds},{value:"Milliseconds",label:this.i18n.milliseconds}],this.attributeType=[{value:"Equal",label:this.i18n.equalSign}]},startup:function(){},_buildUI:function(){var e,t=!0;if(this._outputName.set("validator",a.hitch(this,this.validateServiceName)),this.signInPromise.then(a.hitch(this,N.initHelpLinks,this.domNode,this.showHelp,{analysisGpServer:this.analysisGpServer})),N.updateDisplay([this._temporalJoinNode],this.showTemporalJoin,"table"),N.updateDisplay([this._spatialJoinNode],this.showSpatialJoin,"table"),N.updateDisplay([this._attributeJoinNode],this.showAttributeJoin,"table"),N.updateDisplay([this._joinConditionNode],this.showJoinCondition,"table"),N.updateDisplay([this._outputTypeRow],this.get("showOutputType")&&!this.showGeoAnalyticsParams,"block"),this.allowAllAttributesTypes=!this.showGeoAnalyticsParams&&this.allowAllAttributesTypes,this.showJoinCondition||p.set(this._resultStepLabel,"innerHTML",this.i18n.fiveLabel),this.showGeoAnalyticsParams||(p.set(this._joinOptionsLabel,"innerHTML",this.i18n.joinOptionsStdLabel),p.set(this._joinOptionsHelpNode,"esriHelpTopic","joinType")),n.forEach(this.joinOperationTypes,function(e,t){this._joinOperation.addOption({value:e.value,label:e.label})},this),this.joinOperation&&(this._joinOperation.set("value",this.joinOperation),"JoinOneToMany"===this.joinOperation&&N.updateDisplay([this._joinOperationLabelRow,this._summaryStatisticRow],"JoinOneToOne"===this.joinOperation,"table-row")),n.forEach(this.spatialUnitTypes,function(e,t){this._spatialUnitSelect.addOption({value:e.value,label:e.label})},this),this.spatialUnit&&this._spatialUnitSelect.set("value",this.spatialUnit),n.forEach(this.temporalUnitTypes,function(e,t){this._temporalUnitSelect.addOption({value:e.value,label:e.label})},this),this.temporalUnit&&this._temporalUnitSelect.set("value",this.temporalUnit),P.isDefined(this.targetLayer)&&(e=n.indexOf(this.targetLayers,this.targetLayer),-1===e&&n.forEach(this.targetLayers,function(t,i){t&&(t.url&&this.targetLayer.url&&t.url===this.targetLayer.url||t.name===this.targetLayer.name)&&(e=i)},this),-1===e&&this.targetLayers.push(this.targetLayer)),P.isDefined(this.joinLayer)&&(e=n.indexOf(this.joinLayers,this.joinLayer),-1===e&&n.forEach(this.joinLayers,function(t,i){t&&(t.url&&this.joinLayer.url&&t.url===this.joinLayer.url||t.name===this.joinLayer.name)&&(e=i)},this),-1===e&&this.joinLayers.push(this.joinLayer)),P.isDefined(this.targetLayers)&&this.targetLayers.length>0){var i=[];this.rerun&&!this.targetLayer&&N.addBlankOption(this._targetLayerSelect,i),n.forEach(this.targetLayers,function(e,t){i.push({value:this._toString(t),label:e.name,selected:e.url&&this.targetLayer&&this.targetLayer.url&&e.url===this.targetLayer.url||e&&this.targetLayer&&!e.url&&!this.targetLayer.url&&e.name===this.targetLayer.name})},this),this._targetLayerSelect.addOption(i),P.isDefined(this.targetLayer)||this.rerun||this.set("targetLayer",this.targetLayers[this._targetLayerSelect.get("value")])}if(P.isDefined(this.joinLayers)&&this.joinLayers.length>0){var s=[];this.rerun&&!this.joinLayer&&N.addBlankOption(this._joinLayerSelect,s),n.forEach(this.joinLayers,function(e,t){s.push({value:this._toString(t),label:e.name,selected:e.url&&this.joinLayer&&this.joinLayer.url&&e.url===this.joinLayer.url||e&&this.joinLayer&&!e.url&&!this.joinLayer.url&&e.name===this.joinLayer.name})},this),this._joinLayerSelect.addOption(s),P.isDefined(this.joinLayer)||this.rerun||this.set("joinLayer",this.joinLayers[this._joinLayerSelect.get("value")])}N.addReadyToUseLayerOption(this,[this._targetLayerSelect,this._joinLayerSelect]),c.set(this._chooseFolderRow,"display",!0===this.showSelectFolder?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(a.hitch(this,function(e){this.folderStore=e,N.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})),c.set(this._showCreditsLink,"display",!0===this.showCredits?"block":"none"),this._loadConnections(),this.outputLayerName&&(this._outputName.set("value",this.outputLayerName),t=!1),t=!(this.outputLayerName||this.spatialRelationship||this.temporalRelationship||this.attributeRelationship),this.joinCondition&&this._bufFieldOutput.set("value",this.joinCondition),this._checkCreateView.set("checked",this.outputType===W.FLAYERVIEW),this._updateAnalysisLayerUI(t)},_handleTargetLayerChange:function(e){var t;"browse"===e?(this._analysisquery||(this._analysisquery=this._browsedlg.browseItems.get("query")),this._browsedlg.browseItems.set("query",this._analysisquery),this._isAnalysisSelect=!0,this._browsedlg.show()):"browselayers"===e?(this.showGeoAnalyticsParams&&(t=this._browseLyrsdlg.browseItems.get("query"),t.types.push('type:"Big Data File Share"'),this._browseLyrsdlg.browseItems.set("query",t),this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!1,this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!0),this._isAnalysisSelect=!0,this._browseLyrsdlg.show()):(this.set("targetLayer",this.targetLayers[e]),this._updateAnalysisLayerUI(!0))},_toString:function(e){return""+e},_handleJoinLayerChange:function(e){var t;"browse"===e?(this._analysisquery||(this._analysisquery=this._browsedlg.browseItems.get("query")),this._browsedlg.browseItems.set("query",this._analysisquery),this._isAnalysisSelect=!1,this._browsedlg.show()):"browselayers"===e?(this.showGeoAnalyticsParams&&(t=this._browseLyrsdlg.browseItems.get("query"),t.types.push('type:"Big Data File Share"'),this._browseLyrsdlg.browseItems.set("query",t),this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!1,this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!0),this._isAnalysisSelect=!1,this._browseLyrsdlg.show()):(this.set("joinLayer",this.joinLayers[e]),this._updateAnalysisLayerUI(!0))},_handleJoinOperationChange:function(e){e!==this.joinOperation&&(this._removeStatsRows(),"JoinOneToOne"===e&&P.isDefined(this.joinLayer)&&P.isDefined(this.targetLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")&&this._createStatsRow(),N.updateDisplay([this._joinOperationLabelRow,this._summaryStatisticRow],"JoinOneToOne"===e,"table-row"),this.joinOperation=e,this._updateCreateViewUI())},_handleSpatialCheckChange:function(e,t){g.toggle(this._spatialJoin,"selected"),this.spatialJoin=g.contains(this._spatialJoin,"selected"),P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)&&this._repopulateSpatialTypes(this.targetLayer.geometryType,this.joinLayer.geometryType,t),this.spatialJoin||g.add(this._spatialDistanceRow,"hide"),g.toggle(this._spatialRelationshipRow,"hide"),g.contains(this._spatialRelationshipRow,"hide")&&this._spatialDistanceInput.set("required",!1),this._updateCreateViewUI()},_handleSpatialRelationshipChange:function(e){this.spatialRelationship=e,"Near"===e||"withindistance"===e?(this._spatialDistanceInput.set("required",!0),g.remove(this._spatialDistanceRow,"hide")):(g.add(this._spatialDistanceRow,"hide"),this._spatialDistanceInput.set("required",!1)),this._updateCreateViewUI()},_handleSpatialDistanceChange:function(e){this.spatialDistance=e},_handleSpatialUnitChange:function(e){this.spatialUnit=e},_handleExpBtnClick:function(){this._calcField.set("expression",this._bufFieldOutput.get("value")),D.show(this._calcField.domNode),this._exprDialog.show()},_repopulateSpatialTypes:function(e,t,i){this._spatialRelationshipSelect.removeOption(this._spatialRelationshipSelect.getOptions());var s,a={value:this.showGeoAnalyticsParams?"Equals":"identicalto",label:this.showGeoAnalyticsParams?this.i18n.equalsLabel:this.i18n.identical},r={value:this.showGeoAnalyticsParams?"Intersects":"intersects",label:this.i18n.intersectsLabel},o={value:this.showGeoAnalyticsParams?"Contains":"completelycontains",label:this.showGeoAnalyticsParams?this.i18n.containsLabel:this.i18n.completelyContains},l={value:this.showGeoAnalyticsParams?"Within":"completelywithin",label:this.showGeoAnalyticsParams?this.i18n.withinLabel:this.i18n.completelyWithin},h={value:"Crosses",label:this.i18n.crossesLabel},d={value:"Touches",label:this.i18n.touchesLabel},u={value:"Overlaps",label:this.i18n.overlapsLabel},c={value:this.showGeoAnalyticsParams?"Near":"withindistance",label:this.showGeoAnalyticsParams?this.i18n.near:this.i18n.withinDistance};s={esriGeometryPoint:{esriGeometryPoint:(this.showGeoAnalyticsParams,[a,r,o,l,c]),esriGeometryPolyline:this.showGeoAnalyticsParams?[r,l,d,c]:[r,l,c],esriGeometryPolygon:this.showGeoAnalyticsParams?[r,l,d,c]:[r,l,c]},esriGeometryPolyline:{esriGeometryPoint:this.showGeoAnalyticsParams?[r,o,d,c]:[r,o,c],esriGeometryPolyline:this.showGeoAnalyticsParams?[a,r,o,l,h,d,u,c]:[a,r,o,l,c],esriGeometryPolygon:this.showGeoAnalyticsParams?[r,l,h,d,c]:[r,l,c]},esriGeometryPolygon:{esriGeometryPoint:this.showGeoAnalyticsParams?[r,o,d,c]:[r,o,c],esriGeometryPolyline:this.showGeoAnalyticsParams?[r,o,h,d,c]:[r,o,c],esriGeometryPolygon:this.showGeoAnalyticsParams?[a,r,o,l,d,u,c]:[a,r,o,l,c]}},i||(this.spatialRelationship=s[e][t][0].value),n.forEach(s[e][t],function(e,t){this._spatialRelationshipSelect.addOption({value:e.value,label:e.label})},this),this._spatialRelationshipSelect.set("value",this.spatialRelationship)},_handleTemporalCheckChange:function(e,t){if(g.toggle(this._temporalJoin,"selected"),this.temporalJoin=g.contains(this._temporalJoin,"selected"),P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)){var i,s;i=N.isTimeInstantLayer(this.targetLayer)?"TimeInstant":"TimeInterval",s=N.isTimeInstantLayer(this.joinLayer)?"TimeInstant":"TimeInterval",this._repopulateTemporalTypes(i,s,t)}e||g.add(this._temporalDistanceRow,"hide"),g.toggle(this._temporalRelationshipRow,"hide"),g.contains(this._temporalRelationshipRow,"hide")&&this._temporalDistanceInput.set("required",!1)},_handleTemporalRelationshipChange:function(e){this.temporalRelationship=e;var t=["Near","NearAfter","NearBefore"];n.indexOf(t,e)>-1?(this._temporalDistanceInput.set("required",!0),g.remove(this._temporalDistanceRow,"hide")):(g.add(this._temporalDistanceRow,"hide"),this._temporalDistanceInput.set("required",!1))},_handleTemporalDistanceChange:function(e){this.temporalDistance=e},_handleTemporalUnitChange:function(e){this.temporalUnit=e},_repopulateTemporalTypes:function(e,t,i){this._temporalRelationshipSelect.removeOption(this._temporalRelationshipSelect.getOptions());var s,a={value:"Equals",label:this.i18n.equalsLabel},r={value:"Intersects",label:this.i18n.intersectsLabel},o={value:"During",label:this.i18n.duringLabel},l={value:"Contains",label:this.i18n.containsLabel},h={value:"Finishes",label:this.i18n.finishesLabel},d={value:"Finished By",label:this.i18n.finishedByLabel},u={value:"Meets",label:this.i18n.meetsLabel},c={value:"Met By",label:this.i18n.metByLabel},p={value:"Near",label:this.i18n.near},y={value:"NearAfter",label:this.i18n.nearAfter},m={value:"NearBefore",label:this.i18n.nearBefore},g={value:"Overlaps",label:this.i18n.overlapsLabel},_={value:"Overlapped By",label:this.i18n.overlappedByLabel},f={value:"Starts",label:this.i18n.startsLabel},b={value:"Started By",label:this.i18n.startedByLabel};e&&t&&(s={TimeInstant:{TimeInstant:[a,r,p,y,m],TimeInterval:[r,o,h,f,p,y,m]},TimeInterval:{TimeInstant:[r,l,d,b,p,y,m],TimeInterval:[a,r,o,l,h,d,u,c,g,_,f,b,p,y,m]}}),i||(this.temporalRelationship=s[e][t][0].value),n.forEach(s[e][t],function(e,t){this._temporalRelationshipSelect.addOption({value:e.value,label:e.label})},this)},_handleAttributeCheckChange:function(e,t){g.toggle(this._attributeJoin,"selected"),this.attributeJoin=g.contains(this._attributeJoin,"selected"),g.toggle(this._attributeRelationshipRow,"hide"),t||(!0===this.attributeJoin?this._createAttrJoinRow():this._removeAttrJoinRows())},_createAttrJoinRow:function(e){var i,s,o,l,h,d,u,p,m;return i=y.create("tr",{style:{height:"40px"}},this._attributeRelationshipRow,"before"),o=y.create("td",{style:{width:"39%"}},i),l=y.create("td",{style:{width:"8%"}},i),s=y.create("td",{style:{width:"39%"}},i),h=new C({maxHeight:200,class:"esriLeadingMargin1 esriTrailingMargin1 mediumInput esriVeryShortlabel",style:{width:"90%",overflow:"hidden",tableLayout:"fixed"}},y.create("select",null,o)),h.addOption({value:"",label:this.i18n.selectTargetField}),n.forEach(this.targetLayer.fields,function(e,t){h.addOption({value:this._toString(t+1),label:e.name})},this),h.set("targetLayer",this.targetLayer),h.set("joinLayer",this.joinLayer),l.innerHTML="=",c.set(l,"text-align","center"),d=new C({class:"mediumInput esriLeadingMargin05 esriVeryShortlabel",style:{width:"90%",overflow:"hidden",tableLayout:"fixed"}},y.create("select",null,s)),d.addOption({value:"",label:this.i18n.selectJoinField}),h.set("statisticSelect",d),r.connect(h,"onChange",this._handleAttrTargetChange),p=y.create("td",{class:"shortTextInput removeTd",style:{display:"none",width:"10%",paddingTop:"1em"}},i),u=y.create("a",{title:this.i18n.remove,class:"closeIcon statsRemove",innerHTML:"<img src='"+t.toUrl("./images/close.gif")+"' border='0''/>"},p),r.connect(u,"onclick",a.hitch(this,this._removeAttrJoinRow,i)),this._attrJoinRows.push(i),1===this._attrJoinRows.length&&(h.set("required","true"),d.set("required","true")),m=y.create("td",{style:{width:"10%",display:"block"}},i),d.set("attributeSelect",h),d.set("removeTd",p),d.set("stylingTd",m),d.set("isnewRowAdded",!1),d.set("referenceWidget",this),h.set("referenceWidget",this),d._watchHandle=d.watch("value",this._handleAttrJoinUpdate),this._currentJoinSelect=d,this._currentTargetSelect=h,!0},_removeAttrJoinRow:function(e){n.forEach(A.findWidgets(e),function(e){e.destroyRecursive()}),y.destroy(e)},_removeAttrJoinRows:function(){n.forEach(this._attrJoinRows,this._removeAttrJoinRow,this),this._attrJoinRows=[]},_handleAttrTargetChange:function(e,t,i){var s,r,o,l,h,d,u=[];s=this.get("statisticSelect"),e!==this._curTargetAttrValue&&(t&&i||n.forEach(s.getOptions(),function(e){""!==e.value&&s.removeOption(e)},this),""!==e&&(t&&i&&(s.removeOption(s.getOptions()),u.push({value:"",label:this.referenceWidget.i18n.selectJoinField,selected:!1})),l=this.get("targetLayer").fields[e-1]&&this.get("targetLayer").fields[e-1].type,n.forEach(this.get("joinLayer").fields,function(e,s){(this.referenceWidget.showGeoAnalyticsParams&&e.type===l||this.referenceWidget.allowAllAttributesTypes)&&(t&&i&&i.joinField===e.name&&(d=s+1+""),u.push({value:s+1+"",label:e.name,selected:t&&i&&i.joinField===e.name}))},this),s._watchHandle&&t&&i&&s._watchHandle.unwatch(),s.addOption(u),s.set("value",d),""!==s.get("value")&&(s.get("isnewRowAdded")||(r=s.get("removeTd"),h=s.get("stylingTd"),c.set(r,"display","block"),c.set(h,"display","none"),o=s.get("referenceWidget"),a.hitch(o,o._createAttrJoinRow)(),s.set("isnewRowAdded",!0)))),this._curTargetAttrValue=e)},_handleAttrJoinUpdate:function(e,t,i){var s,n,r;this.get("attributeSelect")&&(s=this.get("attributeSelect"),""!==s.get("value")&&""!==i&&(this.get("isnewRowAdded")||(n=this.get("removeTd"),c.set(n,"display","block"),r=this.get("referenceWidget"),a.hitch(r,r._createAttrJoinRow)(),this.set("isnewRowAdded",!0))))},_createStatsRow:function(e){var i,s,n,o,l,d;return i=y.create("tr",{style:{height:"40px"}},this._summaryStatisticRow,"before"),s=y.create("td",{colspan:"3",style:{width:"65%"}},i),n=new C({maxHeight:200,class:"esriLeadingMargin1 mediumInput esriTrailingMargin025 attrSelect",style:{tableLayout:"fixed",overflowX:"hidden",width:"45%"}},y.create("select",null,s)),N.addAttributeOptions({selectWidget:n,layer:this.joinLayer,allowStringType:this.showGeoAnalyticsParams}),o=new C({class:"esriLeadingMargin1 mediumInput statsSelect",style:{tableLayout:"fixed",overflowX:"hidden",width:"45%"}},y.create("select",null,s)),N.addStatisticsOptions({selectWidget:o,showGeoAnalyticsParams:this.showGeoAnalyticsParams}),n.set("statisticSelect",o),n.set("featureLayer",this.joinLayer),n.set("showGeoAnalyticsParams",this.showGeoAnalyticsParams),n._onChangeHandle=h.pausable(n,"change",a.partial(this._handleAttrSelectChange,{showGeoAnalyticsParams:this.showGeoAnalyticsParams})),e?n._onChangeHandle.pause():n._onChangeHandle.resume(),this.showGeoAnalyticsParams&&n.watch("value",this._handleAtrrValueUpdate),d=y.create("td",{class:"shortTextInput removeTd",style:{visibility:"hidden",maxWidth:"12px",paddingTop:"1em"}},i),l=y.create("a",{title:this.i18n.remove,class:"closeIcon statsRemove",innerHTML:"<img src='"+t.toUrl("./images/close.gif")+"' border='0''/>"},d),r.connect(l,"onclick",a.hitch(this,this._removeStatsRow,i)),this._statsRows.push(i),o.set("attributeSelect",n),o.set("removeTd",d),o.set("isnewRowAdded",!1),o.set("referenceWidget",this),o.watch("value",this._handleStatsValueUpdate),this._currentStatsSelect=o,this._currentAttrSelect=n,!0},_removeStatsRow:function(e){n.forEach(A.findWidgets(e),function(e){e.destroyRecursive()}),y.destroy(e)},_removeStatsRows:function(){n.forEach(this._statsRows,this._removeStatsRow,this),this._statsRows=[]},_handleAttrSelectChange:function(e,t){var i,s,n,r;"0"!==t&&(i=this.get("statisticSelect"),i.get("referenceWidget"),r=this.getOptions(t),r&&r.type&&N.addStatisticsOptions({selectWidget:i,type:r.type,showGeoAnalyticsParams:e.showGeoAnalyticsParams}),i&&!i.get("isnewRowAdded")&&"0"!==i.get("value")&&""!==i.get("value")&&"0"!==this.get("value")&&""!==this.get("value")&&(s=i.get("removeTd"),c.set(s,"visibility","visible"),n=i.get("referenceWidget"),a.hitch(n,n._createStatsRow)(),i.set("isnewRowAdded",!0)))},_handleStatsValueUpdate:function(e,t,i){var s,n,r;this.get("attributeSelect")&&(s=this.get("attributeSelect"),"0"!==s.get("value")&&"0"!==i&&""!==i&&""!==s.get("value")&&(this.get("isnewRowAdded")||(n=this.get("removeTd"),c.set(n,"visibility","visible"),r=this.get("referenceWidget"),a.hitch(r,r._createStatsRow)(),this.set("isnewRowAdded",!0))))},_handleShowCreditsClick:function(e){var t={};e.preventDefault(),this._form.validate()&&(t=this._buildJobParams(),this.getCreditsEstimate(this.toolName,t).then(a.hitch(this,function(e){t.outputType===W.FLAYERVIEW&&(e.cost=0,e.infoMessage=this.i18n.zeroCreditsViewResult),this._usageForm.set("content",e),this._usageDialog.show()})))},_canCreateView:function(e){return!!e&&!!this.joinLayer&&!!this.targetLayer&&this._isOwner(this.joinLayer,e)&&this._isOwner(this.targetLayer,e)&&!this._isMultiServiceViewLayer(this.targetLayer)&&!this._isMultiServiceViewLayer(this.joinLayer)&&!this.spatialJoin&&"JoinOneToOne"===this._joinOperation.get("value")},_isMultiServiceViewLayer:function(e){var t,i=!1;return e._json&&(t=o.fromJson(e._json),i=t.isMultiServicesView),i},_isOwner:function(e,t){return this.isOwner(e,t)&&(!e.url||-1!==e.url.indexOf(t.orgId))},_enableCreateViewUI:function(e){!e&&this._checkCreateView.get("checked")&&this._checkCreateView.set("checked",e),this._checkCreateView.set("disabled",!e)},_handleCreateViewChange:function(e){this._useExtentCheck.get("checked")&&e&&this._useExtentCheck.set("checked",!e)},_handleExtentChange:function(e){this._checkCreateView.get("checked")&&e&&this._checkCreateView.set("checked",!e)},_getSourceLayerFields:function(e){return e=n.filter(e,function(e){return e.type!==B.FieldTypes.ObjectId}),n.map(e,function(e){var t={name:e.name,alias:e.alias,source:e.source?e.source:e.name};return e.statisticType&&(t.statisticType=e.statisticType,"MEAN"===t.statisticType&&(t.statisticType="AVG")),t})},_getSourceServiceName:function(e){return e.substring(e.indexOf("/services/")+"/services/".length,e.indexOf("/FeatureServer/"))},_getLogicalTableName:function(e){return e+"_"+(new Date).getTime()},_arrIntersections:function(e,t,i){return n.filter(e,function(e){if(i){var s=t.map(function(e){return e[i]});return-1!==n.indexOf(s,e[i])}return-1!==n.indexOf(t,e)})},_updateSameFieldsInRelTable:function(e,t){var i=this._arrIntersections(e,t,"name"),s=n.map(i,function(e){return e.name});i.length>0&&n.forEach(t,function(e){-1!==n.indexOf(s,e.name)&&(e.name=this._getLogicalTableName(e.name))},this)},_createIntermediateTableView:function(e){var t,i,s,r=new L,l={layers:[{name:"",description:"tablestatsjoin",adminLayerInfo:{viewLayerDefinition:{table:{materialized:!1}}}}]},h=e.jobParams,d=e.resultService,u=this._getSourceServiceName(this.joinLayer.url),c=[],p=[];return s=l.layers[0].adminLayerInfo.viewLayerDefinition.table,s.name=this._getLogicalTableName(u)+"_StatsTable",l.layers[0].name=u+"_StatsTable",s.sourceServiceName=u,s.sourceLayerId=this.joinLayer.layerId,t=h.attributeRelationship,n.forEach(t,function(e){e=o.fromJson(e),c.push(e.targetField),p.push(e.joinField)},this),i=n.filter(this.joinLayer.fields,function(e){return-1!==n.indexOf(p,e.name)}),h.summaryFields&&n.forEach(h.summaryFields,function(e){var t=o.fromJson(e),s=this.joinLayer.fields.findIndex(a.hitch(this,function(e){return e.name===t.onStatisticField})),n=a.mixin({},this.joinLayer.fields[s],{statisticType:t.statisticType});n.source=n.name+"",n.name=n.name+"_"+n.statisticType,n.alias=n.alias+"_"+n.statisticType,i.push(n)},this),s.sourceLayerFields=this._getSourceLayerFields(i),s.groupBy=p.join(),this._addToDefinition(d.url,l).then(a.hitch(this,function(e){r.resolve({interTableViewParams:l,response:e})}),a.hitch(this,function(e){r.reject(e)})),r.promise},getViewParams:function(e){var t,i=new L,s=e.jobParams,r=e.resultService;return w([this._getAdminLayerInfo(this.targetLayer.url),this._getAdminLayerInfo(this.joinLayer.url)]).then(a.hitch(this,function(e){var l,h,d=Y.joinFeatures,u=[],c=[],p=e[0].adminLayerInfo,y=e[1].adminLayerInfo,m=this._getSourceServiceName(this.targetLayer.url),g=this._getSourceServiceName(this.joinLayer.url);if(t=o.fromJson(s[this.outputName]),d.layers[0].name=t.serviceProperties?t.serviceProperties.name:this._outputName.get("value"),l=d.layers[0].adminLayerInfo.viewLayerDefinition.table,l.name=this._getLogicalTableName(m)+"_target",l.sourceServiceName=m,l.sourceLayerId=this.targetLayer.layerId,l.sourceLayerFields=this._getSourceLayerFields(this.targetLayer.fields),p.geometryField&&p.geometryField.name?d.layers[0].adminLayerInfo.geometryField.name=l.name+"."+p.geometryField.name:d.layers[0].adminLayerInfo.geometryField=null,l.relatedTables[0].type="JoinOneToOne"===s.joinOperation?"INNER":"RIGHT","JoinOneToOne"===s.joinOperation&&s.summaryFields&&s.summaryFields.length>0){this._createIntermediateTableView({viewParams:d,targetALinfo:p,joinALinfo:y,jobParams:s,resultService:r}).then(a.hitch(this,function(e){var t,a=e.interTableViewParams.layers[0];l.relatedTables[0].name=a.name,l.relatedTables[0].sourceServiceName=d.layers[0].name,l.relatedTables[0].sourceLayerId=0,l.relatedTables[0].sourceLayerFields=n.map(a.adminLayerInfo.viewLayerDefinition.table.sourceLayerFields,function(e){return{name:e.name,alias:e.alias,source:e.name}}),t=s.attributeRelationship,n.forEach(t,function(e){e=o.fromJson(e),u.push(e.targetField),c.push(e.joinField)},this),l.relatedTables[0].parentKeyFields=u,l.relatedTables[0].keyFields=c,i.resolve(d)}),a.hitch(this,function(){i.reject()}))}else l.relatedTables[0].name=this._getLogicalTableName(g)+"_join",l.relatedTables[0].sourceServiceName=g,l.relatedTables[0].sourceLayerId=this.joinLayer.layerId,("JoinOneToMany"===s.joinOperation||"JoinOneToOne"===s.joinOperation&&!s.summaryFields)&&(l.relatedTables[0].sourceLayerFields=this._getSourceLayerFields(this.joinLayer.fields),this._updateSameFieldsInRelTable(l.sourceLayerFields,l.relatedTables[0].sourceLayerFields)),s.spatialRelationship?(l.relatedTables[0].parentKeyFields=[p.geometryField.name],l.relatedTables[0].keyFields=[y.geometryField.name],l.relatedTables[0].operator="completelycontains"===s.spatialRelationship?"esriSpatialRelContains":"intersects"===s.spatialRelationship?"esriSpatialRelIntersects":"esriSpatialRelWithin"):(h=s.attributeRelationship,n.forEach(h,function(e){e=o.fromJson(e),u.push(e.targetField),c.push(e.joinField)},this),l.relatedTables[0].parentKeyFields=u,l.relatedTables[0].keyFields=c),i.resolve(d)}),a.hitch(this,function(e){i.reject(e)})),i.promise},_buildJobParams:function(){var e,t={};if(t.targetLayer=this.constructAnalysisInputLyrObj(this.targetLayer),this.doRefreshItem="table"!==this.targetLayer.type.toLowerCase(),t.joinLayer=this.constructAnalysisInputLyrObj(this.joinLayer),this.showGeoAnalyticsParams||(t.targetLayer=o.toJson(t.targetLayer),t.joinLayer=o.toJson(t.joinLayer)),t.joinOperation=this.get("joinOperation"),this._bufFieldOutput.get("value")&&(t.joinCondition=this._bufFieldOutput.get("value")),this.spatialJoin&&(t.spatialRelationship=this._spatialRelationshipSelect.get("value"),"Near"!==this._spatialRelationshipSelect.get("value")&&"withindistance"!==this._spatialRelationshipSelect.get("value")||(this.showGeoAnalyticsParams?(t.spatialNearDistance=parseFloat(this.get("spatialDistance")),t.spatialNearDistanceUnit=this._spatialUnitSelect.get("value")):(t.spatialRelationshipDistance=parseFloat(this.get("spatialDistance")),t.spatialRelationshipDistanceUnits=this._spatialUnitSelect.get("value")))),this.temporalJoin){t.temporalRelationship=this._temporalRelationshipSelect.get("value");var i=["Near","NearAfter","NearBefore"];n.indexOf(i,t.temporalRelationship)>-1&&(t.temporalNearDistance=parseFloat(this.get("temporalDistance")),t.temporalNearDistanceUnit=this._temporalUnitSelect.get("value"))}if(this.attributeJoin){var s="",a=[],r=0;n.forEach(this._attrJoinRows,function(e,t,i){var l=e.children,h="",d={},u=0,c="";n.forEach(l,function(e,t){if(t<3){if(1!==t)var i=A.byNode(e.children[0]).get("value");0===t&&""!==i&&(u++,h+='target["'+e.textContent+'"]',c=this.targetLayer.fields[parseInt(i,10)-1].type,d.targetField=e.textContent),1===t&&(u++,h+=" "+e.textContent+" ",d.operator="="===e.textContent?this._getEqualParamValue(c):e.textContent),2===t&&""!==i&&(u++,h+='join["'+e.textContent+'"]',d.joinField=e.textContent)}},this),3===u&&(0!==r&&(s+=" and "),s+=h,a.push(this.showGeoAnalyticsParams?d:o.toJson(d)),r++)},this),t.attributeRelationship=this.showGeoAnalyticsParams?o.toJson(a):a}return"JoinOneToOne"===this._joinOperation.get("value")&&this._statsRows.length>=2&&(t.summaryFields=[],e=this.get("summaryFields"),t.summaryFields=this.showGeoAnalyticsParams?o.toJson(e):e),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(t.context=o.toJson({extent:this.map.extent._normalize(!0)})),t.OutputName=o.toJson({serviceProperties:{name:this._outputName.get("value")}}),!this.showGeoAnalyticsParams&&this._checkCreateView.get("checked")&&(t.outputType=W.FLAYERVIEW),t},_getEqualParamValue:function(e){return this.showGeoAnalyticsParams&&e===B.FieldTypes.String?"equalIgnoreCaseTrimWhitespace":"equal"},_handleSaveBtnClick:function(){var e={},t={};if(this._form.validate()){if("_NOVALUE_"===this._joinLayerSelect.get("value"))return void this._showMessages(this.i18n.joinLayerErrorMsg);if("_NOVALUE_"===this._joinOperation.get("value"))return void this._showMessages(this.i18n.joinOpErrorMsg);if(!(this.attributeJoin||this.temporalJoin||this.spatialJoin))return void this._showMessages(this.i18n.joinTypesErrorMsg);if(this._handleCloseMsg(),this._saveBtn.set("disabled",!0),e=this._buildJobParams(),t.jobParams=e,t.itemParams={description:this.i18n.itemDescription,tags:this.i18n.itemTags,snippet:this.i18n.itemSnippet},this.showSelectFolder&&(t.itemParams.folder=this.get("folderId")),this.showGeoAnalyticsParams){if(!N.checkPCSforAnalysis({widget:this,jobParams:e}))return;t.isSpatioTemporalDataStore=!0}this.resultParameter=this.showGeoAnalyticsParams?"output":"outputLayer",this.execute(t)}},_setDisableRunAnalysisAttr:function(e){this._saveBtn.set("disabled",e)},_setTargetLayerAttr:function(e){this._set("targetLayer",e||null)},_setTargetLayersAttr:function(e){this._set("targetLayers",e||[])},_setJoinLayerAttr:function(e){this._set("joinLayer",e||null)},_setShowSpatialJoinAttr:function(e){this._set("showSpatialJoin",e)},_setShowAttributeJoinAttr:function(e){this._set("showAttributeJoin",e)},_setShowTemporalJoinAttr:function(e){this._set("showTemporalJoin",e)},_setShowJoinConditionAttr:function(e){this._set("showJoinCondition",e)},_setJoinLayersAttr:function(e){this._set("joinLayers",e||[])},_handleBrowseItemsSelect:function(e){e&&e.selection&&N.addAnalysisReadyLayer({item:e.selection,layers:this._isAnalysisSelect?this.targetLayers:this.joinLayers,layersSelect:this._isAnalysisSelect?this._targetLayerSelect:this._joinLayerSelect,posIncrement:(this._isAnalysisSelect,0),browseDialog:e.dialog||this._browsedlg,widget:this}).always(a.hitch(this,function(){this._isAnalysisSelect?this._handleTargetLayerChange(this._targetLayerSelect.get("value")):this._handleJoinLayerChange(this._joinLayerSelect.get("value"))}))},_save:function(){},_onClose:function(e){e&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:e})},_loadConnections:function(){this.on("start",a.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",a.hitch(this,"_onClose",!1)),this._spatialJoinHandle=h.pausable(this._spatialJoinCtr,"click",a.hitch(this,this._handleSpatialCheckChange)),this._temporalJoinHandle=h.pausable(this._temporalJoinCtr,"click",a.hitch(this,this._handleTemporalCheckChange)),this._attributeJoinHandle=h.pausable(this._attributeJoinCtr,"click",a.hitch(this,this._handleAttributeCheckChange)),this.own(this._spatialJoinHandle,this._temporalJoinHandle,this._attributeJoinHandle)
},_connect:function(e,t,i){this._pbConnects.push(r.connect(e,t,i))},_updateAnalysisLayerUI:function(e){if(this._expBtn.set("disabled",!this.targetLayer),this._bufFieldOutput.set("disabled",!this.targetLayer),this.targetLayer){var t,s,r,o=this._joinLayerSelect.getOptions(),l=!1;e&&(this.outputLayerName=u.substitute(this.i18n.outputLayerName,{targetLayerName:this.targetLayer.name}),this._outputName.set("value",this.outputLayerName)),this._isAnalysisSelect&&(n.some(o,function(e,t){return e.label===this.targetLayer.title},this)||(s=this.showBrowseLayers&&this.showReadyToUseLayers?3:!this.showBrowseLayers&&this.showReadyToUseLayers?2:this.showBrowseLayers&&!this.showReadyToUseLayers?2:0,t=o.splice(o.length-s,s),l=n.some(this.joinLayers,function(e){return e&&e.analysisReady&&this.targetLayer.analysisReady&&e.itemId===this.targetLayer.itemId},this),l||(0===this.joinLayers.length&&(this.joinLayer=this.targetLayer),this.joinLayers.push(this.targetLayer)),t.unshift({value:this.joinLayers.length-1,label:this.targetLayer.title}),this._joinLayerSelect.addOption(t)));var h,d,p={};if(d=n.map(this.targetLayer.fields,function(e){var t=a.clone(e);return a.mixin(t,{name:'target["'+e.name+'"]',alias:'target["'+e.alias+'"]'}),t},this),h=n.map(this.joinLayer.fields,function(e){var t=a.clone(e);return a.mixin(t,{name:'join["'+e.name+'"]',alias:'join["'+e.alias+'"]'}),t},this),p.fields=[].concat(h,d),this.showJoinCondition){var y=[];if(y.push(this.makeArcadeProfile(this.joinLayer,"$join")),y.push(this.makeArcadeProfile(this.targetLayer,"$target")),this._calcField)this._calcField&&this._calcField.layer!==this.inputLayer&&(this._bufFieldOutput.set("value",""),this._calcField.reset(),this._calcField.set("arcadeProfile",y),this._calcField.set("layer",p));else{var m=N.getExprFunctions();m=n.filter(m,function(e){return e&&e.name&&-1===e.name.indexOf("as_")}),this._calcField=new U({expressionMode:U.MODE_ARCADE,arcadeEditor:this.arcadeEditor,map:this.map,layer:p,field:this.i18n.bufField,baseClass:"esriBufFieldExp",helperMethods:m,showHelp:!0,helpUrl:N.getHelpUrl({widget:this,topic:"BufferExpression"}),css:{base:"esriBufFieldExp",addButton:"btn calcite primary",closeButton:"btn calcite cancel"},helperType:"numeric",showHeader:!1,arcadeProfile:y,calculateLabel:this.i18n.add,expression:this.joinCondition||!1},this._expressionCtr),this._calcField.startup(),this._calcField.expressionMode===U.MODE_SQL?(c.set(this._calcField._validateBtn.domNode,"display","none"),this._calcField._handleHelperTypeChange("value",null,{functionType:"NumType"}),this._aspectHandle=i.around(this._calcField,"_handleAddButtonClick",a.hitch(this,function(e){return a.hitch(this,function(e,t){var i=this._calcField.get("expression")[0];this._bufFieldOutput.set("value",i.sqlExpression),this._exprDialog.hide()})}))):this._calcField.expressionMode===U.MODE_ARCADE&&this._calcField.on("expression-add",a.hitch(this,function(e){this._bufFieldOutput.set("value",e.expression)})),this._calcField.on("close",a.hitch(this,function(){this._exprDialog.hide()}))}}}e?(this.spatialJoin=!1,this.attributeJoin=!1,this.temporalJoin=!1,this._removeStatsRows(),this._removeAttrJoinRows(),g.contains(this._spatialJoin,"selected")&&(g.remove(this._spatialJoin,"selected"),g.add(this._spatialDistanceRow,"hide"),g.add(this._spatialRelationshipRow,"hide"),this._spatialRelationshipSelect.reset(),this._spatialDistanceInput.set("required",!1)),g.contains(this._temporalJoin,"selected")&&(g.remove(this._temporalJoin,"selected"),g.add(this._temporalRelationshipRow,"hide"),g.add(this._temporalDistanceRow,"hide"),this._temporalDistanceInput.set("required",!1)),g.contains(this._attributeJoin,"selected")&&(g.remove(this._attributeJoin,"selected"),g.add(this._attributeRelationshipRow,"hide")),P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")?("JoinOneToOne"===this._joinOperation.get("value")&&this._createStatsRow(),g.remove(this._spatialJoin,"disabled"),g.remove(this._attributeJoin,"disabled"),g.remove(this._spatialJoinLabel,"esriAnalysisTextDisabled"),g.remove(this._attrJoinLabel,"esriAnalysisTextDisabled"),this._spatialJoinHandle.resume()):(g.add(this._spatialJoin,"disabled"),g.add(this._attributeJoin,"disabled"),g.add(this._temporalJoin,"disabled"),g.add(this._spatialJoinLabel,"esriAnalysisTextDisabled"),g.add(this._attrJoinLabel,"esriAnalysisTextDisabled"),g.add(this._temporalJoinLabel,"esriAnalysisTextDisabled"),this._attributeJoinHandle.pause(),this._spatialJoinHandle.pause(),this._temporalJoinHandle.pause())):(this.spatialRelationship&&(this.spatialJoin=!0,this._spatialRelationshipSelect.set("value",this.spatialRelationship),this._handleSpatialCheckChange(this.spatialJoin,!e),this.spatialDistance&&this._spatialDistanceInput.set("value",this.spatialDistance)),this.attributeRelationship&&(this.attributeJoin=!0,this._handleAttributeCheckChange(this.attributeJoin,!e),this.attributeRelationship&&this.targetLayer&&this.joinLayer&&(this._isAttrAdded=!1,this._createAttrJoinRow(this.attributeRelationship),this.attributeRelationship&&!this.attributeRelationship.length&&(this.attributeRelationship=[this.attributeRelationship]),n.forEach(this.attributeRelationship,function(t){var i=n.map(this.targetLayer.fields,function(e){return e.name}),s=n.indexOf(i,t.targetField);this._currentTargetSelect.set("value",s+1+""),a.hitch(this._currentTargetSelect,this._handleAttrTargetChange,this._currentTargetSelect.get("value"),!e,t)()},this),this._isAttrAdded=!0)),!this.spatialRelationship&&P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")&&("JoinOneToOne"!==this._joinOperation.get("value")||this.summaryFields||this._createStatsRow()),this.temporalRelationship&&(this.temporalJoin=!0,this._handleTemporalCheckChange(this.temporalJoin,!e),this._temporalRelationshipSelect.set("value",this.temporalRelationship)),this.summaryFields&&(this._createStatsRow(!e),n.forEach(this.summaryFields,function(e){this._currentAttrSelect.set("value",e.onStatisticField),this._currentStatsSelect.set("value",e.statisticType)},this))),P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")&&(r=!(N.isTimeEnabled(this.joinLayer)&&N.isTimeEnabled(this.targetLayer)),g.toggle(this._temporalJoin,"disabled",r),g.toggle(this._temporalJoinLabel,"esriAnalysisTextDisabled",r),this._attributeJoinHandle.resume(),r?this._temporalJoinHandle.pause():this._temporalJoinHandle.resume()),P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)&&(this.targetLayer.type&&"table"===this.targetLayer.type.toLowerCase()||this.joinLayer.type&&"table"===this.joinLayer.type.toLowerCase())&&(g.add(this._spatialJoin,"disabled"),g.add(this._spatialJoinLabel,"esriAnalysisTextDisabled"),this._spatialJoinHandle.pause()),this._updateCreateViewUI()},_updateCreateViewUI:function(){this.getUserProfile().then(a.hitch(this,function(e){this.spatialRelationship=this._spatialRelationshipSelect.get("value"),this._enableCreateViewUI(this._canCreateView(e))}))},_setAttributeRelationshipAttr:function(e){var t,i=[];e&&"string"==typeof e&&(t=e.split(" and "),n.forEach(t,function(e){var t=e.split(" = ");i.push({targetField:-1!==t[0].indexOf('["')?t[0].substring(t[0].indexOf('["')+2,t[0].indexOf('"]')):t[0],operator:"equal",joinField:-1!==t[1].indexOf('["')?t[1].substring(t[1].indexOf('["')+2,t[1].indexOf('"]')):t[1]})}),e=i),n.forEach(e,function(t,i){"string"==typeof t&&-1!==t.indexOf("{")&&(e[i]=N.tryParseJSON(t))},this),this.attributeRelationship=e},_setSummaryFieldsAttr:function(e){e&&"object"==typeof e&&!e.length&&(e=[e]),n.forEach(e,function(t,i){"string"==typeof t&&-1!==t.indexOf("{")&&(e[i]=N.tryParseJSON(t))},this),this.summaryFields=e},_getSummaryFieldsAttr:function(){var e,t,i=[];return m(".statsSelect",this.domNode).forEach(function(s,a){if(e=A.byNode(s),t=e.get("attributeSelect"),"0"!==t.get("value")&&"0"!==e.get("value")&&""!==t.get("value")&&""!==e.get("value")){var n={};n.statisticType=e.get("value"),n.onStatisticField=t.get("value"),i.push(this.showGeoAnalyticsParams?n:o.toJson(n))}},this),i},_setAnalysisGpServerAttr:function(e){e&&(this.analysisGpServer=e,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},validateServiceName:function(e){return N.validateServiceName(e,{textInput:this._outputName})},_showMessages:function(e){p.set(this._bodyNode,"innerHTML",e),f.fadeIn({node:this._errorMessagePane,easing:b.quadIn,onEnd:a.hitch(this,function(){c.set(this._errorMessagePane,{display:""})})}).play()},_handleCloseMsg:function(e){e&&e.preventDefault(),f.fadeOut({node:this._errorMessagePane,easing:b.quadOut,onEnd:a.hitch(this,function(){c.set(this._errorMessagePane,{display:"none"})})}).play()},makeArcadeProfile:function(e,t){if(e){var i,s,r,o=e.fields,l={layer:e,popupInfo:e.infoTemplate?e.infoTemplate.toJson():null},h=n.map(o,function(e){return e.domain&&n.indexOf(["range","codedValue"],e.domain.type)>-1&&(e=a.clone(e),e.domain=e.domain.toJson?e.domain.toJson():e.domain),e});return i={type:"Feature",value:{attributes:null,geometry:null,layer:{fields:h,objectIdField:e.objectIdField,typeIdField:e.typeIdField,types:e.types?n.map(e.types,function(e){return e.toJson?e.toJson():e}):null,templates:e.templates}},id:P.isDefined(t)?t:"$feature"},l._queryResponse&&l._queryResponse.features&&l._queryResponse.features.length?(i.value.attributes=a.clone(l._queryResponse.features[0].attributes),i.value.geometry=l._queryResponse.features[0].geometry):l._queryResponse&&l._queryResponse[e.url]&&l._queryResponse[e.url].features&&l._queryResponse[e.url].features.length?(i.value.attributes=a.clone(l._queryResponse[e.url].features[0].attributes),i.value.geometry=l._queryResponse[e.url].features[0].geometry):e.graphics&&e.graphics.length&&e.geometryType?(i.value.attributes=a.clone(e.graphics[0].attributes),i.value.geometry=e.graphics[0].geometry.toJson()):(s={},n.forEach(o,function(e){n.indexOf(["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGlobalID"],e.type)>-1&&!1===e.nullable?e.defaultValue?s[e.name]=e.defaultValue:n.indexOf(["esriFieldTypeString"],e.type)>-1?s[e.name]="":s[e.name]=0:s[e.name]=null}),i.value.attributes=s,r=this.map.extent,"esriGeometryPolygon"==e.geometryType||e.getCustomRasterFields?(i.value.geometry=new V(new H(this.map.spatialReference.toJson())),i.value.geometry.addRing([[r.xmin,r.ymin],[r.xmax,r.ymin],[r.xmax,r.ymax],[r.xmin,r.ymax],[r.xmin,r.ymin]])):"esriGeometryPoint"==e.geometryType||"esriGeometryMultipoint"==e.geometryType?i.value.geometry=new M(r.getCenter().toJson()):"esriGeometryPolyline"==e.geometryType&&(i.value.geometry=new q(new H(this.map.spatialReference.toJson())),i.value.geometry.addPath([[r.xmin,r.ymin],[r.xmax,r.ymax]]))),i}}});return l("extend-esri")&&a.setObject("dijit.analysis.JoinFeatures",$,D),$});