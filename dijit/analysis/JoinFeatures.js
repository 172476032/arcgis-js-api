// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["esri/layers/FeatureLayer","require","dojo/aspect","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/has","dojo/on","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/store/Memory","dojo/_base/fx","dojo/fx/easing","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/layout/AccordionContainer","dijit/TitlePane","dijit/form/FilteringSelect","dijit/form/Select","dijit/form/TextBox","dijit/Dialog","../../kernel","../../lang","./utils","./AnalysisBase","./CreditEstimator","./_AnalysisOptions","../CalculateField","dojo/i18n!../../nls/jsapi","dojo/text!./templates/JoinFeatures.html"],function(t,e,i,s,a,n,o,l,r,h,d,c,u,p,y,_,g,m,b,f,L,w,v,S,j,R,A,J,T,O,C,D,x,F,P,I,G,N,E,U,M){var k=s([L,w,v,S,j,N,I],{declaredClass:"esri.dijit.analysis.JoinFeatures",templateString:M,widgetsInTemplate:!0,showGeoAnalyticsParams:!0,showTemporalJoin:!0,showAttributeJoin:!0,showSpatialJoin:!0,showJoinCondition:!0,i18n:null,toolName:"JoinFeatures",helpFileName:"JoinFeatures",resultParameter:"output",constructor:function(t,e){this.targetLayers=[],this.joinLayers=[],this._pbConnects=[],this._statsRows=[],this._attrJoinRows=[],t.containerNode&&(this.container=t.containerNode)},postCreate:function(){this.inherited(arguments),this._buildUI()},postMixInProperties:function(){this.inherited(arguments),a.mixin(this.i18n,U.expressionForm),a.mixin(this.i18n,U.joinFeaturesTool),this.joinOperation||(this.joinOperation="JoinOneToOne"),this.joinOperationTypes=[{value:"JoinOneToOne",label:this.i18n.oneToOneLabel},{value:"JoinOneToMany",label:this.i18n.oneToManyLabel}],this.spatialDistance=this.spatialRelationshipDistance||this.spatialNearDistance||0,this.spatialUnit=this.spatialRelationshipDistanceUnits||this.spatialNearDistanceUnit||this.i18n.feet,this.spatialUnitTypes=[{value:"Miles",label:this.i18n.miles},{value:"Yards",label:this.i18n.yards},{value:"Feet",label:this.i18n.feet},{value:"NauticalMiles",label:this.i18n.nautMiles},{type:"separator"},{value:"Kilometers",label:this.i18n.kilometers},{value:"Meters",label:this.i18n.meters}],this.temporalDistance=0,this.temporalUnit=this.i18n.years,this.temporalUnitTypes=[{value:"Years",label:this.i18n.years},{value:"Months",label:this.i18n.months},{value:"Weeks",label:this.i18n.weeks},{value:"Days",label:this.i18n.days},{value:"Hours",label:this.i18n.hours},{value:"Minutes",label:this.i18n.minutes},{value:"Seconds",label:this.i18n.seconds},{value:"Milliseconds",label:this.i18n.milliseconds}],this.attributeType=[{value:"Equal",label:this.i18n.equalSign}]},startup:function(){},_buildUI:function(){var t,e=!0;if(this._outputName.set("validator",a.hitch(this,this.validateServiceName)),this.signInPromise.then(a.hitch(this,P.initHelpLinks,this.domNode,this.showHelp,{analysisGpServer:this.analysisGpServer})),P.updateDisplay([this._temporalJoinNode],this.showTemporalJoin,"table"),P.updateDisplay([this._spatialJoinNode],this.showSpatialJoin,"table"),P.updateDisplay([this._attributeJoinNode],this.showAttributeJoin,"table"),P.updateDisplay([this._joinConditionNode],this.showJoinCondition,"table"),this.showJoinCondition||p.set(this._resultStepLabel,"innerHTML",this.i18n.fiveLabel),this.showGeoAnalyticsParams||(p.set(this._joinOptionsLabel,"innerHTML",this.i18n.joinOptionsStdLabel),p.set(this._joinOptionsHelpNode,"esriHelpTopic","joinType")),n.forEach(this.joinOperationTypes,function(t,e){this._joinOperation.addOption({value:t.value,label:t.label})},this),this.joinOperation&&(this._joinOperation.set("value",this.joinOperation),"JoinOneToMany"===this.joinOperation&&P.updateDisplay([this._joinOperationLabelRow,this._summaryStatisticRow],"JoinOneToOne"===this.joinOperation,"table-row")),n.forEach(this.spatialUnitTypes,function(t,e){this._spatialUnitSelect.addOption({value:t.value,label:t.label})},this),this.spatialUnit&&this._spatialUnitSelect.set("value",this.spatialUnit),n.forEach(this.temporalUnitTypes,function(t,e){this._temporalUnitSelect.addOption({value:t.value,label:t.label})},this),this.temporalUnit&&this._temporalUnitSelect.set("value",this.temporalUnit),F.isDefined(this.targetLayer)&&(t=n.indexOf(this.targetLayers,this.targetLayer),-1===t&&n.forEach(this.targetLayers,function(e,i){e&&(e.url&&this.targetLayer.url&&e.url===this.targetLayer.url||e.name===this.targetLayer.name)&&(t=i)},this),-1===t&&this.targetLayers.push(this.targetLayer)),F.isDefined(this.joinLayer)&&(t=n.indexOf(this.joinLayers,this.joinLayer),-1===t&&n.forEach(this.joinLayers,function(e,i){e&&(e.url&&this.joinLayer.url&&e.url===this.joinLayer.url||e.name===this.joinLayer.name)&&(t=i)},this),-1===t&&this.joinLayers.push(this.joinLayer)),F.isDefined(this.targetLayers)&&this.targetLayers.length>0){var i=[];this.rerun&&!this.targetLayer&&P.addBlankOption(this._targetLayerSelect,i),n.forEach(this.targetLayers,function(t,e){i.push({value:this._toString(e),label:t.name,selected:t.url&&this.targetLayer&&this.targetLayer.url&&t.url===this.targetLayer.url||t&&this.targetLayer&&!t.url&&!this.targetLayer.url&&t.name===this.targetLayer.name})},this),this._targetLayerSelect.addOption(i),F.isDefined(this.targetLayer)||this.rerun||this.set("targetLayer",this.targetLayers[this._targetLayerSelect.get("value")])}else console.log("Please input an array of targetLayers, or set a specific targetLayer.");if(F.isDefined(this.joinLayers)&&this.joinLayers.length>0){var s=[];this.rerun&&!this.joinLayer&&P.addBlankOption(this._joinLayerSelect,s),n.forEach(this.joinLayers,function(t,e){s.push({value:this._toString(e),label:t.name,selected:t.url&&this.joinLayer&&this.joinLayer.url&&t.url===this.joinLayer.url||t&&this.joinLayer&&!t.url&&!this.joinLayer.url&&t.name===this.joinLayer.name})},this),this._joinLayerSelect.addOption(s),F.isDefined(this.joinLayer)||this.rerun||this.set("joinLayer",this.joinLayers[this._joinLayerSelect.get("value")])}else console.log("Please input an array of joinLayers, or set a specific joinLayer.");P.addReadyToUseLayerOption(this,[this._targetLayerSelect,this._joinLayerSelect]),u.set(this._chooseFolderRow,"display",this.showSelectFolder===!0?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(a.hitch(this,function(t){this.folderStore=t,P.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})),u.set(this._showCreditsLink,"display",this.showCredits===!0?"block":"none"),this._loadConnections(),this.outputLayerName&&(this._outputName.set("value",this.outputLayerName),e=!1),e=!(this.outputLayerName||this.spatialRelationship||this.temporalRelationship||this.attributeRelationship),this.joinCondition&&this._bufFieldOutput.set("value",this.joinCondition),this._updateAnalysisLayerUI(e)},_handleTargetLayerChange:function(t){var e;"browse"===t?(this._analysisquery||(this._analysisquery=this._browsedlg.browseItems.get("query")),this._browsedlg.browseItems.set("query",this._analysisquery),this._isAnalysisSelect=!0,this._browsedlg.show()):"browselayers"===t?(this.showGeoAnalyticsParams&&(e=this._browseLyrsdlg.browseItems.get("query"),e.types.push('type:"Big Data File Share"'),this._browseLyrsdlg.browseItems.set("query",e),this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!1,this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!0),this._isAnalysisSelect=!0,this._browseLyrsdlg.show()):(this.set("targetLayer",this.targetLayers[t]),this._updateAnalysisLayerUI(!0))},_toString:function(t){return""+t},_handleJoinLayerChange:function(t){var e;"browse"===t?(this._analysisquery||(this._analysisquery=this._browsedlg.browseItems.get("query")),this._browsedlg.browseItems.set("query",this._analysisquery),this._isAnalysisSelect=!1,this._browsedlg.show()):"browselayers"===t?(this.showGeoAnalyticsParams&&(e=this._browseLyrsdlg.browseItems.get("query"),e.types.push('type:"Big Data File Share"'),this._browseLyrsdlg.browseItems.set("query",e),this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!1,this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!0),this._isAnalysisSelect=!1,this._browseLyrsdlg.show()):(this.set("joinLayer",this.joinLayers[t]),this._updateAnalysisLayerUI(!0))},_handleJoinOperationChange:function(t){t!==this.joinOperation&&(this._removeStatsRows(),"JoinOneToOne"===t&&F.isDefined(this.joinLayer)&&F.isDefined(this.targetLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")&&this._createStatsRow(),P.updateDisplay([this._joinOperationLabelRow,this._summaryStatisticRow],"JoinOneToOne"===t,"table-row"),this.joinOperation=t)},_handleSpatialCheckChange:function(t,e){g.toggle(this._spatialJoin,"selected"),this.spatialJoin=g.contains(this._spatialJoin,"selected"),F.isDefined(this.targetLayer)&&F.isDefined(this.joinLayer)&&this._repopulateSpatialTypes(this.targetLayer.geometryType,this.joinLayer.geometryType,e),this.spatialJoin||g.add(this._spatialDistanceRow,"hide"),g.toggle(this._spatialRelationshipRow,"hide"),g.contains(this._spatialRelationshipRow,"hide")&&this._spatialDistanceInput.set("required",!1)},_handleSpatialRelationshipChange:function(t){this.spatialRelationship=t,"Near"===t||"withindistance"===t?(this._spatialDistanceInput.set("required",!0),g.remove(this._spatialDistanceRow,"hide")):(g.add(this._spatialDistanceRow,"hide"),this._spatialDistanceInput.set("required",!1))},_handleSpatialDistanceChange:function(t){this.spatialDistance=t},_handleSpatialUnitChange:function(t){this.spatialUnit=t},_handleExpBtnClick:function(){this._calcField.set("expression",this._bufFieldOutput.get("value")),x.show(this._calcField.domNode),this._exprDialog.show()},_repopulateSpatialTypes:function(t,e,i){this._spatialRelationshipSelect.removeOption(this._spatialRelationshipSelect.getOptions());var s,a={value:this.showGeoAnalyticsParams?"Equals":"identicalto",label:this.showGeoAnalyticsParams?this.i18n.equalsLabel:this.i18n.identical},o={value:this.showGeoAnalyticsParams?"Intersects":"intersects",label:this.i18n.intersectsLabel},l={value:this.showGeoAnalyticsParams?"Contains":"completelycontains",label:this.showGeoAnalyticsParams?this.i18n.containsLabel:this.i18n.completelyContains},r={value:this.showGeoAnalyticsParams?"Within":"completelywithin",label:this.showGeoAnalyticsParams?this.i18n.withinLabel:this.i18n.completelyWithin},h={value:"Crosses",label:this.i18n.crossesLabel},d={value:"Touches",label:this.i18n.touchesLabel},c={value:"Overlaps",label:this.i18n.overlapsLabel},u={value:this.showGeoAnalyticsParams?"Near":"withindistance",label:this.showGeoAnalyticsParams?this.i18n.near:this.i18n.withinDistance};s={esriGeometryPoint:{esriGeometryPoint:this.showGeoAnalyticsParams?[a,o,l,r,c,u]:[a,o,l,r,u],esriGeometryPolyline:this.showGeoAnalyticsParams?[o,r,d,u]:[o,r,u],esriGeometryPolygon:this.showGeoAnalyticsParams?[o,r,d,u]:[o,r,u]},esriGeometryPolyline:{esriGeometryPoint:this.showGeoAnalyticsParams?[o,l,d,u]:[o,l,u],esriGeometryPolyline:this.showGeoAnalyticsParams?[a,o,l,r,h,d,c,u]:[a,o,l,r,u],esriGeometryPolygon:this.showGeoAnalyticsParams?[o,r,h,d,u]:[o,r,u]},esriGeometryPolygon:{esriGeometryPoint:this.showGeoAnalyticsParams?[o,l,d,u]:[o,l,u],esriGeometryPolyline:this.showGeoAnalyticsParams?[o,l,h,d,u]:[o,l,u],esriGeometryPolygon:this.showGeoAnalyticsParams?[a,o,l,r,d,c,u]:[a,o,l,r,u]}},i||(this.spatialRelationship=s[t][e][0].value),n.forEach(s[t][e],function(t,e){this._spatialRelationshipSelect.addOption({value:t.value,label:t.label})},this),this._spatialRelationshipSelect.set("value",this.spatialRelationship)},_handleTemporalCheckChange:function(t,e){if(g.toggle(this._temporalJoin,"selected"),this.temporalJoin=g.contains(this._temporalJoin,"selected"),F.isDefined(this.targetLayer)&&F.isDefined(this.joinLayer)){var i,s;i=P.isTimeInstantLayer(this.targetLayer)?"TimeInstant":"TimeInterval",s=P.isTimeInstantLayer(this.joinLayer)?"TimeInstant":"TimeInterval",this._repopulateTemporalTypes(i,s,e)}t||g.add(this._temporalDistanceRow,"hide"),g.toggle(this._temporalRelationshipRow,"hide"),g.contains(this._temporalRelationshipRow,"hide")&&this._temporalDistanceInput.set("required",!1)},_handleTemporalRelationshipChange:function(t){this.temporalRelationship=t,"Near"===t?(this._temporalDistanceInput.set("required",!0),g.remove(this._temporalDistanceRow,"hide")):(g.add(this._temporalDistanceRow,"hide"),this._temporalDistanceInput.set("required",!1))},_handleTemporalDistanceChange:function(t){this.temporalDistance=t},_handleTemporalUnitChange:function(t){this.temporalUnit=t},_repopulateTemporalTypes:function(t,e,i){this._temporalRelationshipSelect.removeOption(this._temporalRelationshipSelect.getOptions());var s,a={value:"Equals",label:this.i18n.equalsLabel},o={value:"Intersects",label:this.i18n.intersectsLabel},l={value:"During",label:this.i18n.duringLabel},r={value:"Contains",label:this.i18n.containsLabel},h={value:"Finishes",label:this.i18n.finishesLabel},d={value:"Finished By",label:this.i18n.finishedByLabel},c={value:"Meets",label:this.i18n.meetsLabel},u={value:"Met By",label:this.i18n.metByLabel},p={value:"Near",label:this.i18n.near},y={value:"Overlaps",label:this.i18n.overlapsLabel},_={value:"Overlapped By",label:this.i18n.overlappedByLabel},g={value:"Starts",label:this.i18n.startsLabel},m={value:"Started By",label:this.i18n.startedByLabel};t&&e&&(s={TimeInstant:{TimeInstant:[a,o,p],TimeInterval:[o,l,h,g,p]},TimeInterval:{TimeInstant:[o,r,d,m,p],TimeInterval:[a,o,l,r,h,d,c,u,y,_,g,m,p]}}),i||(this.temporalRelationship=s[t][e][0].value),n.forEach(s[t][e],function(t,e){this._temporalRelationshipSelect.addOption({value:t.value,label:t.label})},this)},_handleAttributeCheckChange:function(t,e){g.toggle(this._attributeJoin,"selected"),this.attributeJoin=g.contains(this._attributeJoin,"selected"),g.toggle(this._attributeRelationshipRow,"hide"),e||(this.attributeJoin===!0?this._createAttrJoinRow():this._removeAttrJoinRows())},_createAttrJoinRow:function(t){var i,s,l,r,h,d,c,p,_;return i=y.create("tr",{style:{height:"40px"}},this._attributeRelationshipRow,"before"),l=y.create("td",{style:{width:"39%"}},i),r=y.create("td",{style:{width:"8%"}},i),s=y.create("td",{style:{width:"39%"}},i),h=new O({maxHeight:200,"class":"esriLeadingMargin1 esriTrailingMargin1 mediumInput esriVeryShortlabel",style:{width:"90%",overflow:"hidden",tableLayout:"fixed"}},y.create("select",null,l)),h.addOption({value:"",label:this.i18n.selectTargetField}),n.forEach(this.targetLayer.fields,function(t,e){h.addOption({value:this._toString(e+1),label:t.name})},this),h.set("targetLayer",this.targetLayer),h.set("joinLayer",this.joinLayer),r.innerHTML="=",u.set(r,"text-align","center"),d=new O({"class":"mediumInput esriLeadingMargin05 esriVeryShortlabel",style:{width:"90%",overflow:"hidden",tableLayout:"fixed"}},y.create("select",null,s)),d.addOption({value:"",label:this.i18n.selectJoinField}),h.set("statisticSelect",d),o.connect(h,"onChange",this._handleAttrTargetChange),p=y.create("td",{"class":"shortTextInput removeTd",style:{display:"none",width:"10%",paddingTop:"1em"}},i),c=y.create("a",{title:this.i18n.remove,"class":"closeIcon statsRemove",innerHTML:"<img src='"+e.toUrl("./images/close.gif")+"' border='0''/>"},p),o.connect(c,"onclick",a.hitch(this,this._removeAttrJoinRow,i)),this._attrJoinRows.push(i),1===this._attrJoinRows.length&&(h.set("required","true"),d.set("required","true")),_=y.create("td",{style:{width:"10%",display:"block"}},i),d.set("attributeSelect",h),d.set("removeTd",p),d.set("stylingTd",_),d.set("isnewRowAdded",!1),d.set("referenceWidget",this),h.set("referenceWidget",this),d._watchHandle=d.watch("value",this._handleAttrJoinUpdate),this._currentJoinSelect=d,this._currentTargetSelect=h,!0},_removeAttrJoinRow:function(t){n.forEach(R.findWidgets(t),function(t){t.destroyRecursive()}),y.destroy(t)},_removeAttrJoinRows:function(){n.forEach(this._attrJoinRows,this._removeAttrJoinRow,this),this._attrJoinRows=[]},_handleAttrTargetChange:function(t,e,i){var s,o,l,r,h,d,c=[];s=this.get("statisticSelect"),t!==this._curTargetAttrValue&&(e&&i||n.forEach(s.getOptions(),function(t){""!==t.value&&s.removeOption(t)},this),""!==t&&(e&&i&&(s.removeOption(s.getOptions()),c.push({value:"",label:this.referenceWidget.i18n.selectJoinField,selected:!1})),r=this.get("targetLayer").fields[t-1]&&this.get("targetLayer").fields[t-1].type,n.forEach(this.get("joinLayer").fields,function(t,s){t.type===r&&(e&&i&&i.joinField===t.name&&(d=s+1+""),c.push({value:s+1+"",label:t.name,selected:e&&i&&i.joinField===t.name}))},this),s._watchHandle&&e&&i&&s._watchHandle.unwatch(),s.addOption(c),s.set("value",d),""!==s.get("value")&&(s.get("isnewRowAdded")||(o=s.get("removeTd"),h=s.get("stylingTd"),u.set(o,"display","block"),u.set(h,"display","none"),l=s.get("referenceWidget"),a.hitch(l,l._createAttrJoinRow)(),s.set("isnewRowAdded",!0)))),this._curTargetAttrValue=t)},_handleAttrJoinUpdate:function(t,e,i){var s,n,o;this.get("attributeSelect")&&(s=this.get("attributeSelect"),""!==s.get("value")&&""!==i&&(this.get("isnewRowAdded")||(n=this.get("removeTd"),u.set(n,"display","block"),o=this.get("referenceWidget"),a.hitch(o,o._createAttrJoinRow)(),this.set("isnewRowAdded",!0))))},_createStatsRow:function(t){var i,s,n,l,r,d;return i=y.create("tr",{style:{height:"40px"}},this._summaryStatisticRow,"before"),s=y.create("td",{colspan:"3",style:{width:"65%"}},i),n=new O({maxHeight:200,"class":"esriLeadingMargin1 mediumInput esriTrailingMargin025 attrSelect",style:{tableLayout:"fixed",overflowX:"hidden",width:"45%"}},y.create("select",null,s)),P.addAttributeOptions({selectWidget:n,layer:this.joinLayer,allowStringType:this.showGeoAnalyticsParams}),l=new O({"class":"esriLeadingMargin1 mediumInput statsSelect",style:{tableLayout:"fixed",overflowX:"hidden",width:"45%"}},y.create("select",null,s)),P.addStatisticsOptions({selectWidget:l,showGeoAnalyticsParams:this.showGeoAnalyticsParams}),n.set("statisticSelect",l),n.set("featureLayer",this.joinLayer),n.set("showGeoAnalyticsParams",this.showGeoAnalyticsParams),n._onChangeHandle=h.pausable(n,"change",a.partial(this._handleAttrSelectChange,{showGeoAnalyticsParams:this.showGeoAnalyticsParams})),t?n._onChangeHandle.pause():n._onChangeHandle.resume(),this.showGeoAnalyticsParams&&n.watch("value",this._handleAtrrValueUpdate),d=y.create("td",{"class":"shortTextInput removeTd",style:{visibility:"hidden",maxWidth:"12px",paddingTop:"1em"}},i),r=y.create("a",{title:this.i18n.remove,"class":"closeIcon statsRemove",innerHTML:"<img src='"+e.toUrl("./images/close.gif")+"' border='0''/>"},d),o.connect(r,"onclick",a.hitch(this,this._removeStatsRow,i)),this._statsRows.push(i),l.set("attributeSelect",n),l.set("removeTd",d),l.set("isnewRowAdded",!1),l.set("referenceWidget",this),l.watch("value",this._handleStatsValueUpdate),this._currentStatsSelect=l,this._currentAttrSelect=n,!0},_removeStatsRow:function(t){n.forEach(R.findWidgets(t),function(t){t.destroyRecursive()}),y.destroy(t)},_removeStatsRows:function(){n.forEach(this._statsRows,this._removeStatsRow,this),this._statsRows=[]},_handleAttrSelectChange:function(t,e){var i,s,n,o,l;"0"!==e&&(i=this.get("statisticSelect"),o=i.get("referenceWidget"),l=this.getOptions(e),l&&l.type&&P.addStatisticsOptions({selectWidget:i,type:l.type,showGeoAnalyticsParams:t.showGeoAnalyticsParams}),i&&!i.get("isnewRowAdded")&&"0"!==i.get("value")&&""!==i.get("value")&&"0"!==this.get("value")&&""!==this.get("value")&&(s=i.get("removeTd"),u.set(s,"visibility","visible"),n=i.get("referenceWidget"),a.hitch(n,n._createStatsRow)(),i.set("isnewRowAdded",!0)))},_handleStatsValueUpdate:function(t,e,i){var s,n,o;this.get("attributeSelect")&&(s=this.get("attributeSelect"),"0"!==s.get("value")&&"0"!==i&&""!==i&&""!==s.get("value")&&(this.get("isnewRowAdded")||(n=this.get("removeTd"),u.set(n,"visibility","visible"),o=this.get("referenceWidget"),a.hitch(o,o._createStatsRow)(),this.set("isnewRowAdded",!0))))},_handleShowCreditsClick:function(t){var e={};t.preventDefault(),this._form.validate()&&(e=this._buildJobParams(),this.getCreditsEstimate(this.toolName,e).then(a.hitch(this,function(t){this._usageForm.set("content",t),this._usageDialog.show()})))},_buildJobParams:function(){var t,e={};if(e.targetLayer=this.constructAnalysisInputLyrObj(this.targetLayer),this.doRefreshItem="table"!==this.targetLayer.type.toLowerCase(),e.joinLayer=this.constructAnalysisInputLyrObj(this.joinLayer),this.showGeoAnalyticsParams||(e.targetLayer=l.toJson(e.targetLayer),e.joinLayer=l.toJson(e.joinLayer)),e.joinOperation=this.get("joinOperation"),this._bufFieldOutput.get("value")&&(e.joinCondition=this._bufFieldOutput.get("value")),this.spatialJoin&&(e.spatialRelationship=this._spatialRelationshipSelect.get("value"),("Near"===this._spatialRelationshipSelect.get("value")||"withindistance"===this._spatialRelationshipSelect.get("value"))&&(this.showGeoAnalyticsParams?(e.spatialNearDistance=parseFloat(this.get("spatialDistance")),e.spatialNearDistanceUnit=this._spatialUnitSelect.get("value")):(e.spatialRelationshipDistance=parseFloat(this.get("spatialDistance")),e.spatialRelationshipDistanceUnits=this._spatialUnitSelect.get("value")))),this.temporalJoin&&(e.temporalRelationship=this._temporalRelationshipSelect.get("value"),"Near"===this._temporalRelationshipSelect.get("value")&&(e.temporalNearDistance=parseFloat(this.get("temporalDistance")),e.temporalNearDistanceUnit=this._temporalUnitSelect.get("value"))),this.attributeJoin){var i="",s=[],a=0;n.forEach(this._attrJoinRows,function(t,e,o){var r=t.children,h="",d={},c=0;n.forEach(r,function(t,e){if(3>e){if(1!==e)var i=R.byNode(t.children[0]).get("value");0===e&&""!==i&&(c++,h+='target["'+t.textContent+'"]',d.targetField=t.textContent),1===e&&(c++,h+=" "+t.textContent+" ",d.operator="="===t.textContent?"equal":t.textContent),2===e&&""!==i&&(c++,h+='join["'+t.textContent+'"]',d.joinField=t.textContent)}},this),3===c&&(0!==a&&(i+=" and "),i+=h,s.push(this.showGeoAnalyticsParams?d:l.toJson(d)),a++)},this),e.attributeRelationship=this.showGeoAnalyticsParams?l.toJson(s):s}return"JoinOneToOne"===this._joinOperation.get("value")&&this._statsRows.length>=2&&(e.summaryFields=[],t=this.get("summaryFields"),e.summaryFields=this.showGeoAnalyticsParams?l.toJson(t):t),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(e.context=l.toJson({extent:this.map.extent._normalize(!0)})),e.OutputName=l.toJson({serviceProperties:{name:this._outputName.get("value")}}),e},_handleSaveBtnClick:function(){var t,e={},i={};if(this._form.validate()){if("_NOVALUE_"===this._joinLayerSelect.get("value"))return void this._showMessages(this.i18n.joinLayerErrorMsg);if("_NOVALUE_"===this._joinOperation.get("value"))return void this._showMessages(this.i18n.joinOpErrorMsg);if(!(this.attributeJoin||this.temporalJoin||this.spatialJoin))return void this._showMessages(this.i18n.joinTypesErrorMsg);if(this._handleCloseMsg(),this._saveBtn.set("disabled",!0),e=this._buildJobParams(),i.jobParams=e,i.itemParams={description:this.i18n.itemDescription,tags:this.i18n.itemTags,snippet:this.i18n.itemSnippet},this.showSelectFolder&&(i.itemParams.folder=this.get("folderId")),this.showGeoAnalyticsParams){if(t=P.checkPCSforAnalysis({widget:this,jobParams:e}),!t)return;i.isSpatioTemporalDataStore=!0}this.resultParameter=this.showGeoAnalyticsParams?"output":"outputLayer",this.execute(i)}},_setDisableRunAnalysisAttr:function(t){this._saveBtn.set("disabled",t)},_setTargetLayerAttr:function(t){this._set("targetLayer",t||null)},_setTargetLayersAttr:function(t){this._set("targetLayers",t||[])},_setJoinLayerAttr:function(t){this._set("joinLayer",t||null)},_setShowSpatialJoinAttr:function(t){this._set("showSpatialJoin",t)},_setShowAttributeJoinAttr:function(t){this._set("showAttributeJoin",t)},_setShowTemporalJoinAttr:function(t){this._set("showTemporalJoin",t)},_setShowJoinConditionAttr:function(t){this._set("showJoinCondition",t)},_setJoinLayersAttr:function(t){this._set("joinLayers",t||[])},_handleBrowseItemsSelect:function(t){t&&t.selection&&P.addAnalysisReadyLayer({item:t.selection,layers:this._isAnalysisSelect?this.targetLayers:this.joinLayers,layersSelect:this._isAnalysisSelect?this._targetLayerSelect:this._joinLayerSelect,posIncrement:(this._isAnalysisSelect,0),browseDialog:t.dialog||this._browsedlg,widget:this}).always(a.hitch(this,function(){this._isAnalysisSelect?this._handleTargetLayerChange(this._targetLayerSelect.get("value")):this._handleJoinLayerChange(this._joinLayerSelect.get("value"))}))},_save:function(){},_onClose:function(t){t&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:t})},_loadConnections:function(){this.on("start",a.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",a.hitch(this,"_onClose",!1)),this._spatialJoinHandle=h.pausable(this._spatialJoinCtr,"click",a.hitch(this,this._handleSpatialCheckChange)),this._temporalJoinHandle=h.pausable(this._temporalJoinCtr,"click",a.hitch(this,this._handleTemporalCheckChange)),this._attributeJoinHandle=h.pausable(this._attributeJoinCtr,"click",a.hitch(this,this._handleAttributeCheckChange)),this.own(this._spatialJoinHandle,this._temporalJoinHandle,this._attributeJoinHandle)},_connect:function(t,e,i){this._pbConnects.push(o.connect(t,e,i))},_updateAnalysisLayerUI:function(t){if(this._expBtn.set("disabled",!this.targetLayer),this._bufFieldOutput.set("disabled",!this.targetLayer),this.targetLayer){var e,s,o,l=this._joinLayerSelect.getOptions(),r=!1,h=!1;t&&(this.outputLayerName=c.substitute(this.i18n.outputLayerName,{targetLayerName:this.targetLayer.name}),this._outputName.set("value",this.outputLayerName)),this._isAnalysisSelect&&(r=n.some(l,function(t,e){return t.label===this.targetLayer.title},this),r||(s=this.showBrowseLayers&&this.showReadyToUseLayers?3:!this.showBrowseLayers&&this.showReadyToUseLayers?2:this.showBrowseLayers&&!this.showReadyToUseLayers?2:0,e=l.splice(l.length-s,s),h=n.some(this.joinLayers,function(t){return t&&t.analysisReady&&this.targetLayer.analysisReady&&t.itemId===this.targetLayer.itemId},this),h||(0===this.joinLayers.length&&(this.joinLayer=this.targetLayer),this.joinLayers.push(this.targetLayer)),e.unshift({value:this.joinLayers.length-1,label:this.targetLayer.title}),this._joinLayerSelect.addOption(e)));var d,p,y={};if(p=n.map(this.targetLayer.fields,function(t){var e=a.clone(t);return a.mixin(e,{name:'target["'+t.name+'"]',alias:'target["'+t.alias+'"]'}),e},this),d=n.map(this.joinLayer.fields,function(t){var e=a.clone(t);return a.mixin(e,{name:'join["'+t.name+'"]',alias:'join["'+t.alias+'"]'}),e},this),y.fields=[].concat(d,p),this._calcField)this._calcField&&this._calcField.layer!==this.inputLayer&&(this._bufFieldOutput.set("value",""),this._calcField.reset(),this._calcField.set("layer",y));else{var _=P.getExprFunctions();_=n.filter(_,function(t){return t&&t.name&&-1===t.name.indexOf("as_")}),this._calcField=new E({expressionMode:E.MODE_ARCADE,arcadeEditor:this.arcadeEditor,map:this.map,layer:y,field:this.i18n.bufField,baseClass:"esriBufFieldExp",helperMethods:_,showHelp:!0,helpUrl:P.getHelpUrl({widget:this,topic:"BufferExpression"}),css:{base:"esriBufFieldExp",addButton:"btn calcite primary",closeButton:"btn calcite cancel"},helperType:"numeric",showHeader:!1,calculateLabel:this.i18n.add},this._expressionCtr),this._calcField.startup(),this._calcField.expressionMode===E.MODE_SQL?(u.set(this._calcField._validateBtn.domNode,"display","none"),this._calcField._handleHelperTypeChange("value",null,{functionType:"NumType"}),this._aspectHandle=i.around(this._calcField,"_handleAddButtonClick",a.hitch(this,function(t){return a.hitch(this,function(t,e){var i=this._calcField.get("expression")[0];this._bufFieldOutput.set("value",i.sqlExpression),this._exprDialog.hide()})}))):this._calcField.expressionMode===E.MODE_ARCADE&&this._calcField.on("expression-add",a.hitch(this,function(t){this._bufFieldOutput.set("value",t.expression)})),this._calcField.on("close",a.hitch(this,function(){this._exprDialog.hide()}))}}t?(this.spatialJoin=!1,this.attributeJoin=!1,this.temporalJoin=!1,this._removeStatsRows(),this._removeAttrJoinRows(),g.contains(this._spatialJoin,"selected")&&(g.remove(this._spatialJoin,"selected"),g.add(this._spatialDistanceRow,"hide"),g.add(this._spatialRelationshipRow,"hide"),this._spatialRelationshipSelect.reset(),this._spatialDistanceInput.set("required",!1)),g.contains(this._temporalJoin,"selected")&&(g.remove(this._temporalJoin,"selected"),g.add(this._temporalRelationshipRow,"hide"),g.add(this._temporalDistanceRow,"hide"),this._temporalDistanceInput.set("required",!1)),g.contains(this._attributeJoin,"selected")&&(g.remove(this._attributeJoin,"selected"),g.add(this._attributeRelationshipRow,"hide")),F.isDefined(this.targetLayer)&&F.isDefined(this.joinLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")?("JoinOneToOne"===this._joinOperation.get("value")&&this._createStatsRow(),g.remove(this._spatialJoin,"disabled"),g.remove(this._attributeJoin,"disabled"),g.remove(this._spatialJoinLabel,"esriAnalysisTextDisabled"),this._spatialJoinHandle.resume()):(g.add(this._spatialJoin,"disabled"),g.add(this._attributeJoin,"disabled"),g.add(this._temporalJoin,"disabled"),g.add(this._spatialJoinLabel,"esriAnalysisTextDisabled"),g.add(this._attrJoinLabel,"esriAnalysisTextDisabled"),g.add(this._temporalJoinLabel,"esriAnalysisTextDisabled"),this._attributeJoinHandle.pause(),this._spatialJoinHandle.pause(),this._temporalJoinHandle.pause())):(this.spatialRelationship&&(this.spatialJoin=!0,this._spatialRelationshipSelect.set("value",this.spatialRelationship),this._handleSpatialCheckChange(this.spatialJoin,!t),this.spatialDistance&&this._spatialDistanceInput.set("value",this.spatialDistance)),this.attributeRelationship&&(this.attributeJoin=!0,this._handleAttributeCheckChange(this.attributeJoin,!t),this.attributeRelationship&&this.targetLayer&&this.joinLayer&&(this._isAttrAdded=!1,this._createAttrJoinRow(this.attributeRelationship),this.attributeRelationship&&!this.attributeRelationship.length&&(this.attributeRelationship=[this.attributeRelationship]),n.forEach(this.attributeRelationship,function(e){var i=n.map(this.targetLayer.fields,function(t){return t.name}),s=n.indexOf(i,e.targetField);this._currentTargetSelect.set("value",s+1+""),a.hitch(this._currentTargetSelect,this._handleAttrTargetChange,this._currentTargetSelect.get("value"),!t,e)()},this),this._isAttrAdded=!0)),!this.spatialRelationship&&F.isDefined(this.targetLayer)&&F.isDefined(this.joinLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")&&("JoinOneToOne"!==this._joinOperation.get("value")||this.summaryFields||this._createStatsRow()),this.temporalRelationship&&(this.temporalJoin=!0,this._handleTemporalCheckChange(this.temporalJoin,!t),this._temporalRelationshipSelect.set("value",this.temporalRelationship)),this.summaryFields&&(this._createStatsRow(!t),n.forEach(this.summaryFields,function(t){this._currentAttrSelect.set("value",t.onStatisticField),this._currentStatsSelect.set("value",t.statisticType)},this))),F.isDefined(this.targetLayer)&&F.isDefined(this.joinLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")&&(o=!(P.isTimeEnabled(this.joinLayer)&&P.isTimeEnabled(this.targetLayer)),g.toggle(this._temporalJoin,"disabled",o),g.toggle(this._temporalJoinLabel,"esriAnalysisTextDisabled",o),this._attributeJoinHandle.resume(),o?this._temporalJoinHandle.pause():this._temporalJoinHandle.resume()),F.isDefined(this.targetLayer)&&F.isDefined(this.joinLayer)&&(this.targetLayer.type&&"table"===this.targetLayer.type.toLowerCase()||this.joinLayer.type&&"table"===this.joinLayer.type.toLowerCase())&&(g.add(this._spatialJoin,"disabled"),g.add(this._spatialJoinLabel,"esriAnalysisTextDisabled"),this._spatialJoinHandle.pause())},_setAttributeRelationshipAttr:function(t){var e,i=[];t&&"string"==typeof t&&(e=t.split(" and "),n.forEach(e,function(t){var e=t.split(" = ");i.push({targetField:-1!==e[0].indexOf('["')?e[0].substring(e[0].indexOf('["')+2,e[0].indexOf('"]')):e[0],operator:"equal",joinField:-1!==e[1].indexOf('["')?e[1].substring(e[1].indexOf('["')+2,e[1].indexOf('"]')):e[1]
})}),t=i),n.forEach(t,function(e,i){var s="string"==typeof e&&-1!==e.indexOf("{");s&&(t[i]=P.tryParseJSON(e))},this),this.attributeRelationship=t},_setSummaryFieldsAttr:function(t){t&&"object"==typeof t&&!t.length&&(t=[t]),n.forEach(t,function(e,i){var s="string"==typeof e&&-1!==e.indexOf("{");s&&(t[i]=P.tryParseJSON(e))},this),this.summaryFields=t},_getSummaryFieldsAttr:function(){var t,e,i=[];return _(".statsSelect",this.domNode).forEach(function(s,a){if(t=R.byNode(s),e=t.get("attributeSelect"),"0"!==e.get("value")&&"0"!==t.get("value")&&""!==e.get("value")&&""!==t.get("value")){var n={};n.statisticType=t.get("value"),n.onStatisticField=e.get("value"),i.push(this.showGeoAnalyticsParams?n:l.toJson(n))}},this),i},_setAnalysisGpServerAttr:function(t){t&&(this.analysisGpServer=t,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},validateServiceName:function(t){return P.validateServiceName(t,{textInput:this._outputName})},_showMessages:function(t){p.set(this._bodyNode,"innerHTML",t),b.fadeIn({node:this._errorMessagePane,easing:f.quadIn,onEnd:a.hitch(this,function(){u.set(this._errorMessagePane,{display:""})})}).play()},_handleCloseMsg:function(t){t&&t.preventDefault(),b.fadeOut({node:this._errorMessagePane,easing:f.quadOut,onEnd:a.hitch(this,function(){u.set(this._errorMessagePane,{display:"none"})})}).play()}});return r("extend-esri")&&a.setObject("dijit.analysis.JoinFeatures",k,x),k});