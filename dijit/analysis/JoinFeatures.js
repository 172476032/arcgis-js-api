// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["esri/layers/FeatureLayer","require","dojo/aspect","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/has","dojo/on","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/store/Memory","dojo/_base/fx","dojo/fx/easing","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/layout/AccordionContainer","dijit/TitlePane","dijit/form/FilteringSelect","dijit/form/Select","dijit/form/TextBox","dijit/Dialog","../../kernel","../../lang","./utils","./AnalysisBase","./CreditEstimator","./_AnalysisOptions","../CalculateField","dojo/i18n!../../nls/jsapi","dojo/text!./templates/JoinFeatures.html"],function(e,t,i,s,a,n,o,l,r,h,d,c,u,p,y,_,g,m,b,w,L,v,f,S,j,J,A,R,T,C,O,D,I,P,x,F,G,N,M,U,E){var q=s([L,v,f,S,j,N,F],{declaredClass:"esri.dijit.analysis.JoinFeatures",templateString:E,widgetsInTemplate:!0,showGeoAnalyticsParams:!0,showTemporalJoin:!0,showAttributeJoin:!0,showSpatialJoin:!0,showJoinCondition:!0,i18n:null,toolName:"JoinFeatures",helpFileName:"JoinFeatures",resultParameter:"output",constructor:function(e,t){this.targetLayers=[],this.joinLayers=[],this._pbConnects=[],this._statsRows=[],this._attrJoinRows=[],e.containerNode&&(this.container=e.containerNode)},postCreate:function(){this.inherited(arguments),this._buildUI()},postMixInProperties:function(){this.inherited(arguments),a.mixin(this.i18n,U.expressionForm),a.mixin(this.i18n,U.joinFeaturesTool),this.joinOperation="JoinOneToOne",this.joinOperationTypes=[{value:"JoinOneToOne",label:this.i18n.oneToOneLabel},{value:"JoinOneToMany",label:this.i18n.oneToManyLabel}],this.spatialDistance=0,this.spatialUnit=this.i18n.feet,this.spatialUnitTypes=[{value:"Miles",label:this.i18n.miles},{value:"Yards",label:this.i18n.yards},{value:"Feet",label:this.i18n.feet},{value:"NauticalMiles",label:this.i18n.nautMiles},{type:"separator"},{value:"Kilometers",label:this.i18n.kilometers},{value:"Meters",label:this.i18n.meters}],this.temporalDistance=0,this.temporalUnit=this.i18n.years,this.temporalUnitTypes=[{value:"Years",label:this.i18n.years},{value:"Months",label:this.i18n.months},{value:"Weeks",label:this.i18n.weeks},{value:"Days",label:this.i18n.days},{value:"Hours",label:this.i18n.hours},{value:"Minutes",label:this.i18n.minutes},{value:"Seconds",label:this.i18n.seconds},{value:"Milliseconds",label:this.i18n.milliseconds}],this.attributeRelationshipCheck=null,this.attributeRelationship=this.i18n.equalSign,this.attributeType=[{value:"Equal",label:this.i18n.equalSign}]},startup:function(){},_buildUI:function(){var e,t=!0;this._outputName.set("validator",a.hitch(this,this.validateServiceName)),this.signInPromise.then(a.hitch(this,x.initHelpLinks,this.domNode,this.showHelp,{analysisGpServer:this.analysisGpServer})),x.updateDisplay([this._temporalJoinNode],this.showTemporalJoin,"table"),x.updateDisplay([this._spatialJoinNode],this.showSpatialJoin,"table"),x.updateDisplay([this._attributeJoinNode],this.showAttributeJoin,"table"),x.updateDisplay([this._joinConditionNode],this.showJoinCondition,"table"),this.showJoinCondition||p.set(this._resultStepLabel,"innerHTML",this.i18n.fiveLabel),this.showGeoAnalyticsParams||(p.set(this._joinOptionsLabel,"innerHTML",this.i18n.joinOptionsStdLabel),p.set(this._joinOptionsHelpNode,"esriHelpTopic","joinType")),n.forEach(this.joinOperationTypes,function(e,t){this._joinOperation.addOption({value:e.value,label:e.label})},this),n.forEach(this.spatialUnitTypes,function(e,t){this._spatialUnitSelect.addOption({value:e.value,label:e.label})},this),n.forEach(this.temporalUnitTypes,function(e,t){this._temporalUnitSelect.addOption({value:e.value,label:e.label})},this),P.isDefined(this.targetLayer)&&(e=n.indexOf(this.targetLayers,this.targetLayer),-1!==e?this._targetLayerSelect.addOption({value:this._toString(e),label:this.targetLayer.name}):(this._targetLayerSelect.addOption({value:this._toString(this.targetLayers.length-1),label:this.targetLayer.name}),this.targetLayers.push(this.targetLayer))),P.isDefined(this.joinLayer)&&(e=n.indexOf(this.joinLayers,this.joinLayer),-1!==e?this._joinLayerSelect.addOption({value:this._toString(e),label:this.joinLayer.name}):(this._joinLayerSelect.addOption({value:this._toString(this.joinLayers.length-1),label:this.joinLayer.name}),this.joinLayers.push(this.joinLayer))),P.isDefined(this.targetLayers)&&this.targetLayers.length>0?n.forEach(this.targetLayers,function(e,t){this.targetLayer!==e&&this._targetLayerSelect.addOption({value:this._toString(t),label:e.name}),!P.isDefined(this.targetLayer)&&P.isDefined(this.targetLayers[t])&&this.set("targetLayer",this.targetLayers[t])},this):console.log("Please input an array of targetLayers, or set a specific targetLayer."),P.isDefined(this.joinLayers)&&this.joinLayers.length>0?n.forEach(this.joinLayers,function(e,t){this.joinLayer!==e&&this._joinLayerSelect.addOption({value:this._toString(t),label:e.name}),!P.isDefined(this.joinLayer)&&P.isDefined(this.joinLayers[t])&&this.set("joinLayer",this.joinLayers[t])},this):console.log("Please input an array of joinLayers, or set a specific joinLayer."),x.addReadyToUseLayerOption(this,[this._targetLayerSelect,this._joinLayerSelect]),u.set(this._chooseFolderRow,"display",this.showSelectFolder===!0?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(a.hitch(this,function(e){this.folderStore=e,x.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})),u.set(this._showCreditsLink,"display",this.showCredits===!0?"block":"none"),this._loadConnections(),this.outputLayerName&&(this._outputName.set("value",this.outputLayerName),t=!1),this._updateAnalysisLayerUI(t)},_handleTargetLayerChange:function(e){var t;"browse"===e?(this._analysisquery||(this._analysisquery=this._browsedlg.browseItems.get("query")),this._browsedlg.browseItems.set("query",this._analysisquery),this._isAnalysisSelect=!0,this._browsedlg.show()):"browselayers"===e?(this.showGeoAnalyticsParams&&(t=this._browseLyrsdlg.browseItems.get("query"),t.types.push('type:"Big Data File Share"'),this._browseLyrsdlg.browseItems.set("query",t),this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!1,this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!0),this._isAnalysisSelect=!0,this._browseLyrsdlg.show()):(this.set("targetLayer",this.targetLayers[e]),this._updateAnalysisLayerUI(!0))},_toString:function(e){return e+""},_handleJoinLayerChange:function(e){var t;"browse"===e?(this._analysisquery||(this._analysisquery=this._browsedlg.browseItems.get("query")),this._browsedlg.browseItems.set("query",this._analysisquery),this._isAnalysisSelect=!1,this._browsedlg.show()):"browselayers"===e?(this.showGeoAnalyticsParams&&(t=this._browseLyrsdlg.browseItems.get("query"),t.types.push('type:"Big Data File Share"'),this._browseLyrsdlg.browseItems.set("query",t),this._browseLyrsdlg.browseItems.plugIn.checkGeometryType=!1,this._browseLyrsdlg.browseItems.plugIn.checkLayerType=!0),this._isAnalysisSelect=!1,this._browseLyrsdlg.show()):(this.set("joinLayer",this.joinLayers[e]),this._updateAnalysisLayerUI(!0))},_handleJoinOperationChange:function(e){this._removeStatsRows(),"JoinOneToOne"===e&&P.isDefined(this.joinLayer)&&P.isDefined(this.targetLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")&&this._createStatsRow(),x.updateDisplay([this._joinOperationLabelRow,this._summaryStatisticRow],"JoinOneToOne"===e,"table-row"),this.joinOperation=e},_handleSpatialCheckChange:function(e){g.toggle(this._spatialJoin,"selected"),this.spatialJoin=g.contains(this._spatialJoin,"selected"),P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)&&this._repopulateSpatialTypes(this.targetLayer.geometryType,this.joinLayer.geometryType),this.spatialJoin||g.add(this._spatialDistanceRow,"hide"),g.toggle(this._spatialRelationshipRow,"hide"),g.contains(this._spatialRelationshipRow,"hide")&&this._spatialDistanceInput.set("required",!1)},_handleSpatialRelationshipChange:function(e){this.spatialRelationship=e,"Near"===e||"withindistance"===e?(this._spatialDistanceInput.set("required",!0),g.remove(this._spatialDistanceRow,"hide")):(g.add(this._spatialDistanceRow,"hide"),this._spatialDistanceInput.set("required",!1))},_handleSpatialDistanceChange:function(e){this.spatialDistance=e},_handleSpatialUnitChange:function(e){this.spatialUnit=e},_handleExpBtnClick:function(){this._calcField.reset(),this._exprDialog.show()},_repopulateSpatialTypes:function(e,t){this._spatialRelationshipSelect.removeOption(this._spatialRelationshipSelect.getOptions());var i,s={value:this.showGeoAnalyticsParams?"Equals":"identicalto",label:this.showGeoAnalyticsParams?this.i18n.equalsLabel:this.i18n.identical},a={value:this.showGeoAnalyticsParams?"Intersects":"intersects",label:this.i18n.intersectsLabel},o={value:this.showGeoAnalyticsParams?"Contains":"completelycontains",label:this.showGeoAnalyticsParams?this.i18n.containsLabel:this.i18n.completelyContains},l={value:this.showGeoAnalyticsParams?"Within":"completelywithin",label:this.showGeoAnalyticsParams?this.i18n.withinLabel:this.i18n.completelyWithin},r={value:"Crosses",label:this.i18n.crossesLabel},h={value:"Touches",label:this.i18n.touchesLabel},d={value:"Overlaps",label:this.i18n.overlapsLabel},c={value:this.showGeoAnalyticsParams?"Near":"withindistance",label:this.showGeoAnalyticsParams?this.i18n.near:this.i18n.withinDistance};i={esriGeometryPoint:{esriGeometryPoint:this.showGeoAnalyticsParams?[s,a,o,l,d,c]:[s,a,o,l,c],esriGeometryPolyline:this.showGeoAnalyticsParams?[a,l,h,c]:[a,l,c],esriGeometryPolygon:this.showGeoAnalyticsParams?[a,l,h,c]:[a,l,c]},esriGeometryPolyline:{esriGeometryPoint:this.showGeoAnalyticsParams?[a,o,h,c]:[a,o,c],esriGeometryPolyline:this.showGeoAnalyticsParams?[s,a,o,l,r,h,d,c]:[s,a,o,l,c],esriGeometryPolygon:this.showGeoAnalyticsParams?[a,l,r,h,c]:[a,l,c]},esriGeometryPolygon:{esriGeometryPoint:this.showGeoAnalyticsParams?[a,o,h,c]:[a,o,c],esriGeometryPolyline:this.showGeoAnalyticsParams?[a,o,r,h,c]:[a,o,c],esriGeometryPolygon:this.showGeoAnalyticsParams?[s,a,o,l,h,d,c]:[s,a,o,l]}},this.spatialRelationship=i[e][t][0].value,n.forEach(i[e][t],function(e,t){this._spatialRelationshipSelect.addOption({value:e.value,label:e.label})},this)},_handleTemporalCheckChange:function(e){if(g.toggle(this._temporalJoin,"selected"),this.temporalJoin=g.contains(this._temporalJoin,"selected"),P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)){var t,i;t=x.isTimeInstantLayer(this.targetLayer)?"TimeInstant":"TimeInterval",i=x.isTimeInstantLayer(this.joinLayer)?"TimeInstant":"TimeInterval",this._repopulateTemporalTypes(t,i)}e||g.add(this._temporalDistanceRow,"hide"),g.toggle(this._temporalRelationshipRow,"hide"),g.contains(this._temporalRelationshipRow,"hide")&&this._temporalDistanceInput.set("required",!1)},_handleTemporalRelationshipChange:function(e){this.temporalRelationship=e,"Near"===e?(this._temporalDistanceInput.set("required",!0),g.remove(this._temporalDistanceRow,"hide")):(g.add(this._temporalDistanceRow,"hide"),this._temporalDistanceInput.set("required",!1))},_handleTemporalDistanceChange:function(e){this.temporalDistance=e},_handleTemporalUnitChange:function(e){this.temporalUnit=e},_repopulateTemporalTypes:function(e,t){this._temporalRelationshipSelect.removeOption(this._temporalRelationshipSelect.getOptions());var i,s={value:"Equals",label:this.i18n.equalsLabel},a={value:"Intersects",label:this.i18n.intersectsLabel},o={value:"During",label:this.i18n.duringLabel},l={value:"Contains",label:this.i18n.containsLabel},r={value:"Finishes",label:this.i18n.finishesLabel},h={value:"Finished By",label:this.i18n.finishedByLabel},d={value:"Meets",label:this.i18n.meetsLabel},c={value:"Met By",label:this.i18n.metByLabel},u={value:"Near",label:this.i18n.near},p={value:"Overlaps",label:this.i18n.overlapsLabel},y={value:"Overlapped By",label:this.i18n.overlappedByLabel},_={value:"Starts",label:this.i18n.startsLabel},g={value:"Started By",label:this.i18n.startedByLabel};e&&t&&(i={TimeInstant:{TimeInstant:[s,a,u],TimeInterval:[a,o,r,_,u]},TimeInterval:{TimeInstant:[a,l,h,g,u],TimeInterval:[s,a,o,l,r,h,d,c,p,y,_,g,u]}}),this.temporalRelationship=i[e][t][0].value,n.forEach(i[e][t],function(e,t){this._temporalRelationshipSelect.addOption({value:e.value,label:e.label})},this)},_handleAttributeCheckChange:function(e){g.toggle(this._attributeJoin,"selected"),this.attributeJoin=g.contains(this._attributeJoin,"selected"),g.toggle(this._attributeRelationshipRow,"hide"),this.attributeJoin===!0?this._createAttrJoinRow():this._removeAttrJoinRows()},_createAttrJoinRow:function(){var e,i,s,l,r,h,d,c,p;return e=y.create("tr",{style:{height:"40px"}},this._attributeRelationshipRow,"before"),s=y.create("td",{style:{width:"39%"}},e),l=y.create("td",{style:{width:"8%"}},e),i=y.create("td",{style:{width:"39%"}},e),r=new C({maxHeight:200,"class":"esriLeadingMargin1 esriTrailingMargin1 mediumInput esriVeryShortlabel",style:{width:"90%",overflow:"hidden",tableLayout:"fixed"}},y.create("select",null,s)),r.addOption({value:"",label:this.i18n.selectTargetField}),n.forEach(this.targetLayer.fields,function(e,t){r.addOption({value:this._toString(t+1),label:e.name})},this),this.set("attributes",{selectWidget:r}),r.set("targetLayer",this.targetLayer),r.set("joinLayer",this.joinLayer),l.innerHTML="=",u.set(l,"text-align","center"),h=new C({"class":"mediumInput esriLeadingMargin05 esriVeryShortlabel",style:{width:"90%",overflow:"hidden",tableLayout:"fixed"}},y.create("select",null,i)),h.addOption({value:"",label:this.i18n.selectJoinField}),r.set("statisticSelect",h),o.connect(r,"onChange",this._handleAttrTargetChange),c=y.create("td",{"class":"shortTextInput removeTd",style:{display:"none",width:"10%",paddingTop:"1em"}},e),d=y.create("a",{title:this.i18n.remove,"class":"closeIcon statsRemove",innerHTML:"<img src='"+t.toUrl("./images/close.gif")+"' border='0''/>"},c),o.connect(d,"onclick",a.hitch(this,this._removeAttrJoinRow,e)),this._attrJoinRows.push(e),1===this._attrJoinRows.length&&(r.set("required","true"),h.set("required","true")),p=y.create("td",{style:{width:"10%",display:"block"}},e),h.set("attributeSelect",r),h.set("removeTd",c),h.set("stylingTd",p),h.set("isnewRowAdded",!1),h.set("referenceWidget",this),h.watch("value",this._handleAttrJoinUpdate),this._currentJoinSelect=h,this._currentTargetSelect=r,!0},_removeAttrJoinRow:function(e){n.forEach(J.findWidgets(e),function(e){e.destroyRecursive()}),y.destroy(e)},_removeAttrJoinRows:function(){n.forEach(this._attrJoinRows,this._removeAttrJoinRow,this),this._attrJoinRows=[]},_handleAttrTargetChange:function(e){var t,i,s,o,l;t=this.get("statisticSelect"),n.forEach(t.options,function(e){""!==e.value&&t.removeOption(e)},this),""!==e&&(o=this.get("targetLayer").fields[e-1].type,n.forEach(this.get("joinLayer").fields,function(e,i){e.type===o&&t.addOption({value:i+1+"",label:e.name})},this),""!==t.get("value")&&(t.get("isnewRowAdded")||(i=t.get("removeTd"),l=t.get("stylingTd"),u.set(i,"display","block"),u.set(l,"display","none"),s=t.get("referenceWidget"),a.hitch(s,s._createAttrJoinRow()),t.set("isnewRowAdded",!0))))},_handleAttrJoinUpdate:function(e,t,i){var s,n,o;this.get("attributeSelect")&&(s=this.get("attributeSelect"),""!==s.get("value")&&""!==i&&(this.get("isnewRowAdded")||(n=this.get("removeTd"),u.set(n,"display","block"),o=this.get("referenceWidget"),a.hitch(o,o._createAttrJoinRow()),this.set("isnewRowAdded",!0))))},_createStatsRow:function(){var e,i,s,n,l,r;return e=y.create("tr",{style:{height:"40px"}},this._summaryStatisticRow,"before"),i=y.create("td",{colspan:"3",style:{width:"65%"}},e),s=new C({maxHeight:200,"class":"esriLeadingMargin1 mediumInput esriTrailingMargin025 attrSelect",style:{tableLayout:"fixed",overflowX:"hidden",width:"45%"}},y.create("select",null,i)),x.addAttributeOptions({selectWidget:s,layer:this.joinLayer,allowStringType:this.showGeoAnalyticsParams}),this.set("attributes",{selectWidget:s,joinLayer:this.joinLayer}),n=new C({"class":"esriLeadingMargin1 mediumInput statsSelect",style:{tableLayout:"fixed",overflowX:"hidden",width:"45%"}},y.create("select",null,i)),x.addStatisticsOptions({selectWidget:n,showGeoAnalyticsParams:this.showGeoAnalyticsParams}),s.set("statisticSelect",n),s.set("featureLayer",this.joinLayer),o.connect(s,"onChange",this._handleAttrSelectChange),r=y.create("td",{"class":"shortTextInput removeTd",style:{visibility:"hidden",maxWidth:"12px",paddingTop:"1em"}},e),l=y.create("a",{title:this.i18n.remove,"class":"closeIcon statsRemove",innerHTML:"<img src='"+t.toUrl("./images/close.gif")+"' border='0''/>"},r),o.connect(l,"onclick",a.hitch(this,this._removeStatsRow,e)),this._statsRows.push(e),n.set("attributeSelect",s),n.set("removeTd",r),n.set("isnewRowAdded",!1),n.set("referenceWidget",this),n.watch("value",this._handleStatsValueUpdate),this._currentStatsSelect=n,this._currentAttrSelect=s,!0},_removeStatsRow:function(e){n.forEach(J.findWidgets(e),function(e){e.destroyRecursive()}),y.destroy(e)},_removeStatsRows:function(){n.forEach(this._statsRows,this._removeStatsRow,this),this._statsRows=[]},_handleAttrSelectChange:function(e){var t,i,s,n,o;"0"!==e&&(t=this.get("statisticSelect"),n=t.get("referenceWidget"),o=this.getOptions(e),o&&o.type&&x.addStatisticsOptions({selectWidget:t,type:o.type,showGeoAnalyticsParams:this.showGeoAnalyticsParams}),t.get("isnewRowAdded")||"0"===t.get("value")||""===t.get("value")||"0"===this.get("value")||""===this.get("value")||(i=t.get("removeTd"),u.set(i,"visibility","visible"),s=t.get("referenceWidget"),a.hitch(s,s._createStatsRow()),t.set("isnewRowAdded",!0)))},_handleStatsValueUpdate:function(e,t,i){var s,n,o;this.get("attributeSelect")&&(s=this.get("attributeSelect"),"0"!==s.get("value")&&"0"!==i&&""!==i&&""!==s.get("value")&&(this.get("isnewRowAdded")||(n=this.get("removeTd"),u.set(n,"visibility","visible"),o=this.get("referenceWidget"),a.hitch(o,o._createStatsRow()),this.set("isnewRowAdded",!0))))},_handleShowCreditsClick:function(e){var t={};e.preventDefault(),this._form.validate()&&(t=this._buildJobParams(),this.getCreditsEstimate(this.toolName,t).then(a.hitch(this,function(e){this._usageForm.set("content",e),this._usageDialog.show()})))},_buildJobParams:function(){var e,t={};if(t.targetLayer=this.constructAnalysisInputLyrObj(this.targetLayer,this.showGeoAnalyticsParams),this.doRefreshItem="table"!==this.targetLayer.type.toLowerCase(),t.joinLayer=this.constructAnalysisInputLyrObj(this.joinLayer,this.showGeoAnalyticsParams),this.showGeoAnalyticsParams||(t.targetLayer=l.toJson(t.targetLayer),t.joinLayer=l.toJson(t.joinLayer)),t.joinOperation=this.get("joinOperation"),this._bufFieldOutput.get("value")&&(t.joinCondition=this._bufFieldOutput.get("value")),this.spatialJoin&&(t.spatialRelationship=this._spatialRelationshipSelect.get("value"),("Near"===this._spatialRelationshipSelect.get("value")||"withindistance"===this._spatialRelationshipSelect.get("value"))&&(this.showGeoAnalyticsParams?(t.spatialNearDistance=parseFloat(this.get("spatialDistance")),t.spatialNearDistanceUnit=this._spatialUnitSelect.get("value")):(t.spatialRelationshipDistance=parseFloat(this.get("spatialDistance")),t.spatialRelationshipDistanceUnits=this._spatialUnitSelect.get("value")))),this.temporalJoin&&(t.temporalRelationship=this._temporalRelationshipSelect.get("value"),"Near"===this._temporalRelationshipSelect.get("value")&&(t.temporalNearDistance=parseFloat(this.get("temporalDistance")),t.temporalNearDistanceUnit=this._temporalUnitSelect.get("value"))),this.attributeJoin){var i="",s=[],a=0;n.forEach(this._attrJoinRows,function(e,t,o){var r=e.children,h="",d={},c=0;n.forEach(r,function(e,t){if(3>t){if(1!==t)var i=J.byNode(e.children[0]).get("value");0===t&&""!==i&&(c++,h+="target."+e.textContent,d.targetField=e.textContent),1===t&&(c++,h+=" "+e.textContent+" ",d.operator="="===e.textContent?"equal":e.textContent),2===t&&""!==i&&(c++,h+="join."+e.textContent,d.joinField=e.textContent)}},this),3===c&&(0!==a&&(i+=" and "),i+=h,s.push(l.toJson(d)),a++)},this),t.attributeRelationship=this.showGeoAnalyticsParams?i:s}return"JoinOneToOne"===this._joinOperation.get("value")&&this._statsRows.length>=2&&(t.summaryFields=[],e=this.get("summaryFields"),t.summaryFields=this.showGeoAnalyticsParams?l.toJson(e):e),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(t.context=l.toJson({extent:this.map.extent._normalize(!0)})),t.OutputName=l.toJson({serviceProperties:{name:this._outputName.get("value")}}),t},_handleSaveBtnClick:function(){var e={},t={};if(this._form.validate()){if("_NOVALUE_"===this._joinLayerSelect.get("value"))return void this._showMessages(this.i18n.joinLayerErrorMsg);if("_NOVALUE_"===this._joinOperation.get("value"))return void this._showMessages(this.i18n.joinOpErrorMsg);if(!(this.attributeJoin||this.temporalJoin||this.spatialJoin))return void this._showMessages(this.i18n.joinTypesErrorMsg);this._handleCloseMsg(),this._saveBtn.set("disabled",!0),e=this._buildJobParams(),t.jobParams=e,t.itemParams={description:this.i18n.itemDescription,tags:this.i18n.itemTags,snippet:this.i18n.itemSnippet},this.showSelectFolder&&(t.itemParams.folder=this.get("folderId")),this.showGeoAnalyticsParams&&(t.isSpatioTemporalDataStore=!0),this.resultParameter=this.showGeoAnalyticsParams?"output":"outputLayer",this.execute(t)}},_setDisableRunAnalysisAttr:function(e){this._saveBtn.set("disabled",e)},_setTargetLayerAttr:function(e){this._set("targetLayer",e||null)},_setTargetLayersAttr:function(e){this._set("targetLayers",e||[])},_setJoinLayerAttr:function(e){this._set("joinLayer",e||null)},_setShowSpatialJoinAttr:function(e){this._set("showSpatialJoin",e)},_setShowAttributeJoinAttr:function(e){this._set("showAttributeJoin",e)},_setShowTemporalJoinAttr:function(e){this._set("showTemporalJoin",e)},_setShowJoinConditionAttr:function(e){this._set("showJoinCondition",e)},_setJoinLayersAttr:function(e){this._set("joinLayers",e||[])},_handleBrowseItemsSelect:function(e){e&&e.selection&&x.addAnalysisReadyLayer({item:e.selection,layers:this._isAnalysisSelect?this.targetLayers:this.joinLayers,layersSelect:this._isAnalysisSelect?this._targetLayerSelect:this._joinLayerSelect,posIncrement:(this._isAnalysisSelect,0),browseDialog:e.dialog||this._browsedlg,widget:this}).always(a.hitch(this,function(){this._isAnalysisSelect?this._handleTargetLayerChange(this._targetLayerSelect.get("value")):this._handleJoinLayerChange(this._joinLayerSelect.get("value"))}))},_save:function(){},_onClose:function(e){e&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:e})},_loadConnections:function(){this.on("start",a.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",a.hitch(this,"_onClose",!1)),this._spatialJoinHandle=h.pausable(this._spatialJoinCtr,"click",a.hitch(this,this._handleSpatialCheckChange)),this._temporalJoinHandle=h.pausable(this._temporalJoinCtr,"click",a.hitch(this,this._handleTemporalCheckChange)),this._attributeJoinHandle=h.pausable(this._attributeJoinCtr,"click",a.hitch(this,this._handleAttributeCheckChange)),this.own(this._spatialJoinHandle,this._temporalJoinHandle,this._attributeJoinHandle)},_connect:function(e,t,i){this._pbConnects.push(o.connect(e,t,i))},_updateAnalysisLayerUI:function(e){if(this._expBtn.set("disabled",!this.targetLayer),this._bufFieldOutput.set("disabled",!this.targetLayer),this.targetLayer){var t,s,o=this._joinLayerSelect.getOptions(),l=!1,r=!1;e&&(this.outputLayerName=c.substitute(this.i18n.outputLayerName,{targetLayerName:this.targetLayer.name}),this._outputName.set("value",this.outputLayerName)),this._isAnalysisSelect&&(l=n.some(o,function(e,t){return e.label===this.targetLayer.title},this),l||(s=this.showBrowseLayers&&this.showReadyToUseLayers?3:!this.showBrowseLayers&&this.showReadyToUseLayers?2:this.showBrowseLayers&&!this.showReadyToUseLayers?2:0,t=o.splice(o.length-s,s),r=n.some(this.joinLayers,function(e){return e&&e.analysisReady&&this.targetLayer.analysisReady&&e.itemId===this.targetLayer.itemId},this),r||(0===this.joinLayers.length&&(this.joinLayer=this.targetLayer),this.joinLayers.push(this.targetLayer)),t.unshift({value:this.joinLayers.length-1,label:this.targetLayer.title}),this._joinLayerSelect.addOption(t)));var h,d,p={};if(d=n.map(this.targetLayer.fields,function(e){var t=a.clone(e);return a.mixin(t,{name:"target."+e.name,alias:"target."+e.alias}),t},this),h=n.map(this.joinLayer.fields,function(e){var t=a.clone(e);return a.mixin(t,{name:"join."+e.name,alias:"join."+e.alias}),t},this),p.fields=[].concat(h,d),this._calcField)this._calcField&&this._calcField.layer!==this.inputLayer&&(this._bufFieldOutput.set("value",""),this._calcField.reset(),this._calcField.set("layer",p));else{var y=x.getExprFunctions();y=n.filter(y,function(e){return e&&e.name&&-1===e.name.indexOf("as_")}),this._calcField=new M({layer:p,field:this.i18n.bufField,baseClass:"esriBufFieldExp",helperMethods:y,css:{base:"esriBufFieldExp",addButton:"btn calcite primary",closeButton:"btn calcite cancel"},helperType:"numeric",showHeader:!1,calculateLabel:this.i18n.add},this._expressionCtr),this._calcField.startup(),u.set(this._calcField._validateBtn.domNode,"display","none"),this._calcField._handleHelperTypeChange("value",null,{functionType:"NumType"}),this._aspectHandle=i.around(this._calcField,"_handleAddButtonClick",a.hitch(this,function(e){return a.hitch(this,function(e,t){var i=this._calcField.get("expression")[0];this._bufFieldOutput.set("value",i.sqlExpression),this._exprDialog.hide()})})),this._calcField.on("close",a.hitch(this,function(){this._exprDialog.hide()}))}}if(this.spatialJoin=!1,this.attributeJoin=!1,this.temporalJoin=!1,this._removeStatsRows(),this._removeAttrJoinRows(),g.contains(this._spatialJoin,"selected")&&(g.remove(this._spatialJoin,"selected"),g.add(this._spatialDistanceRow,"hide"),g.add(this._spatialRelationshipRow,"hide"),this._spatialRelationshipSelect.reset(),this._spatialDistanceInput.set("required",!1)),g.contains(this._temporalJoin,"selected")&&(g.remove(this._temporalJoin,"selected"),g.add(this._temporalRelationshipRow,"hide"),g.add(this._temporalDistanceRow,"hide"),this._temporalDistanceInput.set("required",!1)),g.contains(this._attributeJoin,"selected")&&(g.remove(this._attributeJoin,"selected"),g.add(this._attributeRelationshipRow,"hide")),P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")){"JoinOneToOne"===this._joinOperation.value&&this._createStatsRow();var _=!(x.isTimeEnabled(this.joinLayer)&&x.isTimeEnabled(this.targetLayer));g.remove(this._spatialJoin,"disabled"),g.remove(this._attributeJoin,"disabled"),g.toggle(this._temporalJoin,"disabled",_),g.remove(this._spatialJoinLabel,"esriAnalysisTextDisabled"),g.remove(this._attrJoinLabel,"esriAnalysisTextDisabled"),g.toggle(this._temporalJoinLabel,"esriAnalysisTextDisabled",_),this._attributeJoinHandle.resume(),this._spatialJoinHandle.resume(),_?this._temporalJoinHandle.pause():this._temporalJoinHandle.resume()}else g.add(this._spatialJoin,"disabled"),g.add(this._attributeJoin,"disabled"),g.add(this._temporalJoin,"disabled"),g.add(this._spatialJoinLabel,"esriAnalysisTextDisabled"),g.add(this._attrJoinLabel,"esriAnalysisTextDisabled"),g.add(this._temporalJoinLabel,"esriAnalysisTextDisabled"),this._attributeJoinHandle.pause(),this._spatialJoinHandle.pause(),this._temporalJoinHandle.pause();P.isDefined(this.targetLayer)&&P.isDefined(this.joinLayer)&&(this.targetLayer.type&&"table"===this.targetLayer.type.toLowerCase()||this.joinLayer.type&&"table"===this.joinLayer.type.toLowerCase())&&(g.add(this._spatialJoin,"disabled"),g.add(this._spatialJoinLabel,"esriAnalysisTextDisabled"),this._spatialJoinHandle.pause())},_setSummaryFieldsAttr:function(e){this.summaryFields=e},_getSummaryFieldsAttr:function(){var e,t,i=[];return _(".statsSelect",this.domNode).forEach(function(s,a){if(e=J.byNode(s),t=e.get("attributeSelect"),"0"!==t.get("value")&&"0"!==e.get("value")&&""!==t.get("value")&&""!==e.get("value")){var n={};n.statisticType=e.get("value"),n.onStatisticField=t.get("value"),i.push(this.showGeoAnalyticsParams?n:l.toJson(n))}},this),i},_setAnalysisGpServerAttr:function(e){e&&(this.analysisGpServer=e,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},validateServiceName:function(e){return x.validateServiceName(e,{textInput:this._outputName})},_showMessages:function(e){p.set(this._bodyNode,"innerHTML",e),b.fadeIn({node:this._errorMessagePane,easing:w.quadIn,onEnd:a.hitch(this,function(){u.set(this._errorMessagePane,{display:""})})}).play()},_handleCloseMsg:function(e){e&&e.preventDefault(),b.fadeOut({node:this._errorMessagePane,easing:w.quadOut,onEnd:a.hitch(this,function(){u.set(this._errorMessagePane,{display:"none"})})}).play()}});return r("extend-esri")&&a.setObject("dijit.analysis.JoinFeatures",q,I),q});