// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define(["esri/layers/FeatureLayer","require","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/has","dojo/on","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/store/Memory","dojo/_base/fx","dojo/fx/easing","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/layout/AccordionContainer","dijit/TitlePane","dijit/form/FilteringSelect","dijit/form/Select","dijit/form/TextBox","dijit/Dialog","../../kernel","../../lang","./utils","./AnalysisBase","./CreditEstimator","./_AnalysisOptions","dojo/i18n!../../nls/jsapi","dojo/text!./templates/JoinFeatures.html"],function(e,t,i,s,a,n,o,l,r,h,d,c,u,y,p,g,_,m,b,v,L,f,w,S,j,R,J,T,A,O,D,I,C,x,M,U,P,q,E){var F=i([v,L,f,w,S,P,M],{declaredClass:"esri.dijit.analysis.JoinFeatures",templateString:E,widgetsInTemplate:!0,showGeoAnalyticsParams:!0,i18n:null,toolName:"JoinFeatures",helpFileName:"JoinFeatures",resultParameter:"output",constructor:function(e,t){this.targetLayers=[],this.joinLayers=[],this._pbConnects=[],this._statsRows=[],this._attrJoinRows=[],e.containerNode&&(this.container=e.containerNode)},postCreate:function(){this.inherited(arguments),this._buildUI()},postMixInProperties:function(){this.inherited(arguments),this.i18n={},s.mixin(this.i18n,q.common),s.mixin(this.i18n,q.joinFeaturesTool),this.joinOperation=this.i18n.oneToOneLabel,this.joinOperationTypes=[{value:"JoinOneToOne",label:this.i18n.oneToOneLabel},{value:"JoinOneToMany",label:this.i18n.oneToManyLabel}],this.spatialDistance=0,this.spatialUnit=this.i18n.feet,this.spatialUnitTypes=[{value:"Feet",label:this.i18n.feet},{value:"Yards",label:this.i18n.yards},{value:"Miles",label:this.i18n.miles},{value:"Meters",label:this.i18n.meters},{value:"Kilometers",label:this.i18n.kilometers},{value:"NauticalMiles",label:this.i18n.nautMiles}],this.temporalDistance=0,this.temporalUnit=this.i18n.years,this.temporalUnitTypes=[{value:"Years",label:this.i18n.years},{value:"Months",label:this.i18n.months},{value:"Weeks",label:this.i18n.weeks},{value:"Days",label:this.i18n.days},{value:"Hours",label:this.i18n.hours},{value:"Minutes",label:this.i18n.minutes},{value:"Seconds",label:this.i18n.seconds},{value:"Milliseconds",label:this.i18n.milliseconds}],this.attributeRelationshipCheck=null,this.attributeRelationship=this.i18n.equalSign,this.attributeType=[{value:"Equal",label:this.i18n.equalSign}]},startup:function(){},_buildUI:function(){var e;this.signInPromise.then(s.hitch(this,x.initHelpLinks,this.domNode,this.showHelp,{analysisGpServer:this.analysisGpServer})),a.forEach(this.joinOperationTypes,function(e,t){this._joinOperation.addOption({value:e.value,label:e.label})},this),a.forEach(this.spatialUnitTypes,function(e,t){this._spatialUnitSelect.addOption({value:e.value,label:e.label})},this),a.forEach(this.temporalUnitTypes,function(e,t){this._temporalUnitSelect.addOption({value:e.value,label:e.label})},this),C.isDefined(this.targetLayer)&&(e=a.indexOf(this.targetLayers,this.targetLayer),-1!==e?this._targetLayerSelect.addOption({value:this._toString(e),label:this.targetLayer.name}):(this._targetLayerSelect.addOption({value:this._toString(this.targetLayers.length-1),label:this.targetLayer.name}),this.targetLayers.push(this.targetLayer))),C.isDefined(this.joinLayer)&&(e=a.indexOf(this.joinLayers,this.joinLayer),-1!==e?this._joinLayerSelect.addOption({value:this._toString(e),label:this.joinLayer.name}):(this._joinLayerSelect.addOption({value:this._toString(this.joinLayers.length-1),label:this.joinLayer.name}),this.joinLayers.push(this.joinLayer))),C.isDefined(this.targetLayers)&&this.targetLayers.length>0?a.forEach(this.targetLayers,function(e,t){this.targetLayer!==e&&this._targetLayerSelect.addOption({value:this._toString(t),label:e.name}),!C.isDefined(this.targetLayer)&&C.isDefined(this.targetLayers[t])&&this.set("targetLayer",this.targetLayers[t])},this):console.log("Please input an array of targetLayers, or set a specific targetLayer."),C.isDefined(this.joinLayers)&&this.joinLayers.length>0?a.forEach(this.joinLayers,function(e,t){this.joinLayer!==e&&this._joinLayerSelect.addOption({value:this._toString(t),label:e.name}),!C.isDefined(this.joinLayer)&&C.isDefined(this.joinLayers[t])&&this.set("joinLayer",this.joinLayers[t])},this):console.log("Please input an array of joinLayers, or set a specific joinLayer."),x.addReadyToUseLayerOption(this,[this._targetLayerSelect,this._joinLayerSelect]),c.set(this._chooseFolderRow,"display",this.showSelectFolder===!0?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(s.hitch(this,function(e){this.folderStore=e,x.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})),c.set(this._showCreditsLink,"display",this.showCredits===!0?"block":"none"),this._loadConnections(),this._updateAnalysisLayerUI()},_handleTargetLayerChange:function(e){var t;"browse"===e?(this._analysisquery||(this._analysisquery=this._browsedlg.browseItems.get("query")),this._browsedlg.browseItems.set("query",this._analysisquery),this._isAnalysisSelect=!0,this._browsedlg.show()):"browselayers"===e?(this.showGeoAnalyticsParams&&(t=this._browseLyrsdlg.browseItems.get("query"),t.types.push('type:"Big Data File Share"'),this._browseLyrsdlg.browseItems.set("query",t)),this._isAnalysisSelect=!0,this._browseLyrsdlg.show()):(this.set("targetLayer",this.targetLayers[e]),console.log(this.targetLayers),console.log(e),this._updateAnalysisLayerUI())},_toString:function(e){return e+""},_handleJoinLayerChange:function(e){var t;"browse"===e?(this._analysisquery||(this._analysisquery=this._browsedlg.browseItems.get("query")),this._browsedlg.browseItems.set("query",this._analysisquery),this._isAnalysisSelect=!1,this._browsedlg.show()):"browselayers"===e?(this.showGeoAnalyticsParams&&(t=this._browseLyrsdlg.browseItems.get("query"),t.types.push('type:"Big Data File Share"'),this._browseLyrsdlg.browseItems.set("query",t)),this._isAnalysisSelect=!1,this._browseLyrsdlg.show()):(this.set("joinLayer",this.joinLayers[e-1]),this._updateAnalysisLayerUI())},_handleJoinOperationChange:function(e){this._removeStatsRows(),"JoinOneToOne"===e&&C.isDefined(this.joinLayer)&&C.isDefined(this.targetLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")?(this._createStatsRow(),g.remove(this._summaryStatisticRow,"hide")):g.add(this._summaryStatisticRow,"hide"),this.joinOperation=e},_handleSpatialCheckChange:function(e){g.toggle(this._spatialJoin,"selected"),this.spatialJoin=g.contains(this._spatialJoin,"selected"),C.isDefined(this.targetLayer)&&C.isDefined(this.joinLayer)&&this._repopulateSpatialTypes(this.targetLayer.geometryType,this.joinLayer.geometryType),this.spatialJoin||g.add(this._spatialDistanceRow,"hide"),g.toggle(this._spatialRelationshipRow,"hide"),g.contains(this._spatialRelationshipRow,"hide")&&this._spatialDistanceInput.set("required",!1)},_handleSpatialRelationshipChange:function(e){this.spatialRelationship=e,"Near"===e?(this._spatialDistanceInput.set("required",!0),g.remove(this._spatialDistanceRow,"hide")):(g.add(this._spatialDistanceRow,"hide"),this._spatialDistanceInput.set("required",!1))},_handleSpatialDistanceChange:function(e){this.spatialDistance=e},_handleSpatialUnitChange:function(e){this.spatialUnit=e},_repopulateSpatialTypes:function(e,t){this._spatialRelationshipSelect.removeOption(this._spatialRelationshipSelect.getOptions());var i,s={value:"Equals",label:this.i18n.equalsLabel},n={value:"Intersects",label:this.i18n.intersectsLabel},o={value:"Contains",label:this.i18n.containsLabel},l={value:"Within",label:this.i18n.withinLabel},r={value:"Crosses",label:this.i18n.crossesLabel},h={value:"Touches",label:this.i18n.touchesLabel},d={value:"Overlaps",label:this.i18n.overlapsLabel},c={value:"Near",label:this.i18n.near};i={esriGeometryPoint:{esriGeometryPoint:[s,n,o,l,d,c],esriGeometryPolyline:[n,l,h,c],esriGeometryPolygon:[n,l,h,c]},esriGeometryPolyline:{esriGeometryPoint:[n,o,h,c],esriGeometryPolyline:[s,n,o,l,r,h,d,c],esriGeometryPolygon:[n,l,r,h,c]},esriGeometryPolygon:{esriGeometryPoint:[n,o,h,c],esriGeometryPolyline:[n,o,r,h,c],esriGeometryPolygon:[s,n,o,l,h,d,c]}},this.spatialRelationship=i[e][t][0].value,a.forEach(i[e][t],function(e,t){this._spatialRelationshipSelect.addOption({value:e.value,label:e.label})},this)},_handleTemporalCheckChange:function(e){if(g.toggle(this._temporalJoin,"selected"),this.temporalJoin=g.contains(this._temporalJoin,"selected"),C.isDefined(this.targetLayer)&&C.isDefined(this.joinLayer)){var t,i;t=x.isTimeInstantLayer(this.targetLayer)?"TimeInstant":"TimeInterval",i=x.isTimeInstantLayer(this.joinLayer)?"TimeInstant":"TimeInterval",this._repopulateTemporalTypes(t,i)}e||g.add(this._temporalDistanceRow,"hide"),g.toggle(this._temporalRelationshipRow,"hide"),g.contains(this._temporalRelationshipRow,"hide")&&this._temporalDistanceInput.set("required",!1)},_handleTemporalRelationshipChange:function(e){this.temporalRelationship=e,"Near"===e?(this._temporalDistanceInput.set("required",!0),g.remove(this._temporalDistanceRow,"hide")):(g.add(this._temporalDistanceRow,"hide"),this._temporalDistanceInput.set("required",!1))},_handleTemporalDistanceChange:function(e){this.temporalDistance=e},_handleTemporalUnitChange:function(e){this.temporalUnit=e},_repopulateTemporalTypes:function(e,t){this._temporalRelationshipSelect.removeOption(this._temporalRelationshipSelect.getOptions());var i,s={value:"Equals",label:this.i18n.equalsLabel},n={value:"Intersects",label:this.i18n.intersectsLabel},o={value:"During",label:this.i18n.duringLabel},l={value:"Contains",label:this.i18n.containsLabel},r={value:"Finishes",label:this.i18n.finishesLabel},h={value:"Finished By",label:this.i18n.finishedByLabel},d={value:"Meets",label:this.i18n.meetsLabel},c={value:"Met By",label:this.i18n.metByLabel},u={value:"Near",label:this.i18n.near},y={value:"Overlaps",label:this.i18n.overlapsLabel},p={value:"Overlapped By",label:this.i18n.overlappedByLabel},g={value:"Starts",label:this.i18n.startsLabel},_={value:"Started By",label:this.i18n.startedByLabel};e&&t&&(i={TimeInstant:{TimeInstant:[s,n,u],TimeInterval:[n,o,r,g,u]},TimeInterval:{TimeInstant:[n,l,h,_,u],TimeInterval:[s,n,o,l,r,h,d,c,y,p,g,_,u]}}),this.temporalRelationship=i[e][t][0].value,a.forEach(i[e][t],function(e,t){this._temporalRelationshipSelect.addOption({value:e.value,label:e.label})},this)},_handleAttributeCheckChange:function(e){g.toggle(this._attributeJoin,"selected"),this.attributeJoin=g.contains(this._attributeJoin,"selected"),g.toggle(this._attributeRelationshipRow,"hide"),this.attributeJoin===!0?this._createAttrJoinRow():this._removeAttrJoinRows()},_createAttrJoinRow:function(){var e,i,o,l,r,h,d,u,p;return e=y.create("tr",{style:{height:"40px"}},this._attributeRelationshipRow,"before"),o=y.create("td",{style:{width:"39%"}},e),l=y.create("td",{style:{width:"8%"}},e),i=y.create("td",{style:{width:"39%"}},e),r=new A({maxHeight:200,"class":"esriLeadingMargin1 esriTrailingMargin1 mediumInput esriVeryShortlabel",style:{width:"90%",overflow:"hidden",tableLayout:"fixed"}},y.create("select",null,o)),r.addOption({value:"",label:this.i18n.selectTargetField}),a.forEach(this.targetLayer.fields,function(e,t){r.addOption({value:this._toString(t+1),label:e.name})},this),this.set("attributes",{selectWidget:r}),r.set("targetLayer",this.targetLayer),r.set("joinLayer",this.joinLayer),l.innerHTML="=",c.set(l,"text-align","center"),h=new A({"class":"mediumInput esriLeadingMargin05 esriVeryShortlabel",style:{width:"90%",overflow:"hidden",tableLayout:"fixed"}},y.create("select",null,i)),h.addOption({value:"",label:this.i18n.selectJoinField}),r.set("statisticSelect",h),n.connect(r,"onChange",this._handleAttrTargetChange),u=y.create("td",{"class":"shortTextInput removeTd",style:{display:"none",width:"10%",paddingTop:"1em"}},e),d=y.create("a",{title:this.i18n.remove,"class":"closeIcon statsRemove",innerHTML:"<img src='"+t.toUrl("./images/close.gif")+"' border='0''/>"},u),n.connect(d,"onclick",s.hitch(this,this._removeAttrJoinRow,e)),this._attrJoinRows.push(e),1===this._attrJoinRows.length&&(r.set("required","true"),h.set("required","true")),p=y.create("td",{style:{width:"10%",display:"block"}},e),h.set("attributeSelect",r),h.set("removeTd",u),h.set("stylingTd",p),h.set("isnewRowAdded",!1),h.set("referenceWidget",this),h.watch("value",this._handleAttrJoinUpdate),this._currentJoinSelect=h,this._currentTargetSelect=r,!0},_removeAttrJoinRow:function(e){a.forEach(j.findWidgets(e),function(e){e.destroyRecursive()}),y.destroy(e)},_removeAttrJoinRows:function(){a.forEach(this._attrJoinRows,this._removeAttrJoinRow,this),this._attrJoinRows=[]},_handleAttrTargetChange:function(e){var t,i,n,o,l;t=this.get("statisticSelect"),a.forEach(t.options,function(e){""!==e.value&&t.removeOption(e)},this),""!==e&&(o=this.get("targetLayer").fields[e-1].type,a.forEach(this.get("joinLayer").fields,function(e,i){e.type===o&&t.addOption({value:i+1+"",label:e.name})},this),""!==t.get("value")&&(t.get("isnewRowAdded")||(i=t.get("removeTd"),l=t.get("stylingTd"),c.set(i,"display","block"),c.set(l,"display","none"),n=t.get("referenceWidget"),s.hitch(n,n._createAttrJoinRow()),t.set("isnewRowAdded",!0))))},_handleAttrJoinUpdate:function(e,t,i){var a,n,o;this.get("attributeSelect")&&(a=this.get("attributeSelect"),""!==a.get("value")&&""!==i&&(this.get("isnewRowAdded")||(n=this.get("removeTd"),c.set(n,"display","block"),o=this.get("referenceWidget"),s.hitch(o,o._createAttrJoinRow()),this.set("isnewRowAdded",!0))))},_createStatsRow:function(){var e,i,a,o,l,r;return e=y.create("tr",{style:{height:"40px"}},this._summaryStatisticRow,"before"),i=y.create("td",{style:{width:"65%"}},e),a=new A({maxHeight:200,"class":"esriLeadingMargin1 mediumInput esriTrailingMargin025 attrSelect",style:{tableLayout:"fixed",overflowX:"hidden",width:"45%"}},y.create("select",null,i)),x.addAttributeOptions({selectWidget:a,layer:this.joinLayer,allowStringType:!0}),this.set("attributes",{selectWidget:a,joinLayer:this.joinLayer}),o=new A({"class":"esriLeadingMargin1 mediumInput statsSelect",style:{tableLayout:"fixed",overflowX:"hidden",width:"45%"}},y.create("select",null,i)),x.addStatisticsOptions({selectWidget:o,showGeoAnalyticsParams:this.showGeoAnalyticsParams}),a.set("statisticSelect",o),a.set("featureLayer",this.joinLayer),n.connect(a,"onChange",this._handleAttrSelectChange),r=y.create("td",{"class":"shortTextInput removeTd",style:{visibility:"hidden",maxWidth:"12px",paddingTop:"1em"}},e),l=y.create("a",{title:this.i18n.remove,"class":"closeIcon statsRemove",innerHTML:"<img src='"+t.toUrl("./images/close.gif")+"' border='0''/>"},r),n.connect(l,"onclick",s.hitch(this,this._removeStatsRow,e)),this._statsRows.push(e),o.set("attributeSelect",a),o.set("removeTd",r),o.set("isnewRowAdded",!1),o.set("referenceWidget",this),o.addOption([{value:"0",label:this.i18n.statistic}]),o.watch("value",this._handleStatsValueUpdate),this._currentStatsSelect=o,this._currentAttrSelect=a,!0},_removeStatsRow:function(e){a.forEach(j.findWidgets(e),function(e){e.destroyRecursive()}),y.destroy(e)},_removeStatsRows:function(){a.forEach(this._statsRows,this._removeStatsRow,this),this._statsRows=[]},_handleAttrSelectChange:function(e){var t,i,a,n,o;"0"!==e&&(t=this.get("statisticSelect"),n=t.get("referenceWidget"),o=this.getOptions(e),o&&o.type&&x.addStatisticsOptions({selectWidget:t,type:o.type,showGeoAnalyticsParams:!0}),t.get("isnewRowAdded")||"0"===t.get("value")||""===t.get("value")||"0"===this.get("value")||""===this.get("value")||(i=t.get("removeTd"),c.set(i,"visibility","visible"),a=t.get("referenceWidget"),s.hitch(a,a._createStatsRow()),t.set("isnewRowAdded",!0)))},_handleStatsValueUpdate:function(e,t,i){var a,n,o;this.get("attributeSelect")&&(a=this.get("attributeSelect"),"0"!==a.get("value")&&"0"!==i&&""!==i&&""!==a.get("value")&&(this.get("isnewRowAdded")||(n=this.get("removeTd"),c.set(n,"visibility","visible"),o=this.get("referenceWidget"),s.hitch(o,o._createStatsRow()),this.set("isnewRowAdded",!0))))},_handleShowCreditsClick:function(e){var t={};e.preventDefault(),this._form.validate()&&(t=this._buildJobParams(),t.InputLayers=o.toJson(t.InputLayers),this.getCreditsEstimate(this.toolName,t).then(s.hitch(this,function(e){this._usageForm.set("content",e),this._usageDialog.show()})))},_buildJobParams:function(){var e={};if(e.targetLayer=x.constructAnalysisInputLyrObj(this.targetLayer,!0),e.joinLayer=x.constructAnalysisInputLyrObj(this.joinLayer,!0),e.joinOperation=this.get("joinOperation"),this.spatialJoin&&(e.spatialRelationship=this._spatialRelationshipSelect.get("value"),"Near"===this._spatialRelationshipSelect.get("value")&&(e.spatialNearDistance=parseFloat(this.get("spatialDistance")),e.spatialNearDistanceUnit=this._spatialUnitSelect.get("value"))),this.temporalJoin&&(e.temporalRelationship=this._temporalRelationshipSelect.get("value"),"Near"===this._temporalRelationshipSelect.get("value")&&(e.temporalNearDistance=parseFloat(this.get("temporalDistance")),e.temporalNearDistanceUnit=this._temporalUnitSelect.get("value"))),this.attributeJoin){var t="",i=0;a.forEach(this._attrJoinRows,function(e,s,n){var o=e.children,l="",r=0;a.forEach(o,function(e,t){if(3>t){if(1!==t)var i=j.byNode(e.children[0]).get("value");0===t&&""!==i&&(r++,l+="target."+e.textContent),1===t&&(r++,l+=" "+e.textContent+" "),2===t&&""!==i&&(r++,l+="join."+e.textContent)}},this),3===r&&(0!==i&&(t+=" and "),t+=l,i++)},this),e.attributeRelationship=t}return"JoinOneToOne"===this._joinOperation.get("value")&&this._statsRows.length>=2&&(e.summaryFields=[],e.summaryFields=o.toJson(this.get("summaryFields"))),e.OutputName=o.toJson({serviceProperties:{name:this._outputName.get("value")}}),e},_handleSaveBtnClick:function(){var e={},t={};if(this._form.validate()){if("_NOVALUE_"===this._joinLayerSelect.get("value"))return void this._showMessages(this.i18n.joinLayerErrorMsg);if("_NOVALUE_"===this._joinOperation.get("value"))return void this._showMessages(this.i18n.joinOpErrorMsg);if(!(this.attributeJoin||this.temporalJoin||this.spatialJoin))return void this._showMessages(this.i18n.joinTypesErrorMsg);this._handleCloseMsg(),this._saveBtn.set("disabled",!0),e=this._buildJobParams(),t.jobParams=e,t.itemParams={description:this.i18n.itemDescription,tags:this.i18n.itemTags,snippet:this.i18n.itemSnippet},this.showSelectFolder&&(t.itemParams.folder=this.get("folderId")),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(e.Context=o.toJson({extent:this.map.extent._normalize(!0)})),this.showGeoAnalyticsParams&&this._datastoreSelect&&(t.isSpatioTemporalDataStore="spatialtemporal"===this._datastoreSelect.get("value")),console.log(t),this.execute(t)}},_setTargetLayerAttr:function(e){this._set("targetLayer",e||null)},_setTargetLayersAttr:function(e){this._set("targetLayers",e||[])},_setJoinLayerAttr:function(e){this._set("joinLayer",e||null)},_setJoinLayersAttr:function(e){this._set("joinLayers",e||[])},_handleBrowseItemsSelect:function(e){e&&e.selection&&x.addAnalysisReadyLayer({item:e.selection,layers:this._isAnalysisSelect?this.targetLayers:this.joinLayers,layersSelect:this._isAnalysisSelect?this._targetLayerSelect:this._joinLayerSelect,posIncrement:this._isAnalysisSelect?0:1,browseDialog:e.dialog||this._browsedlg,widget:this}).always(this._isAnalysisSelect?this._handleTargetLayerChange(this._targetLayerSelect.get("value")):this._handleJoinLayerChange(this._joinLayerSelect.get("value")))},_save:function(){},_onClose:function(e){e&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:e})},_loadConnections:function(){this.on("start",s.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",s.hitch(this,"_onClose",!1)),this.showGeoAnalyticsParams&&(this._spatialJoinHandle=r.pausable(this._spatialJoin,"click",s.hitch(this,this._handleSpatialCheckChange)),this._temporalJoinHandle=r.pausable(this._temporalJoin,"click",s.hitch(this,this._handleTemporalCheckChange)),this._attributeJoinHandle=r.pausable(this._attributeJoin,"click",s.hitch(this,this._handleAttributeCheckChange)),this.own(this._spatialJoinHandle,this._temporalJoinHandle,this._attributeJoinHandle))},_connect:function(e,t,i){this._pbConnects.push(n.connect(e,t,i))},_updateAnalysisLayerUI:function(e){if(this.targetLayer){var t,i,s=this._joinLayerSelect.getOptions(),n=!1,o=!1;this._isAnalysisSelect&&(n=a.some(s,function(e,t){return e.label===this.targetLayer.title},this),n||(i=this.showBrowseLayers&&this.showReadyToUseLayers?3:!this.showBrowseLayers&&this.showReadyToUseLayers?2:this.showBrowseLayers&&!this.showReadyToUseLayers?2:0,t=s.splice(s.length-i,i),o=a.some(this.joinLayers,function(e){return e&&e.analysisReady&&this.targetLayer.analysisReady&&e.itemId===this.targetLayer.itemId},this),o||(0===this.joinLayers.length&&(this.joinLayer=this.targetLayer),this.joinLayers.push(this.targetLayer)),t.unshift({value:this.joinLayers.length,label:this.targetLayer.title}),this._joinLayerSelect.addOption(t)))}if(this.spatialJoin=!1,this.attributeJoin=!1,this.temporalJoin=!1,this._removeStatsRows(),this._removeAttrJoinRows(),g.contains(this._spatialJoin,"selected")&&(g.remove(this._spatialJoin,"selected"),g.add(this._spatialDistanceRow,"hide"),g.add(this._spatialRelationshipRow,"hide"),this._spatialRelationshipSelect.reset(),this._spatialDistanceInput.set("required",!1)),g.contains(this._temporalJoin,"selected")&&(g.remove(this._temporalJoin,"selected"),g.add(this._temporalRelationshipRow,"hide"),g.add(this._temporalDistanceRow,"hide"),this._temporalDistanceInput.set("required",!1)),g.contains(this._attributeJoin,"selected")&&(g.remove(this._attributeJoin,"selected"),g.add(this._attributeRelationshipRow,"hide")),C.isDefined(this.targetLayer)&&C.isDefined(this.joinLayer)&&"_NOVALUE_"!==this._joinLayerSelect.get("value")){"JoinOneToOne"===this._joinOperation.value&&this._createStatsRow();var l=!(x.isTimeEnabled(this.joinLayer)&&x.isTimeEnabled(this.targetLayer));g.remove(this._spatialJoin,"disabled"),g.remove(this._attributeJoin,"disabled"),g.toggle(this._temporalJoin,"disabled",l),g.remove(this._spatialJoinLabel,"esriAnalysisTextDisabled"),g.remove(this._attrJoinLabel,"esriAnalysisTextDisabled"),g.toggle(this._temporalJoinLabel,"esriAnalysisTextDisabled",l),this._attributeJoinHandle.resume(),this._spatialJoinHandle.resume(),l?this._temporalJoinHandle.pause():this._temporalJoinHandle.resume()}else g.add(this._spatialJoin,"disabled"),g.add(this._attributeJoin,"disabled"),g.add(this._temporalJoin,"disabled"),g.add(this._spatialJoinLabel,"esriAnalysisTextDisabled"),g.add(this._attrJoinLabel,"esriAnalysisTextDisabled"),g.add(this._temporalJoinLabel,"esriAnalysisTextDisabled"),this._attributeJoinHandle.pause(),this._spatialJoinHandle.pause(),this._temporalJoinHandle.pause()},_setSummaryFieldsAttr:function(e){this.summaryFields=e},_getSummaryFieldsAttr:function(){var e,t,i=[];return p(".statsSelect",this.domNode).forEach(function(s,a){if(e=j.byNode(s),t=e.get("attributeSelect"),"0"!==t.get("value")&&"0"!==e.get("value")&&""!==t.get("value")&&""!==e.get("value")){var n={};n.statisticType=e.get("value"),n.onStatisticField=t.get("value"),i.push(n)}}),i},_setAnalysisGpServerAttr:function(e){e&&(this.analysisGpServer=e,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},_showMessages:function(e){u.set(this._bodyNode,"innerHTML",e),m.fadeIn({node:this._errorMessagePane,easing:b.quadIn,onEnd:s.hitch(this,function(){c.set(this._errorMessagePane,{display:""})})}).play()},_handleCloseMsg:function(e){e&&e.preventDefault(),m.fadeOut({node:this._errorMessagePane,easing:b.quadOut,onEnd:s.hitch(this,function(){c.set(this._errorMessagePane,{display:"none"})})}).play()}});return l("extend-esri")&&s.setObject("dijit.analysis.JoinFeatures",F,I),F});