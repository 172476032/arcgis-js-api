// COPYRIGHT Â© 2015 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.15/esri/copyright.txt for details.
define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/event","dojo/_base/json","dojo/dom-attr","dojo/has","dojo/i18n","dojo/io-query","dojo/i18n!../../nls/jsapi","dojo/json","dojo/string","dojo/query","dojo/date/locale","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/Deferred","dojo/number","dojo/_base/window","dojo/when","dojo/data/ItemFileWriteStore","dijit/registry","dijit/Dialog","dijit/form/CheckBox","../../kernel","../../lang","../../request","./HelpWindow","../../tasks/query","../../dijit/BrowseItems","../../layers/FeatureLayer","./PluginAnalysisLayers","../../tasks/Geoprocessor","../../dijit/SingleFilter"],function(e,t,i,s,a,n,r,o,l,d,m,c,u,y,p,g,h,f,b,v,T,I,w,D,L,S,x,F,M,E,_,P,j,O,N){var C={};return t.mixin(C,{_helpDialog:null,i18n:null,initHelpLinks:function(e,i,n){if(this._helpDialog||(this._helpDialog=new E),e){var o=D.byNode(e),l=o?o.get("helpFileName"):n&&n.helpFileName?n.helpFileName:null;y("[esriHelpTopic]",e).forEach(function(d){d&&(g.set(d,"display",F.isDefined(i)&&i!==!0?"none":""),s.connect(d,"onclick",t.hitch(this,function(t){a.stop(t),this._helpDialog.show(t,{helpId:r.get(d,"esriHelpTopic"),helpFileName:l,analysisGpServer:n&&n.analysisGpServer?n.analysisGpServer:null,helpParentNode:e,isPortal:o.get("isSingleTenant")})})))},this)}},constructAnalysisFeatColl:function(e){var i,s={};s.featureCollection=e.layerDefinition;for(i in s.featureCollection)s.featureCollection.hasOwnProperty(i)&&"objectIdField"===i&&(s.featureCollection.objectIdFieldName=t.clone(s.featureCollection.objectIdField),delete s.featureCollection.objectIdField);return s.featureCollection.features=e.featureSet.features,s},constructAnalysisInputLyrObj:function(e){var i,s,a,n,r={},o=e.getMap()||e._map;if(e.url&&!e._collection){if(r={url:e.url},a=this.isHostedService(e.url),n=e.version>=10.2&&e._useStandardizedQueries,e.getDefinitionExpression&&e.getDefinitionExpression()?r.filter=e.getDefinitionExpression():F.isDefined(e.definitionExpression)&&""!==e.definitionExpression&&(r.filter=e.definitionExpression),e.useMapTime&&e.timeInfo&&o.timeExtent&&(n||a||e.version>=10.2)){var l="";e.timeInfo.startTimeField&&!e.timeInfo.endTimeField?(o.timeExtent.startTime&&(l=e.timeInfo.startTimeField+" > "+(a?"":"timestamp ")+"'"+this.formatDate(o.timeExtent.startTime)+"'"),o.timeExtent.endTime&&(o.timeExtent.startTime&&(l+=" AND "),l+=e.timeInfo.startTimeField+" < "+(a?"":"timestamp ")+"'"+this.formatDate(o.timeExtent.endTime)+"'")):!e.timeInfo.startTimeField&&e.timeInfo.endTimeField?(o.timeExtent.startTime&&(l=e.timeInfo.endTimeField+" > "+(a?"":"timestamp ")+"'"+this.formatDate(o.timeExtent.startTime)+"'"),o.timeExtent.endTime&&(o.timeExtent.startTime&&(l+=" AND "),l+=e.timeInfo.endTimeField+" < "+(a?"":"timestamp ")+"'"+this.formatDate(o.timeExtent.endTime)+"'")):e.timeInfo.startTimeField&&e.timeInfo.endTimeField&&(o.timeExtent.startTime&&(l=e.timeInfo.startTimeField+" > "+(a?"":"timestamp ")+"'"+this.formatDate(o.timeExtent.startTime)+"'"),o.timeExtent.endTime&&(o.timeExtent.startTime&&(l+=" AND "),l+=e.timeInfo.endTimeField+" < "+(a?"":"timestamp ")+"'"+this.formatDate(o.timeExtent.endTime)+"'")),r.filter?r.filter+=" AND "+l:r.filter=l}e.credential&&(r.serviceToken=e.credential.token),-1!==r.url.indexOf("?")&&(i=r.url.substring(r.url.indexOf("?")+1,r.url.length),s=d.queryToObject(i),t.mixin(r,s),r.url=r.url.substring(0,r.url.indexOf("?")))}else if(!e.url||e._collection)try{r=e.toJson()}catch(m){e._json=c.parse(e._json),r=e.toJson()}return r},formatDate:function(e){return p.format(e,{datePattern:"yyyy-MM-dd",selector:"date"})+" "+p.format(e,{selector:"time",timePattern:"HH:mm:ss"})},isHostedService:function(e){if(!e)return!1;var t=".arcgis.com/",i="//services",s="//tiles",a="//features",n=-1!==e.indexOf(t),r=-1!==e.indexOf(i)||-1!==e.indexOf(s)||-1!==e.indexOf(a);return n&&r},buildReport:function(e,s){var a="";return s||(s={},t.mixin(s,m.analysisMsgCodes)),i.forEach(e,function(e){var n,r,o;"string"==typeof e.message?(n=F.isDefined(s[e.messageCode])?s[e.messageCode]:e.message,a+=e.style.substring(0,e.style.indexOf("</"))+(this._isEmptyObject(e.params)?n:u.substitute(n,e.params))+e.style.substring(e.style.indexOf("</"))):t.isArray(e.message)&&(o=[],r=t.clone(e.style),i.forEach(e.message,function(t,i){r=r.replace(/<\//,"${"+i+"}"),n=F.isDefined(s[e.messageCode+"_"+i])?s[e.messageCode+"_"+i]:t,n=this._isEmptyObject(e.params)?n:u.substitute(n,e.params),o.push(n+"</")},this),r=u.substitute(r,o),a+=r)},this),a},getLayerFeatureCount:function(e,t){var i=new _;return i.geometry=t.geometry||"",i.where=t.where||"1=1",i.geometryType=t.geometryType||"esriGeometryEnvelope",e.queryCount(i)},createPolygonFeatureCollection:function(e){var t;return t={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPolygon"}},t.layerDefinition={currentVersion:10.2,copyrightText:"",defaultVisibility:!0,relationships:[],isDataVersioned:!1,supportsRollbackOnFailureParameter:!0,supportsStatistics:!0,supportsAdvancedQueries:!0,geometryType:"esriGeometryPolygon",minScale:0,maxScale:0,objectIdField:"OBJECTID",templates:[],type:"Feature Layer",displayField:"TITLE",visibilityField:"VISIBLE",name:e,hasAttachments:!1,typeIdField:"TYPEID",capabilities:"Query",allowGeometryUpdates:!0,htmlPopupType:"",hasM:!1,hasZ:!1,globalIdField:"",supportedQueryFormats:"JSON",hasStaticData:!1,maxRecordCount:-1,indexes:[],types:[],drawingInfo:{renderer:{type:"simple",symbol:{color:[0,0,0,255],outline:{color:[0,0,0,255],width:3,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSNull"},label:"",description:""},transparency:0,labelingInfo:null,fixedSymbols:!0},fields:[{alias:"OBJECTID",name:"OBJECTID",type:"esriFieldTypeOID",editable:!1},{alias:"Title",name:"TITLE",length:50,type:"esriFieldTypeString",editable:!0},{alias:"Visible",name:"VISIBLE",type:"esriFieldTypeInteger",editable:!0},{alias:"Description",name:"DESCRIPTION",length:1073741822,type:"esriFieldTypeString",editable:!0},{alias:"Type ID",name:"TYPEID",type:"esriFieldTypeInteger",editable:!0}]},t},createPointFeatureCollection:function(e){var t;return t={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPoint"}},t.layerDefinition={objectIdField:"OBJECTID",templates:[],type:"Feature Layer",drawingInfo:{renderer:{field1:"TYPEID",type:"simple",symbol:{height:24,xoffset:0,yoffset:12,width:24,contentType:"image/png",type:"esriPMS",url:"http://static.arcgis.com/images/Symbols/Basic/GreenStickpin.png"},description:"",value:"0",label:"Stickpin"}},displayField:"TITLE",visibilityField:"VISIBLE",name:e,hasAttachments:!1,typeIdField:"TYPEID",capabilities:"Query",types:[],geometryType:"esriGeometryPoint",fields:[{alias:"OBJECTID",name:"OBJECTID",type:"esriFieldTypeOID",editable:!1},{alias:"Title",name:"TITLE",length:50,type:"esriFieldTypeString",editable:!0},{alias:"Visible",name:"VISIBLE",type:"esriFieldTypeInteger",editable:!0},{alias:"Description",name:"DESCRIPTION",length:1073741822,type:"esriFieldTypeString",editable:!0},{alias:"Type ID",name:"TYPEID",type:"esriFieldTypeInteger",editable:!0}]},t},createFolderStore:function(e,t){var s=new w({data:{identifier:"id",label:"name",items:[]}});return s.newItem({name:t,id:""}),i.forEach(e,function(e){s.newItem({name:e.title,id:e.id})}),s},setupFoldersUI:function(e){e.folderSelect.set("store",e.folderStore),e.folderSelect.set("required",!0),e.folderSelect.set("searchAttr","name"),F.isDefined(e.folderId)?e.folderStore.get(e.folderId).then(t.hitch(this,function(t){F.isDefined(t)?e.folderSelect.set("item",t):e.folderStore.get("").then(function(t){e.folderSelect.set("item",t)},this)})):e.folderName?e.folderStore.fetch({query:{name:e.folderName},onComplete:t.hitch(this,function(t){F.isDefined(t)&&t.length>0?e.folderSelect.set("item",t[0]):e.folderStore.get("").then(function(t){e.folderSelect.set("item",t)},this)})}):e.username?e.folderSelect.set("displayedValue",e.username):e.folderStore.get("").then(function(t){e.folderSelect.set("item",t)},this)},_isEmptyObject:function(e){var t;for(t in e)if(e.hasOwnProperty(t))return!1;return!0},validateServiceName:function(e,t){var i,s,a=/(:|&|<|>|%|#|\?|\\|\"|\/|\+)/.test(e),n=!0;return F.isDefined(t)&&t.textInput&&(s=t.textInput),this.initI18n(),0===e.length||0===u.trim(e).length?(i=this.i18n.requiredValue,n=!1):a?(i=this.i18n.invalidServiceName,n=!1):e.length>98?(i=this.i18n.invalidServiceNameLength,n=!1):encodeURIComponent(e).length>170&&(i=this.i18n.invalidEncodedServiceNameLength,n=!1),s&&!n&&s.set("invalidMessage",i),n},getStepNumber:function(e){y(".esriAnalysisNumberLabel",e).forEach(function(e,t){var i=this._getNumberLabel(t);r.set(e,"innerHTML",i)},this)},_getNumberLabel:function(e){var t="";switch(this.initI18n(),e){case 0:t=this.i18n.oneLabel;break;case 1:t=this.i18n.twoLabel;break;case 2:t=this.i18n.threeLabel;break;case 3:t=this.i18n.fourLabel;break;case 4:t=this.i18n.fiveLabel;break;case 5:t=this.i18n.sixLabel;break;case 6:t=this.i18n.sevenLabel;break;case 7:t=this.i18n.eightLabel;break;case 8:t=this.i18n.nineLabel}return t},populateAnalysisLayers:function(e,t,s,a){if(e){var n=[],r=e.get(t);e._titleRow&&g.set(e._titleRow,"display","none"),e._analysisLabelRow&&g.set(e._analysisLabelRow,"display","table-row"),e._selectAnalysisRow&&(g.set(e._selectAnalysisRow,"display","table-row"),h.add(e._analysisSelect.domNode,"esriTrailingMargin3"),g.set(e._analysisSelect.domNode.parentNode,"padding-bottom","1em")),e.domNode&&this.getStepNumber(e.domNode),F.isDefined(a)&&a.chooseLabel&&n.push({value:-1,label:this.i18n.chooseLabel}),F.isDefined(a)&&F.isDefined(a.posIncrement)||(F.isDefined(a)||(a={}),a.posIncrement=0),i.forEach(e.get(s),function(e,t){t+=a.posIncrement;var i={value:F.isDefined(a)&&a.chooseLabel?t+1:t,label:e.name};r&&e.name===r.name&&(i.selected=!0),n.push(i)},this),e._analysisSelect.addOption(n),e._analysisSelect.set("required",!0)}},isValidAnalysisLayer:function(e){var t,s,a,n,r,o,l,d,m,c,y,p="",g=!0,h={isValid:g,validationMessage:p},f=0,b=0,v=0;return F.isDefined(e)&&F.isDefined(e.toolName)?(this.initI18n(),t=e.toolName,s=e.featureLayers,a=e.analysisLayer,n=t.charAt(0).toLowerCase()+t.substring(1),l=this.i18n,y=e.showReadyToUseLayers||!1,i.forEach(s,function(e){"esriGeometryPoint"===e.geometryType&&(o=!0,f++),("esriGeometryPoint"===e.geometryType||"esriGeometryMultipoint"===e.geometryType)&&(d=!0),"esriGeometryPolyline"===e.geometryType&&(m=!0,v++),"esriGeometryPolygon"===e.geometryType&&(r=!0,b++)},this),-1!==i.indexOf(["CreateDriveTimeAreas","PlanRoutes","ConnectOriginsToDestinations"],t)&&(!o||a&&"esriGeometryPoint"!==a.geometryType)?(p=u.substitute(this.i18n.selectPointLayer,{toolName:l[n]}),g=!1):"AggregatePoints"!==t&&"InterpolatePoints"!==t||(!a||"esriGeometryPoint"===a.geometryType||"esriGeometryMultipoint"===a.geometryType)&&d?"CalculateDensity"===t&&(!d&&!m||a&&"esriGeometryPoint"!==a.geometryType&&"esriGeometryMultipoint"!==a.geometryType&&"esriGeometryPolyline"!==a.geometryType)?(p=u.substitute(this.i18n.areaFeatureInvalidMsg,{toolName:l[n]}),g=!1):"FindHotSpots"===t&&(!d&&!r||a&&"esriGeometryPoint"!==a.geometryType&&"esriGeometryMultipoint"!==a.geometryType&&"esriGeometryPolygon"!==a.geometryType)?(p=u.substitute(this.i18n.hotspotsLineFeatureMsg,{toolName:l[n]}),g=!1):"OverlayLayers"!==t&&"AggregatePoints"!==t&&"SummarizeWithin"!==t&&"SummarizeNearby"!==t&&"FindNearest"!==t&&"MergeLayers"!==t||y||0!==s.length&&(1!==s.length||s[0]!==a&&F.isDefined(a))?"ConnectOriginsToDestinations"===t&&!y&&(0===s.length||2>f)?(p=u.substitute(this.i18n.odPointMsg,{toolName:l[n]}),g=!1):"AggregatePoints"===t&&!y&&s.length>1?(r=i.some(s,function(e){return"esriGeometryPolygon"===e.geometryType}),r||(p=u.substitute(this.i18n.aggregatePolyMsg,{toolName:l[n]}),g=!1)):"MergeLayers"===t&&!y&&s.length>1?(c=f>1||v>1||b>1,c||(p=this.i18n.mergeValidationMsg,g=!1)):"SummarizeWithin"!==t&&"DissolveBoundaries"!==t||(!a||"esriGeometryPolygon"===a.geometryType)&&r?"ExtractData"===t?(g=i.some(s,function(e){return-1!==e.capabilities.indexOf("Extract")}),g||(p=u.substitute(this.i18n.extractValidationMsg))):"ConnectOriginsToDestinations"===t&&s.length>1&&(o=i.some(s,function(e){var t=F.isDefined(a)&&a.id===e.id;return"esriGeometryPoint"===e.geometryType&&!t}),o||(p=u.substitute(this.i18n.odPointMsg,{toolName:l[n]}),g=!1)):(p=u.substitute(this.i18n.selectPolyLayer,{toolName:l[n]}),g=!1):(p=u.substitute(this.i18n.overlayValidationMsg,{toolName:l[n]}),g=!1):(p=u.substitute(this.i18n.selectPointLayer,{toolName:l[n]}),g=!1),h={isValid:g,validationMessage:p}):h},initI18n:function(){this.i18n||(this.i18n={},t.mixin(this.i18n,m.common),t.mixin(this.i18n,m.analysisTools),t.mixin(this.i18n,m.analysisMsgCodes),t.mixin(this.i18n,m.browseLayersDlg),t.mixin(this.i18n,m.driveTimes))},addBrowseAnalysisDialog:function(e){var i=[];if(e&&e.widget){this.i18n||this.initI18n(),i.push({label:this.i18n.categoryAll,value:"analysis ready"}),i.push({label:this.i18n.categoryBoundaries,value:"boundaries OR places"}),i.push({label:"&nbsp;&nbsp;&nbsp;&nbsp;"+this.i18n.subCategoryBoundaries,value:"boundaries"}),i.push({label:"&nbsp;&nbsp;&nbsp;&nbsp;"+this.i18n.subCategoryPlaces,value:"places"}),i.push({label:this.i18n.categoryHexBins,value:"hex"}),i.push({label:this.i18n.categoryTransportation,value:"transportation"});var s,a,n,r,o=T.doc.createDocumentFragment(),l=f.create("div",{style:"width:100%;height:100%;"},o),d=f.create("div",{style:"width:100%;height:10%;","class":""},l),m=f.create("div",{style:"width:100%"},l),c=new P({portalUrl:e.widget.get("portalUrl"),message:"",plugin:"esri/dijit/analysis/PluginAnalysisLayers",sortDescending:!0,sort:"title",self:e.widget.get("portalSelf"),categories:i,categoryType:"tags",selectedCategory:"boundaries OR places",pagingLinks:3,itemsPerPage:6,"class":"esriBrowseAnalysisLayers itemsGallery esriFloatLeading",closePopupPerRow:!1,extent:e.widget.get("map").extent,useExtent:!0,fetchTimeout:600,galleryTemplate:"<div style='opacity:1;' class='grid-item gallery-view galleryNode'>${item:_formatItemTitle}${item:_formatThumbnail}"+'<div class="linksDiv" style=\'display:none;\'><div class="esriItemLinks"><div class="esriFloatLeading"><a style="text-decoration: none;"><span>Add layer to analysis</span><div class="dijitReset dijitInline esriArrows"></div></a></div></div></div>',formatThumbnail:function(e){var t=e.thumbnailUrl||this._portal.staticImagesUrl+"/desktopapp.png";return"<img class='grid-item galleryThumbnail' width='120px' height='80px' alt='' src='"+t+"'>"},formatItemTitle:function(e){return'<div class="galleryLabelContainer"><span alt=\''+(e.title||e.name||"<No Title>")+"'>"+(e.title.replace(/_/g," ")||e.name.replace(/_/g," ")||"<No Title>")+"</span></div>"},style:"width:600px;height:90%;clear:both;"},m);r=f.toDom('<table cellpadding="0" cellspacing="0" class="esriFloatTrailing">'),f.place(r,d);var u=f.create("tr",null,r),y=f.create("td",null,u),p=(f.create("td",{innerHTML:"&nbsp;"},u),f.create("td",null,u)),g=f.create("tr",null,r),h=f.create("td",{style:"padding-bottom: 0.5em"},g),b=(f.create("td",{style:"padding-bottom: 0.5em",innerHTML:"&nbsp;"},g),f.create("td",{style:"padding-bottom: 0.5em"},g));return f.create("label",{"for":e.widget.id+"_addlayercheck","class":"",innerHTML:this.i18n.addLayer},p),s=new S({name:"addlayer",id:e.widget.id+"_addlayercheck","class":"",value:!1,checked:!1},f.create("input",{},y)),f.create("label",{"for":e.widget.id+"_addextentcheck","class":"",innerHTML:this.i18n.withinMapArea},b),n=new S({name:"extentcheck",id:e.widget.id+"_addextentcheck","class":"",value:!0,checked:!0,onChange:t.hitch(this,function(e){c.set("useExtent",e)})},f.create("input",{},h)),a=new L({title:this.i18n.browseAnalysisTitle,content:l,doLayout:!0,browseItems:c,addlayerCheckBox:s,style:"padding:.75em 0;background-color: #fff;"}),e.widget.own(e.widget.get("map").on("extent-change",t.hitch(e.widget,function(){console.log("new extent",e.widget.get("map").extent),c.set("extent",e.widget.get("map").extent)}))),a}},addAnalysisReadyLayer:function(e){if(F.isDefined(e)&&F.isDefined(e.item)&&F.isDefined(e.layersSelect)&&F.isDefined(e.layers)&&F.isDefined(e.browseDialog)){e.browseDialog.browseItems._closePopup(),e.browseDialog.hide();var s,a,n,r,o,l={url:e.item.url+"/0",itemId:e.item.id,title:e.item.title,analysisReady:!0},d=i.some(e.layers,function(e,t){var i=e.analysisReady&&l.analysisReady&&e.itemId===l.itemId;return i&&(s=t),i}),m=new b;return d?(e.posIncrement&&(s+=e.posIncrement),e.browseDialog.addlayerCheckBox.get("checked")&&(e.posIncrement||(e.posIncrement=0),o=e.layers[s-e.posIncrement],e.widget.map.getLayer(o.lyr.id)||(this._addLayerHandle&&this._addLayerHandle.remove(),this._addLayerHandle=e.widget.map.on("layer-add",t.hitch(this,function(t){this._addLayerHandle.remove(),e.widget.emit("add-ready-to-use-layer",{layer:t.layer,layerInfo:o.linfo,item:o})})),e.widget.map.addLayer(o.lyr))),e.layersSelect.set("value",s),e.browseDialog.browseItems.clear(),m.resolve()):(m=M({url:l.url,content:{f:"json"}}),m.then(t.hitch(this,function(i){var s=new j(l.url,{outFields:["*"]});t.mixin(l,s),t.mixin(l,i),l.id=l.title+"_"+i.id,l.title=l.title.replace(/_/g," "),l.name=l.title,l.version=l.currentVersion,r=e.layersSelect.getOptions(),a=r.splice(r.length-2,2),e.layersSelect.removeOption(a),n=e.layers.length,e.posIncrement&&(n+=e.posIncrement),a.unshift({value:n,label:l.title,selected:!0}),e.layersSelect.addOption(a),e.layersSelect.set("value",n),l.lyr=s,l.linfo=i,e.layers.push(l),s.name=l.name,e.browseDialog.addlayerCheckBox.get("checked")&&(this._addLayerHandle&&this._addLayerHandle.remove(),this._addLayerHandle=e.widget.map.on("layer-add",t.hitch(this,function(t){this._addLayerHandle.remove(),e.widget.emit("add-ready-to-use-layer",{layer:t.layer,layerInfo:i,item:l})})),e.widget.map.addLayer(s)),e.browseDialog.browseItems.clear()}))),m.promise}},addReadyToUseLayerOption:function(e,s){e&&e.showReadyToUseLayers&&(s||(s=[]),e.signInPromise.then(t.hitch(this,function(){i.forEach(s,function(t){t.addOption({type:"separator",value:""}),t.addOption({value:"browse",label:e.i18n.browseAnalysisTitle})},this),F.isDefined(e._browsedlg)||(e._browsedlg=this.addBrowseAnalysisDialog({widget:e}),e.own(e._browsedlg.browseItems.on("select-change",t.hitch(e,e._handleBrowseItemsSelect)),e._browsedlg.on("hide",t.hitch(e,function(){e._browsedlg.browseItems._closePopup(),i.forEach(s,function(e){"browse"===e.get("value")&&e.reset()})}))))})))},getMaxInputByMode:function(e){var t,i=300,s=300,a=1e3,n=1.60934,r=5280,o=1760;if(e&&e.units&&e.type)return"StraightLine"===e.type?"Miles"===e.units?t=a:"Yards"===e.units?t=a*o:"Kilometers"===e.units?t=v.format(a*n,{places:2}):"Meters"===e.units?t=v.format(a*n*1e3,{places:2}):"Feet"===e.units&&(t=a*r):"DrivingDistance"===e.type||"TruckingDistance"===e.type||"WalkingDistance"===e.type?"Miles"===e.units?t=i:"Yards"===e.units?t=i*o:"Kilometers"===e.units?t=v.format(i*n,{places:2}):"Meters"===e.units?t=v.format(i*n*1e3,{places:2}):"Feet"===e.units&&(t=i*r):("DrivingTime"===e.type||"TruckingTime"===e.type||"WalkingTime"===e.type)&&("Minutes"===e.units?t=s:"Seconds"===e.units?t=60*s:"Hours"===e.units&&(t=s/60)),t},updateModeConstraints:function(e){var t;e&&e.validateWidget&&e.units&&e.type&&(t=e.validateWidget.get("constraints"),t.max=this.getMaxInputByMode(e),e.validateWidget.set(t))},getTravelModes:function(e){var s,a,r,o,l=new b;return F.isDefined(this.travelModes)&&this.travelModes.length>0?l.resolve(this.travelModes):e&&e.widget?e.widget.signInPromise.then(t.hitch(this,function(){o=e.widget.get("helperServices"),o&&o.routingUtilities?(r=o.routingUtilities.url,s="sync"):s=e.widget._getSelf(e.widget.portalUrl),I(s,t.hitch(this,function(e){var s={};return e&&e.helperServices&&e.helperServices.routingUtilities&&(r=e.helperServices.routingUtilities.url),F.isDefined(r)?(a=new N(r+"/GetTravelModes"),void a.execute(s).then(t.hitch(this,function(e){var t=e[0].value&&e[0].value.features;this.travelModes=i.map(t,function(e){return n.fromJson(e.attributes.TravelMode)}),e[1]&&e[1].paramName&&"defaultTravelMode"===e[1].paramName&&(this.defaultTravelModeId=e[1].value),l.resolve(this.travelModes)}),t.hitch(this,function(e){l.reject(e)}))):void l.reject(new Error("Missing Routing Utility Service to get Travel Modes"))}),function(e){l.reject(e)})})):l.reject(new Error("Missing parameter: params.widget required parameter")),l.promise},populateTravelModes:function(e){if(e&&e.selectWidget&&e.widget){var s=[],a=e.allowmode||"all";this.initI18n(),e.addStraightLine&&s.push({value:"StraightLine",label:'<div class="esriFloatLeading bufferIcon esriStraightLineDistanceIcon"></div><div class="esriLeadingMargin4" style="height:20px;margin-top:10px;">'+this.i18n.straightLineDistance+"</div>"}),this.getTravelModes({widget:e.widget}).then(t.hitch(this,function(t){i.forEach(t,function(t){var i,n,r=t.name,o=e.separator||"",l=r.replace(/\s/g,o),d="AUTOMOBILE"===t.type?"Driving":"TRUCK"===t.type?"Trucking":"WALK"===t.type?"Walking":"Other",m=d.toLowerCase(),c=t.units||r.split(/\s/)[1],u=r,y=F.isDefined(e.enableTravelModes)&&!e.enableTravelModes;c=t.impedanceAttributeName===t.timeAttributeName?"Time":t.impedanceAttributeName===t.distanceAttributeName?"Distance":"Other",i='<div class="esriFloatLeading bufferIcon esri'+d+c+'Icon"></div><div class="esriLeadingMargin4" style="height:20px;margin-top:10px;">'+u+"</div>",n={label:i,value:l,travelMode:t,disabled:y,modei18nKey:m,units:c},("all"===a||a===c.toLowerCase())&&("all"!==a&&(n.value=n.value.replace(c,"")),e.selectDefaultMode&&this.defaultTravelModeId&&this.defaultTravelModeId===t.id&&(n.selected=!0),s.push(n))},this),e.selectWidget.removeOption(),e.selectWidget.addOption(s),e.selectWidget.set("value",e.value),e.widget.emit("travelmodes-added",{travelOptions:s})}),t.hitch(this,function(){s&&s.length>0&&(e.selectWidget.removeOption(),e.selectWidget.addOption(s),e.selectWidget.set("value",e.value),e.widget.emit("travelmodes-added",{travelOptions:s}))}))}}}),o("extend-esri")&&t.setObject("dijit.analysis.utils",C,x),C});