// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.17/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/event","dojo/_base/json","dojo/dom-attr","dojo/has","dojo/i18n","dojo/io-query","dojo/i18n!../../nls/jsapi","dojo/json","dojo/string","dojo/query","dojo/date/locale","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/Deferred","dojo/number","dojo/_base/window","dojo/when","dojo/dom","dojo/data/ItemFileWriteStore","dojo/topic","dijit/registry","dijit/Dialog","dijit/form/CheckBox","../../kernel","../../lang","../../request","./HelpWindow","../../tasks/query","../../dijit/BrowseItems","../../layers/FeatureLayer","./PluginAnalysisLayers","../../tasks/Geoprocessor","../../dijit/SingleFilter","./FeatureRecordSetLayer","./PluginLayers","../../layers/ArcGISImageServiceLayer"],function(e,t,i,s,a,n,r,o,l,d,c,m,y,u,h,g,p,f,b,w,v,T,I,L,D,S,x,_,M,F,E,P,N,j,O,C,A,k,B,G,R){var U={};return t.mixin(U,{_helpDialog:null,i18n:null,initHelpLinks:function(e,i,n){if(this._helpDialog||(this._helpDialog=new P),e){var o=S.byNode(e),l=o?o.get("helpFileName"):n&&n.helpFileName?n.helpFileName:null,d=o?o.get("isSingleTenant"):n&&n.isSingleTenant?n.isSingleTenant:!1;o&&(o.showGeoAnalyticsParams||o.showBigData)||n&&n.analysisMode&&"bigdata"===n.analysisMode?l+="_bd":n&&n.analysisMode&&"raster"===n.analysisMode&&(l+="_ro"),u("[esriHelpTopic]",e).forEach(function(o){o&&(g.set(o,"display",F.isDefined(i)&&i!==!0?"none":""),s.connect(o,"onclick",t.hitch(this,function(t){a.stop(t),this._helpDialog.show(t,{helpId:r.get(o,"esriHelpTopic"),helpFileName:l,analysisGpServer:n&&n.analysisGpServer?n.analysisGpServer:null,helpParentNode:e,isPortal:d})})))},this)}},constructAnalysisFeatColl:function(e){var i,s={};s.featureCollection=e.layerDefinition;for(i in s.featureCollection)s.featureCollection.hasOwnProperty(i)&&"objectIdField"===i&&(s.featureCollection.objectIdFieldName=t.clone(s.featureCollection.objectIdField),delete s.featureCollection.objectIdField);return s.featureCollection.features=e.featureSet.features,s},constructAnalysisInputLyrObj:function(e,i){var s,a,n,r,o={},l=e.getMap()||e._map;if(e.url&&!e._collection){if(o={url:e.url},n=this.isHostedService(e.url),r=e.version>=10.2&&e._useStandardizedQueries,e.getDefinitionExpression&&e.getDefinitionExpression()?o.filter=e.getDefinitionExpression():F.isDefined(e.definitionExpression)&&""!==e.definitionExpression&&(o.filter=e.definitionExpression),e.useMapTime&&e.timeInfo&&l&&l.timeExtent&&(r||n||e.version>=10.2)){var c="";e.timeInfo.startTimeField&&!e.timeInfo.endTimeField?(l.timeExtent.startTime&&(c=e.timeInfo.startTimeField+" > "+(n?"":"timestamp ")+"'"+this.formatDate(l.timeExtent.startTime)+"'"),l.timeExtent.endTime&&(l.timeExtent.startTime&&(c+=" AND "),c+=e.timeInfo.startTimeField+" < "+(n?"":"timestamp ")+"'"+this.formatDate(l.timeExtent.endTime)+"'")):!e.timeInfo.startTimeField&&e.timeInfo.endTimeField?(l.timeExtent.startTime&&(c=e.timeInfo.endTimeField+" > "+(n?"":"timestamp ")+"'"+this.formatDate(l.timeExtent.startTime)+"'"),l.timeExtent.endTime&&(l.timeExtent.startTime&&(c+=" AND "),c+=e.timeInfo.endTimeField+" < "+(n?"":"timestamp ")+"'"+this.formatDate(l.timeExtent.endTime)+"'")):e.timeInfo.startTimeField&&e.timeInfo.endTimeField&&(l.timeExtent.startTime&&(c=e.timeInfo.startTimeField+" > "+(n?"":"timestamp ")+"'"+this.formatDate(l.timeExtent.startTime)+"'"),l.timeExtent.endTime&&(l.timeExtent.startTime&&(c+=" AND "),c+=e.timeInfo.endTimeField+" < "+(n?"":"timestamp ")+"'"+this.formatDate(l.timeExtent.endTime)+"'")),o.filter?o.filter+=" AND "+c:o.filter=c}e.credential&&(o.serviceToken=e.credential.token),-1!==o.url.indexOf("?")&&(s=o.url.substring(o.url.indexOf("?")+1,o.url.length),a=d.queryToObject(s),t.mixin(o,a),o.url=o.url.substring(0,o.url.indexOf("?")))}else if(!e.url||e._collection)try{o=e.toJson()}catch(y){e._json=m.parse(e._json),o=e.toJson()}return i&&(o=new B(o)),o},formatDate:function(e){return h.format(e,{datePattern:"yyyy-MM-dd",selector:"date"})+" "+h.format(e,{selector:"time",timePattern:"HH:mm:ss"})},isHostedService:function(e){if(!e)return!1;var t=".arcgis.com/",i="//services",s="//tiles",a="//features",n=-1!==e.indexOf(t),r=-1!==e.indexOf(i)||-1!==e.indexOf(s)||-1!==e.indexOf(a);return n&&r},isTimeEnabled:function(e){var t=e.version>=10.2&&e._useStandardizedQueries;return e.useMapTime&&e.timeInfo&&(t||e.version>=10.2)},isTimeInstantLayer:function(e){return F.isDefined(e.timeInfo)&&F.isDefined(e.timeInfo.startTimeField)&&!F.isDefined(e.timeInfo.endTimeField)||F.isDefined(e.time)&&F.isDefined(e.time.timeType)&&"instant"===e.time.timeType},buildReport:function(e,s){var a="";return s||(s={},t.mixin(s,c.analysisMsgCodes)),i.forEach(e,function(e){var n,r,o;"string"==typeof e.message?(n=F.isDefined(s[e.messageCode])?s[e.messageCode]:e.message,a+=e.style.substring(0,e.style.indexOf("</"))+(this._isEmptyObject(e.params)?n:y.substitute(n,e.params))+e.style.substring(e.style.indexOf("</"))):t.isArray(e.message)&&(o=[],r=t.clone(e.style),i.forEach(e.message,function(t,i){r=r.replace(/<\//,"${"+i+"}"),n=F.isDefined(s[e.messageCode+"_"+i])?s[e.messageCode+"_"+i]:t,n=this._isEmptyObject(e.params)?n:y.substitute(n,e.params),o.push(n+"</")},this),r=y.substitute(r,o),a+=r)},this),a},getLayerFeatureCount:function(e,t){var i=new N;return i.geometry=t.geometry||"",i.where=t.where||"1=1",i.geometryType=t.geometryType||"esriGeometryEnvelope",e.queryCount(i)},createPolygonFeatureCollection:function(e){var t;return t={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPolygon"}},t.layerDefinition={currentVersion:10.2,copyrightText:"",defaultVisibility:!0,relationships:[],isDataVersioned:!1,supportsRollbackOnFailureParameter:!0,supportsStatistics:!0,supportsAdvancedQueries:!0,geometryType:"esriGeometryPolygon",minScale:0,maxScale:0,objectIdField:"OBJECTID",templates:[],type:"Feature Layer",displayField:"TITLE",visibilityField:"VISIBLE",name:e,hasAttachments:!1,typeIdField:"TYPEID",capabilities:"Query",allowGeometryUpdates:!0,htmlPopupType:"",hasM:!1,hasZ:!1,globalIdField:"",supportedQueryFormats:"JSON",hasStaticData:!1,maxRecordCount:-1,indexes:[],types:[],drawingInfo:{renderer:{type:"simple",symbol:{color:[0,0,0,255],outline:{color:[0,0,0,255],width:3,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSNull"},label:"",description:""},transparency:0,labelingInfo:null,fixedSymbols:!0},fields:[{alias:"OBJECTID",name:"OBJECTID",type:"esriFieldTypeOID",editable:!1},{alias:"Title",name:"TITLE",length:50,type:"esriFieldTypeString",editable:!0},{alias:"Visible",name:"VISIBLE",type:"esriFieldTypeInteger",editable:!0},{alias:"Description",name:"DESCRIPTION",length:1073741822,type:"esriFieldTypeString",editable:!0},{alias:"Type ID",name:"TYPEID",type:"esriFieldTypeInteger",editable:!0}]},t},createPointFeatureCollection:function(e){var t;return t={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPoint"}},t.layerDefinition={objectIdField:"OBJECTID",templates:[],type:"Feature Layer",drawingInfo:{renderer:{field1:"TYPEID",type:"simple",symbol:{height:24,xoffset:0,yoffset:12,width:24,contentType:"image/png",type:"esriPMS",url:"http://static.arcgis.com/images/Symbols/Basic/GreenStickpin.png"},description:"",value:"0",label:"Stickpin"}},displayField:"TITLE",visibilityField:"VISIBLE",name:e,hasAttachments:!1,typeIdField:"TYPEID",capabilities:"Query",types:[],geometryType:"esriGeometryPoint",fields:[{alias:"OBJECTID",name:"OBJECTID",type:"esriFieldTypeOID",editable:!1},{alias:"Title",name:"TITLE",length:50,type:"esriFieldTypeString",editable:!0},{alias:"Visible",name:"VISIBLE",type:"esriFieldTypeInteger",editable:!0},{alias:"Description",name:"DESCRIPTION",length:1073741822,type:"esriFieldTypeString",editable:!0},{alias:"Type ID",name:"TYPEID",type:"esriFieldTypeInteger",editable:!0}]},t},createFolderStore:function(e,t){var s=new L({data:{identifier:"id",label:"name",items:[]}});return s.newItem({name:t,id:""}),i.forEach(e,function(e){s.newItem({name:e.title,id:e.id})}),s},setupFoldersUI:function(e){e.folderSelect.set("store",e.folderStore),e.folderSelect.set("required",!0),e.folderSelect.set("searchAttr","name"),F.isDefined(e.folderId)?e.folderStore.get(e.folderId).then(t.hitch(this,function(t){F.isDefined(t)?e.folderSelect.set("item",t):e.folderStore.get("").then(function(t){e.folderSelect.set("item",t)},this)})):e.folderName?e.folderStore.fetch({query:{name:e.folderName},onComplete:t.hitch(this,function(t){F.isDefined(t)&&t.length>0?e.folderSelect.set("item",t[0]):e.folderStore.get("").then(function(t){e.folderSelect.set("item",t)},this)})}):e.username?e.folderSelect.set("displayedValue",e.username):e.folderStore.get("").then(function(t){e.folderSelect.set("item",t)},this)},_isEmptyObject:function(e){var t;for(t in e)if(e.hasOwnProperty(t))return!1;return!0},validateServiceName:function(e,t){var i,s,a=/(:|&|<|>|%|#|\?|\\|\"|\/|\+)/.test(e),n=!0;return F.isDefined(t)&&t.textInput&&(s=t.textInput),this.initI18n(),0===e.length||0===y.trim(e).length?(i=this.i18n.requiredValue,n=!1):a?(i=this.i18n.invalidServiceName,n=!1):e.length>98?(i=this.i18n.invalidServiceNameLength,n=!1):encodeURIComponent(e).length>170&&(i=this.i18n.invalidEncodedServiceNameLength,n=!1),s&&!n&&s.set("invalidMessage",i),n},getStepNumber:function(e){u(".esriAnalysisNumberLabel",e).forEach(function(e,t){var i=this._getNumberLabel(t);r.set(e,"innerHTML",i)},this)},_getNumberLabel:function(e){var t="";switch(this.initI18n(),e){case 0:t=this.i18n.oneLabel;break;case 1:t=this.i18n.twoLabel;break;case 2:t=this.i18n.threeLabel;break;case 3:t=this.i18n.fourLabel;break;case 4:t=this.i18n.fiveLabel;break;case 5:t=this.i18n.sixLabel;break;case 6:t=this.i18n.sevenLabel;break;case 7:t=this.i18n.eightLabel;break;case 8:t=this.i18n.nineLabel}return t},populateAnalysisLayers:function(e,t,s,a){if(e){var n=[],r=e.get(t);e._titleRow&&g.set(e._titleRow,"display","none"),e._analysisLabelRow&&g.set(e._analysisLabelRow,"display","table-row"),e._selectAnalysisRow&&(g.set(e._selectAnalysisRow,"display","table-row"),p.add(e._analysisSelect.domNode,"esriTrailingMargin3"),g.set(e._analysisSelect.domNode.parentNode,"padding-bottom","1em")),e.domNode&&this.getStepNumber(e.domNode),F.isDefined(a)&&a.chooseLabel&&n.push({value:-1,label:this.i18n.chooseLabel}),F.isDefined(a)&&F.isDefined(a.posIncrement)||(F.isDefined(a)||(a={}),a.posIncrement=0),i.forEach(e.get(s),function(e,t){t+=a.posIncrement;var i={value:F.isDefined(a)&&a.chooseLabel?t+1:t,label:e.name};r&&e.name===r.name&&(i.selected=!0),n.push(i)},this),e._analysisSelect.addOption(n),e._analysisSelect.set("required",!0)}},isValidAnalysisLayer:function(e){var t,s,a,n,r,o,l,d,c,m,u,h,g,p,f="",b=!0,w={isValid:b,validationMessage:f},v=0,T=0,I=0;return F.isDefined(e)&&F.isDefined(e.toolName)?(this.initI18n(),F.isDefined(this.i18n.cblPointMsg)||(this.i18n.cblPointMsg="You need to have at least one point feature layer to run ${toolName}."),t=e.toolName,s=e.featureLayers,a=e.analysisLayer,n=t.charAt(0).toLowerCase()+t.substring(1),l=this.i18n,u=e.showReadyToUseLayers||!1,i.forEach(s,function(e){e instanceof R&&(h=!0),h&&e.bandCount>1&&(g=!0),h&&1===e.bandCount&&(p=!0),"esriGeometryPoint"===e.geometryType&&(o=!0,v++),("esriGeometryPoint"===e.geometryType||"esriGeometryMultipoint"===e.geometryType)&&(d=!0),"esriGeometryPolyline"===e.geometryType&&(c=!0,I++),"esriGeometryPolygon"===e.geometryType&&(r=!0,T++)},this),-1!==i.indexOf(["CreateDriveTimeAreas","PlanRoutes","ConnectOriginsToDestinations"],t)&&(!o||a&&"esriGeometryPoint"!==a.geometryType)?(f=y.substitute(this.i18n.selectPointLayer,{toolName:l[n]}),b=!1):"AggregatePoints"!==t&&"InterpolatePoints"!==t||(!a||"esriGeometryPoint"===a.geometryType||"esriGeometryMultipoint"===a.geometryType)&&d?"CalculateDensity"===t&&(!d&&!c||a&&"esriGeometryPoint"!==a.geometryType&&"esriGeometryMultipoint"!==a.geometryType&&"esriGeometryPolyline"!==a.geometryType)?(f=y.substitute(this.i18n.areaFeatureInvalidMsg,{toolName:l[n]}),b=!1):"FindHotSpots"===t&&(!d&&!r||a&&"esriGeometryPoint"!==a.geometryType&&"esriGeometryMultipoint"!==a.geometryType&&"esriGeometryPolygon"!==a.geometryType)?(f=y.substitute(this.i18n.hotspotsLineFeatureMsg,{toolName:l[n]}),b=!1):"OverlayLayers"!==t&&"AggregatePoints"!==t&&"SummarizeWithin"!==t&&"SummarizeNearby"!==t&&"FindNearest"!==t&&"MergeLayers"!==t||u||0!==s.length&&(1!==s.length||s[0]!==a&&F.isDefined(a))?"ConnectOriginsToDestinations"===t&&!u&&(0===s.length||2>v)?(f=y.substitute(this.i18n.odPointMsg,{toolName:l[n]}),b=!1):"ChooseBestFacilities"!==t||0!==s.length&&0!==v?"AggregatePoints"===t&&!u&&s.length>1?(r=i.some(s,function(e){return"esriGeometryPolygon"===e.geometryType}),r||(f=y.substitute(this.i18n.aggregatePolyMsg,{toolName:l[n]}),b=!1)):"MergeLayers"===t&&!u&&s.length>1?(m=v>1||I>1||T>1,m||(f=this.i18n.mergeValidationMsg,b=!1)):"SummarizeWithin"!==t&&"DissolveBoundaries"!==t||(!a||"esriGeometryPolygon"===a.geometryType)&&r?"ExtractData"===t?(b=i.some(s,function(e){return-1!==e.capabilities.indexOf("Extract")}),b||(f=y.substitute(this.i18n.extractValidationMsg))):("ConnectOriginsToDestinations"===t||"ChooseBestFacilities"===t)&&s.length>1?(o=i.some(s,function(e){var t=F.isDefined(a)&&a.id===e.id;return"esriGeometryPoint"===e.geometryType&&!t}),o||(f=y.substitute("ChooseBestFacilities"===t?this.i18n.cblPointMsg:this.i18n.odPointMsg,{toolName:l[n]}),b=!1)):"CalculateSlope"===t||"DeriveAspect"===t||"RemapValues"===t?h?p||(b=!1,f=y.substitute(this.i18n.noSingleBandISMsg,{toolName:l[n]})):(b=!1,f=y.substitute(this.i18n.noImageServiceMsg,{toolName:l[n]})):"ExtractRaster"===t?h||(b=!1,f=y.substitute(this.i18n.noImageServiceMsg,{toolName:l[n]})):"MonitorVegetation"===t&&(h?g||(b=!1,f=y.substitute(this.i18n.noMultiBandISMsg,{toolName:l[n]})):(b=!1,f=y.substitute(this.i18n.noImageServiceMsg,{toolName:l[n]}))):(f=y.substitute(this.i18n.selectPolyLayer,{toolName:l[n]}),b=!1):(f=y.substitute(this.i18n.cblPointMsg,{toolName:l[n]}),b=!1):(f=y.substitute(this.i18n.overlayValidationMsg,{toolName:l[n]}),b=!1):(f=y.substitute(this.i18n.selectPointLayer,{toolName:l[n]}),b=!1),w={isValid:b,validationMessage:f}):w},initI18n:function(){this.i18n||(this.i18n={},t.mixin(this.i18n,c.common),t.mixin(this.i18n,c.analysisTools),t.mixin(this.i18n,c.analysisMsgCodes),t.mixin(this.i18n,c.browseLayersDlg),t.mixin(this.i18n,c.driveTimes))},addBrowseAnalysisDialog:function(e){if(e&&e.widget){this.i18n||this.initI18n();var i,s,a,n,r,o,l="esri/dijit/analysis/PluginAnalysisLayers",d="<div style='opacity:1;' class='grid-item gallery-view galleryNode'>${item:_formatItemTitle}${item:_formatThumbnail}"+'<div class="linksDiv" style=\'display:none;\'><div class="esriItemLinks"><div class="esriFloatLeading"><a style="text-decoration: none;"><span>Add layer to analysis</span><div class="dijitReset dijitInline esriArrows"></div></a></div></div></div>',c=function(e){var t=e.thumbnailUrl||this._portal.staticImagesUrl+"/desktopapp.png";return"<img class='grid-item galleryThumbnail' width='120px' height='80px' alt='' src='"+t+"'>"},m=function(e){return'<div class="galleryLabelContainer"><span alt=\''+(e.title||e.name||"<No Title>")+"'>"+(e.title.replace(/_/g," ")||e.name.replace(/_/g," ")||"<No Title>")+"</span></div>"},y="<div class='listServiceTitle'><table cellpadding='0' cellspacing='0' width='100%'><tr width='100%'><td nowrap='nowrap'>  <div  style=\"position:absolute;left:80px; top:10px; width:1px; height:1px; background: transparent;\"></div><div style='overflow:hidden;'><a style=\"height:16px;\">${item.title}</a></div></td></tr></table><table cellpadding='0' cellspacing='0' width='100%'><tr width='100%' class='bottomRowTable'><td width='20'>  <span class='esriAlignLeading'>${item:_formatThumbnail}</span></td><td nowrap='nowrap'>  <span class='esriAlignLeading' style='color:#656565;'>${item.owner}</span></td><td style='padding-right:5px;padding-left:3px;'></td></tr></table></div>",u=function(e){var t=e.iconUrl;return"<img class='grid-item-thumb' width='16px' height='16px' alt='' src='"+t+"'/>"},h=function(e){var t=e.iconUrl;return"<img class='grid-item-thumb' width='16px' height='16px' alt='' src='"+t+"'/>"},g=v.doc.createDocumentFragment(),p=f.create("div",{style:"width:100%;height:100%;"},g),b=f.create("div",{style:"width:100%;height:10%;","class":""}),w=f.create("div",{style:"width:100%"},p),T=this._isCustomAnalysisQuery(e.widget);1===e.browseType?(l="esri/dijit/analysis/PluginLayers",o={portalUrl:e.widget.get("portalUrl"),message:"",plugin:l,sortDescending:!0,sort:"title",self:e.widget.get("portalSelf"),pagingLinks:3,itemsPerPage:15,extent:e.widget.get("map").extent,useExtent:!1,fetchTimeout:600,galleryTemplate:y,showInfoPanel:!0,isAutoClose:!1,formatThumbnail:h,formatInfoPanelImage:u,"class":"esriAnalysisLayersItems"}):o={portalUrl:e.widget.get("portalUrl"),message:"",plugin:l,sortDescending:!0,sort:"title",self:e.widget.get("portalSelf"),pagingLinks:3,rowsPerPage:6,"class":"esriBrowseAnalysisLayers itemsGallery esriFloatLeading",extent:e.widget.get("map").extent,useExtent:!T,fetchTimeout:600,galleryTemplate:d,formatItemTitle:m,showInfoPanel:!1,showTooltip:!0,formatThumbnail:c,style:"width:48em;height:100%;clear:both;"},r=f.toDom('<div class="esriBrowseOptions">'),f.place(r,b);var I,L;L=f.create("div",{"class":"esriBrowseOption"},r),e.browseType&&1===e.browseType||(I=f.create("div",{"class":"esriBrowseOption"},r),s=new _({name:"addlayer",id:e.widget.id+(e.browseType?e.browseType:"")+"_addlayercheck","class":"",value:!1,checked:!1},f.create("input",{},I)),f.create("label",{"for":e.widget.id+"_addlayercheck","class":"esriBrowseOption_label",innerHTML:this.i18n.addLayer},I));var D=!0;return e.browseType&&1===e.browseType?D=!1:T&&(D=!1),n=new _({name:"extentcheck",id:e.widget.id+(e.browseType?e.browseType:"")+"_addextentcheck","class":"",value:D,checked:D},f.create("input",{},L)),f.create("label",{"for":e.widget.id+(e.browseType?e.browseType:"")+"_addextentcheck","class":"esriBrowseOption_label",innerHTML:this.i18n.withinMapArea},L),o.messageRight=b,i=new j(o,w),n.on("change",t.hitch(this,function(e){i.set("useExtent",e)})),a=new x({title:1===e.browseType?this.i18n.browseLayers:T?this.i18n.browseAnalysisLayers:this.i18n.browseAnalysisTitle,content:p,doLayout:e.browseType&&1===e.browseType,browseItems:i,addlayerCheckBox:s,style:"padding:.75em 0;background-color: #fff;width:50em;"}),e.widget.own(e.widget.get("map").on("extent-change",t.hitch(e.widget,function(){i.set("extent",e.widget.get("map").extent)})),a.on("hide",t.hitch(a,function(){a.browseItems.reset()}))),a}},addAnalysisReadyLayer:function(e){function s(i){var s,a,n,r=new O(o.url,{outFields:["*"]});t.mixin(o,r),t.mixin(o,i),o.id=o.title+"_"+i.id,e.item.selectedLayer?(o.title=o.title+"-"+i.name,i.name=o.title):(o.title=o.title.replace(/_/g," "),o.name=o.title),o.version=o.currentVersion,n=e.layersSelect.getOptions();var l;e.widget.showBrowseLayers&&e.widget.showReadyToUseLayers?l=3:(e.widget.showBrowseLayers||e.widget.showReadyToUseLayers)&&(l=2),s=n.splice(n.length-l,l),e.layersSelect.removeOption(s),a=e.layers.length,e.posIncrement&&(a+=e.posIncrement),s.unshift({value:a,label:o.title,selected:!0}),e.layersSelect.addOption(s),e.layersSelect.set("value",a),o.lyr=r,o.linfo=i,e.layers.push(o),r.name=o.name;var d;u(".js-add-layer-checkbox",e.browseDialog.browseItems.infoPanel).forEach(function(e){d=e.checked}),(e.browseDialog.addlayerCheckBox&&e.browseDialog.addlayerCheckBox.get("checked")||d)&&(this._addLayerHandle&&this._addLayerHandle.remove(),this._addLayerHandle=e.widget.map.on("layer-add",t.hitch(this,function(t){this._addLayerHandle.remove(),e.widget.emit("add-ready-to-use-layer",{layer:t.layer,layerInfo:i,item:o})})),e.widget.map.addLayer(r)),e.browseDialog.browseItems.clear()}if(F.isDefined(e)&&F.isDefined(e.item)&&F.isDefined(e.layersSelect)&&F.isDefined(e.layers)&&F.isDefined(e.browseDialog)){e.browseDialog.hide();var a,n,r=e.item.url&&-1!==window.location.protocol.indexOf("https:")?e.item.url.replace("http:","https:")+"/0":e.item.url+"/0",o={url:r,itemId:e.item.id,title:e.item.title,analysisReady:!0},l=i.some(e.layers,function(e,t){var i=e.analysisReady&&o.analysisReady&&e.itemId===o.itemId;return i&&(a=t),i}),d=new b,c="sync";if(l){e.posIncrement&&(a+=e.posIncrement);var m;u(".js-add-layer-checkbox",e.browseDialog.browseItems.infoPanel).forEach(function(e){m=e.checked}),(e.browseDialog.addlayerCheckBox&&e.browseDialog.addlayerCheckBox.get("checked")||m)&&(e.posIncrement||(e.posIncrement=0),n=e.layers[a-e.posIncrement],e.widget.map.getLayer(n.lyr.id)||(this._addLayerHandle&&this._addLayerHandle.remove(),this._addLayerHandle=e.widget.map.on("layer-add",t.hitch(this,function(t){this._addLayerHandle.remove(),e.widget.emit("add-ready-to-use-layer",{layer:t.layer,layerInfo:n.linfo,item:n})})),e.widget.map.addLayer(n.lyr))),e.layersSelect.set("value",a),e.browseDialog.browseItems.clear(),d.resolve()}else e.item.selectedLayer?(o.url=e.item.selectedLayer.url,d.then(t.hitch(this,s)),setTimeout(d.resolve(e.item.selectedLayer),500)):(c=e.item.itemDataUrl?E({url:e.item.itemDataUrl,content:{f:"json"}}):"sync",T(c,t.hitch(this,function(e){e&&e.layers&&e.layers[0].id&&(o.url=o.url.replace("/0","/"+e.layers[0].id)),d=E({url:o.url,content:{f:"json"}}),d.then(t.hitch(this,s))})));return d.promise}},addReadyToUseLayerOption:function(e,s){e&&(e.showReadyToUseLayers||e.showBrowseLayers)&&(s||(s=[]),e.signInPromise.then(t.hitch(this,function(){i.forEach(s,function(t){if((e.showReadyToUseLayers||e.showBrowseLayers)&&t.addOption({type:"separator",value:""}),e.showReadyToUseLayers){var i=e.i18n.browseAnalysisTitle;this._isCustomAnalysisQuery(e)&&(i=this.i18n.browseAnalysisLayers),t.addOption({value:"browse",label:i})}e.showBrowseLayers&&t.addOption({value:"browselayers",label:e.i18n.browseLayers})},this),e.showReadyToUseLayers&&!F.isDefined(e._browsedlg)&&(e._browsedlg=this.addBrowseAnalysisDialog({widget:e}),e.own(e._browsedlg.browseItems.on("select-change",t.hitch(e,e._handleBrowseItemsSelect)),e._browsedlg.on("hide",t.hitch(e,function(){i.forEach(s,function(e){"browse"===e.get("value")&&e.reset()})})))),e.showBrowseLayers&&!F.isDefined(e._browseLyrsdlg)&&(e._browseLyrsdlg=this.addBrowseAnalysisDialog({widget:e,browseType:1}),e.own(D.subscribe("/esri/browseitems/close",t.hitch(this,function(t,i){"add-layer"===t&&(console.log(t,i),e._browseLyrsdlg.browseItems.plugIn._grid&&(i.selectedLayer=e._browseLyrsdlg.browseItems.plugIn._selectedLayer,e._handleBrowseItemsSelect({dialog:e._browseLyrsdlg,selection:i})),e._browseLyrsdlg.browseItems.closeInfoPanel())})),e._browseLyrsdlg.on("hide",t.hitch(e,function(){i.forEach(s,function(e){"browselayers"===e.get("value")&&e.reset()})}))))})))},_isCustomAnalysisQuery:function(e){var t='title:"Living Atlas Analysis Layers" AND owner:esri',i=!1;return e.portalSelf&&e.portalSelf.analysisLayersGroupQuery&&e.portalSelf.analysisLayersGroupQuery!==t?i=!0:e._portal&&e._portal.analysisLayersGroupQuery&&e._portal.analysisLayersGroupQuery!==t&&(i=!0),i},getMaxInputByMode:function(e){var t,i=300,s=300,a=1e3,n=1.60934,r=5280,o=1760;if(e&&e.units&&e.type)return"StraightLine"===e.type?"Miles"===e.units?t=a:"Yards"===e.units?t=a*o:"Kilometers"===e.units?t=w.format(a*n,{places:2}):"Meters"===e.units?t=w.format(a*n*1e3,{places:2}):"Feet"===e.units&&(t=a*r):"DrivingDistance"===e.type||"TruckingDistance"===e.type||"WalkingDistance"===e.type?"Miles"===e.units?t=i:"Yards"===e.units?t=i*o:"Kilometers"===e.units?t=w.format(i*n,{places:2}):"Meters"===e.units?t=w.format(i*n*1e3,{places:2}):"Feet"===e.units&&(t=i*r):("DrivingTime"===e.type||"TruckingTime"===e.type||"WalkingTime"===e.type)&&("Minutes"===e.units?t=s:"Seconds"===e.units?t=60*s:"Hours"===e.units&&(t=s/60)),t},updateModeConstraints:function(e){var t;e&&e.validateWidget&&e.units&&e.type&&(t=e.validateWidget.get("constraints"),t.max=this.getMaxInputByMode(e),e.validateWidget.set(t))},getTravelModes:function(e){var s,a,r,o,l=new b;return F.isDefined(this.travelModes)&&this.travelModes.length>0?l.resolve(this.travelModes):e&&e.widget?e.widget.signInPromise.then(t.hitch(this,function(){o=e.widget.get("helperServices"),o&&o.routingUtilities?(r=o.routingUtilities.url,s="sync"):s=e.widget._getSelf(e.widget.portalUrl),T(s,t.hitch(this,function(e){var s={};return e&&e.helperServices&&e.helperServices.routingUtilities&&(r=e.helperServices.routingUtilities.url),F.isDefined(r)?(a=new A(r+"/GetTravelModes"),void a.execute(s).then(t.hitch(this,function(e){var t=e[0].value&&e[0].value.features;this.travelModes=i.map(t,function(e){return n.fromJson(e.attributes.TravelMode)}),e[1]&&e[1].paramName&&"defaultTravelMode"===e[1].paramName&&(this.defaultTravelModeId=e[1].value),l.resolve(this.travelModes)}),t.hitch(this,function(e){l.reject(e)}))):void l.reject(new Error("Missing Routing Utility Service to get Travel Modes"))}),function(e){l.reject(e)})})):l.reject(new Error("Missing parameter: params.widget required parameter")),l.promise},populateTravelModes:function(e){if(e&&e.selectWidget&&e.widget){var s=[],a=e.allowmode||"all";this.initI18n(),e.addStraightLine&&s.push({value:"StraightLine",label:'<div class="esriFloatLeading bufferIcon esriStraightLineDistanceIcon"></div><div class="esriLeadingMargin4" style="height:20px;margin-top:10px;">'+this.i18n.straightLineDistance+"</div>"}),this.getTravelModes({widget:e.widget}).then(t.hitch(this,function(t){i.forEach(t,function(t){var i,n,r=t.name,o=e.separator||"",l=r.replace(/\s/g,o),d="AUTOMOBILE"===t.type?"Driving":"TRUCK"===t.type?"Trucking":"WALK"===t.type?"Walking":"Other",c=d.toLowerCase(),m=t.units||r.split(/\s/)[1],y=r,u=F.isDefined(e.enableTravelModes)&&!e.enableTravelModes;m=t.impedanceAttributeName===t.timeAttributeName?"Time":t.impedanceAttributeName===t.distanceAttributeName?"Distance":"Other",i='<div class="esriFloatLeading bufferIcon esri'+d+m+'Icon"></div><div class="esriLeadingMargin4" style="height:20px;margin-top:10px;">'+y+"</div>",n={label:i,value:l,travelMode:t,disabled:u,modei18nKey:c,units:m},("all"===a||a===m.toLowerCase())&&("all"!==a&&(n.value=n.value.replace(m,"")),e.selectDefaultMode&&this.defaultTravelModeId&&this.defaultTravelModeId===t.id&&(n.selected=!0),s.push(n))},this),e.selectWidget.removeOption(),e.selectWidget.addOption(s),e.selectWidget.set("value",e.value),e.widget.emit("travelmodes-added",{travelOptions:s})}),t.hitch(this,function(){s&&s.length>0&&(e.selectWidget.removeOption(),e.selectWidget.addOption(s),e.selectWidget.set("value",e.value),e.widget.emit("travelmodes-added",{travelOptions:s}))}))}},updateDisplay:function(e,t,i){var s=new u.NodeList(e);s.style("display",t?i?i:"block":"none")}}),o("extend-esri")&&t.setObject("dijit.analysis.utils",U,M),U});