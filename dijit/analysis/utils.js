// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/event","dojo/_base/fx","dojo/_base/json","dojo/dom-attr","dojo/has","dojo/i18n","dojo/io-query","dojo/i18n!../../nls/jsapi","dojo/json","dojo/string","dojo/query","dojo/date/locale","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/Deferred","dojo/promise/all","dojo/fx/easing","dojo/number","dojo/_base/window","dojo/when","dojo/dom","dojo/on","dojo/data/ItemFileWriteStore","dojo/topic","dojo/store/Memory","dojox/mvc/equals","dijit/registry","dijit/Dialog","dijit/form/CheckBox","../../kernel","../../lang","../../units","../../request","./HelpWindow","../../tasks/query","../../dijit/BrowseItems","../../layers/FeatureLayer","./PluginAnalysisLayers","../../tasks/Geoprocessor","../../dijit/SingleFilter","./FeatureRecordSetLayer","./PluginLayers","./PCSList","./ItemTypes","../../layers/ArcGISImageServiceLayer","../../layers/RasterFunction","./AnalysisRegistry"],function(e,t,i,s,n,r,a,o,l,d,u,c,m,y,h,p,g,f,b,T,v,w,S,I,E,L,D,M,N,x,_,F,A,R,P,C,O,U,k,B,j,G,H,V,Q,W,q,K,Y,J,z,$){var X={},Z={UNKNOWN:-1,UNSUPPORTED:0,LENGTH:1,AREA:2};return t.mixin(X,{_helpDialog:null,i18n:null,UNITSMAP:{Feet:"esriFeet",Yards:"esriYards",Miles:"esriMiles",Meters:"esriMeters",Kilometers:"esriKilometers",NauticalMiles:"esriNauticalMiles"},initHelpLinks:function(e,i,s){if(e){var r=F.byNode(e),a=r?r.get("helpFileName"):s&&s.helpFileName?s.helpFileName:null,l=r?r.get("isSingleTenant"):!(!s||!s.isSingleTenant)&&s.isSingleTenant,d=$.Modes.standard,u=r&&r.portalSelf?r.portalSelf.helpBase:s&&s.helpBase?s.helpBase:null;this._helpDialog||(this._helpDialog=new k({isPortal:l})),r&&(r.showGeoAnalyticsParams||r.showBigData)||s&&s.analysisMode&&s.analysisMode===$.Modes.Bigdata?(a+="_bd",d=$.Modes.Bigdata):s&&s.analysisMode&&"raster"===s.analysisMode&&(a+="_ra",d=$.Modes.Raster),h("[esriHelpTopic]",e).forEach(function(r,c,m){r&&(g.set(r,"display",C.isDefined(i)&&!0!==i?"none":""),C.isDefined(r._helpClickHandler)&&(r._helpClickHandler.remove(),r._helpClickHandler=null),r._helpClickHandler=D(r,"click",t.hitch(this,function(t){n.stop(t),s&&s.showHelpFromUrl&&s.helpUrl?this._helpDialog.show(t,{showHelpFromUrl:s.showHelpFromUrl,helpUrl:s.helpUrl}):this._helpDialog.show(t,{helpId:o.get(r,"esriHelpTopic"),helpFileName:a,analysisGpServer:s&&s.analysisGpServer?s.analysisGpServer:null,helpParentNode:e,isPortal:l,analysisMode:d,helpBase:u})})))},this)}},constructAnalysisFeatColl:function(e){var i,s={};s.featureCollection=e.layerDefinition;for(i in s.featureCollection)s.featureCollection.hasOwnProperty(i)&&"objectIdField"===i&&(s.featureCollection.objectIdFieldName=t.clone(s.featureCollection.objectIdField),delete s.featureCollection.objectIdField);return s.featureCollection.features=e.featureSet.features,s},constructAnalysisInputLyrObj:function(e,i,s){var n,r,a,o,l,d={};if(C.isDefined(s)||(s=!0),e.getMap?o=e.getMap():e._map&&(o=e._map),e.url&&!e._collection){if(d={url:e.url},a=this.isHostedService(e.url),l=e.version>=10.2&&e._useStandardizedQueries,e.getDefinitionExpression&&e.getDefinitionExpression()?d.filter=e.getDefinitionExpression():C.isDefined(e.definitionExpression)&&""!==e.definitionExpression&&(d.filter=e.definitionExpression),e.useMapTime&&e.timeInfo&&o&&o.timeExtent&&(l||a||e.version>=10.2)&&s){var c="";e.timeInfo.startTimeField&&!e.timeInfo.endTimeField?(o.timeExtent.startTime&&(c=e.timeInfo.startTimeField+" > "+(a?"":"timestamp ")+"'"+this.formatDate(o.timeExtent.startTime)+"'"),o.timeExtent.endTime&&(o.timeExtent.startTime&&(c+=" AND "),c+=e.timeInfo.startTimeField+" < "+(a?"":"timestamp ")+"'"+this.formatDate(o.timeExtent.endTime)+"'")):!e.timeInfo.startTimeField&&e.timeInfo.endTimeField?(o.timeExtent.startTime&&(c=e.timeInfo.endTimeField+" > "+(a?"":"timestamp ")+"'"+this.formatDate(o.timeExtent.startTime)+"'"),o.timeExtent.endTime&&(o.timeExtent.startTime&&(c+=" AND "),c+=e.timeInfo.endTimeField+" < "+(a?"":"timestamp ")+"'"+this.formatDate(o.timeExtent.endTime)+"'")):e.timeInfo.startTimeField&&e.timeInfo.endTimeField&&(o.timeExtent.startTime&&(c=e.timeInfo.startTimeField+" > "+(a?"":"timestamp ")+"'"+this.formatDate(o.timeExtent.startTime)+"'"),o.timeExtent.endTime&&(o.timeExtent.startTime&&(c+=" AND "),c+=e.timeInfo.endTimeField+" < "+(a?"":"timestamp ")+"'"+this.formatDate(o.timeExtent.endTime)+"'")),d.filter?d.filter+=" AND "+c:d.filter=c}e.credential&&(d.serviceToken=e.credential.token),-1!==d.url.indexOf("?")&&(n=d.url.substring(d.url.indexOf("?")+1,d.url.length),r=u.queryToObject(n),t.mixin(d,r),d.url=d.url.substring(0,d.url.indexOf("?")))}else if(!e.url||e._collection)try{d=e.toJson()}catch(t){e._json=m.parse(e._json),d=e.toJson()}return d.name=e.name,i&&(d=new W(d)),d},formatDate:function(e){return p.format(e,{datePattern:"yyyy-MM-dd",selector:"date"})+" "+p.format(e,{selector:"time",timePattern:"HH:mm:ss"})},isHostedService:function(e){if(!e)return!1;var t=-1!==e.indexOf(".arcgis.com/"),i=-1!==e.indexOf("//services")||-1!==e.indexOf("//tiles")||-1!==e.indexOf("//features");return t&&i},isPortalHostedService:function(e){if(!e)return!1;return-1!==e.toLowerCase().indexOf("/hosted/")},isTimeEnabled:function(e){var t=e.version>=10.2&&e._useStandardizedQueries;return e.useMapTime&&e.timeInfo&&(t||e.version>=10.2)||C.isDefined(e.time)},isTimeInstantLayer:function(e){return C.isDefined(e.timeInfo)&&C.isDefined(e.timeInfo.startTimeField)&&!C.isDefined(e.timeInfo.endTimeField)||C.isDefined(e.time)&&C.isDefined(e.time.timeType)&&"instant"===e.time.timeType},buildReport:function(e,s){var n="";return s||(s={},t.mixin(s,c.analysisMsgCodes)),i.forEach(e,function(e,r){var a,o,l;"string"==typeof e.message?(a=C.isDefined(s[e.messageCode])?s[e.messageCode]:e.message,n+=e.style.substring(0,e.style.indexOf("</"))+(this._isEmptyObject(e.params)?a:y.substitute(a,e.params))+e.style.substring(e.style.indexOf("</"))):t.isArray(e.message)&&(l=[],o=t.clone(e.style),i.forEach(e.message,function(t,i){o=o.replace(/<\//,"${"+i+"}"),a=C.isDefined(s[e.messageCode+"_"+i])?s[e.messageCode+"_"+i]:t,a=this._isEmptyObject(e.params)?a:y.substitute(a,e.params),l.push(a+"</")},this),o=y.substitute(o,l),n+=o)},this),n},getLayerFeatureCount:function(e,t){var i=new B;return i.geometry=t.geometry||"",i.where=t.where||"1=1",i.geometryType=t.geometryType||"esriGeometryEnvelope",e.getDefinitionExpression&&e.getDefinitionExpression()&&!t.where?i.where=e.getDefinitionExpression():C.isDefined(e.definitionExpression)&&""!==e.definitionExpression&&!t.where&&(i.where=e.definitionExpression),e.queryCount(i)},createPolygonFeatureCollection:function(e){var t;return t={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPolygon"}},t.layerDefinition={currentVersion:10.2,copyrightText:"",defaultVisibility:!0,relationships:[],isDataVersioned:!1,supportsRollbackOnFailureParameter:!0,supportsStatistics:!0,supportsAdvancedQueries:!0,geometryType:"esriGeometryPolygon",minScale:0,maxScale:0,objectIdField:"OBJECTID",templates:[],type:"Feature Layer",displayField:"TITLE",visibilityField:"VISIBLE",name:e,hasAttachments:!1,typeIdField:"TYPEID",capabilities:"Query",allowGeometryUpdates:!0,htmlPopupType:"",hasM:!1,hasZ:!1,globalIdField:"",supportedQueryFormats:"JSON",hasStaticData:!1,maxRecordCount:-1,indexes:[],types:[],drawingInfo:{renderer:{type:"simple",symbol:{color:[0,0,0,255],outline:{color:[0,0,0,255],width:3,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSNull"},label:"",description:""},transparency:0,labelingInfo:null,fixedSymbols:!0},fields:[{alias:"OBJECTID",name:"OBJECTID",type:"esriFieldTypeOID",editable:!1},{alias:"Title",name:"TITLE",length:50,type:"esriFieldTypeString",editable:!0},{alias:"Visible",name:"VISIBLE",type:"esriFieldTypeInteger",editable:!0},{alias:"Description",name:"DESCRIPTION",length:1073741822,type:"esriFieldTypeString",editable:!0},{alias:"Type ID",name:"TYPEID",type:"esriFieldTypeInteger",editable:!0}]},t},createPointFeatureCollection:function(e){var t;return t={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPoint"}},t.layerDefinition={objectIdField:"OBJECTID",templates:[],type:"Feature Layer",drawingInfo:{renderer:{field1:"TYPEID",type:"simple",symbol:{height:24,xoffset:0,yoffset:12,width:24,contentType:"image/png",type:"esriPMS",url:"http://static.arcgis.com/images/Symbols/Basic/GreenStickpin.png"},description:"",value:"0",label:"Stickpin"}},displayField:"TITLE",visibilityField:"VISIBLE",name:e,hasAttachments:!1,typeIdField:"TYPEID",capabilities:"Query",types:[],geometryType:"esriGeometryPoint",fields:[{alias:"OBJECTID",name:"OBJECTID",type:"esriFieldTypeOID",editable:!1},{alias:"Title",name:"TITLE",length:50,type:"esriFieldTypeString",editable:!0},{alias:"Visible",name:"VISIBLE",type:"esriFieldTypeInteger",editable:!0},{alias:"Description",name:"DESCRIPTION",length:1073741822,type:"esriFieldTypeString",editable:!0},{alias:"Type ID",name:"TYPEID",type:"esriFieldTypeInteger",editable:!0}]},t},createFolderStore:function(e,t){var s=new M({data:{identifier:"id",label:"name",items:[]}});return s.newItem({name:t,id:""}),i.forEach(e,function(e){s.newItem({name:e.title,id:e.id})}),s},setupFoldersUI:function(e){e.folderSelect.set("store",e.folderStore),e.folderSelect.set("required",!0),e.folderSelect.set("searchAttr","name"),C.isDefined(e.folderId)?e.folderStore.get(e.folderId).then(t.hitch(this,function(t){C.isDefined(t)?e.folderSelect.set("item",t):e.folderStore.get("").then(function(t){e.folderSelect.set("item",t)},this)})):e.folderName?e.folderStore.fetch({query:{name:e.folderName},onComplete:t.hitch(this,function(t){C.isDefined(t)&&t.length>0?e.folderSelect.set("item",t[0]):e.folderStore.get("").then(function(t){e.folderSelect.set("item",t)},this)})}):e.username?e.folderSelect.set("displayedValue",e.username):e.folderStore.get("").then(function(t){e.folderSelect.set("item",t)},this)},_isEmptyObject:function(e){var t;for(t in e)if(e.hasOwnProperty(t))return!1;return!0},validateServiceName:function(e,t){var i,s,n,r=/(:|&|<|>|%|#|\?|\\|\"|\/|\+|=|\*|@|\'|;|\||,)/g,a=r.test(e),o=!0;if(C.isDefined(t)&&t.textInput&&(s=t.textInput),this.initI18n(),0===e.length||0===y.trim(e).length)i=this.i18n.requiredValue,o=!1;else if(a)i=this.i18n.invalidServiceName,o=!1;else if(e.length>98)i=this.i18n.invalidServiceNameLength,o=!1;else if(encodeURIComponent(e).length>170){for(n=e+"";encodeURIComponent(n).length>170;)n=n.substring(0,n.length-1);i=y.substitute(this.i18n.suggestedServiceNameLength,{count:n.length}),o=!1}return s&&!o&&s.set("invalidMessage",i),o},getStepNumber:function(e){h(".esriAnalysisNumberLabel",e).forEach(function(e,t){var i=this._getNumberLabel(t);o.set(e,"innerHTML",i)},this)},_getNumberLabel:function(e){var t="";switch(this.initI18n(),e){case 0:t=this.i18n.oneLabel;break;case 1:t=this.i18n.twoLabel;break;case 2:t=this.i18n.threeLabel;break;case 3:t=this.i18n.fourLabel;break;case 4:t=this.i18n.fiveLabel;break;case 5:t=this.i18n.sixLabel;break;case 6:t=this.i18n.sevenLabel;break;case 7:t=this.i18n.eightLabel;break;case 8:t=this.i18n.nineLabel}return t},populateAnalysisLayers:function(e,s,n,r){if(e){var a=[],o=e.get(s),l=e._analysisSelect||r.layerSelect;e.rerun&&!o&&(r||(r={}),r.chooseBlank=!0),e._titleRow&&g.set(e._titleRow,"display","none"),e._analysisLabelRow&&g.set(e._analysisLabelRow,"display","table-row"),e._selectAnalysisRow&&(g.set(e._selectAnalysisRow,"display","table-row"),f.add(e._analysisSelect.domNode,"esriTrailingMargin3"),g.set(e._analysisSelect.domNode.parentNode,"padding-bottom","1em")),e.domNode&&this.getStepNumber(e.domNode),C.isDefined(r)&&r.chooseLabel&&a.push({value:-1,label:this.i18n.chooseLabel}),C.isDefined(r)&&r.chooseBlank&&a.push({value:"  ",label:""}),C.isDefined(r)&&C.isDefined(r.posIncrement)||(C.isDefined(r)||(r={}),r.posIncrement=0),e.get(n)||e.set(n,[]),i.forEach(e.get(n),function(e,t){t+=r.posIncrement;var i={value:C.isDefined(r)&&r.chooseLabel?""+t+1:""+t,label:e.name};o&&(e.name===o.name||e.url&&o.url&&e.url===o.url)&&(i.selected=!0),a.push(i)},this),l.addOption(a),l.set("required",!0),r.chooseBlank&&"  "===l.get("value")&&setTimeout(t.hitch(this,this._validateSelectUI,l),100)}},isValidAnalysisLayer:function(e){var t,s,n,r,a,o,l,d,u,c,m,h,p,g="",f=!0,b={isValid:f,validationMessage:g},T=0,v=0,w=0,S=!0;return C.isDefined(e)&&C.isDefined(e.toolName)?(this.initI18n(),t=e.toolName,s=e.layers,n=e.analysisLayer,r=t.charAt(0).toLowerCase()+t.substring(1),l=this.i18n,c=e.showReadyToUseLayers||!1,i.forEach(s,function(e){S=!1,e instanceof J&&(m=!0),m&&e.bandCount>1&&(h=!0),m&&1===e.bandCount&&(p=!0),"esriGeometryPoint"===e.geometryType&&(o=!0,T++),"esriGeometryPoint"!==e.geometryType&&"esriGeometryMultipoint"!==e.geometryType||(d=!0),"esriGeometryPolyline"===e.geometryType&&(u=!0,w++),"esriGeometryPolygon"===e.geometryType&&(a=!0,v++)},this),-1!==i.indexOf(["CreateDriveTimeAreas","PlanRoutes","ConnectOriginsToDestinations"],t)&&(!o||n&&"esriGeometryPoint"!==n.geometryType)?(g=y.substitute(this.i18n.selectPointLayer,{toolName:l[r]}),f=!1):"AggregatePoints"!==t&&"InterpolatePoints"!==t||(!n||"esriGeometryPoint"===n.geometryType||"esriGeometryMultipoint"===n.geometryType)&&d?"CalculateDensity"===t&&(!d&&!u||n&&"esriGeometryPoint"!==n.geometryType&&"esriGeometryMultipoint"!==n.geometryType&&"esriGeometryPolyline"!==n.geometryType)?(g=y.substitute(this.i18n.areaFeatureInvalidMsg,{toolName:l[r]}),f=!1):"FindHotSpots"!==t&&"FindOutliers"!==t||c||!(!d&&!a||n&&"esriGeometryPoint"!==n.geometryType&&"esriGeometryMultipoint"!==n.geometryType&&"esriGeometryPolygon"!==n.geometryType)?"OverlayLayers"!==t&&"AggregatePoints"!==t&&"SummarizeWithin"!==t&&"SummarizeNearby"!==t&&"FindNearest"!==t&&"MergeLayers"!==t||c||0!==s.length&&(1!==s.length||s[0]!==n&&C.isDefined(n))?"ConnectOriginsToDestinations"===t&&!c&&(S||T<2)?(g=y.substitute(this.i18n.odPointMsg,{toolName:l[r]}),f=!1):this.isFindCentroids(t)&&this.isPointLayer(n)?(g=y.substitute(this.i18n.selectNoPointLayer,{toolName:l[r]}),f=!1):this.isToolRequiresPointLayer(t)&&0===T?(g=y.substitute(this.i18n.selectPointLayer,{toolName:l[r]}),f=!1):"AggregatePoints"===t&&!c&&s.length>1?(a=i.some(s,function(e){return"esriGeometryPolygon"===e.geometryType}))||(g=y.substitute(this.i18n.aggregatePolyMsg,{toolName:l[r]}),f=!1):"MergeLayers"===t&&!c&&s.length>1?T>1||w>1||v>1||(g=this.i18n.mergeValidationMsg,f=!1):"SummarizeWithin"!==t&&"DissolveBoundaries"!==t||(!n||"esriGeometryPolygon"===n.geometryType)&&a||c?"ExtractData"===t?(f=i.some(s,function(e){return-1!==e.capabilities.indexOf("Extract")}))||(g=y.substitute(this.i18n.extractValidationMsg)):("ConnectOriginsToDestinations"===t||t===$.Tools.ChooseBestFacilities)&&s.length>1?(o=i.some(s,function(e){var t=C.isDefined(n)&&n.id===e.id;return"esriGeometryPoint"===e.geometryType&&!t}))||(g=y.substitute(t===$.Tools.ChooseBestFacilities?this.i18n.selectPointLayer:this.i18n.odPointMsg,{toolName:l[r]}),f=!1):"CalculateSlope"===t||"DeriveAspect"===t||"RemapValues"===t?m?p||(f=!1,g=y.substitute(this.i18n.noSingleBandISMsg,{toolName:l[r]})):(f=!1,g=y.substitute(this.i18n.noImageServiceMsg,{toolName:l[r]})):"ExtractRaster"===t?m||(f=!1,g=y.substitute(this.i18n.noImageServiceMsg,{toolName:l[r]})):"MonitorVegetation"===t&&(m?h||(f=!1,g=y.substitute(this.i18n.noMultiBandISMsg,{toolName:l[r]})):(f=!1,g=y.substitute(this.i18n.noImageServiceMsg,{toolName:l[r]}))):(g=y.substitute(this.i18n.selectPolyLayer,{toolName:l[r]}),f=!1):(g=y.substitute(this.i18n.overlayValidationMsg,{toolName:l[r]}),f=!1):(g=y.substitute(this.i18n.hotspotsLineFeatureMsg,{toolName:l[r]}),f=!1):(g=y.substitute(this.i18n.selectPointLayer,{toolName:l[r]}),f=!1),b={isValid:f,validationMessage:g}):b},isToolRequiresPointLayer:function(e){return e===$.Tools.ChooseBestFacilities},isFindCentroids:function(e){return e===$.Tools.FindCentroids},isPointLayer:function(e){return e&&"esriGeometryPoint"===e.geometryType},initI18n:function(){this.i18n||(this.i18n={},t.mixin(this.i18n,c.common),t.mixin(this.i18n,c.analysisTools),t.mixin(this.i18n,c.analysisMsgCodes),t.mixin(this.i18n,c.browseLayersDlg),t.mixin(this.i18n,c.driveTimes),t.mixin(this.i18n,c.calculateFields))},addBrowseAnalysisDialog:function(e){if(e&&e.widget){this.i18n||this.initI18n();var i,s,n,r,a,o,l="esri/dijit/analysis/PluginAnalysisLayers",d=function(e){return"<img class='grid-item galleryThumbnail' width='120px' height='80px' alt='' src='"+(e.thumbnailUrl||this._portal.staticImagesUrl+"/desktopapp.png")+"'>"},u=function(e){return'<div class="galleryLabelContainer"><span alt=\''+(e.title||e.name||"<No Title>")+"'>"+(e.title.replace(/_/g," ")||e.name.replace(/_/g," ")||"<No Title>")+"</span></div>"},c=function(e){return"<img class='grid-item-thumb' width='16px' height='16px' alt='' src='"+e.iconUrl+"'/>"},m=function(e){return"<img class='grid-item-thumb' width='16px' height='16px' alt='' src='"+e.iconUrl+"'/>"},y=I.doc.createDocumentFragment(),h=b.create("div",{style:"width:100%;height:100%;"},y),p=b.create("div",{style:"width:100%;height:10%;",class:""}),g=b.create("div",{style:"width:100%"},h),f=this._isCustomAnalysisQuery(e.widget);1===e.browseType||2===e.browseType?(l="esri/dijit/analysis/PluginLayers",o={portalUrl:e.widget.get("portalUrl"),message:"",plugin:l,sortDescending:!0,sort:"title",self:e.widget.get("portalSelf"),itemsPerPage:100,demandList:!0,extent:e.widget.get("map").extent,useExtent:!1,fetchTimeout:600,fetchType:2===e.browseType?['type:"'+Y.IS+'"']:void 0,galleryTemplate:"<div class='listServiceTitle'><table cellpadding='0' cellspacing='0' width='100%'><tr width='100%'><td nowrap='nowrap'>  <div  style=\"position:absolute;left:80px; top:10px; width:1px; height:1px; background: transparent;\"></div><div style='overflow:hidden;'><a style=\"height:16px;\">${item.title}</a></div></td></tr></table><table cellpadding='0' cellspacing='0' width='100%'><tr width='100%' class='bottomRowTable'><td width='20'>  <span class='esriAlignLeading'>${item:_formatThumbnail}</span></td><td nowrap='nowrap'>  <span class='esriAlignLeading' style='color:#656565;'>${item.owner}</span></td><td style='padding-right:5px;padding-left:3px;'></td></tr></table></div>",showInfoPanel:!0,isAutoClose:!1,checkIsButtonEnabled:!0,formatThumbnail:m,formatInfoPanelImage:c,class:"esriAnalysisLayersItems"}):o={portalUrl:e.widget.get("portalUrl"),message:"",plugin:l,sortDescending:!0,sort:"title",self:e.widget.get("portalSelf"),pagingLinks:1,rowsPerPage:6,class:"esriBrowseAnalysisLayers itemsGallery esriFloatLeading",extent:e.widget.get("map").extent,useExtent:!f,fetchTimeout:600,galleryTemplate:"<div style='opacity:1;' class='grid-item gallery-view galleryNode'>${item:_formatItemTitle}${item:_formatThumbnail}"+'<div class="linksDiv" style=\'display:none;\'><div class="esriItemLinks"><div class="esriFloatLeading"><a style="text-decoration: none;"><span>Add layer to analysis</span><div class="dijitReset dijitInline esriArrows"></div></a></div></div></div>',formatItemTitle:u,showInfoPanel:!1,showTooltip:!0,formatThumbnail:d,style:"width:48em;height:100%;clear:both;"},a=b.toDom('<div class="esriBrowseOptions">'),b.place(a,p);var T,v;v=b.create("div",{class:"esriBrowseOption"},a),(!e.browseType||1!==e.browseType&&2!==e.browseType)&&(T=b.create("div",{class:"esriBrowseOption"},a),s=new R({name:"addlayer",id:e.widget.id+(e.browseType?e.browseType:"")+"_addlayercheck",class:"",value:!1,checked:!1},b.create("input",{},T)),b.create("label",{for:e.widget.id+"_addlayercheck",class:"esriBrowseOption_label",innerHTML:this.i18n.addLayer},T));var w=!0;return!e.browseType||1!==e.browseType&&2!==e.browseType?f&&(w=!1):w=!1,r=new R({name:"extentcheck",id:e.widget.id+(e.browseType?e.browseType:"")+"_addextentcheck",class:"",value:w,checked:w},b.create("input",{},v)),b.create("label",{for:e.widget.id+(e.browseType?e.browseType:"")+"_addextentcheck",class:"esriBrowseOption_label",innerHTML:this.i18n.withinMapArea},v),o.messageRight=p,i=new j(o,g),r.on("change",t.hitch(this,function(e){i.set("useExtent",e)})),n=new A({title:1===e.browseType||2===e.browseType?this.i18n.browseLayers:f?this.i18n.browseAnalysisLayers:this.i18n.browseAnalysisTitle,content:h,browseItems:i,addlayerCheckBox:s,style:e.browseType&&1===e.browseType?"":"padding:.75em 0;background-color: #fff;width:50em;"}),e.widget.own(n.on("hide",t.hitch(n,function(e){n.browseItems.reset()}))),n}},addAnalysisReadyLayer:function(e,s){function n(i){var n,r,o,l;if("Feature Service"===a.type&&(l=new G(a.url,{outFields:["*"]}),t.mixin(a,l)),"Image Service"===a.type&&(l=new J(a.url,{outFields:["*"]}),t.mixin(a,l)),t.mixin(a,i),a.id=a.title+"_"+i.id,e.item.selectedLayer?a.title=a.title+"-"+i.name:a.title=a.title.replace(/_/g," "),a.name=a.title,a.version=a.currentVersion,y){var d=e.layersSelect.get("store");o=d&&d.data,h=2,n=o.splice(o.length-h,h);var u={id:o.length,label:a.title,name:a.title,url:a.url};o.push(u),o=o.concat(n);var c=new x({data:o,idProperty:"id"});e.layersSelect.set("store",c),e.layersSelect.set("value",u.name)}else{o=e.layersSelect.getOptions();var h;e.widget.showBrowseLayers&&e.widget.showReadyToUseLayers?h=3:(e.widget.showBrowseLayers||e.widget.showReadyToUseLayers)&&(h=2),n=o.splice(o.length-h,h),e.layersSelect.removeOption(n),r=e.layers.length,e.posIncrement&&(r+=e.posIncrement),r=""+r,n.unshift({value:r,label:a.title,selected:!0}),e.layersSelect.addOption(n),e.layersSelect.set("value",r)}l&&(a.lyr=l,l.name=a.name),a.linfo=i,e.layers.push(a),(e.browseDialog.addlayerCheckBox&&e.browseDialog.addlayerCheckBox.get("checked")||m||s)&&(this._addLayerHandle&&this._addLayerHandle.remove(),this._addLayerHandle=e.widget.map.on("layer-add",t.hitch(this,function(t){this._addLayerHandle.remove(),e.widget.emit("add-ready-to-use-layer",{layer:t.layer,layerInfo:i,item:a})})),e.widget.map.addLayer(l)),e.browseDialog.browseItems.clear()}if(C.isDefined(e)&&C.isDefined(e.item)&&C.isDefined(e.layersSelect)&&C.isDefined(e.layers)&&C.isDefined(e.browseDialog)){e.browseDialog.hide();var r,a,o,l,d,u,c;r=!e.item.selectedLayer&&e.item.url?e.item.url+"/0":e.item.selectedLayer.url,r&&-1!==window.location.protocol.indexOf("https:")&&(r=r.replace("http:","https:")),a={url:r,itemId:e.item.id,title:e.item.title,type:e.item.type,analysisReady:!0},l=i.some(e.layers,function(t,i){var s=t.analysisReady&&a.analysisReady&&t.itemId===a.itemId;return e.item.selectedLayer&&e.item.selectedLayer.url&&(s=t.itemId===a.itemId&&t.url===a.url),s&&(o=i),s});var m;h(".js-add-layer-checkbox",e.browseDialog.browseItems.infoPanel).forEach(function(e){m=e.checked});var y=-1!==e.layersSelect.baseClass.indexOf("dijitComboBox");return d=new T,c="sync",l?(e.posIncrement&&(o+=e.posIncrement),(e.browseDialog.addlayerCheckBox&&e.browseDialog.addlayerCheckBox.get("checked")||m||s)&&(e.posIncrement||(e.posIncrement=0),u=e.layers[o-e.posIncrement],e.widget.map.getLayer(u.lyr.id)||(this._addLayerHandle&&this._addLayerHandle.remove(),this._addLayerHandle=e.widget.map.on("layer-add",t.hitch(this,function(t){this._addLayerHandle.remove(),e.widget.emit("add-ready-to-use-layer",{layer:t.layer,layerInfo:u.linfo,item:u})})),e.widget.map.addLayer(u.lyr))),y?e.layersSelect.set("value",e.layers[o-1].name):e.layersSelect.set("value",""+o),e.browseDialog.browseItems.clear(),d.resolve()):e.item.selectedLayer?(a.url=e.item.selectedLayer.url,d.then(t.hitch(this,n)),setTimeout(function(){d.resolve(e.item.selectedLayer)},500)):(c=e.item.itemDataUrl?U({url:e.item.itemDataUrl,content:{f:"json"}}):"sync",E(c,t.hitch(this,function(e){e&&e.layers&&e.layers[0].id&&(a.url=a.url.substring(0,a.url.lastIndexOf("/0"))+"/"+e.layers[0].id),U({url:a.url,content:{f:"json"}}).then(t.hitch(this,function(e){n(e),d.resolve()}))}))),d.promise}},addReadyToUseLayerOption:function(e,s){e&&(e.showReadyToUseLayers||e.showBrowseLayers||e.showBrowseRasterLayers)&&(s||(s=[]),e.signInPromise||(e.signInPromise=new T,setTimeout(t.hitch(this,function(){e.signInPromise.resolve()}),100)),e.i18n||(this.initI18n(),e.i18n=this.i18n),e.signInPromise.then(t.hitch(this,function(){i.forEach(s,function(t){if(-1!==t.baseClass.indexOf("dijitComboBox")&&e.showBrowseRasterLayers){var s=t.get("store");s&&(s.put({id:"separator",name:"separator",label:"<hr>"}),s.put({id:"browselayers",name:"browselayers",label:e.i18n.browseLayers}))}else{var n=t.getOptions();if(!i.some(n,function(e){return"separator"===e.type},this)&&(e.showReadyToUseLayers||e.showBrowseLayers||e.showBrowseRasterLayers)&&t.addOption({type:"separator",value:""}),e.showReadyToUseLayers){var r=e.i18n.browseAnalysisTitle;this._isCustomAnalysisQuery(e)&&(r=e.i18n.browseAnalysisLayers),t.addOption({value:"browse",label:r})}e.showBrowseLayers&&t.addOption({value:"browselayers",label:e.i18n.browseLayers})}},this),e.showReadyToUseLayers&&!C.isDefined(e._browsedlg)&&(e._browsedlg=this.addBrowseAnalysisDialog({widget:e}),e.own(e._browsedlg.browseItems.on("select-change",t.hitch(e,e._handleBrowseItemsSelect)),e._browsedlg.on("hide",t.hitch(e,function(){i.forEach(s,function(e){"browse"===e.get("value")&&e.reset()}),e.layersSelect&&e.layersSelect.reset()})))),!e.showBrowseLayers&&!e.showBrowseRasterLayers||C.isDefined(e._browseLyrsdlg)||(e._browseLyrsdlg=this.addBrowseAnalysisDialog({widget:e,browseType:e.showBrowseRasterLayers?2:1}),e.own(e._browseLyrsdlg.on("browseitems-close",t.hitch(this,function(t){"add-layer"===t.action&&(e._browseLyrsdlg.browseItems.plugIn._grid&&(t.selection.selectedLayer=e._browseLyrsdlg.browseItems.plugIn._selectedLayer,e._handleBrowseItemsSelect({dialog:e._browseLyrsdlg,selection:t.selection})),e._browseLyrsdlg.browseItems.closeInfoPanel())})),e._browseLyrsdlg.on("hide",t.hitch(e,function(){i.forEach(s,function(e){"browselayers"===e.get("value")&&e.reset()})}))))})))},_isCustomAnalysisQuery:function(e){var t='title:"Living Atlas Analysis Layers" AND owner:esri',i=!1;return e&&e.isSingleTenant&&(t='title:"Living Atlas Analysis Layers" AND owner:esri_livingatlas'),e.portalSelf&&e.portalSelf.analysisLayersGroupQuery&&e.portalSelf.analysisLayersGroupQuery!==t?i=!0:e._portal&&e._portal.analysisLayersGroupQuery&&e._portal.analysisLayersGroupQuery!==t&&(i=!0),i},getMaxInputByMode:function(e){if(e&&e.units&&e.type&&e.limits&&e.travelMode){var t,i,s,n=e.limits.maximumBreakDistanceValue,r=e.limits.maximumBreakDistanceValueUnits,a=e.limits.maximumBreakTimeValue,o=e.limits.maximumBreakTimeValueUnits,l=e.travelMode.units;return i=a*this.perMinute(o),s=n*this.perMile(r),"StraightLine"===e.type?"Miles"===e.units?t=1e3:"Yards"===e.units?t=176e4:"Kilometers"===e.units?t=S.format(1609.344,{places:2}):"Meters"===e.units?t=S.format(1609344,{places:2}):"Feet"===e.units&&(t=528e4):"Distance"===l?"Miles"===e.units?t=s:"Yards"===e.units?t=1760*s:"Kilometers"===e.units?t=S.format(1.609344*s,{places:2}):"Meters"===e.units?t=S.format(1.609344*s*1e3,{places:2}):"Feet"===e.units&&(t=5280*s):"Time"===l&&("Minutes"===e.units?t=i:"Seconds"===e.units?t=60*i:"Hours"===e.units&&(t=i/60)),S.parse(t)}},updateModeConstraints:function(e){var t;e&&e.validateWidget&&e.units&&e.type&&e.travelMode&&(t=e.validateWidget.get("constraints"),t.max=this.getMaxInputByMode(e),e.validateWidget.set(t))},getTravelModes:function(e){var s,n,r,o,l=new T;return C.isDefined(this.travelModes)&&this.travelModes.length>0?l.resolve(this.travelModes):e&&e.widget?e.widget.signInPromise.then(t.hitch(this,function(d){o=e.widget.get("helperServices"),o&&o.routingUtilities?(r=o.routingUtilities.url,s="sync"):s=e.widget._getSelf(e.widget.portalUrl),E(s,t.hitch(this,function(e){var s={};if(e&&e.helperServices&&e.helperServices.routingUtilities&&(r=e.helperServices.routingUtilities.url),!C.isDefined(r))return void l.reject(new Error("Missing Routing Utility Service to get Travel Modes"));n=new V(r+"/GetTravelModes"),n.execute(s).then(t.hitch(this,function(e){var t=e[0].value&&e[0].value.features;this.travelModes=i.map(t,function(e){return a.fromJson(e.attributes.TravelMode)}),e[1]&&e[1].paramName&&"defaultTravelMode"===e[1].paramName&&(this.defaultTravelModeId=e[1].value),l.resolve(this.travelModes)}),t.hitch(this,function(e){l.reject(e)}))}),function(e){l.reject(e)})})):l.reject(new Error("Missing parameter: params.widget required parameter")),l.promise},populateTravelModes:function(e){if(e&&e.selectWidget&&e.widget){var s=[],n=e.allowmode||"all",r=!1;this.initI18n(),e.addStraightLine&&s.push({value:"StraightLine",label:'<div class="esriFloatLeading bufferIcon esriStraightLineDistanceIcon"></div><div class="esriLeadingMargin4" style="height:20px;margin-top:10px;">'+this.i18n.straightLineDistance+"</div>",selected:e.value&&"StraightLine"===e.value}),this.getTravelModes({widget:e.widget}).then(t.hitch(this,function(t){var a=C.isDefined(e.enableTravelModes)&&!e.enableTravelModes;i.forEach(t,function(t,i){var o=this.createOptionForTravelMode(t,{name:t.name,disabled:a,separator:e.separator});this.isTravelModeAllowed(n,o.units)&&("all"!==n&&(o.value=o.value.replace(o.units,"")),e.value&&e.value.id===t.id?_(e.value,t)&&(o.selected=!0,r=!0):!e.value&&e.selectDefaultMode&&this.defaultTravelModeId&&this.defaultTravelModeId===t.id&&(o.selected=!0),s.push(o))},this),!r&&this.isRequiredToAddTravelMode(e)&&this.isTravelModeAllowed(n,this.getTravelModeUnits(e.value))&&s.push(this.getOptionForCustomTravelMode(e,a)),e.selectWidget.removeOption(),e.selectWidget.addOption(s),e.widget.emit("travelmodes-added",{travelOptions:s})}),t.hitch(this,function(t){s&&s.length>0&&(e.selectWidget.removeOption(),e.selectWidget.addOption(s),e.widget.emit("travelmodes-added",{travelOptions:s}))}))}},getTravelModeLabel:function(e,t){var i=t||e.name;return'<div class="esriFloatLeading bufferIcon esri'+this.getTravelModei18nKey(e.type)+this.getTravelModeUnits(e)+'Icon"></div><div class="esriLeadingMargin4" style="height:20px;margin-top:10px;" title="'+e.description+'">'+i+"</div>"},getTravelModeUnits:function(e){e.units||name.split(/\s/)[1];return e.impedanceAttributeName===e.timeAttributeName?"Time":e.impedanceAttributeName===e.distanceAttributeName?"Distance":"Other"},getTravelModeValue:function(e,t){return t=t||"",e.replace(/\s/g,t)},getTravelModei18nKey:function(e){return"AUTOMOBILE"===e?"Driving":"TRUCK"===e?"Trucking":"WALK"===e?"Walking":"Other"},isTravelModeAllowed:function(e,t){return"all"===e||e.toLowerCase()===t.toLowerCase()},isRequiredToAddTravelMode:function(e){return e.widget.rerun&&"StraightLine"!==e.value},getOptionForCustomTravelMode:function(e,t){var i="&lt"+e.value.name+"&gt",s=this.createOptionForTravelMode(e.value,{name:i,disabled:t,separator:e.separator});return s.selected=!0,s},createOptionForTravelMode:function(e,t){return{label:this.getTravelModeLabel(e,t.name),value:this.getTravelModeValue(t.name,t.separator),travelMode:e,disabled:t.disabled,modei18nKey:this.getTravelModei18nKey(e.type).toLowerCase(),units:this.getTravelModeUnits(e)}},updateDisplay:function(e,t,i){new h.NodeList(e).style("display",t?i||"block":"none")},isGreaterThanZero:function(){return this.get("value")>0},getExprFunctions:function(){return this.i18n||this.initI18n(),this.exprFunctions||(this.exprFunctions=[{type:"NumType",label:y.substitute(this.i18n.asMetersFunc,{functionName:"as_meters(<i>number</i>)",num:"<i>number</i>"}),name:"as_meters()"},{type:"NumType",label:y.substitute(this.i18n.asKilometersFunc,{functionName:"as_kilometers(<i>number</i>)",num:"<i>number</i>"}),name:"as_kilometers()"},{type:"NumType",label:y.substitute(this.i18n.asFeetFunc,{functionName:"as_feet(<i>number</i>)",num:"<i>number</i>"}),name:"as_feet()"},{type:"NumType",label:y.substitute(this.i18n.asYardsFunc,{functionName:"as_yards(<i>number</i>)",num:"<i>number</i>"}),name:"as_yards()"},{type:"NumType",label:y.substitute(this.i18n.asMilesFunc,{functionName:"as_miles(<i>number</i>)",num:"<i>number</i>"}),name:"as_miles()"},{type:"NumType",label:y.substitute(this.i18n.asNuaticalMilesFunc,{functionName:"as_nautical_miles(<i>number</i>)",num:"<i>number</i>"}),name:"as_nautical_miles()"},{type:"NumType",label:y.substitute(this.i18n.absFunc,{functionName:"abs(<i>number</i>)",num:"<i>number</i>"}),name:"abs()"},{type:"NumType",
label:y.substitute(this.i18n.logFunc,{functionName:"log(<i>number</i>)",num:"<i>number</i>"}),name:"log()"},{type:"NumType",label:y.substitute(this.i18n.sinFunc,{functionName:"sin(<i>number</i>)",num:"<i>number</i>"}),name:"sin()"},{type:"NumType",label:y.substitute(this.i18n.cosFunc,{functionName:"cos(<i>number</i>)",num:"<i>number</i>"}),name:"cos()"},{type:"NumType",label:y.substitute(this.i18n.tanFunc,{functionName:"tan(<i>number</i>)",num:"<i>number</i>"}),name:"tan()"},{type:"NumType",label:y.substitute(this.i18n.squareRootFunc,{functionName:"sqrt(<i>number</i>)",num:"<i>number</i>"}),name:"sqrt()"},{type:"NumType",label:y.substitute(this.i18n.minFunc,{functionName:"min(<i>number</i>)",num:"<i>number</i>"}),name:"min()"},{type:"NumType",label:y.substitute(this.i18n.maxFunc,{functionName:"max(<i>number</i>)",num:"<i>number</i>"}),name:"max()"},{type:"NumType",label:y.substitute(this.i18n.constrainFunc,{functionName:"constrain(<i>number</i>, <i>low</i>, <i>high</i>",num:"<i>number</i>",low:"<i>low</i>",high:"<i>high</i>"}),name:"constrain(,,)"},{type:"NumType",label:y.substitute(this.i18n.iffFunc,{functionName:"iif(<i>condition</i>,<i>value if TRUE</i>,<i>value if FALSE</i>)",num:"<i>number</i>"}),name:"iif(,,)"},{type:"NumType",label:y.substitute(this.i18n.whenFunc,{functionName:"when(<i>number</i>)",num:"<i>number</i>"}),name:"when(,)"},{type:"NumType",label:y.substitute(this.i18n.decodeFunc,{functionName:"decode(<i>expression</i>, <i>case1,return1,..caseN,returnN</i>, <i>default</i>)",num:"<i>number</i>"}),name:"decode(,,,)"}]),this.exprFunctions},addAttributeOptions:function(e){this.initI18n(),C.isDefined(e.allowSelectLabel)||(e.allowSelectLabel=!0);var t,s,n,r=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],a=C.isDefined(e.emptyValue)?e.emptyValue:"";t=e.layer,s=e.selectWidget,n=t?t.fields:[],s.removeOption(s.getOptions()),e.allowSelectLabel&&s.addOption({value:a,label:this.i18n.attribute}),e.allowStringType&&r.push("esriFieldTypeString"),e.allowDateType&&r.push("esriFieldTypeDate");var o=[];return i.forEach(n,function(e){-1!==i.indexOf(r,e.type)&&e.name!==t.objectIdField&&o.push({value:e.name,label:C.isDefined(e.alias)&&""!==e.alias?e.alias:e.name,type:"esriFieldTypeString"===e.type?"string":"esriFieldTypeDate"===e.type?"date":"number"})},this),0!==o.length&&(s.addOption(o),C.isDefined(e.priorityChange)?s.set("value",a,e.priorityChange):s.set("value",a),s.set("disabled",!t||0===t.fields.length),!0)},addStatisticsOptions:function(e){this.initI18n();var t=e.selectWidget,i=[{value:"SUM",label:this.i18n.sum},{value:"MIN",label:this.i18n.minimum},{value:"MAX",label:this.i18n.maximum},{value:"MEAN",label:e.showGeoAnalyticsParams?this.i18n.mean:this.i18n.average},{value:"STDDEV",label:this.i18n.standardDev}],s=[{value:"MIN",label:this.i18n.minimum},{value:"MAX",label:this.i18n.maximum}],n=C.isDefined(e.emptyValue)?e.emptyValue:"";t.removeOption(t.getOptions()),t.addOption([{value:n,label:this.i18n.statistic}]),e.showGeoAnalyticsParams&&(t.addOption({value:"COUNT",label:this.i18n.count}),i.push({value:"VARIANCE",label:this.i18n.variance}),i.splice(4,0,{value:"RANGE",label:this.i18n.range})),e.type&&"number"!==e.type?e.type&&"string"===e.type?(t.addOption({value:"ANY",label:this.i18n.any}),e.selectWidget.optionsType="string"):e.type&&"date"===e.type&&(t.addOption(s),e.selectWidget.optionsType="date"):(t.addOption(i),e.selectWidget.optionsType="number"),t.set("value",n)},addFillOptions:function(e){var t=e.selectWidget,i=[{value:"ZEROES",label:this.i18n.zeroes},{value:"SPATIAL_NEIGHBORS",label:this.i18n.spatialneighbhors},{value:"SPACE_TIME_NEIGHBORS",label:this.i18n.spacetimeneighbors},{value:"TEMPORAL_TREND",label:this.i18n.temporaltrend}];t.removeOption(t.getOptions()),t.addOption([{value:"0",label:this.i18n.fill}]),e.type&&"number"!==e.type||t.addOption(i)},perMeter:function(e){var t=1;switch(e){case O.MILLIMETERS:t=1e3;break;case O.CENTIMETERS:t=100;break;case O.DECIMETERS:t=10;break;case O.METERS:t=1;break;case O.KILOMETERS:t=.001;break;case O.INCHES:t=39.370079;break;case O.FEET:t=3.2808399;break;case O.YARDS:t=1.0936133;break;case O.MILES:t=.00062137119;break;case O.NAUTICAL_MILES:t=.0005399568;break;case O.ACRES:t=.00024710538;break;case O.ARES:t=.01;break;case O.HECTARES:t=1e-4;break;case O.SQUARE_INCHES:t=1550.0031;break;case O.SQUARE_FEET:t=10.7639104;break;case O.SQUARE_YARDS:t=1.19599005;break;case O.SQUARE_MILES:t=3.86102159e-7;break;case O.SQUARE_NAUTICAL_MILES:t=2.9155335e-7;break;case O.SQUARE_MILLIMETERS:t=1e6;break;case O.SQUARE_CENTIMETERS:t=1e4;break;case O.SQUARE_DECIMETERS:t=100;break;case O.SQUARE_METERS:t=1;break;case O.SQUARE_KILOMETERS:t=1e-6}return t},perMile:function(e){var t=1;switch(e){case"Feet":t=189394e-9;break;case"Yards":t=568182e-9;break;case"Meters":t=621371e-9;break;case"Kilometers":t=.621371}return t},perMinute:function(e){var t=1;switch(e){case"Seconds":t=.0166667;break;case"Hours":t=60}return t},getType:function(e){var t=null;switch(e){case O.ACRES:case O.ARES:t=Z.AREA;break;case O.CENTIMETERS:case O.DECIMETERS:case O.FEET:t=Z.LENGTH;break;case O.HECTARES:t=Z.AREA;break;case O.INCHES:case O.KILOMETERS:case O.METERS:case O.MILES:case O.MILLIMETERS:case O.NAUTICAL_MILES:t=Z.LENGTH;break;case O.SQUARE_CENTIMETERS:case O.SQUARE_DECIMETERS:case O.SQUARE_FEET:case O.SQUARE_INCHES:case O.SQUARE_KILOMETERS:case O.SQUARE_METERS:case O.SQUARE_MILES:case O.SQUARE_MILLIMETERS:case O.SQUARE_NAUTICAL_MILES:case O.SQUARE_YARDS:t=Z.AREA;break;case O.YARDS:t=Z.LENGTH;break;default:t=Z.UNSUPPORTED}return t},unitConversion:function(e,t,i){var s=!0;C.isDefined(e)||(this.emitError("The 'From' Value must be a valid numeric value: "+e),s=!1),C.isDefined(t)||(this.emitError("The 'From' Units must be defined: "+t),s=!1),C.isDefined(i)||(this.emitError("The 'To' Units must be defined: "+i),s=!1),e instanceof Array&&(this.emitError("Only single 'From' Value supported: "+e),s=!1),t instanceof Array&&(this.emitError("Only single 'From' Units supported: "+t),s=!1),i instanceof Array&&(this.emitError("Only single 'To' Units supported: "+i),s=!1);var n=this.getType(t),r=this.getType(i);return n===Z.UNSUPPORTED&&(this.emitError("Unsupported 'From' Units: "+t),s=!1),r===Z.UNSUPPORTED&&(this.emitError("Unsupported 'To' Units: "+i),s=!1),n!==r&&(this.emitError("Incompatible 'From' and 'To' Units: "+t+" and "+i),s=!1),s?t===i?+e:+e/this.perMeter(t)*this.perMeter(i):Number.NaN},emitError:function(e){console.log("error",new Error(e))},isEmpty:function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return m.stringify(e)===m.stringify({})},getRoutingUtilities:function(e){var s,n,r,a,o=new T,l={};return e||o.reject(new Error("Missing parameter: widget required parameter")),-1!==i.indexOf(["CreateDriveTimeAreas","EnrichLayer","SummarizeNearby"],e.toolName)?t.mixin(l,{toolName:"GenerateServiceAreas",serviceName:"asyncServiceArea"}):e.toolName===$.Tools.ChooseBestFacilities?t.mixin(l,{toolName:"SolveLocationAllocation",serviceName:"asyncLocationAllocation"}):"PlanRoutes"===e.toolName?t.mixin(l,{toolName:"SolveVehicleRoutingProblem",serviceName:"asyncVRP"}):"FindNearest"===e.toolName?t.mixin(l,{toolName:"FindClosestFacilities",serviceName:"asyncClosestFacility"}):"ConnectOriginsToDestinations"===e.toolName&&t.mixin(l,{toolName:"FindRoutes",serviceName:"asyncRoute"}),this.routingUtilities||(this.routingUtilities={}),this.routingUtilities&&this.routingUtilities[e.toolName]?o.resolve(this.routingUtilities[e.toolName]):e.signInPromise.then(t.hitch(this,function(i){a=e.get("helperServices"),a&&a.routingUtilities?(r=a.routingUtilities.url,s="sync"):s=e._getSelf(e.portalUrl),E(s,t.hitch(this,function(i){i&&i.helperServices&&i.helperServices.routingUtilities&&(r=i.helperServices.routingUtilities.url),C.isDefined(r)||o.reject(new Error("Missing Routing Utility Service to get Network Analysis Service Limits.")),n=new V(r+"/GetToolInfo"),n.execute(l).then(t.hitch(this,function(t){t&&t.length>0&&t[0].value?(this.routingUtilities[e.toolName]=t[0].value,o.resolve(t[0].value)):o.reject("Routing Utility Service 'GetToolInfo' job did not return service limits.")}),function(e){o.reject(e)})}))}),function(e){o.reject(e)}),o.promise},getNetworkAnalysisLimits:function(e){var i=new T;return e||i.reject(new Error("Missing parameter: widget required parameter")),this.getRoutingUtilities(e).then(t.hitch(this,function(e){e.serviceLimits?i.resolve(e.serviceLimits):i.reject()}),function(e){i.reject(e)}),i.promise},isEsriWorldGeocoder:function(e){var t=this.isAgoWorldGeocodeServer(e),i=this.isAgoWorldGeocodeServerProxy(e);return t||i},isAgoWorldGeocodeServer:function(e){return e&&!!e.match(/(arcgis.com\/arcgis\/rest\/services\/world\/geocodeserver).*/gi)},isAgoWorldGeocodeServerProxy:function(e){return e&&!!e.match(/(\/servers\/[\da-z\.-]+\/rest\/services\/world\/geocodeserver).*/gi)},isWorldGeoLocator:function(e){return e&&!!e.match(/(\/rest\/services\/world\/geocodeserver).*/gi)},showMessages:function(e,i,s){o.set(i,"innerHTML",e),r.fadeIn({node:s,easing:w.quadIn,onEnd:t.hitch(this,function(){g.set(s,{display:""})})}).play()},hideMessages:function(e){r.fadeOut({node:e,easing:w.quadOut,onEnd:function(){g.set(e,{display:"none"})}}).play()},getHelpUrl:function(e){if(e.topic&&e.widget){var t;return e.widget.portalSelf&&e.widget.portalSelf.helpBase?t=e.widget.portalSelf.helpBase+"index.html#":!e.widget.isSingleTenant||e.widget.portalSelf&&e.widget.portalSelf.helpBase||(t="http://server.arcgis.com/en/portal/latest/use/"),"BufferExpression"===e.topic&&(t+="Use_expressions_with_GeoAnalytics_Tools/019300000183000000/"),t}},isPCS:function(e){return!!e&&!!K&&-1!==i.indexOf(K,e)},isPCSByLayerType:function(e){var t=!!e&&!!e.fullExtent&&this.isPCS(e.fullExtent.spatialReference.wkid);return!t&&e.extent&&(t=!!e&&!!e.extent&&this.isPCS(e.extent.spatialReference.wkid)),!t&&e.spatialReference&&(t=!!e&&!!e.spatialReference&&this.isPCS(e.spatialReference.wkid)),t},checkPCSforAnalysis:function(e){var s,n,r=e.widget&&e.widget.toolName,a=!!e.widget&&!!e.widget.context&&!!e.widget.context.processSR&&this.isPCS(e.widget.context.processSR.wkid),o=!0,l=e.jobParams||e.widget.jobParams,d=!!(e.widget&&e.widget.context&&e.widget.context.processSR&&e.widget.context.processSR.wkid);return!!(r&&l&&e.widget.showGeoAnalyticsParams)&&(n="<a  href='#' id='"+e.widget.id+"_warn_settings_link'>"+e.widget.i18n.analysisSettings+"</a><div class='esriAnalysisSettingsIcon'></div>",s=y.substitute(e.widget.i18n.PCSReqMsg,{defaultSpatialRef:e.widget.i18n.worldCylindrical,settingsIcon:n}),"FindHotSpots"!==r&&"FindPointClusters"!==r||a?"CalculateDensity"!==r&&"FindPointClusters"!==r||a?"AggregatePoints"!==r||-1===i.indexOf(["HEXAGON","SQUARE"],l.binType)||a?"SummarizeWithin"===r&&l.summaryPolygons&&!a?o=this.isPCSByLayerType(e.widget.sumWithinLayer):"SummarizeWithin"!==r||-1===i.indexOf(["HEXAGON","SQUARE"],l.binType)||a?"JoinFeatures"===r&&l.spatialNearDistance&&!a?(o=this.isPCSByLayerType(e.widget.targetLayer))||(s=y.substitute(e.widget.i18n.JFPCSReqMsg,{settingsIcon:n})):"BuildMultiVariableGrid"!==r||a||(o=i.every(e.inputLayers,function(e){return this.isPCSByLayerType(e)},this)):o=this.isPCSByLayerType(e.widget.summaryLayer):o=this.isPCSByLayerType(e.widget.pointLayer):o=this.isPCSByLayerType(e.widget.inputLayer):(o=this.isPCSByLayerType(e.widget.analysisLayer),"FindPointClusters"!==r||o||(s=y.substitute(e.widget.i18n.FPCSReqMsg,{settingsIcon:n}))),o||e.hasPCSWarnShown||(e.widget.set("disableRunAnalysis",o),this.settingsVM&&this.settingsDlg&&e.widget._bodyNode&&e.widget._errorMessagePane&&(this.showMessages(s,e.widget._bodyNode,e.widget._errorMessagePane),L.byId(e.widget.id+"_warn_settings_link")&&D(L.byId(e.widget.id+"_warn_settings_link"),"click",t.hitch(e.widget,e.widget.showSettingsDlg)))),!o&&e.hasPCSWarnShown&&d&&(o=!0),o)},tryParseJSON:function(e){try{var t=m.parse(e);if(t&&"object"==typeof t&&null!==t)return t}catch(e){}return!1},decodeTag:function(e){return{"&lt;":"<","&gt;":">"}[e]||e},stringDecode:function(e){return e.replace(/(&lt;|&gt;)/g,this.decodeTag)},jobParamsToWidgetProps:function(e){if(e&&e.jobParams){var s=e.jobParams,n=new T,r=[],a=[];for(var o in s){var l;s.hasOwnProperty(o)&&("string"==typeof s[o]&&-1!==s[o].search(/(&lt;|&gt;)/g)&&(s[o]=this.stringDecode(s[o])),(l="string"==typeof s[o]?this.tryParseJSON(s[o]):s[o])&&(-1!==o.toLowerCase().indexOf("layer")&&"object"==typeof l?a.push({key:o,obj:l}):l&&(l.Raster||l.url)&&a.push({key:o,obj:l}),s[o]=l))}for(var d=0;d<a.length;d++){var u=a[d].obj,c=a[d].key;"object"==typeof u&&u.length?(s[c]=[],i.forEach(u,function(e,t){this._getFlayers(e,c,s,r,!0,t)},this)):"object"==typeof u&&u.Raster?(u.url=u.Raster.url,this._getFlayers(u,c,s,r,!0,"Raster")):this._getFlayers(u,c,s,r)}return v(r).then(t.hitch(this,function(){n.resolve(e)}),t.hitch(this,function(){n.resolve(e)})),n.promise}},_getLayerType:function(e){return e?-1!==e.indexOf("BigDataCatalogServer")?Y.BIGDATA:-1!==e.indexOf("ImageServer")?Y.IS:Y.FS:null},_getFlayers:function(e,i,s,n,r,a){var o,l;if(e.url)o=U({url:e.url,content:{f:"json"}}),l=new T,n.push(l),o.then(t.hitch(this,function(e,i,n,a,o){var l,d=this._getLayerType(e.url);if(d===Y.FS)l=new G(e.url,{mode:G.MODE_ONDEMAND,outFields:["*"],resourceInfo:o}),e.filter&&l.setDefinitionExpression(e.filter),l.filter=e.filter;else if(d===Y.BIGDATA)l=o,t.mixin(l,e);else if(d===Y.IS){var u=e.Raster||e;l=new J(u.url),u.renderingRule&&l.setRenderingRule(new z(u.renderingRule)),u.name&&(l.name=u.name),e.Raster&&e.Raster.url===e.url&&delete e.url}e.name&&(l.name=e.name),r?s[i][a]=l:r&&d===Y.IS?t.mixin(s[i][a],l):s[i]=l,n.resolve()},e,i,l,a),t.hitch(this,function(e,t,i,n,a){var o={name:e.name,empty:!0};r?s[t][n]=o:s[t]=o,i.resolve()},e,i,l,a));else{var d=new G(e,{outFields:["*"]});e.name&&(d.name=e.name),r?s[i][a]=d:s[i]=d}},isLayerInLayers:function(e,t){return i.some(t,function(t){return t.name===e.name||t.url&&e.url&&t.url===e.url})},addBlankOption:function(e,i){i&&i.length?i.push({value:"  ",label:""}):e.addOption({value:"  ",label:""}),setTimeout(t.hitch(this,this._validateSelectUI,e),100)},_validateSelectUI:function(e){e._hasBeenBlurred=!0,e.set("focused",!0),e.validate(),e.set("focused",!1),e._hasBeenBlurred=!1,setTimeout(t.hitch(this,function(){e.reset()}),1e3)},updateExpressions:function(e){e&&e.selectedInputLayers&&e.inputLayers&&e.data&&e.expressions&&(i.forEach(e.selectedInputLayers,function(t,s){i.forEach(e.inputLayers,function(e,i){e&&t&&(!t.url&&!e.url&&t.name===e.name||t.url&&e.url&&t.url===e.url)&&(t._oldIndex=s,t._newIndex=i)})}),i.forEach(e.data,function(t,i){var s;i>0&&t&&(s=e.expressions[i-1],C.isDefined(t.layer)&&(t.layer=s&&s.layer),C.isDefined(t.selectingLayer)&&(t.selectingLayer=s&&s.selectingLayer))}),i.forEach(e.data,function(t){var s=!1,n=!1;i.forEach(e.selectedInputLayers,function(e){C.isDefined(t.layer)&&t.layer===e._oldIndex&&!s&&(t.layer=e._newIndex,s=!0),C.isDefined(t.selectingLayer)&&t.selectingLayer===e._oldIndex&&!n&&(t.selectingLayer=e._newIndex,n=!0)},this)},this))},isBigDataTypeTobeAdded:function(e){return-1==i.indexOf(e,'type:"Big Data File Share"')},removeDuplicates:function(e,t){for(var i=[],s={},n=0;n<e.length;n++)s[e[n]]?s[e[n]]=s[e[n]]+1:(i.push(e[n]),s[e[n]]=1);return t?s:i},isPoint:function(e){return e&&e.geometryType===$.GeometryTypes.Point},isLine:function(e){return e&&e.geometryType===$.GeometryTypes.Line},isPolygon:function(e){return e&&e.geometryType===$.GeometryTypes.Polygon},isSameLayer:function(e,t){return e&&t&&(e.name&&t.name&&e.name===t.name||e.url&&t.url&&e.url===t.url)},getTimeType:function(e){return!!e&&(C.isDefined(e.timeInfo)&&C.isDefined(e.timeInfo.startTimeField)&&!C.isDefined(e.timeInfo.endTimeField)?$.TimeTypes.Instant:C.isDefined(e.timeInfo)&&C.isDefined(e.timeInfo.startTimeField)&&C.isDefined(e.timeInfo.endTimeField)?$.TimeTypes.Interval:C.isDefined(e.time)&&C.isDefined(e.time.timeType)?e.time.timeType:$.TimeTypes.None)}}),l("extend-esri")&&t.setObject("dijit.analysis.utils",X,P),X});