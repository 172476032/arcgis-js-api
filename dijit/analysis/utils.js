// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.18/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/event","dojo/_base/json","dojo/dom-attr","dojo/has","dojo/i18n","dojo/io-query","dojo/i18n!../../nls/jsapi","dojo/json","dojo/string","dojo/query","dojo/date/locale","dojo/dom-style","dojo/dom-class","dojo/dom-construct","dojo/Deferred","dojo/number","dojo/_base/window","dojo/when","dojo/dom","dojo/on","dojo/data/ItemFileWriteStore","dojo/topic","dijit/registry","dijit/Dialog","dijit/form/CheckBox","../../kernel","../../lang","../../units","../../request","./HelpWindow","../../tasks/query","../../dijit/BrowseItems","../../layers/FeatureLayer","./PluginAnalysisLayers","../../tasks/Geoprocessor","../../dijit/SingleFilter","./FeatureRecordSetLayer","./PluginLayers","../../layers/ArcGISImageServiceLayer"],function(e,t,i,s,a,r,n,o,l,d,c,m,u,y,p,h,g,f,b,T,v,w,E,I,S,L,D,A,M,_,N,R,x,k,O,F,C,P,U,j,G,B,H){var Q={},V={UNKNOWN:-1,UNSUPPORTED:0,LENGTH:1,AREA:2};return t.mixin(Q,{_helpDialog:null,i18n:null,UNITSMAP:{Feet:"esriFeet",Yards:"esriYards",Miles:"esriMiles",Meters:"esriMeters",Kilometers:"esriKilometers",NauticalMiles:"esriNauticalMiles"},initHelpLinks:function(e,i,s){if(this._helpDialog||(this._helpDialog=new k),e){var r=D.byNode(e),o=r?r.get("helpFileName"):s&&s.helpFileName?s.helpFileName:null,l=r?r.get("isSingleTenant"):s&&s.isSingleTenant?s.isSingleTenant:!1,d="standard";r&&(r.showGeoAnalyticsParams||r.showBigData)||s&&s.analysisMode&&"bigdata"===s.analysisMode?(o+="_bd",d="bigdata"):s&&s.analysisMode&&"raster"===s.analysisMode&&(o+="_ra",d="raster"),y("[esriHelpTopic]",e).forEach(function(r,c,m){r&&(h.set(r,"display",N.isDefined(i)&&i!==!0?"none":""),N.isDefined(r._helpClickHandler)&&(r._helpClickHandler.remove(),r._helpClickHandler=null),r._helpClickHandler=I(r,"click",t.hitch(this,function(t){a.stop(t),this._helpDialog.show(t,{helpId:n.get(r,"esriHelpTopic"),helpFileName:o,analysisGpServer:s&&s.analysisGpServer?s.analysisGpServer:null,helpParentNode:e,isPortal:l,analysisMode:d})})))},this)}},constructAnalysisFeatColl:function(e){var i,s={};s.featureCollection=e.layerDefinition;for(i in s.featureCollection)s.featureCollection.hasOwnProperty(i)&&"objectIdField"===i&&(s.featureCollection.objectIdFieldName=t.clone(s.featureCollection.objectIdField),delete s.featureCollection.objectIdField);return s.featureCollection.features=e.featureSet.features,s},constructAnalysisInputLyrObj:function(e,i){var s,a,r,n,o,l={};if(e.getMap?n=e.getMap():e._map&&(n=e._map),e.url&&!e._collection){if(l={url:e.url},r=this.isHostedService(e.url),o=e.version>=10.2&&e._useStandardizedQueries,e.getDefinitionExpression&&e.getDefinitionExpression()?l.filter=e.getDefinitionExpression():N.isDefined(e.definitionExpression)&&""!==e.definitionExpression&&(l.filter=e.definitionExpression),e.useMapTime&&e.timeInfo&&n&&n.timeExtent&&(o||r||e.version>=10.2)&&!i){var c="";e.timeInfo.startTimeField&&!e.timeInfo.endTimeField?(n.timeExtent.startTime&&(c=e.timeInfo.startTimeField+" > "+(r?"":"timestamp ")+"'"+this.formatDate(n.timeExtent.startTime)+"'"),n.timeExtent.endTime&&(n.timeExtent.startTime&&(c+=" AND "),c+=e.timeInfo.startTimeField+" < "+(r?"":"timestamp ")+"'"+this.formatDate(n.timeExtent.endTime)+"'")):!e.timeInfo.startTimeField&&e.timeInfo.endTimeField?(n.timeExtent.startTime&&(c=e.timeInfo.endTimeField+" > "+(r?"":"timestamp ")+"'"+this.formatDate(n.timeExtent.startTime)+"'"),n.timeExtent.endTime&&(n.timeExtent.startTime&&(c+=" AND "),c+=e.timeInfo.endTimeField+" < "+(r?"":"timestamp ")+"'"+this.formatDate(n.timeExtent.endTime)+"'")):e.timeInfo.startTimeField&&e.timeInfo.endTimeField&&(n.timeExtent.startTime&&(c=e.timeInfo.startTimeField+" > "+(r?"":"timestamp ")+"'"+this.formatDate(n.timeExtent.startTime)+"'"),n.timeExtent.endTime&&(n.timeExtent.startTime&&(c+=" AND "),c+=e.timeInfo.endTimeField+" < "+(r?"":"timestamp ")+"'"+this.formatDate(n.timeExtent.endTime)+"'")),l.filter?l.filter+=" AND "+c:l.filter=c}e.credential&&(l.serviceToken=e.credential.token),-1!==l.url.indexOf("?")&&(s=l.url.substring(l.url.indexOf("?")+1,l.url.length),a=d.queryToObject(s),t.mixin(l,a),l.url=l.url.substring(0,l.url.indexOf("?")))}else if(!e.url||e._collection)try{l=e.toJson()}catch(u){e._json=m.parse(e._json),l=e.toJson()}return i&&(l=new G(l)),l},formatDate:function(e){return p.format(e,{datePattern:"yyyy-MM-dd",selector:"date"})+" "+p.format(e,{selector:"time",timePattern:"HH:mm:ss"})},isHostedService:function(e){if(!e)return!1;var t=".arcgis.com/",i="//services",s="//tiles",a="//features",r=-1!==e.indexOf(t),n=-1!==e.indexOf(i)||-1!==e.indexOf(s)||-1!==e.indexOf(a);return r&&n},isTimeEnabled:function(e){var t=e.version>=10.2&&e._useStandardizedQueries;return e.useMapTime&&e.timeInfo&&(t||e.version>=10.2)||N.isDefined(e.time)},isTimeInstantLayer:function(e){return N.isDefined(e.timeInfo)&&N.isDefined(e.timeInfo.startTimeField)&&!N.isDefined(e.timeInfo.endTimeField)||N.isDefined(e.time)&&N.isDefined(e.time.timeType)&&"instant"===e.time.timeType},buildReport:function(e,s){var a="";return s||(s={},t.mixin(s,c.analysisMsgCodes)),i.forEach(e,function(e,r){var n,o,l;"string"==typeof e.message?(n=N.isDefined(s[e.messageCode])?s[e.messageCode]:e.message,a+=e.style.substring(0,e.style.indexOf("</"))+(this._isEmptyObject(e.params)?n:u.substitute(n,e.params))+e.style.substring(e.style.indexOf("</"))):t.isArray(e.message)&&(l=[],o=t.clone(e.style),i.forEach(e.message,function(t,i){o=o.replace(/<\//,"${"+i+"}"),n=N.isDefined(s[e.messageCode+"_"+i])?s[e.messageCode+"_"+i]:t,n=this._isEmptyObject(e.params)?n:u.substitute(n,e.params),l.push(n+"</")},this),o=u.substitute(o,l),a+=o)},this),a},getLayerFeatureCount:function(e,t){var i=new O;return i.geometry=t.geometry||"",i.where=t.where||"1=1",i.geometryType=t.geometryType||"esriGeometryEnvelope",e.queryCount(i)},createPolygonFeatureCollection:function(e){var t;return t={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPolygon"}},t.layerDefinition={currentVersion:10.2,copyrightText:"",defaultVisibility:!0,relationships:[],isDataVersioned:!1,supportsRollbackOnFailureParameter:!0,supportsStatistics:!0,supportsAdvancedQueries:!0,geometryType:"esriGeometryPolygon",minScale:0,maxScale:0,objectIdField:"OBJECTID",templates:[],type:"Feature Layer",displayField:"TITLE",visibilityField:"VISIBLE",name:e,hasAttachments:!1,typeIdField:"TYPEID",capabilities:"Query",allowGeometryUpdates:!0,htmlPopupType:"",hasM:!1,hasZ:!1,globalIdField:"",supportedQueryFormats:"JSON",hasStaticData:!1,maxRecordCount:-1,indexes:[],types:[],drawingInfo:{renderer:{type:"simple",symbol:{color:[0,0,0,255],outline:{color:[0,0,0,255],width:3,type:"esriSLS",style:"esriSLSSolid"},type:"esriSFS",style:"esriSFSNull"},label:"",description:""},transparency:0,labelingInfo:null,fixedSymbols:!0},fields:[{alias:"OBJECTID",name:"OBJECTID",type:"esriFieldTypeOID",editable:!1},{alias:"Title",name:"TITLE",length:50,type:"esriFieldTypeString",editable:!0},{alias:"Visible",name:"VISIBLE",type:"esriFieldTypeInteger",editable:!0},{alias:"Description",name:"DESCRIPTION",length:1073741822,type:"esriFieldTypeString",editable:!0},{alias:"Type ID",name:"TYPEID",type:"esriFieldTypeInteger",editable:!0}]},t},createPointFeatureCollection:function(e){var t;return t={layerDefinition:null,featureSet:{features:[],geometryType:"esriGeometryPoint"}},t.layerDefinition={objectIdField:"OBJECTID",templates:[],type:"Feature Layer",drawingInfo:{renderer:{field1:"TYPEID",type:"simple",symbol:{height:24,xoffset:0,yoffset:12,width:24,contentType:"image/png",type:"esriPMS",url:"http://static.arcgis.com/images/Symbols/Basic/GreenStickpin.png"},description:"",value:"0",label:"Stickpin"}},displayField:"TITLE",visibilityField:"VISIBLE",name:e,hasAttachments:!1,typeIdField:"TYPEID",capabilities:"Query",types:[],geometryType:"esriGeometryPoint",fields:[{alias:"OBJECTID",name:"OBJECTID",type:"esriFieldTypeOID",editable:!1},{alias:"Title",name:"TITLE",length:50,type:"esriFieldTypeString",editable:!0},{alias:"Visible",name:"VISIBLE",type:"esriFieldTypeInteger",editable:!0},{alias:"Description",name:"DESCRIPTION",length:1073741822,type:"esriFieldTypeString",editable:!0},{alias:"Type ID",name:"TYPEID",type:"esriFieldTypeInteger",editable:!0}]},t},createFolderStore:function(e,t){var s=new S({data:{identifier:"id",label:"name",items:[]}});return s.newItem({name:t,id:""}),i.forEach(e,function(e){s.newItem({name:e.title,id:e.id})}),s},setupFoldersUI:function(e){e.folderSelect.set("store",e.folderStore),e.folderSelect.set("required",!0),e.folderSelect.set("searchAttr","name"),N.isDefined(e.folderId)?e.folderStore.get(e.folderId).then(t.hitch(this,function(t){N.isDefined(t)?e.folderSelect.set("item",t):e.folderStore.get("").then(function(t){e.folderSelect.set("item",t)},this)})):e.folderName?e.folderStore.fetch({query:{name:e.folderName},onComplete:t.hitch(this,function(t){N.isDefined(t)&&t.length>0?e.folderSelect.set("item",t[0]):e.folderStore.get("").then(function(t){e.folderSelect.set("item",t)},this)})}):e.username?e.folderSelect.set("displayedValue",e.username):e.folderStore.get("").then(function(t){e.folderSelect.set("item",t)},this)},_isEmptyObject:function(e){var t;for(t in e)if(e.hasOwnProperty(t))return!1;return!0},validateServiceName:function(e,t){var i,s,a=/(:|&|<|>|%|#|\?|\\|\"|\/|\+)/.test(e),r=!0;return N.isDefined(t)&&t.textInput&&(s=t.textInput),this.initI18n(),0===e.length||0===u.trim(e).length?(i=this.i18n.requiredValue,r=!1):a?(i=this.i18n.invalidServiceName,r=!1):e.length>98?(i=this.i18n.invalidServiceNameLength,r=!1):encodeURIComponent(e).length>170&&(i=this.i18n.invalidEncodedServiceNameLength,r=!1),s&&!r&&s.set("invalidMessage",i),r},getStepNumber:function(e){y(".esriAnalysisNumberLabel",e).forEach(function(e,t){var i=this._getNumberLabel(t);n.set(e,"innerHTML",i)},this)},_getNumberLabel:function(e){var t="";switch(this.initI18n(),e){case 0:t=this.i18n.oneLabel;break;case 1:t=this.i18n.twoLabel;break;case 2:t=this.i18n.threeLabel;break;case 3:t=this.i18n.fourLabel;break;case 4:t=this.i18n.fiveLabel;break;case 5:t=this.i18n.sixLabel;break;case 6:t=this.i18n.sevenLabel;break;case 7:t=this.i18n.eightLabel;break;case 8:t=this.i18n.nineLabel}return t},populateAnalysisLayers:function(e,t,s,a){if(e){var r=[],n=e.get(t);e._titleRow&&h.set(e._titleRow,"display","none"),e._analysisLabelRow&&h.set(e._analysisLabelRow,"display","table-row"),e._selectAnalysisRow&&(h.set(e._selectAnalysisRow,"display","table-row"),g.add(e._analysisSelect.domNode,"esriTrailingMargin3"),h.set(e._analysisSelect.domNode.parentNode,"padding-bottom","1em")),e.domNode&&this.getStepNumber(e.domNode),N.isDefined(a)&&a.chooseLabel&&r.push({value:-1,label:this.i18n.chooseLabel}),N.isDefined(a)&&N.isDefined(a.posIncrement)||(N.isDefined(a)||(a={}),a.posIncrement=0),i.forEach(e.get(s),function(e,t){t+=a.posIncrement;var i={value:N.isDefined(a)&&a.chooseLabel?t+1:t,label:e.name};n&&e.name===n.name&&(i.selected=!0),r.push(i)},this),e._analysisSelect.addOption(r),e._analysisSelect.set("required",!0)}},isValidAnalysisLayer:function(e){var t,s,a,r,n,o,l,d,c,m,y,p,h,g,f="",b=!0,T={isValid:b,validationMessage:f},v=0,w=0,E=0;return N.isDefined(e)&&N.isDefined(e.toolName)?(this.initI18n(),N.isDefined(this.i18n.cblPointMsg)||(this.i18n.cblPointMsg="You need to have at least one point feature layer to run ${toolName}."),t=e.toolName,s=e.featureLayers,a=e.analysisLayer,r=t.charAt(0).toLowerCase()+t.substring(1),l=this.i18n,y=e.showReadyToUseLayers||!1,i.forEach(s,function(e){e instanceof H&&(p=!0),p&&e.bandCount>1&&(h=!0),p&&1===e.bandCount&&(g=!0),"esriGeometryPoint"===e.geometryType&&(o=!0,v++),("esriGeometryPoint"===e.geometryType||"esriGeometryMultipoint"===e.geometryType)&&(d=!0),"esriGeometryPolyline"===e.geometryType&&(c=!0,E++),"esriGeometryPolygon"===e.geometryType&&(n=!0,w++)},this),-1!==i.indexOf(["CreateDriveTimeAreas","PlanRoutes","ConnectOriginsToDestinations"],t)&&(!o||a&&"esriGeometryPoint"!==a.geometryType)?(f=u.substitute(this.i18n.selectPointLayer,{toolName:l[r]}),b=!1):"AggregatePoints"!==t&&"InterpolatePoints"!==t||(!a||"esriGeometryPoint"===a.geometryType||"esriGeometryMultipoint"===a.geometryType)&&d?"CalculateDensity"===t&&(!d&&!c||a&&"esriGeometryPoint"!==a.geometryType&&"esriGeometryMultipoint"!==a.geometryType&&"esriGeometryPolyline"!==a.geometryType)?(f=u.substitute(this.i18n.areaFeatureInvalidMsg,{toolName:l[r]}),b=!1):"FindHotSpots"===t&&(!d&&!n||a&&"esriGeometryPoint"!==a.geometryType&&"esriGeometryMultipoint"!==a.geometryType&&"esriGeometryPolygon"!==a.geometryType)?(f=u.substitute(this.i18n.hotspotsLineFeatureMsg,{toolName:l[r]}),b=!1):"OverlayLayers"!==t&&"AggregatePoints"!==t&&"SummarizeWithin"!==t&&"SummarizeNearby"!==t&&"FindNearest"!==t&&"MergeLayers"!==t||y||0!==s.length&&(1!==s.length||s[0]!==a&&N.isDefined(a))?"ConnectOriginsToDestinations"===t&&!y&&(0===s.length||2>v)?(f=u.substitute(this.i18n.odPointMsg,{toolName:l[r]}),b=!1):"ChooseBestFacilities"!==t||0!==s.length&&0!==v?"AggregatePoints"===t&&!y&&s.length>1?(n=i.some(s,function(e){return"esriGeometryPolygon"===e.geometryType}),n||(f=u.substitute(this.i18n.aggregatePolyMsg,{toolName:l[r]}),b=!1)):"MergeLayers"===t&&!y&&s.length>1?(m=v>1||E>1||w>1,m||(f=this.i18n.mergeValidationMsg,b=!1)):"SummarizeWithin"!==t&&"DissolveBoundaries"!==t||(!a||"esriGeometryPolygon"===a.geometryType)&&n?"ExtractData"===t?(b=i.some(s,function(e){return-1!==e.capabilities.indexOf("Extract")}),b||(f=u.substitute(this.i18n.extractValidationMsg))):("ConnectOriginsToDestinations"===t||"ChooseBestFacilities"===t)&&s.length>1?(o=i.some(s,function(e){var t=N.isDefined(a)&&a.id===e.id;return"esriGeometryPoint"===e.geometryType&&!t}),o||(f=u.substitute("ChooseBestFacilities"===t?this.i18n.cblPointMsg:this.i18n.odPointMsg,{toolName:l[r]}),b=!1)):"CalculateSlope"===t||"DeriveAspect"===t||"RemapValues"===t?p?g||(b=!1,f=u.substitute(this.i18n.noSingleBandISMsg,{toolName:l[r]})):(b=!1,f=u.substitute(this.i18n.noImageServiceMsg,{toolName:l[r]})):"ExtractRaster"===t?p||(b=!1,f=u.substitute(this.i18n.noImageServiceMsg,{toolName:l[r]})):"MonitorVegetation"===t&&(p?h||(b=!1,f=u.substitute(this.i18n.noMultiBandISMsg,{toolName:l[r]})):(b=!1,f=u.substitute(this.i18n.noImageServiceMsg,{toolName:l[r]}))):(f=u.substitute(this.i18n.selectPolyLayer,{toolName:l[r]}),b=!1):(f=u.substitute(this.i18n.cblPointMsg,{toolName:l[r]}),b=!1):(f=u.substitute(this.i18n.overlayValidationMsg,{toolName:l[r]}),b=!1):(f=u.substitute(this.i18n.selectPointLayer,{toolName:l[r]}),b=!1),T={isValid:b,validationMessage:f}):T},initI18n:function(){this.i18n||(this.i18n={},t.mixin(this.i18n,c.common),t.mixin(this.i18n,c.analysisTools),t.mixin(this.i18n,c.analysisMsgCodes),t.mixin(this.i18n,c.browseLayersDlg),t.mixin(this.i18n,c.driveTimes))},addBrowseAnalysisDialog:function(e){if(e&&e.widget){this.i18n||this.initI18n();var i,s,a,r,n,o,l="esri/dijit/analysis/PluginAnalysisLayers",d="<div style='opacity:1;' class='grid-item gallery-view galleryNode'>${item:_formatItemTitle}${item:_formatThumbnail}"+'<div class="linksDiv" style=\'display:none;\'><div class="esriItemLinks"><div class="esriFloatLeading"><a style="text-decoration: none;"><span>Add layer to analysis</span><div class="dijitReset dijitInline esriArrows"></div></a></div></div></div>',c=function(e){var t=e.thumbnailUrl||this._portal.staticImagesUrl+"/desktopapp.png";return"<img class='grid-item galleryThumbnail' width='120px' height='80px' alt='' src='"+t+"'>"},m=function(e){return'<div class="galleryLabelContainer"><span alt=\''+(e.title||e.name||"<No Title>")+"'>"+(e.title.replace(/_/g," ")||e.name.replace(/_/g," ")||"<No Title>")+"</span></div>"},u="<div class='listServiceTitle'><table cellpadding='0' cellspacing='0' width='100%'><tr width='100%'><td nowrap='nowrap'>  <div  style=\"position:absolute;left:80px; top:10px; width:1px; height:1px; background: transparent;\"></div><div style='overflow:hidden;'><a style=\"height:16px;\">${item.title}</a></div></td></tr></table><table cellpadding='0' cellspacing='0' width='100%'><tr width='100%' class='bottomRowTable'><td width='20'>  <span class='esriAlignLeading'>${item:_formatThumbnail}</span></td><td nowrap='nowrap'>  <span class='esriAlignLeading' style='color:#656565;'>${item.owner}</span></td><td style='padding-right:5px;padding-left:3px;'></td></tr></table></div>",y=function(e){var t=e.iconUrl;return"<img class='grid-item-thumb' width='16px' height='16px' alt='' src='"+t+"'/>"},p=function(e){var t=e.iconUrl;return"<img class='grid-item-thumb' width='16px' height='16px' alt='' src='"+t+"'/>"},h=v.doc.createDocumentFragment(),g=f.create("div",{style:"width:100%;height:100%;"},h),b=f.create("div",{style:"width:100%;height:10%;","class":""}),T=f.create("div",{style:"width:100%"},g),w=this._isCustomAnalysisQuery(e.widget);1===e.browseType?(l="esri/dijit/analysis/PluginLayers",o={portalUrl:e.widget.get("portalUrl"),message:"",plugin:l,sortDescending:!0,sort:"title",self:e.widget.get("portalSelf"),itemsPerPage:100,demandList:!0,extent:e.widget.get("map").extent,useExtent:!1,fetchTimeout:600,galleryTemplate:u,showInfoPanel:!0,isAutoClose:!1,formatThumbnail:p,formatInfoPanelImage:y,"class":"esriAnalysisLayersItems"}):o={portalUrl:e.widget.get("portalUrl"),message:"",plugin:l,sortDescending:!0,sort:"title",self:e.widget.get("portalSelf"),pagingLinks:3,rowsPerPage:6,"class":"esriBrowseAnalysisLayers itemsGallery esriFloatLeading",extent:e.widget.get("map").extent,useExtent:!w,fetchTimeout:600,galleryTemplate:d,formatItemTitle:m,showInfoPanel:!1,showTooltip:!0,formatThumbnail:c,style:"width:48em;height:100%;clear:both;"},n=f.toDom('<div class="esriBrowseOptions">'),f.place(n,b);var E,I;I=f.create("div",{"class":"esriBrowseOption"},n),e.browseType&&1===e.browseType||(E=f.create("div",{"class":"esriBrowseOption"},n),s=new M({name:"addlayer",id:e.widget.id+(e.browseType?e.browseType:"")+"_addlayercheck","class":"",value:!1,checked:!1},f.create("input",{},E)),f.create("label",{"for":e.widget.id+"_addlayercheck","class":"esriBrowseOption_label",innerHTML:this.i18n.addLayer},E));var S=!0;return e.browseType&&1===e.browseType?S=!1:w&&(S=!1),r=new M({name:"extentcheck",id:e.widget.id+(e.browseType?e.browseType:"")+"_addextentcheck","class":"",value:S,checked:S},f.create("input",{},I)),f.create("label",{"for":e.widget.id+(e.browseType?e.browseType:"")+"_addextentcheck","class":"esriBrowseOption_label",innerHTML:this.i18n.withinMapArea},I),o.messageRight=b,i=new F(o,T),r.on("change",t.hitch(this,function(e){i.set("useExtent",e)})),a=new A({title:1===e.browseType?this.i18n.browseLayers:w?this.i18n.browseAnalysisLayers:this.i18n.browseAnalysisTitle,content:g,browseItems:i,addlayerCheckBox:s,style:e.browseType&&1===e.browseType?"":"padding:.75em 0;background-color: #fff;width:50em;"}),e.widget.own(e.widget.get("map").on("extent-change",t.hitch(e.widget,function(t){i.set("extent",e.widget.get("map").extent)})),a.on("hide",t.hitch(a,function(e){a.browseItems.reset()}))),a}},addAnalysisReadyLayer:function(e){function s(i){var s,a,n,o;"Feature Service"===r.type&&(o=new C(r.url,{outFields:["*"]}),t.mixin(r,o)),t.mixin(r,i),r.id=r.title+"_"+i.id,e.item.selectedLayer?r.title=r.title+"-"+i.name:r.title=r.title.replace(/_/g," "),r.name=r.title,r.version=r.currentVersion,n=e.layersSelect.getOptions();var l;e.widget.showBrowseLayers&&e.widget.showReadyToUseLayers?l=3:(e.widget.showBrowseLayers||e.widget.showReadyToUseLayers)&&(l=2),s=n.splice(n.length-l,l),e.layersSelect.removeOption(s),a=e.layers.length,e.posIncrement&&(a+=e.posIncrement),s.unshift({value:a,label:r.title,selected:!0}),e.layersSelect.addOption(s),e.layersSelect.set("value",a),o&&(r.lyr=o,o.name=r.name),r.linfo=i,e.layers.push(r);var d;y(".js-add-layer-checkbox",e.browseDialog.browseItems.infoPanel).forEach(function(e){d=e.checked}),(e.browseDialog.addlayerCheckBox&&e.browseDialog.addlayerCheckBox.get("checked")||d)&&(this._addLayerHandle&&this._addLayerHandle.remove(),this._addLayerHandle=e.widget.map.on("layer-add",t.hitch(this,function(t){this._addLayerHandle.remove(),e.widget.emit("add-ready-to-use-layer",{layer:t.layer,layerInfo:i,item:r})})),e.widget.map.addLayer(o)),e.browseDialog.browseItems.clear()}if(N.isDefined(e)&&N.isDefined(e.item)&&N.isDefined(e.layersSelect)&&N.isDefined(e.layers)&&N.isDefined(e.browseDialog)){e.browseDialog.hide();var a,r,n,o,l,d,c;if(a=!e.item.selectedLayer&&e.item.url?e.item.url+"/0":e.item.selectedLayer.url,-1!==window.location.protocol.indexOf("https:")&&(a=a.replace("http:","https:")),r={url:a,itemId:e.item.id,title:e.item.title,type:e.item.type,analysisReady:!0},o=i.some(e.layers,function(t,i){var s=t.analysisReady&&r.analysisReady&&t.itemId===r.itemId;return e.item.selectedLayer&&e.item.selectedLayer.url&&(s=t.itemId===r.itemId&&t.url===r.url),s&&(n=i),s}),l=new b,c="sync",o){e.posIncrement&&(n+=e.posIncrement);var m;y(".js-add-layer-checkbox",e.browseDialog.browseItems.infoPanel).forEach(function(e){m=e.checked}),(e.browseDialog.addlayerCheckBox&&e.browseDialog.addlayerCheckBox.get("checked")||m)&&(e.posIncrement||(e.posIncrement=0),d=e.layers[n-e.posIncrement],e.widget.map.getLayer(d.lyr.id)||(this._addLayerHandle&&this._addLayerHandle.remove(),this._addLayerHandle=e.widget.map.on("layer-add",t.hitch(this,function(t){this._addLayerHandle.remove(),e.widget.emit("add-ready-to-use-layer",{layer:t.layer,layerInfo:d.linfo,item:d})})),e.widget.map.addLayer(d.lyr))),e.layersSelect.set("value",n),e.browseDialog.browseItems.clear(),l.resolve()}else e.item.selectedLayer?(r.url=e.item.selectedLayer.url,l.then(t.hitch(this,s)),setTimeout(l.resolve(e.item.selectedLayer),500)):(c=e.item.itemDataUrl?x({url:e.item.itemDataUrl,content:{f:"json"}}):"sync",w(c,t.hitch(this,function(e){e&&e.layers&&e.layers[0].id&&(r.url=r.url.replace("/0","/"+e.layers[0].id)),l=x({url:r.url,content:{f:"json"}}),l.then(t.hitch(this,s))})));return l.promise}},addReadyToUseLayerOption:function(e,s){e&&(e.showReadyToUseLayers||e.showBrowseLayers)&&(s||(s=[]),e.signInPromise.then(t.hitch(this,function(){i.forEach(s,function(t){if((e.showReadyToUseLayers||e.showBrowseLayers)&&t.addOption({type:"separator",value:""}),e.showReadyToUseLayers){var i=e.i18n.browseAnalysisTitle;this._isCustomAnalysisQuery(e)&&(i=e.i18n.browseAnalysisLayers),t.addOption({value:"browse",label:i})}e.showBrowseLayers&&t.addOption({value:"browselayers",label:e.i18n.browseLayers})},this),e.showReadyToUseLayers&&!N.isDefined(e._browsedlg)&&(e._browsedlg=this.addBrowseAnalysisDialog({widget:e}),e.own(e._browsedlg.browseItems.on("select-change",t.hitch(e,e._handleBrowseItemsSelect)),e._browsedlg.on("hide",t.hitch(e,function(){i.forEach(s,function(e){"browse"===e.get("value")&&e.reset()})})))),e.showBrowseLayers&&!N.isDefined(e._browseLyrsdlg)&&(e._browseLyrsdlg=this.addBrowseAnalysisDialog({widget:e,browseType:1}),e.own(e._browseLyrsdlg.on("browseitems-close",t.hitch(this,function(t){"add-layer"===t.action&&(e._browseLyrsdlg.browseItems.plugIn._grid&&(t.selection.selectedLayer=e._browseLyrsdlg.browseItems.plugIn._selectedLayer,e._handleBrowseItemsSelect({dialog:e._browseLyrsdlg,selection:t.selection})),e._browseLyrsdlg.browseItems.closeInfoPanel())})),e._browseLyrsdlg.on("hide",t.hitch(e,function(){i.forEach(s,function(e){"browselayers"===e.get("value")&&e.reset()})}))))})))},_isCustomAnalysisQuery:function(e){var t='title:"Living Atlas Analysis Layers" AND owner:esri',i=!1;return e&&e.isSingleTenant&&(t='title:"Living Atlas Analysis Layers" AND owner:esri_livingatlas'),e.portalSelf&&e.portalSelf.analysisLayersGroupQuery&&e.portalSelf.analysisLayersGroupQuery!==t?i=!0:e._portal&&e._portal.analysisLayersGroupQuery&&e._portal.analysisLayersGroupQuery!==t&&(i=!0),i},getMaxInputByMode:function(e){var t,i=300,s=300,a=1e3,r=1.60934,n=5280,o=1760;if(e&&e.units&&e.type)return"StraightLine"===e.type?"Miles"===e.units?t=a:"Yards"===e.units?t=a*o:"Kilometers"===e.units?t=T.format(a*r,{places:2}):"Meters"===e.units?t=T.format(a*r*1e3,{places:2}):"Feet"===e.units&&(t=a*n):"DrivingDistance"===e.type||"TruckingDistance"===e.type||"WalkingDistance"===e.type?"Miles"===e.units?t=i:"Yards"===e.units?t=i*o:"Kilometers"===e.units?t=T.format(i*r,{places:2}):"Meters"===e.units?t=T.format(i*r*1e3,{places:2}):"Feet"===e.units&&(t=i*n):("DrivingTime"===e.type||"TruckingTime"===e.type||"WalkingTime"===e.type)&&("Minutes"===e.units?t=s:"Seconds"===e.units?t=60*s:"Hours"===e.units&&(t=s/60)),t},updateModeConstraints:function(e){var t;e&&e.validateWidget&&e.units&&e.type&&(t=e.validateWidget.get("constraints"),t.max=this.getMaxInputByMode(e),e.validateWidget.set(t))},getTravelModes:function(e){var s,a,n,o,l=new b;return N.isDefined(this.travelModes)&&this.travelModes.length>0?l.resolve(this.travelModes):e&&e.widget?e.widget.signInPromise.then(t.hitch(this,function(d){o=e.widget.get("helperServices"),o&&o.routingUtilities?(n=o.routingUtilities.url,s="sync"):s=e.widget._getSelf(e.widget.portalUrl),w(s,t.hitch(this,function(e){var s={};return e&&e.helperServices&&e.helperServices.routingUtilities&&(n=e.helperServices.routingUtilities.url),N.isDefined(n)?(a=new U(n+"/GetTravelModes"),void a.execute(s).then(t.hitch(this,function(e){var t=e[0].value&&e[0].value.features;this.travelModes=i.map(t,function(e){return r.fromJson(e.attributes.TravelMode)}),e[1]&&e[1].paramName&&"defaultTravelMode"===e[1].paramName&&(this.defaultTravelModeId=e[1].value),l.resolve(this.travelModes)}),t.hitch(this,function(e){l.reject(e)}))):void l.reject(new Error("Missing Routing Utility Service to get Travel Modes"))}),function(e){l.reject(e)})})):l.reject(new Error("Missing parameter: params.widget required parameter")),l.promise},populateTravelModes:function(e){if(e&&e.selectWidget&&e.widget){var s=[],a=e.allowmode||"all";this.initI18n(),e.addStraightLine&&s.push({value:"StraightLine",label:'<div class="esriFloatLeading bufferIcon esriStraightLineDistanceIcon"></div><div class="esriLeadingMargin4" style="height:20px;margin-top:10px;">'+this.i18n.straightLineDistance+"</div>"}),this.getTravelModes({widget:e.widget}).then(t.hitch(this,function(t){i.forEach(t,function(t,i){var r,n,o=t.name,l=e.separator||"",d=o.replace(/\s/g,l),c="AUTOMOBILE"===t.type?"Driving":"TRUCK"===t.type?"Trucking":"WALK"===t.type?"Walking":"Other",m=c.toLowerCase(),u=t.units||o.split(/\s/)[1],y=o,p=N.isDefined(e.enableTravelModes)&&!e.enableTravelModes;u=t.impedanceAttributeName===t.timeAttributeName?"Time":t.impedanceAttributeName===t.distanceAttributeName?"Distance":"Other",r='<div class="esriFloatLeading bufferIcon esri'+c+u+'Icon"></div><div class="esriLeadingMargin4" style="height:20px;margin-top:10px;">'+y+"</div>",n={label:r,value:d,travelMode:t,disabled:p,modei18nKey:m,units:u},("all"===a||a===u.toLowerCase())&&("all"!==a&&(n.value=n.value.replace(u,"")),e.selectDefaultMode&&this.defaultTravelModeId&&this.defaultTravelModeId===t.id&&(n.selected=!0),s.push(n))},this),e.selectWidget.removeOption(),e.selectWidget.addOption(s),e.selectWidget.set("value",e.value),e.widget.emit("travelmodes-added",{travelOptions:s})}),t.hitch(this,function(t){s&&s.length>0&&(e.selectWidget.removeOption(),e.selectWidget.addOption(s),e.selectWidget.set("value",e.value),e.widget.emit("travelmodes-added",{travelOptions:s}))}))}},updateDisplay:function(e,t,i){var s=new y.NodeList(e);s.style("display",t?i?i:"block":"none")},isGreaterThanZero:function(){var e=this.get("value");return e>0},addAttributeOptions:function(e){this.initI18n(),N.isDefined(e.allowSelectLabel)||(e.allowSelectLabel=!0);var t,s,a,r=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"];t=e.layer,s=e.selectWidget,a=t?t.fields:[],s.removeOption(s.getOptions()),e.allowSelectLabel&&s.addOption({value:"",label:this.i18n.attribute}),e.allowStringType&&r.push("esriFieldTypeString");var n=[];i.forEach(a,function(e){-1!==i.indexOf(r,e.type)&&e.name!==t.objectIdField&&n.push({value:e.name,label:N.isDefined(e.alias)&&""!==e.alias?e.alias:e.name,type:"esriFieldTypeString"===e.type?"string":"number"})},this),s.addOption(n),s.set("value","0"),s.set("disabled",!t||0===t.fields.length)},addStatisticsOptions:function(e){this.initI18n();var t=e.selectWidget,i=[{value:"SUM",label:this.i18n.sum},{value:"MIN",label:this.i18n.minimum},{value:"MAX",label:this.i18n.maximum},{value:"MEAN",label:this.i18n.average},{value:"STDDEV",label:this.i18n.standardDev}];t.removeOption(t.getOptions()),t.addOption([{value:"0",label:this.i18n.statistic}]),e.showGeoAnalyticsParams&&(t.addOption({value:"COUNT",label:this.i18n.count}),i.push({value:"VARIANCE",label:this.i18n.variance}),i.splice(4,0,{value:"RANGE",label:this.i18n.range})),e.type&&"number"!==e.type?e.type&&"string"===e.type&&t.addOption({value:"ANY",label:this.i18n.any}):t.addOption(i),t.set("value","0")},addFillOptions:function(e){var t=e.selectWidget,i=[{value:"ZEROES",label:this.i18n.zeroes},{value:"SPATIAL_NEIGHBORS",label:this.i18n.spatialneighbhors},{value:"SPACE_TIME_NEIGHBORS",label:this.i18n.spacetimeneighbors},{value:"TEMPORAL_TREND",label:this.i18n.temporaltrend}];t.removeOption(t.getOptions()),t.addOption([{value:"0",label:this.i18n.fill}]),e.type&&"number"!==e.type||t.addOption(i)},perMeter:function(e){var t=1;switch(e){case R.MILLIMETERS:t=1e3;break;case R.CENTIMETERS:t=100;break;case R.DECIMETERS:t=10;break;case R.METERS:t=1;break;case R.KILOMETERS:t=.001;break;case R.INCHES:t=39.370079;break;case R.FEET:t=3.2808399;break;case R.YARDS:t=1.0936133;break;case R.MILES:t=.00062137119;break;case R.NAUTICAL_MILES:t=.0005399568;break;case R.ACRES:t=.00024710538;break;case R.ARES:t=.01;break;case R.HECTARES:t=1e-4;break;case R.SQUARE_INCHES:t=1550.0031;break;case R.SQUARE_FEET:t=10.7639104;break;case R.SQUARE_YARDS:t=1.19599005;break;case R.SQUARE_MILES:t=3.86102159e-7;break;case R.SQUARE_NAUTICAL_MILES:t=2.9155335e-7;break;case R.SQUARE_MILLIMETERS:t=1e6;break;case R.SQUARE_CENTIMETERS:t=1e4;break;case R.SQUARE_DECIMETERS:t=100;break;case R.SQUARE_METERS:t=1;break;case R.SQUARE_KILOMETERS:t=1e-6}return t},getType:function(e){var t=null;switch(e){case R.ACRES:t=V.AREA;break;case R.ARES:t=V.AREA;break;case R.CENTIMETERS:t=V.LENGTH;break;case R.DECIMETERS:t=V.LENGTH;break;case R.FEET:t=V.LENGTH;break;case R.HECTARES:t=V.AREA;break;case R.INCHES:t=V.LENGTH;break;case R.KILOMETERS:t=V.LENGTH;break;case R.METERS:t=V.LENGTH;break;case R.MILES:t=V.LENGTH;break;case R.MILLIMETERS:t=V.LENGTH;break;case R.NAUTICAL_MILES:t=V.LENGTH;break;case R.SQUARE_CENTIMETERS:t=V.AREA;break;case R.SQUARE_DECIMETERS:t=V.AREA;break;case R.SQUARE_FEET:t=V.AREA;break;case R.SQUARE_INCHES:t=V.AREA;break;case R.SQUARE_KILOMETERS:t=V.AREA;break;case R.SQUARE_METERS:t=V.AREA;break;case R.SQUARE_MILES:t=V.AREA;break;case R.SQUARE_MILLIMETERS:t=V.AREA;break;case R.SQUARE_NAUTICAL_MILES:t=V.AREA;break;case R.SQUARE_YARDS:t=V.AREA;break;case R.YARDS:t=V.LENGTH;break;default:t=V.UNSUPPORTED}return t},unitConversion:function(e,t,i){var s=!0;N.isDefined(e)||(this.emitError("The 'From' Value must be a valid numeric value: "+e),s=!1),N.isDefined(t)||(this.emitError("The 'From' Units must be defined: "+t),s=!1),N.isDefined(i)||(this.emitError("The 'To' Units must be defined: "+i),s=!1),e instanceof Array&&(this.emitError("Only single 'From' Value supported: "+e),s=!1),t instanceof Array&&(this.emitError("Only single 'From' Units supported: "+t),s=!1),i instanceof Array&&(this.emitError("Only single 'To' Units supported: "+i),s=!1);var a=this.getType(t),r=this.getType(i);return a===V.UNSUPPORTED&&(this.emitError("Unsupported 'From' Units: "+t),s=!1),r===V.UNSUPPORTED&&(this.emitError("Unsupported 'To' Units: "+i),s=!1),a!==r&&(this.emitError("Incompatible 'From' and 'To' Units: "+t+" and "+i),s=!1),s?t===i?+e:+e/this.perMeter(t)*this.perMeter(i):Number.NaN},emitError:function(e){console.log("error",new Error(e))},isEmpty:function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return m.stringify(e)===m.stringify({})}}),o("extend-esri")&&t.setObject("dijit.analysis.utils",Q,_),Q});