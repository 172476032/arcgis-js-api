// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/has","dojo/query","../../kernel","../../request","../../arcgis/Portal","../../SpatialReference","./ProjectExtent","dojo/Deferred","dojo/i18n!./nls/BrowseLayerMixin"],function(e,t,i,s,r,a,n,o,l,u,c){var h=e([],{allowedItemTypes:["Map Service","Feature Service"],availableItemTypeFilters:["layers","featureLayers","mapImageLayers","imageryLayers","tables"],_createBrowseItems:function(e,t){if(this.useArcGISComponents)this.setUpItemBrowser(e,t).then(function(){this._chopExtentAtDateLine(this.map.extent).then(this._projectExtentAndDispatch.bind(this))}.bind(this));else{var i=this._browsedlg.browseItems.get("query");i.custom=this._queryTagsForLivingAtlasBrowseItems(e),this._browsedlg.browseItems.set("extent",this.get("map").extent),this._browsedlg.browseItems.set("query",i),this._browsedlg.show()}},setUpItemBrowser:function(e,i){var s=new u;return window.require(["arcgis-components/wrappers/ItemBrowser","esri/arcgis/Portal"],function(r,n){if(!this.ib){var o=document.createElement("div");document.body.appendChild(o);var l=new n.Portal(this.portalSelf&&this.portalSelf.urlKey&&this.portalSelf.customBaseUrl?location.protocol+"//"+this.portalSelf.urlKey+"."+this.portalSelf.customBaseUrl+"/sharing/rest":this.portalUrl+"/sharing/rest");l.signIn().then(function(){this.ib=new r.ItemBrowserWrapper(o,{apiVersion:3,portal:l,request:a,initialState:t.mixin(r.initialState,{settings:t.mixin(r.initialState.settings,{config:t.mixin(r.initialState.settings.config,{dialogTitle:this._getItemBrowserTitle(),allowedItemTypes:this.allowedItemTypes,availableItemTypeFilters:this.availableItemTypeFilters,baseSections:[],resultsPerQuery:16,layoutMode:"fullscreen",searchPlaceholderText:this._isCustomAnalysisQuery()?c.searchCustomPlaceholderText:c.searchPlaceholderText,staticFilters:this._getStaticFilters(e),onBack:function(){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),i.reset(),setTimeout(function(){document.body.removeChild(o)},300),delete this.ib}.bind(this),onSelect:function(e){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),t.hitch(this,this.onBrowseItemSelect,e[0],l)(),setTimeout(function(){document.body.removeChild(o)},300),delete this.ib}.bind(this),mainActionTitle:c.mainActionTitle,customActions:[{allowed:function(){return!0},asynchronous:!1,onAction:function(e){this.ib.dispatch({type:"CLOSE_FULLSCREEN_BROWSER"}),t.hitch(this,this.onBrowseItemSelect,e,l,!0)(),document.body.removeChild(o),delete this.ib}.bind(this),name:c.customActionName}],customSections:[{name:c.customeSectionName,baseQuery:this._getBaseQuery(e),filters:[{fetchGroupIdByQuery:this._getAnalysisGroupQuery(),name:c.Categories,type:"group",path:["categories"],staticSchema:this._getStaticSchema()}].concat(this._getFilters()),addToFront:!0}]})}),ui:t.mixin(r.initialState.ui,{expanded:t.mixin(r.initialState.ui.expanded,{filters:!0})})}),parameters:t.mixin(r.initialState.parameters,{section:c.customeSectionName,filter:t.mixin(r.initialState.parameters.filter,{searchMapArea:!0})})}),s.resolve()}.bind(this))}}.bind(this)),s},_queryTagsForLivingAtlasItemBrowser:function(e){var t=e.tags;return t&&0!==t.length?(s=[],1===t.length?"tags: ("+t[0]+")":(s=[],t.forEach(function(e){s.push(e)}),"tags: ("+s.join(" OR ")+")")):""},_queryTagsForLivingAtlasBrowseItems:function(e){var t=e.tags;if(t&&0!==t.length)return 1===t.length?['tags:"'+t[0]+'"']:(s=[],t.forEach(function(e){s.push('tags:"'+e+'"')}),s)},onBrowseItemSelect:function(e,i,s){var r={selection:new n.PortalItem(t.mixin(e,{portal:i}))};this._handleBrowseItemsSelect(r,s)},_setAllowedItemTypesAttr:function(e){this.allowedItemTypes=e},_setAvailableItemTypeFiltersAttr:function(e){this.availableItemTypeFilters=e},_getAnalysisGroupQuery:function(){return this._isCustomAnalysisQuery()||this._getDefaultQueryString()},_getDefaultQueryString:function(){var e='title:"Living Atlas Analysis Layers" AND owner:esri';return this.isSingleTenant&&(e='title:"Living Atlas Analysis Layers" AND owner:esri_livingatlas'),e},_isCustomAnalysisQuery:function(){return this.portalSelf&&this.portalSelf.analysisLayersGroupQuery&&this.portalSelf.analysisLayersGroupQuery!==this._getDefaultQueryString()?this.portalSelf.analysisLayersGroupQuery:!(!this._portal||!this._portal.analysisLayersGroupQuery||this._portal.analysisLayersGroupQuery===this._getDefaultQueryString())&&this._portal.analysisLayersGroupQuery},_getItemBrowserTitle:function(){return this._isCustomAnalysisQuery()?c.customAnalysisLayerTitle:c.defaultAnaysisLayerTitle},_getStaticSchema:function(){return this._isCustomAnalysisQuery()?void 0:[{title:"categories",categories:[{title:"boundaries and places",categories:[{title:"boundaries",categories:[],displayName:c.boundaries},{title:"places",categories:[],displayName:c.places}],displayName:c.boundariesAndPlaces},{title:"hexbins",categories:[],displayName:c.hexbins},{title:"transportation",categories:[],displayName:c.transportation}]}]},_getBaseQuery:function(e){var t=this._isCustomAnalysisQuery?['-typekeywords:"Multilayer"']:['typekeywords:"Analysis Ready"'];return this._portal&&this._portal.user.demographics||t.push('-typekeywords:"Requires Credits"'),t.push('-type:"Attachment" -tags:"mature support"'),t.push(this._queryTagsForLivingAtlasItemBrowser(e)),t.join(" ")},_getFilters:function(){return this.isSingleTenant?["itemType","modified","created","shared","status","tags"]:["tags"]},_getStaticFilters:function(e){var t=e.tags;if(t&&0!==t.length){var i=[];return t.forEach(function(e){i.push(c[e]?c[e]:e)}),i}},_projectExtentAndDispatch:function(e){this.sr||(this.sr=new o(4326)),l(e,this.sr,function(e){var t=e[0];this._dispatchExtentToItemBrowser(t)}.bind(this),function(e){console.error(e)}.bind(this))},_chopExtentAtDateLine:function(e){var t=new u;return window.esri.geometry.normalizeCentralMeridian([e],null,function(i){if(i[0].rings){var s=new window.esri.geometry.Polygon(e.spatialReference).addRing(i[0].rings[0]).getExtent(),r=new window.esri.geometry.Polygon(e.spatialReference).addRing(i[0].rings[1]).getExtent();t.resolve(s.getWidth()>r.getWidth()?s:r)}else t.resolve(i[0])},function(e){t.reject(e)}),t},_dispatchExtentToItemBrowser:function(e){window.require(["arcgis-components/wrappers/ItemBrowser"],function(t){this.ib.dispatch(t.updateExtent({minx:e.xmin,miny:e.ymin,maxx:e.xmax,maxy:e.ymax}))}.bind(this))}});return i("extend-esri")&&t.setObject("dijit.analysis.BrowseLayerMixin",h,r),h});