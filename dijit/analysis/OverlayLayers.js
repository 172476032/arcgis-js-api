// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/_base/fx","dojo/has","dojo/json","dojo/string","dojo/dom-style","dojo/dom-attr","dojo/dom-construct","dojo/query","dojo/dom-class","dojo/fx/easing","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_OnDijitClickMixin","dijit/_FocusMixin","dijit/registry","dijit/form/Button","dijit/form/CheckBox","dijit/form/Form","dijit/form/Select","dijit/form/TextBox","dijit/form/ValidationTextBox","dijit/layout/ContentPane","dijit/form/FilteringSelect","../../kernel","./AnalysisBase","./_AnalysisOptions","./CreditEstimator","./AnalysisToggleButton","./GroupToggleButton","./utils","dojo/i18n!../../nls/jsapi","dojo/text!./templates/OverlayLayers.html"],function(e,t,s,i,r,a,n,o,l,y,h,u,p,c,d,_,m,v,g,L,T,b,f,S,w,C,I,B,P,O,k,F,G,j,A,x,M,N,E){var D=t([m,v,g,L,T,G,F],{declaredClass:"esri.dijit.analysis.OverlayLayers",templateString:E,widgetsInTemplate:!0,inputLayer:null,overlayLayer:null,overlayType:"intersect",tolerance:0,snapToInput:!1,outputLayerName:null,outputType:"Input",i18n:null,toolName:"OverlayLayers",helpFileName:"OverlayLayers",resultParameter:"Outputlayer",constructor:function(e,t){this._pbConnects=[],e.containerNode&&(this.container=e.containerNode)},destroy:function(){this.inherited(arguments),i.forEach(this._pbConnects,r.disconnect),delete this._pbConnects},postMixInProperties:function(){this.inherited(arguments),s.mixin(this.i18n,N.overlayLayersTool)},postCreate:function(){this.inherited(arguments),d.add(this._form.domNode,"esriSimpleForm"),this._outputLayerInput.set("validator",s.hitch(this,this.validateServiceName)),this._buildUI()},startup:function(){},_onClose:function(e){e&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:e})},_handleSaveBtnClick:function(e){if(this._form.validate()){this._saveBtn.set("disabled",!0);var t,s={},i={};if(s.InputLayer=a.toJson(this.constructAnalysisInputLyrObj(this.inputLayer)),"0"!==this._overlayFeaturesSelect.get("value")){var r=this.overlayLayer[this._overlayFeaturesSelect.get("value")-1];s.OverlayLayer=a.toJson(this.constructAnalysisInputLyrObj(r))}s.OverlayType=this.get("overlayType"),this.returnFeatureCollection||(s.OutputName=a.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}})),s.Tolerance=this.tolerance,s.SnapToInput=this.snapToInput,"intersect"===this.get("OverlayType")&&(s.outputType=this._outputTypeSelect.get("value")),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(s.context=a.toJson({extent:this.map.extent._normalize(!0)})),this.returnFeatureCollection&&(t={outSR:this.map.spatialReference},this.showChooseExtent&&this._useExtentCheck.get("checked")&&(t.extent=this.map.extent._normalize(!0)),s.context=a.toJson(t)),i.jobParams=s,i.itemParams={description:this.i18n.itemDescription,tags:y.substitute(this.i18n.itemTags,{layername:this.inputLayer.name}),snippet:this.i18n.itemSnippet},this.showSelectFolder&&(i.itemParams.folder=this.get("folderId")),this.execute(i)}},_handleShowCreditsClick:function(e){e.preventDefault();var t={};if(this._form.validate()){if(t.InputLayer=a.toJson(this.constructAnalysisInputLyrObj(this.inputLayer)),"0"!==this._overlayFeaturesSelect.get("value")){var i=this.overlayLayer[this._overlayFeaturesSelect.get("value")-1];t.OverlayLayer=a.toJson(this.constructAnalysisInputLyrObj(i))}t.OverlayType=this.get("overlayType"),this.returnFeatureCollection||(t.OutputName=a.toJson({serviceProperties:{name:this._outputLayerInput.get("value")}})),t.Tolerance=this.tolerance,t.SnapToInput=this.snapToInput,"intersect"===this.get("OverlayType")&&(t.outputType=this._outputTypeSelect.get("value")),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(t.context=a.toJson({extent:this.map.extent._normalize(!0)})),this.getCreditsEstimate(this.toolName,t).then(s.hitch(this,function(e){this._usageForm.set("content",e),this._usageDialog.show()}))}},_save:function(){},_sortbyGeometryType:function(e,t){return"esriGeometryPolygon"===e.geometryType?-1:"esriGeometryPolygon"===t.geometryType?1:"esriGeometryPolyline"===e.geometryType?-1:"esriGeometryPolyline"===t.geometryType?1:"esriGeometryPoint"===e.geometryType?-1:"esriGeometryPoint"===t.geometryType?1:void 0},_buildUI:function(){var e=!0;this.signInPromise.then(s.hitch(this,M.initHelpLinks,this.domNode,this.showHelp,{analysisGpServer:this.analysisGpServer})),this.get("showSelectAnalysisLayer")&&(!this.get("inputLayer")&&this.get("inputLayers")&&this.set("inputLayer",this.inputLayers[0]),M.populateAnalysisLayers(this,"inputLayer","inputLayers")),this.outputLayerName&&(this._outputLayerInput.set("value",this.outputLayerName),e=!1),this.inputLayer&&this._updateAnalysisLayerUI(e),M.addReadyToUseLayerOption(this,[this._analysisSelect,this._overlayFeaturesSelect]),h.set(this._chooseFolderRow,"display",this.showSelectFolder===!0?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(s.hitch(this,function(e){this.folderStore=e,M.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})),h.set(this._chooseExtentDiv,"display",this.showChooseExtent===!0?"inline-block":"none"),h.set(this._showCreditsLink,"display",this.showCredits===!0?"block":"none"),this._loadConnections()},_updateAnalysisLayerUI:function(e){if(this.inputLayer&&u.set(this._overlaylayersToolDescription,"innerHTML",y.substitute(this.i18n.overlayDefine,{layername:this.inputLayer.name})),this.overlayLayer){this.overlayLayer.sort(s.hitch(this,this._sortbyGeometryType));var t=i.some(this._overlayFeaturesSelect.getOptions(),function(e){return"browse"===e.value},this),r=i.some(this._overlayFeaturesSelect.getOptions(),function(e){return"browselayers"===e.value},this),a=[],n=this._overlayFeaturesSelect.get("value");this._overlayFeaturesSelect.removeOption(this._overlayFeaturesSelect.getOptions()),i.forEach(this.overlayLayer,function(e,t){var s=!0;e.url&&this.inputLayer.url&&e.url!==this.inputLayer.url?s=!1:this.inputLayer===e||e.analysisReady&&this.inputLayer.analysisReady||(s=!1),s||"esriGeometryPolygon"!==e.geometryType&&"esriGeometryPoint"!==e.geometryType&&"esriGeometryPolyline"!==e.geometryType||a.push({value:t+1,label:e.name})},this),(this.get("showReadyToUseLayers")||this.get("showBrowseLayers")||t||r)&&a.push({type:"separator",value:""}),this.get("showReadyToUseLayers")&&t&&a.push({value:"browse",label:this.i18n.browseAnalysisTitle}),this.get("showBrowseLayers")&&r&&a.push({value:"browselayers",label:this.i18n.browseLayers}),this._overlayFeaturesSelect.addOption(a),this._overlayFeaturesSelect.set("value",n)}this.overlayType&&("intersect"===this.overlayType?(this._intersectBtn.set("checked",!0),this._handleIntersectBtnClick()):"union"===this.overlayType?(this._unionBtn.set("checked",!0),this._handleUnionBtnClick()):"erase"===this.overlayType&&(this._eraseBtn.set("checked",!0),this._handleEraseBtnClick())),this.outputType&&this._outputTypeSelect.set("value",this.outputType)},_handleAnalysisLayerChange:function(e){"browse"===e?(this._isAnalysisSelect=!0,this._browsedlg.show()):"browselayers"===e?(this.showGeoAnalyticsParams&&(c=this._browseLyrsdlg.browseItems.get("query"),c.types.push('type:"Big Data File Share"'),this._browseLyrsdlg.browseItems.set("query",c)),this._isAnalysisSelect=!0,this._browseLyrsdlg.show()):(this.inputLayer=this.inputLayers[e],this._updateAnalysisLayerUI(!0))},_handleBrowseItemsSelect:function(e){e&&e.selection&&M.addAnalysisReadyLayer({item:e.selection,layers:this._isAnalysisSelect?this.inputLayers:this.overlayLayer,layersSelect:this._isAnalysisSelect?this._analysisSelect:this._overlayFeaturesSelect,browseDialog:e.dialog||this._browsedlg,posIncrement:this._isAnalysisSelect?0:1,widget:this}).always(s.hitch(this,function(e){if(this._isAnalysisSelect&&(this.inputLayer=this.inputLayers[this._analysisSelect.get("value")],this.inputLayer)){var t=i.some(this.overlayLayer,function(e){return e&&e.analysisReady&&this.inputLayer.analysisReady&&e.itemId===this.inputLayer.itemId},this);t||this.overlayLayer.push(this.inputLayer)}this._isAnalysisSelect&&this._handleAnalysisLayerChange(this._analysisSelect.get("value"))}))},_loadConnections:function(){this.on("start",s.hitch(this,"_onClose",!0)),this._connect(this._closeBtn,"onclick",s.hitch(this,"_onClose",!1))},_handleLayerChange:function(e){var t,s,i,r;"browse"===e?(this._analysisquery||(this._analysisquery=this._browsedlg.browseItems.get("query")),this._browsedlg.browseItems.set("query",this._analysisquery),this._isAnalysisSelect=!1,this._browsedlg.show()):"browselayers"===e?(this.showGeoAnalyticsParams&&(c=this._browseLyrsdlg.browseItems.get("query"),c.types.push('type:"Big Data File Share"'),this._browseLyrsdlg.browseItems.set("query",c)),this._isAnalysisSelect=!1,this._browseLyrsdlg.show()):(t=this.overlayLayer[e-1],s=!1,r=this.get("overlayType"),t&&this.inputLayer&&(i="esriGeometryPolygon"!==this.inputLayer.geometryType||"esriGeometryPolygon"!==t.geometryType,this._unionBtn.set("disabled",i),this._unionBtn.set("iconClass",i?"unionLayersDisabledIcon":"unionLayersIcon"),"esriGeometryPolygon"===this.inputLayer.geometryType?s="esriGeometryPolygon"===this.inputLayer.geometryType&&"esriGeometryPolygon"!==t.geometryType:"esriGeometryPolyline"===this.inputLayer.geometryType?s="esriGeometryPolyline"===this.inputLayer.geometryType&&"esriGeometryPoint"===t.geometryType:"esriGeometryPolyline"===this.inputLayer.geometryType&&(s=!0),this._eraseBtn.set("disabled",s),this._eraseBtn.set("iconClass",s?"eraseLayersDisabledIcon":"eraseLayersIcon"),"union"!==r||"esriGeometryPolygon"===this.inputLayer.geometryType&&"esriGeometryPolygon"===t.geometryType?"erase"===r&&"esriGeometryPolyline"===this.inputLayer.geometryType&&"esriGeometryPoint"===t.geometryType?(this._showMessages(this.i18n.notSupportedEraseOverlayMsg),this._intersectBtn.set("checked",!0),this._handleIntersectBtnCtrClick()):"erase"===r&&"esriGeometryPolygon"===this.inputLayer.geometryType&&"esriGeometryPolygon"!==t.geometryType?(this._showMessages(this.i18n.notSupportedEraseOverlayMsg),this._intersectBtn.set("checked",!0),this._handleIntersectBtnCtrClick()):"intersect"===r?this._handleIntersectBtnCtrClick():"union"===r?this._handleUnionBtnCtrClick():"erase"===r&&this._handleEraseBtnClick():(this._showMessages(this.i18n.overlayLayerPolyMsg),this._intersectBtn.set("checked",!0),this._handleIntersectBtnCtrClick())))},_showMessages:function(e){u.set(this._bodyNode,"innerHTML",e),n.fadeIn({node:this._errorMessagePane,easing:_.quadIn,onEnd:s.hitch(this,function(){h.set(this._errorMessagePane,{display:""})})}).play(),window.setTimeout(s.hitch(this,this._handleCloseMsg),3e3)},_handleCloseMsg:function(e){e&&e.preventDefault(),n.fadeOut({node:this._errorMessagePane,easing:_.quadOut,onEnd:s.hitch(this,function(){h.set(this._errorMessagePane,{display:"none"})})}).play()},_updateOutputType:function(){var e,t;"0"!==this._overlayFeaturesSelect.get("value")&&(e=this.overlayLayer[this._overlayFeaturesSelect.get("value")-1]),t="esriGeometryPoint"===this.inputLayer.geometryType||"esriGeometryMultipoint"===this.inputLayer.geometryType||"esriGeometryPoint"===e.geometryType||"esriGeometryMultipoint"===e.geometryType,h.set(this._outputTypeTable,"display","table"),this._outputTypeSelect.removeOption(this._outputTypeSelect.getOptions()),this._outputTypeSelect.set("disabled",t),t?d.add(this._outputTypeLabel,"esriAnalysisTextDisabled"):d.remove(this._outputTypeLabel,"esriAnalysisTextDisabled"),t?this._outputTypeSelect.addOption({value:"Input",label:this.i18n.points}):"esriGeometryPolyline"===this.inputLayer.geometryType&&"esriGeometryPolyline"===e.geometryType?this._outputTypeSelect.addOption([{value:"Point",label:this.i18n.points,selected:!0},{value:"Input",label:this.i18n.lines}]):"esriGeometryPolygon"===this.inputLayer.geometryType&&"esriGeometryPolygon"===e.geometryType?this._outputTypeSelect.addOption([{value:"Point",label:this.i18n.points},{value:"Line",label:this.i18n.lines},{value:"Input",label:this.i18n.areas,selected:!0}]):"esriGeometryPolyline"===this.inputLayer.geometryType&&"esriGeometryPolygon"===e.geometryType?this._outputTypeSelect.addOption([{value:"Point",label:this.i18n.points,selected:!0},{value:"Input",label:this.i18n.lines}]):"esriGeometryPolygon"===this.inputLayer.geometryType&&"esriGeometryPolyline"===e.geometryType&&this._outputTypeSelect.addOption([{value:"Point",label:this.i18n.points,selected:!0},{value:"Input",label:this.i18n.lines}])},_handleUnionBtnCtrClick:function(){this._unionBtnCtr.set("checked",!0),this._unionBtn.set("checked",!0),h.set(this._outputTypeTable,"display","none"),this._outputTypeSelect.set("disabled",!0),d.add(this._outputTypeLabel,"esriAnalysisTextDisabled"),this._handleUnionBtnClick()},_handleIntersectBtnCtrClick:function(){var e;this._intersectBtnCtr.set("checked",!0),this._intersectBtn.set("checked",!0),e=this.overlayLayer[this._overlayFeaturesSelect.get("value")-1],this._handleIntersectBtnClick(),this._updateOutputType()},_handleEraseBtnCtrClick:function(){this._eraseBtnCtr.set("checked",!0),this._eraseBtn.set("checked",!0),h.set(this._outputTypeTable,"display","none"),this._outputTypeSelect.set("disabled",!0),d.add(this._outputTypeLabel,"esriAnalysisTextDisabled"),this._handleEraseBtnClick()},_handleUnionBtnClick:function(e){if("browse"!==this._overlayFeaturesSelect.get("value")&&"browselayers"!==this._overlayFeaturesSelect.get("value")&&""!==this._overlayFeaturesSelect.get("value")&&this.inputLayer){var t=this.overlayLayer[this._overlayFeaturesSelect.get("value")-1].name;this._outputLayerInput.set("value",y.substitute(this.i18n.unionOutputLyrName,{layername:this.inputLayer.name,overlayname:t})),this._unionBtn.focus(),this.set("OverlayType","union")}},_handleEraseBtnClick:function(e){if("browse"!==this._overlayFeaturesSelect.get("value")&&"browselayers"!==this._overlayFeaturesSelect.get("value")&&""!==this._overlayFeaturesSelect.get("value")&&this.inputLayer){var t=this.overlayLayer[this._overlayFeaturesSelect.get("value")-1].name;this._eraseBtn.focus(),this._outputLayerInput.set("value",y.substitute(this.i18n.eraseOutputLyrName,{layername:this.inputLayer.name,overlayname:t})),this.set("OverlayType","erase")}},_handleIntersectBtnClick:function(e){if("browse"!==this._overlayFeaturesSelect.get("value")&&"browselayers"!==this._overlayFeaturesSelect.get("value")&&""!==this._overlayFeaturesSelect.get("value")&&this.inputLayer){var t=this.overlayLayer[this._overlayFeaturesSelect.get("value")-1].name;this._intersectBtn.focus(),this._outputLayerInput.set("value",y.substitute(this.i18n.intersectOutputLyrName,{layername:this.inputLayer.name,overlayname:t})),this.set("OverlayType","intersect")}},_setAnalysisGpServerAttr:function(e){e&&(this.analysisGpServer=e,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName))},_setInputLayerAttr:function(e){this.inputLayer=e},_setInputLayersAttr:function(e){this.inputLayers=e},_setOverlayLayerAttr:function(e){this.overlayLayer=e},_setOverlayTypeAttr:function(e){this.overlayType=e},_getOverlayTypeAttr:function(){return this.overlayType},_setDisableRunAnalysisAttr:function(e){this._saveBtn.set("disabled",e)},_setOutputTypeAttr:function(e){this.outputType=e},_getOutputTypeAttr:function(){return this.outputType},validateServiceName:function(e){return M.validateServiceName(e,{textInput:this._outputLayerInput})},_connect:function(e,t,s){this._pbConnects.push(r.connect(e,t,s))}});return o("extend-esri")&&s.setObject("dijit.analysis.OverlayLayers",D,k),D});