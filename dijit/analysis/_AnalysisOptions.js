// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/has","dojo/_base/window","dojo/on","dojo/query","./Settings","./SettingsViewModel","./utils","dijit/Dialog","dojo/i18n!../../nls/jsapi","../../lang","../../kernel"],function(t,s,e,i,n,o,a,h,r,l,c,d,u,g,w,y,f){var S=t([],{declaredClass:"esri.dijit.analysis._AnalysisOptions",showSelectFolder:!1,showChooseExtent:!0,showHelp:!0,showCredits:!0,returnFeatureCollection:!1,showCloseIcon:!0,showSelectAnalysisLayer:!0,map:null,showReadyToUseLayers:!0,showAnalysisBusyIndicator:!0,showGeoAnalyticsParams:!1,showBrowseLayers:!1,showAnalysisModeLabel:!1,distanceDefaultUnits:"Miles",showSettings:!1,showOutputType:!1,context:{},constructor:function(t){},_setShowSelectFolderAttr:function(t){t===!0&&t===this.get("returnFeatureCollection")&&(t=!t),this.showSelectFolder=t,this._webMapFolderSelect&&this._webMapFolderSelect.set("required",t)},_getShowSelectFolderAttr:function(){return this.showSelectFolder},_setShowChooseExtentAttr:function(t){this.showChooseExtent=t},_getShowChooseExtentAttr:function(){return this.showChooseExtent},_setMapAttr:function(t){this.map=t},_getMapAttr:function(){return this.map},_setShowHelpAttr:function(t){this.showHelp=t},_getShowHelpAttr:function(){return this.showHelp},_setReturnFeatureCollectionAttr:function(t){this.returnFeatureCollection=t,t&&this.set("showSelectFolder",!t)},_getReturnFeatureCollectionAttr:function(){return this.returnFeatureCollection},_setShowCreditsAttr:function(t){this.showCredits=t},_getShowCreditsAttr:function(){return this.showCredits},_setShowCloseIconAttr:function(t){this.showCloseIcon=t},_getShowCloseIconAttr:function(){return this.showCloseIcon},_setShowSelectAnalysisLayerAttr:function(t){this.showSelectAnalysisLayer=t,this._analysisSelect&&this._analysisSelect.set("required",t)},_getShowSelectAnalysisLayerAttr:function(){return this.showSelectAnalysisLayer},_setIsSingleTenantAttr:function(t){this.isSingleTenant=t},_getIsSingleTenantAttr:function(){return this.isSingleTenant},_setAllowChooseLabelAttr:function(t){this.allowChooseLabel=t},_getAllowChooseLabelAttr:function(){return this.allowChooseLabel},_setTitleAttr:function(t){this.title=t,this._toolTitle&&e.set(this._toolTitle,"innerHTML",t)},_getTitleAttr:function(){return this.title=e.get(this._toolTitle,"innerHTML"),this.title},_setShowReadyToUseLayersAttr:function(t){this.showReadyToUseLayers=t},_getShowReadyToUseLayersAttr:function(t){return this.showReadyToUseLayers},_setFolderIdAttr:function(t){this.folderId=t},_getFolderIdAttr:function(){return this._webMapFolderSelect&&this.folderStore&&(this.folderId=this._webMapFolderSelect.item?this.folderStore.getValue(this._webMapFolderSelect.item,"id"):""),this.folderId},_setFolderNameAttr:function(t){this.folderName=t},_getFolderNameAttr:function(){return this._webMapFolderSelect&&this.folderStore&&this._webMapFolderSelect.item&&(this.folderName=this.folderStore.getValue(this._webMapFolderSelect.item,"name")),this.folderName},_setHelperServicesAttr:function(t){this.helperServices=t},_getHelperServicesAttr:function(t){return this.helperServices},_getPortalSelfAttr:function(){return this.portalSelf},_setPortalSelfAttr:function(t){this.portalSelf=t},_setShowAnalysisBusyIndicatorAttr:function(t){t&&this.own(this.on("start",s.hitch(this,function(){this.showLoadingIndicator()})),this.on("job-fail, job-result, job-cancel",s.hitch(this,function(){this.hideLoadingIndicator()})))},_setShowGeoAnalyticsParamsAttr:function(t){this.showGeoAnalyticsParams=t},_getShowGeoAnalyticsParamsAttr:function(){return this.showGeoAnalyticsParams},_setShowBrowseLayersAttr:function(t){this.showBrowseLayers=t},_getShowBrowseLayersAttr:function(){return this.showBrowseLayers},showLoadingIndicator:function(){this.get("showAnalysisBusyIndicator")&&(this._saveBtn.set("iconClass","esriLoading"),this.set("disableRunAnalysis",!0))},hideLoadingIndicator:function(){this.get("showAnalysisBusyIndicator")&&(this._saveBtn.set("iconClass",""),this.set("disableRunAnalysis",!1))},_setDistanceDefaultUnitsAttr:function(t){this.distanceDefaultUnits=t},_getDistanceDefaultUnitsAttr:function(){return this.distanceDefaultUnits},_setAnalysisModeAttr:function(t){this.analysiMode=t},_setShowAnalysisModeLabelAttr:function(t){this.showAnalysisModeLabel=t,this._titleLbl&&this._analysisModeLblNode&&(o.set(this._titleLbl,"display",this.showAnalysisModeLabel?"none":"block"),o.set(this._analysisModeLblNode,"display",this.showAnalysisModeLabel?"flex":"none"),this.showAnalysisModeLabel&&("standard"===this.analysiMode?this.analysisModeLabel=this.i18n.standard:"bigdata"===this.analysiMode||this.showGeoAnalyticsParams?this.analysisModeLabel=this.i18n.bigData:"raster"===this.analysisMode&&(this.analysisModeLabel=this.i18n.raster),e.set(this._analysisModeCrumb,"innerHTML",this.analysisModeLabel)))},_getTimeReferenceAttr:function(){if(this._timeRefDay){var t,s,e,i,n="",o="";t=this._timeRefDay.get("value"),s=this._timeRefTime.get("value"),t&&(n=t.toDateString()),s&&(o=s.toTimeString()),e=o&&-1!==o.indexOf("GMT")?n+" "+o.substring(0,o.indexOf("GMT")+"GMT".length):o?n+" "+o.split(" ")[0]+" GMT":n+" GMT",i=new Date(e),this.timeReference=i.getTime()}return this.timeReference},_setSLayersAttr:function(t){this.sLayers=t},_setContextAttr:function(t){this.context=t},_setShowSettingsAttr:function(t){if(this.showSettings=t,t){if(!u.settingsDlg){var e=h.doc.createDocumentFragment(),i=n.create("div",{style:"width:200px;height:200px;"},e);u.settingsVM=new d({showHelp:!0,showCloseIcon:!1,showOverwriteResultOption:!1,showCloseAnalysisOption:!1,showStoreAnalysisOption:!1,showCoordinateSystems:this.analysisMode&&("raster"===this.analysisMode||"bigdata"===this.analysisMode),showProcessSR:this.analysisMode&&"bigdata"===this.analysisMode,showOutSR:this.analysisMode&&"raster"===this.analysisMode,showExtent:!0,showRasterSettings:this.analysisMode&&"raster"===this.analysisMode,showHeader:!1,layers:this.sLayers}),u.settings=new c({viewModel:u.settingsVM},i),this.i18n||(this.i18n={},s.mixin(this.i18n,w.common),s.mixin(this.i18n,w.analysisTools),s.mixin(this.i18n,w.analysisMsgCodes),s.mixin(this.i18n,w.analysisSettings)),u.settingsDlg=new g({title:this.i18n.analysisEnv,content:u.settings,style:"width:400px;"}),u.own(u.settings.on("ok-settings",s.hitch(this,function(){u.settingsDlg.hide()})),u.settings.on("cancel-settings",s.hitch(this,function(){u.settingsDlg.hide()})))}if(u.settingsDlg&&(u.settingsVM.set("showRasterSettings",this.analysisMode&&"raster"===this.analysisMode),u.settingsVM.set("showCoordinateSystems",this.analysisMode&&("raster"===this.analysisMode||"bigdata"===this.analysisMode)),u.settingsVM.set("showProcessSR",this.analysisMode&&"bigdata"===this.analysisMode),u.settingsVM.set("showOutSR",this.analysisMode&&"raster"===this.analysisMode),this.domNode&&l("[esriHelpTopic='toolDescription']",this.domNode).forEach(s.hitch(this,function(t){t&&(this._settingsLink=n.create("a",{href:"#","class":"esriAnalysisSettingsIcon"},t,"before"),r(this._settingsLink,"click",s.hitch(this,this._handleSettingsLinkClick)))})),!this._settingWatchers)){this._settingWatchers=!0;var o=this.get("context");u.settingsVM.extent&&(o.extent=u.settingsVM.extent,this._useExtentCheck&&this._useExtentCheck.set("checked",!1)),u.settingsVM.outSR&&(o.outSR=u.settingsVM.outSR),u.settingsVM.processSR&&(o.processSR=u.settingsVM.processSR),u.settingsVM.extent&&(o.extent=u.settingsVM.extent,this._useExtentCheck&&this._useExtentCheck.set("checked",!1)),u.settingsVM.cellSize&&(o.cellSize=u.settingsVM.cellSize),u.settingsVM.mask&&(o.mask=u.settingsVM.mask),u.settingsVM.snapRaster&&(o.snapRaster=u.settingsVM.snapRaster),this.set("context",o),u.settingsVM.watch("outSR",s.hitch(this,function(t,s,e){var i=this.get("context");i.outSR=e,this.set("context",i)})),u.settingsVM.watch("processSR",s.hitch(this,function(t,s,e){var i=this.get("context");i.processSR=e,this.set("context",i)})),u.settingsVM.watch("extent",s.hitch(this,function(t,s,e){var i=this.get("context");i.extent=e,this.set("context",i),this._useExtentCheck&&this._useExtentCheck.set("checked",!y.isDefined(e))})),u.settingsVM.watch("cellSize",s.hitch(this,function(t,s,e){var i=this.get("context");i.cellSize=e,this.set("context",i)})),u.settingsVM.watch("mask",s.hitch(this,function(t,s,e){var i=this.get("context");i.mask=e,this.set("context",i)})),u.settingsVM.watch("snapRaster",s.hitch(this,function(t,s,e){var i=this.get("context");i.snapRaster=e,this.set("context",i)}))}}},_setShowOutputTypeAttr:function(t){this.showOutputType=t},_handleSettingsLinkClick:function(){u.settingsDlg.show()},_handleModeCrumbClick:function(t){t.preventDefault(),this._onClose(!1)},_onFocus:function(){this.map&&"function"==typeof this.map.disableKeyboardNavigation&&this.map.disableKeyboardNavigation(),this.emit("focus"),this.inherited(arguments)},_onBlur:function(){this.map&&"function"==typeof this.map.enableKeyboardNavigation&&this.map.enableKeyboardNavigation(),this.emit("blur"),this.inherited(arguments)},constructAnalysisInputLyrObj:function(t,s){return s=y.isDefined(s)?s:this.isSingleTenant&&"ExtractData"!==this.toolName,u.constructAnalysisInputLyrObj(t,s,!this.showGeoAnalyticsParams)}});return a("extend-esri")&&s.setObject("dijit.analysis._AnalysisOptions",S,f),S});