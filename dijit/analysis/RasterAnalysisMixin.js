// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.25/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/Deferred","dojo/_base/lang","dojo/_base/array","dojo/_base/connect","dojo/_base/json","dojo/store/Memory","dojo/promise/all","dojo/when","dojo/string","dojo/has","dojo/dom-class","dojo/dom-style","dojo/dom-attr","../../kernel","../../lang","../../request","../../symbols/SimpleFillSymbol","../../Color","../../renderers/ClassBreaksRenderer","../../tasks/AlgorithmicColorRamp","../../tasks/MultipartColorRamp","../RasterFunctionEditor/utils","./AnalysisBase","./_AnalysisOptions","./utils","../../layers/RasterFunction"],function(t,e,s,i,a,n,r,o,u,h,l,c,p,y,m,d,f,_,g,L,v,b,R,w,N,S,A){var I=t([N,w],{declaredClass:"esri.dijit.analysis.RasterAnalysisMixin",map:null,outputLayerName:null,resultParameter:"outputRaster",rasterGPToolName:"GenerateRaster",analysisType:"raster",i18n:null,returnProcessInfo:null,unsupportedServiceNameCharacters:/[\s~`!#$%\^&*+=\-\[\]\\';,\/{}|\\":<>\?\.]/g,_geometryService:null,_findDeepestArgsForRerun:!1,constructor:function(t,e){this._pbConnects=[],t.containerNode&&(this.container=t.containerNode)},destroy:function(){this.inherited(arguments),i.forEach(this._pbConnects,a.disconnect),delete this._pbConnects},postMixInProperties:function(){this.inherited(arguments),s.mixin(this.i18n,this.toolNlsName)},postCreate:function(){this.inherited(arguments),c.add(this._form.domNode,"esriSimpleForm"),this._outputLayerInput.set("validator",s.hitch(this,this.validateServiceName)),this._buildUI()},startup:function(){},validateServiceName:function(t){return S.validateServiceName(t,{textInput:this._outputLayerInput})},_getJobParameters:function(){},_getRasterFunction:function(){},_getRasterArguments:function(){},_getRasterObject:function(t){var e=t||this.get("inputLayer");return R.getRasterJsonFromLayer(e)},_getOutputRasterLayerName:function(){},_getOutputItemProperties:function(){},_setDefaultInputs:function(){},_resetUI:function(){},_getDefaultOutputItemProperties:function(t,e,s){var i=this._getDefaultRenderingRule(e),a=this._getDefaultRenderer(),n=this._getDefaultPopupInfo(),r=t||1,o=s||"RSP_NearestNeighbor",u={visibility:!0,opacity:r,interpolation:o,popupInfo:n};return i&&(u.renderingRule=i),a&&(u.layerDefinition={},u.layerDefinition.drawingInfo={},u.layerDefinition.drawingInfo.renderer=a.toJson()),u},_getDefaultRenderingRule:function(t){var e=new A;e.functionName="Stretch";var s={};s.StretchType=5,s.DRA=!1,s.Gamma=[1],s.UseGamma=!0,e.functionArguments=s,e.outputPixelType="U8";var i=new A;return i.functionName="Colormap",i.functionArguments={colorRamp:t||"Aspect",Raster:e},i},_getDefaultRenderer:function(){if(this.colorValues&&this.colorValues.length&&this.classMaxValues&&this.classMaxValues.length&&this.labels&&this.labels.length){var t=this.colorValues.length;if(t===this.classMaxValues.length&&t===this.labels.length){var e,s,i,a,n=new L({field:"Value",showInAscendingOrder:!0,classificationMethod:"natural-breaks"}),r=new b;for(r.colorRamps=[],i=0;i<t;i++)a=this.colorValues[i],e&&(s=new v,s.algorithm="hsv",s.fromColor=new g(e),s.toColor=new g(a),r.colorRamps.push(s)),e=a;r&&(n.authoringInfo={},n.authoringInfo.colorRamp=r.toJson());var o,u,h=[],l=-1;for(i=0;i<t;i++)u=this.colorValues[i],o=new _("solid",null,new g({r:u[0],g:u[1],b:u[2],a:u[3]})),h.push({minValue:l,maxValue:this.classMaxValues[i],label:this.labels[i],symbol:o}),l=this.classMaxValues[i];return n.infos=h,n.attributeField="Value",n}}},_getDefaultPopupInfo:function(){return{title:this.get("outputLayerName"),description:null,fieldInfos:[{fieldName:"Raster.ServicePixelValue",label:"Service Pixel Value",isEditable:!1,isEditableOnLayer:!1,visible:!1,format:{places:2,digitSeparator:!0}},{fieldName:"Raster.ServicePixelValue.Raw",label:"Pixel Value",isEditable:!1,isEditableOnLayer:!1,visible:!0,format:{places:2,digitSeparator:!0}}],showAttachments:!1,layerOptions:{showNoDataRecords:!0,returnTopmostRaster:!0},mediaInfos:[]}},_getReRunRFxArgs:function(t,e){var s={};return this._findFunction(t,e,s),s&&s.rasterFunctionArguments},_findFunction:function(t,e,s){var i=t&&t.rasterFunction,a=this._getRasterFunction();i&&s&&"object"==typeof s&&(i!==a||(s.rasterFunction=t.rasterFunction,s.rasterFunctionArguments=t.rasterFunctionArguments,e))&&this._findFunction(t.rasterFunctionArguments&&t.rasterFunctionArguments.Raster,e,s)},_getSelectedLayerIndexFromUI:function(t,e){if(!t||!e)return-1;var s=-1;return i.forEach(t,function(t,i){t&&t.label.toLowerCase()===e.toLowerCase()&&(s=i)}),s},_setAnalysisGpServerAttr:function(t){t&&(this.analysisGpServer=t,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.rasterGPToolName))},_setInputLayersAttr:function(t){this.inputLayers=t},_setInputLayerAttr:function(t){this.inputLayer=t},_getInputLayerAttr:function(){return this.inputLayer},_getOutputLayerNameAttr:function(){return this._outputLayerInput&&(this.outputLayerName=this._outputLayerInput.get("value")),this.outputLayerName},_setOutputLayerNameAttr:function(t){this.outputLayerName=t},_setDisableRunAnalysisAttr:function(t){this._saveBtn.set("disabled",t)},_setDisableExtentAttr:function(t){this._useExtentCheck.set("checked",!t),this._useExtentCheck.set("disabled",t)},_getDisableExtentAttr:function(){this._useExtentCheck.get("disabled")},_setMapAttr:function(t){this.map=t},_getMapAttr:function(){return this.map},_handleModeCrumbClick:function(t){t.preventDefault(),this._onClose(!0)},_onClose:function(t){this._removePointLayer(),t&&(this._save(),this.emit("save",{save:!0})),this.emit("close",{save:!t})},_removePointLayer:function(){this.drawnPointLayer&&(this._removeLayer(this.drawnPointLayer,this.inputLayers,this._analysisSelect),this._sourceDrawBtn.deactivate())},_removeLayer:function(t,e,s){this.map.removeLayer(t),i.forEach(e,function(i,a){if(i===t)return s.removeOption({value:a+1,label:e.name}),void e.splice(a,1)},this)},_save:function(){},_handleShowCreditsClick:function(t){t.preventDefault();var e={};this._form.validate()&&(e.inputLayer=n.toJson(S.constructAnalysisInputLyrObj(this.get("inputLayer"))),e[this.outputName]=n.toJson({serviceProperties:{name:this.get("outputLayerName")}}),this.secondaryOutputNames&&s.mixin(e,this.updateSecondaryOutputNames()),this.showChooseExtent&&this._useExtentCheck.get("checked")&&(e.context=n.toJson({extent:this.map.extent._normalize(!0)})),this.getCreditsEstimate(this.toolName,e).then(s.hitch(this,function(t){this._usageForm.set("content",t),this._usageDialog.show()})))},updateSecondaryOutputNames:function(){var t={};return i.forEach(this.secondaryOutputNames,s.hitch(this,function(e){this.get(e)&&(t[e]=n.toJson({serviceProperties:{name:this.get(e).replace(this.unsupportedServiceNameCharacters,"_")}}))})),t},_handleSaveBtnClick:function(t){if(this._form.validate()){var e;e=this.secondaryOutputNames?this._validateSecondaryOutputNames():"done",u(e,s.hitch(this,function(){this._saveBtn.set("disabled",!0);var t=this._webLayerTypeSelect.get("value"),e={},i=this._getJobParameters();if(!d.isDefined(i)){i={};var a={};this._useRFT?a=this._getRasterFunction():(a.rasterFunction=this._getRasterFunction(),a.rasterFunctionArguments=this._getRasterArguments()),i.rasterFunction=n.toJson(a);var r=this._getRasterObject();r&&!this._useRFT&&(i.functionArguments=n.toJson({raster:r}))}i[this.outputName]=n.toJson({serviceProperties:{name:this.get("outputLayerName")}}),this.secondaryOutputNames&&s.mixin(i,this.updateSecondaryOutputNames()),i.returnProcessInfo=this.returnProcessInfo;var o={};if(this.showChooseExtent&&!this.get("disableExtent")&&this._useExtentCheck.get("checked")&&(o.extent=this.map.extent._normalize(!0)),i.context=n.toJson(o),e.jobParams=i,"permanentLayer"===t){e.itemParams={description:this.i18n.itemDescription,tags:h.substitute(this.i18n.itemTags,{layername:this.inputLayer&&this.inputLayer.name,fieldname:i.field||"",valuelayername:i.valuelayername||""}),snippet:this.i18n.itemSnippet};var u=this._getOutputItemProperties();u&&(e.itemParams.text=u),this.showSelectFolder&&(e.itemParams.folder=this.get("folderId")),e.analysisType=this.analysisType,this.execute(e)}else"dynamicLayer"===t&&this._handleSaveDynamicLayer(i)}))}},_handleSaveDynamicLayer:function(t){var e=this.get("inputLayer"),s=this.analysisGpServer.replace("RasterAnalysisTools/GPServer","RasterRendering/ImageServer?viewId="),i={createItemThumbnail:!1};i.url=s+e.url,i.outputLayerName=n.fromJson(t[this.outputName]).serviceProperties.name,i.analysisInfo={toolName:this.toolName,jobParams:t};var a=new A;a.functionName=this._getRasterFunction(),a.functionArguments=this._getRasterArguments(),i.renderingRule=a,i.mosaicRule=e.mosaicRule},_handleAnalysisLayerChange:function(t){"browse"===t?(this._analysisquery||(this._analysisquery=this._browsedlg.browseItems.get("query")),this._browsedlg.browseItems.set("query",this._analysisquery+' AND tags:"point"'),this._browsedlg.show()):(this.inputLayer=this.inputLayers[t],this._updateAnalysisLayerUI(!0))},addPointAnalysisLayer:function(){this._sourceDrawBtn&&(this._sourceDrawBtn.set("map",this.map),this._sourceDrawBtn.on("change",s.hitch(this,this._handleAnalysisPointSelectLayer)))},_handleAnalysisPointSelectLayer:function(t){this.inputLayers&&0!==this.inputLayers.length&&-1!==this.inputLayers.indexOf(t)||(this.drawnPointLayer=t,this.inputLayers.push(t),this.inputLayer=t,this._analysisSelect.removeOption(this._analysisSelect.getOptions()),S.populateAnalysisLayers(this,"inputLayer","inputLayers"),this._updateAnalysisLayerUI(!0))},_updateAnalysisLayerUI:function(t){"ApplyRFxTemplate"===this.toolName&&(t&&(this.outputLayerName=this._getOutputRasterLayerName()),this._outputLayerInput.set("value",this.outputLayerName)),this.inputLayer&&(this._interpolateToolDescription&&y.set(this._interpolateToolDescription,"innerHTML",h.substitute(this.i18n.toolDefine,{layername:this.inputLayer.name})),t&&(this.outputLayerName=this._getOutputRasterLayerName()||h.substitute(this.i18n.outputLayerName,{layername:this.inputLayer.name})),this._outputLayerInput.set("value",this.outputLayerName)),this._resetUI()},_handleBrowseItemsSelect:function(t){t&&t.selection&&S.addAnalysisReadyLayer({item:t.selection,layers:this.inputLayers,layersSelect:this._analysisSelect,browseDialog:this._browsedlg,widget:this}).always(s.hitch(this,this._updateAnalysisLayerUI,!0))},_validateSecondaryOutputNames:function(t){var a=new e;return this.getUserProfile().then(s.hitch(this,function(t){var e=[],n=!0,r=this.portalUrl+"/sharing/rest/portals/"+t.orgId+"/isServiceNameAvailable";i.forEach(this.secondaryOutputNames,s.hitch(this,function(t){if(this.get(t)){var s={name:this.get(t).replace(this.unsupportedServiceNameCharacters,"_"),type:"Image Service",f:"json"};e.push(f({url:r,content:s}))}})),o(e).then(s.hitch(this,function(t){i.forEach(t,s.hitch(this,function(t,e){t.available||(n=!1,this.emit("job-fail",{message:this.i18n.servNameExists,type:"warning",messageCode:"AB_0002"}),a.reject())})),n&&a.resolve()}))})),a.promise},_buildUI:function(){var t=!0;if(this._loadConnections(),this.signInPromise.then(s.hitch(this,S.initHelpLinks,this.domNode,this.showHelp,{analysisGpServer:this.analysisGpServer,analysisMode:"raster"})),this.rasterFunction){var e=this._getReRunRFxArgs(this.rasterFunction,this._findDeepestArgsForRerun);e&&s.mixin(this,e)}if(this.functionArguments&&this.functionArguments.Raster&&this.set("inputLayer",this.functionArguments.Raster),this.get("showSelectAnalysisLayer")&&(this.inputLayers&&this.inputLayer&&!S.isLayerInLayers(this.inputLayer,this.inputLayers)&&this.inputLayers.push(this.inputLayer),this.get("inputLayer")||!this.get("inputLayers")||this.rerun||this.set("inputLayer",this.inputLayers[0]),S.populateAnalysisLayers(this,"inputLayer","inputLayers")),S.addReadyToUseLayerOption(this,[this._analysisSelect]),this.outputLayerName&&(this._outputLayerInput.set("value",this.outputLayerName),t=!1),(this.inputLayer||"ApplyRFxTemplate"===this.toolName)&&this._updateAnalysisLayerUI(t),p.set(this._chooseFolderRow,"display",!0===this.showSelectFolder?"block":"none"),this.showSelectFolder&&this.getFolderStore().then(s.hitch(this,function(t){this.folderStore=t,S.setupFoldersUI({folderStore:this.folderStore,folderId:this.folderId,folderName:this.folderName,folderSelect:this._webMapFolderSelect,username:this.portalUser?this.portalUser.username:""})})),this._chooseLayerTypeRow){p.set(this._chooseLayerTypeRow,"display",!0===this.showSelectLayerType?"block":"none");var i=new r({data:[{name:this.i18n.permanentLayer,id:"permanentLayer"},{name:this.i18n.dynamicLayer,id:"dynamicLayer"}]});this._webLayerTypeSelect.set("store",i),this._webLayerTypeSelect.set("value","permanentLayer")}p.set(this._chooseExtentDiv,"display",!0===this.showChooseExtent?"inline-block":"none"),p.set(this._showCreditsLink,"display",!0===this.showCredits?"block":"none"),this.inputLayer&&this.inputLayer.drawnLayer&&this._sourceDrawBtn&&this._sourceDrawBtn.set("pointFeatureLayer",this.inputLayer),this._setDefaultInputs()},_loadConnections:function(){this.on("start",s.hitch(this,"_onClose",!1)),this._connect(this._closeBtn,"onclick",s.hitch(this,"_onClose",!0))},_connect:function(t,e,s){this._pbConnects.push(a.connect(t,e,s))}});return l("extend-esri")&&s.setObject("dijit.analysis.RasterAnalysisMixin",I,m),I});