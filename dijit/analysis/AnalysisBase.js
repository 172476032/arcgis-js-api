// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/has","dojo/json","dojo/Deferred","dojo/promise/all","dojo/when","dojo/data/ItemFileWriteStore","dojo/string","dojo/Evented","dojo/_base/kernel","dojo/Stateful","../../kernel","../../lang","../../request","../../tasks/Geoprocessor","dojo/i18n!../../nls/jsapi","./utils","./storageUtils","../../IdentityManager"],function(e,t,s,i,r,a,o,n,h,l,m,c,u,p,d,f,b,g,P,j,v,S){var _=t([d,u],{declaredClass:"esri.dijit.analysis.AnalysisBase",isOutputLayerItemUpdated:!1,analysisGpServer:null,toolName:null,portalUrl:null,jobParams:null,itemParams:null,gp:null,resultParameter:null,signInPromise:null,getResultLyrInfos:!1,checkCreditLimits:!1,_jobInfo:null,_popupInfo:null,_toolServiceUrl:null,_counter:null,_analysisType:"feature",doRefreshItem:!0,doSaveJobInfo:!1,doSaveInStorage:!1,constructor:function(e){this.isOutputLayerItemUpdated=!1,this._rids=[],this._counter=0,this._popupInfo=[],e.analysisGpServer?this._signIn(e.analysisGpServer):e.portalUrl&&(this.portalUrl=e.portalUrl,this._signIn(e.portalUrl,!0)),this.i18n={},s.mixin(this.i18n,j.common),s.mixin(this.i18n,j.analysisTools),s.mixin(this.i18n,j.analysisMsgCodes),s.mixin(this.i18n,j.analysisSettings),this.signInPromise.then(s.hitch(this,this._initErrorHelpMap))},execute:function(e){this.jobParams=e.jobParams,this.jobParams.OutputName?this.itemParams=e.itemParams:(this.itemParams=null,this.jobParams.resultName=this.get("resultName")),this._analysisType=e.analysisType||"feature",b.isDefined(e.isSpatioTemporalDataStore)&&(this._isSpatioTemporalDataStore=v.settingsVM&&v.settingsVM.datastore&&"CopyToDataStore"!==this.toolName?"BDS"===v.settingsVM.datastore:e.isSpatioTemporalDataStore),this.signInPromise.then(s.hitch(this,this._checkUser))},_checkUser:function(){var e,t,i;i=f.id.findCredential(this.portalUrl),e=i.userId,e&&(t=this.portalUrl+"/sharing/rest/community/users/"+e,g({url:t,content:{f:"json"}}).then(s.hitch(this,this._handleUserProfileResponse),s.hitch(this,function(e){this.emit("job-fail",{message:e.message+(e.details?e.details.toString():""),jobParams:this.jobParams})})))},_handleUserProfileResponse:function(e){if(b.isDefined(e)&&b.isDefined(e.orgId))if(-1===i.indexOf(["account_admin","account_publisher","org_admin","org_publisher"],e.role))this.emit("job-fail",{message:this.i18n.pubRoleMsg,messageCode:"AB_0001",jobParams:this.jobParams});else if(b.isDefined(e.availableCredits)&&this.get("checkCreditLimits")){var t,a,o={};for(t in this.jobParams)this.jobParams.hasOwnProperty(t)&&("object"==typeof this.jobParams[t]?o[t]=r.toJson(this.jobParams[t]):-1!==i.indexOf(["measurementtype"],t.toLowerCase())&&"StraightLine"!==this.jobParams[t]?(a=r.fromJson(this.jobParams[t]),o[t]=a?a.name.replace(/[\s~`!#$%\^&*+=\-\[\]\\';,\/{}|\\":<>\?]/g,""):"DrivingTime"):o[t]=this.jobParams[t]);this.getCreditsEstimate(this.toolName,o).then(s.hitch(this,function(t){var s,i=t&&b.isDefined(t.cost)?t.cost:t.maximumCost;b.isDefined(i)&&e.availableCredits>i?b.isDefined(this.itemParams)?this._checkServiceName(e.orgId):(this.emit("start",this.jobParams),this._submitGpJob()):t&&t.messageCode&&t.message?(s=b.isDefined(this.i18n[t.messageCode])?this.i18n[t.messageCode]:t.message,s=b.isDefined(t.params)?c.substitute(s,t.params):s,this.emit("job-fail",{message:s,messageCode:"AB_0001",jobParams:this.jobParams})):this.emit("job-fail",{message:this.i18n.insufficientCreditsMsg,messageCode:"AB_0001",jobParams:this.jobParams})}))}else b.isDefined(this.itemParams)?this._checkServiceName(e.orgId):(this.emit("start",this.jobParams),this._submitGpJob());else this.emit("job-fail",{message:this.i18n.orgUsrMsg,jobParams:this.jobParams})},_checkServiceName:function(e){var t,i,a,o;t=f.id.findCredential(this.portalUrl),i=this.portalUrl+"/sharing/rest/portals/"+e+"/isServiceNameAvailable",a=r.fromJson(this.jobParams.OutputName),this.isSingleTenant&&b.isDefined(a.serviceProperties)&&b.isDefined(a.serviceProperties.name)&&(a.serviceProperties.name=a.serviceProperties.name.replace(/[\s~`!#$%\^&*+=\-\[\]\\';,\/{}|\\":<>\?\.]/g,"_"),this.jobParams.OutputName=r.toJson(a)),o={name:a.serviceProperties.name,type:"raster"===this._analysisType?"Image Service":"Feature Service",f:"json"},g({url:i,content:o}).then(s.hitch(this,function(e){e.available?("raster"===this._analysisType?this._createImageService():this._createService(),this.emit("start",this.jobParams)):this.emit("job-fail",{message:this.i18n.servNameExists,type:"warning",messageCode:"AB_0002",jobParams:this.jobParams})}),s.hitch(this,function(e){this.emit("job-fail",{message:e.message+(e.details?e.details.toString():""),jobParams:this.jobParams})}))},_createService:function(){var e,t,i,a,o,n,h;n=f.id.findCredential(this.portalUrl),e=n.userId,t=r.fromJson(this.jobParams.OutputName),e&&(o=this.itemParams.folder,a=this.portalUrl+"/sharing/rest/content/users/"+e+(o&&"/"!==o?"/"+o:"")+"/createService",i={createParameters:r.toJson({currentVersion:10.2,serviceDescription:"",hasVersionedData:!1,supportsDisconnectedEditing:!1,hasStaticData:!0,maxRecordCount:2e3,supportedQueryFormats:"JSON",capabilities:"Query",description:"",copyrightText:"",allowGeometryUpdates:!1,syncEnabled:!1,editorTrackingInfo:{enableEditorTracking:!1,enableOwnershipAccessControl:!1,allowOthersToUpdate:!0,allowOthersToDelete:!0},xssPreventionInfo:{xssPreventionEnabled:!0,xssPreventionRule:"InputOnly",xssInputRule:"rejectInvalid"},tables:[],name:t.serviceProperties.name}),outputType:"featureService",f:"json"},this._isSpatioTemporalDataStore&&(h=r.fromJson(i.createParameters),h.options={dataSourceType:"spatiotemporal"},i.createParameters=r.toJson(h)),g({url:a,content:i},{usePost:!0}).then(s.hitch(this,this._submitGpJob),s.hitch(this,this._handleCreateServiceError)))},_createImageService:function(){var e,t,i,a,o,n;n=f.id.findCredential(this.portalUrl),e=n.userId,t=r.fromJson(this.jobParams.OutputName),e&&(o=this.itemParams.folder,a=this.portalUrl+"/sharing/rest/content/users/"+e+(o&&"/"!==o?"/"+o:"")+"/createService",i={createParameters:r.toJson({name:t.serviceProperties.name,description:"",capabilities:"Image",properties:{path:"@",description:"",copyright:""}}),outputType:"imageService",f:"json"},g({url:a,content:i},{usePost:!0}).then(s.hitch(this,this._submitGpJob),s.hitch(this,this._handleCreateServiceError)))},_handleCreateServiceError:function(e){this.emit("job-fail",{message:e.message+(e.details?e.details.toString():""),jobParams:this.jobParams})},_getSelf:function(e){var t=e+"/sharing/rest/portals/self";return g({url:t,content:{culture:p.locale,f:"json"},callbackParamName:"callback",timeout:0},{})},_submitGpJob:function(e){var t,i;this.itemParams&&(this.currentGpItemId=e.itemId,t=r.fromJson(this.jobParams.OutputName),t.serviceProperties&&(t.serviceProperties.serviceUrl=e.serviceurl),t.itemProperties={itemId:e.itemId},this.itemParams.folder&&(t.itemProperties.folderId=this.itemParams.folder),this.jobParams.OutputName=r.toJson(t)),this.rerun&&this.context&&this._useExtentCheck&&!this._useExtentCheck.get("checked")&&(this.context=null),this.context&&(i=r.fromJson(this.jobParams.context),i||(i={}),this.context.outSR&&!i.outSR&&(i.outSR=this.context.outSR),this.context.processSR&&!i.processSR&&(i.processSR=this.context.processSR),this.context.extent&&!i.extent&&(i.extent=this.context.extent),"raster"===this._analysisType&&(this.context.cellSize&&!i.cellSize&&(i.cellSize=this.context.cellSize),this.context.mask&&!i.mask&&(i.mask=this.context.mask),this.context.snapRaster&&!i.snapRaster&&(i.snapRaster=this.context.snapRaster)),this.jobParams.context=r.toJson(i)),this.analysisGpServer?(this._toolServiceUrl&&this.gp||this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName),this.gp.setUpdateDelay(3e3),this.itemParams||delete this.jobParams.resultName,this.gp.submitJob(this.jobParams,s.hitch(this,this._gpJobComplete),s.hitch(this,this._gpJobStatus),s.hitch(this,this._gpJobFailed)),this.itemParams||(this.jobParams.resultName=this.get("resultName")),this.emit("job-submit",this.jobParams)):this._getSelf(this.portalUrl).then(s.hitch(this,function(e){this.analysisGpServer=e.helperServices.analysis&&e.helperServices.analysis.url?e.helperServices.analysis.url:null,this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName),this.gp.setUpdateDelay(3e3),this.itemParams||delete this.jobParams.resultName,this.gp.submitJob(this.jobParams,s.hitch(this,this._gpJobComplete),s.hitch(this,this._gpJobStatus),s.hitch(this,this._gpJobFailed)),this.itemParams||(this.jobParams.resultName=this.get("resultName")),this.emit("job-submit",this.jobParams)}))},_updateItem:function(e){var t,i,a,o,n,h,l,m,c;return t=f.id.findCredential(this.portalUrl),i=t.userId,i?(a=this.itemParams.folder,o=this.portalUrl+"/sharing/rest/content/users/"+i+(a&&"/"!==a?"/"+a:"")+"/items/"+this.currentGpItemId+"/update",e&&(c=e.item.properties),b.isDefined(c)||(c={}),b.isDefined(c.jobUrl)||(c.jobUrl=this._toolServiceUrl+"/jobs/"+this._jobInfo.jobId,c.jobType="GPServer",c.jobId=this._jobInfo.jobId,c.jobStatus="processing",this.itemParams.properties=c),n=s.mixin({f:"json"},this.itemParams),e&&n.folder===e.item.folder&&delete n.folder,e&&e.item&&n.tags===e.item.tags.toString()&&delete n.tags,e&&e.item&&n.snippet===e.item.snippet&&delete n.snippet,e&&e.item&&n.description===e.item.description&&delete n.description,n.properties&&(n.properties=r.toJson(n.properties)),n.text&&(n.text=r.toJson(n.text)),h={},l={},m=g({url:o,content:n},{usePost:!0}),m.then(s.hitch(this,this._handleItemUpdate),s.hitch(this,this._handleUpdateItemError)),m):void 0},_handleItemUpdate:function(e){this.isOutputLayerItemUpdated=!0},_handleItemDataUpdate:function(e){},_handleUpdateItemError:function(e){this.isOutputLayerItemUpdated=!0,this.emit("job-fail",{message:e.message+(e.details?e.details.toString():""),jobParams:this.jobParams})},_handleErrorResponse:function(e){this.emit("job-fail",e)},_refreshItem:function(){var e,t,s,i,r;return i=f.id.findCredential(this.portalUrl),e=i.userId,e?(t=this.itemParams.folder,s=this.portalUrl+"/sharing/rest/content/users/"+e+(t&&"/"!==t?"/"+t:"")+"/items/"+this.currentGpItemId+"/refresh",r=g({url:s,content:{f:"json"}},{usePost:!0})):(r=new n,r.resolve()),r.promise},_handleItemRefresh:function(e){},_readItem:function(){var e,t,i,r,a;return r=f.id.findCredential(this.portalUrl),e=r.userId,e?(t=this.itemParams.folder,i=this.portalUrl+"/sharing/rest/content/users/"+e+(t&&"/"!==t?"/"+t:"")+"/items/"+this.currentGpItemId,a=g({url:i,content:{f:"json"}}),a.then(s.hitch(this,this._updateItem))):void 0},getItemInfo:function(e){var t,s,i;return i=f.id.findCredential(this.portalUrl),t=i.userId,t?(s=this.portalUrl+"/sharing/rest/content/items/"+e,g({url:s,content:{f:"json"}})):void 0},_gpJobStatus:function(e){e.jobParams=this.jobParams,e.resultParameter=this.resultParameter,e.returnProcessInfo=this.jobParams.returnProcessInfo,e.getResultLyrInfos=this.getResultLyrInfos,e.currentGpItemId=this.currentGpItemId,e.itemParams=this.itemParams,"esriJobFailed"===e.jobStatus||"esriJobSucceeded"===e.jobStatus?(e.messages&&(e.message=this._buildErrorMsg(e)),this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=null,this._gpJobComplete(e)),"esriJobFailed"===e.jobStatus&&this._deleteItem(!1)):"esriJobCancelled"===e.jobStatus&&(this.itemParams?this._deleteItem(!0):this.emit("job-cancel",e)),this.doSaveJobInfo&&this.saveJobInfo(e),this.emit("job-status",e),this._jobInfo=e,this.itemParams&&!this.isOutputLayerItemUpdated&&this._readItem()},_updateRefreshItem:function(e){var t,i=[],a=e[0];i.push(this._readItem(this.doRefreshItem)),t="sync",h(i).then(s.hitch(this,function(e){a.outputLayerName=r.fromJson(this.jobParams.OutputName).serviceProperties.name,a.value.itemId=this.currentGpItemId,a.analysisInfo={toolName:this.toolName,jobParams:this.jobParams},this.doRefreshItem?this._refreshItem().always(s.hitch(this,function(){this.emit("job-result",a)})):this.emit("job-result",a)}),s.hitch(this,this._handleDeleteItemError))},_gpJobComplete:function(e){var t;"esriJobSucceeded"===e.jobStatus&&(e.jobParams=this.jobParams,this.emit("job-success",e),h(this._getGpResultData(e)).then(s.hitch(this,function(a){return a=i.filter(a,function(e){var t=!0;return b.isDefined(e.value.empty)?t=e.value.empty:b.isDefined(e.value.url)||b.isDefined(e.value.itemId)?t=!1:b.isDefined(e.value.featureSet)&&(t=!1),t?void 0:e}),0===a.length?(this.currentGpItemId&&this._deleteItem(!1),void this.emit("job-fail",{message:this.i18n.emptyResultInfoMsg,type:"warning",jobParams:this.jobParams})):(b.isDefined(this.itemParams)&&this.itemParams.properties&&this.itemParams.properties.jobStatus&&"processing"===this.itemParams.properties.jobStatus&&(this.itemParams.properties.jobStatus="completed"),i.forEach(a,function(e){if(e.value.featureSet&&!e.value.url)e.value.featureSet.spatialReference=e.value.layerDefinition.spatialReference;else if(e.value.url&&-1!==e.value.url.indexOf("/FeatureServer/")&&e.value.layerInfo&&e.value.layerInfo.popupInfo){var t=e.value.url.match(/[0-9]+$/g)[0];this._popupInfo[t]=e.value.layerInfo.popupInfo}},this),t=a[0],t.results=a,void(this.jobParams.returnProcessInfo?this.gp.getResultData(e.jobId,"ProcessInfo").then(s.hitch(this,function(e){var s=[];i.forEach(e.value,function(e){s.push(r.fromJson(e))},this),this.currentGpItemId?(this.itemParams.description=v.buildReport(s),this._updateRefreshItem(a)):(t.analysisReport=v.buildReport(s),t.outputLayerName=this.jobParams.resultName,this.emit("job-result",t))})):this.currentGpItemId?this._updateRefreshItem(a):(t.outputLayerName=this.jobParams.resultName,this.emit("job-result",t))))})))},_gpJobFailed:function(e){var t=s.clone(e);t.jobParams=this.jobParams,this._checkTimer&&(clearInterval(this._checkTimer),this._checkTimer=null),e.messages&&(e.message=this._buildErrorMsg(e)),this.emit("job-fail",e)},_getGpResultData:function(e){var t=[],s=[];return"string"==typeof this.resultParameter?s.push(this.resultParameter):this.resultParameter instanceof Array&&(s=this.resultParameter),i.forEach(s,function(s,i){t.push(this.gp.getResultData(e.jobId,s))},this),t},cancel:function(e){this.gp.cancelJob(e.jobId).then(s.hitch(this,function(e){"esriJobCancelled"===e.jobStatus&&(this.itemParams?this._deleteItem(!0):this.emit("job-cancel",e))}),function(e){})},checkJobStatus:function(e){this.signInPromise.then(s.hitch(this,function(){this.gp.setUpdateDelay(3e3),this._checkTimer=setInterval(s.hitch(this,this._checkStatus,e,s.hitch(this,this._gpJobStatus),s.hitch(this,this._gpJobFailed)),3e3)}))},_checkStatus:function(e,t,s){this.gp.checkJobStatus(e,t,s)},_deleteItem:function(e){var t,i,r,a;a=f.id.findCredential(this.portalUrl),t=a.userId,t&&this.itemParams&&(i=b.isDefined(this.itemParams.folder)?this.itemParams.folder:"",r=this.portalUrl+"/sharing/rest/content/users/"+t+(i&&"/"!==i?"/"+i:"")+"/items/"+this.currentGpItemId+"/delete",g({url:r,content:{f:"json"}},{usePost:!0}).then(s.hitch(this,this._handleItemDelete,e),s.hitch(this,this._handleDeleteItemError)))},_handleItemDelete:function(e,t){e&&this.emit("job-cancel",t)},_handleDeleteItemError:function(e){this.emit("job-fail",{message:e.message+(e.details?e.details.toString():""),jobParams:this.jobParams})},_initFolderStore:function(e,t){this.portalSelf?this._fportal=new e.Portal({url:this.portalUrl,self:this.portalSelf}):this._fportal=new e.Portal(this.portalUrl),this._fportal.signIn().then(s.hitch(this,function(e){this.portalUser=e,this.portalUser.getFolders().then(s.hitch(this,function(e){var s=v.createFolderStore(e,this.portalUser.username);t.resolve(s)}))}))},getFolderStore:function(){var t,r,a,o,h=new n;return this.folderStore?h.resolve(this.folderStore):this.signInPromise.then(s.hitch(this,function(s){t=["../../arcgis/Portal"],r=this._counter++,a=this,this._rids&&this._rids.push(r),e(t,function(e){o=a._rids?i.indexOf(a._rids,r):-1,-1!==o&&(a._rids.splice(o,1),a._initFolderStore(e,h))})})),h},_checkToolUrl:function(){var e=new n;return this.analysisGpServer?(this._toolServiceUrl&&this.gp||this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName),e.resolve({success:!0})):this._getSelf(this.portalUrl).then(s.hitch(this,function(t){this.analysisGpServer=t.helperServices.analysis&&t.helperServices.analysis.url?t.helperServices.analysis.url:null,this.analysisGpServer&&this.set("toolServiceUrl",this.analysisGpServer+"/"+this.toolName),e.resolve({success:!0})})),e},getCreditsEstimate:function(e,t){var r,a,o,h,l;return a=new n,this._checkToolUrl().then(s.hitch(this,function(n){this._toolServiceUrl?l=this._toolServiceUrl:(h=this.portalUrl&&-1!==this.portalUrl.indexOf("dev")?"dev":this.portalUrl&&-1!==this.portalUrl.indexOf("qa")?"qa":"",l="http://analysis"+h+".arcgis.com/arcgis/rest/services/tasks/GPServer/"+this.toolName),!this.showGeoAnalyticsParams&&-1!==i.indexOf(["AggregatePoints","SummarizeWithin"],e)&&t.binType?(r=l.replace(e,"TessellationCredit"),this.creditGP=new P(r),this.creditGP.setUpdateDelay(1e3),t.pointLayer?t.inputLayer=t.pointLayer:t.summaryLayer&&(t.inputLayer=t.summaryLayer),this.creditGP.submitJob(t,s.hitch(this,this._getGPCreditResult,a),s.hitch(this,this._creditGPJobFailed,a),s.hitch(this,this._creditGPJobFailed,a))):(r=l.replace("/"+e,"/exts/Estimate/"+e),o=s.mixin({f:"json"},t),g({url:r,content:o},{usePost:!0}).then(function(e){a.resolve(e)},function(e){a.resolve(e)}))})),a},_getGPCreditResult:function(e,t){this.creditGP.getResultData(t.jobId,"creditOutput").then(s.hitch(this,function(e,t){t&&t.value&&t.value.credits&&(t.value.cost=t.value.credits),e.resolve(t.value)},e),s.hitch(this,function(e,t){e.resolve(t)},e))},_creditGPJobFailed:function(e,t){("esriJobFailed"===t.jobStatus||"esriJobCancelled"===t.jobStatus)&&e.resolve(this._buildErrorMsg(t))},_signIn:function(t,r){var a,o,h,l,m;return this.signInPromise=new n,r?(a=["../../arcgis/Portal"],o=this._counter++,h=this,this._rids&&this._rids.push(o),e(a,s.hitch(this,function(e){l=h._rids?i.indexOf(h._rids,o):-1,-1!==l&&(h._rids.splice(l,1),this.portalSelf?this._portal=new e.Portal({url:t,self:this.portalSelf}):this._portal=new e.Portal(t),this._portal.signIn().then(s.hitch(this,function(e){this.portalUser=e,this._portal.helperServices&&this._portal.helperServices.analysis&&this._portal.helperServices.analysis.url?(this.analysisGpServer=this._portal.helperServices.analysis.url,this.showGeoAnalyticsParams&&this._portal.helperServices.geoanalytics&&(this.analysisGpServer=this._portal.helperServices.geoanalytics.url),g({url:this.analysisGpServer,content:{f:"json"},callbackParamName:"callback"}).then(s.hitch(this,function(e){m=f.id.findCredential(this.analysisGpServer),this.signInPromise.resolve(m)}),s.hitch(this,function(e){this.signInPromise.reject(e)}))):this.signInPromise.resolve(e)}),s.hitch(this,this._handleSignInError)))}))):g({url:t,content:{f:"json"},callbackParamName:"callback"}).then(s.hitch(this,function(e){var i,r;i=f.id.findCredential(t),b.isDefined(i)?(r=f.id.findServerInfo(this._toolServiceUrl),b.isDefined(r)&&b.isDefined(r.owningSystemUrl)&&(this.portalUrl=r.owningSystemUrl),this.signInPromise.resolve(i)):f.id.getCredential(t).then(s.hitch(this,function(e){e=f.id.findCredential(t),r=f.id.findServerInfo(this._toolServiceUrl),b.isDefined(r)&&b.isDefined(r.owningSystemUrl)&&(this.portalUrl=r.owningSystemUrl),this.signInPromise.resolve(e)}),s.hitch(this,this._handleSignInError))}),s.hitch(this,this._handleSignInError)),this.signInPromise},_handleSignInError:function(e){this.emit("job-fail",{message:this.i18n.analysisSignInErrorMsg,messageCode:"AB_0003"}),this.signInPromise.reject(e)},_buildErrorMsg:function(e){var t,s,a="",o=[];return this.errorHelpMap||this._initErrorHelpMap(),o=i.filter(e.messages,function(e){return"esriJobMessageTypeError"!==e.type&&"esriJobMessageTypeWarning"!==e.type||-1===e.description.indexOf("messageCode")?void 0:e.description},this),o.length>0&&i.forEach(o,function(i){var o;try{t=r.fromJson(i.description)}catch(n){t=i.description}s="","esriJobMessageTypeWarning"===i.type&&(e.type="warning"),t.messageCode?(s=b.isDefined(this.i18n[t.messageCode])?this.i18n[t.messageCode]:t.message,s=b.isDefined(t.params)?c.substitute(s,t.params):s,a+=s+"&nbsp;",o=this._addLearnMoreErrorLink(t.messageCode),o&&(a+=o)):t.error&&t.error.messageCode?(s=b.isDefined(this.i18n[t.error.messageCode])?this.i18n[t.error.messageCode]:t.error.message,s=b.isDefined(t.error.params)?c.substitute(s,t.error.params):s,a+=s+"&nbsp;",o=this._addLearnMoreErrorLink(t.error.messageCode),o&&(a+=o)):a+=t+"&nbsp;"},this),a},_toolServiceUrlSetter:function(e){this._toolServiceUrl=e,this.gp=new P(e)},_setToolServiceUrlAttr:function(e){this._toolServiceUrl=e,this.gp=new P(e)},checkCreditLimitsAttr:function(e){this.checkCreditLimits=e},replaceTag:function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;"};return t[e]||e},safetagsReplace:function(e){return e.replace(/[<>]/g,this.replaceTag)},saveJobInfo:function(e){var t,a,o;if(this.doSaveJobInfo&&this.currentGpItemId&&-1!==i.indexOf(["esriJobSucceeded"],e.jobStatus)){s.mixin(e.jobParams,{extentCheck:this._useExtentCheck&&this._useExtentCheck.get("checked")}),i.forEach(e.messages,function(e){e.description=this.safetagsReplace(e.description)},this),t={toolName:this.toolName,jobParams:e.jobParams,timestamp:Date.now(),portalUrl:this.portalUrl,jobInfo:{jobId:e.jobId,jobStatus:e.jobStatus,messages:e.messages,analysisServer:"bigdata"===this.analysisMode?"geoanalytics":"default"===this.analysisMode?"standard":this.analysisMode}},"CopyToDataStore"===this.toolName&&(t.jobParams.isSpatioTemporalDataStore=this._isSpatioTemporalDataStore),"bigdata"===this.analysisMode&&t.jobParams.timeStepReference&&(t.jobParams.timeReferenceType=this.get("timeReferenceType"));for(var n in t.jobParams)if(t.jobParams.hasOwnProperty(n)&&b.isDefined(t.jobParams[n])){if("object"==typeof t.jobParams[n]&&t.jobParams[n].serviceToken||"string"==typeof t.jobParams[n]&&-1!==t.jobParams[n].indexOf("serviceToken")){var h="string"==typeof t.jobParams[n]?r.fromJson(t.jobParams[n]):t.jobParams[n];h&&h.serviceToken&&(delete h.serviceToken,t.jobParams[n]="string"==typeof t.jobParams[n]?r.toJson(h):h)}("object"==typeof t.jobParams[n]&&!s.isArray(t.jobParams[n])&&t.jobParams[n].filter||"string"==typeof t.jobParams[n]&&-1!==t.jobParams[n].search(/[<>]/g))&&("object"==typeof t.jobParams[n]&&t.jobParams[n].filter&&!s.isArray(t.jobParams[n])?t.jobParams[n].filter=this.safetagsReplace(t.jobParams[n].filter):"string"==typeof t.jobParams[n]&&-1!==t.jobParams[n].search(/[<>]/g)&&(t.jobParams[n]=this.safetagsReplace(t.jobParams[n])))}o=f.id.findCredential(this.portalUrl),this.currentGpItemId&&(a={id:this.currentGpItemId,folderId:this.itemParams.folder,owner:o.userId},S.addToItemResource(a,t)),this.doSaveInStorage&&S.addToStorage(t)}},_initErrorHelpMap:function(){if(this.isSingleTenant){var t="./help/errorhelpmap_enterprise.json",i=e.toUrl(t);g({url:i}).then(s.hitch(this,function(e){this.errorHelpMap=e.map}))}},_addLearnMoreErrorLink:function(e){if(this.isSingleTenant){var t,s=this.errorHelpMap[e],i=this&&this.portalSelf?this.portalSelf.helpBase:null,r=this.analysisGpServer&&-1!==this.analysisGpServer.indexOf("dev")?"dev":this.analysisGpServer&&-1!==this.analysisGpServer.indexOf("qa")?"uat":"";return b.isDefined(s)&&(t="http://doc"+r+".arcgis.com/en/arcgis-online/analyze/"+s,this.isSingleTenant&&i?t=i+"index.html#"+s:this.isSingleTenant&&!i&&(t="http://server"+r+".arcgis.com/en/portal/latest/use/"+s)),t&&(t="<br/><br/><div class='esriHelpPopup'><a class='action zoomTo' href='"+t+"' target='_help'>"+this.i18n.learnMore+"</a></div><br/><br/>"),t}}});return a("extend-esri")&&s.setObject("dijit.analysis.AnalysisBase",_,f),_});