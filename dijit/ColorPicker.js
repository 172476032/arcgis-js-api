// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["../Color","../kernel","./_EventedWidget","./_Tooltip","./ColorPicker/colorUtil","./ColorPicker/HexPalette","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dojo/_base/array","dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/dom-construct","dojo/on","dojo/query","dojo/sniff","dojo/dom-style","dojo/i18n!../nls/jsapi","dojo/text!./ColorPicker/templates/ColorPicker.html","./HorizontalSlider","dijit/form/RadioButton","dijit/form/TextBox","dijit/form/ToggleButton","dojo/NodeList-dom"],function(t,e,s,o,i,r,l,a,n,c,h,d,_,p,u,g,C,w,f){var S="no-color",m=13,P=c([s,l,a,o],{baseClass:"esriColorPicker",css:{container:"esriContainer",collapsed:"esriCollapsed",collapsible:"esriCollapsible",collapseIcon:"esriCollapseIcon",colorControls:"esriColorControls",header:"esriHeader",footer:"esriFooter",middle:"esriMiddle",swatch:"esriSwatch",swatchRow:"esriSwatchRow",swatchEmpty:"esriSwatchEmpty",swatchPreview:"esriSwatchPreview",swatchTransparencyBackground:"esriSwatchTransparencyBackground",palette:"esriPalette",paletteOptions:"esriPaletteOptions",paletteToggle:"esriPaletteToggle",label:"esriLabel",hexInput:"esriHexInput",recent:"esriRecent",suggested:"esriSuggested",selected:"esriSelected",disabled:"esriDisabled",section:"esriSection",displayNone:"esriDisplayNone",transparencySlider:"esriTransparencySlider",alt:"esriAlt",downArrowIcon:"esri-icon-down"},declaredClass:"esri.dijit.ColorPicker",labels:w.widgets.colorPicker,templateString:f,constructor:function(e,s){e=e||{},this._colorInstance=new t,this._brightsPalette=new r({colors:e.palette}),this._pastelsPalette=new r({colors:this._toPastels(this._brightsPalette.get("colors"))}),this._activePalette=this._brightsPalette,this._swatchCreator=e.swatchCreator||this._createSwatch,this._swatches={}},buildRendering:function(){this.inherited(arguments),this._createPalettes();var t=this.css.swatch,e=this.css.swatchEmpty;this._noColorSwatchNode=_.create("div",{className:t+" "+e},this.dap_hexInput.domNode,"after")},postCreate:function(){this.inherited(arguments),this._addListeners(),this._selectColor(),this.dap_hexInput.intermediateChanges=!0,this.dap_transparencySlider.intermediateChanges=!0,this.createTooltips([{node:this.dap_paletteContainer,label:this.labels.paletteTooltip},{node:this.dap_hexInput,label:this.labels.hexInputTooltip},{node:this._noColorSwatchNode,label:this.labels.noColorTooltip},{node:this.dap_paletteToggle,label:this.labels.moreColorsTooltip}])},_activePalette:null,_autoCollapseHandle:null,_brightsPalette:null,_colorInstance:null,_noColorSwatchNode:null,_pastelsPalette:null,_previousColor:null,_swatchCreator:null,_swatches:null,_transparencyLabels:function(){var t=[0,50,100];return"["+t.map(function(t){var e=w.widgets.colorPicker.percent;return h.replace(e,{percent:t})}).map(function(t){return"'"+t+"'"})+"]"}(),collapsed:!1,_setCollapsedAttr:function(t){this.collapsible&&(d.toggle(this.domNode,this.css.collapsed,t),this._set("collapsed",t))},collapsible:!1,_setCollapsibleAttr:function(t){if(d.toggle(this.domNode,this.css.collapsible,t),t){if(!this._autoCollapseHandle){var e=p.pausable(this.ownerDocument,"click",function(t){var e=this.domNode.contains(t.target);this.collapsed||e||this.set("collapsed",!0)}.bind(this));this._autoCollapseHandle=e,this.own(e)}this._autoCollapseHandle.resume()}else this._autoCollapseHandle&&this._autoCollapseHandle.pause();this._set("collapsible",t)},color:null,_getColorAttr:function(){return this.color===S?S:new t(this.color)},_setColorAttr:function(e,s){if(e=e||S,s=s||void 0===s,!this.required){if(e===S)return this._set("color",S),this._previousColor=S,this._disableTransparencySlider(),this._clearSelection(),this._silentlyUpdateHexInput(S),this._updatePreviewSwatch(e),d.add(this._noColorSwatchNode,this.css.selected),void(s&&this.emit("color-change",{color:S}));this._enableTransparencySlider(),d.remove(this._noColorSwatchNode,this.css.selected)}var o,r=i.normalizeColor(e),l=this._previousColor,a=this._colorInstance,n=this.css.selected;if(l){if(i.equal(l,r))return;var c=this._findColorSwatch(l);c&&(d.remove(c,n),C.set(c,"borderColor",""))}a.setColor(r),o=a.toHex(),this._set("color",new t(a)),this._previousColor=r,this._silentlyUpdateIntermediateChangingValueWidget(this.dap_transparencySlider,1-a.a),this._updatePreviewSwatch(a),this._checkSelection(),this._silentlyUpdateHexInput(a),this.trackColors&&this._addRecentColor(o),s&&this.emit("color-change",{color:new t(a)})},colorsPerRow:m,_setColorsPerRow:function(t){t=t>0?t:m,this._set("colorsPerRow",t)},_setPaletteAttr:function(t){var e=this._activePalette===this._brightsPalette;this._brightsPalette.set("colors",t),this._pastelsPalette.set("colors",this._toPastels(this._brightsPalette.get("colors"))),this._activePalette=e?this._brightsPalette:this._pastelsPalette,this._createPalettes(),this._togglePalette(!e)},recentColors:[],_getRecentColorsAttr:function(){return n.map(this.recentColors,function(t){return i.normalizeColor(t)})},_setRecentColorsAttr:function(t){this.recentColors=t||[],this.recentColors=n.map(this.recentColors,function(t){return i.normalizeColor(t).toHex()}),0===this.recentColors.length?this._clearRecentSwatches():this._renderRecentSwatches()},required:!1,_setRequiredAttr:function(t){d.toggle(this._noColorSwatchNode,this.css.displayNone,t),this._set("required",t)},_showRecentColors:!0,_setShowRecentColorsAttr:function(t){d.toggle(this.dap_recentColorSection,this.css.displayNone,!t),this._set("showRecentColors",t)},_showSuggestedColors:!1,_setShowSuggestedColorsAttr:function(t){d.toggle(this.dap_suggestedColorSection,this.css.displayNone,!t),this._set("showSuggestedColors",t)},_showTransparencySlider:!0,_setShowTransparencySliderAttr:function(t){d.toggle(this.dap_transparencySection,this.css.displayNone,!t),this._set("showTransparencySlider",t)},suggestedColors:null,_getSuggestedColorsAttr:function(){return n.map(this.suggestedColors,function(t){return i.normalizeColor(t)})},_setSuggestedColorsAttr:function(t){this._clearSuggestedSwatches(),this.suggestedColors=t||[],this.suggestedColors=n.map(this.suggestedColors,function(t){return i.normalizeColor(t).toHex()}),this.suggestedColors.length>0&&this._renderSuggestedSwatches()},trackColors:!0,addRecentColor:function(t){t&&t!==S&&this._addRecentColor(i.normalizeColor(t).toHex())},loadRecentColors:function(t){this.set("recentColors",JSON.parse(localStorage.getItem(t)))},saveRecentColors:function(t){localStorage.setItem(t,JSON.stringify(this.get("recentColors")))},_toPastels:function(e){var s=this._colorInstance,o=new t([238,238,238]);return n.map(e,function(e){return t.blendColors(s.setColor(e),o,.2)},this)},_createSwatch:function(t){var e=t.className,s=t.hexColor||"transparent",o=t.paletteNode,i=_.create("span",{className:e,style:{background:s}},o);return i},_createSwatches:function(t,e){var s,o,i=this.css.swatch,r=this.css.swatchRow,l=this.colorsPerRow,a=e.get("colors");n.forEach(a,function(e,a){a%l===0&&(s=_.create("div",{className:r},t)),o=this._swatchCreator({className:i,hexColor:e,paletteNode:s}),this._swatches[e]=o},this)},_selectColor:function(){var t=this.color||this._activePalette.get("colors")[0];this.set("color",t)},_setColorWithCurrentAlpha:function(t){t!==S&&this.color!==S&&(t=i.normalizeColor(t),t.a=this.color.a),this.set("color",t)},_updatePreviewSwatch:function(t){var e,s,o,r,l,a=this.css.swatchEmpty,n=this.dap_previewSwatch;return t===S?(d.add(n,a),void C.set(n,{backgroundColor:"",borderColor:""})):(e=i.getContrastingColor(t),s=8!==g("ie"),d.remove(n,a),o=t.toCss(s),r=e.toCss(s),l={backgroundColor:o,borderColor:r},s||(l.opacity=t.a),void C.set(n,l))},_showBrights:function(){d.remove(this.dap_paletteContainer,this.css.alt),this._activePalette=this._brightsPalette},_showPastels:function(){d.add(this.dap_paletteContainer,this.css.alt),this._activePalette=this._pastelsPalette},_setColorFromSwatch:function(t){var e=C.get(t,"backgroundColor");this._setColorWithCurrentAlpha(e)},_checkSelection:function(){var t=this.get("color");this._activePalette.contains(t)?this._highlightColor(t):this._clearSelection()},_addListeners:function(){var t="."+this.css.swatch;"."+this.css.swatchEmpty;this.own(p(this.dap_paletteContainer,p.selector(t,"click"),h.hitch(this,function(t){this._setColorFromSwatch(t.target)}))),this.own(p(this.dap_recentColorPalette,p.selector(t,"click"),h.hitch(this,function(t){this._setColorFromSwatch(t.target)}))),this.own(p(this.dap_suggestedColorPalette,p.selector(t,"click"),h.hitch(this,function(t){this._setColorFromSwatch(t.target)}))),this.own(p(this._noColorSwatchNode,"click",h.hitch(this,function(t){this.set("color",S)})));var e=this.dap_hexInput;e.on("blur",h.hitch(this,function(){var t=i.normalizeHex(e.get("value"));return i.isShorthandHex(t)?void this._setColorWithCurrentAlpha(t):void this._silentlyUpdateHexInput(this.color)})),e.on("change",h.hitch(this,function(){var t=i.normalizeHex(e.get("value"));i.isLonghandHex(t)&&(this.color===S||this.color.toHex()!==t)&&this._setColorWithCurrentAlpha(t)})),this.dap_transparencySlider.on("change",h.hitch(this,function(t){var e,s=this.get("color");s!==S&&(e=i.normalizeColor(this._colorInstance.setColor(s)),e.a=1-t,this._updatePreviewSwatch(e),this._silentlyUpdateHexInput(e),this.set("color",e))})),this.dap_paletteToggle.on("change",h.hitch(this,this._togglePalette)),this.own(p(this.dap_header,"click",function(){this.collapsible&&this.set("collapsed",!this.collapsed)}.bind(this)))},_togglePalette:function(t){this.dap_paletteToggle.set("checked",t,!1),t?this._showPastels():this._showBrights(),this._checkSelection()},_createPalettes:function(){this._swatches={},_.empty(this.dap_primaryPalette),_.empty(this.dap_secondaryPalette),this._createSwatches(this.dap_primaryPalette,this._brightsPalette),this._createSwatches(this.dap_secondaryPalette,this._pastelsPalette)},_silentlyUpdateHexInput:function(t){var e=t===S?"":t.toHex();this._silentlyUpdateIntermediateChangingValueWidget(this.dap_hexInput,e)},_silentlyUpdateIntermediateChangingValueWidget:function(t,e){t.intermediateChanges=!1,t.set("value",e,!1),t.intermediateChanges=!0},_addRecentColor:function(t){if(t){var e=this.recentColors,s=n.indexOf(e,t);s>-1&&e.splice(s,1),e.unshift(t),e.length>this.colorsPerRow&&e.pop(),this._renderRecentSwatches()}},_renderRecentSwatches:function(){if(this.recentColors){var t=this.css.recent,e=this.css.swatch,s="."+t+"."+e,o=u(s,this.dap_recentColorPalette);n.forEach(this.recentColors,function(s,i){if(i<this.colorsPerRow){if(i+1>o.length){var r=this._swatchCreator({hexColor:s,className:e+" "+t,paletteNode:this.dap_recentColorPalette});o.push(r)}C.set(o[i],"backgroundColor",s)}},this)}},_renderSuggestedSwatches:function(){if(this.suggestedColors){var t=this.css.suggested,e=this.css.swatch,s="."+t+"."+e,o=u(s,this.dap_recentColorPalette);n.forEach(this.suggestedColors,function(s,i){if(i<this.colorsPerRow){if(i+1>o.length){var r=this._swatchCreator({hexColor:s,className:e+" "+t,paletteNode:this.dap_suggestedColorPalette});o.push(r)}C.set(o[i],"backgroundColor",s)}},this)}},_clearRecentSwatches:function(){_.empty(this.dap_recentColorPalette)},_clearSuggestedSwatches:function(){_.empty(this.dap_suggestedColorPalette)},_clearSelection:function(){var t=this.css.selected,e="."+t;u(e,this.dap_paletteContainer).removeClass(t)},_highlightColor:function(t){var e,s=this.css.selected,o=this._findColorSwatch(t);o&&(t=i.normalizeColor(t),e=i.getContrastingColor(t),d.add(o,s),C.set(o,"borderColor",e.toHex()))},_findColorSwatch:function(t){var e,s=this._activePalette.get("colors"),o=this._colorInstance.setColor(t).toHex(),i=n.indexOf(s,o);return i>-1&&(e=this._swatches[o]),e},_enableTransparencySlider:function(){d.remove(this.dap_transparencyLabel,this.css.disabled),this.dap_transparencySlider.set("disabled",!1)},_disableTransparencySlider:function(){d.add(this.dap_transparencyLabel,this.css.disabled),this.dap_transparencySlider.set("disabled",!0)}});return P.NO_COLOR=S,g("extend-esri")&&h.setObject("dijit.ColorPicker",P,e),P});