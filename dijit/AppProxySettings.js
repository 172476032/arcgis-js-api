// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["require","dojo/_base/array","dojo/_base/declare","dojo/_base/lang","../kernel","dojo/uacss","dijit/_WidgetBase","../arcgis/AppProxyManager","../arcgis/utils","dojo/i18n!../nls/jsapi","dojo/Deferred","dojo/on","dojo/promise/all","dojo/query","dojo/string","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","dojo/store/Memory","dijit/form/CheckBox","dijit/form/Select","dijit/form/NumberSpinner","dgrid/OnDemandGrid","dgrid/editor","dojo/domReady!"],function(t,e,i,r,s,o,n,a,h,c,d,u,l,p,m,g,_,f,x,y,v,w,P,b){function j(t){return"second"===t?1:"minute"===t?60:"hour"===t?3600:"day"===t?86400:U}function S(t){return 1===t?"second":60===t?"minute":3600===t?"hour":86400===t?"day":I}var I="none",U=0,M=c.widgets.appProxySettings,A=i([v],{destroy:function(){if(this._destroyed||this._beingDestroyed)return void this.closeDropDown();this.inherited(arguments)}}),D=i([n],{declaredClass:"esri.dijit.AppProxySettings",_creditDomains:[/demographics\w*\.arcgis\.com/i,/geoenrich\w*\.arcgis\.com/i,/route\w*\.arcgis\.com/i,/logistics\w*\.arcgis\.com/i,/analysis\w*\.arcgis\.com/i,/elevation\w*\.arcgis\.com/i],_premiumDomains:[/traffic\w*\.arcgis\.com/i,/elevation\w*\.arcgis\.com/i,/geoenrich\w*\.arcgis\.com/i,/hydro\w*\.arcgis\.com/i,/naip\w*\.arcgis\.com/i,/livefeeds\w*\.arcgis\.com/i,/demographics\w*\.arcgis\.com/i,/landscape\w*\.arcgis\.com/i,/historical\w*\.arcgis\.com/i,/earthobs\w*\.arcgis\.com/i],defaults:{webmaps:[],proxyManagerOptions:{appid:""},proxies:[]},constructor:function(t){this._editing=!1,this.css={container:"esriAppProxySettings"};var e=r.mixin({},this.defaults,t);this.set(e),this.appProxyManager=new a(this.proxyManagerOptions),this.appProxyManager.loaded?this._init():u.once(this.appProxyManager,"load",r.hitch(this,function(){this._init()}))},startup:function(){this.inherited(arguments),this.loaded?this._createTable():u.once(this,"load",r.hitch(this,function(){this._createTable()}))},resize:function(){this._grid&&this._grid.resize()},_queryForSecureServices:function(t){return h.getItem(t).then(r.hitch(this,this._parseMap)).then(r.hitch(this,function(t){var i=this._mapsProxies;return e.forEach(t,r.hitch(this,function(t){i.push(t)})),t}))},_loaded:function(){this.set("loaded",!0),this.emit("load")},_itemInApp:function(t,i){return e.some(this._mapsProxies,function(e){if(e[t]===i.url)return e.title=i.title,!0})},_parseUrl:function(t){var e=document.createElement("a");return e.href=t,e},_consumesCredits:function(t){return e.some(this._creditDomains,function(e){return t.search(e)>-1})},_isPremium:function(t){return e.some(this._premiumDomains,function(e){return t.search(e)>-1})},_checkItem:function(t){var e=new d,i=this._parseUrl(t.url);return this._isPremium(i.host)?e.resolve({sourceUrl:t.url,id:t.id,title:t.title,proxyId:null,proxied:!1}):e.resolve(),e.promise},_parseMap:function(t){if(t&&t.itemData){var i=t.itemData.operationalLayers,s=[];return e.forEach(i,r.hitch(this,function(t){this._itemInApp("sourceUrl",t)||s.push(this._checkItem(t))})),l(s).then(function(t){var i=[];return e.forEach(t,function(t){t&&i.push(t)}),i})}var o=new d;return o.resolve(),o.promise},_getWebmapsProxies:function(){this._mapsProxies=this.proxies;for(var t=[],e=0,i=this.webmaps.length;e<i;e++)t.push(this._queryForSecureServices(this.webmaps[e]));return l(t)},_webmapsChanged:function(){var t=new d;return this.webmaps&&this.webmaps.length?this._getWebmapsProxies().then(r.hitch(this,function(){this.set("proxies",this._mapsProxies),t.resolve()})):t.resolve(),t.promise},_init:function(){var t=this.appProxyManager.proxies;e.forEach(t,r.hitch(this,function(t,e){if(!t.hasOwnProperty("title")){var i=this._parseUrl(t.sourceUrl);i&&i.host&&(t.title=m.substitute(M.untitled,{url:i.host}))}t.hasOwnProperty("proxied")||(t.proxied=!0,t.id="AppProxy"+e)})),this.proxies=t,this.webmaps&&this.webmaps.length?this._webmapsChanged().then(r.hitch(this,function(){this._loaded()})):this._loaded()},_createTable:function(){this._memoryStore=new x({data:this.proxies});var e=f.create("div",{className:this.css.container},this.domNode),s=i([P]);this._grid=new s({store:this._memoryStore,columns:{proxied:b({label:"",field:"proxied",canEdit:r.hitch(this,this._canToggleProxied),editor:y,get:r.hitch(this,this._getProxied),formatter:r.hitch(this,this._getFieldValue),editorArgs:{value:!0}}),title:{label:M.premiumContent,get:r.hitch(this,this._getTitle),formatter:function(e){return m.substitute(e,{url:'<img width="16" height="16" src="'+t.toUrl("../css/images/item_type_icons/premiumcredits16.png")+'" />'})}},requestLimit:b({label:M.requestLimit,field:"requestLimit",get:this._getHitsPerInterval,formatter:r.hitch(this,this._getFieldValue),canEdit:r.hitch(this,this._canUpdateField),editor:w,editorArgs:{constraints:{min:0},style:"width:75%;"}}),interval:b({label:M.interval,field:"interval",get:this._getInterval,formatter:r.hitch(this,this._getFieldValue),canEdit:r.hitch(this,this._canUpdateField),editor:A,editorArgs:{style:"width:75%;",options:[{value:"none",label:M.intervalNone},{value:"second",label:M.intervalSecond},{value:"minute",label:M.intervalMinute},{value:"hour",label:M.intervalHour},{value:"day",label:M.intervalDay}]}})}},e),this._grid.startup(),this.own(u(this._grid,"dgrid-datachange",r.hitch(this,function(t){function e(){this._editing=!1,this._grid.refresh()}var i=t.cell,s=i&&i.column&&i.column.field,o=t.value,n=i&&i.row&&i.row.data;s&&(n[s]=o);var a,h={proxyId:n.proxyId,proxyUrl:n.proxyUrl,sourceUrl:n.sourceUrl,proxied:n.proxied,hitsPerInterval:this._getHitsPerInterval(n),intervalSeconds:j(n.interval)};a=h.proxied?h.proxyId?this.appProxyManager.updateProxy(h).then(r.hitch(this,function(t){t&&(this._updateProxy(n,t),this.emit("update-proxy",n))})):this.appProxyManager.createProxies([h]).then(r.hitch(this,function(t){t&&(this._updateProxy(n,t),this.emit("create-proxy",n))})):this.appProxyManager.deleteProxies([h]).then(r.hitch(this,function(t){t&&(this._updateProxy(n,t),this.emit("delete-proxy",n))})),this._editing=!0,this._grid.refresh(),a.then(r.hitch(this,e)).otherwise(r.hitch(this,e))})))},_getFieldValue:function(t){return this._editing?'<span class="esriAppProxyLoading"></span>':t},_canUpdateField:function(t){return!this._editing&&this._getProxied(t)},_canToggleProxied:function(){return!this._editing},_updateProxy:function(t,i){this._memoryStore&&e.some(i,r.hitch(this,function(e){if(e.sourceUrl===t.sourceUrl){var i=r.mixin(t,{proxied:t.proxied,proxyId:t.proxied?e.proxyId:void 0});return t=i,this._memoryStore.put(i,{overwrite:!0}),!0}}))},_getTitle:function(t){var e=t.title;return this._consumesCredits(t.sourceUrl)&&(e+=" ${url}"),e},_getProxied:function(t){return t&&!!t.proxied},_getInterval:function(t){var e=t.interval||S(t.intervalSeconds);return t&&e&&t.proxied?e:I},_getHitsPerInterval:function(t){var e="number"==typeof t.requestLimit?t.requestLimit:t.hitsPerInterval;return t&&e&&t.proxied?e:0},_setWebmapsAttr:function(t){var e=t.slice();this._set("webmaps",e),this._created&&this._memoryStore&&this._webmapsChanged()},_setProxiesAttr:function(t){var e=t.slice();this._set("proxies",e),this._created&&this._memoryStore&&(this._memoryStore.setData(this.proxies),this._grid.set("store",this._memoryStore))}});return o("extend-esri")&&r.setObject("dijit.AppProxySettings",D,s),D});