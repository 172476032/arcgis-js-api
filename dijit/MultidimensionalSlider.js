// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.17/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/has","dojo/on","dojo/json","dijit/form/VerticalSlider","dojox/form/VerticalRangeSlider","dijit/form/VerticalRule","dijit/form/VerticalRuleLabels","dijit/form/HorizontalSlider","dojox/form/HorizontalRangeSlider","dijit/form/HorizontalRule","dijit/form/HorizontalRuleLabels","dijit/_Widget","dijit/_Templated","dojox/timing/_base","dojo/_base/array","dojo/Deferred","dojo/DeferredList","../layers/MosaicRule","../layers/DimensionalDefinition","../kernel","../lang","./_EventedWidget","dojo/text!./templates/MultidimensionalSlider_vertical.html","dojo/text!./templates/MultidimensionalSlider_horizontal.html","dojo/i18n!../nls/jsapi","dojo/dom-class","dojo/dom-style","dojo/dom-geometry","dojo/touch","dojo/query","dojo/dom-construct"],function(e,i,t,s,n,a,l,o,h,r,u,d,m,c,_,f,g,p,v,V,b,y,S,R,L,C,D,N,I,x,j,O,A){var M={LAYOUT_VERTICAL:"vertical",LAYOUT_HORIZONTAL:"horizontal"},H=e([R,c,_],{declaredClass:"esri.dijit.MultidimensionalSlider",widgetsInTemplate:!0,templateString:L,nLabels:10,_thumbCount:1,useRanges:!1,loop:!0,useLayersDimSlices:!0,prefetch:!0,prefetchedValues:{},showPlayButton:!0,prefetchFactor:2,_hasUnitConflict:!1,_update:!0,playDirectionAscending:!0,unitSymbols:{meter:"m",pascal:"Pa"},_eventMap:{"dimension-value-change":!0,play:!0,pause:!0,next:!0,previous:!0,change:!0,"dimension-array-create":!0},onChange:function(){},onPlay:function(){},onPause:function(){},onDimensionValueChange:function(){},_onPlay:function(){this.playing=!this.playing,this._updateUI(),this.playing?(this._timer.start(),this.onPlay()):(this._timer.stop(),this.onPause())},constructor:function(i){e.safeMixin(this,i),this.playing=!1,this._iconClass="mdsButton mdsPlayButton",this.map&&this._getImageLayers(),this.layout===M.LAYOUT_HORIZONTAL&&(this.templateString=C),this.thumbMovingRate=this.thumbMovingRate||3e3,this._i18n=D,this.prefetchImgNodes={}},postCreate:function(){this.inherited(arguments)},startup:function(){this.inherited(arguments);var e=this;this._getAllLayersMDInfo().then(function(){e._sortDimensionValues(),e.dimensionValues=e.dimensionValues&&e.dimensionValues.length&&!e.useLayersDimValues?e.dimensionValues:e._mapSortedDimensionValues,e.getUnit(),e._setupSlider(!0)}),this._timer=new f.Timer,this._timer.setInterval(this.thumbMovingRate),this._timer.onTick=i.hitch(this,function(){this._bumpSlider(this.playDirectionAscending?1:-1)}),this.layout===M.LAYOUT_VERTICAL&&(this.computeSliderStyle(),this.on("resize",i.hitch(this,"computeSliderStyle"))),this._setupHandles()},_insertPassiveLabels:function(){var e=O(".dijitSliderMoveable.dijitSliderMoveableV",this.domNode);this._passiveLbl1=A.create("div"),N.add(this._passiveLbl1,"esriMdSliderPassiveLbl"),A.place(this._passiveLbl1,e[0]),2===this._thumbCount&&(this._passiveLbl2=A.create("div"),N.add(this._passiveLbl2,"esriMdSliderPassiveLbl"),A.place(this._passiveLbl2,e[1]))},_setupHandles:function(){this._eventHandles=[],this._eventHandles.push(s(this.domNode,"mouseover",i.hitch(this,"activateSlider"))),this._eventHandles.push(s(this.domNode,"mouseleave",i.hitch(this,"deactivateSlider"))),this._eventHandles.push(s(this.domNode,j.press,i.hitch(this,"activateSlider"))),this._eventHandles.push(s(this.domNode,j.release,i.hitch(this,"deactivateSlider"))),this._eventHandles.push(s(this.prevBtn.domNode,j.press,i.hitch(this,"activateSlider"))),this._eventHandles.push(s(this.playPauseBtn.domNode,j.press,i.hitch(this,"activateSlider"))),this._eventHandles.push(s(this.nextBtn.domNode,j.press,i.hitch(this,"activateSlider")));var e=O(".dijitSliderImageHandle.dijitSliderImageHandleV",this.domNode);g.forEach(e,function(e){this._eventHandles.push(s(e,j.press,i.hitch(this,"activateSlider"))),this._eventHandles.push(s(e,j.release,i.hitch(this,"deactivateSlider")))},this)},_removeHandles:function(){g.forEach(this._eventHandles,function(e){e&&e.remove()})},activateSlider:function(){dojo.isIE<9&&dojo.style(this.domNode,"background","#fff"),this.sliderActive=!0,this.deactivateTimer&&clearTimeout(this.deactivateTimer),N.remove(this.domNode,"esriMdSliderPassive"),N.add(this.domNode,"esriMdSliderActive"),I.set(this._passiveLbl1,"display","none"),this._passiveLbl2&&I.set(this._passiveLbl2,"display","none")},deactivateSlider:function(){if(!(dojo.isIE<10)){var e=this;this.deactivateTimer=setTimeout(function(){e.sliderActive=!1,e.updatePassiveLabels(),N.remove(e.domNode,"esriMdSliderActive"),N.add(e.domNode,"esriMdSliderPassive"),e._showPassiveLabels()},2500)}},updatePassiveLabels:function(){this._slider&&S.isDefined(this._slider.value)&&(this._passiveLbl1.innerHTML=this.value.length?this.value[0]:this.value,this._slider.value.length&&(this._passiveLbl2.innerHTML=this.value[1]),this.sliderActive||this._showPassiveLabels())},_showPassiveLabels:function(){S.isDefined(this.value)&&(I.set(this._passiveLbl1,"display","inline-block"),this.value.length?I.set(this._passiveLbl2,"display","inline-block"):this._passiveLbl2&&I.set(this._passiveLbl2,"display","none"))},increment:function(){var e=1;!this.playDirectionAscending&&this.playing&&(e=-1),this._bumpSlider(e)},decrement:function(){var e=-1;!this.playDirectionAscending&&this.playing&&(e=1),this._bumpSlider(e)},_setDimensionAttr:function(e){var i=S.isDefined(i)?!1:!0;this._slider&&(e.dimension&&(this.dimension=e.dimension),this.dimensionValues=e.dimensionValues&&e.dimensionValues.length?e.dimensionValues:[],this.update(!1))},update:function(e){var i=this;this._mapSortedDimensionValues=[],this._getImageLayers(),this.value=e?this.dimensionValues[this._slider.value]:null,this._getAllLayersMDInfo().then(function(){i._sortDimensionValues(),i.getUnit(),i.dimensionValues&&i.dimensionValues.length&&!i.useLayersDimSlices||(i.dimensionValues=i._mapSortedDimensionValues),i._setupSlider(e)})},pause:function(){this.playing=!1,this._updateUI(),this._timer.stop()},play:function(e){this.playing!==!0&&(e=e?!0:!1,this.playing=!1,this._onPlay())},_setupSlider:function(e){this._destroySlider(),this.dimensionValues&&this.dimensionValues.length&&(this.sliderNode=document.createElement("div"),this._getDimensionAlias(),this._layers&&this._layers.length&&1===this._layers.length&&e&&this._readMosaicRule(),this._createRule(),this._createLabels(),this._createSlider(),this._insertPassiveLabels(),this._slider.onChange(this._slider.value))},_createLabels:function(){this.layout===M.LAYOUT_HORIZONTAL?this._createHorizontalLabels():this._createVerticalLabels()},_createRule:function(){this.layout===M.LAYOUT_HORIZONTAL?this._createHorizontalRule():this._createVerticalRule()},_createVerticalLabels:function(){this.labelsNode=document.createElement("div"),this.sliderNode.appendChild(this.labelsNode),this._sliderLabels=new h({labels:this._filterLabels(),labelStyle:"font-size: 83%; padding-left: 5px;"},this.labelsNode)},_createVerticalRule:function(){this.rulesNode=document.createElement("div"),this.sliderNode.appendChild(this.rulesNode),this.dimensionValues.length<=100&&(this._sliderRules=new o({count:this.dimensionValues.length,style:"width:5px;"},this.rulesNode),this._sliderRules.startup())},_createHorizontalLabels:function(){this.labelsNode=document.createElement("div"),this.sliderNode.appendChild(this.labelsNode),this._sliderLabels=new m({labels:this._filterLabels(),labelStyle:"font-size: 83%"},this.labelsNode)},_createHorizontalRule:function(){this.rulesNode=document.createElement("div"),this.sliderNode.appendChild(this.rulesNode),this.dimensionValues.length<=100&&(this._sliderRules=new d({count:this.dimensionValues.length,style:"height:5px;"},this.rulesNode),this._sliderRules.startup())},_createHorizontalSingleSlider:function(e){e=e?e:this.playDirectionAscending?0:this.dimensionValues.length-1,this._slider=new r({name:"horizontal",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:"width: 100%;",increment:i.hitch(this,"increment"),decrement:i.hitch(this,"decrement"),value:e||0,onChange:i.hitch(this,this._onSingleSliderChange),showButtons:!1},this.sliderNode),this._slider.startup()},_createHorizontalRangeSlider:function(e){e=e?e:this.playDirectionAscending?[0,1]:[this.dimensionValues.length-2,this.dimensionValues.length-1],this._slider=new u({name:"horizontal",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:"width:100%;",increment:i.hitch(this,"increment"),decrement:i.hitch(this,"decrement"),value:e||[0,1],onChange:i.hitch(this,this._onRangeSliderChange),showButtons:!1},this.sliderNode),this._slider.startup(),s(this._slider.incrementButton,"click",this._slider.increment),s(this._slider.decrementButton,"click",this._slider.decrement),this._slider._typematicCallback=function(){}},_createVerticalSingleSlider:function(e){e=e?e:this.playDirectionAscending?0:this.dimensionValues.length-1,this._slider=new a({name:"vertical",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:this.computeSliderStyle(),increment:i.hitch(this,"increment"),decrement:i.hitch(this,"decrement"),value:e||0,onChange:i.hitch(this,this._onSingleSliderChange),showButtons:!1},this.sliderNode),this._slider.startup()},_createVerticalRangeSlider:function(e){e=e?e:this.playDirectionAscending?[0,1]:[this.dimensionValues.length-2,this.dimensionValues.length-1],this._slider=new l({name:"vertical",minimum:0,maximum:this.dimensionValues.length-1,intermediateChanges:!1,discreteValues:this.dimensionValues.length,style:this.computeSliderStyle(),increment:i.hitch(this,"increment"),decrement:i.hitch(this,"decrement"),value:e||[0,1],onChange:i.hitch(this,this._onRangeSliderChange),showButtons:!1},this.sliderNode),this._slider.startup(),this._slider._typematicCallback=function(){}},_onSingleSliderChange:function(e){var i=this.dimensionValues[e];this.setDimensionInfoText(i),g.forEach(this._layers,function(t){this._updateMosaicRule(t,i),this.prefetch&&this.playing&&this._prefetchData(e,t)},this),this._oldValue=e,this.value=i,this.updatePassiveLabels(),this.onChange(i)},_onRangeSliderChange:function(e){if(this._update){this._snap&&(e=this._snapToNearestRange(e));var t=[this.dimensionValues[e[1]],this.dimensionValues[e[0]]];t.sort(this._sortCompareFunction),this.value=t,this.setDimensionInfoText(t),this.updatePassiveLabels(),g.forEach(this._layers,function(i){this._updateMosaicRule(i,t),this.prefetch&&this.playing&&this._prefetchData(e,i)},this),this._update=!0,this._oldValue=i.clone(e),this.onChange(t)}},destroy:function(){this.inherited(arguments),this._timer.stop(),this._destroySlider(),this._removeHandles()},_destroySlider:function(){this._slider&&(this._slider.destroy(),this._slider=null)},_createSlider:function(){var e;this.mdSliderCell.appendChild(this.sliderNode),this.value&&this.value.length?e=g.indexOf(this.dimensionValues,this.value[0])>=0&&g.indexOf(this.dimensionValues,this.value[1])>=0?[g.indexOf(this.dimensionValues,this.value[0]),g.indexOf(this.dimensionValues,this.value[1])]:[0,1]:this.value&&(e=g.indexOf(this.dimensionValues,this.value)>=0?g.indexOf(this.dimensionValues,this.value):0),2===this._thumbCount?this.layout===M.LAYOUT_HORIZONTAL?this._createHorizontalRangeSlider(e):this._createVerticalRangeSlider(e):this.layout===M.LAYOUT_HORIZONTAL?this._createHorizontalSingleSlider(e):this._createVerticalSingleSlider(e)},_getMultidimensionalInfo:function(e){function i(){e.getMultidimensionalInfo().then(function(i){e.multidimensionalInfo=i,t.resolve(e)},function(e){t.reject(e)})}var t=new p;return e.multidimensionalInfo?t.resolve(e):e.loaded?i():e.on("load",function(){i()}),t},_getAllLayersMDInfo:function(){var e=[];g.forEach(this._layers,function(i){e.push(this._getMultidimensionalInfo(i))},this);var i=new v(e);return i},_getImageLayers:function(){var e,i=this.map.layerIds.concat(this.map.graphicsLayerIds);return this._layers=[],g.forEach(i,function(i){e=this.map.getLayer(i),("esri.layers.ArcGISImageServiceLayer"===e.declaredClass||"esri.layers.ArcGISImageServiceVectorLayer"===e.declaredClass||"esri.layers.RasterLayer"===e.declaredClass)&&this._layers.push(e)},this),this._layers},_sortCompareFunction:function(e,i){return S.isDefined(e)&&S.isDefined(i)?e-i:!1},_getDimensionObjects:function(){function e(e){if(e&&e.values&&e.hasRanges){var i=[];g.forEach(e.values,function(e){e.length?i=t(i,e):i.push.apply(t(i.sort(this._sortCompareFunction),[e]))},this),i=i.sort(s._sortCompareFunction),e.decodedValues=i}return e}var t=this._merge,s=this;this._allRangeValues=!0,this._thumbCount=1,this._snap=!1,this._dimensionObjects=[],this._layers=this._filterLayers(),g.forEach(this._layers,function(e){e.multidimensionalInfo&&g.some(e.multidimensionalInfo.variables,function(e){g.some(e.dimensions,function(e){return e.name!==this.dimension||e.hasRanges?void 0:void(this._allRangeValues=!1)},this)},this)},this),this.useRanges?(this._thumbCount=2,this._snap=!1):this._allRangeValues&&this.useLayersDimSlices?(this._thumbCount=2,this._snap=!0):this._snap=!1,g.forEach(this._layers,function(t){t.multidimensionalInfo&&g.some(t.multidimensionalInfo.variables,function(t){g.some(t.dimensions,function(t){t.name===this.dimension&&(this._allRangeValues&&t.hasRanges||this.useRanges?this._dimensionObjects.push(e(i.clone(t))):!this._allRangeValues&&t.hasRanges||this._dimensionObjects.push(i.clone(t)))},this)},this)},this)},_merge:function(e,i){for(var t=[],s=0,n=0;s<e.length&&n<i.length;)e[s]<i[n]?t.push(e[s++]):e[s]>i[n]?t.push(i[n++]):(t.push(i[n++]),s++);return t=t.concat(e.slice(s)).concat(i.slice(n)),t=g.filter(t,function(e,i,t){return t.indexOf(e)===i})},_mergeRangeArrays:function(e,i){for(var t=[],s=0,n=0;s<e.length&&n<i.length;)e[s][0]<i[n][0]||e[s][0]===i[n][0]&&e[s][1]<i[n][1]?t.push(e[s++]):e[s][0]>i[n][0]||e[s][0]===i[n][0]&&e[s][1]>i[n][1]?t.push(i[n++]):(t.push(i[n++]),s++);return t=t.concat(e.slice(s)).concat(i.slice(n)),t=g.filter(t,function(e,i,t){return t.indexOf(e)===i},this)},_sortDimensionValues:function(){var e=0,i=this._merge,t=this._mergeRangeArrays;if(this._getDimensionObjects(),this._dimensionObjects.length>=1&&(this._mapSortedDimensionValues=this._dimensionObjects[0].decodedValues||this._dimensionObjects[0].values,this._allRangeValues&&(this._dimensionRangeValues=this._dimensionObjects[0].values)),this._dimensionObjects.length>1)for(e=1;e<this._dimensionObjects.length;e++)this._mapSortedDimensionValues=i(this._mapSortedDimensionValues,this._dimensionObjects[e].decodedValues||this._dimensionObjects[e].values),this._allRangeValues&&(this._dimensionRangeValues=t(this._dimensionRangeValues,this._dimensionObjects[e].values))},_createDimensionalDefinition:function(e,i){var t=[e],s=new b({variableName:i,dimensionName:this.dimension,values:t,isSlice:1===t.length});return s},_updateMosaicRule:function(e,i){var t=!1,s=e.mosaicRule||e.defaultMosaicRule||new V({multidimensionalDefinition:[]}),n=s.multidimensionalDefinition||[];i.length&&i.sort(this._sortCompareFunction),g.forEach(n,function(e){e.dimensionName===this.dimension&&(e.values=[i],e.isSlice=!this.useRanges,t=!0)},this),t||g.some(e.multidimensionalInfo.variables,function(e){return g.some(e.dimensions,function(e){return e.name===this.dimension?!0:void 0},this)?!0:void 0},this)&&(n.push(this._createDimensionalDefinition(i,"")),t=!0),t&&(s.multidimensionalDefinition=n,e.setMosaicRule(s))},_prefetchData:function(e,t){if(t&&t.mosaicRule){var s,a,l,o,h,r=!1,u=this;for(this.prefetchedValues[t.id]||(this.prefetchedValues[t.id]=[]),this.prefetchImgNodes[t.id]=[],a=i.clone(t._params),l=i.clone(t.mosaicRule),s=1;s<=this.prefetchFactor;s++)r=!1,g.forEach(l.multidimensionalDefinition,function(i){i.dimensionName===this.dimension&&(this.playDirectionAscending?e.length?(this.snap?(o=this._getNextRangeIndex(e)||e,i.values=[this.dimensionValues[o[0]],this.dimensionValues[o[1]]]):i.values=[this.dimensionValues[(e[0]+s)%this.dimensionValues.length],this.dimensionValues[(e[1]+s)%this.dimensionValues.length]],i.values.sort(this._sortCompareFunction)):i.values=[this.dimensionValues[(e+s)%this.dimensionValues.length]]:e.length?(this.snap?(o=this._getNextRangeIndex(e,-1)||e,i.values=[this.dimensionValues[o[0]],this.dimensionValues[o[1]]]):i.values=[this.dimensionValues[(this.dimensionValues.length+e[0]-s)%this.dimensionValues.length],this.dimensionValues[(this.dimensionValues.length+e[1]-s)%this.dimensionValues.length]],i.values.sort(this._sortCompareFunction)):i.values=[this.dimensionValues[(this.dimensionValues.length+e-s)%this.dimensionValues.length]],g.some(this.prefetchedValues[t.id],function(e){return n.stringify(e)===n.stringify(i.values)?!0:void 0})||(r=!0,this.prefetchedValues[t.id].push(i.values)))},this),r&&(a.mosaicRule=n.stringify(l.toJson()),t.getImageUrl(this.map.extent,this.map.width,this.map.height,function(e){h=new Image,u.prefetchImgNodes[t.id].push(h),h.src=e},a))}},setDimensionInfoText:function(e){if(S.isDefined(e)){var t=this.unitSymbol||this.unit;if("number"!=typeof e){var s=i.clone(e.sort(this._sortCompareFunction));(s[0]%1!==0||s[1]%1!==0)&&(s[0]=parseFloat(s[0].toFixed(2)),s[1]=parseFloat(s[1].toFixed(2))),e="["+s[0]+", "+s[1]+"]"}else e%1!==0&&(e=e.toFixed(2));this.dimensionInfo.innerHTML=this.unitSymbol?"<label style='font-weight:700;'>"+this.dimensionAlias+" ("+t+")</label>":"<label style='font-weight:700;'>"+this.dimensionAlias+"</label>",this.dimensionInfo.innerHTML+=this.layout===M.LAYOUT_HORIZONTAL?": "+e:"<br/> "+e}},setLabels:function(){},_filterLabels:function(){if(this.nLabels&&this.dimensionValues&&this.dimensionValues.length){var e=Math.ceil(this.dimensionValues.length/this.nLabels),i=g.map(this.dimensionValues,function(i,t){return t%e===0||t===this.dimensionValues.length-1?(i%1!==0&&(i=parseFloat(i.toFixed(2))),i):""},this);return i}},_filterLayers:function(){return g.filter(this._layers,function(e){return e.multidimensionalInfo&&e.visible&&e.useMapDimensionValue&&g.some(e.multidimensionalInfo.variables,function(e){return g.some(e.dimensions,function(e){return e.name===this.dimension?!0:void 0},this)?!0:void 0},this)?!0:void 0},this)},_updateUI:function(){N.remove(this.playPauseBtn.iconNode,this._iconClass),this._iconClass=this.playing?"mdsButton mdsPauseButton":"mdsButton mdsPlayButton",N.add(this.playPauseBtn.iconNode,this._iconClass)},_bumpSlider:function(e){var i=this._slider.value;e>=0?!this._snap&&(0>i||i>=this.dimensionValues.length-1||i[0]>=this.dimensionValues.length-1||i[1]>=this.dimensionValues.length-1)?this._timer.isRunning&&(this.loop?(this._timer.stop(),this.prefetchedValues={},this.prefetchImgNodes={},2===this._thumbCount?this._snap?this._slider.set("value",this._getNextRangeIndex(i)):this._slider.set("value",[0,Math.abs(i[0]-i[1])]):this._slider.set("value",0),this._timer.start(),this.playing=!0):this.pause()):2===this._thumbCount&&!this._snap&&i[0]<this.dimensionValues.length-1&&i[1]<this.dimensionValues.length-1?this._slider.set("value",[i[0]+1,i[1]+1]):1===this._thumbCount&&i<this.dimensionValues.length-1?this._slider.set("value",i+1):this._snap&&this._slider.set("value",this._getNextRangeIndex(i)):0>=i||i[0]<=0||i[1]<=0?this._timer.isRunning&&(this.loop?(this._timer.stop(),this.prefetchedValues={},2===this._thumbCount?this._snap?this._slider.set("value",this._getNextRangeIndex(i,-1)):this._slider.set("value",[this.dimensionValues.length-1,this.dimensionValues.length-1-Math.abs(i[0]-i[1])]):this._slider.set("value",this.dimensionValues.length-1),this._timer.start(),this.playing=!0):this.pause()):(i>=0||i[1]>=0)&&(2===this._thumbCount&&i[1]>0&&i[0]>0?this._snap?this._slider.set("value",this._getNextRangeIndex(i,-1)):this._slider.set("value",[i[0]-1,i[1]-1]):1===this._thumbCount&&i>0&&this._slider.set("value",i-1))},setThumbMovingRate:function(e){this.thumbMovingRate=e,this._timer&&this._timer.setInterval(this.thumbMovingRate)},getFullDimensionRange:function(e){e=e||this.dimension;var i,t;return g.forEach(this._layers,function(s){s.multidimensionalInfo&&s.multidimensionalInfo.variables&&g.forEach(s.multidimensionalInfo.variables,function(s){g.forEach(s.dimensions,function(s){s.name===e&&s.extent&&s.extent.length&&s.extent.length>1&&((!S.isDefined(i)||s.extent[0]<i)&&(i=s.extent[0]),(!S.isDefined(t)||s.extent[1]>t)&&(t=s.extent[1]))},this)},this)},this),[i,t]},setThumbCount:function(e){this._thumbCount=2==e?2:1,this.value=this.dimensionValues[this._slider.value],this._setupSlider()},clearDimensionalDefinition:function(e){var i,t,s=[];e&&e.mosaicRule&&e.mosaicRule.multidimensionalDefinition&&(t=e.mosaicRule,i=t.multidimensionalDefinition,g.forEach(i,function(e){e.dimensionName!==this.dimension&&s.push(e)},this),t.multidimensionalDefinition=s,e.setMosaicRule(t))},getUnit:function(){var e=null,i=!1;return this.unit=null,g.forEach(this._layers,function(t){t.multidimensionalInfo&&g.forEach(t.multidimensionalInfo.variables,function(t){g.forEach(t.dimensions,function(t){if(t.name===this.dimension&&t.unit)if(null!=e||i){if(S.isDefined(t.unit)&&t.unit.replace("esri","").toLowerCase()!==e.toLowerCase())return e=null,void(i=!0)}else e=t.unit.replace("esri","")},this)},this)},this),e&&(e=e.replace("esri","")),this.unit=e,this.unitSymbol=this.getUnitSymbol(),this._hasUnitConflict=i,e},_getDimensionAlias:function(){this.dimensionAlias=this.dimension,g.some(this._layers,function(e){return e.fields&&e.fields.length&&g.some(e.fields,function(e){return e.name&&e.name===this.dimension&&e.alias?(this.dimensionAlias=e.alias,!0):void 0},this)?!0:void 0},this)},_readMosaicRule:function(){var e;g.forEach(this._layers,function(i){i.mosaicRule&&i.mosaicRule.multidimensionalDefinition&&g.forEach(i.mosaicRule.multidimensionalDefinition,function(i){i&&i.dimensionName===this.dimension&&i.values&&(e=i.values.length&&i.values[0]&&i.values[0].length?i.values[0]:i.values)},this)},this),e&&(1===e.length?(this._thumbCount=1,this.useRanges=!1,this.value=e[0]):(this._thumbCount=2,this.useRanges=!0,this.value=e))},hasUnitConflict:function(){return this.getUnit(),this._hasUnitConflict},resizeSlider:function(e,i){I.set(this.domNode,{height:e+"px",width:i+"px"}),I.set(this.mdSliderTable,{height:e+"px",width:i+"px"}),this.computeSliderStyle()},computeSliderStyle:function(){var e,i;return e=x.getContentBox(this.domNode).h-x.getContentBox(this.dimensionInfo).h-(x.getContentBox(this.playPauseBtnRow).h+20),t("ie")<=10&&(e-=53),i="height: "+e+"px;",this._slider&&this._slider.domNode&&I.set(this._slider.domNode,"height",e+"px"),i},getUnitSymbol:function(){if(!S.isDefined(this.unit))return null;var e=this.unit.toLowerCase();return"meters"===e||"meter"===e?this.unitSymbols.meter:"pascal"===e||"pascals"===e?this.unitSymbols.pascal:void 0},_snapToNearestRange:function(e){if(e&&e.length&&this._snap){var t,s,n,a,l,o,h,r,u=this;return a=[this.dimensionValues[e[1]],this.dimensionValues[e[0]]],a.sort(this._sortCompareFunction),g.some(this._dimensionObjects,function(e){return g.some(e.values,function(e){return e&&e.length&&e[0]===a[0]&&e[1]===a[1]?!0:void 0})?!0:void 0},this)?e:(g.some(this._dimensionObjects,function(e){return g.some(e.values,function(e){return e&&e.length&&e[0]===a[0]?(t=i.clone(e.sort(this._sortCompareFunction)),!0):void 0},this)?!0:void 0},this)&&(g.some(this.dimensionValues,function(e,i){e===t[0]&&(s=i),e===t[1]&&(n=i)}),h=Math.abs(e[0]-s),l=[s,n]),g.some(this._dimensionObjects,function(e){return g.some(e.values,function(e){return e&&e.length&&e[1]===a[1]?(t=i.clone(e.sort(this._sortCompareFunction)),!0):void 0},this)?!0:void 0},this)&&(g.some(this.dimensionValues,function(e,i){e===t[1]&&(n=i),e===t[0]&&(s=i)}),r=Math.abs(e[1]-n),o=[s,n]),e=h&&r?this._oldValue&&this._oldValue.length&&this._arraysEqual(this._oldValue,l)?o:this._oldValue&&this._oldValue.length&&this._arraysEqual(this._oldValue,o)?l:r>=h?l:o:l||o||e,this._update=!1,setTimeout(function(){u._slider.set("value",e)},100),e)}},_arraysEqual:function(e,i){var t;if(!S.isDefined(e)||!S.isDefined(i))return!1;if(e===i)return!0;if(e.length!==i.length)return!1;for(e.sort(this._sortCompareFunction),i.sort(this._sortCompareFunction),t=0;t<e.length;++t)if(e[t]!==i[t])return!1;return!0},_getNextRangeIndex:function(e,i){if(!this._dimensionRangeValues||!this._dimensionRangeValues.length)return null;var t,s,n,a,l;return i=S.isDefined(i)?i:1,g.some(this._dimensionRangeValues,function(i,s){return this._arraysEqual(i,[this.dimensionValues[e[0]],this.dimensionValues[e[1]]])?(t=s,!0):void 0},this),s=i>0?(t+1)%this._dimensionRangeValues.length:(this._dimensionRangeValues.length+t-1)%this._dimensionRangeValues.length,n=this._dimensionRangeValues[s],g.some(this.dimensionValues,function(e,i){return e===n[0]&&(a=i),e===n[1]&&(l=i),a&&l?!0:void 0},this),[a,l]}});return i.mixin(H,M),t("extend-esri")&&i.setObject("dijit.MultidimensionalSlider",H,y),H});