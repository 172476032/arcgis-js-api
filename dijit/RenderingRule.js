// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.19/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/connect","dojo/_base/array","dojo/dom-style","dojo/i18n!../nls/jsapi","dojo/text!./templates/RenderingRule.html","dojo/store/Memory","dojo/has","../kernel","../layers/RasterFunction","../geometry/Extent","./ColorRampSelector","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/Tooltip","dijit/form/HorizontalSlider","dijit/form/HorizontalRuleLabels","dijit/form/FilteringSelect","dijit/form/NumberTextBox"],function(e,t,n,i,a,s,r,o,l,d,h,c,u,m,p,g,_){var y=e([m,p,g],{declaredClass:"esri.dijit.RenderingRule",templateString:r,widgetsInTemplate:!0,layer:null,map:null,hideApplyButton:!1,_renderingRuleObject:null,_rasterFunctionData:[],_rasterFunctionStore:null,_cachedFunctionList:[],_cachedkeyProperties:{},_pendingDfds:{},_redBandIdStore:null,_greenBandIdStore:null,_blueBandIdStore:null,_donotSaveChanges:!1,_resetBandCombination:!1,_serviceBandCount:3,_defaultBandCombinationFncName:"User Defined Renderer",_firstFncInRenderingRuleList:null,_gammaSliderTooltip:null,constructor:function(t){e.safeMixin(this,t),this._i18n=s,this._defaultBandCombinationFncName=this._i18n.widgets.renderingRule.userDefinedRendererTitle,this._renderingRuleObject=new h},startup:function(){this.inherited(arguments),n.connect(this.rasterFunctionList,"onChange",t.hitch(this,"_onRasterFunctionChange")),n.connect(this.stretchMethodList,"onChange",t.hitch(this,"_onStretchMethodChange")),n.connect(this.gammaSlider,"onChange",t.hitch(this,"_onGammaChange")),n.connect(this.gammaSlider,"onMouseLeave",t.hitch(this,"_onGammaMouseLeave")),n.connect(this._apply,"onclick",t.hitch(this,"_onClickApplyRenderingRule")),n.subscribe("onRenderingRuleApply",t.hitch(this,"_onClickApplyRenderingRule")),n.subscribe("onRenderingRuleReset",t.hitch(this,"_onClickResetRenderingRule")),this.hideApplyButton&&(this._apply.style.display="none")},_getColorMapFunction:function(e){var t=new h;return this.colorRampSelect.colorRampName?t.functionArguments={colorRamp:this.colorRampSelect.colorRampName}:t.functionArguments={Colormap:this.colorRampSelect.colorMap},t.variableName="Raster",t.functionName="Colormap",t},destroy:function(){this._pendingDfds=null,this._gammaSliderTooltip&&(this._gammaSliderTooltip.destroy(),this._gammaSliderTooltip=null),this.inherited(arguments)},_setLayerAttr:function(e){if(e){this.inherited(arguments),this.layer=e,this._donotSaveChanges=!0,this._firstFncInRenderingRuleList=null,this._fillStretchMehodList(),this._hideStretch();var i=t.hitch(this,"_setupDefaults");this.layer.loaded?this._setupDefaults():n.connect(this.layer,"onLoad",i),this._donotSaveChanges=!1}},_setupDefaults:function(){this._setupBandIdDefaults(),this._setupColorRampDefaults(),this._setupStretchDefaults(),this._setupRenderingRuleDefaults()},_setupRenderingRuleDefaults:function(){if(this.layer){this._rasterFunctionData=[];var e;for(e=0;e<this._cachedFunctionList.length;e++){var t=this._cachedFunctionList[e];if(t&&this.layer===t.layer)return this._rasterFunctionData=t.data,void this._setupFunctionStore()}this._fillRasterFunctionList(this.layer)}},_setupFunctionStore:function(){if(!this.layer)return void console.log("Could not populate renderers as the layer does not exists");this._rasterFunctionStore=new o({data:this._rasterFunctionData,idProperty:"name"}),this.rasterFunctionList.set("store",this._rasterFunctionStore),this.rasterFunctionList.set("labelAttr","label"),this.rasterFunctionList.set("labelType","html");var e=this.layer.renderingRule,t="";t=e&&e.functionName?"stretch"!==e.functionName.toLowerCase()&&"colormap"!==e.functionName.toLowerCase()?e.functionName:this._getRenderingRuleNameFromStretchFunction(e)||this._defaultBandCombinationFncName:this._firstFncInRenderingRuleList&&"none"!==this._firstFncInRenderingRuleList.toLowerCase()?this._firstFncInRenderingRuleList:this._defaultBandCombinationFncName,t&&(this._rasterFunctionStore.get(t)||"Colormap"===t)&&(this.rasterFunctionList.set("value",t),this._onRasterFunctionChange())},_fillRasterFunctionList:function(e){if(this.layer&&(this._rasterFunctionData=[],null!==e&&null!==e.extent)){var n=new c(e.extent.xmin,e.extent.ymin,e.extent.xmax,e.extent.ymax,e.extent.spatialReference),a=n.getWidth(),s=n.getHeight();if(a/s>=2||s/a>=2){var r=Math.min(a,s)/2,o=n.getCenter();n.update(o.x-r,o.y-r,o.x+r,o.y+r,e.extent.spatialReference)}var l=n.xmin+","+n.ymin+","+n.xmax+","+n.ymax,d=e._getToken(),h="";d&&(h="&token="+d);var u=this.layer.url+"/exportImage?bbox="+l+h+"&imageSize=400,400&f=image&renderingRule=",m=this.layer.bandIds,p=u;m&&m.length>=3&&(p=u+"&bandIds="+m[0]+","+m[1]+","+m[2]),this._addFunctionItemToList(this._defaultBandCombinationFncName,this._defaultBandCombinationFncName,this._i18n.widgets.renderingRule.userDefinedRendererDesc,p,""),e.rasterFunctionInfos&&e.rasterFunctionInfos.length>0&&i.forEach(e.rasterFunctionInfos,t.hitch(this,function(e){if(null===this._firstFncInRenderingRuleList&&(this._firstFncInRenderingRuleList=e.name),"none"!==e.name.toLowerCase()){var t='{"rasterFunction":"'+e.name+'"}';this._addFunctionItemToList(e.name,e.name,e.description,u,t)}}));var g={};g.layer=this.layer,g.data=this._rasterFunctionData,this._cachedFunctionList.push(g),this._setupFunctionStore()}},_addFunctionItemToList:function(e,t,n,i,a){var s={};s.name=e,s.id=t;var r=n;r.length>200&&(r=r.substring(0,200)+"..."),s.description=r,s.label="<html><body><section><h4>"+e+":</h4><table cellspacing='5'><tr><td><img src='"+i+a+"' height='100' width='100'></td><td><p style='white-space:pre-wrap;width:40ex'><i>"+r+"</i></p></td></tr></table></section></body></html>",this._rasterFunctionData.push(s)},_setupColorRampDefaults:function(){if(this.layer){var e,t=this.layer.bandCount,n=this.layer.pixelType,i=this.layer.renderingRule;i&&(n=i.outputPixelType||this.layer.pixelType,e=i.functionName),t>1||this.layer.currentVersion<10.3||!n||"u8"===n.toLowerCase()||!e||"colormap"!==e.toLowerCase()?this._hideColorRampSelector():this._showColorRampSelector()}},_setColorRampSelectValue:function(){if(this.layer){var e=this.layer.renderingRule;e&&e.functionName&&"colormap"===e.functionName.toLowerCase()&&e.functionArguments&&e.functionArguments.colorRamp?this.colorRampSelect.setSelected(e.functionArguments.colorRamp):this.colorRampSelect.reset()}},_hideColorRampSelector:function(){a.set(this.colorRampBlock,"display","none"),a.set(this.colorRampLabelBlock,"display","none"),this.colorRampVisible=!1},_showColorRampSelector:function(){this.layer&&this.rasterFunctionList.get("value")===this._defaultBandCombinationFncName&&1===this.layer.bandCount&&this.layer.currentVersion>=10.3&&("0"!==this.stretchMethodList.get("value")||"u8"===this.layer.pixelType.toLowerCase())&&(this._setColorRampSelectValue(),a.set(this.colorRampBlock,"display","table-row"),a.set(this.colorRampLabelBlock,"display","table-row"),this.colorRampVisible=!0)},_setupBandIdDefaults:function(){if(this.layer){var e=3;e=this.layer.bandCount;var n=this.layer.id,i=this._cachedkeyProperties[n];if(!i&&e>1){this.msgLabel.style.display="",this.msgLabel.innerHTML="<i>"+this._i18n.widgets.renderingRule.bandNamesRequestMsg+"</i>";var a=this.layer.getKeyProperties();this._pendingDfds[n]=1,a.addBoth(t.partial(this._fillBandIdList,this,this.layer))}else this._fillBandIdList(this,this.layer,i);3>e?this._hideBandIds():this._showBandIds()}},_fillBandIdList:function(e,t,n){if(e.layer&&e.layer===t){var i=e._pendingDfds,a=e.layer.id;i&&i[a]&&delete i[a],e.msgLabel.style.display="none",e.msgLabel.innerHTML="";var s=3;s=e.layer.bandCount;var r;n&&n.BandProperties&&n.BandProperties.length>0&&(r=n.BandProperties);var l=e._getBandIdList(s,r,"");e._redBandIdStore=new o({data:l,idProperty:"name"}),e.bandIdsRedList.set("store",e._redBandIdStore),e.bandIdsRedList.set("labelAttr","label"),e.bandIdsRedList.set("labelType","html");var d=e._getBandIdList(s,r,"");e._greenBandIdStore=new o({data:d,idProperty:"name"}),e.bandIdsGreenList.set("store",e._greenBandIdStore),e.bandIdsGreenList.set("labelAttr","label"),e.bandIdsGreenList.set("labelType","html");var h=e._getBandIdList(s,r,"");e._blueBandIdStore=new o({data:h,idProperty:"name"}),e.bandIdsBlueList.set("store",e._blueBandIdStore),e.bandIdsBlueList.set("labelAttr","label"),e.bandIdsBlueList.set("labelType","html");var c=e.layer.bandIds;if(c&&c.length>2)e.bandIdsRedList.set("value",e._getBandName(e._redBandIdStore,c[0])),e.bandIdsGreenList.set("value",e._getBandName(e._greenBandIdStore,c[1])),e.bandIdsBlueList.set("value",e._getBandName(e._blueBandIdStore,c[2]));else if(e._redBandIdStore.data.length>0&&e._greenBandIdStore.data.length>1&&e._blueBandIdStore.data.length>2){var u=e._getRedBandIndex(r),m=e._getGreenBandIndex(r),p=e._getBlueBandIndex(r);e.bandIdsRedList.set("value",e._redBandIdStore.data[u].name),e.bandIdsGreenList.set("value",e._greenBandIdStore.data[m].name),e.bandIdsBlueList.set("value",e._blueBandIdStore.data[p].name)}e._cachedkeyProperties[a]=n;var g=e.rasterFunctionList.get("value");g===e._defaultBandCombinationFncName&&e._enableBandIds()}},_getRedBandIndex:function(e){if(!this.layer||!e)return 0;var t;for(t=0;t<e.length;t++)if(e[t]&&e[t].hasOwnProperty("BandName")&&"red"===e[t].BandName.toLowerCase())return t;return 0},_getGreenBandIndex:function(e){if(!this.layer||!e)return 1;var t;for(t=0;t<e.length;t++)if(e[t]&&e[t].hasOwnProperty("BandName")&&"green"===e[t].BandName.toLowerCase())return t;return 1},_getBlueBandIndex:function(e){if(!this.layer||!e)return 2;var t;for(t=0;t<e.length;t++)if(e[t]&&e[t].hasOwnProperty("BandName")&&"blue"===e[t].BandName.toLowerCase())return t;return 2},_getBandIdList:function(e,t,n){if(this.layer){var i=[];n||(n="Black");var a=!1;t&&e===t.length&&(a=!0);var s;for(s=0;e>s;s++){var r=s,o=s;a&&t[s]&&t[s].BandName?r=t[s].BandName:r++;var l={};l.name=r,l.index=o,l.label="<html><body><span value="+o+"><font color="+n+">"+r+"</font></span></body></html>",i.push(l)}return i}},_getBandName:function(e,t){if(e&&e.data){var n;for(n=0;n<e.data.length;n++){var i=e.data[n];if(i.index===t)return i.name}return""}},_setupStretchDefaults:function(){if(this.layer){var e=this.layer.renderingRule;e&&e.functionName&&"stretch"===e.functionName.toLowerCase()?this._loadStretchFunction(e):e&&e.functionName&&"colormap"===e.functionName.toLowerCase()&&e.functionArguments&&e.functionArguments.Raster&&e.functionArguments.Raster.functionName&&"stretch"===e.functionArguments.Raster.functionName.toLowerCase()?(e=e.functionArguments.Raster,this._loadStretchFunction(e)):(this.stretchMethodList.set("value","0"),this._onStretchMethodChange(),this.numStdDevText.set("value",2),this.minPercentText.set("value",2),this.maxPercentText.set("value",2),this.gammaSlider.setValue(0),e&&e.functionName?(this.draCheckbox.checked=!0,this.draCheckbox.disabled=!1,this.draLabel.style.color="Black"):this.layer.minValues&&this.layer.minValues.length>0&&this.layer.maxValues&&this.layer.maxValues.length>0?(this.draCheckbox.checked=!1,this.draCheckbox.disabled=!1,this.draLabel.style.color="Black"):(this.draCheckbox.checked=!0,this.draCheckbox.disabled=!0,this.draLabel.style.color="Gray")),this._gammaSliderTooltip||(this._gammaSliderTooltip=new _({connectId:["gammaSliderID"],position:["below","above"],id:"gammaSliderTooltipID"}))}},_loadStretchFunction:function(e){if(e&&e.functionName&&"stretch"===e.functionName.toLowerCase()){var t=e.functionArguments,n=t.StretchType;if(this.stretchMethodList.set("value",n.toString()),this._onStretchMethodChange(),t.NumberOfStandardDeviations&&this.numStdDevText.set("value",t.NumberOfStandardDeviations),this.draCheckbox.checked=t.DRA?!0:!1,t.UseGamma){var i=t.Gamma;t.Gamma.length>0&&(i=t.Gamma[0]);var a=Math.log(i)/Math.log(10);a&&this.gammaSlider.setValue(a)}t.MinPercent&&this.minPercentText.set("value",t.MinPercent),t.MaxPercent&&this.maxPercentText.set("value",t.MaxPercent)}},_getRenderingRuleNameFromStretchFunction:function(e){if(e&&e.functionName&&"stretch"===e.functionName.toLowerCase()){var t=e.functionArguments,n=t.Raster;return n&&n.functionName||null}},_fillStretchMehodList:function(){this.stretchMethodList.removeOption(this.stretchMethodList.getOptions()),this.stretchMethodList.addOption([{value:"0",label:this._i18n.widgets.renderingRule.noneStretchAlias},{value:"5",label:this._i18n.widgets.renderingRule.minMaxStretchAlias},{value:"3",label:this._i18n.widgets.renderingRule.stdDevStretchAlias},{value:"6",label:this._i18n.widgets.renderingRule.percentClipStretchAlias}]),this.stretchMethodList.set("value","0"),this._onStretchMethodChange()},_onRasterFunctionChange:function(){var e=this.rasterFunctionList.get("value");if(e){var t=this._rasterFunctionStore.get(e).description;this.rasterFunctionList.set("title",t);var n=this.layer.id;e===this._defaultBandCombinationFncName?(this.rasterFunctionRow.width="",this.layer.bandCount>1?(this._showBandIds(),this._pendingDfds[n]?this._disableBandIds():this._enableBandIds()):(this._hideBandIds(),this.layer.currentVersion>=10.3&&this._showColorRampSelector())):(this.domNode.clientWidth>0&&(this.rasterFunctionRow.width=this.domNode.clientWidth),this._hideBandIds(),this._hideColorRampSelector()),e===this._defaultBandCombinationFncName||this.layer.version>=10.3?(this.imageEnhancementLabel.style.display="",this.stretchMethodLabel.style.display="",this.stretchDescLabel.style.display="",this.stretchMethodList.domNode.style.display="",this._onStretchMethodChange()):this._hideStretch()}},_onColorRampChange:function(){},_onStretchMethodChange:function(){if(!(this.stretchMethodList.getOptions.length<1)){var e=this.stretchMethodList.get("value");switch("0"===e?this._hideStretchOptions(!0):this._hideStretchOptions(!1),e){case"0":this.stretchMethodNoneDescBlock.style.display="","u8"!==this.layer.pixelType.toLowerCase()&&this._hideColorRampSelector();break;case"3":this.numStdDevBlock.style.display="",this._showColorRampSelector();break;case"5":this.stretchMethodMinMaxDescBlock.style.display="",this._showColorRampSelector();break;case"6":this.minMaxPercentDescBlock.style.display="",this.minPercentBlock.style.display="",this.maxPercentBlock.style.display="",this._showColorRampSelector()}}},_onClickApplyRenderingRule:function(){var e=this.rasterFunctionList.get("value");e!==this._defaultBandCombinationFncName?this._onRasterFunctionApply():this._onBandIdsApply()},_onClickResetRenderingRule:function(){this.layer&&(this.layer.renderingRule=null,this.layer.bandIds=null,this._setupDefaults(),this._onClickApplyRenderingRule())},_onRasterFunctionApply:function(){if(!this._donotSaveChanges&&this.layer){var e,t=[];this.layer.setBandIds(t,!0);var n=new h;n.functionName=this.rasterFunctionList.get("value");var i=this._getStretchFunction();this.layer.version>=10.3&&i?(i.functionArguments.Raster=n,this.colorRampVisible&&"none"!==this.colorRampSelect.value&&this.rasterFunctionList.get("value")===this._defaultBandCombinationFncName?(e=this._getColorMapFunction(),e.functionArguments.Raster=i,this.layer.setRenderingRule(e)):this.layer.setRenderingRule(i)):this.layer.setRenderingRule(n)}},_onBandIdsApply:function(){if(!this._donotSaveChanges&&this.layer){if(!this._redBandIdStore||!this.bandIdsGreenList||!this.bandIdsBlueList)return void this._onStretchApply(!1);var e=[],t=this._redBandIdStore.get(this.bandIdsRedList.value),n=this._greenBandIdStore.get(this.bandIdsGreenList.value),i=this._blueBandIdStore.get(this.bandIdsBlueList.value);t&&n&&i&&(e.push(t.index),e.push(n.index),e.push(i.index)),this._onStretchApply(!0),this.layer.setBandIds(e)}},_onStretchApply:function(e){if(!this._donotSaveChanges&&this.layer){var t,n=this._getStretchFunction();this.colorRampVisible&&"none"!==this.colorRampSelect.value?(t=this._getColorMapFunction(),t.functionArguments.Raster=n,this.layer.setRenderingRule(t)):this.layer.setRenderingRule(n,e)}},_getStretchFunction:function(){var e=this.stretchMethodList.get("value"),t=null;return"0"!==e&&(t=new h,t.functionName="Stretch",this._buildStretchFunction(t)),t},_buildStretchFunction:function(e){e.functionName="Stretch";var t=this.stretchMethodList.get("value"),n={};n.StretchType=parseInt(t,10),n.DRA=this.draCheckbox.checked?!0:!1;var i=Math.exp(this.gammaSlider.value*Math.log(10));i=parseFloat(parseFloat(i).toFixed(2));var a=[];a.push(i),this.layer.bandCount>1&&(a.push(i),a.push(i)),n.Gamma=a,n.UseGamma=!0,"3"===t?(n.NumberOfStandardDeviations=this.numStdDevText.value,e.outputPixelType="U8"):"6"===t?(n.MinPercent=parseFloat(this.minPercentText.value),n.MaxPercent=parseFloat(this.maxPercentText.value),e.outputPixelType="U8"):"5"===t&&(e.outputPixelType="U8"),e.functionArguments=n},_onGammaChange:function(e){var t=this._gammaSliderTooltip;if(t){var n=Math.exp(e*Math.log(10));n?t.label=parseFloat(n).toFixed(2):t.label=e,t.open("gammaSliderID")}},_onGammaMouseLeave:function(){this.gammaTooltipClose()},_disableBandIds:function(){this.bandIdsRedList.set("disabled",!0),this.bandIdsGreenList.set("disabled",!0),this.bandIdsBlueList.set("disabled",!0),this.bandIdsLabel.style.color="Gray"},_enableBandIds:function(){this.bandIdsRedList.set("disabled",!1),this.bandIdsGreenList.set("disabled",!1),this.bandIdsBlueList.set("disabled",!1),""===this.bandIdsRedList.value&&this.bandIdsRedList.set("value","1"),""===this.bandIdsGreenList.value&&this.bandIdsGreenList.set("value","2"),""===this.bandIdsBlueList.value&&this.bandIdsBlueList.set("value","3"),this.bandIdsLabel.style.color="Black"},_showBandIds:function(){this.bandIdsLabelBlock.style.display="",this.bandIdsBlock.style.display="",this.bandIdsMsgBlock.style.display=""},_hideBandIds:function(){this.bandIdsLabelBlock.style.display="none",this.bandIdsBlock.style.display="none",this.bandIdsMsgBlock.style.display="none"},_hideStretch:function(){this.imageEnhancementLabel.style.display="none",this.stretchDescLabel.style.display="none",this.stretchMethodLabel.style.display="none",this.stretchMethodList.domNode.style.display="none",this._hideStretchOptions(!0)},_hideStretchOptions:function(e){var t="";e&&(t="none"),this.gammaBlock.style.display=t,this.draBlock.style.display=t,this.stretchMethodNoneDescBlock.style.display="none",this.stretchMethodMinMaxDescBlock.style.display="none",this.numStdDevBlock.style.display="none",this.minMaxPercentDescBlock.style.display="none",this.minPercentBlock.style.display="none",this.maxPercentBlock.style.display="none"},_getDefaultRedBandIndex:function(){var e;return this._redBandIdStore&&(e=this._redBandIdStore.get("Red")),e||(e=1),e},gammaTooltipClose:function(){this._gammaSliderTooltip&&this._gammaSliderTooltip.close()}});return l("extend-esri")&&t.setObject("dijit.RenderingRule",y,d),y});