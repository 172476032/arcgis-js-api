// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/dom-construct","dojo/on","dojox/timing","dojo/Evented","dijit/_WidgetBase","dijit/_TemplatedMixin","dojox/form/HorizontalRangeSlider","dijit/form/TextBox","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/ObjectUtil","dojo/text!./templates/NumericalSlider.html"],function(t,e,i,a,n,l,s,u,r,h,o,m,x,V,d){return t([u,r,s],{templateString:d,decimals:0,minValue:0,maxValue:0,lowerValue:0,upperValue:0,maxNumStatBlocks:20,minNumStatBlocks:10,minNumDataForStatistics:2,timeIntervalLength:null,_timer:null,_root:null,constructor:function(t){t&&this.setData(t)},buildRendering:function(){var e=this;this.inherited(arguments);var a=t(this._getSliderClass(),{postMixInProperties:function(){var t=this.value.slice();this.inherited(arguments),this.value=t.map(function(t){return parseFloat(t)})}});this._rangeSlider=new a({name:"rangeSlider",value:["rtl"===document.dir?this.upperValue:this.lowerValue,"rtl"===document.dir?this.lowerValue:this.upperValue],minimum:parseFloat(this.minValue),maximum:parseFloat(this.maxValue),showButtons:!1,intermediateChanges:!0,onChange:this._onChangeValue.bind(this)},this.divSliderContainer),this.own(this._rangeSlider),i.add(this._rangeSlider.sliderHandle,"esriGENumericalSliderMinThumb"),this.label?this.divLabel.innerHTML=this.label:x.hide(this.divLabel),this._createMinTextBox(),this._createMaxTextBox(),this._setMinValue(this.numberToText(this._rangeSlider.value["rtl"===document.dir?1:0])),this._setMaxValue(this.numberToText(this._rangeSlider.value["rtl"===document.dir?0:1])),n(this.tbxMinValue,m.clickOrRelease,function(t){e.tbxMinValue.textbox.select()}),n(this.tbxMaxValue,m.clickOrRelease,function(t){e.tbxMaxValue.textbox.select()})},_getSliderClass:function(){return h},_createMinTextBox:function(){var t=this;this.tbxMinValue=(new o).placeAt(this.divMinValue),n(this.tbxMinValue.textbox,"keyup",function(e){13===e.keyCode&&t._onChangeMinValue()}),this.own(this.tbxMinValue)},_createMaxTextBox:function(){var t=this;this.tbxMaxValue=(new o).placeAt(this.divMaxValue),n(this.tbxMaxValue.textbox,"keyup",function(e){13===e.keyCode&&t._onChangeMaxValue()}),this.own(this.tbxMaxValue)},setData:function(t){t.timeIntervalLength&&(t.timeIntervalLength=parseInt(t.timeIntervalLength),this._timer=new l.Timer,this._timer.onTick=this._onTick.bind(this)),t.minValue?t.minValue=parseFloat(t.minValue):t.dataArray&&(t.minValue=Math.min.apply(null,t.dataArray)),t.maxValue?t.maxValue=parseFloat(t.maxValue):t.dataArray&&(t.maxValue=Math.max.apply(null,t.dataArray)),parseFloat(t.lowerValue)&&0!==t.lowerValue||(t.lowerValue=t.minValue),parseFloat(t.upperValue)&&0!==t.upperValue||(t.upperValue=t.maxValue),e.mixin(this,t)},setValue:function(t){var e="rtl"===document.dir?1:0,i="rtl"===document.dir?0:1;this.lowerValue=t[e],this.upperValue=t[i],this._setMinValue(this.numberToText(t[e])),this._setMaxValue(this.numberToText(t[i])),this._rangeSlider.value=t,this._rangeSlider._printSliderBar(!0,!1)},_setMinValue:function(t){this.tbxMinValue.set("value",t),this.tbxMinValue.textbox.title=t},_setMaxValue:function(t){this.tbxMaxValue.set("value",t),this.tbxMaxValue.textbox.title=t},_emitChangeEvent:function(){this._timer?(this._timer.stop(),this._timer.setInterval(this.timeIntervalLength),this._timer.start()):this._onTick()},_onTick:function(){var t={lowerValue:this.lowerValue,upperValue:this.upperValue};this._timer&&this._timer.stop(),this.onChange(t)},_onChangeValue:function(t){var e="rtl"===document.dir?1:0,i="rtl"===document.dir?0:1;this._setMinValue(this.numberToText(t[e])),this._setMaxValue(this.numberToText(t[i])),this.lowerValue=t[e],this.upperValue=t[i],this._emitChangeEvent()},_onChangeMinValue:function(t){var e=this.tbxMinValue.get("value");e=this.textToNumber?this.textToNumber(e):parseFloat(e),e=Math.min(this.maxValue,Math.max(this.minValue,e)),isNaN(e)||(this.lowerValue=e,this.upperValue=e<=this.upperValue?this.upperValue:e,this.setValue([this.lowerValue,this.upperValue]),this._emitChangeEvent(),this._setMaxValue(this.numberToText(this.upperValue))),this._setMinValue(this.numberToText(this.lowerValue))},_onChangeMaxValue:function(t){var e=this.tbxMaxValue.get("value");e=this.textToNumber?this.textToNumber(e):parseFloat(e),e=Math.min(this.maxValue,Math.max(this.minValue,e)),isNaN(e)||(this.lowerValue=e>=this.lowerValue?this.lowerValue:e,this.upperValue=e,this.setValue([this.lowerValue,this.upperValue]),this.upperValue=e,this._emitChangeEvent(),this._setMinValue(this.numberToText(this.lowerValue))),this._setMaxValue(this.numberToText(this.upperValue))},numberToText:function(t){return t.toFixed(this.decimals)},textToNumber:function(t){return parseFloat(t)},setStatistics:function(t){if(t=t.filter(function(t){return t>=this.minValue&&t<=this.maxValue},this),!(t.length<this.minNumDataForStatistics)){t.sort(function(t,e){return t-e});for(var e=1/0,i=0;i<t.length;i++)if(0!==i){var n=Math.abs(t[i]-t[i-1]);n>0&&(e=Math.min(n))}var l=isFinite(e)?Math.max(Math.round((this.maxValue-this.minValue)/e)+1,this.minNumStatBlocks):1e6,s=Math.min(this.maxNumStatBlocks,l),u=(this.maxValue-this.minValue)/s,r=this.minValue+u,h=[0],o=0,m=Math.max(1,Math.round(Math.log10(3e3/this.maxValue)));t.forEach(function(t){if(V.roundNumber(t,m)<=V.roundNumber(r,m))h[h.length-1]++;else{for(;V.roundNumber(t,m)>V.roundNumber(r,m);)r+=u,h.push(0);h[h.length-1]++}o=Math.max(o,h[h.length-1])}),a.empty(this.statisticsContainer);var x=(this.statisticsContainer.clientWidth||125)/s;h.forEach(function(t,e){var i=a.create("div",{class:"esriGENumericalSlider_statisticsContainerBlock"},this.statisticsContainer);i.style.width=x-1+"px";var n=t>0?18*t/o+2:0;i.style.height=n+"px",i.style.left=x*e+"px",i.style.top=20-n+"px"},this)}},round:function(t){return this.textToNumber(this.numberToText(t))},onChange:function(t){}})});