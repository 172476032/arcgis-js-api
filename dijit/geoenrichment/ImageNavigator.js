// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/on","dojo/when","dojo/string","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dijit/_WidgetBase","dijit/_TemplatedMixin","./Pagination","./FlowList","./utils/DeviceUtil","./utils/DnDUtil","./utils/DomUtil","./utils/WaitingUtil","./ReportPlayer/core/annotations/utils/CircularMaskUtil","dojo/text!./templates/ImageNavigator.html","dojo/i18n!../../nls/jsapi"],function(t,e,i,a,n,s,o,h,g,l,r,m,u,d,c,_,I,v){function p(t,e,a){return a=a||{},c.showProgress(e),i(t.getThumbnail(),function(t){if(c.removeProgress(e),t){var i=s.create("div",{class:"imageNode esriGEAbsoluteStretched"},e);i.style.backgroundImage="url("+t+")",a.useCircularMask?setTimeout(function(){_.setCircularMask(a.useCircularMask,i,t)},0):a.scaleToCover&&(i.style.backgroundSize="cover")}else if(a.pagination)var i=s.create("div",{class:"thumbnailIsUnavailable",innerHTML:v.previewNotAvailable},e);else{var i=s.create("div",{class:"imageNode esriGEAbsoluteStretched noImage"},e);i.style.backgroundImage=""}})}v=v.geoenrichment.dijit.ReportPlayer.ImageNavigator;var b=t(null,{createPresentation:function(t,e,i,a){var n=s.create("div",{class:"imageThumbnailListItemRoot"},i);return p(t,n),this.selectPresentation(n,e),n},selectPresentation:function(t,e){n[e?"add":"remove"](t,"imageThumbnailListItemRootSelected")}});return t([h,g],{templateString:I,nls:v,showNotes:!0,showThumbnails:!1,showNavigationLabel:!1,enableAllImagesButton:!0,pagination:null,thumbnailList:null,allImagesList:null,postCreate:function(){this.inherited(arguments),this._initPagination(),this._initThumbnailsList(),this._updateUI(),d.hide(this.noImagePlaceHolder),this._addImageListeners(),this._setViewMode("singleImage"),n[m.isMobileDevice()?"add":"remove"](this.domNode,"mobile")},_initThumbnailsList:function(){this.showThumbnails&&(this.thumbnailList=this._createAllImagesList(this.thumbnailListDiv))},_initAllImagesList:function(){this.allImagesList||(this.allImagesList=this._createAllImagesList(this.allImagesListDiv,"esriGEAbsoluteStretched")),this.allImagesList.setItems(this._images,!0),this.allImagesList.setSelectedIndex(this._imageIndex)},_createAllImagesList:function(t,e){var i=this,a=new r({class:"imageThumbnailList "+(e||""),items:[],itemRenderer:new b,onChange:function(){i._imageIndex=a.items.indexOf(a.selectedItem),i._setViewMode("singleImage"),i._showImage()}}).placeAt(t);return this.own(a),a},_initPagination:function(){var t=this;this.pagination=new l({createItemContainer:function(){var e=s.create("div",{class:"imageNavigator_imagePaginationRoot"});return t._containerHeight>0&&o.set(e,"height",t._containerHeight+"px"),u.addNoDragClickHandler(e,function(){t._onImageClicked(e)},{tolerance:m.isMobileDevice()?30:2}),e},updateItemContainer:function(e,a){s.empty(e),t.onContentLoadingStart(),i(p(a,e,{useCircularMask:t._useCircularMask,scaleToCover:t._scaleToCover,pagination:!0}),function(){t.onContentLoadingEnd()})},scrollAnimation:"slide",autoCenter:"$stretch:1,1"}).placeAt(this.imagePaginationDiv),this.own(this.pagination),this.pagination.set("items",[]),this.pagination.startup()},_onImageClicked:function(t){var e=this._getCurrentImage();i(e&&e.getAttachmentUrl&&e.getAttachmentUrl(),function(t){t&&window.open(t,"_blank")})},_updateUI:function(){d[this.showNotes?"show":"hide"](this.imageNoteContainerDiv),d[this.showThumbnails?"show":"hide"](this.thumbnailListDiv),d[this.showNavigationLabel?"show":"hide"](this.navigatorLabel)},_imageIndex:0,_addImageListeners:function(){var t=this;e(this.prevImageButton,"click",function(){0!=t._imageIndex&&(t._imageIndex--,t._showImage())}),e(this.nextImageButton,"click",function(){t._imageIndex!=t._images.length-1&&(t._imageIndex++,t._showImage())}),this.enableAllImagesButton&&e(this.showAllImagesButton,"click",function(){t._setViewMode("allImages")})},_updateImageButtons:function(){n[this._imageIndex>0?"remove":"add"](this.prevImageButton,"esriGEImageNavigatorPaginationLeftButtonDisabled"),n[this._imageIndex<this._images.length-1?"remove":"add"](this.nextImageButton,"esriGEImageNavigatorPaginationRightButtonDisabled")},_getCurrentImage:function(){return this._images[this._imageIndex]},_showImage:function(){var t=this._getCurrentImage();t?(d.show(this.imageContainerOuter),d.hide(this.noImagePlaceHolder),this.pagination.resize(),this.pagination.set("currentPage",this._imageIndex),this._imageIndex=this.pagination.currentPage,this.thumbnailList&&this.thumbnailList.setSelectedIndex(this._imageIndex)):(d.hide(this.imageContainerOuter),d.show(this.noImagePlaceHolder)),n[t?"remove":"add"](this.domNode,"hasNoImages"),this._updateImageButtons(),this._updateNavigatorLabel(),this._showNote()},_updateNavigatorLabel:function(){this.navigatorLabel.innerHTML=a.substitute(v.paginationLabel,{n:this._imageIndex+1,m:this._images.length})},_showNote:function(){var t=this._getCurrentImage();this.imageNoteLabel.innerHTML=t&&t.description||"",o.set(this.imageNoteContainerDiv,"visibility",this.imageNoteLabel.innerHTML?"visible":"hidden")},_attachmentStore:null,_useCircularMask:null,_scaleToCover:null,update:function(t,e){var a=t&&(!this._attachmentStore||this._attachmentStore._site!==t._site);this._attachmentStore=t||this._attachmentStore,this._updateWithAdditionalParameters(e),this._updateUI(),a&&(this._images=[],this._imageIndex=0,this.pagination.set("items",[]),this._showImage());var n=this;return i(this._attachmentStore&&this._attachmentStore.getAttachments(),function(t){n._images=t||[],n.pagination.set("items",n._images),n._showImage(),n.thumbnailList&&(n.thumbnailList.setItems(n._images),n.thumbnailList.setSelectedIndex(n._imageIndex)),n._height&&n.setHeight(n._height)})},_updateWithAdditionalParameters:function(t){t=t||{},this._useCircularMask=t.useCircularMask,n[t.alwaysShowCaptions?"add":"remove"](this.domNode,"fixedCaptions"),this._scaleToCover=t.scaleToCover},_mode:null,_setViewMode:function(t){d.hide([this.singleImageView,this.allImagesView]),"singleImage"==t?d.show(this.singleImageView):(d.show(this.allImagesView),this._initAllImagesList()),this._mode=t},getImageIndex:function(){return this._imageIndex},setImageIndex:function(t){this._imageIndex=t,this._showImage()},_height:0,_containerHeight:0,setHeight:function(t){this._height=t,this._containerHeight=t-(this.showThumbnails?50:0),o.set(this.imageContainer,"height",this._containerHeight+"px"),o.set(this.noImagePlaceHolder,"paddingTop",(t-169)/2+"px");var e=(this._containerHeight-o.get(this.prevImageButton,"height"))/2;o.set(this.prevImageButton,"top",e+"px"),o.set(this.nextImageButton,"top",e+"px"),this.pagination.resize()},onContentLoadingStart:function(){},onContentLoadingEnd:function(){}})});