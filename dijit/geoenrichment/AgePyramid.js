// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["../../declare","dojo/_base/lang","./BaseSelectComparison","dojo/dom-construct","dojo/number","dojo/dom-class","./utils","./theme","dojox/charting/Chart","dojox/charting/axis2d/Default","dojox/charting/plot2d/Bars","dojox/charting/plot2d/Lines","./ReportPlayer/core/charts/tooltips/ZoomSupportTooltip","dojox/charting/action2d/Highlight","dojox/charting/SimpleTheme","dojo/i18n!../../nls/jsapi"],function(e,t,i,a,s,n,r,h,l,d,o,m,c,g,u,_){_=_.geoenrichment.dijit.AgePyramid;return e("esri.dijit.geoenrichment.AgePyramid",i,{baseClass:"Infographics_AgePyramid",showVerticalAxis:!1,chart:null,_currentTheme:null,_themeChangeHandle:null,updateUI:function(){this.inherited(arguments),this._themeChangeHandle||(this._themeChangeHandle=h.on("change",t.hitch(this,this._onThemeChange))),this._currentTheme?this._doUpdateUI():h.load("AgePyramid").then(t.hitch(this,this._onThemeLoad))},_onThemeChange:function(){this._currentTheme=null,this._destroyChart(),this.updateUI()},_onThemeLoad:function(e){this._currentTheme=e,this._currentTheme.theme=new u(e.theme),this._doUpdateUI()},_doUpdateUI:function(){this.ensureChart();var e=this.getDataFields();this.maleIndices=[],this.femaleIndices=[];for(var i,a,s=e.length/2,h=Number.NEGATIVE_INFINITY,l=Number.POSITIVE_INFINITY,o=!0,m=!0,c=0;c<e.length;c++){var g=c<s;g?this.maleIndices.push(e[c]):this.femaleIndices.push(e[c]);var u=this.getValueByIndex(0,e[c]);u>h?(h=u,i=this.getFieldByIndex(e[c]).alias,o=g):u<l&&(l=u,a=this.getFieldByIndex(e[c]).alias,m=g)}var _,p,x=this.setSeriesData(this.chart.getSeries("male_bars"),0,this.maleIndices,-1),f=this.setSeriesData(this.chart.getSeries("female_bars"),0,this.femaleIndices,1);if(this.expanded){var I=this._getComparisonRow();_=this.setSeriesData(this.chart.getSeries("male_lines"),I,this.maleIndices,-1),p=this.setSeriesData(this.chart.getSeries("female_lines"),I,this.femaleIndices,1)}else this.chart.getSeries("male_lines").update([]),this.chart.getSeries("female_lines").update([]),_=Number.NEGATIVE_INFINITY,p=Number.NEGATIVE_INFINITY;if(this.extreme=r.getCeiling(Math.max(x,f,_,p),!0),this.chart.removeAxis("y"),this.chart.addAxis("y",{type:d,min:-this.extreme,max:this.extreme,minorTicks:!1,labelFunc:t.hitch(this,this.getAxisLabel)}),this.chart.removeAxis("x"),this.showVerticalAxis){var T=/\d+$/i;this.chart.addAxis("x",{type:d,min:.5,max:this.maleIndices.length+1,majorTickStep:1e3,majorTicks:!1,minorTicks:!0,minorTickStep:2,vertical:!0,labelFunc:t.hitch(this,function(e,t,i){var a=this.maleIndices[t-1],s=this.data.fields[a],n=s&&s.name.match(T);return(n=n&&n[0])||" "})})}this.chart.render(),this.expanded&&(o?n.replace(this.max,"AgePyramid_TextMale","AgePyramid_TextFemale"):n.replace(this.max,"AgePyramid_TextFemale","AgePyramid_TextMale"),m?n.replace(this.min,"AgePyramid_TextMale","AgePyramid_TextFemale"):n.replace(this.min,"AgePyramid_TextFemale","AgePyramid_TextMale"),this.max.innerHTML=i,this.min.innerHTML=a)},getAxisLabel:function(e,t,i){return t=Math.abs(t),t!=this.extreme?s.format(t,{places:0}):s.format(t/100,{places:0,type:"percent"})},resize:function(){this.inherited(arguments),this.chart&&this.chart.resize()},ensureChart:function(){if(!this.chart){var e=this._currentTheme,i=this.chart=new l(this.chartDiv);i.setTheme(e.theme),i.addPlot("lines",{type:this._getLinesPlot(),markers:!0}),i.addPlot("bars",{type:this._getBarsPlot(),gap:this.expanded?1.5:1}),i.addSeries("male_bars",[],t.mixin({plot:"bars"},e.male)),i.addSeries("female_bars",[],t.mixin({plot:"bars"},e.female)),i.addSeries("male_lines",[],t.mixin({plot:"lines"},e.line)),i.addSeries("female_lines",[],t.mixin({plot:"lines"},e.line));var a={text:t.hitch(this,this.getTooltip)};new c(i,"bars",a),new c(i,"lines",a),new g(i,"bars",{duration:1}),new g(i,"lines",{duration:1,highlight:e.highlight})}},_getLinesPlot:function(){return m},_getBarsPlot:function(){return o},getTooltip:function(e){var t,i,a=this._currentTheme;switch(e.run.name){case"male_bars":t=this.maleIndices[e.index],i=0;break;case"female_bars":t=this.femaleIndices[e.index],i=0;break;case"male_lines":t=this.maleIndices[e.index],i=this._getComparisonRow();break;case"female_lines":t=this.femaleIndices[e.index],i=this._getComparisonRow();break;default:return""}var n=this.getFeatureTitle(i),r=this.getFieldByIndex(t).alias,h=s.format(this.getValueByIndex(i,t),{places:0}),l="lines"===e.plot.name?e.x:e.y,d=s.format(Math.abs(l)/100,{places:1,type:"percent"});return"<div class='AgePyramid_Tooltip_Content'><span style='font:"+a.font+"; color:"+a.color+";'><b>"+n+"</b > <br / > "+r+"<br/>"+h+" ("+d+")</span></div>"},setSeriesData:function(e,t,i,a){var s,n,r=[],h=0;for(s=0;s<i.length;s++)n=this.getValueByIndex(t,i[s]),r.push(n),h+=n;var l=Number.NEGATIVE_INFINITY;for(s=0;s<i.length;s++)n=r[s]/h*100,r[s]=n*a,n>l&&(l=n);if("lines"===e.plot)for(s=0;s<r.length;s++)r[s]={x:r[s],y:s+1};return e.update(r),l},createUI:function(e){this.inherited(arguments),e.contentClass.push("AgePyramid_ContentPane"),this.chartDiv=e.addContent("div",{class:"AgePyramid_Chart"})},createUIExpanded:function(e){this.inherited(arguments);var t=e.addContent("div",{class:"AgePyramid_MinMax"});a.create("div",{innerHTML:_.maxLabel},t),this.max=a.create("div",{class:"AgePyramid_Text"},t),a.create("div",{class:"AgePyramid_MinLabel",innerHTML:_.minLabel},t),this.min=a.create("div",{class:"AgePyramid_Text"},t);var i=e.addContent("div",{class:"AgePyramid_Comparison"});a.create("div",{class:"AgePyramid_ComparisonLabel",innerHTML:_.compLabel},i),this._createComboBox(i)},createUICollapsed:function(e){this.inherited(arguments),a.create("div",{class:"MenLabel",innerHTML:_.menLabel},this.chartDiv),a.create("div",{class:"WomenLabel",innerHTML:_.womenLabel},this.chartDiv)},destroy:function(){this._destroyChart(),this._themeChangeHandle&&(this._themeChangeHandle.remove(),this._themeChangeHandle=null),this.inherited(arguments)},_destroyChart:function(){this.chart&&(this.chart.destroy(),this.chart=null)}})});