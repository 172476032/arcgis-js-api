// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","./BaseWidget","dojo/_base/lang","dojo/_base/array","dojo/on","dojo/dom-construct","dojo/dom-class","dojo/i18n!../../nls/jsapi","dojox/html/entities","./dom"],function(e,t,a,i,n,s,l,r,o,d){function c(e,t){return"TOP"+(e+1).toString()+t}function _(e){return"Tapestry_LifeMode"+e.match(/\d+/)[0]}function u(e){return"http://downloads.esri.com/esri_content_doc/dbl/us/tapestry/segment"+e+".pdf"}r=r.geoenrichment.dijit.Tapestry;return e(t,{baseClass:"Infographics_Tapestry",_mainTable:null,_detailsTable:null,updateUIExpanded:function(){this.inherited(arguments),this._updateUI()},updateUICollapsed:function(){this.inherited(arguments),this._updateUI()},createUIExpanded:function(e){this.inherited(arguments),this._createUI(e)},createUICollapsed:function(e){this.inherited(arguments),this._createUI(e)},_createUI:function(e){var t=this._mainTable=e.addContent("table",{class:"Tapestry_Main_Table"});n(t,".Tapestry_Main_Button:click",a.hitch(this,this._toDetailView)),this.expanded?d.createCols(t,[.25,.4,.35]):d.createCols(t,[.55,.45])},_updateUI:function(){function e(){d=o.insertCell(-1)}function t(e){l.add(d,e)}this._toMainView();var a,i;for(i=0;i<3&&this._getValue(i,"NAME");i++)a=i+1;var n,o,d,c=this;n=this._mainTable;var u,h;for(i=n.rows.length;i<a;i++)!function(){o=n.insertRow(-1)}(),l.add(o,"Tapestry_LifeMode"),this.expanded&&e(),e(),t("Tapestry_Main_Name Tapestry_Main_Button LifeModeColor"),e(),t("Tapestry_Main_Pct Tapestry_Main_Button LifeModeColor"),this.expanded&&(e(),t("Tapestry_Main_Arrow Tapestry_Main_Button"),s.create("div",null,d));for(;n.rows.length>2*a;)n.deleteRow(-1);for(u=this.expanded?1:0,h=this.expanded?2:1,i=0;i<a;i++){var p=n.rows,f=p[i].cells;this.expanded&&(f[0].removeAttribute("class"),s.empty(f[0]),function(e){var t=c._getValue(i,"CODE"),a=t.length<3?"0"+t:t;l.add(e,"Tapestry_Main_Button Tapestry_Details_Image code_"+a+" LifeModeBorder "+_(t));var n=s.create("div",null,e);s.create("span",{class:"Tapestry_thumbnail_Code LifeModeBorder "+_(t),innerHTML:t},n)}(f[0])),f[u].innerHTML=this._getValue(i,"NAME")+"<br><span class='Tapestry_Main_Value'>"+this._formatValue(i,"VALUE")+" "+r.hhLabel+"</span>",f[h].innerHTML=this._formatValue(i,"PRC")+"<br><span class='Tapestry_Main_PctLabel'>"+r.prtHhLabel+"</span>",p[i].setAttribute("data-index",i.toString())}},_getValue:function(e,t){return this.getValueByName(0,c(e,t))},_formatValue:function(e,t){return this.formatByName(0,c(e,t))},_toDetailView:function(e){for(var t,a=e.target,n=this._mainTable;a&&a!==n;){if(t=a.getAttribute("data-index")){t=+t;break}a=a.parentNode}if(this.expanded){if(this._detailsTableRow){if(this._detailsTableRow.previousSibling===a)return l.remove(a,"clicked"),void this._toMainView();this._toMainView(),function(){var e=n.rows;i.forEach(e,function(e){l.remove(e,"clicked")})}(),l.add(a,"clicked"),this.createDetailsTable(a)}else l.add(a,"clicked"),this.createDetailsTable(a);this._createDetailedViewExpanded(t)}else window.open(u(this._getValue(t,"NUM")),"_blank")},createDetailsTable:function(e){this._detailsTableRow=s.create("tr",null,e,"after");var t=s.create("td",{colSpan:"4"},this._detailsTableRow);this._detailsTable=s.create("table",{class:"Tapestry_Details_Table"},t),d.createCols(this._detailsTable,[.35,.35,.3])},_createDetailedViewExpanded:function(e){function t(){p=T.insertRow(-1)}function a(e){f=p.insertCell(-1),e&&l.add(f,e)}function i(e,t,a){var i={};return e&&(i.class=e),t&&(i.innerHTML=o.encode(t)),s.create("div",i,a||f)}function d(t){return b._getValue(e,t)}function c(t){return b._formatValue(e,t)}function h(e,t){a("Tapestry_Details_FieldCell");var n=i("LifeModeBorder");i("Tapestry_Details_Label",e,n),i(null,c(t),n)}var p,f,T=this._detailsTable,b=this,m=d("CODE");l.add(T,_(m)),m.length<3&&(m="0"+m),t(),h(r.hhTypeLabel,"TYPE"),h(r.medianAgeLabel,"AGE"),a("Tapestry_Details_Image household code_"+m),f.rowSpan=2,i(),i(null,d("TYPE")),t(),h(r.employmentLabel,"JOB"),h(r.educationLabel,"EDUCATION"),t(),h(r.incomeLabel,"INCOME"),h(r.raceEthnicityLabel,"RACE"),a("Tapestry_Details_Image housing code_"+m),f.rowSpan=2,i(),i(null,d("HOUSE")),t(),a(),f.colSpan=2;var y=i("Wizard_Link Tapestry_Details_Name","View full segment profile"),w=u(d("NUM"));n(y,"click",function(){window.open(w,"_blank")})},_toMainView:function(){this._detailsTableRow&&(s.destroy(this._detailsTableRow),this._detailsTable=null,this._detailsTableRow=null)}})});