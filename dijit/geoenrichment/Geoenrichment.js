// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["../../declare","dojo/_base/lang","dojo/on","dojo/string","dojo/promise/all","./bufferTitle","../../geometry/Polygon","../../units","./DataProvider","../../tasks/geoenrichment/GeoenrichmentTask","../../tasks/geoenrichment/EnrichParameters","../../tasks/geoenrichment/RingBuffer","../../tasks/geoenrichment/DriveBuffer","../../tasks/geoenrichment/GeographyLevel","../../tasks/geoenrichment/GeometryStudyArea","../../tasks/geoenrichment/AddressStudyArea","../../tasks/geoenrichment/studyAreaFromJson","./config","./lang","./_Invoke","dojo/when","../../tasks/locator","../../tasks/FeatureSet","../../graphic","../../geometry/jsonUtils"],function(e,t,s,n,r,a,i,o,u,h,l,c,f,d,y,v,m,g,p,_,k,b,V,D,J){function A(e){var t=e.toJson();return delete t.returnGeometry,delete t.comparisonLevels,delete t.attributes,t=JSON.stringify(t)}var C=e(null,{_keys:null,_values:null,_capacity:5,constructor:function(e){this._keys=[],this._values={},e&&(this._capacity=e)},getValue:function(e){return this._values[e]},setValue:function(e,t){this._keys.push(e),this._values[e]=t,this._removeOverflow()},hasValue:function(e){return this._values.hasOwnProperty(e)},_removeOverflow:function(){if(this._keys.length>this._capacity)for(var e=this._keys.splice(0,this._keys.length-this._capacity),t=0;t<e.length;t++)delete this._values[e[t]]},setCapacity:function(e){this._capacity=e,this._removeOverflow()},toJson:function(){var e={};for(var t in this._values){var s=this._values[t];void 0===s||null===s||"number"==typeof s&&isNaN(s)||("string"==typeof s||"boolean"==typeof s||"number"==typeof s?e[t]=s:"object"==typeof s&&s.toJson&&(e[t]=s.toJson()))}return{keys:this._keys.slice(),values:e,capacity:this._capacity}},fromJson:function(e,t){if(e){this._keys=e.keys,this._capacity=e.capacity,this._values={};for(var s in e.values)this._values[s]=t?t(e.values[s]):e.values[s]}}}),w=e(null,{_values:null,constructor:function(e){this._values=new C(e)},getValue:function(e){var t=this.keyToString(e);if(this._values.hasValue(t))return this._values.getValue(t);var s=this;return this.keyToValue(e).then(function(e){return s._values.setValue(t,e),e})},keyToString:function(e){return JSON.stringify(e)},keyToValue:function(e){throw"Not implemented"},setCapacity:function(e){this._values.setCapacity(e)},toJson:function(){return this._values.toJson()},fromJson:function(e,t){e&&this._values.fromJson(e,t)}}),G=e([w],{keyToString:function(e){return JSON.stringify(e.toJson())},keyToValue:function(e){var t=new b(g.locatorUrl);return t.locationToAddress(e).then(function(e){return n.substitute(g.addressFormat,e.address,function(e){return e||""})},function(e){return""})}}),S=e([w],{_countryValues:null,_geometries:null,constructor:function(){this._countryValues=new C,this._geometries=new C(3)},keyToValue:function(e){var t,s,n=this,r=m(e.studyArea),a=r.returnGeometry;a&&(s=A(r),t=this._geometries.hasValue(s));var i=a&&!t,o=new h(g.server);o.token=g.token;for(var u=null,c=r.comparisonGeographyLevels.length-1;c>=0;c--)"Admin1"==r.comparisonGeographyLevels[c].layerID&&(u=r.comparisonGeographyLevels.splice(c,1)[0]);var f,d;u&&(f=JSON.stringify({variables:e.variables,country:e.country}),d=this._countryValues.hasValue(f),d||r.comparisonGeographyLevels.push(u));var y=new l;return y.forStorage=!1,y.countryID=e.country,y.variables=e.variables,r.returnGeometry=i,i&&(y.outSR=r.geometry?r.geometry.spatialReference:e.outSR),y.studyAreas.push(r),o.enrich(y).then(function(e){var r=e.featureSets[0].features;return u&&(d?r.push(n._countryValues.getValue(f)):n._countryValues.setValue(f,r[r.length-1])),a&&(t?r[0].geometry=n._geometries.getValue(s):n._geometries.setValue(s,r[0].geometry)),e.featureSets[0]})},setCapacity:function(e){this.inherited(arguments),this._countryValues.setCapacity(e)},toJson:function(){var e=this.inherited(arguments);return e.countryValues=this._countryValues.toJson(),e.geometries=this._geometries.toJson(),e},fromJson:function(e){e&&(this._countryValues.fromJson(e.countryValues,function(e){return new D(e)}),this._geometries.fromJson(e.geometries,function(e){return J.fromJson(e)}),this.inherited(arguments,[e,function(e){return new V(e)}]))}}),q=e([w],{metadata:null,_enrichCache:null,_addressCache:null,constructor:function(e){this._enrichCache=new S(e),this._addressCache=new G(3)},keyToValue:function(e){var t=this,s=[],n=e.returnAddress;delete e.returnAddress,s.push(this._enrichCache.getValue(e));var i=m(e.studyArea);return n&&s.push(this._addressCache.getValue(i.geometry)),r(s).then(function(e){var s=e[0],r=s.features[0];return r.attributes[t.metadata.name]||(r.attributes[t.metadata.name]=a(i.getGeomType(),i.options),n?r.attributes[t.metadata.address]=e[1]:i instanceof v&&(r.attributes[t.metadata.address]=i.address.text)),s})},setCapacity:function(e){this.inherited(arguments),this._enrichCache.setCapacity(e)},toJson:function(e){var s=this.inherited(arguments);return s.metadata=t.clone(this.metadata),s.enrichCache=this._enrichCache.toJson(),s.addressCache=this._addressCache.toJson(),s},fromJson:function(e){e&&(this.metadata=e.metadata,this._enrichCache.fromJson(e.enrichCache),this._addressCache.fromJson(e.addressCache),this.inherited(arguments,[e,function(e){return new V(e)}]))}}),L=e("esri.dijit.geoenrichment.Geoenrichment",[u,_],{country:null,returnGeometry:!1,returnAddress:!1,returnData:!0,studyArea:null,outSR:null,buffer:null,variables:null,levels:null,highestLevel:null,data:null,restartOnDone:!1,requests:null,started:!1,cache:null,constructor:function(){this.buffer=new c,this.cache=new q,this.cache.metadata=this.metadata},handleResponse:function(e){try{this.data=e,this.onDone(null)}catch(t){this.onDone(t)}},handleError:function(e){this.onDone(e)},onDone:function(e){this.requests=null,e?"CancelError"!==e.name&&(console.log(e),s.emit(this,"error",e)):s.emit(this,"data"),this.restartOnDone?(this.invalidate(),this.restartOnDone=!1):(s.emit(this,"end"),this.started=!1)},requestData:function(){if(this.studyArea&&this.variables&&this.buffer){this.requests=[],this.started||(s.emit(this,"start"),this.started=!0);var e,n=this.buffer,r=!1;if(this.studyArea instanceof y)switch(this.studyArea.geometry.type){case"point":r=this.returnAddress;break;case"polyline":this.buffer instanceof f&&(n=new c);break;case"polygon":n=null}var a=t.clone(this.studyArea);if(!a.options&&n&&(a.options=n),this.levels)for(var i=0;i<this.levels.length;i++)a.comparisonGeographyLevels.push(new d({layerID:this.levels[i]}));this.highestLevel&&a.comparisonGeographyLevels.push(new d({layerID:this.highestLevel})),a.returnGeometry=this.returnGeometry,e=k(this.cache.getValue({country:this.country,variables:this.variables,returnData:this.returnData,studyArea:a.toJson(),outSR:this.outSR,returnAddress:r})),this.requests.push(e),e.then(t.hitch(this,this.handleResponse),t.hitch(this,this.handleError))}},invalidate:function(){this.pendingInvoke("requestData")||(this.requests?this.restartOnDone=!0:(this.geometry=null,this.invoke("requestData")))},setStudyArea:function(e){this.studyArea=e,this.invalidate()},setBuffer:function(e){this.buffer=e,this.invalidate()},getBuffer:function(){return this.buffer},invalidateData:function(){this.data=null,this.invalidate()},setVariables:function(e){p.arraysEqual(this.variables,e)||(this.variables=e,this.invalidateData())},setGeoLevels:function(e,t){p.arraysEqual(this.levels,e)&&this.highestLevel==t||(this.levels=e,this.highestLevel=t,this.invalidateData())},setCacheLimit:function(e){this.cache.setCapacity(e)},getData:function(){return this.data},getGeometry:function(){return this.data.features[0].geometry},isBusy:function(){return this.pendingInvoke("requestData")||this.requests||this.restartOnDone},stop:function(){if(this.restartOnDone=!1,this.cancelInvoke("requestData"),this.requests)for(var e=this.requests.slice(0),t=0;t<e.length;t++)e[t].cancel()},setReturnAddress:function(e){this.returnAddress!=e&&(this.returnAddress=e,e&&this.invalidateData())}});return L});