// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","./TextStyleBuilder","../TransformUtil","./FlowCalculator","./ReplaceUtil","./SiblingsUtil"],function(e,i,n,t,r,s,o,a){var l={_linesNode:null,_wordNode:null,createTempLinesNode:function(e){return this._linesNode=this._linesNode||this._createTempNode(),this._styleNode(this._linesNode,e,!0)},createTempWordNode:function(e){return this._wordNode=this._wordNode||this._createTempNode(),this._styleNode(this._wordNode,e)},_createTempNode:function(){var i=e.create("div",null,document.body);return n.set(i,{position:"absolute",display:"inline-block"}),i},_styleNode:function(e,i,r){return t.resetTextStyle(e),n.set(e,"width",r?i.style.cw+"px":""),n.set(e,"display","inline-block"),n.set(e,i.style.getTextStyleObject()),e},dispose:function(e){e&&n.set(e,"display","none")}},d={getParagraphs:function(e,i){function n(e){return o.collapseMultipleSpaces(e.trim())}var t=i.style.getTextStyle("whiteSpace"),r="pre-wrap"===t||"pre"===t||"pre-line"===t;r||(e=o.removeReturns(e));var s="pre-wrap"===t||"pre"===t;s||(e=n(e));var a=r?e.split(String.fromCharCode(10)):[e];return a.length>1&&!s&&(a=a.map(n)),a}},h={measureWidth:function(e,i){return i.innerHTML=e,n.get(i,"width")}},u={getLinesForWords:function(e,n,t,r){function s(){var e=t.innerHTML;t.innerHTML="";var i=e.split("");return u.getLinesForWords(i,n,t,{checkBreaking:!1,separator:""}).lines}function o(e){var i=e.split("");return u.getLinesForWords(i,n,t,{checkBreaking:!1,separator:"",clearLinesNodeBeforeMeasure:!r.isBreakAll}).lines}var a,l,d=0;r.checkBreaking&&(t.innerHTML="a",l=i.position(t).h);var c=0,g="";r.clearLinesNodeBeforeMeasure&&(t.innerHTML=""),e.some(function(e){if(a){var u;r.checkBreaking&&(u=t.innerHTML),t.innerHTML+=r.separator+e;var p=i.position(t).h;if(c>0&&p>c){a.push({text:g,w:h.measureWidth(g,n),lineHeight:d});var f;if(r.checkBreaking&&(p-c>1.2*l||r.isBreakAll)){t.innerHTML=g+r.separator;var L=o(e);t.innerHTML=u+r.separator+e,L.length>1&&(f=!0,L.forEach(function(e,i){if(i<L.length-1)if(0===i&&r.isBreakAll){var t=a[a.length-1];t.text+=r.separator+e.text,t.w=h.measureWidth(t.text,n)}else a.push(e);else d=e.lineHeight,g=e.text}),c=p)}f||(g=e,d=p-c,c=p)}else g+=r.separator+e,0===c&&(c=i.position(t).h,d=c)}else if(a=[],r.clearLinesNodeBeforeMeasure?t.innerHTML=e:t.innerHTML+=e,g=e,c=i.position(t).h,d=c,r.checkBreaking&&c>1.2*l){var T=s();T.length>1&&T.forEach(function(e,i){i<T.length-1?a.push(e):(d=e.lineHeight,g=e.text)})}}),a.push({text:g,w:h.measureWidth(g,n),lineHeight:d});var p=i.position(t).w;return{lines:a,textWidth:p,lineHeight:d}}},c={getLinesForParagraph:function(e,i,n,t){var r=e.split(" "),s="break-word"===i.style.getTextStyle("overflowWrap"),o="break-all"===i.style.getTextStyle("wordBreak");return u.getLinesForWords(r,n,t,{checkBreaking:s||o,isBreakAll:o,clearLinesNodeBeforeMeasure:!0,separator:" "})}},g={_node:null,_originalInnerHTML:null,_nextSiblingsHideInfo:null,setNode:function(e){this._node=e,this._originalInnerHTML=null,this._nextSiblingsHideInfo=null},doPresets:function(){this._originalInnerHTML=this._node.innerHTML,this.hideNextSibling()},undoPresets:function(){this.showNextSibling(),this._node.innerHTML=this._originalInnerHTML},hideNextSibling:function(){this._nextSiblingsHideInfo||(this._nextSiblingsHideInfo=a.hideNextSiblings(this._node))},showNextSibling:function(){a.showNextSiblings(this._nextSiblingsHideInfo),this._nextSiblingsHideInfo=null}};return{getLines:function(e,n,t){if(e.innerHTML&&e.innerHTML.trim()){var s=r.disableTransform(e,n.parentVs);g.setNode(e),g.doPresets();var o,a=n.isSpanLike?e:l.createTempLinesNode(n),h=l.createTempWordNode(n),u=d.getParagraphs(e.innerHTML,n),p=[];if(u.forEach(function(e){var i=c.getLinesForParagraph(e,n,h,a);o=i.textWidth,p=p.concat(i.lines)}),n.isSpanLike){a.innerHTML=g._originalInnerHTML;var f=i.position(a).h;g.showNextSibling();var L=i.position(a).h;if(L>f){var T=(L-f)/2;p[p.length-1].lineHeight+=T}g.hideNextSibling()}return g.undoPresets(),l.dispose(h),!n.isSpanLike&&l.dispose(a),r.restoreTransform(s),{lines:p,textWidth:o}}},getSpanFlowOffsets:function(e,i){return s.getSpanFlowOffsets(e,i)}}});