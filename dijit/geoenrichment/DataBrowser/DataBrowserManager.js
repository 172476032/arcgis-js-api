// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/array","dojo/when","dojo/Stateful","dojo/dom-geometry","dojo/Deferred","./VariableInfo","./VariableUtil"],function(e,t,i,l,n,o,r,s){return e(l,{variables:null,selectionLimit:-1,variableQuery:null,selection:null,variableInfo:null,flyAnim:null,onLimit:null,allowShoppingCart:!1,allowMultipleSelectInGroup:!1,categoryPageIndex:0,constructor:function(e){this.variables=e.variables,this.selectionLimit=isNaN(e.selectionLimit)?-1:e.selectionLimit,this.allowShoppingCart=this.multipleSelectIsAllowed()&&!!e.shoppingCart,this.allowMultipleSelectInGroup=this.multipleSelectIsAllowed()&&!!e.allowMultipleSelectInGroup,e.variableQuery=this.variableQuery=e.variableQuery||{},e.countryID=this.variableQuery.countryID=this.variableQuery.countryID||e.countryID||null,e.favorites&&!this.variables.favorites&&(this.variables.favorites=e.favorites),this.variables.synchronize(e.countryID),e.selection&&e.selection.length&&this.multipleSelectIsAllowed()&&this.changeSelection(e.selection),this.selection=[],e.selection=this.selection;var t=e.variableInfo;if(!1!==t){if(!0===t)t="fullName";else if(t&&t.domNode)return void(this.variableInfo=t);this.variableInfo=new r({infoFields:t}),e.own(this.variableInfo)}},postscript:function(){},multipleSelectIsAllowed:function(){return this.selectionLimit<0||this.selectionLimit>1},changeSelection:function(e){var t=this,l=new o;return i(this.variables.synchronize(),function(){setTimeout(function(){t.selection=[],t.addToSelection(e,!0),l.resolve()},0)}),l.promise},validateSelection:function(){var e=t.filter(this.selection,function(e){return this.variables.get(e)},this);e.length!=this.selection.length&&this.set("selection",e)},addToSelection:function(e,i){"string"==typeof e&&(e=[e]);var l=this.selection.slice(),n={},o=!1;return t.forEach(e,function(e){if(this.variables.get(e)){if(this.selectionLimit>=0&&l.length==this.selectionLimit)return void(o=!0);var i=s.getToggleGroups(this.variables,[e],this.allowMultipleSelectInGroup);t.every(l,function(e){return!i.hash[e]})&&(l.push(i.groups[0].value),n[e]=!0)}},this),l.length&&!this._ensureValidSelection(l)?null:(i||this.selection.length!=l.length?this.set("selection",l):n=null,o&&this.onLimit&&this.onLimit(),n)},_ensureValidSelection:function(e){return!0},removeFromSelection:function(e,i){"string"==typeof e&&(e=[e]);var l=[],n=s.getToggleGroups(this.variables,e,!i&&this.allowMultipleSelectInGroup).hash,o={};return t.forEach(this.selection,function(e){n[e]?o[e]=!0:l.push(e)}),this.selection.length!=l.length?(this.set("selection",l),o):null},updateSelection:function(e){var i=s.getToggleGroups(this.variables,[e],this.allowMultipleSelectInGroup),l=-1;if(t.some(this.selection,function(e,t){return!!i.hash[e]&&(l=t,!0)}),l>=0){var n=this.selection.slice();n[l]=i.groups[0].value,this.set("selection",n)}},getSelectionGroups:function(){return this._selectionGroups||(this._selectionGroups=s.getToggleGroups(this.variables,this.selection,this.allowMultipleSelectInGroup)),this._selectionGroups},_selectionSetter:function(e){this._selectionGroups=null,this.selection=e},_selectionGroups:null,animateSelection:function(e){this.flyAnim.fly(e,"DataBrowser_SelectVar",["top",n.isBodyLtr()?"right":"left"])},composeQuery:function(e){e&&"string"==typeof e&&(e=[e]);var i={countryID:this._getQueryCountryID()};return t.forEach(e,function(e){var t=this.variableQuery[e];t&&(i[e]=t)},this),i},_getQueryCountryID:function(){return this.variableQuery.countryID},validateQuery:function(){var e=this.variableQuery,t=e.dataCollectionID?this.getDataCollection():e.categoryID?this.getCategory():this.queryVariables(),l=this;return i(t).then(function(t){return t||l.set("variableQuery",l.composeQuery()),e.dataCollectionID||e.categoryID?null:t},function(e){return l.set("variableQuery",l.composeQuery()),null})},getCategories:function(){return this.variables.categories.query(this.composeQuery())},queryVariables:function(e){return this.variables.query(this.variableQuery,e)},getCategory:function(e){if(!(e=e||this.variableQuery.categoryID))return null;var t=this.composeQuery();t.id=e;var i=this.variables.categories.query(t),l=this;return i.then?i.then(function(t){return l._getCategory(t,e)}):this._getCategory(i,e)},_getCategory:function(e,t){return e[0]},getDataCollection:function(e){if(!(e=e||this.variableQuery.dataCollectionID))return null;var t=this.composeQuery();t.id=e;var i=this.variables.dataCollections.query(t),l=this;return i.then?i.then(function(t){return l._getDataCollection(t,e)}):this._getDataCollection(i,e)},_getDataCollection:function(e,t){return e[0]}})});