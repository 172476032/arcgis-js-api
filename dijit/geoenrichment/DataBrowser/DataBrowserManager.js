// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.17/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/when","dojo/Stateful","dojo/dom-geometry","./VariableInfo","./DeferredStore","./VariableUtil"],function(e,t,i,l,n,o,r,s,a){return e(n,{variables:null,selectionLimit:-1,variableQuery:null,selection:null,variableInfo:null,flyAnim:null,onLimit:null,allowShoppingCart:!1,allowMultipleSelectInGroup:!1,constructor:function(e){this.variables=e.variables,this.selectionLimit=isNaN(e.selectionLimit)?-1:e.selectionLimit,this.allowShoppingCart=this.multipleSelectIsAllowed()&&!!e.shoppingCart,this.allowMultipleSelectInGroup=this.multipleSelectIsAllowed()&&!this.allowShoppingCart&&!!e.allowMultipleSelectInGroup,e.variableQuery=this.variableQuery=e.variableQuery||{},e.countryID=this.variableQuery.countryID=this.variableQuery.countryID||e.countryID||null,e.favorites&&!this.variables.favorites&&(this.variables.favorites=e.favorites),this.variables.synchronize(e.countryID),e.selection&&e.selection.length&&this.multipleSelectIsAllowed()&&this.changeSelection(e.selection),this.selection=[],e.selection=this.selection;var t=e.variableInfo;if(t!==!1){if(t===!0)t="fullName";else if(t&&t.domNode)return void(this.variableInfo=t);this.variableInfo=new r({infoFields:t}),e.own(this.variableInfo)}},postscript:function(){},multipleSelectIsAllowed:function(){return this.selectionLimit<0||this.selectionLimit>1},changeSelection:function(e){var t=this;l(this.variables.synchronize(),function(){setTimeout(function(){t.selection=[],t.addToSelection(e,!0)},0)})},validateSelection:function(){var e=i.filter(this.selection,function(e){return this.variables.get(e)},this);e.length!=this.selection.length&&this.set("selection",e)},addToSelection:function(e,t){"string"==typeof e&&(e=[e]);var l=this.selection.slice(),n={},o=!1;return i.forEach(e,function(e){if(this.variables.get(e)){if(this.selectionLimit>=0&&l.length==this.selectionLimit)return void(o=!0);var t=a.getToggleGroups(this.variables,[e],this.allowMultipleSelectInGroup);i.every(l,function(e){return!t.hash[e]})&&(l.push(t.groups[0].value),n[e]=!0)}},this),l.length&&!this._ensureValidSelection(l)?null:(t||this.selection.length!=l.length?this.set("selection",l):n=null,o&&this.onLimit&&this.onLimit(),n)},_ensureValidSelection:function(){return!0},removeFromSelection:function(e,t){"string"==typeof e&&(e=[e]);var l=[],n=a.getToggleGroups(this.variables,e,!t&&this.allowMultipleSelectInGroup).hash,o={};return i.forEach(this.selection,function(e){n[e]?o[e]=!0:l.push(e)}),this.selection.length!=l.length?(this.set("selection",l),o):null},updateSelection:function(e){var t=a.getToggleGroups(this.variables,[e],this.allowMultipleSelectInGroup),l=-1;if(i.some(this.selection,function(e,i){return t.hash[e]?(l=i,!0):!1}),l>=0){var n=this.selection.slice();n[l]=t.groups[0].value,this.set("selection",n)}},getSelectionGroups:function(){return this._selectionGroups||(this._selectionGroups=a.getToggleGroups(this.variables,this.selection,this.allowMultipleSelectInGroup)),this._selectionGroups},_selectionSetter:function(e){this._selectionGroups=null,this.selection=e},_selectionGroups:null,animateSelection:function(e){this.flyAnim.fly(e,"DataBrowser_SelectVar",["top",o.isBodyLtr()?"right":"left"])},composeQuery:function(e){e&&"string"==typeof e&&(e=[e]);var t={countryID:this._getQueryCountryID()};return i.forEach(e,function(e){var i=this.variableQuery[e];i&&(t[e]=i)},this),t},_getQueryCountryID:function(){return this.variableQuery.countryID},validateQuery:function(){var e=this.variableQuery,t=e.dataCollectionID?this.getDataCollection():e.categoryID?this.getCategory():this.queryVariables(),i=this;return l(t).then(function(t){return t||i.set("variableQuery",i.composeQuery()),e.dataCollectionID||e.categoryID?null:t},function(){return i.set("variableQuery",i.composeQuery()),null})},getCategories:function(){return this.variables.categories.query(this.composeQuery())},queryVariables:function(e){return this.variables.query(this.variableQuery,e)},getCategory:function(e){if(e=e||this.variableQuery.categoryID,!e)return null;var t=this.composeQuery();t.id=e;var i=this.variables.categories.query(t),l=this;return i.then?i.then(function(t){return l._getCategory(t,e)}):this._getCategory(i,e)},_getCategory:function(e){return e[0]},getDataCollection:function(e){if(e=e||this.variableQuery.dataCollectionID,!e)return null;var t=this.composeQuery();t.id=e;var i=this.variables.dataCollections.query(t),l=this;return i.then?i.then(function(t){return l._getDataCollection(t,e)}):this._getDataCollection(i,e)},_getDataCollection:function(e){return e[0]}})});