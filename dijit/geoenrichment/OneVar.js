// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["../../declare","./BaseWidget","./dom","dojo/dom-class","dojo/dom-construct","dojo/dom-attr","dojo/query","dojo/string","./lang","dojo/i18n!../../nls/jsapi","./utils","./formatVariable"],function(e,t,a,s,r,i,n,l,o,u,h,d){return u=u.geoenrichment.dijit.OneVar,e("esri.dijit.geoenrichment.OneVar",[t],{baseClass:"Infographics_OneVar",constructor:function(){this._state={sortBy:1,sortDesc:!0}},_calculate:function(){var e=this.getDataFields(),t=this.getFieldByIndex(e[0]);return this.primary&&(this.primary.innerHTML=this.formatByIndex(0,e[0])+" "),{firstCol:t}},_getLessThanPattern:function(){return u.lessThan},_getMoreThanPattern:function(){return u.moreThan},_getSamePattern:function(){return u.same},_isSiteRowFeature:function(e){return!1},_canCreateValueBlock:function(){return!0},updateUIExpanded:function(){this.inherited(arguments);var e,t=this._calculate(),n=t.firstCol,c=[];if(n){var C=[],p=this.data.features.length;for(e=0;e<p;e++){var m=[];c.length&&!this._isSiteRowFeature(this.data.features[e])||c.push(m),m.push(this.getFeatureTitle(e)),m.push(this.getValueByName(e,n.name)),C.push(m)}this.site&&(this.site.innerHTML=u.subtitleSite2),this._sortRows(C);var _=this.getValueByName(0,n.name),V=o.isNumber(_);if(V){var M=this.getValueByName(p-1,n.name),g=this.getFeatureTitle(p-1),f=1-M/_;Math.abs(f)<.005&&(f=0);var w;w=f<0?this._getLessThanPattern():f>0?this._getMoreThanPattern():this._getSamePattern(),this.comp&&(this.comp.innerHTML=l.substitute(w,{site:g}))}else this.comp&&(this.comp.innerHTML="");for(var O=this.table,v=C.length+1;O.rows.length>1;)O.deleteRow(-1);var T=O.rows[0];if(V)for(;T.cells.length<4;)T.insertCell(-1);else for(;T.cells.length>2;)r.destroy(T.cells[T.cells.length-1]);for(e=1;e<v;e++){var H=O.insertRow(-1);if(e%2==0&&e>0&&(H.className="AlternatingRow"),i.set(H.insertCell(-1),"class","OneVarMultiComparison_TextColumn"),i.set(H.insertCell(-1),"class","OneVarMultiComparison_ValueColumn"),V){var y=i.set(H.insertCell(-1),"class","OneVarMultiComparison_ChartColumn");i.set(y,"colspan","2")}}var R=Number.NEGATIVE_INFINITY;if(V){for(e=0;e<C.length;e++)C[e][1]>R&&(R=C[e][1]);R=h.getCeiling(R),O.rows[0].cells[2].innerHTML=d(n,0),O.rows[0].cells[3].innerHTML=d(n,R)}for(e=0;e<C.length;e++)if(T=O.rows[e+1],T.cells[0].innerHTML=C[e][0],T.cells[1].innerHTML=d(n,C[e][1]),V){var b;-1!==c.indexOf(C[e])?(s.remove(T,"OneVarMultiComparison_Row"),s.add(T,"OneVarMultiComparison_CurrentRow"),b="OneVarMultiComparison_Expanded_CurrentBar"):(s.remove(T,"OneVarMultiComparison_CurrentRow"),s.add(T,"OneVarMultiComparison_Row"),b="OneVarMultiComparison_Expanded_Bar");var x=a.pct(C[e][1]/R);T.cells[2].innerHTML="<div class='"+b+"' style='width:"+x+"' />",i.set(T.cells[0],"style","width:50%"),i.set(T.cells[1],"style","width:20%")}else i.set(T.cells[0],"style","width:50%"),i.set(T.cells[1],"style","width:50%")}},updateUICollapsed:function(){this.inherited(arguments);var e,t=this._calculate(),a=t.firstCol,r=[];if(a){var l=[],u=this.data.features.length;for(e=0;e<u;e++){var h=[];r.length&&!this._isSiteRowFeature(this.data.features[e])||r.push(h),h.push(this.getFeatureTitle(e)),h.push(this.getValueByName(e,a.name)),l.push(h)}this._sortRows(l);var c=this.getValueByName(0,a.name),C=this.table,p=l.length+1;for(e=C.rows.length;e<p;e++){var m=C.insertRow(-1);e%2==0&&(m.className="AlternatingRow"),i.set(m.insertCell(-1),"class","OneVarMultiComparison_TextColumn"),i.set(m.insertCell(-1),"class","OneVarMultiComparison_ValueColumn")}for(;C.rows.length>p;)C.deleteRow(-1);var _=o.isNumber(c),V=n("col",this.table);for(_?(i.set(V[0],"style","width:70%"),i.set(V[1],"style","width:30%")):(i.set(V[0],"style","width:50%"),i.set(V[1],"style","width:50%")),e=0;e<l.length;e++){var M=C.rows[e+1];M.cells[0].innerHTML=l[e][0],M.cells[1].innerHTML=d(a,l[e][1]),-1!==r.indexOf(l[e])?(s.remove(M,"OneVarMultiComparison_Row"),s.add(M,"OneVarMultiComparison_CurrentRow")):(s.remove(M,"OneVarMultiComparison_CurrentRow"),s.add(M,"OneVarMultiComparison_Row"))}}},createUIExpanded:function(e){if(this.inherited(arguments),this._canCreateValueBlock()){var t=e.addHeader("div",{class:"OneVarMultiComparison_Value"}),s=r.create("table",{cellpadding:"0",cellspacing:"0"},t),n=s.insertRow(0),l=n.insertCell(-1);this.site=r.create("span",{class:"OneVarMultiComparison_Expanded_Value_Site"},l),n=s.insertRow(-1),l=n.insertCell(-1),this.primary=r.create("span",{class:"OneVarMultiComparison_Expanded_Value_Primary"},l),this.comp=r.create("span",{class:"OneVarMultiComparison_Comparison"},l)}this.table=e.addContent("table",{class:"OneVarMultiComparison_Table"}),a.createCols(this.table,[.5,.2,.15,.15]),n=this.table.insertRow(-1),this._appendSortHeader(n,u.areaCol,0,{class:"OneVarMultiComparison_TextColumnHeader"}),this._appendSortHeader(n,u.valueCol,1,{class:"OneVarMultiComparison_ValueColumnHeader"}),i.set(n.insertCell(-1),"class","OneVarMultiComparison_ChartColumnHeader_Lower"),i.set(n.insertCell(-1),"class","OneVarMultiComparison_ChartColumnHeader_Upper"),this.autoHeight&&e.contentClass.push("OneVarMultiComparison_Expanded_ContentPane"),e.addFooter("div")},createUICollapsed:function(e){if(this.inherited(arguments),this._canCreateValueBlock()){var t=e.addHeader("div",{class:"OneVarMultiComparison_Value"}),s=r.create("table",{cellpadding:"0",cellspacing:"0"},t),n=s.insertRow(0),l=n.insertCell(-1);this.site=r.create("span",{class:"OneVarMultiComparison_Expanded_Value_Site"},l),n=s.insertRow(-1),l=n.insertCell(-1),this.primary=r.create("span",{class:"OneVarMultiComparison_Expanded_Value_Primary"},l)}this.table=e.addContent("table",{class:"OneVarMultiComparison_Table"}),a.createCols(this.table,[.7,.3]),n=this.table.insertRow(-1),this._appendSortHeader(n,u.areaCol,0,{class:"OneVarMultiComparison_TextColumnHeader"}),this._appendSortHeader(n,u.valueCol,1,{class:"OneVarMultiComparison_ValueColumnHeader"}),i.set(n.insertCell(-1),"class","OneVarMultiComparison_ChartColumnHeader_Lower"),i.set(n.insertCell(-1),"class","OneVarMultiComparison_ChartColumnHeader_Upper"),this.autoHeight&&e.contentClass.push("OneVarMultiComparison_Expanded_ContentPane"),e.addFooter("div")}})});