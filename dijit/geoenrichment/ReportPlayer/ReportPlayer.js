// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/dom-class","dojo/on","dojo/when","dojo/promise/all","dijit/_WidgetBase","dijit/_TemplatedMixin","./dataProviders/commands/_config","./playerSupports/_CommandSupport","./playerSupports/_KeyboardNavigationSupport","./playerSupports/_LogoSupport","./playerSupports/_MapSupport","./playerSupports/_PageNavigationSupport","./playerSupports/_PlayerAreaSelectSupport","./playerSupports/_PrintSupport","./playerSupports/_ReportContainersSwitcher","./playerSupports/_SmartLayoutSupport","./playerSupports/_ZoomSupport","./playerSupports/_HeaderArrangeSupport","./printing/PageOptionsDialog/PageOptionsDialog","./ReportPlayerViewModel","./PlayerResizeModes","./PlayerZoomBehaviors","./PlayerThemes","./core/layout/LayoutBuilder","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/Queue","esri/dijit/geoenrichment/utils/WaitingUtil","dojo/text!./templates/ReportPlayer.html","dojo/i18n!../../../nls/jsapi"],function(e,t,i,r,a,n,o,s,l,h,p,d,u,_,g,c,m,f,y,D,v,w,A,R,C,S,P,I,M,E,T,L){return L=L.geoenrichment.dijit.ReportPlayer.ReportPlayer,e([s,l,p,u,_,m,f,y,D,c,d,g,v],{templateString:T,nls:L,dataProvider:null,config:{},isSlidesView:!1,theme:S.DARK,allowKeyboardNavigation:!0,showAreaTitle:!0,resizeMode:R.AUTO,listenToWindowResize:!0,printConfig:{subtitle:L.preparedByEsri,printDialogClass:w},defaultZoomBehavior:C.RESET,_viewModel:null,_initPromise:null,_reportData:null,_analysisAreaIndex:0,_disableAnimation:!1,postCreate:function(){this.inherited(arguments),Object.assign(h,this.config),I.hide(this.errorViewDiv),this._applyTheme()},startup:function(){this.inherited(arguments),!this._viewModel&&this._reportData&&(this._viewModel=new A,this._disableAnimation&&(this._viewModel.chartAnimationAllowed=!1),this._viewModel.layoutBuilder=(new this._getLayoutBuilder)(),this._initPromise=n(this._viewModel.layoutBuilder.initialize()))},_getLayoutBuilder:function(){return P},playReport:function(e,t){var i=this;return this._showWaiting(),n(this.dataProvider.getReportData(e),function(e){return i.setReportData(e,t)},function(e){i._showError(e)})},_isDataBeingSetFlag:!1,setReportData:function(e,t){function r(){return 0>o?void n.resolve():void a._setReportData(e,{analysisAreaIndex:o--,rerenderContent:!1}).then(function(){setTimeout(r,30)},n.reject)}var a=this;t=t||{},t.disableAnimation&&(this._disableAnimation=!0),this._isDataBeingSetFlag=!0,this.onSetReportDataStart();var n=new i;if(t.preloadAllPages===!1||1==e.analysisAreas.length)this._resetLoadedFlags(),this._resetMapBuilder(),this._setReportData(e).then(n.resolve,n.reject);else{t._resetLoadedContents!==!1&&(this._resetLoadedFlags(),this._resetMapBuilder());var o=e.analysisAreas.length-1;r()}return this._showWaiting(),n.promise.always(function(){return a._removeWaiting(),a._isDataBeingSetFlag=!1,a.onSetReportDataEnd(),a._emitPendingResizedEvent(),t.waitUntilAllContentIsReady?a.isContentLoading():void 0})},refresh:function(e){return this._reportData&&n(this.setReportData(this._reportData,{waitUntilAllContentIsReady:!(!e||!e.waitUntilAllContentIsReady),_resetLoadedContents:!(!e||!e.rerenderContent)}),function(){return this.showPageAt(0),this.resize()}.bind(this))},showAnalysisAreaAt:function(e,t){var i=this._setReportData(this._reportData,{analysisAreaIndex:e,rerenderContent:!(!t||!t.rerenderContent)});return t&&t.waitUntilAllContentIsReady?this.isContentLoading():i},_setReportData:function(e,t){var i=this;t=t||{};var r=t.rerenderContent!==!1;return this._reportData=e,I.hide(this.normalViewDiv),I.hide(this.errorViewDiv),this._analysisAreaIndex=this._reportData&&void 0!==t.analysisAreaIndex?t.analysisAreaIndex:0,this._reportData?(I.show(this.normalViewDiv),this._updateMapPortalUrl(),this._setFallbackMapImageInfos(this._reportData.mapImageInfos),this.startup(),n(this._initPromise,function(){return i._updateAreaSelect(),i._configureViewModel(),n(i._setReportContainer(r),function(e){return e===!0&&i.__doApplyTemplateJson(t)})})):void this._showError()},__doApplyTemplateJson:function(e){var t=this.getCurrentReportContainer().fromJson(this._reportData.templateJson,{waitUntilAllContentIsReady:!0});return this._registerContntainerLoadPromise(t),this._setCurrentContainerLoaded(),this.showPageAt(this._currentPageIndex),this.resize()},_loadQueue:null,isContentLoading:function(){return this._loadQueue&&this._loadQueue.getLoadPromise()},_registerContntainerLoadPromise:function(e){var t=this;this._loadQueue||(this._loadQueue=new M({onLoadStart:function(){I.enableContentAbsolute(t.commandButtonsContainer,!1)},onLoadEnd:function(){I.enableContentAbsolute(t.commandButtonsContainer,!0)}})),this._loadQueue.add(e)},getReportData:function(){return this._reportData},updateTemplateJson:function(e){this._reportData&&e&&(this._reportData.templateJson=e)},getReportTitle:function(){return this._reportData&&this._reportData.reportTitle||""},getCurrentAnalysisAreaIndex:function(){return this._analysisAreaIndex},getCurrentAnalysisArea:function(){return this._reportData&&this._reportData.analysisAreas[this._analysisAreaIndex]},_configureViewModel:function(){var e=this;this._viewModel.setTheme(this._reportData.theme);var i=this.__getCurrentAnalysisAreaConfiguration();this._viewModel.setDynamicReportInfo({fieldData:i.fieldData,features:i.features,infographicOptions:this._reportData.infographicOptions,attachmentsStore:this._reportData.attachmentsStore,createMapFunc:t.hitch(this,this._createMap),reportType:this._reportData.reportType,isClassic:this._reportData.isClassic,isFixedDataMode:!this._reportData.config.geoenrichmentUrl}),this._viewModel.getDynamicImageFunc=t.hitch(this,this._getReportLogo),this._viewModel.enrichFieldData=function(r){return e.dataProvider.enrichFieldData(r,t.mixin({analysisAreas:[i.analysisArea],fieldData:i.fieldData},e._reportData.config))}},__getCurrentAnalysisAreaConfiguration:function(){this._reportData.infographicOptions&&this._reportData.infographicOptions.setCurrentAnalysisAreaIndex(this._analysisAreaIndex);var e=t.mixin({},this._reportData.fieldData);e.featureData=[this._reportData.fieldData.featureData[this._analysisAreaIndex]];var i=this._reportData.analysisAreas[this._analysisAreaIndex];return{fieldData:e,analysisArea:i,features:[i.feature]}},getNumberOfPages:function(){return this.getCurrentReportContainer().getNumberOfPages()},notifyShown:function(){this.getCurrentReportContainer()&&this.getCurrentReportContainer().notifyShown()},_showWaiting:function(){this.normalViewDiv.style.opacity="0.01",E.showProgress(this.waitingDiv,"esriGEReportPlayerProgress"),I.show(this.waitingDiv)},_removeWaiting:function(){E.removeProgress(this.waitingDiv),I.hide(this.waitingDiv),this.normalViewDiv.style.opacity=""},_showError:function(e){e&&console.log(e),I.hide(this.normalViewDiv),I.show(this.errorViewDiv),this.onError(e)},setPrintMode:function(e){r[e?"add":"remove"](this.domNode,"esriGEReportPlayerInPrinting")},resize:function(){return this._applyTheme(),this.inherited(arguments)},_applyTheme:function(){r.remove(this.domNode,"playerThemeDark playerThemeLight"),r.add(this.domNode,this.theme==S.DARK?"playerThemeDark":"playerThemeLight")},_pendingResizeEvent:null,_emitResizedEvent:function(e){this._pendingResizeEvent={isPaginating:!!e},this._isDataBeingSetFlag||this._emitPendingResizedEvent()},_emitPendingResizedEvent:function(){this._pendingResizeEvent&&(this.onResized(this._pendingResizeEvent.isPaginating),this._pendingResizeEvent=null)},onSetReportDataStart:function(){},onSetReportDataEnd:function(){},onResized:function(e){},onError:function(e){}})});