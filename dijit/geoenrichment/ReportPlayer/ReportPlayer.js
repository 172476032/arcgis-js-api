// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/dom-class","dojo/when","dijit/_WidgetBase","dijit/_TemplatedMixin","./config","./playerSupports/_CommandSupport","./playerSupports/_KeyboardSwipeNavigationSupport","./playerSupports/_LogoSupport","./playerSupports/_MapSupport","./playerSupports/_PageNavigationSupport","./playerSupports/_PrintSupport","./playerSupports/_ReportContainersSwitcher","./playerSupports/_SmartLayoutSupport","./playerSupports/_ZoomSupport","./playerSupports/_WaitingSupport","./supportClasses/PlayerConfigurator","./supportClasses/PlayerToFullScreenAnimator","./printing/PageOptionsDialog/PageOptionsDialog","./PlayerToolbar","./ReportPlayerViewModel","./PlayerResizeModes","./PlayerThemes","./ReportPlayerState","./DataProviderGE","esri/dijit/geoenrichment/utils/DelayUtil","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/async/AsyncQueue","dojo/text!./templates/ReportPlayer.html","dojo/i18n!esri/nls/jsapi","./_devConfig"],function(t,e,i,r,o,n,a,s,l,h,p,d,u,_,g,c,m,f,y,C,D,v,w,A,P,S,R,b,T,M,I,E,F,N){return F=F.geoenrichment.dijit.ReportPlayer.ReportPlayer,t([n,a,l,p,d,_,g,c,m,h,u,f],{templateString:E,nls:F,dataProvider:null,exportCommands:null,config:null,theme:void 0,viewMode:void 0,enableDataDrilling:void 0,showToolbarInPopup:void 0,showAreaTitle:void 0,scaleSlidesToFitWindow:void 0,showCloseButton:!1,showToFullScreenAnimation:!1,allowKeyboardNavigation:void 0,allowSwipeNavigation:void 0,resizeMode:void 0,renderMapsFromCalculators:!1,printConfig:{subtitle:F.preparedByEsri,printDialogClass:D},showProgressBar:!0,defaultZoomBehavior:void 0,isDataDrillingPlayer:!1,_viewModel:null,_reportData:null,_analysisAreaIndex:0,_disableAnimation:!1,playerToolbar:null,postCreate:function(){this.config=e.mixin({},s,this.config),this._viewModel=new(this._getViewModelClass()),this.dataProvider=this.dataProvider||new R,this.exportCommands&&this.exportCommands.forEach(function(t){this.dataProvider.registerCommand(t)},this),y.configurePlayer(this),this._initToolbar(),this._initContainerSwither(),this._initSmartLayout(),this._initCommands(),this._initPageNavigationControls(),this._initKeyboardSwipeNavigation(),this._initZoomControls(),this._applyTheme(),this._showError(!1),this._initProgressController(),r[T.isMobileDevice()?"add":"remove"](this.domNode,"esriGEReportPlayerMobile")},_getViewModelClass:function(){return w},_initToolbar:function(){var t=this;this.playerToolbar=new v({popupButtonDiv:this.playerAfterToolbarDiv,showToolbarInPopup:this.showToolbarInPopup,showAreaTitle:this.showAreaTitle,stretchToolbarNode:!this.showToolbarInPopup&&(this.resizeMode===A.FIT_WINDOW?document.body:this.domNode),showCloseButton:this.showCloseButton,isMobileDevice:T.isMobileDevice(),isScrollShown:function(){var e=t.getCurrentReportContainer();return e&&e.isScrollShown&&e.isScrollShown()},onClose:function(){t._onClose()}}).placeAt(this.playerToolbarDiv),this.own(this.playerToolbar),this.playerToolbar.onShowAnalysisAreaAt=function(e){t.showAnalysisAreaAt(e)}},_applyTheme:function(){r.remove(this.domNode,"playerThemeDark playerThemeLight"),r.add(this.domNode,this.theme===P.DARK?"playerThemeDark":"playerThemeLight"),this.playerToolbar.setTheme(this.theme)},playReport:function(t,e){if(this.isContentLoading())return this.isContentLoading();var i=this;return this._showError(!1),this._progressController&&this._progressController.reset(),this.showToFullScreenAnimation&&this.resizeMode===A.FIT_WINDOW&&C.animateTo(this),this.dataProvider._onCreateReportStarted=function(){i._viewModel.preInitialize()},o(this._showWaiting(this.dataProvider.getReportData(t,function(t){i._progressController&&i._progressController.setLoadDataProgress(t)})),function(t){return i.setReportData(t,e)},function(t){i._showError(t)})},_isDataBeingSetFlag:!1,setReportData:function(t,e){if(this.isContentLoading())return this.isContentLoading();var o=this;if(e=e||{},this._reportData=t,!t)return void this._showError(!0);e.disableAnimation&&(this._disableAnimation=!0),this._isDataBeingSetFlag=!0,S.isAnimationSuspended=!0,this.onSetReportDataStart();var n=new i;this._configureViewModel(t),b.delay(0).then(function(){function i(){if(r<0)return void n.resolve();o._applyReportData({analysisAreaIndex:r--,rerenderContent:!1}).then(function(){setTimeout(i,100)},n.reject)}if(1===t.analysisAreas.length||t.isMultiFeature)this._destroyAllContainers(),this._resetMapBuilder(),this._applyReportData({analysisAreaIndex:0,rerenderContent:!0}).then(n.resolve,n.reject);else{!1!==e._resetLoadedContents&&(this._destroyAllContainers(),this._resetMapBuilder());var r=t.analysisAreas.length-1;i()}}.bind(this)),this._progressController&&this._progressController.setNumAreas(t.analysisAreas.length),this._progressController&&this._progressController.setLoadDataProgress(1);var a=n.promise.then(function(){return o._progressController&&o._progressController.finalize()}).otherwise(function(t){o._showError(t)});return this._showWaiting(a),a.always(function(){var t=o.getCurrentReportContainer();if(t&&t.domNode)return r.add(t.domNode,"esriGEReportPlayer_fadeIn1000"),b.delay(1e3).then(function(){t.domNode&&r.remove(t.domNode,"esriGEReportPlayer_fadeIn1000")}),b.delay(300).then(function(){if(o._isDataBeingSetFlag=!1,S.isAnimationSuspended=!1,o.onSetReportDataEnd(),o._emitPendingResizedEvent(),t.notifyShown(),o._progressController&&o._progressController.reset(),e.waitUntilAllContentIsReady)return o.isContentLoading()})})},refresh:function(t){return this.isContentLoading()?this.isContentLoading():this._reportData&&o(this.setReportData(this._reportData,{waitUntilAllContentIsReady:!(!t||!t.waitUntilAllContentIsReady),_resetLoadedContents:!(!t||!t.rerenderContent)}),function(){return this.showPageAt(0),this.resize()}.bind(this))},showAnalysisAreaAt:function(t,e){if(this.isContentLoading())return this.isContentLoading();var i=this._applyReportData({analysisAreaIndex:t,rerenderContent:!(!e||!e.rerenderContent)});return e&&e.waitUntilAllContentIsReady?this.isContentLoading():i},_applyReportData:function(t){var e=this;t=t||{};var i=this._reportData&&this._reportData.isMultiFeature?0:t.analysisAreaIndex||0,r=!1!==t.rerenderContent;if(this._analysisAreaIndex=i,this._showError(!this._reportData),this._reportData)return o(this._viewModel.initialize(this._reportData.isClassic,this.viewMode),function(){return e.playerToolbar.updateAreaSelect(e._reportData.analysisAreas,e._reportData.combinedAreasInfo,e.getCurrentAnalysisAreaIndex(),e._reportData.isMultiFeature),o(e._setReportContainer(r),function(t){return t&&e._doApplyTemplateJson({analysisAreaIndex:i})})})},_doApplyTemplateJson:function(t){var e=this,i=this.getCurrentReportContainer(),r=i.fromJson(this._reportData.templateJson,{waitUntilAllContentIsReady:!0,progressCallback:function(i){e._progressController&&e._progressController.setProgressForAreaAt(i,t.analysisAreaIndex)}}),n=i.getPagePromise?i.getPagePromise():r,a=i.getContentPromise?i.getContentPromise():r;return this._registerContainerLoadPromise(a),o(n,function(){return this._setCurrentContainerLoaded(),this.showPageAt(this._currentPageIndex),this.resize()}.bind(this))},_loadQueue:null,isContentLoading:function(){return this._loadQueue&&this._loadQueue.getPromise()},_registerContainerLoadPromise:function(t){var e=this;this._loadQueue||(this._loadQueue=new I({onStarted:function(){M.enableContentAbsolute(e.commandButtonsContainer,!1)},onFinished:function(){M.enableContentAbsolute(e.commandButtonsContainer,!0)}})),this._loadQueue.add(t)},getReportData:function(){return this._reportData},reportDataToJson:function(t){return this.dataProvider.reportDataToJson(this.getReportData(),t)},reportDataFromJson:function(t,e){return o(this.dataProvider.reportDataFromJson(t),function(t){return this.setReportData(t,e)}.bind(this))},updateTemplateJson:function(t){this._reportData&&t&&(this._reportData.templateJson=t)},getReportTitle:function(){return this._reportData&&this._reportData.reportTitle||""},getCurrentAnalysisAreaIndex:function(){return this._analysisAreaIndex},getCurrentAnalysisArea:function(){return this._reportData&&this._reportData.analysisAreas[this._analysisAreaIndex]},getAnalysisAreas:function(){return this._reportData&&this._reportData.analysisAreas},_configureViewModel:function(t){var i=this;this._viewModel.setTheme(this._reportData.templateJson.theme),this._viewModel.enableDataDrilling=this.enableDataDrilling,this._disableAnimation&&(this._viewModel.animationAllowed=!1),this._viewModel.setDynamicReportInfo({fieldData:this._reportData.fieldData,analysisAreas:this._reportData.analysisAreas,combinedAreasInfo:this._reportData.combinedAreasInfo,infographicOptions:this._reportData.infographicOptions,attachmentsStore:this._reportData.attachmentsStore,createMapFunc:e.hitch(this,this._createMap),reportType:this._reportData.reportType,isClassic:this._reportData.isClassic,isMultiFeature:this._reportData.isMultiFeature,isFixedDataMode:!this._reportData.config.geoenrichmentUrl,geClient:this._reportData.geClient,templateVariableProvider:this._reportData.templateVariableProvider,countryID:this._reportData.config.countryID,hierarchy:this._reportData.config.hierarchy}),this._viewModel.getDynamicImageFunc=e.hitch(this,this._getReportLogo),this._viewModel.enrichFieldData=function(t){return i.dataProvider.enrichFieldData(t,e.mixin({analysisAreas:i._reportData.analysisAreas,fieldData:i._reportData.fieldData},i._reportData.config))}},getNumberOfPages:function(){return this.getCurrentReportContainer().getNumberOfPages()},notifyShown:function(){this._isDataBeingSetFlag||this.getCurrentReportContainer()&&this.getCurrentReportContainer().notifyShown()},_isErrorShown:!1,_showError:function(t){N.emulateErrors.playerError&&(t=!0),M[t?"hide":"show"](this.printableDivContainer),M[t?"show":"hide"](this.errorViewDiv),r[t?"add":"remove"](this.domNode,"esriGEReportPlayerError"),this._isErrorShown=!!t,t&&M.hide(this.sidePageNavigator),this.playerToolbar.setErrorShown(!!t),t&&(this._progressController&&this._progressController.reset(),console.log(t),this.onError(t))},isErrorShown:function(){return this._isErrorShown},setPrintMode:function(t){r[t?"add":"remove"](this.domNode,"esriGEReportPlayerInPrinting")},resize:function(t,e){return o(this._resize({width:t,height:e}),function(){this._updatePageNavigator(),this._updateZoomControls(),this.playerToolbar.update()}.bind(this))},_pendingResizeEvent:null,_emitResizedEvent:function(t){this._pendingResizeEvent={isPaginating:!!t},this._isDataBeingSetFlag||this._emitPendingResizedEvent()},_emitPendingResizedEvent:function(){this._pendingResizeEvent&&(this.onResized(this._pendingResizeEvent.isPaginating),this._pendingResizeEvent=null)},_onClose:function(){var t;this.showToFullScreenAnimation&&this.resizeMode===A.FIT_WINDOW&&(t=C.animateFrom(this)),o(t,function(){this.onClose()}.bind(this))},onSetReportDataStart:function(){},onSetReportDataEnd:function(){},onResized:function(t){},onClose:function(){},onError:function(t){}})});