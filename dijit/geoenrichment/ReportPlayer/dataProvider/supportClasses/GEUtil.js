// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.25/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/when","dojo/promise/all","dojox/uuid/generateRandomUuid","esri/kernel","esri/request","esri/urlUtils","esri/dijit/geoenrichment/utils/requests/UniversalClient","esri/dijit/geoenrichment/utils/UrlUtil","./stdGeographies/StdGeographiesModel","./PortalManager"],function(e,t,n,r,i,o,a,s,u,c,l,h,f){function d(){var e=a.id.credentials[0];return e&&e.token}function p(e,n){var r=u.urlToObject(e);return n&&(n=t.mixin(r.query||{},n),n.token||(n.token=d())),{url:r.path,taskParams:n}}function _(e,t){return C||(C=new m(e)),!t||C.initialized?C:C.initialize()}var m=e(null,{_geoenrichmentUrl:null,_geInfo:null,_capabilities:null,_supportedOperations:null,constructor:function(e){this._geoenrichmentUrl=e},_initDfd:null,initialized:!1,initialize:function(){var e=this;return this._initDfd?this._initDfd.promise:(this._initDfd=new n,s({url:p(this._geoenrichmentUrl).url+"/Geoenrichment",content:{f:"json"},handleAs:"json"}).then(function(t){e._geInfo=t,e._capabilities={},e._supportedOperations={},t.capabilities&&t.capabilities.forEach(function(t){e._capabilities[t.toLowerCase()]=!0}),t.supportedOperations&&t.supportedOperations.forEach(function(t){e._supportedOperations[t.toLowerCase()]=!0}),e.initialized=!0,e._initDfd.resolve()}),this._initDfd.promise)},hasCapability:function(e){return this._capabilities[e.toLowerCase()]},supportsOperation:function(e){return this._supportedOperations[e.toLowerCase()]},enrich:function(e){var t=p(this._geoenrichmentUrl,e);return t.taskParams.AddDerivativeVariables="all",s({url:t.url+"/Geoenrichment/Enrich",content:t.taskParams,handleAs:"json"}).then(function(e){return e.results[0].value.FeatureSet||[]})},_contriesCache:{},getCountryInfo:function(e){var t=this;if(!this._contriesCache[e]){var n=p(this._geoenrichmentUrl,{f:"json"});this._contriesCache[e]=s({url:n.url+"/Geoenrichment/Countries/"+e,content:n.taskParams,handleAs:"json"}).then(function(n){var o=n.countries[0],a={};return i(o.hierarchies.map(function(n){return r(t.getStdGeographyModel(e,n.ID),function(e){a[n.ID]=e})})).then(function(){return{country:o,geographiesModels:a}})})}return this._contriesCache[e]},_stdModelCache:null,getStdGeographyModel:function(e,t){t=t||"census",this._stdModelCache=this._stdModelCache||{};var n=e+t;if(!this._stdModelCache[n]){var r=p(this._geoenrichmentUrl,{f:"json"});this._stdModelCache[n]=s({url:r.url+"/Geoenrichment/StandardGeographyLevels/"+e+"/"+t,content:r.taskParams,handleAs:"json"}).then(function(n){return new h(e,t,n)})}return this._stdModelCache[n]},formatReport:function(e){var t=p(this._geoenrichmentUrl,e);return new c({allowSSL:!0}).send(t.url+"/Geoenrichment/FormatReport",{handleAs:"bin",content:t.taskParams}).then(function(e){return e&&e.data&&"text/plain"===e.data.type?null:e})},_tasksHash:{},createReport:function(e){var n=p(this._geoenrichmentUrl,e),r=o();return this._tasksHash[r]={taskName:"createReport",taskParams:t.clone(e)},new c({allowSSL:!0}).send(n.url+"/Geoenrichment/createReport",{handleAs:"text",content:n.taskParams}).then(function(e){return{taskID:r,result:e}})},consumeCredits:function(e){var n=this._tasksHash[e];if(n)return n=t.clone(n),delete n.taskParams.forStorage,this[n.taskName](n.taskParams)},_dataLayersCache:{},getLayerInfos:function(e){return this._dataLayersCache[e]||(this._dataLayersCache[e]=this._getLayerInfos(e)),this._dataLayersCache[e]},_getLayerInfos:function(e){var t=p(this._geoenrichmentUrl,{f:"json"});return s({url:t.url+"/Geoenrichment/DataLayers/"+e,content:t.taskParams,handleAs:"json"}).then(function(e){return e&&e.layers||[]}).otherwise(function(e){return console.log(e),[]})},getLayerInfo:function(e,t){var n=e+"_"+t;return this._dataLayersCache[n]||(this._dataLayersCache[n]=this._getLayerInfo(e,t)),this._dataLayersCache[n]},_getLayerInfo:function(e,t){var n=p(this._geoenrichmentUrl,{f:"json"});return s({url:n.url+"/Geoenrichment/DataLayers/"+e+"/"+t,content:n.taskParams,handleAs:"json"}).then(function(e){return e&&e.layer}).otherwise(function(e){return console.log(e),null})}}),g={};g.provideGeoenrichmentUrl=function(e){return r(function(){if(!e.geoenrichmentUrl)return r(f.getPortalInfo(e),function(t){e.geoenrichmentUrl=t.portal.helperServices.geoenrichment.url})}(),function(){l.registerCORS(e.geoenrichmentUrl)})},g.GEClient=m;var C;return g.getClient=function(){return C},g.initialize=function(e){return _(e,!0)},g.enrich=function(e,t){return _(e).enrich(t)},g.formatReport=function(e,t){return _(e).formatReport(t)},g.createReport=function(e,t){return _(e).createReport(t)},g.consumeCredits=function(e,t){return _(e).consumeCredits(t)},g.getLayerInfos=function(e,t){return _(e).getLayerInfos(t)},g.hasCapability=function(e,t){return r(_(e,!0),function(){return C&&C.hasCapability(t)})},g.supportsOperation=function(e,t){return r(_(e,!0),function(){return C&&C.supportsOperation(t)})},g.getCountryInfo=function(e,t){return _(e).getCountryInfo(t)},g.getStdGeographyModel=function(e,t,n){return _(e).getStdGeographyModel(t,n)},g});