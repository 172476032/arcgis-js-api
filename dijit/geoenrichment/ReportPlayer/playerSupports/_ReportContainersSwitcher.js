// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.25/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/when","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","../PlayerResizeModes","../PlayerViewModes","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ViewModes"],function(e,t,n,i,r,o,a,s,u){var d="classic",l={createContainer:function(e,t,n){var i=n._viewModel,r=n._containerDict.getContainer(e,t);if(!r){switch(e){case"pagination":r=function(){return i.layoutBuilder.createElement("reportContainerPagination",{viewModel:i,parentWidget:n,scaleSectionsToFit:n.scaleSlidesToFitWindow,onResized:function(e){n.playerToolbar.update(),n._emitResizedEvent(e)},onPendingDataApplied:function(){n._emitResizedEvent()}},n.reportContainerDiv)}();break;case"stack":r=function(){return i.layoutBuilder.createElement("reportContainerStack",{viewModel:i,parentWidget:n,renderOptions:{center:!0,minTop:10},onPendingDataApplied:function(){n._emitResizedEvent()}},n.reportContainerDiv)}();break;default:r=function(){var t={viewModel:i,parentWidget:n,isSourceContainer:!0,onPendingDataApplied:function(){n._emitResizedEvent()}};return n.resizeMode!==o.AUTO?t.renderOptions={center:!0,minTop:10}:t.renderOptions={center:!0,minTop:10,minRight:10,minBottom:10,minLeft:10},i.layoutBuilder.createElement(e===d?"reportContainer":"reportContainerGrid",t,n.reportContainerDiv)}()}r.isCurrentContainer=function(){return n.getCurrentReportContainer()===r},n.own(r)}return n._containerDict.setContainer(r,e,t),r}},c=e(null,{_containersHash:null,constructor:function(){this._containersHash={}},_getInfo:function(e,t,n,i){var r=this._containersHash[e]=this._containersHash[e]||[],o=r[t];return!o&&i&&(o=r[t]={container:i,loaded:!1}),n?o&&o[n]:o},getContainer:function(e,t){return this._getInfo(e,t,"container")},getContainers:function(e){return(this._containersHash[e]=this._containersHash[e]||[]).map(function(e){return e.container})},getContainerIndex:function(e,t){return this.getContainers(t).indexOf(e)},setContainer:function(e,t,i){n.set(e.domNode,"area-index",i),this._getInfo(t,i,null,e)},isLoaded:function(e,t){return this._getInfo(e,t,"loaded")},setLoaded:function(e,t){var n=this._getInfo(e,t);n&&(n.loaded=!0)},resetAllLoaded:function(){for(var e in this._containersHash)this._containersHash[e].forEach(function(e){e.loaded=!1})}});return e(null,{_containerDict:null,_initContainerSwither:function(){this._containerDict=new c},getCurrentReportContainer:function(){return this._currentReportContainer},getAllReportContainers:function(){var e=this._getCurrentViewType();return this._containerDict.getContainers(e)},_getCurrentViewType:function(){switch(this.viewMode){case a.PANELS_IN_SLIDES:return"pagination";case a.PANELS_IN_STACK:return"stack";default:this._reportData.isClassic}},_setReportContainer:function(e){var n=this;return e?this._resetLoadedFlags():this._rememberCurrentContainerVisuals(),this._switchToCurrentReportContainer(),!(!e&&this._isCurrentContainerLoaded())||t(this._resize({isPaginating:!0}),function(){return n._applyCurrentContainerVisuals(),!1})},_switchToCurrentReportContainer:function(){this._currentReportContainer&&this._hideContainer(this._currentReportContainer);var e=this._getCurrentViewType();switch(this._currentReportContainer=l.createContainer(e,this.getCurrentAnalysisAreaIndex(),this),i.remove(this.domNode,"esriGEReportPlayerFullView esriGEReportPlayerPaginationView esriGEReportPlayerStackView"),this.viewMode){case a.PANELS_IN_SLIDES:i.add(this.domNode,"esriGEReportPlayerPaginationView");break;case a.PANELS_IN_STACK:i.add(this.domNode,"esriGEReportPlayerStackView");break;default:i.add(this.domNode,"esriGEReportPlayerFullView")}this._showContainer(this._currentReportContainer),this._currentReportContainer.setViewMode&&this._currentReportContainer.setViewMode(u.PREVIEW_VALUES),this._connectZoomToCurrentContainer(),this.notifyShown()},_hideContainer:function(e){var t=this._getCurrentViewType();e.__undoHideContainerHandle=s.hideNodeInBackground(e.domNode,"reportContainer_"+this._containerDict.getContainerIndex(e,t)),e.own(e.__undoHideContainerHandle)},_showContainer:function(e){e.__undoHideContainerHandle&&(e.__undoHideContainerHandle.undo(),delete e.__undoHideContainerHandle)},_showAllContainers:function(){var e=this;return this.getAllReportContainers().forEach(function(t){e._showContainer(t),e.reportContainerDiv.removeChild(t.domNode),r.place(t.domNode,e.reportContainerDiv)}),{undo:function(){e.getAllReportContainers().forEach(function(t){e._hideContainer(t)}),e._switchToCurrentReportContainer()}}},_resetLoadedFlags:function(){this._lastVisuals=null,this._containerDict.resetAllLoaded()},_isCurrentContainerLoaded:function(){return this._containerDict.isLoaded(this._getCurrentViewType(),this.getCurrentAnalysisAreaIndex())},_setCurrentContainerLoaded:function(){this._applyCurrentContainerVisuals(),this._containerDict.setLoaded(this._getCurrentViewType(),this.getCurrentAnalysisAreaIndex())},_lastVisuals:null,_rememberCurrentContainerVisuals:function(){if(!this._currentReportContainer)return void(this._lastVisuals=null);var e=this._currentReportContainer;this._lastVisuals={type:this._getCurrentViewType(),scrollTop:e.getScrollableContainer&&e.getScrollableContainer().scrollTop||0,pageIndex:e.getCurrentPageIndex&&e.getCurrentPageIndex()||0,slideIndex:e.getCurrentSlideIndex&&e.getCurrentSlideIndex()||0,zoomInfo:e.getZoomInfo&&e.getZoomInfo()}},_applyCurrentContainerVisuals:function(){if(this._lastVisuals){if(this._lastVisuals.type!==this._getCurrentViewType())return void(this._lastVisuals=null);var e=this;!function(){var t=e._currentReportContainer;t.getScrollableContainer&&(t.getScrollableContainer().scrollTop=e._lastVisuals.scrollTop||0),t.showSlideAt&&t.showSlideAt(e._lastVisuals.slideIndex||0),t.showPageAt&&t.showPageAt(e._lastVisuals.pageIndex||0),t.setZoomInfo&&t.setZoomInfo(e._lastVisuals.zoomInfo)}()}}})});