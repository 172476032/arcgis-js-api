// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/when","dojo/dom-attr","dojo/dom-class","dojo/dom-construct","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ViewModes"],function(e,t,n,r,i,o,a){var s="classic",u="graphic",l="pagination",d={createContainer:function(e,t,n){function r(){return o.layoutBuilder.createElement(e===s?"reportContainer":"reportContainerGrid",{viewModel:o,parentWidget:n,isSourceContainer:!0,onPendingDataApplied:function(){n._emitResizedEvent()},renderOptions:{center:!0,minTop:10}},n.reportContainerDiv)}function i(){return o.layoutBuilder.createElement("reportContainerPagination",{viewModel:o,parentWidget:n,onResized:function(e){n._emitResizedEvent(e)},onPendingDataApplied:function(){n._emitResizedEvent()}},n.reportContainerDiv)}var o=n._viewModel,a=n._containerDict.getContainer(e,t);return a||(a=e===l?i():r(),a.isCurrentContainer=function(){return n.getCurrentReportContainer()===a},n.own(a)),n._containerDict.setContainer(a,e,t),a}},c=e(null,{_containersHash:null,constructor:function(){this._containersHash={}},_getInfo:function(e,t,n,r){var i=this._containersHash[e]=this._containersHash[e]||[],o=i[t];return!o&&r&&(o=i[t]={container:r,loaded:!1}),n?o&&o[n]:o},getContainer:function(e,t){return this._getInfo(e,t,"container")},getContainers:function(e){var t=this._containersHash[e]=this._containersHash[e]||[];return t.map(function(e){return e.container})},getContainerIndex:function(e,t){return this.getContainers(t).indexOf(e)},setContainer:function(e,t,r){n.set(e.domNode,"area-index",r),this._getInfo(t,r,null,e)},isLoaded:function(e,t){return this._getInfo(e,t,"loaded")},setLoaded:function(e,t){var n=this._getInfo(e,t);n&&(n.loaded=!0)},resetAllLoaded:function(){for(var e in this._containersHash)this._containersHash[e].forEach(function(e){e.loaded=!1})}});return e(null,{_containerDict:null,postCreate:function(){this._containerDict=new c,this.inherited(arguments)},getCurrentReportContainer:function(){return this._currentReportContainer},getAllReportContainers:function(){var e=this._getCurrentViewType();return this._containerDict.getContainers(e)},_getCurrentViewType:function(){return this.isSlidesView?l:this._reportData.isClassic?s:u},_setReportContainer:function(e){var n=this;return e?this._resetLoadedFlags():this._rememberCurrentContainerVisuals(),this._switchToCurrentReportContainer(),!e&&this._isCurrentContainerLoaded()?t(this._resize({isPaginating:!0}),function(){return n._applyCurrentContainerVisuals(),!1}):!0},_switchToCurrentReportContainer:function(){this._currentReportContainer&&this._hideContainer(this._currentReportContainer);var e=this._getCurrentViewType();this._currentReportContainer=d.createContainer(e,this.getCurrentAnalysisAreaIndex(),this),r[e===l?"add":"remove"](this.domNode,"esriGEReportPlayerPaginationView"),r[e===l?"remove":"add"](this.domNode,"esriGEReportPlayerFullView"),this._showContainer(this._currentReportContainer),this._currentReportContainer.setViewMode&&this._currentReportContainer.setViewMode(a.PREVIEW_VALUES),this._connectZoomToCurrentContainer(),this.notifyShown()},_hideContainer:function(e){var t=this._getCurrentViewType();e.__undoHideContainerHandle=o.hideNodeInBackground(e.domNode,"reportContainer_"+this._containerDict.getContainerIndex(e,t))},_showContainer:function(e){e.__undoHideContainerHandle&&(e.__undoHideContainerHandle.undo(),delete e.__undoHideContainerHandle)},_showAllContainers:function(){var e=this;return this.getAllReportContainers().forEach(function(t){e._showContainer(t),e.reportContainerDiv.removeChild(t.domNode),i.place(t.domNode,e.reportContainerDiv)}),{undo:function(){e.getAllReportContainers().forEach(function(t){e._hideContainer(t)}),e._switchToCurrentReportContainer()}}},_resetLoadedFlags:function(){this._lastVisuals=null,this._containerDict.resetAllLoaded()},_isCurrentContainerLoaded:function(){return this._containerDict.isLoaded(this._getCurrentViewType(),this.getCurrentAnalysisAreaIndex())},_setCurrentContainerLoaded:function(){this._applyCurrentContainerVisuals(),this._containerDict.setLoaded(this._getCurrentViewType(),this.getCurrentAnalysisAreaIndex())},_lastVisuals:null,_rememberCurrentContainerVisuals:function(){if(!this._currentReportContainer)return void(this._lastVisuals=null);var e=this._currentReportContainer;this._lastVisuals={type:this._getCurrentViewType(),scrollTop:e.getScrollableContainer&&e.getScrollableContainer().scrollTop||0,pageIndex:e.getCurrentPageIndex&&e.getCurrentPageIndex()||0,slideIndex:e.getCurrentSlideIndex&&e.getCurrentSlideIndex()||0,zoomInfo:e.getZoomInfo&&e.getZoomInfo()}},_applyCurrentContainerVisuals:function(){function e(){var e=t._currentReportContainer;e.getScrollableContainer&&(e.getScrollableContainer().scrollTop=t._lastVisuals.scrollTop||0),e.showSlideAt&&e.showSlideAt(t._lastVisuals.slideIndex||0),e.showPageAt&&e.showPageAt(t._lastVisuals.pageIndex||0),e.setZoomInfo&&e.setZoomInfo(t._lastVisuals.zoomInfo)}if(this._lastVisuals){if(this._lastVisuals.type!==this._getCurrentViewType())return void(this._lastVisuals=null);var t=this;e()}}})});