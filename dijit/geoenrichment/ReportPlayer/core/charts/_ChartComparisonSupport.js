// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","../comparison/ComparisonSelect","./utils/ChartTypes","../../dataProvider/supportClasses/ge/LocalGEChart","./dummyData/DummyGE","esri/dijit/geoenrichment/utils/DomUtil","dojo/i18n!esri/nls/jsapi"],function(e,t,i,o,s,r,n){return n=n.geoenrichment.dijit.ReportPlayer.ChartContainer,e(null,{comparisonSelect:null,_comparisonValue:null,_additionalFeatures:null,_ge:null,_stdPolygonsController:null,_initChartComparisonSelect:function(){var e=this;if(this._additionalFeatures=[],r.hide(this.comparisonSelectBlock),this._currentComparisonInfo){this._updateComparisonLabel();var i=this._getGeoenrichment().getData().features;if(this.comparisonSelect=new t({fields:this._getGeoenrichment().getAttributeFields(),canAddFeatures:this._canAddRemoveFeatures(),addFeatureMessage:n.addToChart,featureIsAlreadyAddedMessage:n.alreadyAdded,canRemoveFeatures:this._canAddRemoveFeatures(),removeFeatureMessage:n.removeFromChart,onFeatureSelected:function(t,i){e._setComparisonId(i)},isFeatureAdded:function(t,i){return e._comparisonValue===i||-1!==e._additionalFeatures.indexOf(i)},canRemoveFeature:function(t,i){return e._comparisonValue!==i},onAddFeature:function(t,i){e._additionalFeatures.push(i),e._updateSeries(),e._syncWithShownFeatures()},onRemoveFeature:function(t,i){e._additionalFeatures.splice(e._additionalFeatures.indexOf(i),1),e._updateSeries(),e._syncWithShownFeatures()}}).placeAt(this.comparisonSelectDiv),this.own(this.comparisonSelect),this.comparisonSelect.setFeatures(i),this._comparisonValue=this.comparisonSelect.setDefaultValue(),!this.comparisonSelect.get("options").length)return this.comparisonSelect.destroy(),void(this._currentComparisonInfo=null);r.show(this.comparisonSelectBlock),r.enableContent(this.comparisonSelectBlock,!!this.viewModel.dynamicReportInfo),this.viewModel.dynamicReportInfo&&(this._stdPolygonsController=this.viewModel.getStdPolygonsController(this._currentComparisonInfo.calculatorName,this.currentFeatureIndex),this.own(this._stdPolygonsController),this._syncWithShownFeatures())}},_canAddRemoveFeatures:function(){return this._isMultiFeatureChart&&!i.isLineLike(this._currentChartType)},_updateComparisonLabel:function(){if(this._currentComparisonInfo){var e;e=this._canAddRemoveFeatures()?n.selectOrAddGeographyToCompare:this._isTableView?n.compareWith:i.isColumnBarLike(this._getComparisonChartType())?n.comparisonLabelBars:n.comparisonLabelDots,this.comparisonLabel.innerHTML=e,this.comparisonLabel.style.color=this.viewModel.getDocumentDefaultStyles(this.theme).color}},_allAttributesCache:null,_syncWithShownFeatures:function(){if(this._stdPolygonsController){this._stdPolygonsController.setAttributeFields(this._getGeoenrichment().getAttributeFields());var e=this._getGeoenrichment().getAllGeographyAttributes({ignoreFilters:!0});this._allAttributesCache||(this._allAttributesCache={},e.forEach(function(e){this._allAttributesCache[e.StdGeographyID]=e},this));var t=this._getComparisonFeatureIds().map(function(e){return this._allAttributesCache[e]},this);this._stdPolygonsController.setShownFeatureAttributes(t),this._stdPolygonsController.setAllFeatureAttributes(e)}},_createDummyGE:function(){return s.getInstance()},_getComparisonChartType:function(){return this._currentComparisonInfo&&this._currentComparisonInfo.chartType||this._currentChartType},_getGeoenrichment:function(){return this._currentComparisonInfo?this._ge?this._ge:(this.viewModel.dynamicReportInfo?this._ge=new o(this._originalSeriesItems,this._currentComparisonInfo.calculatorName,this.viewModel.dynamicReportInfo.fieldData.areaData,this._isMultiFeatureChart,this.viewModel.dynamicReportInfo.analysisAreas.map(function(e){return e.shortName||e.name}),this.currentFeatureIndex):this._ge=this._createDummyGE(),this._ge):null},_setComparisonId:function(e){this._comparisonValue=e,this.comparisonSelect.get("options").length?this.comparisonSelect.get("value")!==this._comparisonValue&&this.comparisonSelect.set("value",this._comparisonValue):this._comparisonValue=null,this._updateSeries(),this._syncWithShownFeatures()},_setFilterRangesForComparison:function(e){if(!this._currentComparisonInfo)return!1;this._getGeoenrichment().setFilterRanges(e);var t=this._getGeoenrichment().getData().features;return this.comparisonSelect.setFeatures(t),this._setComparisonId(this.comparisonSelect.setDefaultValue()),r[this.comparisonSelect.get("options").length?"show":"hide"](this.comparisonSelectBlock),!0},_getComparisonFeatureIds:function(){if(!this._currentComparisonInfo)return null;var e={};this._getGeoenrichment().getData().features.forEach(function(t){e[t.attributes.StdGeographyID]=!0});var t=this._additionalFeatures.filter(function(t){return e[t]}),i=t.slice();return this._comparisonValue&&-1===i.indexOf(this._comparisonValue)&&i.push(this._comparisonValue),i}})});