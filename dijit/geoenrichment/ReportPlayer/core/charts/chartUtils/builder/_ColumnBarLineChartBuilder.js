// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojox/charting/axis2d/Default","../ThemeCalculator","../ChartTypes","../ChartSorting","../../../supportClasses/conditionalStyling/ConditionalStyleUtil","../plots/ClusteredColumns","../plots/StackedColumns","../plots/ClusteredBars","../plots/StackedBars","../plots/PictureClusteredColumns","../plots/PictureClusteredBars","../plots/Lines","../plots/StackedLines","../plots/Areas","../plots/StackedAreas","../../../themes/ReportThemes","../CustomGridPlot","../AxisUtil","esri/dijit/geoenrichment/utils/ColorUtil","./_ChartDataUtil","./_TooltipInfoBuilder","./_ChartDataLabelBuilder","./ChartPlots"],function(e,i,t,o,r,a,n,s,l,c,p,m,u,d,h,f,S,x,C,I,y,g,v,L,P){function b(e,i,t,o,r){var a=288*o/680/(e+1);return"Small"===t?a*=.5:"Large"===t&&(a*=1.5),a/(r?1:i)}function A(e,i){return e.captionFieldInfo?g.getCaptionValue(e,i):e.label||""}var k={getComparisonPlotName:function(e,i){return i&&i.chartType===r.LINE&&e!==r.LINE?P.SECONDARY:null},isComparisonInPrimaryPlot:function(e,i){return!this.getComparisonPlotName(e,i)},getEffectiveNumberOfSeries:function(e,i,t){if(!this.canShowComparison(t,e))return e.length;var o=k.isComparisonInPrimaryPlot(i,t);return o?e.length+1:e.length},canShowComparison:function(e,i){return e&&1===i.length},updateSeriesItemsForComparisonInfo:function(e){if(this.canShowComparison(e.comparisonInfo,e.seriesItems)){var i=e.seriesItems.slice();i.push({isComparisonSeries:!0,label:e.selectedComparisonAreaName,points:i[0].points.slice()}),e.seriesItemsWithComparison=i}}},T={configureChart:function(e){var t=e.chart,o=e.visualProperties,a=e.chartType,n=e.comparisonInfo,I=e.themeSettings,v=e.viewModel;t._pointIndexToLabelMap={};var b=v.reportStyle===x.GRAPHIC&&i.mixin({},I.xAxis.axisStyle,o.xAxis.style),A=y.toColor(b.color||"#000000");A.a=g.undefinedToDefault(o.yAxis.gridLinesOpacity,1),A=y.toCSSColor(A),t.addPlot(P.GRID,{type:C,vMajorLines:o.yAxis.gridLines,majorVLine:{color:A,width:.5},vMinorLines:!1,hMajorLines:o.xAxis.gridLines,majorHLine:{color:A,width:.5},hMinorLines:!1});var T=t.getPlot(P.GRID);T.xHasHalfTickOffset=o.yAxis.gridLinesCentered,T.yHasHalfTickOffset=o.xAxis.gridLinesCentered;var M={gap:50},w=-1!==o.dataLabels.indexOf("Label"),_=-1!==o.dataLabels.indexOf("Value"),F=-1!==o.dataLabels.indexOf("Percent"),R=o.dataLabelsInside?"inside":"outside",E=5,N=w||_||F?{precision:0,labels:!0,labelStyle:R,labelHorizontalAlign:o.dataLabelsHorizontalAlign,htmlLabels:!0,labelOffset:E,labelFunc:function(e){return L.formatDataLabel(e.y,e.name,e._valuesSumsInSeries,o)}}:null,B=v.dynamicReportInfo&&v.chartAnimationAllowed?{animate:!0}:null;switch(a){case r.COLUMN:t.addPlot(P.PRIMARY,i.mixin({type:o.isStacked?l:s},M,N,B));break;case r.BAR:t.addPlot(P.PRIMARY,i.mixin({type:o.isStacked?p:c},M,N,B));break;case r.LINE:t.addPlot(P.PRIMARY,i.mixin({type:o.fillLineArea?o.isStacked?S:f:o.isStacked?h:d,markers:v.reportStyle===x.GRAPHIC&&!o.fillLineArea},B));break;case r.PICTURE_COLUMN:t.addPlot(P.PRIMARY,i.mixin({type:m},M,N,B));break;case r.PICTURE_BAR:t.addPlot(P.PRIMARY,i.mixin({type:u},M,N,B))}k.isComparisonInPrimaryPlot(a,n)||(t.addPlot(P.SECONDARY,i.mixin({type:d,markers:!0})),t.movePlotToFront(P.SECONDARY)),t.movePlotToBack(P.GRID),t.addAxis("x",this._createXAxis(null,o,a,I,v,t)),t.addAxis("y",this._createYAxis(null,o,a,I,v)),this.updateBarSize(e)},_createXAxis:function(e,t,a,n,s,l){function c(){var e=p.show&&p.showLine&&p.showTicks?5:0;return p.ticksInside&&(e*=-1),{length:e,color:h}}var p=t.xAxis,m="OtherSide"!==p.placement,u=i.mixin({},n.xAxis.axisStyle,p.style),d=i.mixin({},n.xAxis.titleStyle,p.titleStyle),h=p.lineColor||n.xAxis.lineColor,f=r.isBarLike(a),S={stroke:{width:p.show&&p.showLine?1:0,color:h},title:p.title,titleOrientation:!f&&m?"away":"axis",titleFont:o.combineFontString(d),titleFontColor:d.color,vertical:f,leftBottom:m,majorTicks:!0,majorTick:c(),majorTickStep:1,minorTicks:!1,microTicks:!1,minorTickStep:.5,microTickStep:.01,font:o.combineFontString(u),fontColor:u.color,dropLabels:s.reportStyle===x.CLASSIC,majorLabels:p.show,minorLabels:!1,labelFunc:function(e,i,t){var o=l._pointIndexToLabelMap&&l._pointIndexToLabelMap[i];return void 0!==o?o:e},rotation:-p.labelsAngle||0};return i.mixin(S,e)},_createYAxis:function(e,t,a,n,s){function l(){var e=c.show&&c.showLine&&c.showTicks?5:0;return c.ticksInside&&(e*=-1),{length:e,color:d}}var c=t.yAxis,p="OtherSide"!==c.placement,m=i.mixin({},n.yAxis.axisStyle,c.style),u=i.mixin({},n.yAxis.titleStyle,c.titleStyle),d=c.lineColor||n.yAxis.lineColor,h=r.isBarLike(a),f={fixUpper:"major",includeZero:!0,stroke:{width:c.show&&c.showLine?1:0,color:d},title:c.title,titleOrientation:h&&p?"away":"axis",titleFont:o.combineFontString(u),titleFontColor:u.color,vertical:!h,leftBottom:p,majorTicks:!0,majorTick:l(),majorTickStep:200,minorTicks:!1,microTicks:!1,minorTickStep:100,microTickStep:10,font:o.combineFontString(m),fontColor:m.color,dropLabels:s.reportStyle===x.CLASSIC,majorLabels:c.show,minorLabels:!1,rotation:-c.labelsAngle||0,labelFunc:function(e,i,t){return e}};return i.mixin(f,e)},updateBarSize:function(e){var i=e.chart,t=e.visualProperties,o=e.comparisonInfo,a=e.seriesItems,n=e.chartType,s=e.chartSize;if(i&&n!==r.LINE){var s=s||t[r.isColumnLike(n)?"width":"height"],l=0;a.forEach(function(e){l=Math.max(l,e.points.length)});var c=b(l,k.getEffectiveNumberOfSeries(a,n,o),t.columnThickness,s,t.isStacked);i.getPlot(P.PRIMARY).opt.maxBarSize=c,i.getPlot(P.PRIMARY).opt.minBarSize=c}},calcSeries:function(e){if(k.updateSeriesItemsForComparisonInfo(e),e.chartType===r.LINE)return this._calcSeriesLine(e);if(e.seriesItemsWithComparison&&!k.isComparisonInPrimaryPlot(e.chartType,e.comparisonInfo)){var t=e.seriesItemsWithComparison[e.seriesItemsWithComparison.length-1];delete e.seriesItemsWithComparison;var o=this._calcSeriesColumnBar(e),a=i.mixin({},e);a.seriesItems=[t],a.isSecondaryPlot=!0,a.primarySeries=o[0],a.reverseXY=r.isBarLike(e.chartType);var n=this._calcSeriesLine(a);return o.concat(n)}return this._calcSeriesColumnBar(e)},_updatePointIndexToLabelMap:function(e,i,t,o){var r=e._pointIndexToLabelMap[i];(void 0===r||""===r)&&(e._pointIndexToLabelMap[i]=A(t,o))},_calcSeriesColumnBar:function(e){var i,t=e.chart,r=e.visualProperties,s=e.seriesItems,l=1===s.length,c=e.seriesItemsWithComparison||s,p=e.chartType,m=e.comparisonInfo,u=e.themeSettings,d=e.viewModel,h=e.previewFeatureIndex,f=e.isMultiFeatureChart,S=e.excludedSeriesHash,x=1===c.length&&e.sorting,C=e.selectedComparisonIndex,I=e.ge,y=this,L=0,P=[];r.isStacked&&(i=[]),t._pointIndexToLabelMap={};var b,T={};if(r.conditionalStyling){var M=n.getStatistics(r.conditionalStyling);M&&c.length&&(b=g.getChartData(M,c[0].points.length))}return c.forEach(function(e,s){if(e.points.length){var c={name:e.label,data:[],params:{plot:e.isComparisonSeries&&k.getComparisonPlotName(p,m)||void 0}},M=[],w=0,_=1e6,F=-1e6;e.points.forEach(function(t,o){var r=g.getPreviewValue(t,o,s,!1,d,f?o:h,b,e.isComparisonSeries,C,I);M[o]=r,r=r||0,S&&S[e.label]||(i?(i[o]=i[o]||0,i[o]+=r):L=Math.max(r,L),w+=r,_=Math.min(_,r),F=Math.max(F,r))});var R=w/e.points.length;o.provideMissingIconsForPoints(e.points,p),e.points.forEach(function(i,t){var a,h=M[t],f=h||0,S=t+1;if(r.conditionalStyling){var x=n.getConditionalStyle(f,r.conditionalStyling);a=x&&x.backgroundColor}a=a||o.calcColorForPoint(i,e,t,s,l?1:2,p,u,e.isComparisonSeries,m);var C=v.getTooltipInfo(h,A(i,d),e.label,_,F,w,R,r,p,a,r.conditionalStyling),I=T[S]=T[S]||[];I.push(C),C.getGroup=function(){return I};var y=o.calcIconForPoint(i,a,p),g=o.calcBackgroundIconForPoint(i,p,u,r);c.data.push({x:S,y:f,isUnavailableData:isNaN(h),valueProp:"y",unsortedIndex:t,name:A(i,d),_valuesSumsInSeries:w,point:i,fill:a,tooltip:C,icon:y,bgIcon:g,stroke:{width:0}})}),x&&x!==a.NONE&&(c.data.sort(function(e,i){return(e.y-i.y)*(x===a.DESC?-1:1)}),c.data.forEach(function(e,i){var t=i+1;e.x=t})),c.data.forEach(function(e){y._updatePointIndexToLabelMap(t,e.x,e.point,d)}),P.push(c)}}),i&&(i.sort(function(e,i){return i-e}),L=i[0]),this._prettifyYAxis(L,t,r,p,u,d),P},_calcSeriesLine:function(e){var i,t=e.chart,a=e.visualProperties,n=e.seriesItems,s=1===n.length,l=e.seriesItemsWithComparison||n,c=e.isSecondaryPlot,p=e.reverseXY,m=e.comparisonInfo,u=e.themeSettings,d=e.viewModel,h=e.previewFeatureIndex,f=e.isMultiFeatureChart,S=e.selectedComparisonIndex,x=e.ge,C=r.LINE,I=this,y=0,L=[];a.isStacked&&(i=[]);var b={};if(l.forEach(function(r,n){if(r.points.length){var l=r.isComparisonSeries?1:n,c=o.calcColorForPoint(null,r,0,l,s?1:2,C,u,r.isComparisonSeries,m),k={name:r.label,data:[],params:{plot:r.isComparisonSeries&&e.isSecondaryPlot?P.SECONDARY:void 0,stroke:{color:c,width:a.lineThickness||1}}},T=[],M=0,w=1e6,_=-1e6;r.points.forEach(function(e,t){var o=g.getPreviewValue(e,t,l,!1,d,f?t:h,null,r.isComparisonSeries,S,x);T[t]=o,o=o||0,i?(i[t]=i[t]||0,i[t]+=o):y=Math.max(o,y),M+=o,w=Math.min(w,o),_=Math.max(_,o)});var F=M/r.points.length;r.points.forEach(function(e,i){var n=T[i],s=n||0,l=i+1;I._updatePointIndexToLabelMap(t,l,e,d);var m=v.getTooltipInfo(n,A(e,d),r.label,w,_,M,F,a,C,c),u=b[l]=b[l]||[];u.push(m),m.getGroup=function(){return u};var h={isUnavailableData:isNaN(n),unsortedIndex:i,name:A(e,d),_valuesSumsInSeries:M,point:e,fill:"#FFFFFF",stroke:{color:c},tooltip:m};p?(h.x=s,h.y=l,h.valueProp="x"):(h.x=l,h.y=s,h.valueProp="y"),r.isComparisonSeries&&(h.marker=o.getComparisonSymbol()),k.data.push(h)}),L.push(k)}}),i&&(i.sort(function(e,i){return i-e}),y=i[0]),c){var k=p?"y":"x",T=[];e.primarySeries.data.forEach(function(e){var i=L[0].data[e.unsortedIndex];i[k]=e.x,T.push(i)}),L[0].data=T}else this._prettifyYAxis(y,t,a,C,u,d);return L},_prettifyYAxis:function(e,i,t,o,r,a){i.removeAxis("y"),i.addAxis("y",this._createYAxis(I.getPrettifyYAxisParameters(e),t,o,r,a))},supportConditionalStyling:function(e){return r.isConditionalStylingEnabled(e)},getFullSeriesItems:function(e){return k.updateSeriesItemsForComparisonInfo(e),e.seriesItemsWithComparison||e.seriesItems}};return T});