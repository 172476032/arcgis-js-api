// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/Color","dojo/_base/declare","dojo/_base/lang","dojox/charting/plot2d/Base","dojox/charting/plot2d/_PlotEvents","dojox/charting/plot2d/common","dojox/gfx","dojox/gfx/matrix","dojox/lang/functional","dojox/lang/utils","dojo/has","./animation/_DonutAnimation"],function(t,e,n,i,s,a,r,l,o,h,u,c){var d={createPath:function(t,e,n,i,s,a,r,l,o,h,u,c){var d=function(s,c,d){e=void 0!==c?c:e;var p=f.getEndAngle(e,s,a,r,o,u,d);1===s&&(p=Number(p.toFixed(5)));var g=n*l,b=p-e,m=i.cx+n*Math.cos(e),x=i.cy+n*Math.sin(e),v=i.cx+n*Math.cos(p),_=i.cy+n*Math.sin(p);if(g){var M=i.cx+g*Math.cos(e),y=i.cy+g*Math.sin(e),P=i.cx+g*Math.cos(p),R=i.cy+g*Math.sin(p);shape=t.createPath().moveTo(M,y).lineTo(m,x).arcTo(n,n,0,b>Math.PI,!0,v,_).lineTo(P,R).arcTo(g,g,0,b>Math.PI,!1,M,y).closePath().setStroke(h.series.stroke)}else shape=t.createPath().moveTo(i.cx,i.cy).lineTo(m,x).arcTo(n,n,0,b>Math.PI,!0,v,_).lineTo(i.cx,i.cy).closePath().setStroke(h.series.stroke);return specialFill=h.series.fill,shape.setFill(specialFill),{shape:shape,end:p,donutGap:r}};return c.push({isSlice:!0,sliceIndex:s,func:d}),d}},f={getStartAngle:function(t,e){return t.series.donutArcPercent&&100!==t.series.donutArcPercent?-270+(100-t.series.donutArcPercent)/100*360/2:(t.series.startAngle||0)+e},getEndAngle:function(t,e,n,i,s,a,r){var l=t+2*e*Math.PI-i;if(n){var o=a+2*Math.PI-i;r||s.series.donutArcPercent&&100!==s.series.donutArcPercent?(l+=i,l=Math.min(l,o)):l=o}return l}};return e([i,s,c],{enableHole:!0,enableGap:!0,startAngleOffset:0,_animationInfos:null,_dataLabels:null,defaultParams:{labels:!0,ticks:!1,fixed:!0,precision:1,labelStyle:"outside",htmlLabels:!0,radGrad:"native",fanSize:5,startAngle:0,animate:null},optionalParams:{radius:0,omitLabels:!1,stroke:{},outline:{},shadow:{},fill:{},filter:{},styleFunc:null,font:"",fontColor:"",labelWiring:{}},constructor:function(t,e){this.opt=n.clone(this.defaultParams),h.updateWithObject(this.opt,e),h.updateWithPattern(this.opt,e,this.optionalParams),this.axes=[],this.run=null,this.dyn=[],this.runFilter=[]},clear:function(){return this.inherited(arguments),this.dyn=[],this.run=null,this},setAxis:function(t){return this},addSeries:function(t){return this.run=t,this},getSeriesStats:function(){return n.delegate(a.defaultStats)},getRequiredColors:function(){return this.run?this.run.data.length:0},getRenderResults:function(){return this._lastRenderResults},render:function(t,e){function i(t,e,n){return f.getEndAngle(t,e,n,j,a,y)}if(!this.dirty)return this;this.resetEvents(),this.dirty=!1,this._eventSeries={},this.cleanGroup();var s=this.group,a=this.chart.theme;if(!this.run||!this.run.data.length)return this;var h,c,p,g,b,m,x=(t.width-e.l-e.r)/2,v=(t.height-e.t-e.b)/2/this._getRYMultiplier(a),_=Math.min(x,v),M="font"in this.opt?this.opt.font:a.series.font,y=l._degToRad(this._getStartAngle(a)),P=y,R=this.events(),A=this.run.data.map(function(t,e){return"number"!=typeof t&&t.hidden&&(this.runFilter.push(e),t.hidden=!1),this.runFilter.some(function(t){return t===e})?"number"==typeof t?0:{y:0,text:t.text}:t},this);this.dyn=[],"radius"in this.opt&&(_=this.opt.radius,m=_);var S,L={cx:e.l+x,cy:e.t+v,r:_};if(c=o.map(A,"x ? Math.max(x.y, 0) : 0"),o.every(c,"<= 0"))return s.createCircle(L).setStroke(a.series.stroke),this.dyn=c.map(function(){return{}}),this;p=o.map(c,"/this",o.foldl(c,"+",0)),this.opt.labels&&(g=p.map(function(t,e){if(0>t)return"";var n=A[e];return"text"in n?n.text:this._getLabel(100*t)+"%"},this));var T=this.enableHole?(a.series.donutHolePercent||0)/100:0,j=this.enableGap?l._degToRad(a.series.donutGap||0):0;p=this._fixSlices(p,j),this._lastRenderResults={},this._animationInfos=[],this._dataLabels=[];var k=o.map(A,function(t,e){var n=[this.opt,this.run];return null!=t&&"number"!=typeof t&&n.push(t),this.opt.styleFunc&&n.push(this.opt.styleFunc(t)),a.next("slice",n,!0)},this),E=this._preprocessParams(A,a,_,x,v,L,p);if(L=E.circle,_=E.r,this.opt.labels)switch(h=0,b=0,g.forEach(function(t,e){var n=k[e].series.font,i=r._base._getTextBox(t,{font:n});h=Math.max(h,i.h),b=Math.max(b,i.w)}),this.opt.labelStyle){case"outside":var I=5,F=_;_=Math.min(x-b,v-h)-I,m=_+b/2,_=Math.max(_,F/2);break;case"inside":var w=(_-_*T)/2+_*T;m=Math.abs(w+(_-b/2))/2;break;case"columns":_=Math.min(x-b-20,v-2*h),m=_}var G=new Array(p.length);if(p.some(function(t,e){t=this._getSliceValueAt(p,e,a);var n,i,r=A[e],l=k[e];S=_*T;var o=d.createPath(s,P,_,L,e,e+1===p.length,j,T,a,l,y,this._animationInfos)(t),h=o.end;return shape=o.shape,this.dyn.push({fill:n,stroke:l.series.stroke}),R&&(i={element:"slice",index:e,run:this.run,shape:shape,x:e,y:"number"==typeof r?r:r.y,cx:L.cx,cy:L.cy,cr:_},this._connectEvents(i),G[e]=i),P=h+j,!1},this),this.opt.labels){var O=u("dojo-bidi")&&this.chart.isRightToLeft();if("outside"===this.opt.labelStyle||"inside"===this.opt.labelStyle){P=y;p.some(function(e,n){if(e=this._getSliceValueAt(p,n,a),0>=e)return!1;var r=k[n];if(e>=1)return this._dataLabels.push(this.renderLabel(s,L.cx,L.cy+h/2,g[n],r,!0)),!0;var l=i(P,e,n+1===p.length);if(this.opt.omitLabels&&.001>l-P)return!1;var o=(P+l)/2,u=m;"outside"===this.opt.labelStyle&&(u=1.15*m+(h-b/2-.15*m)*Math.abs(Math.sin(o)));var c=L.cx+u*Math.cos(o),d=L.cy+u*Math.sin(o)+h/2;return this._dataLabels.push(this.renderLabel(s,O?t.width-c:c,d,g[n],r,!0)),P=l+j,!1},this)}else if("columns"===this.opt.labelStyle){P=y;var B=this.opt.omitLabels,C=[];p.forEach(function(t,e){t=this._getSliceValueAt(p,e,a);var n=i(P,t,e+1===p.length),s=(P+n)/2;C.push({angle:s,left:Math.cos(s)<0,theme:k[e],index:e,omit:B?.001>n-P:!1}),P=n+j},this);var V=r._base._getTextBox("a",{font:M}).h;this._getProperLabelRadius(C,V,1.1*m);for(var W=0;W<C.length;W++){var H=C[W];if(!H.omit){var Y=L.cx-x,q=L.cx+x,z=r._base._getTextBox(g[W],{font:H.theme.series.font}).w,D=L.cx+H.labelR*Math.cos(H.angle),N=L.cy+H.labelR*Math.sin(H.angle),J=H.left?Y+z:q-z,K=H.left?Y:J,Q=s.createPath().moveTo(L.cx+m*Math.cos(H.angle),L.cy+m*Math.sin(H.angle));Q.lineTo(D,N),Q.lineTo(J,N).setStroke(H.theme.series.labelWiring),this._dataLabels.push(this.renderLabel(s,O?t.width-z-K:K,N,g[W],H.theme,!1,"left"))}}}}var U=0;return this._eventSeries[this.run.name]=o.map(A,function(t){return 0>=t?null:G[U++]}),u("dojo-bidi")&&this._checkOrientation(this.group,t,e),this._lastRenderResults=n.mixin(this._lastRenderResults,{labels:this.opt.labels,radiusInner:S,radiusOuter:_}),this._renderAdditionalElements(A,a,_,s,L,p),this.opt.animate&&this._renderAnimation(A,a,_,s,L,p),this},_getStartAngle:function(t){return f.getStartAngle(t,this.startAngleOffset)},_fixSlices:function(t,e){var n=[],i=0,s=[],a=e/(2*Math.PI)+.001;t.forEach(function(t,e){if(a>t){var r=a-t;t=a,i+=r,s.push(e),n[e]=t}});var r=i/(t.length-s.length);return t.forEach(function(t,e){-1===s.indexOf(e)&&(t-=r,n[e]=t)}),n},_getSliceValueAt:function(t,e,n){var i=Math.max(0,t[e]),s=n.series.donutArcPercent?n.series.donutArcPercent/100:1;return i*s},_preprocessParams:function(t,e,n,i,s,a,r){return{circle:a,r:n}},_getRYMultiplier:function(t){return Math.max(.625,t.series.donutArcPercent&&100!==t.series.donutArcPercent?(1+Math.cos(l._degToRad(360*(100-t.series.donutArcPercent)/100/2.1)))/2:1)},_renderAdditionalElements:function(t,e,n,i,s,a){},_getProperLabelRadius:function(t,e,n){var i,s,a=1,r=1;if(1===t.length)return void(t[0].labelR=n);for(var l=0;l<t.length;l++){var o=Math.abs(Math.sin(t[l].angle));t[l].left?a>=o&&(a=o,i=t[l]):r>=o&&(r=o,s=t[l])}i.labelR=s.labelR=n,this._calculateLabelR(i,t,e),this._calculateLabelR(s,t,e)},_calculateLabelR:function(t,e,n){for(var i,s=t.index,a=e.length,r=t.labelR;!(e[s%a].left^e[(s+1)%a].left);)e[(s+1)%a].omit||(i=(Math.sin(e[s%a].angle)*r+(e[s%a].left?-n:n))/Math.sin(e[(s+1)%a].angle),r=i<t.labelR?t.labelR:i,e[(s+1)%a].labelR=r),s++;s=t.index;for(var l=0===s?a-1:s-1;!(e[s].left^e[l].left);)e[l].omit||(i=(Math.sin(e[s].angle)*r+(e[s].left?n:-n))/Math.sin(e[l].angle),r=i<t.labelR?t.labelR:i,e[l].labelR=r),s--,l--,s=0>s?s+e.length:s,l=0>l?l+e.length:l}})});