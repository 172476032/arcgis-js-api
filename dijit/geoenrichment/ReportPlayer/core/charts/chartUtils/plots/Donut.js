// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/Color","dojo/_base/declare","dojo/_base/lang","dojox/charting/plot2d/Base","dojox/charting/plot2d/_PlotEvents","dojox/charting/plot2d/common","dojox/gfx","dojox/gfx/matrix","dojox/lang/functional","dojox/lang/utils","dojo/has","./animation/_DonutAnimation","./labelsRendering/LabelOverlapFixer","./labelsRendering/LabelsUtil"],function(t,e,i,n,a,s,r,l,o,h,u,c,d,f){var b={createPath:function(t,e,i,n,a,s,r,l,o,h,u,c){var d=function(a,c,d){e=void 0!==c?c:e;var f=x.getEndAngle(e,a,s,r,o,u,d);1===a&&(f=Number(Math.floor(1e5*f)/1e5));var b=i*l,p=f-e,g=n.cx+i*Math.cos(e),m=n.cy+i*Math.sin(e),v=n.cx+i*Math.cos(f),_=n.cy+i*Math.sin(f);if(b){var y=n.cx+b*Math.cos(e),M=n.cy+b*Math.sin(e),R=n.cx+b*Math.cos(f),P=n.cy+b*Math.sin(f);shape=t.createPath().moveTo(y,M).lineTo(g,m).arcTo(i,i,0,p>Math.PI,!0,v,_).lineTo(R,P).arcTo(b,b,0,p>Math.PI,!1,y,M).closePath().setStroke(h.series.stroke)}else shape=t.createPath().moveTo(n.cx,n.cy).lineTo(g,m).arcTo(i,i,0,p>Math.PI,!0,v,_).lineTo(n.cx,n.cy).closePath().setStroke(h.series.stroke);return specialFill=h.series.fill,shape.setFill(specialFill),{shape:shape,end:f,donutGap:r}};return c.push({isSlice:!0,sliceIndex:a,func:d}),d}},x={getStartAngle:function(t,e){return t.series.donutArcPercent&&100!==t.series.donutArcPercent?(100-t.series.donutArcPercent)/100*360/2-270:(t.series.startAngle||0)+e},getEndAngle:function(t,e,i,n,a,s,r){var l=t+2*e*Math.PI-n;if(i){var o=s+2*Math.PI-n;r||a.series.donutArcPercent&&100!==a.series.donutArcPercent?(l+=n,l=Math.min(l,o)):l=o}return l}};return e([n,a,c],{enableHole:!0,enableGap:!0,startAngleOffset:0,_animationInfos:null,_dataLabels:null,_labelBoxes:null,defaultParams:{labels:!0,ticks:!1,fixed:!0,precision:1,labelStyle:"outside",htmlLabels:!0,radGrad:"native",fanSize:5,startAngle:0,animate:null},optionalParams:{radius:0,omitLabels:!1,stroke:{},outline:{},shadow:{},fill:{},filter:{},styleFunc:null,font:"",fontColor:"",labelWiring:{}},constructor:function(t,e){this.opt=i.clone(this.defaultParams),h.updateWithObject(this.opt,e),h.updateWithPattern(this.opt,e,this.optionalParams),this.axes=[],this.run=null,this.dyn=[],this.runFilter=[]},clear:function(){return this.inherited(arguments),this.dyn=[],this.run=null,this},setAxis:function(t){return this},addSeries:function(t){return this.run=t,this},getSeriesStats:function(){return i.delegate(s.defaultStats)},getRequiredColors:function(){return this.run?this.run.data.length:0},getRenderResults:function(){return this._lastRenderResults},render:function(t,e){function n(t,e,i){return x.getEndAngle(t,e,i,w,s,y)}if(!this.dirty)return this;this.resetEvents(),this._eventSeries={},this.cleanGroup();var a=this.group,s=this.chart.theme;if(!this.run||!this.run.data.length)return this;var r,h,c,d,p,g,m=(t.width-e.l-e.r)/2,v=(t.height-e.t-e.b)/2/this._getRYMultiplier(s),_=Math.min(m,v),y=l._degToRad(this._getStartAngle(s)),M=y,R=this.events(),P=this.run.data.map(function(t,e){return"number"!=typeof t&&t.hidden&&(this.runFilter.push(e),t.hidden=!1),this.runFilter.some(function(t){return t===e})?"number"==typeof t?0:{y:0,text:t.text}:t},this);this.dyn=[],"radius"in this.opt&&(_=this.opt.radius,g=_);var A,S={cx:e.l+m,cy:e.t+v,r:_};if(h=o.map(P,"x ? Math.max(x.y, 0) : 0"),o.every(h,"<= 0"))return a.createCircle(S).setStroke(s.series.stroke),this.dyn=h.map(function(){return{}}),this;c=o.map(h,"/this",o.foldl(h,"+",0)),this.opt.labels&&(d=c.map(function(t,e){return f.getLabelInfo(this,P[e],s)},this));var L=this.enableHole?(s.series.donutHolePercent||0)/100:0,w=this.enableGap?l._degToRad(s.series.donutGap||0):0;c=this._fixSlices(c,w),this._lastRenderResults={},this._animationInfos=[],this._labelBoxes=[];var T=o.map(P,function(t,e){var i=[this.opt,this.run];return null!=t&&"number"!=typeof t&&i.push(t),this.opt.styleFunc&&i.push(this.opt.styleFunc(t)),s.next("slice",i,!0)},this),j=this._preprocessParams(P,s,_,m,v,S,c);if(S=j.circle,_=j.r,this.opt.labels)switch(r=0,p=0,d.forEach(function(t,e){r=Math.max(r,t.box.h),p=Math.max(p,t.box.w)}),this.opt.labelStyle){case"outside":var k=_;_=Math.min(m-p,v-r)-5,g=_+p/2,_=Math.max(_,k/2);break;case"inside":var E=(_-_*L)/2+_*L;g=Math.abs(E+(_-p/2))/2;break;case"columns":_=Math.min(m-p-20,v-2*r),g=_}var F=new Array(c.length);if(c.some(function(t,e){t=this._getSliceValueAt(c,e,s);var i,n=P[e],r=T[e];A=_*L;var l=b.createPath(a,M,_,S,e,e+1===c.length,w,L,s,r,y,this._animationInfos)(t),o=l.end;return shape=l.shape,this.dyn.push({fill:void 0,stroke:r.series.stroke}),R&&(i={element:"slice",index:e,run:this.run,shape:shape,x:e,y:"number"==typeof n?n:n.y,cx:S.cx,cy:S.cy,cr:_},this._connectEvents(i),F[e]=i),M=o+w,!1},this),this.opt.labels){var I=u("dojo-bidi")&&this.chart.isRightToLeft();if("outside"===this.opt.labelStyle||"inside"===this.opt.labelStyle){M=y;c.some(function(e,i){e=this._getSliceValueAt(c,i,s);var a=d[i];if(e<=0)return!1;T[i];if(e>=1)return this._labelBoxes.push({x:S.cx-a.box.w/2,y:S.cy+r/2,w:a.box.w,h:a.box.h,text:a.text}),!0;var l=n(M,e,i+1===c.length);if(this.opt.omitLabels&&l-M<.001)return!1;var o=(M+l)/2,h=g;"outside"===this.opt.labelStyle&&(h=1.15*g+(r-p/2-.15*g)*Math.abs(Math.sin(o)));var u=S.cx+h*Math.cos(o),f=S.cy+h*Math.sin(o)+r/2;return this._labelBoxes.push({x:(I?t.width-u:u)-a.box.w/2,y:f-(2===a.numRows?a.box.h/2:0),w:a.box.w,h:a.box.h,text:a.text}),M=l+w,!1},this)}else if("columns"===this.opt.labelStyle){M=y;var B=this.opt.omitLabels,G=[];c.forEach(function(t,e){t=this._getSliceValueAt(c,e,s);var i=n(M,t,e+1===c.length),a=(M+i)/2;G.push({angle:a,left:Math.cos(a)<0,theme:T[e],index:e,omit:!!B&&i-M<.001}),M=i+w},this),this._getProperLabelRadius(G,d[0].box.h,1.1*g);for(var O=0;O<G.length;O++){var C=G[O],V=d[O];if(!C.omit){var W=S.cx-m,H=S.cx+m,Y=V.box.w,q=S.cx+C.labelR*Math.cos(C.angle),z=S.cy+C.labelR*Math.sin(C.angle),D=C.left?W+Y:H-Y,N=C.left?W:D,U=a.createPath().moveTo(S.cx+g*Math.cos(C.angle),S.cy+g*Math.sin(C.angle));U.lineTo(q,z),U.lineTo(D,z).setStroke(C.theme.series.labelWiring),this._labelBoxes.push({x:I?t.width-Y-N:N,y:z,w:V.box.w,h:V.box.h,text:V.text})}}}}this._renderLabels(a,s,t,e);var X=0;return this._eventSeries[this.run.name]=o.map(P,function(t){return t<=0?null:F[X++]}),u("dojo-bidi")&&this._checkOrientation(this.group,t,e),this.dirty=!1,this._lastRenderResults=i.mixin(this._lastRenderResults,{labels:this.opt.labels,radiusInner:A,radiusOuter:_}),this._renderAdditionalElements(P,s,_,a,S,c),this.opt.animate&&this._renderAnimation(P,s,_,a,S,c),this},_renderLabels:function(t,e,i,n){this._dataLabels=[],d.fixLabelsOverlap(this._labelBoxes,i,n,this._getFixLabelsParams(),t),this._labelBoxes.forEach(function(i){i.hidden||this._dataLabels.push(this.renderLabel(t,i.x,i.y,i.text,e,!0,"left"))},this)},_getFixLabelsParams:function(){return{allowXShift:!0,allowYShift:!0,xGap:3,yGap:3,xTolerance:0,yTolerance:0}},_getStartAngle:function(t){return x.getStartAngle(t,this.startAngleOffset)},_fixSlices:function(t,e){var i=[],n=0,a=[],s=e/(2*Math.PI)+.001;t.forEach(function(t,e){if(t<s){var r=s-t;t=s,n+=r,a.push(e),i[e]=t}});var r=n/(t.length-a.length);return t.forEach(function(t,e){-1===a.indexOf(e)&&(t-=r,i[e]=t)}),i},_getSliceValueAt:function(t,e,i){return Math.max(0,t[e])*(i.series.donutArcPercent?i.series.donutArcPercent/100:1)},_preprocessParams:function(t,e,i,n,a,s,r){return{circle:s,r:i}},_getRYMultiplier:function(t){return Math.max(.625,t.series.donutArcPercent&&100!==t.series.donutArcPercent?(1+Math.cos(l._degToRad(360*(100-t.series.donutArcPercent)/100/2.1)))/2:1)},_renderAdditionalElements:function(t,e,i,n,a,s){},_getProperLabelRadius:function(t,e,i){var n,a,s=1,r=1;if(1===t.length)return void(t[0].labelR=i);for(var l=0;l<t.length;l++){var o=Math.abs(Math.sin(t[l].angle));t[l].left?s>=o&&(s=o,n=t[l]):r>=o&&(r=o,a=t[l])}n.labelR=a.labelR=i,this._calculateLabelR(n,t,e),this._calculateLabelR(a,t,e)},_calculateLabelR:function(t,e,i){for(var n,a=t.index,s=e.length,r=t.labelR;!(e[a%s].left^e[(a+1)%s].left);)e[(a+1)%s].omit||(n=(Math.sin(e[a%s].angle)*r+(e[a%s].left?-i:i))/Math.sin(e[(a+1)%s].angle),r=n<t.labelR?t.labelR:n,e[(a+1)%s].labelR=r),a++;a=t.index;for(var l=0===a?s-1:a-1;!(e[a].left^e[l].left);)e[l].omit||(n=(Math.sin(e[a].angle)*r+(e[a].left?i:-i))/Math.sin(e[l].angle),r=n<t.labelR?t.labelR:n,e[l].labelR=r),a--,l--,a=a<0?a+e.length:a,l=l<0?l+e.length:l}})});