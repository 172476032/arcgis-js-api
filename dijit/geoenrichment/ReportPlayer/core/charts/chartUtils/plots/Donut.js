// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/_base/declare","dojox/charting/plot2d/Base","dojox/charting/plot2d/_PlotEvents","dojox/charting/plot2d/common","dojox/gfx","dojox/gfx/matrix","dojox/lang/functional","dojox/lang/utils","dojo/has"],function(t,e,i,s,a,r,n,l,o,h){return e([i,s],{enableHole:!0,enableGap:!0,defaultParams:{labels:!0,ticks:!1,fixed:!0,precision:1,labelStyle:"outside",htmlLabels:!0,radGrad:"native",fanSize:5,startAngle:0},optionalParams:{radius:0,omitLabels:!1,stroke:{},outline:{},shadow:{},fill:{},filter:{},styleFunc:null,font:"",fontColor:"",labelWiring:{}},constructor:function(e,i){this.opt=t.clone(this.defaultParams),o.updateWithObject(this.opt,i),o.updateWithPattern(this.opt,i,this.optionalParams),this.axes=[],this.run=null,this.dyn=[],this.runFilter=[]},clear:function(){return this.inherited(arguments),this.dyn=[],this.run=null,this},setAxis:function(t){return this},addSeries:function(t){return this.run=t,this},getSeriesStats:function(){return t.delegate(a.defaultStats)},getRequiredColors:function(){return this.run?this.run.data.length:0},getRenderResults:function(){return this._lastRenderResults},render:function(t,e){if(!this.dirty)return this;this.resetEvents(),this.dirty=!1,this._eventSeries={},this.cleanGroup();var i=this.group,s=this.chart.theme;if(!this.run||!this.run.data.length)return this;var a,o,c,u,f,d,b=(t.width-e.l-e.r)/2,p=(t.height-e.t-e.b)/2,x=Math.min(b,p),g="font"in this.opt?this.opt.font:s.series.font,m=n._degToRad(this.opt.startAngle),v=m,y=this.events(),M=this.run.data.map(function(t,e){return"number"!=typeof t&&t.hidden&&(this.runFilter.push(e),t.hidden=!1),this.runFilter.some(function(t){return t==e})?"number"==typeof t?0:{y:0,text:t.text}:t},this);this.dyn=[],"radius"in this.opt&&(x=this.opt.radius,d=x);var R,_={cx:e.l+b,cy:e.t+p,r:x};if(o=l.map(M,"x ? Math.max(x.y, 0) : 0"),l.every(o,"<= 0"))return i.createCircle(_).setStroke(s.series.stroke),this.dyn=o.map(function(){return{}}),this;c=l.map(o,"/this",l.foldl(o,"+",0)),this.opt.labels&&(u=c.map(function(t,e){if(0>t)return"";var i=M[e];return"text"in i?i.text:this._getLabel(100*t)+"%"},this));var P=l.map(M,function(t,e){var i=[this.opt,this.run];return null!==t&&"number"!=typeof t&&i.push(t),this.opt.styleFunc&&i.push(this.opt.styleFunc(t)),s.next("slice",i,!0)},this),k=this.enableHole?(s.series.donutHolePercent||0)/100:0,S=this.enableGap?(s.series.donutGap||0)/360:0;if(this.opt.labels)switch(a=0,f=0,u.forEach(function(t,e){var i=P[e].series.font,s=r._base._getTextBox(t,{font:i});a=Math.max(a,s.h),f=Math.max(f,s.w)}),this.opt.labelStyle){case"outside":var T=5,L=x;x=Math.min(b-f,p-a)-T,d=x+f/2,x=Math.max(x,L/2);break;case"inside":var j=(x-x*k)/2+x*k;d=Math.abs(j+(x-f/2))/2;break;case"columns":x=Math.min(b-f-20,p-2*a),d=x}var I=new Array(c.length);if(c.some(function(s,a){if(0>s)return!1;var r,l,o=M[a],h=P[a];if(0==s)return this.dyn.push({fill:h.series.fill,stroke:h.series.stroke}),!1;if(s>=1){r=this._plotFill(h.series.fill,t,e);var u;if(k){var f=x-x*k;R=x-f/2,u=i.createCircle({cx:_.cx,cy:_.cy,r:R}).setStroke({color:r,width:f})}else R=x,u=i.createCircle(_).setFill(r).setStroke(h.series.stroke);return this.dyn.push({fill:r,stroke:h.series.stroke}),y&&(l={element:"slice",index:a,run:this.run,shape:u,x:a,y:"number"==typeof o?o:o.y,cx:_.cx,cy:_.cy,cr:x},this._connectEvents(l),I[a]=l),!1}var d=v+2*s*Math.PI-S;a+1==c.length&&(d=m+2*Math.PI-S);var b=x*k;R=b;var p=d-v,g=_.cx+x*Math.cos(v),T=_.cy+x*Math.sin(v),L=_.cx+x*Math.cos(d),j=_.cy+x*Math.sin(d);n._degToRad(this.opt.fanSize);if(b){var w=_.cx+b*Math.cos(v),F=_.cy+b*Math.sin(v),E=_.cx+b*Math.cos(d),C=_.cy+b*Math.sin(d);u=i.createPath().moveTo(w,F).lineTo(g,T).arcTo(x,x,0,p>Math.PI,!0,L,j).lineTo(E,C).arcTo(b,b,0,p>Math.PI,!1,w,F).closePath().setStroke(h.series.stroke)}else u=i.createPath().moveTo(_.cx,_.cy).lineTo(g,T).arcTo(x,x,0,p>Math.PI,!0,L,j).lineTo(_.cx,_.cy).closePath().setStroke(h.series.stroke);return r=h.series.fill,u.setFill(r),this.dyn.push({fill:r,stroke:h.series.stroke}),y&&(l={element:"slice",index:a,run:this.run,shape:u,x:a,y:"number"==typeof o?o:o.y,cx:_.cx,cy:_.cy,cr:x},this._connectEvents(l),I[a]=l),v=d+S,!1},this),this.opt.labels){var w=h("dojo-bidi")&&this.chart.isRightToLeft();if("outside"==this.opt.labelStyle||"inside"==this.opt.labelStyle){v=m;c.some(function(e,s){if(0>=e)return!1;var r=P[s];if(e>=1)return this.renderLabel(i,_.cx,_.cy+a/2,u[s],r,!0),!0;var n=v+2*e*Math.PI-S;if(s+1==c.length&&(n=m+2*Math.PI-S),this.opt.omitLabels&&.001>n-v)return!1;var l=(v+n)/2,o=d;"outside"===this.opt.labelStyle&&(o=1.15*d+(a-f/2-.15*d)*Math.abs(Math.sin(l)));var h=_.cx+o*Math.cos(l),b=_.cy+o*Math.sin(l)+a/2;return this.renderLabel(i,w?t.width-h:h,b,u[s],r,!0),v=n+S,!1},this)}else if("columns"==this.opt.labelStyle){v=m;var F=this.opt.omitLabels,E=[];c.forEach(function(t,e){var i=v+2*t*Math.PI-S;e+1==c.length&&(i=m+2*Math.PI-S);var s=(v+i)/2;E.push({angle:s,left:Math.cos(s)<0,theme:P[e],index:e,omit:F?.001>i-v:!1}),v=i+S});var C=r._base._getTextBox("a",{font:g}).h;this._getProperLabelRadius(E,C,1.1*d);for(var G=0;G<E.length;G++){var A=E[G];if(!A.omit){var B=_.cx-b,W=_.cx+b,H=r._base._getTextBox(u[G],{font:A.theme.series.font}).w,O=_.cx+A.labelR*Math.cos(A.angle),z=_.cy+A.labelR*Math.sin(A.angle),q=A.left?B+H:W-H,D=A.left?B:q,J=i.createPath().moveTo(_.cx+d*Math.cos(A.angle),_.cy+d*Math.sin(A.angle));J.lineTo(O,z),J.lineTo(q,z).setStroke(A.theme.series.labelWiring),this.renderLabel(i,w?t.width-H-D:D,z,u[G],A.theme,!1,"left")}}}}var K=0;return this._eventSeries[this.run.name]=l.map(M,function(t){return 0>=t?null:I[K++]}),h("dojo-bidi")&&this._checkOrientation(this.group,t,e),this._lastRenderResults={labels:this.opt.labels,radiusInner:R,radiusOuter:x},this},_getProperLabelRadius:function(t,e,i){var s,a,r=1,n=1;if(1==t.length)return void(t[0].labelR=i);for(var l=0;l<t.length;l++){var o=Math.abs(Math.sin(t[l].angle));t[l].left?r>=o&&(r=o,s=t[l]):n>=o&&(n=o,a=t[l])}s.labelR=a.labelR=i,this._calculateLabelR(s,t,e),this._calculateLabelR(a,t,e)},_calculateLabelR:function(t,e,i){for(var s,a=t.index,r=e.length,n=t.labelR;!(e[a%r].left^e[(a+1)%r].left);)e[(a+1)%r].omit||(s=(Math.sin(e[a%r].angle)*n+(e[a%r].left?-i:i))/Math.sin(e[(a+1)%r].angle),n=s<t.labelR?t.labelR:s,e[(a+1)%r].labelR=n),a++;a=t.index;for(var l=0==a?r-1:a-1;!(e[a].left^e[l].left);)e[l].omit||(s=(Math.sin(e[a].angle)*n+(e[a].left?i:-i))/Math.sin(e[l].angle),n=s<t.labelR?t.labelR:s,e[l].labelR=n),a--,l--,a=0>a?a+e.length:a,l=0>l?l+e.length:l}})});