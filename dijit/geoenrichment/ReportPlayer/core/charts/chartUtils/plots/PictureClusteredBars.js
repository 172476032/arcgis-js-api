// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/_base/array","dojo/_base/declare","dojo/has","dojox/charting/plot2d/CartesianBase","dojox/charting/plot2d/_PlotEvents","dojox/charting/plot2d/common","dojox/gfx/fx","dojox/gfx","dojox/lang/utils","dojox/lang/functional","dojox/lang/functional/reversed","./labelsRendering/_BarsLabelRenderingFix","./pictureUtil/Converter"],function(e,t,a,r,i,s,n,o,h,l,c,d,p,u){var m=d.lambda("item.purgeGroup()");return a("dojox.charting.plot2d.Bars",[i,s,p],{defaultParams:{gap:0,animate:null,enableCache:!1},optionalParams:{minBarSize:1,maxBarSize:1,stroke:{},outline:{},shadow:{},fill:{},filter:{},styleFunc:null,font:"",fontColor:""},constructor:function(t,a){this.opt=e.clone(e.mixin(this.opt,this.defaultParams)),l.updateWithObject(this.opt,a),l.updateWithPattern(this.opt,a,this.optionalParams),this.animate=this.opt.animate,this.renderingOptions={"shape-rendering":"crispEdges"}},getSeriesStats:function(){var e,t=n.collectSimpleStats(this.series);return t.hmin-=.5,t.hmax+=.5,e=t.hmin,t.hmin=t.vmin,t.vmin=e,e=t.hmax,t.hmax=t.vmax,t.vmax=e,t},createRect:function(e,t,a){var r;return this.opt.enableCache&&e._rectFreePool.length>0?(r=e._rectFreePool.pop(),r.setShape(a),t.add(r)):r=t.createRect(a),this.opt.enableCache&&e._rectUsePool.push(r),r},render:function(e,a){if(this.zoom&&!this.isDataDirty())return this.performZoom(e,a);this.dirty=this.isDirty(),this.resetEvents();var i;this.dirty&&(t.forEach(this.series,m),this._eventSeries={},this.cleanGroup(),i=this.getGroup(),c.forEachRev(this.series,function(e){e.cleanGroup(i)}));var s=this.chart.theme,n=this._hScaler.scaler.getTransformerFromModel(this._hScaler),o=this._vScaler.scaler.getTransformerFromModel(this._vScaler),h=Math.max(0,this._hScaler.bounds.lower),l=n(h),d=this.events(),p=this.getBarProperties(),f=this.series.length;t.forEach(this.series,function(e){e.hidden&&f--});for(var g=f,y=this.series.length-1;y>=0;--y){var v=this.series[y];if(this.dirty||v.dirty){v.cleanGroup(),this.opt.enableCache&&(v._rectFreePool=(v._rectFreePool?v._rectFreePool:[]).concat(v._rectUsePool?v._rectUsePool:[]),v._rectUsePool=[]);var x=s.next("bar",[this.opt,v]);if(v.hidden)v.dyn.fill=x.series.fill,v.dyn.stroke=x.series.stroke;else{g--;var _=new Array(v.data.length);i=v.group;for(var b=t.some(v.data,function(e){return"number"==typeof e||e&&!e.hasOwnProperty("x")}),P=b?Math.max(0,Math.floor(this._vScaler.bounds.from-1)):0,S=b?Math.min(v.data.length,Math.ceil(this._vScaler.bounds.to)):v.data.length,j=P;S>j;++j){var F=v.data[j];if(null!=F){var w,B=this.getValue(F,j,y,b),E=n(B.y),M=Math.abs(E-l);if(this.opt.styleFunc||"number"!=typeof F){var C="number"!=typeof F?[F]:[];this.opt.styleFunc&&C.push(this.opt.styleFunc(F)),w=s.addMixin(x,"bar",C,!0)}else w=s.post(x,"bar");if(M>=0&&p.height>=1){var G={x:a.l+(B.y<h?E:l),y:e.height-a.b-o(B.x+1.5)+p.gap+p.thickness*(f-g-1),width:M,height:p.height},k=w.series.chartIcons[j]||u.DEFAULT_SHAPE,z=this._drawBarPictures(i,k,G);if(d){var T={element:"bar",index:j,run:v,shape:z,cx:B.y,cy:B.x+1.5,x:b?j:v.data[j].x,y:b?v.data[j]:v.data[j].y};this._connectEvents(T),_[j]=T}!isNaN(B.py)&&B.py>h&&(G.x+=n(B.py),G.width-=n(B.py)),this.createLabel(i,F,G,w)}}}this._eventSeries[v.name]=_,v.dirty=!1}}else s.skip(),this._reconnectEvents(v.name)}return this.dirty=!1,r("dojo-bidi")&&this._checkOrientation(this.group,e,a),this},_drawBarPictures:function(e,t,a){for(var r=e.createGroup(),i=t.shapeJson,s=a.height/i.style.height,n=i.style.width*s,o=Math.ceil(a.width/n),l=0;o>l;l++){var c=r.createGroup(),d=u.shapeJsonToGFXJson(i);if(h.utils.deserialize(c,d),l===o-1){var p=(n-(o*n-a.width))/s;c.setClip({x:0,y:0,width:p,height:i.style.height})}c.applyTransform(h.matrix.translate(a.x+l*n,a.y)),c.applyTransform(h.matrix.scale(s))}return r},getValue:function(e,t,a,r){var i,s;return r?(i="number"==typeof e?e:e.y,s=t):(i=e.y,s=e.x-1),{y:i,x:s}},getBarProperties:function(){var e=this.series.length;t.forEach(this.series,function(t){t.hidden&&e--});var a=n.calculateBarSize(this._vScaler.bounds.scale,this.opt,e);return{gap:a.gap,height:a.size,thickness:a.size}},_animateBar:function(t,a,r){0==r&&(r=1),o.animateTransform(e.delegate({shape:t,duration:1200,transform:[{name:"translate",start:[a-a/r,0],end:[0,0]},{name:"scale",start:[1/r,1],end:[1,1]},{name:"original"}]},this.animate)).play()}})});