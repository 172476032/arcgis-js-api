// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-style","dojox/gfx","dojox/gfx/matrix","./Donut","./animation/_GaugeAnimation","./supportClasses/GaugeLabelPlacement"],function(e,t,o,n,s,a,r,i){var l={getMainLabelInfo:function(e,o,a,r,l,u,h){var d=(void 0!==h?h:e[0].tooltip.valueLabel)+(o.series.isPercentState?"%":""),b=(o.series.donutHolePercent||0)/100,f=a*b*1.5;o.series.donutMainLabelPosition===i.INSIDE&&o.series.donutShowIcons&&(f/=2);var c=30,x=100,g=30,L={series:t.mixin({},o.series)};L.series.font=o.series.donutMainLabelFont||L.series.font,o.series.donutMainLabelFontColorFromConditionalStyling?L.series.fontColor=e[0].fill:L.series.fontColor=o.series.donutMainLabelFontColor||L.series.fontColor;var M=function(){if(o.series.donutMainLabelFontSize)return o.series.donutMainLabelFontSize;if(o.series.donutMainLabelPosition===i.OUTSIDE)return g;L.series.font=L.series.font.replace(/\s\w*px/," "+g+"px");var e=n._base._getTextBox(d,{font:L.series.font}),t=Math.max(e.w,e.h);return Math.min(x,Math.max(c,g*f/t))}();L.series.font=L.series.font.replace(/\s\w*px/," "+M+"px");var m,I=n._base._getTextBox(d,{font:L.series.font});if(o.series.donutMainLabelPosition===i.OUTSIDE){var _=s._degToRad(u),T=_+2*l*Math.PI,S=o.series.donutShowArrowIndicator?T:(_+T)/2,p=I.w*Math.cos(S),A=I.h*Math.sin(S);m={labelX:r.cx+a*Math.cos(S)-I.w/2+.8*p,labelY:r.cy+a*Math.sin(S)+I.h/3+.8*A,pushX:p,pushY:A}}return{text:d,fontSize:M,labelBox:I,labelT:L,maxLabelSize:f,outsideInfo:m}},getFromLabelInfo:function(e,o,a,r,i,l,u,h){var d={series:t.mixin({},o.series)};d.series.font=o.series.donutFromLabelFont||d.series.font,d.series.fontColor=o.series.donutFromLabelFontColor||d.series.fontColor;var b=o.series.donutFromLabelFontSize||20;d.series.font=d.series.font.replace(/\s\w*px/," "+b+"px");var f,c=n._base._getTextBox(h,{font:d.series.font}),x=s._degToRad(u),g=o.series.donutArcPercent>55?0:Math.max(0,(c.w-(a-r))/2),L=o.series.donutArcPercent<55?0:c.h;return f={labelX:i.cx+a*Math.cos(x)+(a-r-c.w)/2,labelY:i.cy+a*Math.sin(x)+c.h+3,labelBox:c,pushX:g,pushY:L},{text:h,fontSize:b,labelBox:c,labelT:d,outsideInfo:f}},getToLabelInfo:function(e,o,a,r,i,l,u,h){var d={series:t.mixin({},o.series)};d.series.font=o.series.donutToLabelFont||d.series.font,d.series.fontColor=o.series.donutToLabelFontColor||d.series.fontColor;var b=o.series.donutToLabelFontSize||20;d.series.font=d.series.font.replace(/\s\w*px/," "+b+"px");var f,c=n._base._getTextBox(h,{font:d.series.font}),x=s._degToRad(u)+2*l*Math.PI,g=o.series.donutArcPercent>55?0:Math.max(0,(c.w-(a-r))/2),L=o.series.donutArcPercent<55?0:c.h;return f={labelX:i.cx+a*Math.cos(x)-c.w+(c.w-(a-r))/2,labelY:i.cy+a*Math.sin(x)+c.h+3,labelBox:c,pushX:g,pushY:L},{text:h,fontSize:b,labelBox:c,labelT:d,outsideInfo:f}}},u={renderMainLabel:function(e,t,n,s,a,r,u,h,d){var b=function(s,d){var b,f,c,x=l.getMainLabelInfo(e,t,n,r,s,h,d);return t.series.donutMainLabelPosition===i.OUTSIDE?c=u.renderLabel(a,x.outsideInfo.labelX,x.outsideInfo.labelY,x.text,x.labelT,!0,"left"):(b=r.cx-x.labelBox.w/2,f=r.cy,50!==t.series.donutArcPercent&&(f+=x.labelBox.h/3),t.series.donutShowIcons&&(f-=x.maxLabelSize/1.5),c=u.renderLabel(a,b,f,x.text,x.labelT,!0,"left")),c&&"underline"===t.series.donutMainLabelTextDecoration&&(o.set(c,"textDecoration","underline"),o.set(c,"textDecorationColor",x.labelT.series.fontColor)),{labelInfo:x,element:c}};return d&&d.push({isLabel:!0,func:b}),b},renderFromLabel:function(e,t,n,s,a,r,i,u,h,d){var b=l.getFromLabelInfo(e,t,n,s,r,h,u,d),f=i.renderLabel(a,b.outsideInfo.labelX,b.outsideInfo.labelY,b.text,b.labelT,!0,"left");return f&&"underline"===t.series.donutFromLabelTextDecoration&&(o.set(f,"textDecoration","underline"),o.set(f,"textDecorationColor",b.labelT.series.fontColor)),{labelInfo:b,element:f}},renderToLabel:function(e,t,n,s,a,r,i,u,h,d){var b=l.getToLabelInfo(e,t,n,s,r,h,u,d),f=i.renderLabel(a,b.outsideInfo.labelX,b.outsideInfo.labelY,b.text,b.labelT,!0,"left");return f&&"underline"===t.series.donutToLabelTextDecoration&&(o.set(f,"textDecoration","underline"),o.set(f,"textDecorationColor",b.labelT.series.fontColor)),{labelInfo:b,element:f}}},h={renderArrow:function(e,t,o,n,a,r){var i=function(r){var i=s._degToRad(a),l=i+2*r*Math.PI,u=[];return u.push({x:n.cx+5*Math.cos(l+Math.PI/2),y:n.cy+5*Math.sin(l+Math.PI/2)}),u.push({x:n.cx+5*Math.cos(l+Math.PI),y:n.cy+5*Math.sin(l+Math.PI)}),u.push({x:n.cx+5*Math.cos(l-Math.PI/2),y:n.cy+5*Math.sin(l-Math.PI/2)}),u.push({x:n.cx+o*Math.cos(l),y:n.cy+o*Math.sin(l)}),{shape:e.createPath().moveTo(u[0].x,u[0].y).lineTo(u[1].x,u[1].y).lineTo(u[2].x,u[2].y).lineTo(u[3].x,u[3].y).lineTo(u[0].x,u[0].y).setStroke(t.series.donutArrowIndicatorLineColor).setFill(t.series.donutArrowIndicatorFillColor)}};return r.push({isArrow:!0,func:i}),i}};return e([a,r],{startAngleOffset:-90,_preprocessParams:function(e,t,o,n,s,a,r,u){if(t.series.donutMainLabelPosition===i.OUTSIDE){var h=l.getMainLabelInfo(e,t,o,r,this._getSliceValueAt(u,0,t),this._getStartAngle(t)),d=h.outsideInfo.pushX/2,b=h.outsideInfo.pushY/2,f=5,c=o;s-=Math.abs(d),a-=Math.abs(b),o=Math.min(s,a)-f,o=Math.max(o,c/2),r.cx-=d,r.cy-=b,this._lastRenderResults.chartShiftX=-d,this._lastRenderResults.chartShiftY=-b}if(t.series.donutShowFromToLabels){var x=l.getFromLabelInfo(e,t,o,n,r,this._getStartAngle(t),this._getSliceValueAt(u,0,t),t.series.donutFromLabelText),g=l.getToLabelInfo(e,t,o,n,r,this._getStartAngle(t),this._getSliceValueAt(u,0,t)+(this._getSliceValueAt(u,1,t)||0),t.series.donutToLabelText),d=(x.outsideInfo.pushX+g.outsideInfo.pushX)/2,b=x.outsideInfo.pushY/2,f=5,c=o;s-=Math.abs(d),a-=Math.abs(b),o=Math.min(s,a)-f,o=Math.max(o,c/2),r.cy-=b,this._lastRenderResults.chartShiftY-=b}return{circle:r,r:o}},_renderAdditionalElements:function(e,t,o,n,s,a,r){this._lastRenderResults.ryMultiplier=this._getRYMultiplier(t),this._renderGaugeDataLabel(e,t,o,n,s,a,r),this._renderGaugeFromToLabels(e,t,o,n,s,a,r),this._renderGaugeArrowIndicator(e,t,o,n,s,a,r)},_gaugeLabelElement:null,_renderGaugeDataLabel:function(e,t,o,n,s,a,r){if(t.series.donutMainLabelPosition!==i.NONE){var l=u.renderMainLabel(e,t,o,n,s,a,this,this._getStartAngle(t),this._animationInfos)(this._getSliceValueAt(r,0,t));this._gaugeLabelElement=l.element,t.series.donutMainLabelPosition===i.INSIDE&&(this._lastRenderResults.maxIconSize=l.labelInfo.maxLabelSize,this._lastRenderResults.chartIconOffset=l.labelInfo.maxLabelSize/1.25)}},_gaugeFromLabelElement:null,_gaugeToLabelElement:null,_renderGaugeFromToLabels:function(e,t,o,n,s,a,r){if(t.series.donutShowFromToLabels){var i=u.renderFromLabel(e,t,o,n,s,a,this,this._getStartAngle(t),this._getSliceValueAt(r,0,t),t.series.donutFromLabelText);this._gaugeFromLabelElement=i.element;var i=u.renderToLabel(e,t,o,n,s,a,this,this._getStartAngle(t),this._getSliceValueAt(r,0,t)+(this._getSliceValueAt(r,1,t)||0),t.series.donutToLabelText);this._gaugeToLabelElement=i.element}},_renderGaugeArrowIndicator:function(e,t,o,n,s,a,r){t.series.donutShowArrowIndicator&&h.renderArrow(s,t,o,a,this._getStartAngle(t),this._animationInfos)(this._getSliceValueAt(r,0,t))}})});