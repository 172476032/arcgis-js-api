// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/_base/array","dojo/_base/declare","dojo/has","dojox/charting/plot2d/CartesianBase","dojox/charting/plot2d/_PlotEvents","dojox/charting/plot2d/common","dojox/lang/functional","dojox/lang/functional/reversed","dojox/lang/utils","./labelsRendering/_ColumnsLabelRenderingFix","./animation/_ClusteredColumnsAnimation","./_MinVisibleColumn"],function(t,e,i,r,a,s,n,o,h,l,u,c,d){var m=h.lambda("item.purgeGroup()");return i("dojox.charting.plot2d.Columns",[a,s,u,c,d],{_mainShapes:null,_animationInfos:null,defaultParams:{gap:0,animate:null,enableCache:!1},optionalParams:{minBarSize:1,maxBarSize:1,stroke:{},outline:{},shadow:{},fill:{},filter:{},styleFunc:null,font:"",fontColor:"",labelHorizontalAlign:null},constructor:function(e,i){this.opt=t.clone(t.mixin(this.opt,this.defaultParams)),l.updateWithObject(this.opt,i),l.updateWithPattern(this.opt,i,this.optionalParams),this.animate=this.opt.animate,this.renderingOptions={"shape-rendering":"crispEdges"}},getSeriesStats:function(){var t=n.collectSimpleStats(this.series,function(t){return null==t});return t.hmin-=.5,t.hmax+=.5,t},render:function(t,i){if(!this.chart.isPreRenderMode){if(this.zoom&&!this.isDataDirty())return this.performZoom(t,i);this.resetEvents(),this.dirty=this.isDirty();var a;this.dirty&&(e.forEach(this.series,m),this._eventSeries={},this.cleanGroup(),a=this.getGroup(),o.forEachRev(this.series,function(t){t.cleanGroup(a)}));var s=this.chart.theme,n=this._hScaler.scaler.getTransformerFromModel(this._hScaler),h=this._vScaler.scaler.getTransformerFromModel(this._vScaler),l=Math.max(s.series.baseLineValue||0,this._vScaler.bounds.lower),u=h(l),c=this.events(),d=this.getBarProperties();this._mainShapes=[],this._animationInfos=[];var f=this.extractValues(this._hScaler);f=this.rearrangeValues(f,h,u);for(var p=this.series.length-1;p>=0;--p){var g=this.series[p];if(this.dirty||g.dirty){g.cleanGroup(),this.opt.enableCache&&(g._rectFreePool=(g._rectFreePool?g._rectFreePool:[]).concat(g._rectUsePool?g._rectUsePool:[]),g._rectUsePool=[]);var v=s.next("column",[this.opt,g]),_=new Array(g.data.length);if(g.hidden)g.dyn.fill=v.series.fill;else{a=g.group;for(var y=e.some(g.data,function(t){return"number"==typeof t||t&&!t.hasOwnProperty("x")}),x=y?Math.max(0,Math.floor(this._hScaler.bounds.from-1)):0,b=y?Math.min(g.data.length,Math.ceil(this._hScaler.bounds.to)):g.data.length,S=x;S<b;++S){var M=g.data[S];if(null!=M){var P,C=this.getValue(M,S,p,y),j=f[p][S];if(this.opt.styleFunc||"number"!=typeof M){var w="number"!=typeof M?[M]:[];this.opt.styleFunc&&w.push(this.opt.styleFunc(M)),P=s.addMixin(v,"column",w,!0)}else P=s.post(v,"column");if(d.width>=1){var z={x:i.l+n(C.x+.5)+d.gap+d.thickness*this._getXShift(p,s),y:t.height-i.b-u-Math.max(j,0),width:d.width,height:Math.abs(j)},F=this._drawColumn(a,M,z,P,t,i,g,u),V=F.shape;if(V.value=M,this._mainShapes.push(V),z=F.rect,c){var B={element:"column",index:S,run:g,shape:V,cx:C.x+.5,cy:C.y,x:y?S:g.data[S].x,y:y?g.data[S]:g.data[S].y};this._connectEvents(B),_[S]=B}if(this.createLabel(a,M,z,P,i),this.animate){var E={shape:V,voffset:t.height-i.b-u,vsize:j};this._animationInfos.push(E),this._animateColumn(E)}}}}this._eventSeries[g.name]=_,g.dirty=!1}}else s.skip(),this._reconnectEvents(g.name)}return this._renderLabels(P,t,i,a),this.dirty=!1,r("dojo-bidi")&&this._checkOrientation(this.group,t,i),this}},getMainShapes:function(){return this._mainShapes},_drawColumn:function(t,e,i,r,a,s,n,o){},getValue:function(t,e,i,r){var a,s;return r?(a="number"==typeof t?t:t.y,s=e):(a=t.y,s=t.x-1),{x:s,y:a}},extractValues:function(t){for(var i=[],r=this.series.length-1;r>=0;--r){var a=this.series[r];if(this.dirty||a.dirty){var s=e.some(a.data,function(t){return"number"==typeof t||t&&!t.hasOwnProperty("x")}),n=s?Math.max(0,Math.floor(t.bounds.from-1)):0,o=s?Math.min(a.data.length,Math.ceil(t.bounds.to)):a.data.length,h=i[r]=[];h.min=n,h.max=o;for(var l=n;l<o;++l){var u=a.data[l];h[l]=this.isNullValue(u)?0:"number"==typeof u?u:u.y}}}return i},rearrangeValues:function(t,e,i){for(var r=0,a=t.length;r<a;++r){var s=t[r];if(s)for(var n=s.min,o=s.max;n<o;++n){var h=s[n];s[n]=this.isNullValue(h)?0:e(h)-i}}return t},getBarProperties:function(){var t=this._getClusterSize(),e=n.calculateBarSize(this._hScaler.bounds.scale,this.opt,t);return{gap:e.gap,width:e.size,thickness:e.size,clusterSize:t}},_getClusterSize:function(){var t=this.series.length;return e.forEach(this.series,function(e){e.hidden&&t--}),this.chart.theme.series.renderColumnBarsInOppositeDirections?Math.round(t/2):t},_getXShift:function(t,e){return e.series.renderColumnBarsInOppositeDirections&&t>=this.series.length/2?t-this.series.length/2:t}})});