// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/lang","../../ThemeCalculator","../../ChartTypes","../../ChartLineStyles","../../ChartLineMarkers","../../AxisUtil","../utils/ChartDataUtil","../utils/TooltipInfoBuilder","../ChartPlots","esri/dijit/geoenrichment/utils/ColorUtil","./_AxisBuilder","./_PointLabelUtil"],function(e,a,i,t,s,r,n,l,o,u,m,c){var S={calcLineStyle:function(e,r,n,l){var o=l.comparisonInfo,m=l.themeSettings,c=l.visualProperties,S=a.calcColorForPoint(null,e,0,r,n.length,i.LINE,m,e.isComparisonSeries,o),p=c.lineThickness||1,h=c.fillLineArea?c.lineAreaOpacity:1,d=t.SOLID,V=void 0;if(e.isComparisonSeries&&o&&(o.lineThickness&&(p=o.lineThickness),o.lineStyle&&(d=o.lineStyle),V=o.lineMarker?s.getMarkerPath(o.lineMarker):a.getComparisonSymbol()),h<1&&S){var S=u.toColor(S);S.a=h}return{color:S,width:p,style:t.toGFXValue(d),marker:V}}};return{calcSeriesLine:function(a){function s(e){return v?2*e+1:e}var n=a.chart,u=a.chartType,p=a.visualProperties,h=a.seriesItems,d=1===h.length,V=a.seriesItemsWithComparison||h,v=a.isSecondaryPlot,f=a.reverseXY||u===i.VERTICAL_LINE,I=a.comparisonInfo,x=a.themeSettings,y=a.viewModel,g=[],k={minYValue:1/0,maxYValue:-1/0,stackedValues:p.isStacked?[]:null,crossSeriesStats:null},C=a.primaryPlotStat&&a.primaryPlotStat.pointIndexToTooltipsHash||{},A=V.map(function(e,i){return this._collectStatisticsForSeries(a,e,s(i),k)},this);if(k.crossSeriesStats=a.isMultiFeatureChart&&this._collectCrossSeriesStats(A),V.forEach(function(e,i){if(e.points.length){var r=S.calcLineStyle(e,s(i),V,a),m={name:e.label,data:[],isComparisonSeries:e.isComparisonSeries,params:{plot:v?o.SECONDARY:void 0,stroke:{color:r.color,width:r.width,style:r.style},fill:r.color,outline:!1}},h=A[i];e.points.forEach(function(s,o){function S(){return v&&a.oppositeDirections&&1===i?-1:1}function V(){return v&&!a.oppositeDirections&&2===a.primarySeries.length?0===i?-.15:.15:0}var x=h.values[o],g=x||0,A=o+1;c.updatePointIndexToLabelMap(n,A,s,y);var b=a.isMultiFeatureChart&&k.crossSeriesStats[o],M=l.getTooltipInfo({yValue:x,pointLabel:c.getPointLabel(s,y),seriesLabel:e.label,minInSeriesValue:h.minInSeries,maxInSeriesValue:h.maxInSeries,sumInSeriesValue:h.valuesSum,absSumInSeriesValue:h.absValuesSum,avgInSeriesValue:h.avgInSeries,minInAreasValue:b&&b.min,maxInAreasValue:b&&b.max,sumInAreasValue:b&&b.sum,absSumInAreasValue:b&&b.absSum,avgInAreasValue:b&&b.avg,visualProperties:p,chartType:u,isMultiFeature:a.isMultiFeatureChart,color:r.color,conditionalStyling:null,fieldInfo:s.fieldInfo,isThisAreaSpecific:I&&!a.isMultiFeatureChart?!e.isComparisonSeries:void 0,isThisAreaSingleSeries:d,decimals:s.value&&s.value.decimals}),P=C[A]=C[A]||[];P.push(M),M.getGroup=function(){return P};var T={originalValue:x,isUnavailableData:isNaN(x),unsortedIndex:o,seriesIndex:i,name:c.getPointLabel(s,y),_valuesSumsInSeries:h.absValuesSum,point:s,fill:"#FFFFFF",stroke:{color:r.color,width:1,style:t.toGFXValue(t.SOLID)},outline:!1,tooltip:M};y.isGraphicStyle?r.marker&&(T.marker=r.marker):T.marker=void 0,f?(T.x=g*S(),T.y=A+V(),T.valueProp="x"):(T.x=A+V(),T.y=g*S(),T.valueProp="y"),p.yAxis.showValuesAsWeightsInSeries&&(T[f?"x":"y"]/=h.absValuesSum/100),m.data.push(T)}),g.push(m)}},this),k.stackedValues&&(k.stackedValues.sort(function(e,a){return a-e}),k.minYValue=k.stackedValues[k.stackedValues.length-1],k.maxYValue=k.stackedValues[0]),v){if(a.primaryPlotStat){var b=r.getPrettifyYAxisParameters(Math.min(k.minYValue,a.primaryPlotStat.minYValue),Math.max(k.maxYValue,a.primaryPlotStat.maxYValue),{baseLineValue:p.yAxis.baseLineValue,renderColumnBarsInOppositeDirections:a.oppositeDirections,previewBelowZero:!y.dynamicReportInfo});e.mixin(n.axes.y.opt,{majorTickStep:b.majorTickStep,minorTickStep:b.minorTickStep,min:b.min,max:b.max})}if(1===a.primarySeries.length){var M=f?"y":"x",P=[];a.primarySeries[0].data.forEach(function(e){var a=g[0].data[e.unsortedIndex];a[M]=e.x,P.push(a)}),g[0].data=P}}else m.prettifyYAxis(k.minYValue,k.maxYValue,p.yAxis.baseLineValue,n,p,u,x,y);return g},_collectStatisticsForSeries:function(e,a,i,t){var s=e.chartType,r=e.viewModel,l=e.visualProperties,o=e.seriesItems,u=e.currentFeatureIndex,m=e.isMultiFeatureChart,c=e.selectedComparisonAreaId,S=e.isSecondaryPlot,p=e.ge,h=[],d=0,V=0,v=1e6,f=-1e6,I=2===o.length&&e.oppositeDirections&&S?n.CHART_DATA_SMOOTH:null;return a.points.forEach(function(e,t){var o=n.getPreviewValue(e,t,i,!1,s,l,r,m?i:u,I,a.isComparisonSeries,c,p,!1);h[t]=o,o=o||0,d+=o,V+=Math.abs(o),v=Math.min(v,o),f=Math.max(f,o)}),a.points.forEach(function(e,a){var i=h[a],i=l.yAxis.showValuesAsWeightsInSeries?i/V*100:i;t.stackedValues?(t.stackedValues[a]=t.stackedValues[a]||0,t.stackedValues[a]+=i):(t.minYValue=Math.min(i,t.minYValue),t.maxYValue=Math.max(i,t.maxYValue))}),{values:h,valuesSum:d,absValuesSum:V,minInSeries:v,maxInSeries:f,avgInSeries:d/a.points.length}},_collectCrossSeriesStats:function(e){return e.length?e[0].values.map(function(a,i){var t=0,s=0,r=1e6,n=-1e6;return e.forEach(function(e){var a=e.values[i]||0;t+=a,s+=Math.abs(a),r=Math.min(r,a),n=Math.max(n,a)}),{sum:t,absSum:s,min:r,max:n,avg:t/e.length}}):[]}}});