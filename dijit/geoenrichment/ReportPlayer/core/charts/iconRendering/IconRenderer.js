// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dijit/Destroyable","../chartUtils/ChartTypes","../../supportClasses/templateJsonUtils/FieldInfoBuilder","../../supportClasses/TableUtil","../../infographics/infographicUtils/InfographicThemeUtil","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes","esri/dijit/geoenrichment/utils/DomUtil"],function(e,t,o,n,i,s,r,a,c,h,l){var d=50;return e(i,{AXIS_ICON_MAX_SIZE:d,renderIcons:function(e){this._destroyIcons();var t=this._getRenderFunction(e.chartType);t&&this[t](e),this._renderFloatingIcons(e)},_getRenderFunction:function(e){switch(e){case s.DONUT:return"_renderDonutIcons";case s.RING:return"_renderRingIcons";case s.COLUMN:return"_renderColumnIcons";case s.BAR:return"_renderBarIcons"}return null},_renderDonutIcons:function(e){if(e.visualProperties.showChartIcons){var o=e.chart.getPlot("default").getRenderResults();if(o){var i=t.create("div",{"class":"chartContainer_chartIcon"},e.iconNode),s=o.radiusInner;n.set(i,{width:s+"px",height:s+"px",left:(e.chartW-s)/2+"px",top:(e.chartH-s)/2+"px"});var r=e.visualProperties.chartIcons&&e.visualProperties.chartIcons[0];this._createIconSection(e,r||this._getDefaultIcon(),s,i)}}},_renderRingIcons:function(e){if(e.visualProperties.showChartIcons){var o=e.chart.getPlot("default").getRenderResults();if(o){o.slicePies.sort(function(e,t){return e.r-t.r});var i=o.slicePies[0],s=o.slicePies[o.slicePies.length-1],r=t.create("div",{"class":"chartContainer_chartIcon"},e.iconNode),a=0;o.labels?(a=Math.max(50,.8*Math.min(2*i.r,Math.min(o.maxLabelWidth,e.chartW-(s.cx+s.r)))),n.set(r,{width:a+"px",height:a+"px",left:Math.max(s.cx+s.r+15,s.cx+s.r+o.maxLabelWidth/2-a/2)+"px",top:s.cy-a/2+"px"})):(a=1.4*i.r,n.set(r,{width:a+"px",height:a+"px",left:i.cx-a/2+"px",top:i.cy-a/2+"px"}));var c=e.visualProperties.chartIcons&&e.visualProperties.chartIcons[0];this._createIconSection(e,c||this._getDefaultIcon(),a,r)}}},_renderColumnIcons:function(e){this._renderAxisIcons(e,!0)},_renderBarIcons:function(e){this._renderAxisIcons(e,!1)},_renderAxisIcons:function(e,o){if(e.visualProperties.showAxisIcons){var i=this,s=e.chart.calculateGeometry();if(s.series[0].group){var r,a,c=s.series[0].group.children.map(function(e){return e.rawNode});s.series[0].data.forEach(function(e,t){void 0!==e.unsortedIndex&&(r=r||{},r[t]=e.unsortedIndex),a=a||{},a[t]=e.fill});var h=e.visualProperties.isStacked?1:s.series.length,u=l.position(e.iconNode);c.forEach(function(s,f){var p=r?r[f]:f,I=l.position(s),_=t.create("div",{"class":"chartContainer_chartIcon"},e.iconNode),g=Math.min(d,e.chartW/c.length);n.set(_,{width:g+"px",height:g+"px"});var m=e.visualProperties.xAxis.show?0:g/(o?2:3.5);o?n.set(_,{left:I.x-u.x+(I.w*h-g)/2+"px",bottom:-g+m+"px"}):n.set(_,{top:I.y-u.y+(I.h*h-g)/2+"px",left:-g+m+"px"});var v=e.visualProperties.chartIcons&&e.visualProperties.chartIcons[p];i._createIconSection(e,v||i._getDefaultIcon(),g,_,p,a&&a[f])})}}},_floatingIconsSection:null,_renderFloatingIcons:function(e){var t=e.visualProperties.floatingIcons;if(t&&t.length){t.forEach(function(t){var o=t.data.data[0].fieldInfos[t.data.columns[0].field].shapeJson,n=e.viewModel.getChartDefaultStyles(e.theme||e.themeContext);c.applyThemeSettingsToShapeJson(o,n)});var o={};o["class"]="chartContainer_floatingIconSection",o.initialWidth=e.chartW,o.json={type:h.DETAILS,stack:t},o.viewModel=e.viewModel,o.themeContext=e.themeContext,o.theme=e.theme,o.tableClass="chartContainerFloatingIconTable",o.hasFixedLayout=!1,this._provideParamsForFloatingIconSection(o,e),this._floatingIconsSection=e.viewModel.layoutBuilder.createElement("section",o,e.iconNode),this._floatingIconsSection.setResizedHeight(e.chartH),this._floatingIconsSection.setViewMode(this._viewMode||"edit")}},_provideParamsForFloatingIconSection:function(e,t){},_getDefaultIcon:function(){},_iconSections:null,_createIconSection:function(e,t,o,n,i,s){if(t&&(t.imageJson||t.shapeJson)){if(t.shapeJson){var l=e.viewModel.getChartDefaultStyles(e.theme||e.themeContext);c.applyThemeSettingsToShapeJson(t.shapeJson,l),t.shapeJson.themeStyle&&s&&(t.shapeJson.themeStyle.borderColor=s,t.shapeJson.themeStyle.fillColor=s)}var d=a.createSingleCellTable({width:o,height:o,fieldInfo:t.imageJson?r.createFieldInfoFromImage(t.imageJson):r.createFieldInfoFromShape(t.shapeJson),cellStyle:{backgroundColor:"transparent"}}),u={};u.initialWidth=o,u.json={type:h.DETAILS,stack:[d]},u.viewModel=e.viewModel,u.themeContext=e.themeContext,u.theme=e.theme,u.tableClass="chartContainerIconTable",u.hasFixedLayout=!0,this._provideParamsForIconSection(u,e);var f=e.viewModel.layoutBuilder.createElement("section",u,n);f.setResizedHeight(o),f.setViewMode(this._viewMode||"edit"),f.__unsortedIndex=i,this._iconSections.push(f)}},_getSectionUnsortedIndex:function(e){return e&&void 0!==e.__unsortedIndex?e.__unsortedIndex:-1},_provideParamsForIconSection:function(e,t,o){},_viewMode:null,setViewMode:function(e){this._viewMode=e,this._iconSections&&this._iconSections.forEach(function(t){t.setViewMode(e)}),this._floatingIconsSection&&this._floatingIconsSection.setViewMode(e)},_destroyIcons:function(){this._iconSections=this._iconSections||[],this._iconSections.forEach(function(e){var o=e.domNode&&e.domNode.parentNode;e.destroy(),o&&t.destroy(o)}),this._iconSections.length=0,this._floatingIconsSection&&this._floatingIconsSection.destroy(),this._floatingIconsSection=null},destroy:function(){this._destroyIcons(),this.inherited(arguments)}})});