// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/dom-construct","dojo/dom-style","dijit/Destroyable","../utils/ChartTypes","../utils/builder/ChartPlots","../utils/plots/supportClasses/GaugeLabelPlacement","../../supportClasses/templateJsonUtils/fieldInfo/FieldInfoBuilder","../../supportClasses/tableJson/TableJsonUtil","../../infographics/utils/InfographicThemeUtil","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ViewModes"],function(e,t,o,i,n,s,r,a,c,l,h,d,u){var p=e(i,{renderIcons:function(e){this._destroyIcons();var t=this._getRenderFunction(e.chartType);t&&this[t](e),this._renderFloatingIcons(e)},_getRenderFunction:function(e){switch(e){case n.GAUGE:case n.DONUT:return"_renderDonutIcons";case n.RING:return"_renderRingIcons";case n.COLUMN:return"_renderColumnIcons";case n.BAR:return"_renderBarIcons"}return null},_renderDonutIcons:function(e){if(e.visualProperties.showChartIcons){var i=e.chart.getPlot(s.PRIMARY).getRenderResults();if(i){var a=t.create("div",{class:"chartContainer_chartIcon"},e.iconNode),c=i.radiusInner,l=0,h=1;e.chartType===n.GAUGE&&(h=Math.max(.6,i.ryMultiplier),e.visualProperties.gaugeLabelPlacement===r.INSIDE&&(l=i.chartIconOffset,c=Math.min(c,i.maxIconSize)));var d=(e.chartH/h-c+l)/2+(i.chartShiftY||0);d=Math.min(d,e.chartH-c-10),o.set(a,{width:c+"px",height:c+"px",left:(e.chartW-c)/2+(i.chartShiftX||0)+"px",top:d+"px"});var u=e.visualProperties.chartIcons&&e.visualProperties.chartIcons[0];this._createIconSection(e,u||this._getDefaultIcon(),c,a)}}},_renderRingIcons:function(e){if(e.visualProperties.showChartIcons){var i=e.chart.getPlot(s.PRIMARY).getRenderResults();if(i){i.slicePies.sort(function(e,t){return e.r-t.r});var n=i.slicePies[0],r=i.slicePies[i.slicePies.length-1],a=t.create("div",{class:"chartContainer_chartIcon"},e.iconNode),c=0;i.labels?(c=Math.max(50,.8*Math.min(2*n.r,Math.min(i.maxLabelWidth,e.chartW-(r.cx+r.r)))),o.set(a,{width:c+"px",height:c+"px",left:Math.max(r.cx+r.r+15,r.cx+r.r+i.maxLabelWidth/2-c/2)+"px",top:r.cy-c/2+"px"})):(c=1.4*n.r,o.set(a,{width:c+"px",height:c+"px",left:n.cx-c/2+"px",top:n.cy-c/2+"px"}));var l=e.visualProperties.chartIcons&&e.visualProperties.chartIcons[0];this._createIconSection(e,l||this._getDefaultIcon(),c,a)}}},_renderColumnIcons:function(e){this._renderAxisIcons(e,!0)},_renderBarIcons:function(e){this._renderAxisIcons(e,!1)},_renderAxisIcons:function(e,i){if(e.visualProperties.showAxisIcons){var r=this,a=e.chart.calculateGeometry(),c=e.chart.getPlot(s.PRIMARY).getMainShapes();if(c&&c.length){var l={};c.forEach(function(e){(l[e.value.x]=l[e.value.x]||[]).push(e.rawNode)});var h=Object.keys(l).map(function(e){return Number(e)});h.sort();var u,p,I=h.map(function(e){return d.uniteNodeBoxes(l[e])});a.series[0].data.forEach(function(e,t){void 0!==e.unsortedIndex&&(u=u||{},u[t]=e.unsortedIndex),p=p||{},p[t]=e.fill});var f=d.position(e.iconNode);I.forEach(function(s,a){var c=t.create("div",{class:"chartContainer_chartIcon"},e.iconNode),l=Math.min(50,(n.isXAxisVertical(e.chartType)?e.chartH:e.chartW)/I.length);o.set(c,{width:l+"px",height:l+"px"});var h=e.visualProperties.xAxis.show?0:l/(i?2:3.5);i?o.set(c,{left:s.x-f.x+(1*s.w-l)/2+"px",bottom:-l+h+"px"}):o.set(c,{top:s.y-f.y+(1*s.h-l)/2+"px",left:-l+h+"px"});var d=u?u[a]:a,_=e.visualProperties.chartIcons&&e.visualProperties.chartIcons[d];r._createIconSection(e,_||r._getDefaultIcon(),l,c,d,p&&p[a])})}}},_floatingIconsSection:null,_renderFloatingIcons:function(e){var t=e.visualProperties.floatingIcons;if(t&&t.length){t.forEach(function(t){var o=t.data.data[0].fieldInfos[t.data.columns[0].field].shapeJson,i=e.viewModel.getChartDefaultStyles(e.theme);l.applyThemeSettingsToShapeJson(o,i)});var o={};o.class="chartContainer_floatingIconSection",o.initialWidth=e.chartW,o.json={type:h.DETAILS,stack:t},o.viewModel=e.viewModel,o.theme=e.theme,o.tableClass="chartContainerFloatingIconTable",o.hasFixedLayout=!1,o.parentWidget=e.parentWidget,o.initialViewMode=this._viewMode||u.EDIT,this._provideParamsForFloatingIconSection(o,e),this._floatingIconsSection=e.viewModel.layoutBuilder.createElement("section",o,e.iconNode),this._floatingIconsSection.setResizedHeight(e.chartH)}},_provideParamsForFloatingIconSection:function(e,t){},_getDefaultIcon:function(){},_iconSections:null,_createIconSection:function(e,t,o,i,n,s){if(t&&(t.imageJson||t.shapeJson)){if(t.shapeJson){var r=e.viewModel.getChartDefaultStyles(e.theme);l.applyThemeSettingsToShapeJson(t.shapeJson,r),t.shapeJson.themeStyle&&s&&(t.shapeJson.themeStyle.borderColor=s,t.shapeJson.themeStyle.fillColor=s)}var d=c.createSingleCellTable({width:o,height:o,fieldInfo:t.imageJson?a.createFieldInfoFromImage(t.imageJson):a.createFieldInfoFromShape(t.shapeJson),cellStyle:{backgroundColor:"transparent"}}),p={};p.initialWidth=o,p.json={type:h.DETAILS,stack:[d]},p.viewModel=e.viewModel,p.theme=e.theme,p.tableClass="chartContainerIconTable",p.hasFixedLayout=!0,p.parentWidget=e.parentWidget,p.initialViewMode=this._viewMode||u.EDIT,this._provideParamsForIconSection(p,e);var I=e.viewModel.layoutBuilder.createElement("section",p,i);I.setResizedHeight(o),I.__unsortedIndex=n,this._iconSections.push(I)}},_getSectionUnsortedIndex:function(e){return e&&void 0!==e.__unsortedIndex?e.__unsortedIndex:-1},_provideParamsForIconSection:function(e,t,o){},_viewMode:null,setViewMode:function(e){this._viewMode!==e&&(this._viewMode=e,this._iconSections&&this._iconSections.forEach(function(t){t.setViewMode(e)}),this._floatingIconsSection&&this._floatingIconsSection.setViewMode(e))},_destroyIcons:function(){this._iconSections=this._iconSections||[],this._iconSections.forEach(function(e){var o=e.domNode&&e.domNode.parentNode;e.destroy(),o&&t.destroy(o)}),this._iconSections.length=0,this._floatingIconsSection&&this._floatingIconsSection.destroy(),this._floatingIconsSection=null},destroy:function(){this._destroyIcons(),this.inherited(arguments)}});return p.AXIS_ICON_MAX_SIZE=50,p});