// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/string","dojo/_base/window","dojo/_base/connect","dojo/sniff","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dijit/Tooltip","dojox/charting/action2d/Tooltip","dojox/lang/functional","dojox/gfx/matrix","../chartUtils/ChartTypes","../../supportClasses/conditionalStyling/ConditionalStyleLegendBuilder","esri/dijit/geoenrichment/utils/DomUtil","dojo/i18n!../../../../../../nls/jsapi"],function(e,t,a,i,o,r,n,l,s,c,h,u,d,p,v,f,_,b){b=b.geoenrichment.dijit.ReportPlayer.ReportPlayer;var g=Math.PI/4,m=Math.PI/2,T={_nodeInLayoutCheckHandle:null,_rawNode:null,_node:null,show:function(e,t,a,i){t&&(this.hide(t),h.show(e,t,a),this._setClasses(!0),this._setListeners(t,i))},hide:function(e){h.hide(e),this._setClasses(!1),this._setListeners(null,null)},_setClasses:function(e){h._masterTT&&(n[e?"add":"remove"](h._masterTT.domNode,"esriGEChartContainer_chartTooltip_masterTooltip"),n[e?"add":"remove"](h._masterTT.containerNode,"esriGEChartContainer_chartTooltip_containerNode"))},_setListeners:function(e,t){var a=this;clearInterval(this._nodeInLayoutCheckHandle),t&&(this._node=e,this._rawNode=t,this._nodeInLayoutCheckHandle=setInterval(function(){_.isNodeInLayout(a._rawNode)||a.hide(a._node)},500))}};return e(u,{showStatistics:!0,_chartType:null,constructor:function(){var e=this,t=function(t,a){var i=t.run&&t.run.data&&t.run.data[t.index];if(i.tooltip&&"object"==typeof i.tooltip)return e._renderTooltip(i.tooltip)},a=this.text;this.text=function(e,i){return t(e,i)||a(e,i)}},process:function(e){function a(){t.mixin(c,n())}function n(){var t=e.shape.rawNode.getBoundingClientRect(),a=s.position(l.chart.node,!0);return{x:t.left-a.x,y:t.top-a.y,w:t.width,h:t.height}}var l=this;if("onplotreset"===e.type||"onmouseout"===e.type)return T.hide(this.aroundRect),this.aroundRect=null,void("onplotreset"===e.type&&delete this.angles);if(!(!e.shape||this.mouseOver&&"onmouseover"!==e.type||!this.mouseOver&&"onclick"!==e.type)){var c={type:"rect"},h=["after-centered","before-centered"];if(v.isPictureLike(this._chartType))a();else{switch(e.element){case"marker":case"circle":case"spider_circle":case"spider_plot":case"candlestick":a();break;case"column":h=["above-centered","below-centered"];case"bar":a();break;default:if(!this.angles){var u="number"==typeof e.run.data[0]?d.map(e.run.data,"x ? Math.max(x, 0) : 0"):d.map(e.run.data,"x ? Math.max(x.y, 0) : 0");this.angles=d.map(d.scanl(u,"+",0),"* 2 * Math.PI / this",d.foldl(u,"+",0))}var f=p._degToRad(e.plot.opt.startAngle),_=(this.angles[e.index]+this.angles[e.index+1])/2+f;a(),f&&(0>_||_>2*Math.PI)&&(_=Math.abs(2*Math.PI-Math.abs(_))),g>_||(m+g>_?h=["below-centered","above-centered"]:_<Math.PI+g?h=["before-centered","after-centered"]:_<2*Math.PI-g&&(h=["above-centered","below-centered"]))}r("dojo-bidi")&&this._recheckPosition(e,c,h)}var b=this.chart.getCoords();c.x+=b.x,c.y+=b.y,c.x=Math.round(c.x),c.y=Math.round(c.y),c.w=Math.ceil(c.w),c.h=Math.ceil(c.h),this.aroundRect=c;var y=this.text(e,this.plot);y&&T.show(this._format(y),this.aroundRect,h,e.shape.rawNode),this.mouseOver||(this._handle=o.connect(i.doc,"onclick",this,"onClick"))}},setChartType:function(e){this._chartType=e},_renderTooltip:function(e){function t(e,t){var a=l.create("div",{"class":"chartTooltip_title esriGERowHigh"},m,"first");t&&i(t,a),o(e,a)}function i(e,t){var a=l.create("div",{"class":"chartTooltip_color dijitInline esriGESpaceAfterBig"},t);c.set(a,"backgroundColor",e||"transparent")}function o(e,t){return l.create("div",{"class":"chartTooltip_label dijitInline esriGESpaceAfterBig",innerHTML:e},t)}function r(e,t){return l.create("div",{"class":"chartTooltip_value dijitInline esriGESpaceAfterBig",innerHTML:e},t)}function n(e){var t=0;e.forEach(function(e){t=Math.max(t,c.get(e,"width"))}),e.forEach(function(e){c.set(e,"width",t+"px")})}function s(t,a,n,s){function c(t,a){if(e[t]){var n=l.create("div",{"class":"chartTooltip_row esriGERowHigh"},m);i(null,n),_.push(o(a,n)),r(e[t],n)}}c("percentLabel",t),c("minValueLabel",a),c("maxValueLabel",n),c("avgValueLabel",s)}function h(){t(e.label,e.color),i(null,T),g?o(b.unavailableData,T):(o(a.substitute(b.pieChartTooltip_label,{value:e.valueLabel,total:e.sumValueLabel}),T),s(b.weight,b.minValue,b.maxValue,b.avgValue))}function u(){t(e.label,e.color),i(null,T),g?o(b.unavailableData,T):o(a.substitute(b.pieChartTooltip_label,{value:e.valueLabel,total:e.sumValueLabel}),T)}function d(){var a=e.getGroup&&e.getGroup();a&&1!==a.length?(t(e.label),i(e.color,T),_.push(o(e.seriesLabel,T)),g?r(b.unavailableData,T):(r(e.valueLabel,T),s(b.weightInSeries,b.minValueInSeries,b.maxValueInSeries,b.avgValueInSeries)),e.getGroup().forEach(function(t){if(e!==t){var a=l.create("div",{"class":"chartTooltip_row esriGERowHigh"},m);i(t.color,a),_.push(o(t.seriesLabel,a)),isNaN(t.value)?r(b.unavailableData,a):r(t.valueLabel,a)}})):(i(e.color,T),_.push(o(e.label,T)),g?r(b.unavailableData,T):(r(e.valueLabel,T),s(b.weight,b.minValue,b.maxValue,b.avgValue)))}function p(){t(e.label),i(e.color,T),_.push(o(e.seriesLabel,T)),r(e.valueLabel,T),s(b.weightInSeries,b.minValueInSeries,b.maxValueInSeries,b.avgValueInSeries),e.getGroup().forEach(function(t){if(e!==t){var a=l.create("div",{"class":"chartTooltip_row esriGERowHigh"},m);i(t.color,a),_.push(o(t.seriesLabel,a)),r(t.valueLabel,a)}})}var _=[],g=isNaN(e.value),m=l.create("div",{"class":"esriGEChartContainer_chartTooltip"},document.body);if(this.showStatistics){var T=l.create("div",{"class":"chartTooltip_row esriGERowHigh"},m);this._chartType===v.PIE||this._chartType===v.DONUT||this._chartType===v.RING?h():this._chartType===v.GAUGE?u():v.isColumnBarLike(this._chartType)?d():this._chartType===v.LINE&&p(),n(_)}else l.create("div",{"class":"chartTooltip_row esriGERowHigh",innerHTML:b.colorOfBackWillDependOnValue},m);e.conditionalStyling&&l.place(f.createLegendNode(e.conditionalStyling,"chart",e.value),m);var y=m.outerHTML;return l.destroy(m),y}})});