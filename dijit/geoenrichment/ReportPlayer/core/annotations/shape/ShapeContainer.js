// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/sniff","dojo/dom-class","dojo/dom-construct","dojo/dom-style","../../grid/valueField/ValueField","esri/dijit/geoenrichment/utils/ShapeUtil","../../infographics/utils/InfographicThemeUtil","../utils/AnnotationsUtil","dojo/i18n!esri/nls/jsapi"],function(e,t,s,i,h,a,o,n,l,r,d){d=d.geoenrichment.dijit.ReportPlayer.ReportPlayer;var p={borderColor:"#AAAAAA",fillColor:"#AAAAAA"};return e(o,{viewModel:null,theme:null,currentFeatureIndex:null,shapeJson:null,relativeParent:null,alignParams:null,applyThemeStyle:!0,getPreviewValueFunction:null,parentWidget:null,_g:!1,_viewBox:!1,_shapeStyle:null,_shapeThemeStyle:null,_needSaveShapeThemeStyle:!0,_preserveAspectRatio:void 0,_showAsBar:!1,_showBarBackground:!1,_barBackgroundStyle:null,_isPlaceholder:!1,_angle:0,postCreate:function(){var e=this,t=h.create("div",{class:"floatingElement templateShape"});this.content=t,this.fieldStyle=this.fieldStyle||{},this.fieldStyle.width=this.shapeJson.style.width,this.fieldStyle.height=this.shapeJson.style.height,this._g=this.shapeJson.g,this._viewBox=this.shapeJson.viewBox,this._shapeStyle=this.shapeJson.style||{},this._preserveAspectRatio=this.shapeJson.preserveAspectRatio,this._isPlaceholder=this.shapeJson.isPlaceholder,this._angle=this.shapeJson.style.angle||0,this._processThemeStyle(),this._showAsBar=this.shapeJson.showAsBar,this._showBarBackground=this.shapeJson.showBarBackground,this._barBackgroundStyle=this.shapeJson.barBackgroundStyle||{},this.inherited(arguments),i.add(this.domNode,"floatingElementContainer"),a.set(this.domNode,"position","absolute"),a.set(this.domNode,"top",(this.shapeJson.style.top||0)+"px"),a.set(this.domNode,"left",(this.shapeJson.style.left||0)+"px"),this._updateShapeNode(),this._applyRotation(),this.alignParams&&r.alignAnnotationContainer(this,this.alignParams),e.onInitialized()},_processThemeStyle:function(){if(this.applyThemeStyle&&(this._shapeThemeStyle=this.shapeJson.themeStyle,!this._shapeThemeStyle)){this._needSaveShapeThemeStyle=!1;var e=this.viewModel.getStaticInfographicDefaultStyles(this.theme);l.applyThemeSettingsToShapeJson(this.shapeJson,e),this._shapeThemeStyle=this.shapeJson.themeStyle,delete this.shapeJson.themeStyle}},_applyRotation:function(){this._angle=this._angle>0||this._angle<0?this._angle:0;var e=s("webkit")?"webkitTransform":"transform";this.content.style[e]="rotate("+this._angle+"deg)"},_lastAlignParams:null,resize:function(e,t){e&&(this.setWidth(e.w),this.setHeight(e.h)),this._updateShapeNode(),this._lastAlignParams=t||this._lastAlignParams,r.alignAnnotationContainer(this,this._lastAlignParams)},scaleProportionallyWithinParent:function(e){var t=this.getShapeBox();this.resize({w:t.w*e.xScale,h:t.h*e.yScale}),a.set(this.domNode,{left:t.l*e.xScale+"px",top:t.t*e.yScale+"px"})},getShapeBox:function(){return{l:a.get(this.domNode,"left"),t:a.get(this.domNode,"top"),w:this.getWidth(),h:this.getHeight()}},_updateShapeNode:function(){function e(e){var d,c=h.create("div",{class:"shapeContainer_svgContainer esriGEAbsoluteStretched"},l.content);e?(i.add(c,"shapeContainer_svgContainerBackground"),d=t.mixin({},l._barBackgroundStyle,p)):d=t.mixin({},l._shapeThemeStyle,l._shapeStyle);var g=1;l._showAsBar&&(g=e?1:l.getPreviewValueFunction?l.getPreviewValueFunction().normalizedValue:.5+.5*Math.random(),a.set(c,"width",g*r+"px"),i.add(c,"shapeContainer_svgContainerShowAsBar"));var _=l._showAsBar?Math.floor(r/s):1;_=Math.round(g*_);for(var u=0;u<_;u++)!function(e){var t=n.createSVGNode(l._viewBox,{width:s+"px",height:o+"px",overflow:"visible"});l._preserveAspectRatio&&t.setAttribute("preserveAspectRatio",l._preserveAspectRatio),l._g.forEach(function(e){var s=n.createNodeByAttributes(e,d,{overrideFillOpacity:!0});s&&t.appendChild(s)});var i=h.create("div",{class:"shapeContainer_svgContainerElement"},c);a.set(i,"left",e*s+"px"),h.place(t,i)}(u)}var s,o,l=this,r=this.getWidth(),d=this.getHeight(),c=this._viewBox.width/this._viewBox.height,g=Math.min(r,d*c);if("none"===this._preserveAspectRatio?(s=r,o=d):(s=g,o=g/c),a.set(this.content,"width",(this._showAsBar?r:s)+"px"),a.set(this.content,"height",o+"px"),h.empty(this.content),this._isPlaceholder)return void h.create("div",{class:"shapeContainer_svgPlaceholder"},this.content);this._showAsBar&&this._showBarBackground&&e(!0),e()},onInitialized:function(){},_domNodePositionToShapeStyle:function(){this.domNode&&(this._shapeStyle.top=a.get(this.domNode,"top"),this._shapeStyle.left=a.get(this.domNode,"left"))},toJson:function(){this._domNodePositionToShapeStyle();var e={id:"shape",g:this._g,viewBox:this._viewBox,preserveAspectRatio:this._preserveAspectRatio,isPlaceholder:this._isPlaceholder,style:t.mixin({},this._shapeStyle,{angle:this._angle,width:this.getWidth(),height:this.getHeight()}),themeStyle:this._needSaveShapeThemeStyle?this._shapeThemeStyle:void 0,showAsBar:this._showAsBar,showBarBackground:this._showBarBackground,barBackgroundStyle:t.mixin({},this._barBackgroundStyle)};return t.clone(e)}})});