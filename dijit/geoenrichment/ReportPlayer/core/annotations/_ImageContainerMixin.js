// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/Deferred","dojo/sniff","dojox/gfx","dojox/gfx/matrix","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/when","esri/dijit/geoenrichment/_Invoke","esri/dijit/geoenrichment/utils/ImageInfoUtil","./annotationUtils/AnnotationsUtil","./annotationUtils/CircularMaskUtil","../supportClasses/images/ImageDataHolder","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/WaitingUtil","dojo/i18n!../../../../../nls/jsapi"],function(t,e,i,a,s,n,o,h,l,r,g,m,c,d,u,_,p,f){f=f.geoenrichment.dijit.ReportPlayer.ReportPlayer;var M=150,y=6e4;return t(g,{themeContext:null,theme:null,imageJson:null,relativeParent:null,imageTriggerJson:null,movable:!1,alignParams:null,showError:!0,createMapFunc:null,getDynamicImageFunc:null,_circularMask:!1,_fitParent:!0,_angle:0,_opacity:1,_isLogoPlaceholder:!1,_logoPlaceholderType:null,_dynamicBehavior:null,_isMapImage:!1,_webMapId:null,_defaultBasemapId:null,_thumbnailUrl:null,_useDefaultImageSizeFlag:!1,_fileName:null,_imageData:null,postCreate:function(){this._configurePropertiesFromImageJson(),this._isMapImage||(this.createMapFunc=null),this.content=this.createMapFunc?o.create("div",{"class":"templateMap"}):o.create(this._isMapImage?"div":"img",{"class":"floatingElement templateImage"}),this.inherited(arguments),this._configureDomNodeStylesFromParameters(),this._addAdditionalUI(),this._isMapImage?this.resize():this._isLogoPlaceholder&&(this.content._wToHRatio=1,this.resize()),this._applyOpacity(),this._applyRotation(),this.alignParams&&c.alignAnnotationContainer(this,this.alignParams),(this.imageJson.fileName||this.imageJson.isLogoPlaceholder||this._imageData)&&this._initWithImageData()},_configurePropertiesFromImageJson:function(){this.fieldStyle=this.fieldStyle||{},this.fieldStyle.width=this.imageJson.style.width||M,this.fieldStyle.height=this.imageJson.style.height||0,this._circularMask=!!this.imageJson.circularMask,this._isMapImage=!!this.imageJson.isMapImage,this._webMapId=this.imageJson.webMapId,this._defaultBasemapId=this.imageJson.defaultBasemapId,this._thumbnailUrl=this.imageJson.thumbnailUrl,this._isLogoPlaceholder=!!this.imageJson.isLogoPlaceholder,this._logoPlaceholderType=this.imageJson.logoPlaceholderType,this._fileName=this.imageJson.fileName,this._opacity=Math.max(0,Math.min(1,void 0!==this.imageJson.style.opacity?this.imageJson.style.opacity:1)),this._angle=this.imageJson.style.angle||0,this._dynamicBehavior=this.imageJson.dynamicBehavior,this._fitParent=this.imageJson.fitParent!==!1,this.imageJson.style.width||(this._useDefaultImageSizeFlag=!0)},_configureDomNodeStylesFromParameters:function(){this._isLogoPlaceholder&&n.add(this.domNode,"templateImage_logoPlaceholder"),"short"==this._logoPlaceholderType&&n.add(this.domNode,"templateImage_logoPlaceholderShort"),this._isMapImage&&!this.createMapFunc&&this._setMapImageBackground(),n.add(this.domNode,this.movable===!1?"templateImageContainerStatic":"templateImageContainerMovable"),n.add(this.domNode,"floatingElementContainer templateImageContainer"),l.set(this.domNode,"position","absolute"),l.set(this.domNode,"top",(this.imageJson.style.top||0)+"px"),l.set(this.domNode,"left",(this.imageJson.style.left||0)+"px")},_addAdditionalUI:function(){},_applyOpacity:function(){this._opacity>0&&this._opacity<1?(this._ieHackClipMask&&(this._ieHackClipMask.style.opacity=this._opacity),this.content.style.opacity=this._opacity):(delete this.content.style.opacity,this._ieHackClipMask&&delete this._ieHackClipMask.style.opacity)},_applyRotation:function(){this._angle=this._angle>0||this._angle<0?this._angle:0;var t=i("safari")?"webkitTransform":"transform";this.content.style[t]="rotate("+this._angle+"deg)",this._updateCircularMask()},_initWithImageData:function(){var t=this;return r(this._reloadImageData(),function(){t.onInitialized(),t._circularMask&&t._updateCircularMask()})},_reloadImageData:function(){function t(t,e){return i._setImageData({data:t,fileName:e,recalcImageContainerDimentions:i._useDefaultImageSizeFlag,preserveHeight:!1,dispatchEvents:!1})}function e(){return t(u.getImageData(i._fileName)||i.imageJson.data,i._fileName)}var i=this;if(!this._isMapImage){if(!this._isLogoPlaceholder)return e();if(this.getDynamicImageFunc){var a=o.create("div",null,this.domNode);return p.showProgress(a),this.onContentLoadingStart(),r(this.getDynamicImageFunc(this._dynamicBehavior,this.theme||this.themeContext)).then(function(e){return e&&t(e)}).always(function(){o.destroy(a),i.onContentLoadingEnd()})}}},_setImageData:function(t){var i=this,a=t.data,s=t.fileName,n=t.recalcImageContainerDimentions,o=t.preserveHeight,h=t.dispatchEvents,r=new e;return i._showErrorMessage(!1),l.set(this.domNode,"opacity","0.01"),m.getImageInfo(a,s).then(function(t){h&&i.onImageDataPreChanged();var e=t.width/t.height;i.content._wToHRatio=e;var a;i._fitParent?(a=i._useDefaultImageSizeFlag?M:Math.min(i.getWidth(),i.getHeight()*e),l.set(i.content,"width",a+"px"),l.set(i.content,"height",a/e+"px")):(a=i.imageJson.style.width||M,l.set(i.content,"width",a+"px"),l.set(i.content,"height",a/e+"px")),i.content.onload=function(){n&&i._recalcImageContainerDimentions(o),h&&i.onImageDataChanged(),r.resolve()},i.content.onerror=function(t){r.reject(t)},i._fileName=t.filename,i._imageData=t.dataUrl,i._applyBackgroundUrl(t.dataUrl),u.putImageData(t.filename,t.dataUrl),i._syncLogoStateAfterLoadingImage()},r.reject),r.promise.then(function(){i.domNode&&l.set(i.domNode,"opacity","")},function(){i._showErrorMessage(!0)}),r.promise},_syncLogoStateAfterLoadingImage:function(){this.domNode&&n[this._fileName||this._imageData?"remove":"add"](this.domNode,"templateImage_logoPlaceholder"),this._isLogoPlaceholder=!this._fileName},_showErrorMessage:function(t){this.showError&&(t&&!this.errorMessageDiv&&(this.errorMessageDiv=o.create("div",{"class":"templateImage_errorMessage",innerHTML:this._isMapImage?f.mapLoadError:f.imageLoadError},this.domNode),l.set(this.errorMessageDiv,"top",l.get(this.domNode,"height")/2-20+"px")),_[t?"show":"hide"](this.errorMessageDiv))},_recalcImageContainerDimentions:function(t){if(this.domNode){var e=_.position(this.content),i=t&&this.getHeight();this.setWidth(e.w),this.setHeight(e.h),t&&this.setHeight(i)}},_setMapImageBackground:function(){var t=this;n.add(this.content,"templateMapImage"),this._thumbnailUrl?this._applyBackgroundUrl(this._thumbnailUrl):this._webMapId&&(t._applyBackgroundUrl(null),r(this._updateThumbnailUrl(),function(){t._thumbnailUrl&&t._applyBackgroundUrl(t._thumbnailUrl),t.__updateThumbnailClass()})),this.__updateThumbnailClass()},__updateThumbnailClass:function(){n[this._thumbnailUrl?"add":"remove"](this.content,"templateImageWithThumbnail")},_updateThumbnailUrl:function(){},_applyBackgroundUrl:function(t){this._isMapImage?this.content.style.backgroundImage=t?"url("+t+")":"":this.content.src=t||"",this.__updateThumbnailClass(),this._updateCircularMask()},_getBackgroundUrl:function(){return this._isMapImage?l.get(this.content,"backgroundImage").replace("url","").replace("(","").replace(")","").replace(/\"/g,""):this.content.src},isMapImage:function(){return this._isMapImage},_lastAlignParams:null,resize:function(t,e){if(t&&(this.setWidth(t.w),this.setHeight(t.h),this._useDefaultImageSizeFlag=!1),this._isMapImage){var i=l.get(this.content,"width"),a=this.getWidth(),s=l.get(this.content,"height"),n=this.getHeight();(i!==a||s!==n)&&(l.set(this.content,"width",a+"px"),l.set(this.content,"height",n+"px"),this.createMapFunc&&this._placeMap())}else this._lastAlignParams=e,this._resizeContentImage();this._updateCircularMask()},_getContentImageWToHRatio:function(){return this.content._wToHRatio||(this.imageJson.style._imageW||this.imageJson.style.width)/(this.imageJson.style._imageH||this.imageJson.style.height)},_resizeContentImage:function(){var t,e=this._getContentImageWToHRatio();t=this._fitParent?Math.min(this.getWidth(),this.getHeight()*e):Math.min(this.imageJson.style.width,this.imageJson.style.height*e,this.getWidth(),this.getHeight()*e),l.set(this.content,"width",t+"px"),l.set(this.content,"height",t/e+"px"),c.alignAnnotationContainer(this,this._lastAlignParams),this._updateCircularMask()},scaleProportionallyWithinParent:function(t){var e=this.getImageBox(!1);this.resize({w:e.w*t.xScale,h:e.h*t.yScale}),l.set(this.domNode,{left:e.l*t.xScale+"px",top:e.t*t.yScale+"px"})},_isPlacingMapFlag:!1,_currentMap:null,_placeMap:function(){function t(){s&&s.remove(),n&&clearTimeout(n),o.destroy(a),i._finalizePlaceMap()}function e(){t(),i._showErrorMessage(!0),i.onMapLoadError()}var i=this;this._showErrorMessage(!1),this._isPlacingMapFlag&&this._finalizePlaceMap(),this._currentMap&&this._currentMap.destroy(),this._currentMap=null,o.empty(this.content);var a=o.create("div",null,this.content);p.showProgress(a),this.onContentLoadingStart(),this._isPlacingMapFlag=!0;var s,n;return r(this.createMapFunc(this.content,{webMapId:this._webMapId,defaultBasemapId:this._defaultBasemapId}),function(a){return i._currentMap=a,a?(i._mapExtentPending&&i.setVisualState({mapExtent:i._mapExtentPending}),i.own(a),void(a.loaded?t():(s=on.once(a,"load",t),n=setTimeout(function(){e()},y)))):void e()},e)},_finalizePlaceMap:function(){this._isPlacingMapFlag&&(this._isPlacingMapFlag=!1,this.onContentLoadingEnd())},_mapExtentPending:null,getVisualState:function(){return{mapExtent:this._currentMap&&this._currentMap.extent}},setVisualState:function(t){this._mapExtentPending=null,t&&t.mapExtent&&(this._currentMap&&this._currentMap.setExtent?this._currentMap.setExtent(t.mapExtent):this._mapExtentPending=t.mapExtent)},_ieHackClipMask:null,_updateCircularMask:function(){this.createMapFunc||(this._ieHackClipMask&&o.destroy(this._ieHackClipMask),this._ieHackClipMask=d.setCircularMask(this._circularMask&&this._imageData,this.content,this._getBackgroundUrl(),this._angle),this._applyOpacity())},getFitParent:function(){return this._fitParent},setFitParent:function(t){this._fitParent=t,this._resizeContentImage()},getImageBox:function(t){var e=t!==!1&&_.position(this.content);return{w:e?e.w:this.getWidth(),h:e?e.h:this.getHeight(),l:this.domNode?l.get(this.domNode,"left"):0,t:this.domNode?l.get(this.domNode,"top"):0}},setImageWidth:function(t){this._fitParent||(this.imageJson.style.width=t,this.imageJson.style.height=t/this._getContentImageWToHRatio(),this._resizeContentImage())},setImageHeight:function(t){this._fitParent||(this.imageJson.style.height=t,this.imageJson.style.width=t*this._getContentImageWToHRatio(),this._resizeContentImage())},onInitialized:function(){},onImageDataPreChanged:function(){},onImageDataChanged:function(){},onContentLoadingStart:function(){},onContentLoadingEnd:function(){},onMapLoadError:function(){},toJson:function(){var t=_.position(this.content),e={id:"img",fileName:this._isLogoPlaceholder?null:this._fileName,isMapImage:this._isLogoPlaceholder?!1:this._isMapImage,webMapId:this._webMapId,defaultBasemapId:this._defaultBasemapId,thumbnailUrl:this._thumbnailUrl,circularMask:this._circularMask,isLogoPlaceholder:this._isLogoPlaceholder,logoPlaceholderType:this._isLogoPlaceholder?this._logoPlaceholderType:null,dynamicBehavior:this._isLogoPlaceholder?this._dynamicBehavior:null,fitParent:this._fitParent,style:{top:this.domNode?l.get(this.domNode,"top"):0,left:this.domNode?l.get(this.domNode,"left"):0,angle:this._angle,opacity:this._opacity,_imageW:t.w,_imageH:t.h}};return this._fitParent?(e.style.width=this.getWidth(),e.style.height=this.getHeight()):(e.style.width=t.w,e.style.height=t.h),e},destroy:function(){this._finalizePlaceMap(),this.inherited(arguments)}})});