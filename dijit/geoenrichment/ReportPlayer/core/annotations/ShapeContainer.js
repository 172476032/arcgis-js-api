// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-class","dojo/dom-construct","dojo/dom-style","../grid/ValueField","esri/dijit/geoenrichment/utils/ShapeUtil","./annotationUtils/AnnotationsUtil","dojo/i18n!../../../../../nls/jsapi"],function(e,t,i,s,o,a,h,n,r){r=r.geoenrichment.dijit.ReportPlayer.ReportPlayer;var l={borderColor:"#AAAAAA",fillColor:"#AAAAAA"},d=e(a,{shapeJson:null,relativeParent:null,alignParams:null,applyThemeStyle:!0,getPreviewValueFunction:null,_g:!1,_viewBox:!1,_shapeStyle:null,_shapeThemeStyle:null,_preserveAspectRatio:void 0,_showAsBar:!1,_showBarBackground:!1,_barBackgroundStyle:null,_isPlaceholder:!1,postCreate:function(){var e=this,t=s.create("div",{"class":"floatingElement templateShape"});this.content=t,this.fieldStyle=this.fieldStyle||{},this.fieldStyle.width=this.shapeJson.style.width,this.fieldStyle.height=this.shapeJson.style.height,this._g=this.shapeJson.g,this._viewBox=this.shapeJson.viewBox,this._shapeStyle=this.shapeJson.style||{},this._shapeThemeStyle=this.applyThemeStyle?this.shapeJson.themeStyle:null,this._preserveAspectRatio=this.shapeJson.preserveAspectRatio,this._isPlaceholder=this.shapeJson.isPlaceholder,this._showAsBar=this.shapeJson.showAsBar,this._showBarBackground=this.shapeJson.showBarBackground,this._barBackgroundStyle=this.shapeJson.barBackgroundStyle||{},this.inherited(arguments),i.add(this.domNode,"templateShapeContainerStatic"),i.add(this.domNode,"floatingElementContainer templateShapeContainer"),o.set(this.domNode,"position","absolute"),o.set(this.domNode,"top",(this.shapeJson.style.top||0)+"px"),o.set(this.domNode,"left",(this.shapeJson.style.left||0)+"px"),this._updateShapeNode(),this.alignParams&&n.alignAnnotationContainer(this,this.alignParams),e.onInitialized()},getBorders:function(){return{outer:{t:1,b:0,l:1,r:0},inner:{t:0,b:0,l:0,r:0}}},resize:function(e,t){e&&(this.setWidth(e.w-3),this.setHeight(e.h-3)),this._updateShapeNode(),n.alignAnnotationContainer(this,t)},scaleProportionallyWithinParent:function(e){var t=this.getShapeBox();this.resize({w:t.w*e.xScale,h:t.h*e.yScale}),o.set(this.domNode,{left:t.l*e.xScale+"px",top:t.t*e.yScale+"px"})},getShapeBox:function(){return{l:o.get(this.domNode,"left"),t:o.get(this.domNode,"top"),w:this.getWidth(),h:this.getHeight()}},_updateShapeNode:function(){function e(e){function p(e){var t=h.createSVGNode(r._viewBox,{width:a+"px",height:n+"px",overflow:"visible"});r._preserveAspectRatio&&t.setAttribute("preserveAspectRatio",r._preserveAspectRatio),r._g.forEach(function(e){var i=h.createNodeByAttributes(e,c);i&&t.appendChild(i)});var i=s.create("div",{"class":"shapeContainer_svgContainerElement"},g);o.set(i,"left",e*a+"px"),s.place(t,i)}var c,g=s.create("div",{"class":"shapeContainer_svgContainer esriGEAbsoluteStretched"},r.content);e?(i.add(g,"shapeContainer_svgContainerBackground"),c=t.mixin({},r._barBackgroundStyle,l)):c=t.mixin({},r._shapeThemeStyle,r._shapeStyle);var u=1;r._showAsBar&&(u=e?1:r.getPreviewValueFunction?r.getPreviewValueFunction().normalizedValue:.5+.5*Math.random(),o.set(g,"width",u*d+"px"),i.add(g,"shapeContainer_svgContainerShowAsBar"));var _=r._showAsBar?Math.floor(d/a):1;_=Math.round(u*_);for(var v=0;_>v;v++)p(v)}var a,n,r=this,d=this.getWidth(),p=this.getHeight(),c=this._viewBox.width/this._viewBox.height,g=Math.min(d,p*c);return"none"===this._preserveAspectRatio?(a=d,n=p):(a=g,n=g/c),o.set(this.content,"width",(this._showAsBar?d:a)+"px"),o.set(this.content,"height",n+"px"),s.empty(this.content),this._isPlaceholder?void s.create("div",{"class":"shapeContainer_svgPlaceholder"},this.content):(this._showAsBar&&this._showBarBackground&&e(!0),void e())},onInitialized:function(){},_domNodePositionToShapeStyle:function(){this.domNode&&(this._shapeStyle.top=o.get(this.domNode,"top"),this._shapeStyle.left=o.get(this.domNode,"left"))},toJson:function(){this._domNodePositionToShapeStyle();var e={id:"shape",g:this._g,viewBox:this._viewBox,preserveAspectRatio:this._preserveAspectRatio,isPlaceholder:this._isPlaceholder,style:t.mixin({},this._shapeStyle,{width:this.getWidth(),height:this.getHeight()}),themeStyle:this._shapeThemeStyle,showAsBar:this._showAsBar,showBarBackground:this._showBarBackground,barBackgroundStyle:t.mixin({},this._barBackgroundStyle)};return t.clone(e)}});return d});