// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/Deferred","dojo/sniff","dojox/gfx","dojox/gfx/matrix","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/when","esri/dijit/geoenrichment/_Invoke","esri/dijit/geoenrichment/utils/ImageInfoUtil","../annotationUtils/AnnotationsUtil","../annotationUtils/CircularMaskUtil","../annotationUtils/ScaleToCoverUtil","../../supportClasses/images/ImageDataHolder","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/WaitingUtil","dojo/i18n!../../../../../../nls/jsapi","../../../_devConfig"],function(t,e,i,a,s,n,o,l,h,r,g,c,m,d,_,u,p,f,y,M){y=y.geoenrichment.dijit.ReportPlayer.ReportPlayer;return t(g,{viewModel:null,theme:null,imageJson:null,relativeParent:null,imageTriggerJson:null,alignParams:null,showError:!0,parentWidget:null,_createMapFunc:null,_circularMask:!1,_scaleToCover:!1,_fitParent:!0,_angle:0,_opacity:1,_isLogoPlaceholder:!1,_logoPlaceholderType:null,_dynamicBehavior:null,_isMapImage:!1,_webMapId:null,_defaultBasemapId:null,_thumbnailUrl:null,_calculatorFieldName:null,_useDefaultImageSizeFlag:!1,_fileName:null,_imageData:null,postCreate:function(){this._configurePropertiesFromImageJson(),this._isMapImage&&(this._createMapFunc=this.viewModel.dynamicReportInfo&&this.viewModel.dynamicReportInfo.createMapFunc),this.content=this._isMapImage&&this._createMapFunc?o.create("div",{class:"templateLiveMap"}):o.create(this._isMapImage?"div":"img",{class:"floatingElement templateImage"}),this.inherited(arguments),this._configureDomNodeStylesFromParameters(),this._addAdditionalUI(),this._isMapImage?this.resize():this._isLogoPlaceholder&&(this.content._wToHRatio=1,this.resize()),this._applyOpacity(),this._applyRotation(),this.alignParams&&m.alignAnnotationContainer(this,this.alignParams),(this.imageJson.fileName||this.imageJson.isLogoPlaceholder||this._imageData)&&this._initWithImageData()},_configurePropertiesFromImageJson:function(){this.fieldStyle=this.fieldStyle||{},this.fieldStyle.width=this.imageJson.style.width||150,this.fieldStyle.height=this.imageJson.style.height||0,this._fileName=this.imageJson.fileName,this._opacity=Math.max(0,Math.min(1,void 0!==this.imageJson.style.opacity?this.imageJson.style.opacity:1)),this._angle=this.imageJson.style.angle||0,this._dynamicBehavior=this.imageJson.dynamicBehavior,this._fitParent=!1!==this.imageJson.fitParent,this._circularMask=!!this.imageJson.circularMask,this._scaleToCover=!!this.imageJson.scaleToCover,this.imageJson.style.width||(this._useDefaultImageSizeFlag=!0),this.alignParams||!this.imageJson.style.horizontalAlign&&!this.imageJson.style.verticalAlign||(this.alignParams={horizontalAlign:this.imageJson.style.horizontalAlign,verticalAlign:this.imageJson.style.verticalAlign}),this._isMapImage=!!this.imageJson.isMapImage,this._calculatorFieldName=this.imageJson.calculatorFieldName,this._webMapId=this.imageJson.webMapId,this._defaultBasemapId=this.imageJson.defaultBasemapId,this._thumbnailUrl=this.imageJson.thumbnailUrl,this._isLogoPlaceholder=!!this.imageJson.isLogoPlaceholder,this._logoPlaceholderType=this.imageJson.logoPlaceholderType},_configureDomNodeStylesFromParameters:function(){this._isLogoPlaceholder&&n.add(this.domNode,"templateImage_logoPlaceholder"),"short"===this._logoPlaceholderType&&n.add(this.domNode,"templateImage_logoPlaceholderShort"),this._isMapImage&&!this._createMapFunc&&this._setMapImageBackground(),n.add(this.domNode,"floatingElementContainer"),h.set(this.domNode,"position","absolute"),h.set(this.domNode,"top",(this.imageJson.style.top||0)+"px"),h.set(this.domNode,"left",(this.imageJson.style.left||0)+"px")},_addAdditionalUI:function(){},_applyOpacity:function(){this._opacity>=0&&this._opacity<1?(this._clickMaskDiv&&(this._clickMaskDiv.style.opacity=this._opacity),this._scaleToCoverDiv&&(this._scaleToCoverDiv.style.opacity=this._opacity),this.content.style.opacity=this._opacity):(this.content.style.opacity="",this._clickMaskDiv&&(this._clickMaskDiv.style.opacity=""),this._scaleToCoverDiv&&(this._scaleToCoverDiv.style.opacity=""))},_applyRotation:function(){this._angle=this._angle>0||this._angle<0?this._angle:0;var t=i("webkit")?"webkitTransform":"transform";this.content.style[t]="rotate("+this._angle+"deg)",this._updateCircularMaskAndScaleToCover()},_initPromise:null,_initWithImageData:function(){var t=this;return this._initPromise=r(this._reloadImageData(),function(){t.onInitialized(),t._updateCircularMaskAndScaleToCover()}),this._initPromise},isInitialized:function(){return this._initPromise},_reloadImageData:function(){function t(t,i){return e._setImageData({data:t,fileName:i,recalcImageContainerDimentions:e._useDefaultImageSizeFlag,preserveHeight:!1,dispatchEvents:!1})}var e=this;return this._isMapImage?void 0:this._isLogoPlaceholder?this.viewModel.getDynamicImageFunc?(f.showProgress(this.domNode),this.onContentLoadingStart(),r(this.viewModel.getDynamicImageFunc(this._dynamicBehavior,this.theme),function(e){return e&&t(e)}).always(function(){f.removeProgress(e.domNode),e.onContentLoadingEnd()})):void 0:function(){return t(u.getImageData(e._fileName)||e.imageJson.data,e._fileName)}()},_setImageData:function(t){var i=this,a=t.data,s=t.fileName,n=t.recalcImageContainerDimentions,o=t.preserveHeight,l=t.dispatchEvents,r=new e;return this._showErrorMessage(!1),h.set(this.domNode,"opacity","0.01"),c.getImageInfo(a,s).then(function(t){l&&i.onImageDataPreChanged();var e=t.width/t.height;i.content._wToHRatio=e;var a;i._fitParent?(a=i._useDefaultImageSizeFlag?150:Math.min(i.getWidth(),i.getHeight()*e),h.set(i.content,"width",a+"px"),h.set(i.content,"height",a/e+"px")):(a=i.imageJson.style.width||150,h.set(i.content,"width",a+"px"),h.set(i.content,"height",a/e+"px")),i.content.onload=function(){n&&i._recalcImageContainerDimentions(o),l&&i.onImageDataChanged(),r.resolve()},i.content.onerror=function(t){r.reject(t)},i._fileName=t.filename,i._imageData=t.dataUrl,i._applyBackgroundUrl(t.dataUrl),u.putImageData(t.filename,t.dataUrl),i._syncLogoStateAfterLoadingImage()},r.reject),r.promise.then(function(){i.domNode&&h.set(i.domNode,"opacity","")},function(){i._showErrorMessage(!0)}),r.promise},_syncLogoStateAfterLoadingImage:function(){this.domNode&&n[this._fileName||this._imageData?"remove":"add"](this.domNode,"templateImage_logoPlaceholder"),this._isLogoPlaceholder=!this._fileName},_showErrorMessage:function(t){this.showError&&(M.emulateErrors.contentErrors&&(t=!0),t&&!this.errorMessageDiv&&(this.errorMessageDiv=o.create("div",{class:"esriGEReportPlayerErrorMessage",innerHTML:this._isMapImage?y.mapLoadError:y.imageLoadError},this.domNode),h.set(this.errorMessageDiv,"paddingTop",h.get(this.domNode,"height")/2-20+"px")),p[t?"show":"hide"](this.errorMessageDiv),p[t?"hide":"show"](this.contentBlock))},_recalcImageContainerDimentions:function(t){if(this.domNode){var e=p.position(this.content),i=t&&this.getHeight();this.setWidth(e.w),this.setHeight(e.h),t&&this.setHeight(i)}},_setMapImageBackground:function(){var t=this;n.add(this.content,"templateMapImage"),this._thumbnailUrl?this._applyBackgroundUrl(this._thumbnailUrl):this._webMapId&&(t._applyBackgroundUrl(null),r(this._updateThumbnailUrl(),function(){t._thumbnailUrl&&t._applyBackgroundUrl(t._thumbnailUrl),t.__updateThumbnailClass()})),this.__updateThumbnailClass()},__updateThumbnailClass:function(){n[this._thumbnailUrl?"add":"remove"](this.content,"templateImageWithThumbnail")},_updateThumbnailUrl:function(){},_applyBackgroundUrl:function(t){this._isMapImage?this.content.style.backgroundImage=t?"url("+t+")":"":this.content.src=t||"",this.__updateThumbnailClass(),this._updateCircularMaskAndScaleToCover()},_getBackgroundUrl:function(){return this._isMapImage?h.get(this.content,"backgroundImage").replace("url","").replace("(","").replace(")","").replace(/\"/g,""):this.content.src},isMapImage:function(){return this._isMapImage},_lastAlignParams:null,resize:function(t,e){if(t&&(this.setWidth(t.w),this.setHeight(t.h),this._useDefaultImageSizeFlag=!1),this._isMapImage){var i=h.get(this.content,"width"),a=this.getWidth(),s=h.get(this.content,"height"),n=this.getHeight();i===a&&s===n||(h.set(this.content,"width",a+"px"),h.set(this.content,"height",n+"px"),this._createMapFunc&&this._placeMap())}else this._lastAlignParams=e,this._resizeContentImage();this._updateCircularMaskAndScaleToCover()},_getContentImageWToHRatio:function(){return this.content._wToHRatio||(this.imageJson.style._imageW||this.imageJson.style.width)/(this.imageJson.style._imageH||this.imageJson.style.height)},_resizeContentImage:function(){var t,e=this._getContentImageWToHRatio();t=this._fitParent?Math.min(this.getWidth(),this.getHeight()*e):Math.min(this.imageJson.style.width,this.imageJson.style.height*e,this.getWidth(),this.getHeight()*e),h.set(this.content,"width",t+"px"),h.set(this.content,"height",t/e+"px"),m.alignAnnotationContainer(this,this._lastAlignParams),this._updateCircularMaskAndScaleToCover()},scaleProportionallyWithinParent:function(t){var e=this.getImageBox(!1);this.resize({w:e.w*t.xScale,h:e.h*t.yScale}),h.set(this.domNode,{left:e.l*t.xScale+"px",top:e.t*t.yScale+"px"})},_isPlacingMapFlag:!1,_currentMap:null,_placeMap:function(){function t(){a&&a.remove(),s&&clearTimeout(s),f.removeProgress(i.content),i._finalizePlaceMap()}function e(){t(),i._showErrorMessage(!0),i.onMapLoadError()}var i=this;this._showErrorMessage(!1),this._isPlacingMapFlag&&this._finalizePlaceMap(),this._currentMap&&this._currentMap.destroy(),this._currentMap=null,o.empty(this.content),f.showProgress(this.content),this.onContentLoadingStart(),this._isPlacingMapFlag=!0;var a,s;return r(this._createMapFunc(this.content,{webMapId:this._webMapId,defaultBasemapId:this._defaultBasemapId,calculatorFieldName:this._calculatorFieldName}),function(n){if(i._currentMap=n,!n)return void e();i._mapExtentPending&&i.setVisualState({mapExtent:i._mapExtentPending}),i.own(n),n.loaded?t():(a=on.once(n,"load",t),s=setTimeout(function(){e()},6e4))},e)},_finalizePlaceMap:function(){this._isPlacingMapFlag&&(this._isPlacingMapFlag=!1,this.onContentLoadingEnd())},_mapExtentPending:null,getVisualState:function(){return{mapExtent:this._currentMap&&this._currentMap.extent}},setVisualState:function(t){this._mapExtentPending=null,t&&t.mapExtent&&(this._currentMap&&this._currentMap.setExtent?this._currentMap.setExtent(t.mapExtent):this._mapExtentPending=t.mapExtent)},_clickMaskDiv:null,_scaleToCoverDiv:null,_updateCircularMaskAndScaleToCover:function(){this._createMapFunc||(this._clickMaskDiv=d.setCircularMask(this._circularMask&&this._imageData,this.content,this._getBackgroundUrl(),this._angle),this._scaleToCoverDiv=_.setScaleToCover(this._scaleToCover&&this._imageData,this.content,this._getBackgroundUrl(),this._angle),p[this._clickMaskDiv||this._scaleToCoverDiv?"hide":"show"](this.content),this._applyOpacity())},getFitParent:function(){return this._fitParent},setFitParent:function(t){this._fitParent=t,this._resizeContentImage()},getImageBox:function(t){var e=!1!==t&&p.position(this.content);return{w:e?e.w:this.getWidth(),h:e?e.h:this.getHeight(),l:this.domNode?h.get(this.domNode,"left"):0,t:this.domNode?h.get(this.domNode,"top"):0}},setImageWidth:function(t){this._fitParent||(this.imageJson.style.width=t,this.imageJson.style.height=t/this._getContentImageWToHRatio(),this._resizeContentImage())},setImageHeight:function(t){this._fitParent||(this.imageJson.style.height=t,this.imageJson.style.width=t*this._getContentImageWToHRatio(),this._resizeContentImage())},onInitialized:function(){},onImageDataPreChanged:function(){},onImageDataChanged:function(){},onContentLoadingStart:function(){},onContentLoadingEnd:function(){},onMapLoadError:function(){},toJson:function(){var t=p.position(this.content),e={id:"img",fileName:this._isLogoPlaceholder?null:this._fileName,isMapImage:!this._isLogoPlaceholder&&this._isMapImage,webMapId:this._webMapId,defaultBasemapId:this._defaultBasemapId,calculatorFieldName:this._calculatorFieldName,thumbnailUrl:this._thumbnailUrl,circularMask:this._circularMask,scaleToCover:this._scaleToCover,isLogoPlaceholder:this._isLogoPlaceholder,logoPlaceholderType:this._isLogoPlaceholder?this._logoPlaceholderType:null,dynamicBehavior:this._isLogoPlaceholder?this._dynamicBehavior:null,fitParent:this._fitParent,style:{top:this.domNode?h.get(this.domNode,"top"):0,left:this.domNode?h.get(this.domNode,"left"):0,angle:this._angle,opacity:this._opacity,horizontalAlign:this._lastAlignParams&&this._lastAlignParams.horizontalAlign,verticalAlign:this._lastAlignParams&&this._lastAlignParams.verticalAlign,_imageW:t&&t.w,_imageH:t&&t.h}};return this._fitParent?(e.style.width=this.getWidth(),e.style.height=this.getHeight()):(e.style.width=t.w,e.style.height=t.h),e},destroy:function(){this._finalizePlaceMap(),this.inherited(arguments)}})});