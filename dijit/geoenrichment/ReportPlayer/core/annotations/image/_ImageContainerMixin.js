// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/Deferred","dojo/sniff","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/when","esri/dijit/geoenrichment/utils/ImageInfoUtil","./_LiveMapSupport","../utils/AnnotationsUtil","../utils/CircularMaskUtil","../utils/ScaleToCoverUtil","../../supportClasses/images/ImageDataHolder","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/WaitingUtil","dojo/i18n!esri/nls/jsapi","../../../_devConfig"],function(t,e,i,a,s,o,n,h,l,r,g,d,c,m,_,u,p){u=u.geoenrichment.dijit.ReportPlayer.ReportPlayer;return t(l,{viewModel:null,theme:null,currentFeatureIndex:null,imageJson:null,relativeParent:null,imageTriggerJson:null,alignParams:null,showError:!0,parentWidget:null,_createMapFunc:null,_circularMask:!1,_scaleToCover:!1,_fitParent:!0,_angle:0,_opacity:1,_isLogoPlaceholder:!1,_logoPlaceholderType:null,_dynamicBehavior:null,_isMapImage:!1,_webMapId:null,_defaultBasemapId:null,_thumbnailUrl:null,_calculatorFieldName:null,_additionalLayerInfos:null,showMapLegend:!1,_useDefaultImageSizeFlag:!1,_fileName:null,_imageData:null,postCreate:function(){this._configurePropertiesFromImageJson(),this._isMapImage&&(this._createMapFunc=this.viewModel.dynamicReportInfo&&this.viewModel.dynamicReportInfo.createMapFunc),this.content=this._isMapImage&&this._createMapFunc?s.create("div",{class:"templateLiveMap"}):s.create(this._isMapImage?"div":"img",{class:"floatingElement templateImage"}),this.inherited(arguments),this._configureDomNodeStylesFromParameters(),this._addAdditionalUI(),this._isMapImage?this.resize():this._isLogoPlaceholder&&(this.content._wToHRatio=1,this.resize()),this._applyOpacity(),this._applyRotation(),this.alignParams&&r.alignAnnotationContainer(this,this.alignParams),(this.imageJson.fileName||this.imageJson.isLogoPlaceholder||this._imageData)&&this._initWithImageData()},_configurePropertiesFromImageJson:function(){this.fieldStyle=this.fieldStyle||{},this.fieldStyle.width=this.imageJson.style.width||150,this.fieldStyle.height=this.imageJson.style.height||0,this._fileName=this.imageJson.fileName,this._opacity=Math.max(0,Math.min(1,void 0!==this.imageJson.style.opacity?this.imageJson.style.opacity:1)),this._angle=this.imageJson.style.angle||0,this._dynamicBehavior=this.imageJson.dynamicBehavior,this._fitParent=!1!==this.imageJson.fitParent,this._circularMask=!!this.imageJson.circularMask,this._scaleToCover=!!this.imageJson.scaleToCover,this.imageJson.style.width||(this._useDefaultImageSizeFlag=!0),this.alignParams||!this.imageJson.style.horizontalAlign&&!this.imageJson.style.verticalAlign||(this.alignParams={horizontalAlign:this.imageJson.style.horizontalAlign,verticalAlign:this.imageJson.style.verticalAlign}),this._isMapImage=!!this.imageJson.isMapImage,this._calculatorFieldName=this.imageJson.calculatorFieldName,this._webMapId=this.imageJson.webMapId,this._defaultBasemapId=this.imageJson.defaultBasemapId,this._thumbnailUrl=this.imageJson.thumbnailUrl,this._additionalLayerInfos=this.imageJson.additionalLayerInfos,this.showMapLegend=this.imageJson.showMapLegend,this._isLogoPlaceholder=!!this.imageJson.isLogoPlaceholder,this._logoPlaceholderType=this.imageJson.logoPlaceholderType},_configureDomNodeStylesFromParameters:function(){this._isLogoPlaceholder&&a.add(this.domNode,"templateImage_logoPlaceholder"),"short"===this._logoPlaceholderType&&a.add(this.domNode,"templateImage_logoPlaceholderShort"),a.add(this.domNode,"floatingElementContainer"),o.set(this.domNode,"position","absolute"),o.set(this.domNode,"top",(this.imageJson.style.top||0)+"px"),o.set(this.domNode,"left",(this.imageJson.style.left||0)+"px")},_addAdditionalUI:function(){},_applyOpacity:function(){if(!this.domNode)return null;this._opacity>=0&&this._opacity<1?(this._clickMaskDiv&&(this._clickMaskDiv.style.opacity=this._opacity),this._scaleToCoverDiv&&(this._scaleToCoverDiv.style.opacity=this._opacity),this.content.style.opacity=this._opacity):(this.content.style.opacity="",this._clickMaskDiv&&(this._clickMaskDiv.style.opacity=""),this._scaleToCoverDiv&&(this._scaleToCoverDiv.style.opacity=""))},_applyRotation:function(){if(!this.domNode)return null;this._angle=this._angle>0||this._angle<0?this._angle:0;var t=i("webkit")?"webkitTransform":"transform";this.content.style[t]="rotate("+this._angle+"deg)",this._updateCircularMaskAndScaleToCover()},_initPromise:null,_initWithImageData:function(){var t=this;return this._initPromise=n(this._reloadImageData(),function(){t.onInitialized(),t._updateCircularMaskAndScaleToCover()}),this._initPromise},isInitialized:function(){return this._initPromise},_reloadImageData:function(){function t(t,i){return e._setImageData({data:t,fileName:i,recalcImageContainerDimentions:e._useDefaultImageSizeFlag,preserveHeight:!1,dispatchEvents:!1})}var e=this;return this._isMapImage?void 0:this._isLogoPlaceholder?this.viewModel.getDynamicImageFunc?(_.showProgress(this.domNode),this.onContentLoadingStart(),n(this.viewModel.getDynamicImageFunc(this._dynamicBehavior,this.theme),function(e){return e&&t(e)}).always(function(){_.removeProgress(e.domNode),e.onContentLoadingEnd()})):void 0:function(){return t(c.getImageData(e._fileName)||e.imageJson.data,e._fileName)}()},_setImageData:function(t){if(this.domNode&&t.data){var i=this,a=t.data,s=t.fileName,n=t.recalcImageContainerDimentions,l=t.preserveHeight,r=t.dispatchEvents,g=new e;return this._showErrorMessage(!1),o.set(this.domNode,"opacity","0.01"),h.getImageInfo(a,s).then(function(t){if(!i.domNode)return void g.resolve();r&&i.onImageDataPreChanged();var e=t.width/t.height;i.content._wToHRatio=e;var a;i._fitParent?(a=i._useDefaultImageSizeFlag?150:Math.min(i.getWidth(),i.getHeight()*e),o.set(i.content,"width",a+"px"),o.set(i.content,"height",a/e+"px")):(a=i.imageJson.style.width||150,o.set(i.content,"width",a+"px"),o.set(i.content,"height",a/e+"px")),i.content.onload=function(){n&&i._recalcImageContainerDimentions(l),r&&i.onImageDataChanged(),g.resolve()},i.content.onerror=function(t){g.reject(t)},i._fileName=t.filename,i._imageData=t.dataUrl,i._applyBackgroundUrl(t.dataUrl),c.putImageData(t.filename,t.dataUrl),i._syncLogoStateAfterLoadingImage()},g.reject),g.promise.then(function(){i.domNode&&o.set(i.domNode,"opacity","")},function(t){console.log(t),i._showErrorMessage(!0)})}},_syncLogoStateAfterLoadingImage:function(){this.domNode&&a[this._fileName||this._imageData?"remove":"add"](this.domNode,"templateImage_logoPlaceholder"),this._isLogoPlaceholder=!this._fileName},_showErrorMessage:function(t){this.showError&&this.domNode&&(p.emulateErrors.contentErrors&&(t=!0),t&&!this.errorMessageDiv&&(this.errorMessageDiv=s.create("div",{class:"esriGEReportPlayerErrorMessage",innerHTML:this._isMapImage?u.mapLoadError:u.imageLoadError},this.domNode),o.set(this.errorMessageDiv,"paddingTop",o.get(this.domNode,"height")/2-20+"px")),m[t?"show":"hide"](this.errorMessageDiv),m[t?"hide":"show"](this.contentBlock))},_recalcImageContainerDimentions:function(t){if(this.domNode){var e=m.position(this.content),i=t&&this.getHeight();this.setWidth(e.w),this.setHeight(e.h),t&&this.setHeight(i)}},_applyBackgroundUrl:function(t){this.domNode&&(this._isMapImage?this.content.style.backgroundImage=t?"url("+t+")":"":this.content.src=t||"",this._updateThumbnailClass(),this._updateCircularMaskAndScaleToCover())},_updateThumbnailClass:function(){this.content&&a[this._thumbnailUrl?"add":"remove"](this.content,"templateImageWithThumbnail")},_getBackgroundUrl:function(){return this.domNode?this._isMapImage?o.get(this.content,"backgroundImage").replace("url","").replace("(","").replace(")","").replace(/\"/g,""):this.content.src:null},isMapImage:function(){return this._isMapImage},_lastAlignParams:null,resize:function(t,e){if(!this.domNode)return null;if(t&&(this.setWidth(t.w),this.setHeight(t.h),this._useDefaultImageSizeFlag=!1),this._isMapImage){var i=o.get(this.content,"width"),a=this.getWidth(),s=o.get(this.content,"height"),n=this.getHeight();i===a&&s===n||(o.set(this.content,"width",a+"px"),o.set(this.content,"height",n+"px"),this._createMapFunc&&this._placeMap())}else this._lastAlignParams=e,this._resizeContentImage();this._updateCircularMaskAndScaleToCover()},_getContentImageWToHRatio:function(){return this.content._wToHRatio||(this.imageJson.style.innerImageW||this.imageJson.style.width)/(this.imageJson.style.innerImageH||this.imageJson.style.height)},_resizeContentImage:function(){var t,e=this._getContentImageWToHRatio();t=this._fitParent?Math.min(this.getWidth(),this.getHeight()*e):Math.min(this.imageJson.style.width,this.imageJson.style.height*e,this.getWidth(),this.getHeight()*e),o.set(this.content,"width",t+"px"),o.set(this.content,"height",t/e+"px"),r.alignAnnotationContainer(this,this._lastAlignParams),this._updateCircularMaskAndScaleToCover()},scaleProportionallyWithinParent:function(t){if(!this.domNode)return null;var e=this.getImageBox(!1);this.resize({w:e.w*t.xScale,h:e.h*t.yScale}),o.set(this.domNode,{left:e.l*t.xScale+"px",top:e.t*t.yScale+"px"})},_clickMaskDiv:null,_scaleToCoverDiv:null,_updateCircularMaskAndScaleToCover:function(){!this._createMapFunc&&this.domNode&&(this._clickMaskDiv=g.setCircularMask(this._circularMask&&this._imageData,this.content,this._getBackgroundUrl(),this._angle),this._scaleToCoverDiv=d.setScaleToCover(this._scaleToCover&&this._imageData,this.content,this._getBackgroundUrl(),this._angle),m[this._clickMaskDiv||this._scaleToCoverDiv?"hide":"show"](this.content),this._applyOpacity())},getFitParent:function(){return this._fitParent},setFitParent:function(t){this._fitParent=t,this._resizeContentImage()},getImageBox:function(t){var e=!1!==t&&m.position(this.content);return{w:e?e.w:this.getWidth(),h:e?e.h:this.getHeight(),l:this.domNode?o.get(this.domNode,"left"):0,t:this.domNode?o.get(this.domNode,"top"):0}},setImageWidth:function(t){this._fitParent||(this.imageJson.style.width=t,this.imageJson.style.height=t/this._getContentImageWToHRatio(),this._resizeContentImage())},setImageHeight:function(t){this._fitParent||(this.imageJson.style.height=t,this.imageJson.style.width=t*this._getContentImageWToHRatio(),this._resizeContentImage())},onInitialized:function(){},onImageDataPreChanged:function(){},onImageDataChanged:function(){},onContentLoadingStart:function(){},onContentLoadingEnd:function(){},onMapLoadError:function(){},toJson:function(){var t=m.position(this.content),e={id:"img",fileName:this._isLogoPlaceholder?null:this._fileName,isMapImage:!this._isLogoPlaceholder&&this._isMapImage,defaultBasemapId:this._defaultBasemapId,webMapId:this._webMapId,additionalLayerInfos:this._additionalLayerInfos,showMapLegend:this.showMapLegend,calculatorFieldName:this._calculatorFieldName,thumbnailUrl:this._thumbnailUrl,circularMask:this._circularMask,scaleToCover:this._scaleToCover,isLogoPlaceholder:this._isLogoPlaceholder,logoPlaceholderType:this._isLogoPlaceholder?this._logoPlaceholderType:null,dynamicBehavior:this._isLogoPlaceholder?this._dynamicBehavior:null,fitParent:this._fitParent,style:{top:this.domNode?o.get(this.domNode,"top"):0,left:this.domNode?o.get(this.domNode,"left"):0,angle:this._angle,opacity:this._opacity,horizontalAlign:this._lastAlignParams&&this._lastAlignParams.horizontalAlign,verticalAlign:this._lastAlignParams&&this._lastAlignParams.verticalAlign,innerImageW:t&&t.w,innerImageH:t&&t.h}};return this._fitParent?(e.style.width=this.getWidth(),e.style.height=this.getHeight()):(e.style.width=t.w,e.style.height=t.h),e}})});