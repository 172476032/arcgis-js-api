// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.25/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/utils/JsonXmlConverter","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/fieldInfo/RichTextJsonUtil","../../../supportClasses/DocumentOptions","../../ConversionUtil","../../../sections/SectionTypes","./AlignParser","./_HiddenCellsCollector"],function(t,e,r,a,i,s,n,o){function l(t,e,r,a,s){if(t.spannedWidths||t.spannedHeights)for(var n=t.spannedWidths?t.spannedWidths.split(";").map(function(t){return i.ptToPx(t)}):[i.ptToPx(t.width)],o=t.spannedHeights?t.spannedHeights.split(";").map(function(t){return i.ptToPx(t)}):[i.ptToPx(t.height)],l=0;l<n.length;l++)for(var u=0;u<o.length;u++){var d=r[s+l],g=e[a+u],f=g.style.fields[d.field]=g.style.fields[d.field]||{};f.width=n[l],f.height=o[u]}}var u={parseTableCellAttributes:function(e,r,a){var s=a.tableDefaultStyles;if(r=r||{},e.overrideStyle&&(r.overrideStyle=e.overrideStyle),e.pad&&(r.horizontalPadding=i.ptToPx(e.pad)),e.vpad&&(r.verticalPadding=i.ptToPx(e.vpad)),e.angle&&(r.angle=Number(e.angle)||0),n.parseAlign(e,r),e.width&&(r.width=i.ptToPx(e.width)),e.height&&(r.height=i.ptToPx(e.height)),t.mixin(r,i.ptToPxObj(i.parseStyleString(e.style))),r.overrideStyle&&s){var o=s.getStyle(r.overrideStyle);for(var l in o)delete r[l]}return u._parseBorderProperties(e,r),r},_SIDES:["Top","Right","Bottom","Left"],_parseBorderProperties:function(t,e){function r(r){t["border"+r+"Width"]&&(t["border"+r+"Color"]&&(e["border"+r+"Color"]=t["border"+r+"Color"]),t["border"+r+"Width"]&&(e["border"+r+"Width"]=i.ptToPx(t["border"+r+"Width"])),t["border"+r+"Style"]&&(e["border"+r+"Style"]=t["border"+r+"Style"]),e["border"+r+"Opacity"]=Number(t["border"+r+"Opacity"])||1)}u._SIDES.forEach(r)}},d={getElement:function(t,n){var g=n.templateJson,f=i.pxToPt(a.getPageBox(g.documentOptions).contentW);if(t.attributes.widths&&Number(t.attributes.width)>f){var p=i.splitTrim(t.attributes.widths,";",!0),b=Number(t.attributes.width)-f,c=Number(p[p.length-1]);c>b&&(c-=b,p[p.length-1]=c,t.attributes.widths=p.join(";"),t.attributes.width=f)}var h,m,T,S,v=0,y=t.attributes.widths?i.splitTrim(t.attributes.widths,";",!0).map(function(t){return{field:"field"+v++,style:{width:i.ptToPx(t)}}}):[],x=Number(t.attributes.fixedColumns)||0,P=Number(t.attributes.dynamicColumns)||0,w=[];if(function(){t.tags&&(n.revisionVersion>=1.1?t.tags.forEach(function(t){if("tr"===t.name)return void w.push(t);switch(t.attributes.type){case s.TABLE_BACKGROUND:h=t;break;case s.TABLE_FOREGROUND:m=t;break;case s.TABLE_BACKGROUND_FLOATING_PANELS:T=t;break;case s.TABLE_FOREGROUND_FLOATING_PANELS:case s.TABLE_FLOATING_PANELS:S=t}}):t.tags.forEach(function(t){"tr"===t.name?w.push(t):"background"===t.name?h=t:"foreground"===t.name?m=t:"floatingElements"===t.name&&(S=t)}))}(),w){var A=w.map(function(){return{style:{fields:{}},fieldInfos:{}}}),E=o.collectHiddenCells(w,n);w.forEach(function(t,a){var s=A[a];if(t.attributes&&t.attributes.height&&(s.style.height=i.ptToPx(t.attributes.height)),t.tags&&t.tags.length){var d=0;if(P){var g=[],f=[],p=0;t.tags.forEach(function(t){for(;o.isHidden(E,p,a);)p++;p<x?g.push(t):f.push(t),p++});var b=Math.round((y.length-x)/P);t.tags=g;for(var c=0;c<b;c++)t.tags=t.tags.concat(f)}t.tags.forEach(function(t){function i(t){var e=t.tags&&1===t.tags.length&&t.tags[0];return e&&e.tags?("b"===e.name?b.fontWeight="bold":"i"===e.name?b.fontStyle="italic":"u"===e.name&&(b.textDecoration="underline"),"b"===e.name||"i"===e.name||"u"===e.name?i(e)||{tag:e.tags[0],parentTag:e}:null):null}function g(t){e.isRichText(t)?s.fieldInfos[f]=r.createFieldInfoFromRichText(t):s[f]=e.unrichHTML(t)}for(;o.isHidden(E,d,a);)d++;if(y[d]){var f=y[d].field,p=t.attributes||{},b=s.style.fields[f]={};u.parseTableCellAttributes(p,b,n),p.width&&l(p,A,y,a,d);var c=Number(p.colspan),h=Number(p.rowspan);c&&(s.columnSpans=s.columnSpans||{},s.columnSpans[f]=c),h&&(s.rowSpans=s.rowSpans||{},s.rowSpans[f]=h);var m,T=function(t){var e,r,a;if(t.tags&&t.tags.length)if(a=t.tags.filter(function(t){return"br"!==t.name}),(r=a[0])&&"trigger"===r.name&&a[1]&&"d"===a[1].name)e=r,r=a[1];else{var s=i(t);r=s&&s.tag||a[0],t=s&&s.parentTag||t}return{firstTag:r,triggerTag:e,parentTag:t,hasMultipleTags:a&&a.length>1}}(t),S=T.firstTag,v=T.parentTag,x=T.triggerTag,P=T.hasMultipleTags;if(P&&!x){var w=n.parsers.getParser("field").parseRichTextTag(v,n);w&&(s.fieldInfos[f]=w,m=!0)}if(S&&!m){var _=n.parsers.getParser("field").parseField(S,v,x,n);if("number"==typeof _)s[f]=_+"",m=!0;else if(_)s.fieldInfos[f]=_,m=!0;else if("chart"===S.name)m=!0;else if("img"===S.name)m=!0;else if("text"===S.name)s[f]=S.attributes.name,m=!0;else if("a"===S.name&&S.tags&&"#text"===S.tags[0].name){var N=S.attributes.href;N&&(s.urls=s.urls||{},s.urls[f]=N,s[f]=S.tags[0].text,m=!0)}else"#text"!==S.name||P||(g(S.text),m=!0)}m||g(e.getInnerHTML(v)),d++}})}})}var _={id:"table",backgroundSectionJson:h&&d._parseTableBackgroundForeground(h,n),foregroundSectionJson:m&&d._parseTableBackgroundForeground(m,n),backgroundFloatingTablesSectionJson:T&&d._parseFloatingPanels(T,n),foregroundFloatingTablesSectionJson:S&&d._parseFloatingPanels(S,n),data:{columns:y,data:A||[]},style:{width:i.ptToPx(t.attributes.width),left:i.ptToPx(t.attributes.left),spaceBefore:i.ptToPx(t.attributes.spaceBefore),spaceAfter:i.ptToPx(t.attributes.spaceAfter),alternatingStyle:t.attributes.alternatingStyle},attributes:{}};return x&&(_.attributes.fixedColumns=x),P&&(_.attributes.dynamicColumns=P),t.attributes.fixedRows&&(_.attributes.fixedRows=Number(t.attributes.fixedRows)||0),t.attributes.dynamicRows&&(_.attributes.dynamicRows=Number(t.attributes.dynamicRows)||0),_.attributes.inSectionRole=t.attributes.inSectionRole,_},_parseTableBackgroundForeground:function(t,e){return t.attributes=t.attributes||{},t.attributes.type=s.DETAILS,e.parsers.getParser("section").parseSection(t,e)},_parseFloatingPanels:function(t,e){return t.attributes=t.attributes||{},t.attributes.type=s.DETAILS,e.parsers.getParser("section").parseSection(t,e)}};return d.parseTableCellAttributes=u.parseTableCellAttributes,d});