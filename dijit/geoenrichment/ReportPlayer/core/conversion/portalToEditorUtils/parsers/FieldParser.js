// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

// Example: <text name="Copyright" />

define(["esri/dijit/geoenrichment/utils/JsonXmlConverter","../../../supportClasses/templateJsonUtils/fieldInfo/RichTextJsonUtil","../../../supportClasses/templateJsonUtils/fieldInfo/FieldInfoBuilder","../../ConversionUtil","../../ShapeConverter","../../../annotations/shape/ShapeJsonUtil","./_FieldInfoBuilder","./ImageParser","./AlignParser","../../../../_devConfig"],function(e,r,t,a,n,i,o,s,l,f){function g(e){var r=e.attributes||{};return r&&!r.m&&(r.decimals||r.symbol||r.thousands)&&(r.m={showCurrency:"currency"===r.symbol,showPercent:"percent"===r.symbol,useThousandsSeparator:r.thousands!==!1,decimals:Number(r.decimals)||0}),r}function u(r){return e.queryJson(r,/^d$|^text$|^reportName$|^reportTitle2/)}var m={},c={parseImageTrigger:function(e,r){var t=o.getCalculatorOrScriptFieldInfo(e.attributes.field,r);if(!t)return console.log("Parse template error => can't build fieldInfo for field "+e.attributes.field),console.log(e),null;var a={fieldInfo:t,cases:[]},n=this;return e.tags.forEach(function(e){var t="case"===e.name?e.attributes.key:"default",i=e.tags[0],o=r.processFileName(i.attributes.value);a.cases.push({compareInfos:n._getCompareInfosFromTriggerKey(t),setters:[{property:i.attributes.property,value:o}]}),r.putImageData(o)}),a},parseFieldTrigger:function(e,r,t){r.triggerJson={fieldInfo:t&&o.getCalculatorOrScriptFieldInfo(e.attributes.field,t),cases:[]};var a=this;e.tags.forEach(function(e){var t="case"===e.name?e.attributes.key:"default",n={compareInfos:a._getCompareInfosFromTriggerKey(t),setters:[]};r.triggerJson.cases.push(n),e.tags.forEach(function(e){n.setters.push({property:e.attributes.property,value:e.attributes.value})})})},_getCompareInfosFromTriggerKey:function(e){var r=e.split(a.KEY_INTERVAL_SEPARATOR);return r.map(function(e){var r=a.ONE_FIELD_KEY_TEST.test(e)?e.replace(a.KEY_OPERATOR_RE,""):e,t=e.substr(0,e.length-r.length)||"=";return{value:r,operator:t}})}},d={getFieldInfo:function(e,r,a,n){var i=n.parsers.getParser("chart").portalToEditor(e,r,n);return i&&t.createFieldInfoFromChart(i)}},p={getFieldInfo:function(e,r,a,n){var i=n.parsers.getParser("infographic").portalToEditor(e,r,n);return i&&t.createFieldInfoFromInfographic(i)}},F={getFieldInfo:function(e,r,a,n){var i,o=s.getElement(e,n);return e.tags&&e.tags[0]&&"trigger"===e.tags[0].name&&(i=c.parseImageTrigger(e.tags[0],n)),t.createFieldInfoFromImage(o,i)}},I={getFieldInfo:function(e,r,a,o){var s=n.svgJsonToShapeObject(e),f=n.getStylesFromSvgJson(e),g=i.createShapeJsonFromShapeObj(s,f),u=e.attributes;return g.style.angle=Number(u.angle)||0,l.parseAlign(u,g.style),t.createFieldInfoFromShape(g)}},h={getFieldInfo:function(e,r,a,n){var i=n.parsers.getParser("section").parseSection(e,n);return t.createFieldInfoFromSection(i)}},v={getFieldInfo:function(e,r,a,n,i){var l=g(e);if(r=r||l.f,i.templateJson.metadata.mapImageInfosHash[r]){var f=s.parseMapImageDField(r,i);return t.createFieldInfoFromImage(f)}var u=t.createFieldInfoFromSpecialFieldName(r,l.m);if(!u){var m;2===a.tags.length&&"#text"===a.tags[1].name&&(m=a.tags[1].text),u=o.getCalculatorOrScriptFieldInfo(r,i,{format:l.m,additionalText:m})}return u&&n&&(c.parseFieldTrigger(n,u,i),u.triggerJson&&!u.triggerJson.fieldInfo&&(u.triggerJson.fieldInfo=null,console.log("Parse template error => can't build fieldInfo for field "+n.attributes.field),console.log(n))),u}};return m.parseField=function(e,r,a,n){var i;if(f.emulateErrors.layoutParseError)throw new Error("Error test: something crashed during the parsing of the layout!");if(e){if("chart"===e.name)return d.getFieldInfo(e,r,a,n);if("infographic"===e.name)return p.getFieldInfo(e,r,a,n);if(("img"===e.name||"mapImage"===e.name)&&e.attributes)return F.getFieldInfo(e,r,a,n);if("svg"===e.name)return I.getFieldInfo(e,r,a,n);if("section"===e.name)return h.getFieldInfo(e,r,a,n);if("d"===e.name)i=v.getFieldInfo(e,null,r,a,n);else if("a"===e.name&&e.tags&&"d"===e.tags[0].name){var o=e.tags[0];i=v.getFieldInfo(o,null,r,a,n),i&&e.attributes&&e.attributes.hreff&&(i.linkFieldInfo=v.getFieldInfo(o,e.attributes.hreff,r,a,n))}else i="text"===e.name?t.createFieldInfoFromSpecialFieldName(g(e).name):t.createFieldInfoFromSpecialFieldName(e.name,g(e).m)}if(!i){var s=u(r);if(1===s.length&&s[0].attributes&&"TrialUrlText"===s[0].attributes.name)return t.createFieldInfoFromSpecialFieldName(s[0].attributes.name);i=m.parseRichTextTag(r,n)}return i},m.parseRichTextTag=function(a,n){var i,o=u(a);if(o.length){var s=[],l=[],f=!0;o.some(function(e,r){var i=e.attributes?e.attributes.name:e.name,o="d"===e.name?v.getFieldInfo(e,null,a,null,n):i&&t.createFieldInfoFromSpecialFieldName(i);return o?void("d"===e.name?s.push(o):l.push(o)):(f=!1,!0)}),f&&(i=r.createFieldInfoFromRichText(e.getInnerHTML(a),s,l))}return i},m.parseFieldTrigger=function(e,r,t){return r=r||{},c.parseFieldTrigger(e,r,t),r.triggerJson},m});