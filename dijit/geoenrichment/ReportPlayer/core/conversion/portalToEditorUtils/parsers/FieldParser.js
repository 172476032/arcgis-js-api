// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

// Example: <text name="Copyright" />

define(["esri/dijit/geoenrichment/utils/JsonXmlConverter","../../../supportClasses/templateJsonUtils/RichTextJsonUtil","../../../supportClasses/templateJsonUtils/FieldInfoBuilder","../../ConversionUtil","../../ShapeConverter","../../../annotations/annotationUtils/ShapeJsonUtil"],function(e,t,r,a,i,n){function o(e){var t=e.attributes||{};return t&&!t.m&&(t.decimals||t.symbol||void 0!==t.thousands)&&(t.m={showCurrency:"currency"==t.symbol,showPercent:"percent"==t.symbol,useThousandsSeparator:t.thousands!==!1,decimals:Number(t.decimals)||0}),t}function s(e,t,a){if(!e)return null;var i=a.variableProvider,n=e.substr(e.indexOf(".")+1),o=n.toUpperCase(),s=a.queryMetaDataFunc(o);if(!s)return null;var l=s.isMissing?"createFieldInfoFromMissingVariable":s.isScript?"createFieldInfoFromScript":"createFieldInfoFromCalculator";return r[l](s,i,t)}function l(t){return e.queryJson(t,/^d$|^text$|^reportName$|^reportTitle2/)}var u={},f={parseImageTrigger:function(e,t){var r={fieldInfo:s(e.attributes.field,null,t),cases:[]},a=this;return e.tags.forEach(function(e){var i="case"==e.name?e.attributes.key:"default",n=e.tags[0],o=t.processFileName(n.attributes.value);r.cases.push({compareInfos:a._getCompareInfosFromTriggerKey(i),setters:[{property:n.attributes.property,value:o}]}),t.putImageData(o)}),r},parseFieldTrigger:function(e,t,r){t.triggerJson={fieldInfo:r&&s(e.attributes.field,null,r),cases:[]};var a=this;e.tags.forEach(function(e){var r="case"==e.name?e.attributes.key:"default",i={compareInfos:a._getCompareInfosFromTriggerKey(r),setters:[]};t.triggerJson.cases.push(i),e.tags.forEach(function(e){i.setters.push({property:e.attributes.property,value:e.attributes.value})})})},_getCompareInfosFromTriggerKey:function(e){var t=e.split(a.KEY_INTERVAL_SEPARATOR);return t.map(function(e){var t=a.ONE_FIELD_KEY_TEST.test(e)?e.replace(a.KEY_OPERATOR_RE,""):e,r=e.substr(0,e.length-t.length)||"=";return{value:t,operator:r}})}},c={getFieldInfo:function(e,t,a,i){var n=i.parsers.getParser("chart").portalToEditor(e,t,i.queryMetaDataFunc,i.variableProvider,i);return n&&r.createFieldInfoFromChart(n)}},g={getFieldInfo:function(e,t,a,i){var n=i.parsers.getParser("infographic").portalToEditor(e,t,i);return n&&r.createFieldInfoFromInfographic(n)}},m={getFieldInfo:function(e,t,i,n){var o=n.processFileName(e.attributes.src),s={id:"img",fileName:o,circularMask:e.attributes.circularMask,style:{top:a.ptToPx(e.attributes.top),left:a.ptToPx(e.attributes.left),width:a.ptToPx(e.attributes.width),height:a.ptToPx(e.attributes.height),angle:Number(e.attributes.angle)||0,opacity:Math.min(1,Number(0===e.attributes.opacity?0:e.attributes.opacity||1))}};n.revisionVersion<1&&(s.style.angle=a.ptToPx(s.style.angle),s.style.opacity=Math.min(1,a.ptToPx(s.style.opacity))),n.putImageData(o);var l;return e.tags&&e.tags[0]&&"trigger"==e.tags[0].name&&(l=f.parseImageTrigger(e.tags[0],n)),r.createFieldInfoFromImage(s,l)}},p={getFieldInfo:function(e,t,a,o){var s=i.svgJsonToShapeObject(e),l=i.getStylesFromSvgJson(e),u=n.createShapeJsonFromShapeObj(s,l);return r.createFieldInfoFromShape(u)}},d={getFieldInfo:function(e,t,a,i){var n=i.parsers.getParser("section").parseSection(e,i);return r.createFieldInfoFromSection(n)}},F={getFieldInfo:function(e,t,a,i,n){var l=o(e),u=l[t||"f"],c=r.createFieldInfoFromSpecialFieldName(u,l.m);if(!c){var g;2==a.tags.length&&"#text"==a.tags[1].name&&(g=a.tags[1].text),c=s(u,{format:l.m,additionalText:g},n)}return c&&i&&f.parseFieldTrigger(i,c,n),c}};return u.parseField=function(e,t,a,i){var n;if(e){if("chart"==e.name)return c.getFieldInfo(e,t,a,i);if("infographic"==e.name)return g.getFieldInfo(e,t,a,i);if("img"==e.name&&e.attributes)return m.getFieldInfo(e,t,a,i);if("svg"==e.name)return p.getFieldInfo(e,t,a,i);if("section"==e.name)return d.getFieldInfo(e,t,a,i);if("d"==e.name)n=F.getFieldInfo(e,null,t,a,i);else if("a"==e.name&&e.tags&&"d"==e.tags[0].name){var s=e.tags[0];n=F.getFieldInfo(s,null,t,a,i),n&&e.attributes&&e.attributes.hreff&&(n.linkFieldInfo=F.getFieldInfo(s,"hreff",t,a,i))}else n="text"==e.name?r.createFieldInfoFromSpecialFieldName(o(e).name):r.createFieldInfoFromSpecialFieldName(e.name,o(e).m)}if(!n){var f=l(t);if(1==f.length&&f[0].attributes&&"TrialUrlText"==f[0].attributes.name)return r.createFieldInfoFromSpecialFieldName(f[0].attributes.name);n=u.parseRichTextTag(t,i)}return n},u.parseRichTextTag=function(a,i){var n,o=l(a);if(o.length){var s=[],u=[],f=!0;o.some(function(e,t){var n=e.attributes?e.attributes.name:e.name,o="d"==e.name?F.getFieldInfo(e,null,a,null,i):n&&r.createFieldInfoFromSpecialFieldName(n);return o?void("d"==e.name?s.push(o):u.push(o)):(f=!1,!0)}),f&&(n=t.createFieldInfoFromRichText(e.getInnerHTML(a),s,u))}return n},u.parseFieldTrigger=function(e,t,r){return t=t||{},f.parseFieldTrigger(e,t,r),t.triggerJson},u});