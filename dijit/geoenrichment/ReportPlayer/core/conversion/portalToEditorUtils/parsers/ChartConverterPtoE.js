// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/utils/ColorUtil","esri/dijit/geoenrichment/utils/ImageUtil","esri/dijit/geoenrichment/utils/JsonXmlConverter","../../../charts/utils/ChartJsonUtil","../../ConversionUtil","esri/dijit/geoenrichment/ReportPlayer/core/charts/utils/ChartTypes","esri/dijit/geoenrichment/ReportPlayer/core/charts/legends/ChartLegendTypes","./_FieldInfoBuilder"],function(e,t,r,i,a,s,n,o,l){function u(e,t){return void 0===e?t:Number(e)||t}function g(e,t,r){return i.queryJson(e,"series").filter(function(e){return e.tags&&e.tags[0]&&"point"===e.tags[0].name}).map(function(r){return r.tags?(r.attributes=r.attributes||{},{label:r.attributes.Text||"",color:d(r.attributes.color),thickness:r.attributes.thickness,points:r.tags.map(function(r,s){r.attributes=r.attributes||{};var o=e.attributes.type===n.GAUGE&&1===s,u=r.tags&&r.tags[0],g=u&&u.attributes&&u.attributes.f,c=g&&l.getCalculatorOrScriptFieldInfo(g,t);if(c||o){var b=r.attributes.CaptionField,p=b&&l.getCalculatorOrScriptFieldInfo(b,t),h=i.queryJson(r,"pointIcon")[0],m=h&&t.parsers.getParser("field").parseField(h.tags[0],h,null,t);return a.createChartPoint(c,r.attributes.Text||"",d(r.attributes.color),m,p)}}).filter(function(e){return!!e})}):null}).filter(function(e){return e&&e.points&&!!e.points.length})}function c(t,r){var i={gridLines:t.gridlines,gridLinesCentered:t.gridlinesCentered,gridLinesOpacity:u(t.gridlinesOpacity,1),gridLinesColor:t.gridlinesColor,gridLinesThickness:Number(t.gridlinesThickness)||void 0,gridLinesStyle:t.gridlinesStyle,gridStripes:t.gridStripes,gridStripesColor:t.gridStripesColor,gridStripesColorAlt:t.gridStripesColorAlt};return r&&e.mixin(i,{baseLine:t.baseLine,baseLineColor:t.baseLineColor,baseLineOpacity:u(t.baseLineOpacity,1),baseLineThickness:Number(t.baseLineThickness)||void 0,baseLineStyle:t.baseLineStyle,baseLineValue:t.baseLineValue}),i}function b(e){var t=i.queryJson(e,"BackImage")[0];return t&&t.tags&&t.tags[0].text?r.base64DataToDataURL(t.tags[0].text):null}function p(e){return"string"!=typeof e?0:(e=e.replace("%",""),"0"===e?0:e.replace("0.","").length)}function d(e){return e&&"string"==typeof e&&(e=6===e.length&&-1===e.indexOf("#")?"#"+e:t.toCSSColor(e)),e}var h={};return h.portalToEditor=function(t,r,l){var u,h=i.queryJson(t,"comparisonInfo")[0];if(h){var m=h.attributes.name,y=l.templateJson.metadata.comparisonCalculatorsHash[m];y&&(u={calculatorName:m,chartType:h.attributes.chartType,color:h.attributes.color,lineThickness:Number(h.attributes.lineThickness)||void 0,lineStyle:h.attributes.lineStyle,lineMarker:h.attributes.lineMarker,levels:y.levels})}var S=g(t,l,u);if(!S.length)return null;var v=t.attributes,C=i.queryJson(t,"chartTitle")[0],L=i.queryJson(t,"legend")[0],P=i.queryJson(t,"xAxis")[0],f=i.queryJson(t,"yAxis")[0],x=i.queryJson(t,"chartIcon"),x=i.queryJson(t,"chartIcon"),T=i.queryJson(t,"floatingIcon"),k=i.queryJson(t,"floatingText"),I=i.queryJson(t,"trigger");C.attributes=C.attributes||{},L.attributes=L.attributes||{};var O=P&&P.attributes||{},A=f&&f.attributes||{},w=O,B=A;l.isGraphicReport&&l.revisionVersion<1.3&&(w=A,B=O),S.forEach(function(e){e.thickness=Number(e.thickness)});var N;n.isColumnBarLike(v.type)&&(N=S[0].thickness>1?"Large":S[0].thickness<1?"Small":"Medium");var j=P&&P.tags&&P.tags[0].attributes&&P.tags[0].attributes,F=f&&f.tags&&f.tags[0].attributes&&f.tags[0].attributes,J=b(t),M={isChart:!0,type:v._type||v.type,isMultiFeatureChart:!!v.isMultiFeatureChart,seriesItems:S,visualProperties:{width:s.ptToPx(v.width),height:s.ptToPx(v.height),backgroundColor:d(v.backColor),panelBackgroundColor:v.panelBackgroundColor,barBorders:v.barBorders,dataLabels:v.dataLabels,view3D:!!v.view3D,origin:Number(v.origin)||0,lineThickness:n.isLineLike(v.type)&&S[0].thickness||void 0,columnThickness:N,backgroundImageData:J,dataLabelsDecimals:p(v.CustomPercentFormat||v.CustomValueFormat),title:{text:C.attributes.text,align:C.attributes.align&&C.attributes.align.toLowerCase(),style:s.ptToPxObj(s.parseStyleString(C.attributes.style)),verticalShift:s.ptToPx(C.attributes.verticalShift||0)},xAxis:e.mixin({show:"None"!==O.placement,showTicks:O.ticks,style:s.ptToPxObj(s.parseStyleString(O.style)),title:j&&j.text,titleStyle:j&&s.ptToPxObj(s.parseStyleString(j.style)),placement:"OtherSide"===O.placement?"OtherSide":void 0,labelsAngle:Number(O.labelsAngle)||0,showLine:O.line,lineColor:O.lineColor,ticksInside:O.ticksInside},c(w,!1)),yAxis:e.mixin({show:"None"!==A.placement,showTicks:A.ticks,style:s.ptToPxObj(s.parseStyleString(A.style)),title:F&&F.text,titleStyle:F&&s.ptToPxObj(s.parseStyleString(F.style)),placement:"OtherSide"===A.placement?"OtherSide":void 0,labelsAngle:Number(A.labelsAngle)||0,showLine:A.line,lineColor:A.lineColor,ticksInside:A.ticksInside,showPercentIndicator:A.showPercentIndicator,showValuesAsWeightsInSeries:A.showValuesAsWeightsInSeries},c(B,!0)),legend:{type:L.attributes.type||o.SERIES},dataLabelsStyle:s.ptToPxObj(s.parseStyleString(v.dataLabelsStyle)),isStacked:v.isStacked,showColumnBarBackground:v.showColumnBarBackground,columnBarBackgroundColor:v.columnBarBackgroundColor,renderColumnBarsInOppositeDirections:v.renderColumnBarsInOppositeDirections,columnBarGap:v.columnBarGap?s.ptToPx(v.columnBarGap):void 0,fillLineArea:v.fillLineArea,lineAreaOpacity:v.lineAreaOpacity,donutHolePercent:Number(v.donutHolePercent)||void 0,donutGap:Number(v.donutGap)||void 0,donutArcPercent:Number(v.donutArcPercent)||void 0,gaugeHolePercent:Number(v.gaugeHolePercent)||void 0,gaugeRangeMin:Number(v.gaugeRangeMin)||void 0,gaugeRangeMax:Number(v.gaugeRangeMax)||void 0,gaugeGap:Number(v.gaugeGap)||void 0,gaugeStartAngle:Number(v.gaugeStartAngle)||void 0,gaugeArcPercent:Number(v.gaugeArcPercent)||void 0,gaugeLabelStyle:s.ptToPxObj(s.parseStyleString(v.gaugeLabelStyle))||void 0,gaugeLabelPlacement:v.gaugeLabelPlacement||void 0,gaugeShowArrow:v.gaugeShowArrow||void 0,gaugeArrowLineColor:v.gaugeArrowLineColor||void 0,gaugeArrowFillColor:v.gaugeArrowFillColor||void 0,gaugeConditionalStylingIgnoreOthers:v.gaugeConditionalStylingIgnoreOthers||void 0,gaugeConditionalStylingLabel:v.gaugeConditionalStylingLabel||void 0,gaugeShowFromToLabels:v.gaugeShowFromToLabels||void 0,gaugeFromLabelStyle:s.ptToPxObj(s.parseStyleString(v.gaugeFromLabelStyle))||void 0,gaugeToLabelStyle:s.ptToPxObj(s.parseStyleString(v.gaugeToLabelStyle))||void 0,ringBackgroundColor:v.ringBackgroundColor,showWholePictures:v.showWholePictures,dataLabelsInside:v.dataLabelsInside,dataLabelsStackedInColumns:v.dataLabelsStackedInColumns,dataLabelsHorizontalAlign:v.dataLabelsHorizontalAlign,showAxisIcons:v.showAxisIcons,showChartIcons:v.showChartIcons,sorting:v.sorting}};M.visualProperties.legend.type===o.MIN_MAX?e.mixin(M.visualProperties.legend,{minMax:{placement:L.attributes.placement,placementOffset:Number(L.attributes.placementOffset)||0,titleStyle:s.ptToPxObj(s.parseStyleString(L.attributes.titleStyle)),minVariableLabelStyle:s.ptToPxObj(s.parseStyleString(L.attributes.minVariableLabelStyle)),maxVariableLabelStyle:s.ptToPxObj(s.parseStyleString(L.attributes.maxVariableLabelStyle))}}):e.mixin(M.visualProperties.legend,{series:{placement:L.attributes.placement,placementOffset:Number(L.attributes.placementOffset)||0,hasBorder:L.attributes.hasBorder,labelParts:L.attributes.labelParts,style:s.ptToPxObj(s.parseStyleString(L.attributes.style))}}),l.revisionVersion<1.2&&(void 0!==M.visualProperties.donutGap&&(M.visualProperties.donutGap/=2*Math.PI),void 0!==M.visualProperties.gaugeGap&&(M.visualProperties.gaugeGap/=2*Math.PI)),x&&x.length&&(M.visualProperties.chartIcons=x.map(function(e){return e.tags&&e.tags[0]?l.parsers.getParser("field").parseField(e.tags[0],e,null,l):null})),T&&T.length&&(M.visualProperties.floatingIcons=T.map(function(e){return l.parsers.getParser("section").parseTable(e.tags[0],l)})),k&&k.length&&(M.visualProperties.floatingTexts=k.map(function(e){return l.parsers.getParser("section").parseTable(e.tags[0],l)})),I&&I.length&&(M.visualProperties.conditionalStyling=l.parsers.getParser("field").parseFieldTrigger(I[0])),M.comparisonInfo=u;var G={};return r.attributes&&r.attributes.style&&e.mixin(G,s.parseStyleString(r.attributes.style)),s.ptToPxObj(G),a.provideDefaultValueForMissing(M,{font:G}),a.cleanUpJson(M),M},h});