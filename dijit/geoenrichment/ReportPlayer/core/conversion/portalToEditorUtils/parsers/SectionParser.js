// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/utils/JsonXmlConverter","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/fieldInfo/RichTextJsonUtil","../../../supportClasses/DocumentOptions","../../ConversionUtil","../../../sections/SectionTypes","./ImageParser","./AlignParser"],function(t,e,a,r,i,n,s,o){function l(t,e,a,r,n){if(t.spannedWidths||t.spannedHeights)for(var s=t.spannedWidths?t.spannedWidths.split(";").map(function(t){return i.ptToPx(t)}):[i.ptToPx(t.width)],o=t.spannedHeights?t.spannedHeights.split(";").map(function(t){return i.ptToPx(t)}):[i.ptToPx(t.height)],l=0;l<s.length;l++)for(var u=0;u<o.length;u++){var g=a[n+l],f=e[r+u],p=f.style.fields[g.field]=f.style.fields[g.field]||{};p.width=s[l],p.height=o[u]}}var u={},g={getElement:function(t,e){var a=i.parseStyleString(t.attributes.style),r={id:"hr",style:{height:i.ptToPx(t.attributes.height),backgroundColor:a.backgroundColor}};return r}},f={getElement:function(t,s){function o(){t.tags&&(s.revisionVersion>=1.1?t.tags.forEach(function(t){if("tr"===t.name)return void P.push(t);switch(t.attributes.type){case n.TABLE_BACKGROUND:m=t;break;case n.TABLE_FOREGROUND:b=t;break;case n.TABLE_FLOATING_PANELS:T=t}}):t.tags.forEach(function(t){"tr"===t.name?P.push(t):"background"===t.name?m=t:"foreground"===t.name?b=t:"floatingElements"===t.name&&(T=t)}))}var g=s.templateJson,p=i.pxToPt(r.getPageBox(g.documentOptions).contentW);if(t.attributes.widths&&Number(t.attributes.width)>p){var d=i.splitTrim(t.attributes.widths,";",!0),c=Number(t.attributes.width)-p,h=Number(d[d.length-1]);h>c&&(h-=c,d[d.length-1]=h,t.attributes.widths=d.join(";"),t.attributes.width=p)}var m,b,T,v=0,y=t.attributes.widths?i.splitTrim(t.attributes.widths,";",!0).map(function(t){return{field:"field"+v++,style:{width:i.ptToPx(t)}}}):[],x=Number(t.attributes.fixedColumns)||0,S=Number(t.attributes.dynamicColumns)||0,w={},P=[];o();var E=P&&P.map(function(){return{style:{fields:{}},fieldInfos:{}}});P&&P.forEach(function(t,r){var n=E[r];t.attributes&&t.attributes.height&&(n.style.height=i.ptToPx(t.attributes.height));var o=0;if(S&&t.tags&&t.tags.length>x){var g=t.tags.slice(0,x),f=t.tags.slice(x,x+S),p=Math.round((y.length-g.length)/f.length);t.tags=g;for(var d=0;p>d;d++)t.tags=t.tags.concat(f)}t.tags&&t.tags.forEach(function(t){function i(t){var e=t.tags&&1===t.tags.length&&t.tags[0];return e&&e.tags?("b"===e.name?c.fontWeight="bold":"i"===e.name?c.fontStyle="italic":"u"===e.name&&(c.textDecoration="underline"),"b"===e.name||"i"===e.name||"u"===e.name?i(e)||{tag:e.tags[0],parentTag:e}:null):null}function g(t){var e,a,r;if(t.tags&&t.tags.length)if(r=t.tags.filter(function(t){return"br"!==t.name}),a=r[0],a&&"trigger"===a.name&&r[1]&&"d"===r[1].name)e=a,a=r[1];else{var n=i(t);a=n&&n.tag||r[0],t=n&&n.parentTag||t}return{firstTag:a,triggerTag:e,parentTag:t,hasMultipleTags:r&&r.length>1}}function f(t){e.isRichText(t)?n.fieldInfos[p]=a.createFieldInfoFromRichText(t):n[p]=e.unrichHTML(t)}if(s.revisionVersion>=1)for(;w[o+"_"+r];)o++;if(y[o]){var p=y[o].field,d=t.attributes||{},c=n.style.fields[p]={};u.parseTableCellAttributes(d,c,s),d.width&&l(d,E,y,r,o);var h=Number(d.colspan),m=Number(d.rowspan);if(h&&(n.columnSpans=n.columnSpans||{},n.columnSpans[p]=h),m&&(n.rowSpans=n.rowSpans||{},n.rowSpans[p]=m),h>1||m>1)for(var b=h||1,T=m||1,v=o;o+b>v;v++)for(var x=r;r+T>x;x++)(v!==o||x!==r)&&(w[v+"_"+x]=!0);var S,P=g(t),k=P.firstTag,A=P.parentTag,N=P.triggerTag,R=P.hasMultipleTags;if(R&&!N){var C=s.parsers.getParser("field").parseRichTextTag(A,s);C&&(n.fieldInfos[p]=C,S=!0)}if(k&&!S){var _=s.parsers.getParser("field").parseField(k,A,N,s);if("number"==typeof _)n[p]=_+"",S=!0;else if(_)n.fieldInfos[p]=_,S=!0;else if("chart"===k.name)S=!0;else if("img"===k.name)S=!0;else if("text"===k.name)n[p]=k.attributes.name,S=!0;else if("a"===k.name&&k.tags&&"#text"===k.tags[0].name){var B=k.attributes.href;B&&(n.urls=n.urls||{},n.urls[p]=B,n[p]=k.tags[0].text,S=!0)}else"#text"!==k.name||R||(f(k.text),S=!0)}for(S||f(e.getInnerHTML(A)),o++;w[o+"_"+r];)o++}})});var k={id:"table",backgroundSectionJson:m&&f._parseTableBackgroundForeground(m,s),foregroundSectionJson:b&&f._parseTableBackgroundForeground(b,s),floatingTablesSectionJson:T&&f._parseFloatingPanels(T,s),data:{columns:y,data:E||[]},style:{width:i.ptToPx(t.attributes.width),left:i.ptToPx(t.attributes.left),spaceBefore:i.ptToPx(t.attributes.spaceBefore),spaceAfter:i.ptToPx(t.attributes.spaceAfter)},attributes:{}};return x&&(k.attributes.fixedColumns=x),S&&(k.attributes.dynamicColumns=S),t.attributes.fixedRows&&(k.attributes.fixedRows=Number(t.attributes.fixedRows)||0),t.attributes.dynamicRows&&(k.attributes.dynamicRows=Number(t.attributes.dynamicRows)||0),k},_parseTableBackgroundForeground:function(t,e){return t.attributes=t.attributes||{},t.attributes.type=n.DETAILS,u.parseSection(t,e)},_parseFloatingPanels:function(t,e){return t.attributes=t.attributes||{},t.attributes.type=n.DETAILS,u.parseSection(t,e)}};return u.parseTableCellAttributes=function(e,a,r){var n=r.tableDefaultStyles;if(a=a||{},e.overrideStyle&&(a.overrideStyle=e.overrideStyle),e.pad&&(a.horizontalPadding=i.ptToPx(e.pad)),e.angle&&(a.angle=Number(e.angle)||0),o.parseAlign(e,a),e.width&&(a.width=i.ptToPx(e.width)),e.height&&(a.height=i.ptToPx(e.height)),t.mixin(a,i.ptToPxObj(i.parseStyleString(e.style))),a.overrideStyle&&n){var s=n.getStyle(a.overrideStyle);for(var l in s)delete a[l]}return a},u.parseSection=function(t,e){var a=(e.templateJson,e.tableDefaultStyles,{type:t.attributes.type,stack:[]});return a.type||console.log(new Error("Section type is not supported!")),t.tags&&t.tags.forEach(function(t){t.attributes=t.attributes||{},"img"===t.name||"mapImage"===t.name?a.stack.push(s.getElement(t,e)):"hr"===t.name?a.stack.push(g.getElement(t,e)):"pageBreak"===t.name?a.stack.push({id:"pageBreak"}):"table"===t.name&&a.stack.push(f.getElement(t,e))}),a},u.parseTable=function(t,e){return f.getElement(t,e)},u});