// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/utils/JsonXmlConverter","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/RichTextJsonUtil","../../../supportClasses/DocumentOptions","../../ConversionUtil"],function(t,e,a,i,r){function s(t,e,a,i,s){if(t.spannedWidths||t.spannedHeights)for(var n=t.spannedWidths?t.spannedWidths.split(";").map(function(t){return r.ptToPx(t)}):[r.ptToPx(t.width)],l=t.spannedHeights?t.spannedHeights.split(";").map(function(t){return r.ptToPx(t)}):[r.ptToPx(t.height)],o=0;o<n.length;o++)for(var u=0;u<l.length;u++){var g=a[s+o],p=e[i+u],d=p.style.fields[g.field]=p.style.fields[g.field]||{};d.width=n[o],d.height=l[u]}}var n={},l={getElement:function(t,e){var a=e.templateJson.metadata.mapImageInfosHash[t.attributes.name],i="mapImage"==t.name,s=i?null:e.processFileName(t.attributes.src),n={id:"img",fileName:s,isMapImage:i,circularMask:t.attributes.circularMask,webMapId:a?a.webMapId:t.attributes.webMapId,defaultBasemapId:a?a.defaultBasemapId:t.attributes.defaultBasemapId,mapScale:a?a.mapScale:null,style:{top:r.ptToPx(t.attributes.top),left:r.ptToPx(t.attributes.left),width:r.ptToPx(t.attributes.width),height:r.ptToPx(t.attributes.height),angle:Number(t.attributes.angle)||0,opacity:Math.min(1,Number(0===t.attributes.opacity?0:t.attributes.opacity||1))},isLogoPlaceholder:t.attributes.isLogoPlaceholder,dynamicBehavior:t.attributes.dynamicBehavior};return e.revisionVersion<1&&(n.style.angle=r.ptToPx(n.style.angle),n.style.opacity=Math.min(1,r.ptToPx(n.style.opacity))),s&&e.putImageData(s,t.attributes.data),n}},o={getElement:function(t,e){var a=r.parseStyleString(t.attributes.style),i={id:"hr",style:{height:r.ptToPx(t.attributes.height),backgroundColor:a.backgroundColor}};return i}},u={getElement:function(t,l){var o=l.templateJson,u=r.pxToPt(i.getPageBox(o.documentOptions).contentW);if(t.attributes.widths&&Number(t.attributes.width)>u){var g=r.splitTrim(t.attributes.widths,";",!0),p=Number(t.attributes.width)-u,d=Number(g[g.length-1]);d>p&&(d-=p,g[g.length-1]=d,t.attributes.widths=g.join(";"),t.attributes.width=u)}var f=0,m=t.attributes.widths?r.splitTrim(t.attributes.widths,";",!0).map(function(t){return{field:"field"+f++,style:{width:r.ptToPx(t)}}}):[],h=Number(t.attributes.fixedColumns)||0,b=Number(t.attributes.dynamicColumns)||0,c={},y=t.tags&&t.tags.map(function(){return{style:{fields:{}},fieldInfos:{}}});t.tags&&t.tags.forEach(function(t,i){var o=y[i];t.attributes&&t.attributes.height&&(o.style.height=r.ptToPx(t.attributes.height));var u=0;if(b&&t.tags&&t.tags.length>h){var g=t.tags.slice(0,h),p=t.tags.slice(h,h+b),d=Math.round((m.length-g.length)/p.length);t.tags=g;for(var f=0;d>f;f++)t.tags=t.tags.concat(p)}t.tags&&t.tags.forEach(function(t){function r(t){var e=t.tags&&1==t.tags.length&&t.tags[0];return e&&e.tags?("b"==e.name?h.fontWeight="bold":"i"==e.name?h.fontStyle="italic":"u"==e.name&&(h.textDecoration="underline"),"b"==e.name||"i"==e.name||"u"==e.name?r(e)||{tag:e.tags[0],parentTag:e}:null):null}function g(t){var e,a,i;if(t.tags&&t.tags.length)if(i=t.tags.filter(function(t){return"br"!=t.name}),a=i[0],a&&"trigger"==a.name&&i[1]&&"d"==i[1].name)e=a,a=i[1];else{var s=r(t);a=s&&s.tag||i[0],t=s&&s.parentTag||t}return{firstTag:a,trigerTag:e,parentTag:t,hasMultipleTags:i&&i.length>1}}function p(t){e.isRichText(t)?o.fieldInfos[d]=a.createFieldInfoFromRichText(t):o[d]=e.unrichHTML(t)}if(l.revisionVersion>=1)for(;c[u+"_"+i];)u++;if(m[u]){var d=m[u].field,f=t.attributes||{},h=o.style.fields[d]={};n.parseTableCellAttributes(f,h,l),f.width&&s(f,y,m,i,u);var b=Number(f.colspan),v=Number(f.rowspan);if(b&&(o.columnSpans=o.columnSpans||{},o.columnSpans[d]=b),v&&(o.rowSpans=o.rowSpans||{},o.rowSpans[d]=v),b>1||v>1)for(var T=b||1,x=v||1,w=u;u+T>w;w++)for(var P=i;i+x>P;P++)(w!=u||P!=i)&&(c[w+"_"+P]=!0);var S,I=g(t),M=I.firstTag,N=I.parentTag,C=I.trigerTag,E=I.hasMultipleTags;if(E&&!C){var k=l.parsers.getParser("field").parseRichTextTag(N,l);k&&(o.fieldInfos[d]=k,S=!0)}if(M&&!S){var R=l.parsers.getParser("field").parseField(M,N,C,l);if("number"==typeof R)o[d]=R+"",S=!0;else if(R)o.fieldInfos[d]=R,S=!0;else if("chart"==M.name)S=!0;else if("img"==M.name)S=!0;else if("text"==M.name)o[d]=M.attributes.name,S=!0;else if("a"==M.name&&M.tags&&"#text"==M.tags[0].name){var B=M.attributes.href;B&&(o.urls=o.urls||{},o.urls[d]=B,o[d]=M.tags[0].text,S=!0)}else"#text"!=M.name||E||(p(M.text),S=!0)}for(S||p(e.getInnerHTML(N)),u++;c[u+"_"+i];)u++}})});var v={id:"table",data:{columns:m,data:y||[]},style:{width:r.ptToPx(t.attributes.width),top:r.ptToPx(t.attributes.top),left:r.ptToPx(t.attributes.left),spaceBefore:r.ptToPx(t.attributes.spaceBefore),spaceAfter:r.ptToPx(t.attributes.spaceAfter)},attributes:{}};return h&&(v.attributes.fixedColumns=h),b&&(v.attributes.dynamicColumns=b),t.attributes.fixedRows&&(v.attributes.fixedRows=Number(t.attributes.fixedRows)||0),t.attributes.dynamicRows&&(v.attributes.dynamicRows=Number(t.attributes.dynamicRows)||0),v}};return n.parseTableCellAttributes=function(e,a,i){var s=i.tableDefaultStyles;if(a=a||{},e.overrideStyle&&(a.overrideStyle=e.overrideStyle),e.align&&(a.horizontalAlign=e.align),e.valign&&(a.verticalAlign=r.getPropValuePtoE("valign",e.valign)),e.pad&&(a.horizontalPadding=e.pad),e.width&&(a.width=e.width),e.height&&(a.height=e.height),t.mixin(a,r.parseStyleString(e.style)),r.ptToPxObj(a),a.overrideStyle&&s){var n=s.getStyle(a.overrideStyle);for(var l in n)delete a[l]}return a},n.parseSection=function(t,e){var a=(e.templateJson,e.tableDefaultStyles,{type:t.attributes.type,stack:[]});return a.type||(console.log(new Error("Section type is not supported!")),a.type=t.attributes.type),t.tags&&t.tags.forEach(function(t){t.attributes=t.attributes||{},"img"==t.name||"mapImage"==t.name?a.stack.push(l.getElement(t,e)):"hr"==t.name?a.stack.push(o.getElement(t,e)):"pageBreak"==t.name?a.stack.push({id:"pageBreak"}):"table"==t.name&&a.stack.push(u.getElement(t,e))}),a},n.parseTable=function(t,e){return u.getElement(t,e)},n});