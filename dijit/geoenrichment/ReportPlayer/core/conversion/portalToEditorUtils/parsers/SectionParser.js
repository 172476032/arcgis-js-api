// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/lang","esri/dijit/geoenrichment/utils/JsonXmlConverter","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/fieldInfo/RichTextJsonUtil","../../../supportClasses/DocumentOptions","../../ConversionUtil","../../../sections/SectionTypes","./ImageParser","./AlignParser"],function(t,e,a,r,i,n,s,o){function l(t,e,a,r,n){if(t.spannedWidths||t.spannedHeights)for(var s=t.spannedWidths?t.spannedWidths.split(";").map(function(t){return i.ptToPx(t)}):[i.ptToPx(t.width)],o=t.spannedHeights?t.spannedHeights.split(";").map(function(t){return i.ptToPx(t)}):[i.ptToPx(t.height)],l=0;l<s.length;l++)for(var u=0;u<o.length;u++){var g=a[n+l],f=e[r+u],p=f.style.fields[g.field]=f.style.fields[g.field]||{};p.width=s[l],p.height=o[u]}}var u={},g={getElement:function(t,e){var a=i.parseStyleString(t.attributes.style);return{id:"hr",style:{height:i.ptToPx(t.attributes.height),backgroundColor:a.backgroundColor}}}},f={getElement:function(t,s){var o=s.templateJson,g=i.pxToPt(r.getPageBox(o.documentOptions).contentW);if(t.attributes.widths&&Number(t.attributes.width)>g){var p=i.splitTrim(t.attributes.widths,";",!0),d=Number(t.attributes.width)-g,c=Number(p[p.length-1]);c>d&&(c-=d,p[p.length-1]=c,t.attributes.widths=p.join(";"),t.attributes.width=g)}var h,b,m,T=0,v=t.attributes.widths?i.splitTrim(t.attributes.widths,";",!0).map(function(t){return{field:"field"+T++,style:{width:i.ptToPx(t)}}}):[],y=Number(t.attributes.fixedColumns)||0,S=Number(t.attributes.dynamicColumns)||0,x={},w=[];!function(){t.tags&&(s.revisionVersion>=1.1?t.tags.forEach(function(t){if("tr"===t.name)return void w.push(t);switch(t.attributes.type){case n.TABLE_BACKGROUND:h=t;break;case n.TABLE_FOREGROUND:b=t;break;case n.TABLE_FLOATING_PANELS:m=t}}):t.tags.forEach(function(t){"tr"===t.name?w.push(t):"background"===t.name?h=t:"foreground"===t.name?b=t:"floatingElements"===t.name&&(m=t)}))}();var P=w&&w.map(function(){return{style:{fields:{}},fieldInfos:{}}});w&&w.forEach(function(t,r){var n=P[r];t.attributes&&t.attributes.height&&(n.style.height=i.ptToPx(t.attributes.height));var o=0;if(S&&t.tags&&t.tags.length>y){var g=t.tags.slice(0,y),f=t.tags.slice(y,y+S),p=Math.round((v.length-g.length)/f.length);t.tags=g;for(var d=0;d<p;d++)t.tags=t.tags.concat(f)}t.tags&&t.tags.forEach(function(t){function i(t){var e=t.tags&&1===t.tags.length&&t.tags[0];return e&&e.tags?("b"===e.name?d.fontWeight="bold":"i"===e.name?d.fontStyle="italic":"u"===e.name&&(d.textDecoration="underline"),"b"===e.name||"i"===e.name||"u"===e.name?i(e)||{tag:e.tags[0],parentTag:e}:null):null}function g(t){e.isRichText(t)?n.fieldInfos[f]=a.createFieldInfoFromRichText(t):n[f]=e.unrichHTML(t)}if(s.revisionVersion>=1)for(;x[o+"_"+r];)o++;if(v[o]){var f=v[o].field,p=t.attributes||{},d=n.style.fields[f]={};u.parseTableCellAttributes(p,d,s),p.width&&l(p,P,v,r,o);var c=Number(p.colspan),h=Number(p.rowspan);if(c&&(n.columnSpans=n.columnSpans||{},n.columnSpans[f]=c),h&&(n.rowSpans=n.rowSpans||{},n.rowSpans[f]=h),c>1||h>1)for(var b=c||1,m=h||1,T=o;T<o+b;T++)for(var y=r;y<r+m;y++)T===o&&y===r||(x[T+"_"+y]=!0);var S,w=function(t){var e,a,r;if(t.tags&&t.tags.length)if(r=t.tags.filter(function(t){return"br"!==t.name}),(a=r[0])&&"trigger"===a.name&&r[1]&&"d"===r[1].name)e=a,a=r[1];else{var n=i(t);a=n&&n.tag||r[0],t=n&&n.parentTag||t}return{firstTag:a,triggerTag:e,parentTag:t,hasMultipleTags:r&&r.length>1}}(t),E=w.firstTag,k=w.parentTag,A=w.triggerTag,I=w.hasMultipleTags;if(I&&!A){var N=s.parsers.getParser("field").parseRichTextTag(k,s);N&&(n.fieldInfos[f]=N,S=!0)}if(E&&!S){var R=s.parsers.getParser("field").parseField(E,k,A,s);if("number"==typeof R)n[f]=R+"",S=!0;else if(R)n.fieldInfos[f]=R,S=!0;else if("chart"===E.name)S=!0;else if("img"===E.name)S=!0;else if("text"===E.name)n[f]=E.attributes.name,S=!0;else if("a"===E.name&&E.tags&&"#text"===E.tags[0].name){var C=E.attributes.href;C&&(n.urls=n.urls||{},n.urls[f]=C,n[f]=E.tags[0].text,S=!0)}else"#text"!==E.name||I||(g(E.text),S=!0)}for(S||g(e.getInnerHTML(k)),o++;x[o+"_"+r];)o++}})});var E={id:"table",backgroundSectionJson:h&&f._parseTableBackgroundForeground(h,s),foregroundSectionJson:b&&f._parseTableBackgroundForeground(b,s),floatingTablesSectionJson:m&&f._parseFloatingPanels(m,s),data:{columns:v,data:P||[]},style:{width:i.ptToPx(t.attributes.width),left:i.ptToPx(t.attributes.left),spaceBefore:i.ptToPx(t.attributes.spaceBefore),spaceAfter:i.ptToPx(t.attributes.spaceAfter),alternatingStyle:t.attributes.alternatingStyle},attributes:{}};return y&&(E.attributes.fixedColumns=y),S&&(E.attributes.dynamicColumns=S),t.attributes.fixedRows&&(E.attributes.fixedRows=Number(t.attributes.fixedRows)||0),t.attributes.dynamicRows&&(E.attributes.dynamicRows=Number(t.attributes.dynamicRows)||0),E},_parseTableBackgroundForeground:function(t,e){return t.attributes=t.attributes||{},t.attributes.type=n.DETAILS,u.parseSection(t,e)},_parseFloatingPanels:function(t,e){return t.attributes=t.attributes||{},t.attributes.type=n.DETAILS,u.parseSection(t,e)}};return u.parseTableCellAttributes=function(e,a,r){var n=r.tableDefaultStyles;if(a=a||{},e.overrideStyle&&(a.overrideStyle=e.overrideStyle),e.pad&&(a.horizontalPadding=i.ptToPx(e.pad)),e.angle&&(a.angle=Number(e.angle)||0),o.parseAlign(e,a),e.width&&(a.width=i.ptToPx(e.width)),e.height&&(a.height=i.ptToPx(e.height)),t.mixin(a,i.ptToPxObj(i.parseStyleString(e.style))),a.overrideStyle&&n){var s=n.getStyle(a.overrideStyle);for(var l in s)delete a[l]}return a},u.parseSection=function(t,e){var a=(e.templateJson,e.tableDefaultStyles,{type:t.attributes.type,stack:[]});return a.type||console.log(new Error("Section type is not supported!")),t.tags&&t.tags.forEach(function(r){if(r.attributes=r.attributes||{},"img"===r.name||"mapImage"===r.name)a.stack.push(s.getElement(r,e));else if("hr"===r.name)a.stack.push(g.getElement(r,e));else if("pageBreak"===r.name)a.stack.push({id:"pageBreak"});else if("table"===r.name){var i=f.getElement(r,e);e.postProcessTableInSection&&e.postProcessTableInSection(t,i),a.stack.push(i)}}),a},u.parseTable=function(t,e){return f.getElement(t,e)},u});