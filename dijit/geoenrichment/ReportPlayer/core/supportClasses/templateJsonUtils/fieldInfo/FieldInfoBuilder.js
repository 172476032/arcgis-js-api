// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["./utils","dojo/i18n!esri/nls/jsapi"],function(e,t){function a(e){Object.keys(e).forEach(function(t){var a=e[t];void 0!==a&&null!==a||delete e[t]})}t=t.geoenrichment.dijit.ReportPlayer.ReportPlayer;var i={};i.NUMBER="n/",i.createFieldInfoFromCalculator=function(t,i,r){if(!t)return null;var n="function"==typeof t.getDescriptionWithType?t:null,l=n?n.variable:t,o=r&&r.format,s=r&&r.autoformatCurrency,u=r&&r.additionalText,c=r&&r.calculatorName,m=r&&r.defaultDistanceUnits,d={comparisonIndex:r&&r.comparisonIndex};d.alias=n?n.getDescriptionWithType()||n.getAliasWithType():l.description||l.alias,d.hasVariable=!0,d.variableID=l.id,d.fullName=l.fullName,d.fieldCategory=l.fieldCategory,d.vintage=l.vintage,d.type=l.type;var f=n&&n.getToggleGroup&&n.getToggleGroup();d.statefulName=f?f.value:"n/"+l.fullName;var p=n?n.getCalcType().charAt(0):"n";return d.name=e.name.createFieldNameFromVariable(l,p),o?e.format.setFieldInfoFormat(d,o):(d.decimals=l.precision,d.showCurrency=!(!s||"n"!==p||!l.units||"CURRENCY"!==l.units.toUpperCase()),d.showPercent=!d.showCurrency&&("p"===p||"n"===p&&l.units&&"PCT"===l.units.toUpperCase()),d.useThousandsSeparator=!0),"string"==typeof u&&(d.additionalText=u),l.isWebMap?(d.isWebMap=!0,d.webMapFieldName=l.fieldName,d.webMapField=l.field,d.webMapId=l.webMapId,!o&&l.field&&l.field.format&&(d.decimals=l.field.format.places,d.useThousandsSeparator=!1!==l.field.format.digitSeparator)):l.customDataCollection?(d.isCustomDataCollection=!0,d.customDataCollectionId=l.customDataCollection.id,d.customDataCollectionUrl=l.customDataCollection.url,d.customDataCollectionPortalUrl=l.customDataCollection.portalUrl):l.isSiteAttribute?(d.isSiteAttribute=!0,d.attribute=l.attribute,!o&&l.attribute.places>0&&(d.decimals=l.attribute.places)):l.isDataLayerAttribute&&(d.isDataLayerAttribute=!0,d.layerID=l.layerID,d.layerUrl=l.layerUrl,d.layerName=l.layerName,d.attribute=l.attribute,d.type=l.attribute.type,!o&&l.attribute.decimals>0&&(d.decimals=l.attribute.decimals),"DISTANCE"===l.attribute.name&&(d.units=l.attribute.units||m||"esriMiles")),d.usedFields=l.usedFields,d.expressionText=l.expressionText,e.name.provideQualifiedFieldInfoTemplateName(d,c),a(d),d},i.createFieldInfoFromScript=function(i,r,n){var l=n&&n.format,o=n&&n.additionalText,s=n&&n.calculatorName;i=i||{},i.name=i.name||e.name.DEFAULT_SCRIPT_NAME,i.alias=i.alias||t.scriptNameDefault,i.decimals=Number(i.decimals)||0;var u={comparisonIndex:n&&n.comparisonIndex};return u.name=e.name.createFieldNameFromScript(i),e.name.provideQualifiedFieldInfoTemplateName(u,s),u.script=i,l?e.format.setFieldInfoFormat(u,l):(u.decimals=Number(i.decimals),u.showCurrency=!1,u.showPercent=!1,u.useThousandsSeparator=!0),"string"==typeof o&&(u.additionalText=o),a(u),u},i.createFieldInfoFromChart=function(e){return{isChart:!0,chartJson:e}},i.createFieldInfoFromImage=function(e,t){return{isImage:!0,imageJson:e,triggerJson:t}},i.createFieldInfoFromShape=function(e){return{isShape:!0,shapeJson:e}},i.createFieldInfoFromSection=function(e){return{isReportSection:!0,sectionJson:e}},i.createFieldInfoFromInfographic=function(e){return{isInfographic:!0,infographicJson:e}},i.createFieldInfoFromMissingVariable=function(e,t){return{name:e&&e.substr(e.indexOf(".")+1),templateName:e,isMissing:!0,alias:t}};var r=/^\[\w+\]$/,n=/\[\w+\]/;i.createFieldInfoFromLabel=function(t,a){if("string"!=typeof t)return null;t=t.trim();var l=r.test(t);if(!a||l)return l?(t=t.replace(/\[|\]/g,"").toUpperCase(),i.createFieldInfoFromSpecialFieldName(e.fields.uiToTemplate(t))):null;if(!n.test(t))return null;var o=e.richText.collectFieldInfosFromRenderedXMLString(t);return o&&e.richText.createFieldInfoFromRichText(o.xmlString,o.fieldInfos,o.specialFieldInfos)},i.createFieldInfoFromSpecialFieldName=function(t,a){if("string"!=typeof t)return null;var i,t=t.substr(t.indexOf(".")+1),r=t.toUpperCase();if(function(){"CURRDATE"===r?i={name:e.fields.DATE_FIELD_NAME,alias:e.fields.DATE_FIELD_ALIAS,format:a||e.fields.DATE_FIELD_DEFAULT_FORMAT}:"SITENOTE"===r?i={name:e.fields.SITENOTE_FIELD_NAME,alias:e.fields.SITENOTE_FIELD_ALIAS}:"SITENOTES"===r&&(i={name:e.fields.SITENOTES_FIELD_NAME,alias:e.fields.SITENOTES_FIELD_ALIAS})}(),i)return i;var n=e.fields.templateToUIHeader(r);if(n)i={name:e.fields.qualifyTemplateHeaderName(r),alias:n};else{var l=e.fields.templateToUIReportVar(r);l&&(i={name:l,alias:l})}return i};var l=/_P$/i;return i.isFieldInfoInPercentState=function(e){return e&&e.statefulName&&("p"===e.statefulName.charAt(0)||l.test(e.statefulName))},i});