// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["./utils","dojo/i18n!../../../../../../../nls/jsapi"],function(e,t){t=t.geoenrichment.dijit.ReportPlayer.ReportPlayer;var a={};a.NUMBER="n/",a.createFieldInfoFromCalculator=function(t,a,i,r){if(!t)return null;var l=i&&i.format,n=i&&i.autoformatCurrency,o=i&&i.additionalText,s={};s.alias=t.getDescriptionWithType()||t.getAliasWithType();var u=t.variable;s.hasVariable=!0,s.variableID=u.id,s.fullName=u.fullName,s.fieldCategory=u.fieldCategory,s.vintage=u.vintage,s.type=u.type;var m=t.getToggleGroup&&t.getToggleGroup();s.statefulName=m?m.value:"n/"+u.fullName;var d=t.getCalcType().charAt(0);return s.name=e.name.createFieldNameFromVariable(u,d),l?e.format.setFieldInfoFormat(s,l):(s.decimals=t.getDecimals(),s.showCurrency=!(!n||"n"!==d||!u.units||"CURRENCY"!==u.units.toUpperCase()),s.showPercent=!s.showCurrency&&("p"===d||"n"===d&&u.units&&"PCT"===u.units.toUpperCase()),s.useThousandsSeparator=!0),"string"==typeof o&&(s.additionalText=o),u.isWebMap?(s.isWebMap=!0,s.webMapFieldName=u.fieldName,s.webMapField=u.field,s.webMapId=u.webMapId,!l&&u.field&&u.field.format&&(s.decimals=u.field.format.places,s.useThousandsSeparator=!1!==u.field.format.digitSeparator)):u.customDataCollection?(s.isCustomDataCollection=!0,s.customDataCollectionId=u.customDataCollection.id,s.customDataCollectionUrl=u.customDataCollection.url,s.customDataCollectionPortalUrl=u.customDataCollection.portalUrl):u.isSiteAttribute?(s.isSiteAttribute=!0,s.attribute=u.attribute,u.attribute.places>0&&(s.decimals=u.attribute.places)):u.isDataLayerAttribute&&(s.isDataLayerAttribute=!0,s.layerID=u.layerID,s.attribute=u.attribute,s.type=u.attribute.type,u.attribute.decimals>0&&(s.decimals=u.attribute.decimals),"DISTANCE"===u.attribute.name&&(s.units=u.attribute.units||"esriMiles")),u.usedFields&&(s.usedFields=u.usedFields),e.name.provideQualifiedFieldInfoTemplateName(s,r),s},a.createFieldInfoFromScript=function(a,i,r,l){var n=r&&r.format,o=r&&r.additionalText;a=a||{},a.name=a.name||e.name.DEFAULT_SCRIPT_NAME,a.alias=a.alias||t.scriptNameDefault,a.decimals=Number(a.decimals)||0;var s={};return s.name=e.name.createFieldNameFromScript(a),e.name.provideQualifiedFieldInfoTemplateName(s,l),s.script=a,n?e.format.setFieldInfoFormat(s,n):(s.decimals=Number(a.decimals),s.showCurrency=!1,s.showPercent=!1,s.useThousandsSeparator=!0),"string"==typeof o&&(s.additionalText=o),s},a.createFieldInfoFromChart=function(e){return{isChart:!0,chartJson:e}},a.createFieldInfoFromImage=function(e,t){return{isImage:!0,imageJson:e,triggerJson:t}},a.createFieldInfoFromShape=function(e){return{isShape:!0,shapeJson:e}},a.createFieldInfoFromSection=function(e){return{isReportSection:!0,sectionJson:e}},a.createFieldInfoFromInfographic=function(e){return{isInfographic:!0,infographicJson:e}},a.createFieldInfoFromMissingVariable=function(e){return{isMissing:!0,variable:e,alias:e.alias}};var i=/^\[\w+\]$/,r=/\[\w+\]/;a.createFieldInfoFromLabel=function(t,l){if("string"!=typeof t)return null;t=t.trim();var n=i.test(t);if(!l||n)return n?(t=t.replace(/\[|\]/g,"").toUpperCase(),a.createFieldInfoFromSpecialFieldName(e.fields.uiToTemplate(t))):null;if(!r.test(t))return null;var o=e.richText.collectFieldInfosFromRenderedXMLString(t);return o&&e.richText.createFieldInfoFromRichText(o.xmlString,o.fieldInfos,o.specialFieldInfos)},a.createFieldInfoFromSpecialFieldName=function(t,a){if("string"!=typeof t)return null;var i,t=t.substr(t.indexOf(".")+1),r=t.toUpperCase();if(function(){"CURRDATE"===r?i={name:e.fields.DATE_FIELD_NAME,alias:e.fields.DATE_FIELD_ALIAS,format:a||e.fields.DATE_FIELD_DEFAULT_FORMAT}:"SITENOTE"===r?i={name:e.fields.SITENOTE_FIELD_NAME,alias:e.fields.SITENOTE_FIELD_ALIAS}:"SITENOTES"===r&&(i={name:e.fields.SITENOTES_FIELD_NAME,alias:e.fields.SITENOTES_FIELD_ALIAS})}(),i)return i;var l=e.fields.templateToUIHeader(r);if(l)i={name:e.fields.qualifyTemplateHeaderName(r),alias:l};else{var n=e.fields.templateToUIReportVar(r);n&&(i={name:n,alias:n})}return i};var l=/_P$/i;return a.isFieldInfoInPercentState=function(e){return e&&e.statefulName&&("p"===e.statefulName.charAt(0)||l.test(e.statefulName))},a});