// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.25/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/Deferred","dojo/_base/Deferred","dojo/when","esri/kernel","esri/IdentityManager","esri/arcgis/utils","esri/geometry/Extent","esri/request","esri/dijit/geoenrichment/utils/UrlUtil"],function(e,t,i,r,n,a,o,u,l,s){var c={};s.isPageRunOnWebService()||(n.id.getCredential=function(){var e=new i;return e.reject(new Error("Can't get credentials")),e});var d="http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer",f={_itemsCache:{},_siCache:{},loadItem:function(t){return this._itemsCache[t]||(this._itemsCache[t]=o.getItem(t)),r(this._itemsCache[t],function(t){return t&&e.clone(t)})},loadServiceInfo:function(e,t){return this._siCache[e]||(this._siCache[e]=t({url:e,content:{f:"json"}})),this._siCache[e]}};return c.getItem=function(e){return f.loadItem(e)},c.isWebMapType=function(e){return e&&"Web Map"===e.type},c.createMap=function(e,t,i){if(i=i||{},e&&e.item)return c.isWebMapType(e.item)&&i.additionalLayerInfos&&c._addAdditionalLayerInfosToOperationalLayers(e.itemData.operationalLayers,i.additionalLayerInfos),r(!c.isWebMapType(e.item)&&c.createItemDataForNonWebMapItem(e,{defaultBasemapId:i.defaultBasemapId,additionalLayerInfos:i.additionalLayerInfos}),function(){return o.createMap(e,t,{usePopupManager:!0,mapOptions:{extent:i.extent,sliderPosition:i.sliderPosition,infoWindow:i.infoWindow}})})},c.createItemDataForNonWebMapItem=function(t,i){function n(){o.url=function(e){return["FeatureServer","MapServer","ImageServer"].some(function(t){if(-1!==e.indexOf(t))return e=e.substr(0,e.lastIndexOf(t)+t.length),!0}),e}(o.url);var e=i.requestFunc||l;return s.registerCORS(o.url),f.loadServiceInfo(o.url,e).then(function(e){return r(function(e,t){if(!e.extent){var i=t.initialExtent||t.fullExtent||t.extent;!i||i instanceof u||(i=new u(i)),e.extent=i}}(o,e),function(){return e})})}function a(e){return t.itemData={baseMap:null,operationalLayers:e},i.additionalLayerInfos&&c._addAdditionalLayerInfosToOperationalLayers(e,i.additionalLayerInfos),r(c.provideDefaultBaseMapForItemData(t.itemData,i),function(){return t})}i=i||{};var o=t.item,d=t.itemData;if("Feature Service"===o.type)return n().then(function(e){for(var t=[],i=0;i<e.layers.length;i++){var r=e.layers[i],n=r.id;t.unshift({url:o.url+"/"+n,capabilities:e.capabilities||"Query",id:"featureServiceLayer_"+n,visibility:r.defaultVisibility,mode:1,title:r.title,description:r.description})}return a(t)});if("Map Service"===o.type)return n().then(function(t){return a([e.mixin({url:o.url,id:"mapServiceLayer01",visibility:!0,opacity:1,title:t.title},d)])});if("Image Service"===o.type)return n().then(function(t){return a([e.mixin({url:o.url,id:"imageServiceLayer01",visibility:!0,opacity:1,title:t.title},d)])});if("Vector Tile Service"===o.type)return n().then(function(t){return a([e.mixin({url:o.url,id:"vectorTileServiceLayer01",visibility:!0,opacity:1,title:t.title},d)])});if("WMSServer"===o.type)return n().then(function(t){return a([e.mixin({url:o.url,id:"wmsLayer01",visibility:!0,opacity:1,title:t.title},d)])});if("WMTS"===o.type)return n().then(function(t){return a([e.mixin({url:o.url,id:"wmtsLayer01",visibility:!0,opacity:1,title:t.title},d)])});if("WFS"===o.type)return n().then(function(t){return a([e.mixin({url:o.url,id:"wfsLayer01",visibility:!0,opacity:1,title:t.title},d)])});if("KML"===o.type){s.registerCORS(o.url);return a([e.mixin({url:o.url,id:"kmlLayer01",visibility:!0,opacity:1,title:"KML Layer",type:"KML"},d)])}},c.provideDefaultBaseMapForItemData=function(e,t){if(t=t||{},!e.baseMap)return r(function(){var e={title:"My basemap",baseMapLayers:[{id:"basemapLayer01",opacity:t.hideBasemap?0:1,visibility:!t.hideBasemap,url:d}]};return t.defaultBasemapId?c.getItem(t.defaultBasemapId).then(function(t){return t&&t.itemData&&t.itemData.baseMap||e}):e}(),function(t){return e.baseMap=t,e})},c._addAdditionalLayerInfosToOperationalLayers=function(e,t){t.forEach(function(t,i){e.push({url:t.url,id:"additionalLayer"+i,visibility:!0,opacity:1})})},c});