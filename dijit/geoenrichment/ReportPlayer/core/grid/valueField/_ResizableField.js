// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/on","dojo/string","dojo/dom-class","dojo/dom-construct","dojo/dom-style","./utils/ResizeColumnRowTooltipVisualizer","esri/dijit/geoenrichment/utils/PageUnitsConverter","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/KeyboardUtil","esri/dijit/geoenrichment/utils/MouseUtil","esri/dijit/geoenrichment/utils/TooltipUtil","dojo/i18n!esri/nls/jsapi"],function(e,i,t,s,n,a,d,l,o,h,r,g,S,u,c){c=c.geoenrichment.dijit.ReportPlayer.ValueField;var f={_grid:null,_timeoutHandle:null,setIsBeingResized:function(e,i){this._cleanUp(),i&&e.parentGrid&&e.parentGrid.domNode&&(this._grid=e.parentGrid,a.add(this._grid.domNode,"isBeingResized"),this._timeoutHandle=setTimeout(this._cleanUp.bind(this),1e4))},_cleanUp:function(){clearTimeout(this._timeoutHandle),this._grid&&this._grid.domNode&&a.remove(this._grid.domNode,"isBeingResized"),this._grid=null}};return e(null,{resizable:!0,hasAllSidesSizers:!1,showSizeLabel:!1,showSizeLabelsInAllRelatedCells:!1,showColumnRowSizeTooltip:!1,showSizersOnFocus:!1,createSizersOnDemand:!0,resizeRestrictNode:null,allowHorizontalResizing:!0,allowVerticalResizing:!0,sizeLabel:null,_tooltipHandles:null,postCreate:function(){this._tooltipHandles=[],this.inherited(arguments),this.resizable&&this._addCreateSizersTrigger()},_isBeingResized:!1,_isBeingResizedDelayed:!1,_sizers:null,isBeingResized:function(){return!(!this.resizable||!this._sizers)&&(this._isBeingResized||this._sizers.some(function(e){return S.isMouseOver(e)})||!this.hasAllSidesSizers&&this._sizers.some(function(e){return l.get(e,"opacity")>0}))},wasResizedRecently:function(){return this.isBeingResized()||this._isBeingResizedDelayed},_addCreateSizersTrigger:function(){var e=this;this.createSizersOnDemand||this._updateSizers(),s(this.domNode,"mouseover",function(){e._updateSizers()})},_createSizers:function(){var e=this;if(this.resizable&&!this._sizers){var i;i=this.hasAllSidesSizers?["e","se","s","sw","w","nw","n","ne"]:[this.allowHorizontalResizing?"e":null,this.allowVerticalResizing?"s":null].filter(function(e){return!!e}),this._sizers=i.map(function(i){var t=d.create("div",null,e.domNode);if(e.hasAllSidesSizers){var s=e.showSizersOnFocus?"valueField_allSidesSizer_showOnFocus":"valueField_allSidesSizer";a.add(t,s+" "+i+"_fieldSizer"),e.fieldCellClass&&a.add(t,"fieldSizer_"+e.fieldCellClass)}else"e"===i?(a.add(t,"valueField_widthSizer"),e._tooltipHandles.push(u.setTooltipToNode(t,c.dragToChangeWidth)),e.fieldCellClass&&a.add(t,"widthSizer_"+e.fieldCellClass)):(a.add(t,"valueField_heightSizer"),e._tooltipHandles.push(u.setTooltipToNode(t,c.dragToChangeHeight)),e.fieldCellClass&&a.add(t,"heightSizer_"+e.fieldCellClass));return t._sizerInfo={dir:i,canChangeW:-1!==i.indexOf("w")||-1!==i.indexOf("e"),canChangeH:-1!==i.indexOf("n")||-1!==i.indexOf("s"),canChangeX:-1!==i.indexOf("w"),canChangeY:-1!==i.indexOf("n"),dxDir:-1!==i.indexOf("w")?-1:1,dyDir:-1!==i.indexOf("n")?-1:1},t}),this._addResizeHandlers()}},unitTesting_getSizerByDirection:function(e){return this._updateSizers(),this._sizers.filter(function(i){return i._sizerInfo.dir===e})[0]},_addResizeHandlers:function(){var e=this;this._sizers.forEach(function(i){var t=i._sizerInfo;s(i,"mousedown",function(i){i.stopPropagation();var n;e._setIsBeingResized(!0),e.stopEdit&&e.stopEdit();var a=S.getCursorPosition().clientX,d=S.getCursorPosition().clientY,l=e.getWidth(),o=e.getHeight(),h=a,r=d,u=e._getResisableNodePos(),c={x:u.x,y:u.y,dxShiftSingle:0,dyShiftSingle:0,w:l,h:o,dwSingle:0,dhSingle:0},f=s(document.body,"mousemove",function(i){var s=S.getCursorPosition().clientX,f=S.getCursorPosition().clientY,z=s-a,_=f-d;if(z*=t.dxDir,_*=t.dyDir,i.shiftKey){var C=c.h/c.w,m=(z+_)/2;switch(t.dir){case"se":z=m,_=m*C;break;case"sw":_=m*C,s+=z-m,z=m;break;case"nw":s+=z-m,f+=_-m*C,z=m,_=m*C}}var w;if(g.isCtrl(i))switch(t.dir){case"e":case"w":var p=u.x-z;c.dxShiftSingle=p-c.x,c.x=p,z*=2,w=!0;break;case"se":case"sw":case"nw":var p=u.x-z,x=u.y-_;c.dxShiftSingle=p-c.x,c.dyShiftSingle=x-c.y,c.x=p,c.y=x,z*=2,_*=2,w=!0;break;case"s":case"n":var x=u.y-_;c.dyShiftSingle=x-c.y,c.y=x,_*=2,w=!0}!n&&(t.canChangeW&&z||t.canChangeH&&_)&&(e._onManualSizePreChange(),n=!0);var b=!1;if(c.dwSingle=0,c.dhSingle=0,t.canChangeW&&z&&(c.w=l+z,c.dwSingle=z,b=!0),t.canChangeH&&_&&(c.h=o+_,c.dhSingle=_,b=!0),!w&&(c.dxShiftSingle=0,c.dyShiftSingle=0,t.canChangeX||t.canChangeY)){var y=t.canChangeX?s-h:0,R=t.canChangeY?f-r:0;c.dxShiftSingle=y,c.dyShiftSingle=R,c.x+=y,c.y+=R,h=s,r=f}e._applyResizedCellBox(c,t),b&&(e._onManualSizeChange(t),e.onManualSizeChange()),t.canChangeW&&z&&e.onManualWidthChange(i),t.canChangeH&&_&&e.onManualHeightChange(i),e._updateSizers()}),z=s.once(document.body,"mouseup, click",function(){z.remove(),f.remove(),e._setIsBeingResized(!1)})})}),this.hasAllSidesSizers&&this.own(t.after(this,"onSizeChanged",function(){r.isNodeInLayout(e._sizers[0])&&e._updateSizers()}))},_setIsBeingResized:function(e){e?(this._isBeingResized=!0,this._isBeingResizedDelayed=!0,a.add(this.domNode,"isBeingResized")):(this._isBeingResized&&this._onManualSizeChangeEnd(),this._isBeingResized=!1,a.remove(this.domNode,"isBeingResized"),r.stealFocus(),setTimeout(function(){this._isBeingResizedDelayed=!1}.bind(this),100)),this._tooltipHandles.forEach(function(i){e?i.suspend():i.resume()}),f.setIsBeingResized(this,e)},_getResisableNodePos:function(){return r.position(this.domNode)},_applyResizedCellBox:function(e,t){var s=i.mixin({},e),n=this.resizeRestrictNode&&r.position(this.resizeRestrictNode),a=!1,d=!1;if(s.dxShiftSingle||s.dyShiftSingle){if(n){var l=this._getResisableNodePos();s.dxShiftSingle<0?n.x>=l.x?(s.dxShiftSingle=0,a=!0):(s.dxShiftSingle=Math.max(s.dxShiftSingle,n.x-l.x),s.w-=s.dxShiftSingle-e.dxShiftSingle):s.x<=n.x?(s.dxShiftSingle=0,a=!0):(s.dxShiftSingle=Math.min(s.dxShiftSingle,s.x-n.x),s.w-=e.dxShiftSingle-s.dxShiftSingle),s.dyShiftSingle<0?n.y>=l.y?(s.dyShiftSingle=0,d=!0):(s.dyShiftSingle=Math.max(s.dyShiftSingle,n.y-l.y),s.h-=s.dyShiftSingle-e.dyShiftSingle):s.y<=n.y?(s.dyShiftSingle=0,d=!0):(s.dyShiftSingle=Math.min(s.dyShiftSingle,s.y-n.y),s.h-=e.dyShiftSingle-s.dyShiftSingle)}this.onNeedShiftPositionFromResizing(s.dxShiftSingle,s.dyShiftSingle)}if(t.canChangeX&&0===s.dxShiftSingle&&(a=!0),t.canChangeY&&0===s.dyShiftSingle&&(d=!0),s.dwSingle||s.dhSingle){if(n){var l=this._getResisableNodePos(),o=n.x+n.w-l.x,h=n.y+n.h-l.y;s.w=Math.max(3,Math.min(s.w,o)),s.h=Math.max(3,Math.min(s.h,h))}a||this.setWidth(s.w),d||this.setHeight(s.h)}},updateSizers:function(){this._updateSizers()},_updateSizers:function(){function e(){i._sizers.forEach(function(e){var t,s,n=e._sizerInfo,a=i.getWidth(),d=i.getHeight(),o=l.get(e,"width"),h=l.get(e,"height");switch(n.dir){case"e":t=a,s=(d-h)/2;break;case"se":t=a,s=d;break;case"s":t=(a-o)/2,s=d;break;case"sw":t=0,s=d;break;case"w":t=0,s=(d-h)/2;break;case"nw":t=0,s=0;break;case"n":t=(a-o)/2,s=0;break;case"ne":t=a,s=0}l.set(e,{left:t+"px",top:s+"px",cursor:n.dir+"-resize",marginLeft:n.canChangeW?-o/2+"px":"",marginTop:n.canChangeH?-h/2+"px":""}),"w"!==n.dir&&"e"!==n.dir||r[d<30?"hide":"show"](e),"s"!==n.dir&&"n"!==n.dir||r[a<30?"hide":"show"](e)})}if(this._createSizers(),this._sizers&&this.hasAllSidesSizers){var i=this;l.get(this.domNode,"height")>5?e():setTimeout(e,100)}},_onManualSizePreChange:function(){this.setToolbarSuspended&&this.setToolbarSuspended(!0),this.onManualSizePreChange()},_onManualSizeChange:function(e){this.inherited(arguments),this.showSizeLabel&&this._showAndUpdateSizeLabel(),this.showSizeLabelsInAllRelatedCells&&this._showAndUpdateRelatedCellsSizeLabels(),this.showColumnRowSizeTooltip&&("e"===e.dir?o.showColumnTooltip(this):"s"===e.dir&&o.showRowTooltip(this))},_onManualSizeChangeEnd:function(){r.hide(this.sizeLabel),this.setToolbarSuspended&&this.setToolbarSuspended(!1),this.showSizeLabelsInAllRelatedCells&&this._hideRelatedCellsSizeLabels(),this.showColumnRowSizeTooltip&&o.removeTooltip(),this.onManualSizeChangeEnd()},_showAndUpdateSizeLabel:function(){this.sizeLabel=this.sizeLabel||d.create("div",{class:"elementSizeLabel"},this.domNode),r.show(this.sizeLabel),setTimeout(function(){if(this.domNode&&!r.isHidden(this.sizeLabel)){var e=this.domNode.clientWidth,i=this.domNode.clientHeight;if(this.viewModel&&this.viewModel.showUnitsInPt){var t=h.pxToPt(e),s=h.pxToPt(i);this.sizeLabel.innerHTML=n.substitute(c.elementSizeFormatPt,{width:Math.round(t),height:Math.round(s)})}else this.sizeLabel.innerHTML=n.substitute(c.elementSizeFormat,{width:Math.round(e),height:Math.round(i)});var a=this.sizeLabel.clientWidth,d=this.sizeLabel.clientHeight;this.sizeLabel.style.left=(e-a)/2+"px",this.sizeLabel.style.top=(i>20?(i-d)/2:-d-5)+"px"}}.bind(this))},_showAndUpdateRelatedCellsSizeLabels:function(){this._getRelatedCells().forEach(function(e){e._showAndUpdateSizeLabel()})},_hideRelatedCellsSizeLabels:function(){this._getRelatedCells().forEach(function(e){r.hide(e.sizeLabel)})},_getRelatedCells:function(){return this.parentGrid?this.parentGrid.getFieldCells().filter(function(e){return e!==this},this):[]},onManualSizePreChange:function(){},onManualSizeChangeEnd:function(){},onManualSizeChange:function(){},onManualWidthChange:function(e){},onManualHeightChange:function(e){},onNeedShiftPositionFromResizing:function(e,i){}})});