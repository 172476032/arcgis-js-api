// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/declare","./GridDataUtil","./GridStyleUtil","./GridLayoutCalculator","./GridCellContentScaler","../../supportClasses/conditionalStyling/ConditionalStyleUtil","../../supportClasses/templateJsonUtils/FieldInfoRenderer","../../supportClasses/templateJsonUtils/FieldInfoTooltipUtil","../../themes/ReportThemes","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes"],function(e,t,n,i,o,r,a,l,d,s){var c={color:"#FF0000"};return e(null,{renderCellContent:function(e){var n,i=e.parentGrid,o=t.getFieldInfo(e);if(o){if(o.isChart)return void this._placeChartInCell(i,e);if(o.isImage||o.isShape)return void this._placeImageOrShapeInCell(i,e,o.isImage);if(o.isReportSection)return void this._placeReportSectionInCell(i,e);if(o.isInfographic)return void this._placeInfographicInCell(i,e);o.isMissing&&e.setStyle(c),n=this._getRenderedContent(e,o)}else n=e.gridData[e.column.field]||"";this._applyRenderedContent(e,n),e.setContent(null),o&&o.isRichText&&e.setHoverTooltip&&e.setHoverTooltip("")},updateViewMode:function(e){var n=t.getFieldInfo(e);n&&(n.hasVariable||n.script||n.alias||n.isRichText)&&this._applyRenderedContent(e,this._getRenderedContent(e,n))},_getRenderedContent:function(e,t){var n=this._prepareRenderContextForFieldCell(e,t);return a.renderFieldInfoInTableCell(t,n)},_applyRenderedContent:function(e,i){var o=i&&i.label||i;t.setFieldCellContent(e,o),i&&(e.setNumberValue(i.numberValue),i.conditionalStyle?e.setStyle(i.conditionalStyle):(i.conditionalStyle===!1||"string"==typeof i)&&e.setStyle(n.combineCellStyle(e.parentGrid,e.gridData,e.column))),e.parentGrid&&e.parentGrid.viewModel.dynamicReportInfo&&e.setUrl(t.getFieldCellUrl(e))},_prepareRenderContextForFieldCell:function(e,t){function n(){var e=o.getSpecificViewMode(),n="previewValues"==o.getViewMode();return!t||"SiteNote"!=t.name&&"SiteNotes"!=t.name||(n=!0),e&&("previewValues"==e.richText&&t&&t.isRichText?n=!0:"previewValues"==e.variable&&t&&(t.hasVariable||t.script)&&(n=!0)),n}var o=e.parentGrid,r=n(),a="edit"==o.getViewMode();return{previewValues:r,previewConditionalStyle:!r&&!a,getPreviewValueFunction:o.getPreviewValueFunction,fieldData:o.viewModel.dynamicReportInfo&&o.viewModel.dynamicReportInfo.fieldData,featureIndex:o.previewFeatureIndex||o.isMultiFeatureTable()&&i.calcRingIndexForCell(e),rowIndex:e.gridData&&e.gridData.index,isGraphicReport:o.viewModel.reportStyle==d.GRAPHIC}},_placeChartInCell:function(e,t){var n={viewModel:e.viewModel,themeContext:e.themeContext,theme:e.theme,previewFeatureIndex:e.previewFeatureIndex,showEditButton:!0};return this._createChartPageFromParams(e,t,n)},_createChartPageFromParams:function(e,n,i){var r=t.getFieldInfo(n).chartJson,a=function(e){n.setContent(e)},l=e.viewModel.layoutBuilder.createElement("chart",{node:n.getContentContainerNode(),placeFunc:a,json:r,creationParams:i});return o.fitContentInsideCell(n),l},_placeImageOrShapeInCell:function(e,n,i){var o=t.getFieldInfo(n),l=o[i?"imageJson":"shapeJson"],d=n.getWidth(),s=n.getHeight();if(i){if(o.triggerJson&&e.viewModel.dynamicReportInfo){var c=a.getValueFromFieldData(o.triggerJson.fieldInfo,{fieldData:e.viewModel.dynamicReportInfo.fieldData,formatValue:!1});r.processImageJsonForTrigger(l,c,o.triggerJson),n.setNumberValue(c)}l.style.width&&l.style.height&&!l.fitParent&&Math.round(l.style.width)!=Math.round(d)&&Math.round(l.style.height)!=Math.round(s)?l.fitParent=!1:(l.fitParent=!0,l.style.width=d,l.style.height=s)}else l.style.width=d,l.style.height=s;var u,g={alignParams:n.getFullStyle(),imageTriggerJson:o.triggerJson,createMapFunc:e.viewModel.dynamicReportInfo&&e.viewModel.dynamicReportInfo.createMapFunc,getDynamicImageFunc:e.viewModel.getDynamicImageFunc.bind(e.viewModel),themeContext:e.themeContext,theme:e.theme,showError:!1,getPreviewValueFunction:e.getPreviewValueFunction,applyThemeStyle:e.applyThemeStyle,onInitialized:function(){if(n.domNode){var e=n.getWidth(),t=n.getHeight();u&&u.resize&&u.resize({w:e,h:t},n.getFullStyle())}}};return g.onContentLoadingStart=function(){e.onContentLoadingStart()},g.onContentLoadingEnd=function(){e.onContentLoadingEnd()},u=this._createImageOrShapeFromParams(e,n,l,i,g)},_createImageOrShapeFromParams:function(e,t,n,i,o){var r=function(e){t.setContent(e)};return e.viewModel.layoutBuilder.createElement(i?"image":"shape",{node:t.getContentContainerNode(),placeFunc:r,relativeParent:t.domNode,json:n,creationParams:o})},_placeReportSectionInCell:function(e,n){var i={};return i["class"]="adjustableGrid_inCellSection",i.json=t.getFieldInfo(n).sectionJson,i.viewModel=e.viewModel,i.themeContext=e.themeContext,i.theme=e.theme,i.viewPortContainer=e.viewPortContainer,i.initialWidth=n.getWidth(),i.hasFixedLayout=!1,i.onContentLoadingStart=function(){e.onContentLoadingStart()},i.onContentLoadingEnd=function(){e.onContentLoadingEnd()},this._createReportSectionFromParams(e,n,i)},_createReportSectionFromParams:function(e,t,n){var i;return n.parentGridCell=t,i=n.json&&n.json.stack&&n.json.type!=s.EMPTY?e.viewModel.layoutBuilder.createElement("section",n,t.getContentContainerNode()):e.viewModel.layoutBuilder.createElement("emptySection",n,t.getContentContainerNode()),t.setContent(i),i.setViewMode&&i.setViewMode(e.getViewMode()),o.fitContentInsideCell(t),i},_placeInfographicInCell:function(e,n){var i=t.getFieldInfo(n).infographicJson,o={viewModel:e.viewModel,themeContext:e.themeContext,theme:e.theme,width:n.getWidth(),height:n.getHeight(),showEditButton:!0,allowEditContent:!1,onContentLoadingStart:function(){e.onContentLoadingStart()},onContentLoadingEnd:function(){e.onContentLoadingEnd()}},r=this._createInfographicFromParams(e,n,i,o);return r.setViewMode&&r.setViewMode(e.getViewMode()),r},_createInfographicFromParams:function(e,t,n,i){var r=function(e){t.setContent(e)},a=e.viewModel.layoutBuilder.createElement("infographic",{node:t.getContentContainerNode(),placeFunc:r,json:n,creationParams:i});return o.fitContentInsideCell(t),a}})});