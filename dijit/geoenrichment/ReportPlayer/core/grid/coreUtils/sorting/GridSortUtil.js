// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/on","dojo/dom-class","dojo/dom-construct","dojo/sniff","dojo/touch","./GridRowStyler","../GridDataUtil","../GridQueryUtil","esri/dijit/geoenrichment/utils/ObjectUtil","esri/dijit/geoenrichment/utils/TooltipUtil","dojo/i18n!esri/nls/jsapi"],function(o,r,t,e,n,i,l,a,s,d,f){f=f.geoenrichment.dijit.ReportPlayer.Grid;var c={},u=/^(\d+|\d+[.,]\d+)%$/;return c.isGridSortable=function(o){return!(!o.allowSorting||o.isEmptyTable()||o.store.data.length<3||!o.viewModel.dynamicReportInfo)},c.updateSorting=function(o,r){if(c.isGridSortable(o)){var t=c._collectHeaderRowInfo(o);t&&c._makeSortable(o,t),!r&&t&&c._applySortInfo(o,t)}},c._collectHeaderRowInfo=function(o){function r(r){return r&&r.length===o.columns.length}for(var t,e,n=o.store.data.length-2,i=0;i<n;i++){var l=a.queryCells(o,{rowIndex:i});if(r(l)){t=l,e=i;break}}if(!t)return null;for(i=e+1;i<o.store.data.length;i++)if(l=a.queryCells(o,{rowIndex:i}),!r(l))return null;return{cells:t,headerRowIndex:e}},c._makeSortable=function(i,l){l.cells.forEach(function(a){var s=t.create("div",{class:"sortArrow sortArrowHoverIndicator"},a.domNode),d=a.getFullStyle();s.style[d&&"left"===d.horizontalAlign?"right":"left"]="5px",a._sortArrow=s,r.add(a.domNode,"esriGEClickable"),o(a.contentBlock,e("touch")?n.press:"mousedown",function(o){i&&i.canSortCellFunc&&!i.canSortCellFunc(a)||c._checkCanSortOnHeaderClick(o)&&c._toggleSortForCell(a,l)}),o(s,e("touch")?n.press:"mousedown",function(o){c._toggleSortForCell(a,l)})}),c._updateArrows(i,l)},c._toggleSortForCell=function(o,r){var t=o.parentGrid,e=t._sortInfo&&t._sortInfo.field===o.column.field?t._sortInfo.order:null;t._sortInfo={field:o.column.field,order:null,originalData:t._sortInfo?t._sortInfo.originalData:t.store.data.slice()},e?"desc"===e?t._sortInfo.order="asc":"asc"===e&&(t._sortInfo.order=null):t._sortInfo.order="desc",c._applySortInfo(t,r),t.onSortingChanged(c.getSorting(t))},c._checkCanSortOnHeaderClick=function(o){if(o&&o.path){if(o.path.some(function(o){return"A"===o.nodeName}))return!1}else if(o&&o.srcElement&&o.srcElement.parentNode&&"A"===o.srcElement.parentNode.nodeName)return!1;return!0},c._applySortInfo=function(o,r,t){if(c._updateArrows(o,r),o._sortInfo){if(o._sortInfo.order){for(var e=[],n=o._sortInfo.originalData.slice(),a=0;a<r.headerRowIndex+1;a++)e.push(n.shift());var d=i.getStyleInfo(n,o.columns),f=o._sortInfo.field;n.sort(function(r,t){function e(o){var r=l.getNumericDataValue(o,f);if(void 0!==r)return r;var t=o[f];return"string"==typeof t?u.test(t)?(r=s.parseNumber(t.replace("%","")),isNaN(r)?t:r):(r=s.parseNumber(t),isNaN(r)?t:r):t}var n,i=e(r),a=e(t),d="desc"===o._sortInfo.order,c="number"==typeof i||"number"==typeof a;return c?(i=Number(i),a=Number(a),n=i>a?1:i<a?-1:0,d?-n:n):(i=String(i),a=String(a),n=i.localeCompare(a),d?-n:n)}),d&&i.setAlternatingColors(n,o.columns,d),o.store.data=e.concat(n)}else o.store.data=o._sortInfo.originalData,i.resetStyling(o._sortInfo.originalData,o.columns);t||o.refresh({skipSorting:!0})}},c._updateArrows=function(o,t){t.cells.forEach(function(t){var e=t._sortArrow;r.remove(e,"sortArrowHoverIndicator sortArrowUp sortArrowDown"),d.setTooltipToNode(e,null),o._sortInfo&&o._sortInfo.field===t.column.field?"asc"===o._sortInfo.order?r.add(e,"sortArrowUp"):"desc"===o._sortInfo.order?r.add(e,"sortArrowDown"):(d.setTooltipToNode(e,f.sortTable),r.add(e,"sortArrowHoverIndicator")):(d.setTooltipToNode(e,f.sortTable),r.add(e,"sortArrowHoverIndicator")),setTimeout(function(){e.style.top=(t.getHeight()-e.clientHeight)/2+"px"},100)})},c.getSorting=function(o){return o._sortInfo&&{field:o._sortInfo.field,order:o._sortInfo.order}},c.setSorting=function(o,r,t){if(c.isGridSortable(o)&&r){var e=c._collectHeaderRowInfo(o);e&&(o._sortInfo={field:r.field,order:r.order,originalData:o._sortInfo?o._sortInfo.originalData:o.store.data.slice()},c._applySortInfo(o,e,t&&t.doNotRefresh))}},c.getSortRowIndexMapping=function(o){if(!o._sortInfo||!o._sortInfo.order)return null;var r={};return o.store.data.forEach(function(t,e){r[e]=o._sortInfo.originalData.indexOf(t)}),r},c});