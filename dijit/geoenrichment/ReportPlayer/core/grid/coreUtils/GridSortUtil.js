// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/on","dojo/dom-class","dojo/dom-construct","dojo/dom-style","./GridDataUtil","./GridQueryUtil","./GridLayoutCalculator","../../supportClasses/templateJsonUtils/fieldInfo/FieldInfoRenderer","esri/dijit/geoenrichment/utils/DomUtil"],function(e,o,t,r,n,l,i,a,s){var u={},f={_getCellStyle:function(e,o){e.style=e.style||{};var t=e.style.fields=e.style.fields||{};return t[o.field]=t[o.field]||{}},_getCellStyleState:function(e){return{backgroundColor:e.backgroundColor,overrideStyle:e.overrideStyle,key:e.backgroundColor+"."+e.overrideStyle}},getStyleInfo:function(e,o){function t(e){var t;return o.some(function(o){var r=f._getCellStyle(e,o),n=f._getCellStyleState(r);return t&&t.key!==n.key?!0:void(t=n)})?!1:t}function r(e){var o=t(e);if(!o)return!0;if(n.length){if(1===n.length){if(n[0].key===o.key)return!0;n.push(o)}else if(!n.some(function(e){return e.key===o.key}))return!0}else n.push(o)}f.resetStyling(e,o);var n=[];return e.some(r)?null:{states:n}},setAlternatingColors:function(e,o,t){f.resetStyling(e,o),e.forEach(function(e,r){var n=r%2?t.states[1]:t.states[0];o.forEach(function(o){var t=f._getCellStyle(e,o);t.__isStyled=!0,t.__originalBackgroundColor=t.backgroundColor,t.backgroundColor=n.backgroundColor,t.__originalOverrideStyle=t.overrideStyle,t.overrideStyle=n.overrideStyle})})},resetStyling:function(e,o){e.forEach(function(e){o.forEach(function(o){var t=f._getCellStyle(e,o);t.__isStyled&&(delete t.__isStyled,t.backgroundColor=t.__originalBackgroundColor,delete t.__originalBackgroundColor,t.overrideStyle=t.__originalOverrideStyle,delete t.__originalOverrideStyle)})})}};return u.updateSorting=function(u,d){function c(e){return e&&e.length===u.columns.length}function g(e){var o=u._sortInfo&&u._sortInfo.columnId===e.columnId?u._sortInfo.state:null;u._sortInfo={columnId:e.columnId,column:e.column,state:null,originalData:u._sortInfo?u._sortInfo.originalData:u.store.data.slice()},o?"down"===o?u._sortInfo.state="up":"up"===o&&(u._sortInfo.state=null):u._sortInfo.state="down",_.forEach(m),y()}function m(e){var t=e._sortArrow;o.remove(t,"sortArrowUp"),o.remove(t,"sortArrowDown"),s.hide(t),u._sortInfo&&u._sortInfo.columnId===e.columnId&&("up"===u._sortInfo.state?(o.add(t,"sortArrowUp"),s.show(t)):"down"===u._sortInfo.state&&(o.add(t,"sortArrowDown"),s.show(t)))}function y(){if(u._sortInfo){if(u._sortInfo.state){for(var e=[],o=u._sortInfo.originalData.slice(),t=0;I+1>t;t++)e.push(o.shift());var r,l,s=f.getStyleInfo(o,u.columns);if(u.getNumDynamicColumns()){r={};for(var d=i.calcFeatureCount(u.columns.length,u.getNumFixedColumns(),u.getNumDynamicColumns()),c=u.getNumFixedColumns();;){if(!u.columns[c])break;for(var g=0;d>g;g++)r[u.columns[c++].field]=g}}else u.getNumDynamicRows()&&(l={},u._sortInfo.originalData.forEach(function(e,o){l[e.id]=Math.max(0,o-u.getNumFixedRows())}));var m=u._sortInfo.column.field;o.sort(function(e,o){function t(e){var o=n.getNumericDataValue(e,m);if(void 0!==o)return o;var t=e.fieldInfos&&e.fieldInfos[m];if(t){var i;return u.previewFeatureIndex?i=u.previewFeatureIndex:r?i=r[m]:l&&(i=l[e.id]),t.isImage&&t.triggerJson&&t.triggerJson.fieldInfo&&(t=t.triggerJson.fieldInfo),a.getFieldDataValue(t,u.viewModel.dynamicReportInfo.fieldData,i)||""}return e[m]}var i=t(e),s=t(o),f="down"===u._sortInfo.state,d="number"==typeof i||"number"==typeof s;return d?(i=Number(i),s=Number(s),result=i>s?1:s>i?-1:0,f?-result:result):(i=String(i),s=String(s),result=i.localeCompare(s),f?-result:result)}),s&&f.setAlternatingColors(o,u.columns,s),u.store.data=e.concat(o)}else u.store.data=u._sortInfo.originalData,f.resetStyling(u._sortInfo.originalData,u.columns);u.refresh({applyCurrentSorting:!1})}}if(!(!u.allowSorting||u.isEmptyTable()||u.store.data.length<3)&&u.viewModel.dynamicReportInfo){for(var _,I,v=u.store.data.length-2,S=0;v>S;S++){var C=l.queryCells(u,{rowIndex:S});if(c(C)){_=C,I=S;break}}if(_){for(S=I+1;S<u.store.data.length;S++)if(C=l.queryCells(u,{rowIndex:S}),!c(C))return;_.forEach(function(n){e(n.domNode,"click",function(){g(n)}),o.add(n.domNode,"esriGEAdjustableGridValueField");var l=t.create("div",{"class":"sortArrow"},n.domNode);r.set(l,"top",(n.getHeight()-9)/2+"px");var i=n.getFullStyle();r.set(l,i&&"left"===i.horizontalAlign?"right":"left","5px"),n._sortArrow=l,m(n)}),d&&y()}}},u.getSorting=function(e){return e._sortInfo},u.setSorting=function(e,o){e._sortInfo=o,u.updateSorting(e,!0)},u});