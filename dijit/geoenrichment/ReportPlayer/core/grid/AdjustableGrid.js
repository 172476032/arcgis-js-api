// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.25/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/on","dojo/store/Memory","dojo/when","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dijit/_WidgetBase","dijit/_TemplatedMixin","./_GridHighlightSupport","./_GridSortSupport","./ValueField","./coreUtils/GridBackgroundForegroundUtil","./coreUtils/GridFloatingTablesUtil","./coreUtils/GridBorderUtil","./coreUtils/GridDataUtil","./coreUtils/GridQueryUtil","./coreUtils/GridLayoutCalculator","./coreUtils/GridCellRenderer","./coreUtils/GridStyleUtil","./coreUtils/GridLayoutSizer","./coreUtils/sorting/GridSortUtil","esri/dijit/geoenrichment/utils/ArrayUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/async/AsyncQueue","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ViewModes","dojo/text!../templates/AdjustableGrid.html"],function(e,t,i,n,o,s,l,r,a,d,u,h,c,g,f,_,S,b,m,F,C,w,y,p,T,v,k,R,M,A){var V={defaultRowHeight:15.33,rowMinHeight:3,columnMinWidth:3,defaultChartRowHeight:150};return e([u,h,c,g],{templateString:A,viewModel:null,theme:null,columns:null,store:null,backgroundSectionJson:null,foregroundSectionJson:null,enableBackgroundForeground:!1,backgroundFloatingTablesSectionJson:null,foregroundFloatingTablesSectionJson:null,isFloatingTable:!1,isBackgroundFloatingTable:!1,layoutDefaults:null,stickToRight:!1,looseResize:!1,keepGridSizeWhenResized:!1,parentWidget:null,parentElementInPageInfo:null,viewPortContainer:null,parentGrid:null,reportContainerPageNode:null,getPreviewValueFunction:null,previewFeatureIndex:null,fixedViewMode:null,fieldCellClass:null,applyThemeStyle:!0,inheritThemeBackground:!0,enableAsyncRendering:!1,asyncBatchSize:1,enableNumberAnimation:!1,previewModeBorderLineStyle:null,editModeBorderLineStyle:null,renderBordersFromTheme:!1,noThemeBorderLineStyle:null,hasRealBorders:!1,allowSorting:!1,trimTextIfOverflows:!1,shouldStayWithinParent:!0,backgroundSection:null,foregroundSection:null,backgroundFloatingTablesSection:null,foregroundFloatingTablesSection:null,_cellRenderer:null,_fieldCells:null,_dynamicBindings:null,_isBeingResizedFlag:!1,_asyncQueue:null,postCreate:function(){this.inherited(arguments),this.layoutDefaults=t.mixin({},V,this.layoutDefaults)},refresh:function(e){if(this.domNode)return e=e||{},C.markAsDirty(this),e.preserveFocus||e.preserveFocusAll?this.__refreshAndPreserveFocus(e):this.__simpleRefresh(e),T.updateSorting(this,!1!==e.applyCurrentSorting),this.getRenderPromise()},__simpleRefresh:function(e){if(this.mainNode){e=e||{};this.store&&(this._destroyTableContent(),r.empty(this.mainNode),this.isEmptyTable()?r.create("div",{class:"adjustableGrid_emptyRow"},this.mainNode):(l[this.isSingleCelledTable()?"add":"remove"](this.domNode,"esriGEAdjustableGridSingleCell"),C.recalcRows(this),void 0===e.stickToRight&&(e.stickToRight=this.stickToRight),C.recalcColumns(this,e),C.autoSnapLayout(this),this._createCellsFromStoreData(),this._renderCells(),C.positionCells(this)),this.refreshBackground(),this._renderBackgroundFloatingTables(),this._renderForegroundFloatingTables(),this.refreshForeground())}},__refreshAndPreserveFocus:function(e){this.__simpleRefresh(e)},_createCellsFromStoreData:function(){var e=this;this.enableAsyncRendering&&(this._asyncQueue=new R),this.store.data.forEach(function(t){e.columns.forEach(function(i,n){if(!(t.excludedIndexHorizontal&&t.excludedIndexHorizontal[n]||t.excludedIndexVertical&&t.excludedIndexVertical[n])){var o=i.index+(m.getDataColumnSpan(t,i.field)||1)===e.columns.length,s=t.index+(m.getDataRowSpan(t,i.field)||1)===e.store.data.length;e._createField(t,i,o,s)}})})},_getFieldClass:function(){return f},_createField:function(e,t,i,n){var o="adjustableGridField field-"+t.field+(i?" lastInRow":"")+(n?" lastRow":""),s={viewModel:this.viewModel,fieldStyle:y.combineCellStyle(this,e,t),defaultBorderStyle:this._getDefaultBorderStyle(e,t,i,n),class:o,fieldCellClass:this.fieldCellClass,trimTextIfOverflows:this.trimTextIfOverflows,rowId:e.id,columnId:t.id,parentGrid:this,parentWidget:this,uniqueId:e.id+t.id,gridData:e,column:t,isLastInRow:i,isLastInColumn:n},l=this._doCreateFieldFromParams(s,e,t);return l.domNode.style.position="absolute",this._fieldCells.push(l),l},_getDefaultBorderStyle:function(e,t,i,n){return b.getBorderStyle(this,e,t,i,n)},getRenderPromise:function(){return this._asyncQueue&&this._asyncQueue.getPromise()},_doCreateFieldFromParams:function(e,t,i){return(new this._getFieldClass)(e).placeAt(this.mainNode)},_renderCells:function(){function e(e){t._renderFieldContent(e),t._postCreateFieldCell(e),t._updateCellViewMode(e)}var t=this;if(this._asyncQueue){v.splitArrayToBunches(this._fieldCells,this.asyncBatchSize).forEach(function(i){t._asyncQueue.add(function(){i.forEach(e)},{delayAfter:0})})}else this._fieldCells.forEach(e)},_renderFieldContent:function(e){this._preRenderFieldCell(e),this._getCellRenderer().renderCellContent(e),this._configureRenderedCellContentSpecificStyles(e),this._postRenderFieldCell(e)},_preRenderFieldCell:function(e){},_postRenderFieldCell:function(e){},_getCellRenderer:function(){return this._cellRenderer||(this._cellRenderer=new w),this._cellRenderer},_configureRenderedCellContentSpecificStyles:function(e){l[m.isNumericVariableFieldCell(e)?"add":"remove"](e.domNode,"hasNumericVariableFieldInfo"),l[m.isStringVariableFieldCell(e)?"add":"remove"](e.domNode,"hasStringVariableFieldInfo"),l[m.getConditionalFormatting(e)?"add":"remove"](e.domNode,"hasConditionalFormatting")},_postCreateFieldCell:function(e){},refreshBackground:function(){this.enableBackgroundForeground&&(this.backgroundSection&&this.backgroundSection.destroy(),this.backgroundSection=_.renderBackground(this,this.backgroundSectionJson,this._getBackgroundSectionCreationParams()))},_getBackgroundSectionCreationParams:function(){return this._getContentLoadingParams()},refreshForeground:function(){this.enableBackgroundForeground&&(this.foregroundSection&&this.foregroundSection.destroy(),this.foregroundSection=_.renderForeground(this,this.foregroundSectionJson,this._getForegroundSectionCreationParams()))},_getForegroundSectionCreationParams:function(){return this._getContentLoadingParams()},_renderBackgroundFloatingTables:function(){this.backgroundFloatingTablesSection&&this.backgroundFloatingTablesSection.destroy(),this.backgroundFloatingTablesSection=S.renderFloatingTables(this,this.backgroundFloatingTablesSectionJson,this._getFloatingTablesSectionParams(!0),!0)},_renderForegroundFloatingTables:function(){this.foregroundFloatingTablesSection&&this.foregroundFloatingTablesSection.destroy(),this.foregroundFloatingTablesSection=S.renderFloatingTables(this,this.foregroundFloatingTablesSectionJson,this._getFloatingTablesSectionParams(!1),!1)},_getFloatingTablesSectionParams:function(e){var i=this,n={tableParams:t.mixin({isFloatingTable:!0,isBackgroundFloatingTable:e,parentGrid:this,inheritThemeBackground:this.inheritThemeBackground,layoutDefaults:this.layoutDefaults,_preRenderFieldCell:function(e){i._preRenderFieldCell(e)},_postCreateFieldCell:function(e){i._postCreateFieldCell(e)}},this._getContentLoadingParams())};return this._addFloatingTablesSectionCreationParams(n),n},_addFloatingTablesSectionCreationParams:function(e){return e},getVisualState:function(){return{sorting:this.getSorting(this),cells:this.getFieldCells().map(function(e){return e.content&&e.content.getVisualState&&e.content.getVisualState()}),backgroundSection:this.backgroundSection&&this.backgroundSection.getVisualState(),backgroundFloatingTablesSection:this.backgroundFloatingTablesSection&&this.backgroundFloatingTablesSection.getVisualState(),foregroundFloatingTablesSection:this.foregroundFloatingTablesSection&&this.foregroundFloatingTablesSection.getVisualState(),foregroundSection:this.foregroundSection&&this.foregroundSection.getVisualState()}},setVisualState:function(e){if(e){if(e.sorting&&this.setSorting(e.sorting),e.cells){var t=this.getFieldCells();e.cells.length===t.length&&t.forEach(function(t,i){t.content&&t.content.setVisualState&&t.content.setVisualState(e.cells[i])})}e.backgroundSection&&this.backgroundSection.setVisualState(e.backgroundSection),e.backgroundFloatingTablesSection&&this.backgroundFloatingTablesSection.setVisualState(e.backgroundFloatingTablesSection),e.foregroundFloatingTablesSection&&this.foregroundFloatingTablesSection.setVisualState(e.foregroundFloatingTablesSection),e.foregroundSection&&this.foregroundSection.setVisualState(e.foregroundSection)}},_setCellWidth:function(e,t){C.adjustColumnWidth(this,e.gridData,e.column,t),C.positionCells(this)},_setCellHeight:function(e,t){C.adjustRowHeight(this,e.gridData,e.column.field,t),C.positionCells(this)},setCellWidth:function(e,t){this._setCellWidth(e,t)},setCellHeight:function(e,t){this._setCellHeight(e,t)},_maxWidth:500,_width:500,_height:0,_spaceAfter:0,_maxHeight:0,_left:0,_top:0,_alternatingStyle:null,getMaxHeight:function(e){return this._maxHeight},setMaxHeight:function(e){this._maxHeight=e},getHeight:function(e,t){return this._height+(!1!==t?this._top:0)+(e?this._spaceAfter||0:0)},getMaxWidth:function(){return this._maxWidth},setMaxWidth:function(e,t){var i=0;if(t&&t.preserveRightOffset){C.recalcGridWidth(this);var n=this.getAllowedWidth();i=(n-this._width)/n}this._maxWidth=e,t&&t.resizeToFitAllowedWidth&&this.resizeToFitAllowedWidth({rightOffsetWeight:t.preserveRightOffset?i:0})},getLeft:function(){return this._left},getTop:function(){return this._top},setSpaceAfter:function(e){this._spaceAfter=e},getAllowedWidth:function(){return this._maxWidth-this._left},getAllowedWidthFromParent:function(){return this.shouldStayWithinParent?d.get(this.domNode.parentNode,"width")-this._left:1e6},getTableBox:function(){var e=this.getSettings().style;return{l:e.left,t:e.spaceBefore,w:e.width,h:this.getHeight(!1,!1)}},getDomPosition:function(){return k.position(this.domNode)},resizeToFitAllowedWidth:function(e){this.isEmptyTable()||p.resizeToFitAllowedWidth(this,e)},resizeToFitWidth:function(e){this.isEmptyTable()||p.resizeToFitWidth(this,e)},resizeToFitHeight:function(e,t){if(!this.isEmptyTable()){if(!1!==t){e-=this._top}p.resizeToFitHeight(this,e)}},scaleProportionallyWithinParent:function(e){p.scaleProportionallyWithinParent(this,e)},collapseContent:function(){this.getFieldCells().forEach(function(e){e.content&&e.content.collapseContent&&e.content.collapseContent()})},hasHiddenContent:function(){return this._checkNeedResizeRowHeightToShowCellsContent(!1)},resizeRowHeightToShowCellsContent:function(){this._checkNeedResizeRowHeightToShowCellsContent(!0)},_checkNeedResizeRowHeightToShowCellsContent:function(e){var t,i=this;return this.getFieldCells().forEach(function(n){if(n.content&&n.content.getPreferredHeight){var o=n.content.getPreferredHeight();o>n.getHeight()&&(e&&(o&&(o+=10),i._setCellHeight(n,o)),t=!0)}}),t},_tableAttributes:null,setSettings:function(e){var t,i=this._left;if(this.columns.forEach(function(e){e.style&&"number"==typeof e.style.width&&(e._wasBeforeRecalc=!0)}),e.style){void 0!==e.style.left&&this.setGridPosition(e.style.left),void 0!==e.style.spaceBefore&&this.setGridPosition(void 0,e.style.spaceBefore),void 0!==e.style.spaceAfter&&(this._spaceAfter=e.style.spaceAfter),e.style.width&&(this._width=e.style.width),e.style.alternatingStyle&&(this._alternatingStyle=e.style.alternatingStyle);var n=this._width;this._width=Math.min(this._width,this.getAllowedWidth()),this._width===n&&i===this._left||(t=!0)}e.attributes&&(this._adjustColumnsForSettings(e)&&(t=!0),this._tableAttributes=e.attributes,this._tableAttributes.rowCount&&this._tableAttributes.rowCount!==this.store.data.length&&this._adjustRowsForSettings(e),delete this._tableAttributes.rowCount,delete this._tableAttributes.columnCount),void 0!==e.scaleToFitWidth&&(this._scaleToFitWidth=e.scaleToFitWidth),void 0!==e.scaleToFitHeight&&(this._scaleToFitHeight=e.scaleToFitHeight),this._tableAttributes=this._tableAttributes||{};var o=[];this.columns.forEach(function(e){e._wasBeforeRecalc&&o.push(e),delete e._wasBeforeRecalc}),this.viewModel.dynamicReportInfo&&this.getNumDynamicColumns()?(C.trimColumnsForNumberOfFeatures(this),this.refresh({resetWidth:!0})):this.viewModel.dynamicReportInfo&&this.getNumDynamicRows()?(C.adjustRowsForNumberOfFeatures(this),this.refresh()):t?this.refresh({resetWidth:!0,columnsToPreserve:o}):this.refresh()},setGridPosition:function(e,t){void 0!==e&&(this._left=e||0,this.domNode.style.left=this._left+"px"),void 0!==t&&(this._top=t||0,this.domNode.style.top=this._top+"px")},_adjustColumnsForSettings:function(e){return!1},_adjustRowsForSettings:function(e){},getSettings:function(){return C.recalcGridWidth(this),{style:{width:this._width,left:this._left,spaceBefore:this._top,spaceAfter:this._spaceAfter,alternatingStyle:this._alternatingStyle},attributes:t.mixin(t.clone(this._tableAttributes),{columnCount:this.columns.length,rowCount:this.store.data.length}),scaleToFitWidth:this._scaleToFitWidth,scaleToFitHeight:this._scaleToFitHeight}},needScaleToFitWidth:function(){return this._scaleToFitWidth},needScaleToFitHeight:function(){return this._scaleToFitHeight},isEmptyTable:function(){return!(this.columns&&this.columns.length&&this.store&&this.store.data.length)},isSingleCelledTable:function(){return 1===this.store.data.length&&1===this.columns.length},isMultiFeatureTable:function(){return!!this.getNumDynamicColumns()||!!this.getNumDynamicRows()},getNumFixedColumns:function(){return this._tableAttributes&&this._tableAttributes.fixedColumns||0},setNumFixedColumns:function(e){this._tableAttributes.fixedColumns=e},getNumDynamicColumns:function(){return this._tableAttributes&&this._tableAttributes.dynamicColumns||0},setNumDynamicColumns:function(e){this._tableAttributes.dynamicColumns=e},getNumFixedRows:function(){return this._tableAttributes&&this._tableAttributes.fixedRows||0},setNumFixedRows:function(e){this._tableAttributes.fixedRows=e},getNumDynamicRows:function(){return this._tableAttributes&&this._tableAttributes.dynamicRows||0},setNumDynamicRows:function(e){this._tableAttributes.dynamicRows=e},collectFieldInfos:function(e){return e=e||{},e.onlySelectedCells&&(e.fieldCells=this.getSelectedCells()||[]),F.collectFieldInfos(this,e)},_viewMode:null,_specificViewMode:null,_viewModeKey:null,getViewMode:function(){return this._viewMode},getSpecificViewMode:function(){return this._specificViewMode},setViewMode:function(e,t){var i=this;e=this.fixedViewMode||e;var n=e+t;this._viewModeKey!==n&&(this._viewModeKey=n,this._viewMode=e,void 0!==t&&(this._specificViewMode=t),l[this._viewMode===M.EDIT?"add":"remove"](this.domNode,"adjustableGridEditMode"),l[this._viewMode===M.EDIT?"remove":"add"](this.domNode,"adjustableGridPreviewMode"),this._fieldCells&&this._fieldCells.forEach(function(e){i._updateCellViewMode(e)}),this.backgroundSection&&this.backgroundSection.setViewMode(this._viewMode,this._specificViewMode),this.backgroundFloatingTablesSection&&this.backgroundFloatingTablesSection.setViewMode(this._viewMode,this._specificViewMode),this.foregroundFloatingTablesSection&&this.foregroundFloatingTablesSection.setViewMode(this._viewMode,this._specificViewMode),this.foregroundSection&&this.foregroundSection.setViewMode(this._viewMode,this._specificViewMode))},_updateCellViewMode:function(e){e.setDefaultBorderStyle(this._getDefaultBorderStyle(e.gridData,e.column,e.isLastInRow,e.isLastInColumn)),e.content&&e.content.setViewMode&&e.content.setViewMode(this._viewMode,this._specificViewMode),this._getCellRenderer().updateViewMode(e)},_getContentLoadingParams:function(){return{onContentLoadingStart:this.onContentLoadingStart.bind(this),onContentLoadingEnd:this.onContentLoadingEnd.bind(this)}},getFieldCells:function(e){return e&&e.floatingCells?this.getForegroundFloatingCells().concat(this._fieldCells).concat(this.getBackgroundFloatingCells()):this._fieldCells},queryCells:function(e){return F.queryCells(this,e)},getFirstCell:function(){return this.getFieldCells()[0]},getCellText:function(e){return m.getFieldCellValue(e)},renderCell:function(e){this._renderFieldContent(e)},getInfographicJson:function(){var e=this.getFirstCell();return m.isInfographicCell(e)?m.getFieldInfo(e).infographicJson:null},getOverFieldCell:function(e){return F.getOverFieldCell(this,e)},getBackgroundFloatingCells:function(e){return this._getFloatingCells(this.backgroundFloatingTablesSection,e)},getForegroundFloatingCells:function(e){return this._getFloatingCells(this.foregroundFloatingTablesSection,e)},_getFloatingCells:function(e,t){var i=[];return e?(e.getTables().forEach(function(e){i=i.concat(e.getFieldCells())}),t&&t.topFirst&&i.reverse(),i):i},getChartJson:function(){var e=this.getFirstCell();return m.isChartCell(e)?m.getFieldInfo(e).chartJson:null},toJson:function(){var e=this.getSettings();return e.id="table",e.data={data:this.store.data,columns:this.columns},["backgroundSection","foregroundSection","backgroundFloatingTablesSection","foregroundFloatingTablesSection"].forEach(function(t){var i=this[t];if(i){var n=i.toJson();n.stack.length&&(e[t+"Json"]=n)}},this),t.clone(e)},fromJson:function(e){e&&e.data&&(this.columns=e.data.columns||[],this.store=new o({data:e.data.data||[],idProperty:"id"}),this.backgroundSectionJson=e.backgroundSectionJson,this.foregroundSectionJson=e.foregroundSectionJson,this.refresh())},notifyShown:function(){this.getFieldCells().forEach(function(e){e.notifyShown(),e.content&&e.content.notifyShown&&e.content.notifyShown()}),this.backgroundSection&&this.backgroundSection.notifyShown(),this.backgroundFloatingTablesSection&&this.backgroundFloatingTablesSection.notifyShown(),this.foregroundFloatingTablesSection&&this.foregroundFloatingTablesSection.notifyShown(),this.foregroundSection&&this.foregroundSection.notifyShown()},onContentLoadingStart:function(){},onContentLoadingEnd:function(){},onRequestScaleToFitHeight:function(){},_destroyTableContent:function(){this._renderInfo=null,this._fieldCells=this._fieldCells||[],this._fieldCells.forEach(function(e){e.parentGrid=null,e.gridData=null,e.column=null,e.destroy()}),this._fieldCells.length=0,this.backgroundSection&&this.backgroundSection.destroy(),this.backgroundSection=null,this.backgroundFloatingTablesSection&&this.backgroundFloatingTablesSection.destroy(),this.backgroundFloatingTablesSection=null,this.foregroundFloatingTablesSection&&this.foregroundFloatingTablesSection.destroy(),this.foregroundFloatingTablesSection=null,this.foregroundSection&&this.foregroundSection.destroy(),this.foregroundSection=null,this._asyncQueue&&this._asyncQueue.destroy(),this._asyncQueue=null},destroy:function(){this._destroyTableContent(),this.viewModel=null,this.theme=null,this.store=null,this.columns=null,this.parentWidget=null,this.parentElementInPageInfo=null,this.viewPortContainer=null,this.parentGrid=null,this.reportContainerPageNode=null,this.inherited(arguments)}})});