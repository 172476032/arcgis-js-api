// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/on","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dijit/_WidgetBase","dijit/_TemplatedMixin","./_GridHighlightSupport","./ValueField","./coreUtils/GridBorderUtil","./coreUtils/GridDataUtil","./coreUtils/GridQueryUtil","./coreUtils/GridLayoutCalculator","./coreUtils/GridCellRenderer","./coreUtils/GridStyleUtil","./coreUtils/GridSortUtil","../themes/BorderStyles","esri/dijit/geoenrichment/utils/DomUtil"],function(e,t,i,n,s,o,l,r,d,h,a,u,c,f,g,m,_,C,w,p){var F={defaultRowHeight:15.33,rowMinHeight:3,columnMinWidth:3,defaultChartRowHeight:150};return e([r,d,h],{templateString:"<div class='esriGEAdjustableGrid'><div data-dojo-attach-point='mainNode' class='adjustableGridMainNode'></div></div>",viewModel:null,themeContext:null,theme:null,columns:null,store:null,getPreviewValueFunction:null,previewFeatureIndex:null,fixedViewMode:null,fieldCellClass:null,applyThemeStyle:!0,layoutDefaults:null,renderBordersFromTheme:!1,inheritThemeBackground:!0,renderCellBackground:!0,stickToRight:!1,looseResize:!1,keepGridSizeWhenResized:!1,allowSorting:!1,trimTextIfOverflows:!1,_cellRenderer:null,_createdFlag:!1,_fieldCells:null,_dynamicBindings:null,_isBeingResizedFlag:!1,postCreate:function(){this.inherited(arguments),this.layoutDefaults=t.mixin({},F,this.layoutDefaults),this._createdFlag=!0,this.setViewMode(null)},_renderInfo:null,refresh:function(e){this.domNode&&(e=e||{},g.markAsDirty(this),e.preserveFocus||e.preserveFocusAll?this.__refreshAndPreserveFocus(e):this.__simpleRefresh(e),C.updateSorting(this,e.applyCurrentSorting!==!1))},__simpleRefresh:function(e){if(this.mainNode){e=e||{};if(this.store&&this._createdFlag){if(this._destroyFields(),s.empty(this.mainNode),this.isEmptyTable())return void s.create("div",{"class":"adjustableGrid_emptyRow"},this.mainNode);g.recalcRows(this),void 0===e.stickToRight&&(e.stickToRight=this.stickToRight),g.recalcColumns(this,e),g.autoSnapLayout(this),this._renderStoreData(),this._processEdgeCells(),u.renderBorder(this,this._renderInfo),g.positionCells(this)}}},__refreshAndPreserveFocus:function(e){this.__simpleRefresh(e)},getVisualState:function(){return{sorting:C.getSorting(this),cells:this.getFieldCells().map(function(e){return e.content&&e.content.getVisualState&&e.content.getVisualState()})}},setVisualState:function(e){if(e&&(e.sorting&&C.setSorting(this,e.sorting),e.cells)){var t=this.getFieldCells();e.cells.length==t.length&&t.forEach(function(t,i){t.content&&t.content.setVisualState&&t.content.setVisualState(e.cells[i])})}},_renderStoreData:function(){var e=this,t=!0;this.store.data.forEach(function(i){e.columns.forEach(function(n,s){if(!(i.excludedIndexHorizontal&&i.excludedIndexHorizontal[s]||i.excludedIndexVertical&&i.excludedIndexVertical[s])){var o=n.index+(c.getDataColumnSpan(i,n.field)||1)==e.columns.length,l=i.index+(c.getDataRowSpan(i,n.field)||1)==e.store.data.length;e._createField(i,n,t,o,l)}}),t=!t})},_processEdgeCells:function(){this._renderInfo={firstInRowCells:[],firstInColumnCells:[],lastInRowCells:[],lastInColumnCells:[]};var e=[],t=[];this._fieldCells.forEach(function(i){e[i.gridData.index]=e[i.gridData.index]||[],e[i.gridData.index][i.column.index]=i,t[i.column.index]=t[i.column.index]||[],t[i.column.index][i.gridData.index]=i});var i=this;e.forEach(function(t,s){e[s][0]&&i._renderInfo.firstInRowCells.push(e[s][0]);var o=e[s][e[s].length-1];(o.column.index==i.columns.length-1||o.column.index+c.getColumnSpan(o)==i.columns.length)&&(n.add(o.domNode,"lastInRow"),i._renderInfo.lastInRowCells.push(o))}),t.forEach(function(e,s){t[s][0]&&i._renderInfo.firstInColumnCells.push(t[s][0]);var o=t[s][t[s].length-1];n.add(o.domNode,"lastRow"),i._renderInfo.lastInColumnCells.push(o)})},_destroyFields:function(){this._renderInfo=null,this._fieldCells=this._fieldCells||[],this._fieldCells.forEach(function(e){e.parentGrid=null,e.gridData=null,e.column=null,e.destroy()}),this._fieldCells.length=0},_getFieldClass:function(){return a},_createField:function(e,t,i,s,o){var r=this,d={fieldStyle:_.combineCellStyle(this,e,t),"class":"adjustableGridField",fieldCellClass:this.fieldCellClass,trimTextIfOverflows:this.trimTextIfOverflows,rowId:e.id,columnId:t.id,parentGrid:this,uniqueId:e.id+t.id,gridData:e,column:t,isOddRow:i,getBorders:function(){return r._getFieldCellBorders(s,o)}},h=this._doCreateFieldFromParams(d,e,t,i);return l.set(h.domNode,"position","absolute"),this._renderFieldContent(h),n.add(h.domNode,"adjustableGrid_cell field-"+t.field),this._fieldCells.push(h),this._postCreateFieldCell(h),h},_doCreateFieldFromParams:function(e,t,i,n){return(new this._getFieldClass)(e).placeAt(this.mainNode)},_postCreateFieldCell:function(e){},_getFieldCellBorders:function(e,t){var i="_fieldCellBorders"+!!e+!!t;return this[i]=this[i]||{outer:{t:1,b:t?1:0,l:1,r:e?1:0},inner:{t:1,b:1,l:1,r:1}}},_preRenderFieldCell:function(e){},_postRenderFieldCell:function(e){},_renderFieldContent:function(e){this._preRenderFieldCell(e),this._getCellRenderer().renderCellContent(e),this._configureRenderedCellContentSpecificStyles(e),this._postRenderFieldCell(e)},_configureRenderedCellContentSpecificStyles:function(e){n[c.isVariableFieldCell(e)?"add":"remove"](e.domNode,"hasVariableFieldInfo"),n[c.getConditionalFormatting(e)?"add":"remove"](e.domNode,"hasConditionalFormatting")},_getCellRenderer:function(){return this._cellRenderer||(this._cellRenderer=new m),this._cellRenderer},_setCellWidth:function(e,t){g.adjustColumnWidth(this,e.gridData,e.column,t),g.positionCells(this)},_setCellHeight:function(e,t){g.adjustRowHeight(this,e.gridData,e.column.field,t),g.positionCells(this)},setCellWidth:function(e,t){this._setCellWidth(e,t)},setCellHeight:function(e,t){this._setCellHeight(e,t)},_maxWidth:500,_width:500,_height:0,_spaceAfter:0,_maxHeight:0,getMaxHeight:function(e){return this._maxHeight},setMaxHeight:function(e){this._maxHeight=e},getHeight:function(e,t){return l.get(this.domNode,"height")+(t!==!1?l.get(this.domNode,"top"):0)+(e?this._spaceAfter||0:0)},getMaxWidth:function(){return this._maxWidth},setMaxWidth:function(e,t){var i=0;if(t&&t.preserveRightOffset){g.recalcGridWidth(this);var n=this.getAllowedWidth();i=(n-this._width)/n}this._maxWidth=e,t&&t.resizeToFitAllowedWidth&&this.resizeToFitAllowedWidth({rightOffsetWeight:t.preserveRightOffset?i:0})},setSpaceAfter:function(e){this._spaceAfter=e},getAllowedWidth:function(){return this._maxWidth-l.get(this.domNode,"left")},getAllowedWidthFromParent:function(){return l.get(this.domNode.parentNode,"width")-l.get(this.domNode,"left")},getTableBox:function(){var e=this.getSettings().style;return{l:e.left,t:e.spaceBefore,w:e.width,h:this.getHeight(!1,!1)}},getDomPosition:function(){return p.position(this.domNode)},resizeToFitAllowedWidth:function(e){},resizeToFitWidth:function(e){},resizeToFitHeight:function(e,t){},scaleProportionallyWithinParent:function(e){},collapseContent:function(){this.getFieldCells().forEach(function(e){e.content&&e.content.collapseContent&&e.content.collapseContent()})},hasHiddenContent:function(){return this._checkNeedResizeRowHeightToShowCellsContent(!1)},resizeRowHeightToShowCellsContent:function(){this._checkNeedResizeRowHeightToShowCellsContent(!0)},_checkNeedResizeRowHeightToShowCellsContent:function(e){var t,i=this;return this.getFieldCells().forEach(function(n){if(n.content&&n.content.getPreferredHeight){var s=n.content.getPreferredHeight();s>n.getHeight()&&(e&&(s&&(s+=10),i._setCellHeight(n,s)),t=!0)}}),t},_tableAttributes:null,setSettings:function(e){var t,i=l.get(this.domNode,"left");if(this.columns.forEach(function(e){e.style&&"number"==typeof e.style.width&&(e._wasBeforeRecalc=!0)}),e.style){void 0!==e.style.left&&l.set(this.domNode,"left",e.style.left+"px"),void 0!==e.style.spaceBefore&&l.set(this.domNode,"top",e.style.spaceBefore+"px"),void 0!==e.style.spaceAfter&&(this._spaceAfter=e.style.spaceAfter),e.style.width&&(this._width=e.style.width);var n=this._width;this._width=Math.min(this._width,this.getAllowedWidth()),(this._width!=n||i!=l.get(this.domNode,"left"))&&(t=!0)}e.attributes&&(this._adjustColumnsForSettings(e)&&(t=!0),this._tableAttributes=e.attributes,this._tableAttributes.rowCount&&this._tableAttributes.rowCount!==this.store.data.length&&this._adjustRowsForSettings(e),delete this._tableAttributes.rowCount,delete this._tableAttributes.columnCount),void 0!==e.scaleToFitWidth&&(this._scaleToFitWidth=e.scaleToFitWidth),void 0!==e.scaleToFitHeight&&(this._scaleToFitHeight=e.scaleToFitHeight),this._tableAttributes=this._tableAttributes||{};var s=[];this.columns.forEach(function(e){e._wasBeforeRecalc&&s.push(e),delete e._wasBeforeRecalc}),this.viewModel.dynamicReportInfo&&this.getNumDynamicColumns()?(g.trimColumnsForNumberOfFeatures(this),this.refresh({resetWidth:!0})):this.viewModel.dynamicReportInfo&&this.getNumDynamicRows()?(g.adjustRowsForNumberOfFeatures(this),this.refresh()):t?this.refresh({resetWidth:!0,columnsToPreserve:s}):this.refresh()},_adjustColumnsForSettings:function(e){return!1},_adjustRowsForSettings:function(e){},getSettings:function(){return g.recalcGridWidth(this),{style:{width:this._width,left:l.get(this.domNode,"left"),spaceBefore:l.get(this.domNode,"top"),spaceAfter:this._spaceAfter},attributes:t.mixin(t.clone(this._tableAttributes),{columnCount:this.columns.length,rowCount:this.store.data.length}),scaleToFitWidth:this._scaleToFitWidth,scaleToFitHeight:this._scaleToFitHeight}},needScaleToFitWidth:function(){return this._scaleToFitWidth},needScaleToFitHeight:function(){return this._scaleToFitHeight},isEmptyTable:function(){return!(this.columns&&this.columns.length&&this.store&&this.store.data.length)},isMultiFeatureTable:function(){return!!this.getNumDynamicColumns()||!!this.getNumDynamicRows()},getNumFixedColumns:function(){return this._tableAttributes&&this._tableAttributes.fixedColumns||0},setNumFixedColumns:function(e){this._tableAttributes.fixedColumns=e},getNumDynamicColumns:function(){return this._tableAttributes&&this._tableAttributes.dynamicColumns||0},setNumDynamicColumns:function(e){this._tableAttributes.dynamicColumns=e},getNumFixedRows:function(){return this._tableAttributes&&this._tableAttributes.fixedRows||0},setNumFixedRows:function(e){this._tableAttributes.fixedRows=e},getNumDynamicRows:function(){return this._tableAttributes&&this._tableAttributes.dynamicRows||0},setNumDynamicRows:function(e){this._tableAttributes.dynamicRows=e},_viewMode:null,_specificViewMode:null,getViewMode:function(){return this._viewMode},getSpecificViewMode:function(){return this._specificViewMode},setViewMode:function(e,t){var i=this;e=this.fixedViewMode||e,this._viewMode=e,void 0!==t&&(this._specificViewMode=t),"edit"==e?(n.add(this.domNode,"adjustableGridEditMode"),n.remove(this.domNode,"adjustableGridPreviewMode")):(n.remove(this.domNode,"adjustableGridEditMode"),n.add(this.domNode,"adjustableGridPreviewMode")),this._fieldCells&&this._fieldCells.forEach(function(t){t.content&&t.content.setViewMode&&t.content.setViewMode(e,i._specificViewMode),i._getCellRenderer().updateViewMode(t)})},getFieldCells:function(){return this._fieldCells},getFirstCell:function(){return this.getFieldCells()[0]},getCellText:function(e){return c.getFieldCellText(e)},renderCell:function(e){this._renderFieldContent(e)},getInfographicJson:function(){var e=this.getFirstCell();return c.isInfographicCell(e)?c.getFieldInfo(e).infographicJson:null},getChartJson:function(){var e=this.getFirstCell();return c.isChartCell(e)?c.getFieldInfo(e).chartJson:null},toJson:function(){var e=this.getSettings();return e.id="table",e.data={data:this.store.data,columns:this.columns},t.clone(e)},notifyShown:function(){this.getFieldCells().forEach(function(e){e.content&&e.content.notifyShown&&e.content.notifyShown()})},onContentLoadingStart:function(){},onContentLoadingEnd:function(){},onRequestScaleToFitHeight:function(){},destroy:function(){this._destroyFields(),this.inherited(arguments)}})});