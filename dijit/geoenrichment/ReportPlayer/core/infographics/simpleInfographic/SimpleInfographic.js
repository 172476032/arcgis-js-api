// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.25/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-construct","dojo/dom-style","dijit/_WidgetBase","dijit/_TemplatedMixin","./_DataDrillingSupport","./_DDSlideAnimationSupport","./_DDZoomAnimationSupport","./SimpleInfographicViewModes","esri/dijit/geoenrichment/_Invoke","../utils/InfographicLayoutResizer","../utils/InfographicJsonConversionUtil","../utils/InfographicThemeUtil","../../supportClasses/TableUtil","../../sections/supportClasses/InfographicValueController","../dataDrilling/DataDrillingAnimationTypes","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ViewModes","dojo/text!../../templates/SimpleInfographic.html"],function(e,t,i,n,o,s,r,a,h,l,c,d,u,p,g,f,_,m,y,I){function w(e){return e&&e.shape&&e.shape.shapeJson.showAsBar}function S(e,t,i){return void 0===i?e===t:Number(Number(e).toFixed(i))===Number(Number(t).toFixed(i))}return e([o,s,c,r,a,h],{templateString:I,viewModel:null,theme:null,parentWidget:null,isEditMode:!1,adjustElementsWhenResized:!1,dataDrillingAnimationType:_.ZOOM,_sections:null,_currentInfographicJson:null,postCreate:function(){this.inherited(arguments),this._setViewMode(l.VIEW_MAIN)},_destroySections:function(){this._destroyDrillingSections(),this._destroyDrillingSectionsButtons(),this._sections=this._sections||[],this._sections.forEach(function(e){e.destroy()}),this._sections.length=0,this.domNode&&i.empty(this.mainViewDiv)},updateInfographic:function(e){this.domNode&&(this._currentInfographicJson=this._applyThemeToJson(e),this._doUpdateInfographic())},refresh:function(){this.updateInfographic(this._currentInfographicJson)},_doUpdateInfographic:function(){var e=this;if(this.domNode){this._destroySections();var t=this._currentInfographicJson;this._syncJsonDimensions();var i=this.viewModel.getStaticInfographicDefaultStyles(this.theme);n.set(this.domNode,"backgroundColor",t.style.backgroundColor||i&&i.backgroundColor),n.set(this.domNode,{width:t.style.width+"px",height:t.style.height+"px"}),this._preRender(),this._renderHeader(),this._renderVariableTables(),this._sections.forEach(function(t){t.setViewMode(e.isEditMode?y.EDIT:y.PREVIEW_VALUES)}),this._postRender()}},_syncJsonDimensions:function(){!(this._currentInfographicJson&&this.width&&this.height)||S(this._currentInfographicJson.style.width,this.width,1)&&S(this._currentInfographicJson.style.height,this.height,1)||d.resizeLayout(this._currentInfographicJson,this.width,this.height,{preserveContentSizes:!this.adjustElementsWhenResized,usePrettyBox:!this.adjustElementsWhenResized,updateFontSize:this.adjustElementsWhenResized})},_infographicViewController:null,_preRender:function(){this._infographicViewController=new f;var e=this._currentInfographicJson.variableTables.filter(w);this._infographicViewController.setVariableTables(e)},_renderHeader:function(){if(this._currentInfographicJson.header){var e=this._currentInfographicJson.header;this._createSection(g.getTableWidth(e),g.getTableHeight(e),[e],e.style,null,-1,null)}},_renderVariableTables:function(){var e=this;this._currentInfographicJson.variableTables.forEach(function(t,i){var n=u.variableTableToNormalTables(t);e._createSection(t.style.width,t.style.height,n.tableJsons,t.style,t,i,n)})},_prepareSectionCreationParams:function(e,t){return null},_createSection:function(e,i,o,s,r,a,h){var l=-1===a,c={};c.class="infographicContainer_Section",c.initialWidth=e,c.json={type:m.DETAILS,stack:o},c.viewModel=this.viewModel,c.theme=this.theme,c.parentWidget=this,c.tableClass="infographicContainerTable",c.hasFixedLayout=!1,c.isInfographicSection=!0,c.isInfographicHeaderSection=l,c.infographicViewController=w(r)&&this._infographicViewController,t.mixin(c,this._prepareSectionCreationParams(r,l));var d=this.viewModel.layoutBuilder.createElement("section",c,this.mainViewDiv);return d.setResizedHeight(i),n.set(d.domNode,{position:"absolute",left:(s.left||0)+"px",top:(s.spaceBefore||s.top||0)+"px"}),this._sections.push(d),this.viewModel.dynamicReportInfo&&this.viewModel.enableDataDrilling&&h&&this._addDataDrillingHandlers(d,d.getTables()[h.variableIndex]),d},_postRender:function(){},_mode:null,_setViewMode:function(e,t,i){switch(this.dataDrillingAnimationType){case _.SLIDE:return this._showSlideTransition(e,t);case _.ZOOM:return this._showZoomTransition(e,t,i)}},getVisualState:function(){return{dataDrilling:this._mode===l.VIEW_DATA_DRILLING?this._getDataDrillingState():null}},setVisualState:function(e){e&&e.dataDrilling&&this._setDataDrillingState(e.dataDrilling)},_applyThemeToJson:function(e){var t=this.viewModel.getStaticInfographicDefaultStyles(this.theme);return p.applyThemeSettingsToJson(e,t)},notifyShown:function(){this._sections.forEach(function(e){e.notifyShown()})},width:null,height:null,resize:function(e,t){this.width&&this.height&&this._currentInfographicJson&&this._currentInfographicJson.style.width===e&&this._currentInfographicJson.style.height===t||(this.width=e,this.height=t,this._syncJsonDimensions(),this.invoke("_doResize",50))},_doResize:function(){this._doUpdateInfographic()},toJson:function(){return t.clone(this._currentInfographicJson)},onViewModeChanged:function(e){},destroy:function(){this._destroySections(),this.inherited(arguments)}})});