// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/on","dojo/when","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/query","esri/dijit/geoenrichment/FlowList","./SimpleInfographicViewModes","../../grid/coreUtils/GridDataUtil","../dataDrilling/DataDrillingLibrary","../dataDrilling/DataDrillingAnimationTypes","esri/dijit/geoenrichment/utils/DelayUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/MouseUtil","esri/dijit/geoenrichment/utils/PopupUtil","esri/dijit/geoenrichment/utils/TooltipUtil","esri/dijit/geoenrichment/utils/WaitingUtil","../../sections/SectionTypes","../../supportClasses/ViewModes","./DataDrillingBackgroundUtil","./DataDrillingExportUtil","dojo/i18n!../../../../../../nls/jsapi"],function(i,t,e,n,o,l,a,s,r,d,c,h,g,D,u,p,_,f,m,S,w,y,I,v){v=v.geoenrichment.dijit.ReportPlayer.Infographics;var C={w:700,h:600},O=i(r.itemRenderers.DefaultItemRenderer,{createLabelNode:!0,labelClass:"TrimWithEllipses esriGEReportPlayerTabs_label"});return i(null,{drillingOptionsList:null,_drillingSections:null,_drillingSectionsButtons:null,postCreate:function(){var i=this;this.inherited(arguments),t(this.backToMainViewButton,"click",function(){i._setViewMode(d.VIEW_MAIN,!0)}),this.viewModel.dynamicReportInfo&&(I.canPrintDataDrilling(this)&&(f.setTooltipToNode(this.printButton,v.printInfographic),n.add(this.dataDrillingViewDiv,"canPrintDataDrilling"),t(this.printButton,"click",function(){I.printDataDrilling(i)})),I.canExportDataDrilling(this)&&(f.setTooltipToNode(this.exportButton,v.exportInfographic),n.add(this.dataDrillingViewDiv,"canExportDataDrilling"),t(this.exportButton,"click",function(){I.exportDataDrilling(i)})))},_getCountryID:function(){return this.viewModel.dynamicReportInfo.infographicOptions.countryID},_addDataDrillingHandlers:function(i,e){var n=this,l=c.getFieldInfo(e.getFieldCells()[0]),s=this._getDDValue(l),r=s&&"object"==typeof s?s:null,g="standard"===s&&h.hasDrillingOptions(this._getCountryID(),l);(r||g)&&i.own(t.once(this.domNode,"mouseover",function(){var e=o.create("div",{class:"simpleInfographic_drillDataButton"},i.domNode);o.create("div",{class:"dijitInline simpleInfographic_drillDataButtonIcon esriGESpaceAfterBig"},e),o.create("div",{class:"dijitInline simpleInfographic_drillDataButtonLabel",innerHTML:v.drillForMoreData},e),t(e,"click",function(){n._selectedOptionsCache=n._selectedOptionsCache||{};var i=n._selectedOptionsCache[l.variableID]||0,t=n._setViewMode(d.VIEW_DATA_DRILLING,!0,e);r?n._renderCustomSectionJson(r,l,t):(n._loadDataDrillingOptionsList(l),n.drillingOptionsList.setSelectedIndex(i),n._loadDataDrillingView(l,n.drillingOptionsList.selectedItem.label,null,null,t))}),n._drillingSectionsButtons.push({destroy:function(){o.destroy(e)}});var s=[];i.getTables().forEach(function(i){s.push(i.domNode)});var c=u.intersectNodeBoxes(s,i.domNode);a.set(e,{left:c.x+"px",top:c.y+"px",width:c.w+"px",height:c.h+"px",lineHeight:c.h+"px"});var h=u.position(e);h.w>c.w&&a.set(e,"left",c.x-(h.w-c.w)/2+"px")}))},_getDDValue:function(i){return i&&this._currentInfographicJson.dataDrilling&&this._currentInfographicJson.dataDrilling[i.templateName]},_selectedOptionsCache:null,_createDrillingOptionsList:function(i){this._selectedOptionsCache=this._selectedOptionsCache||{};var t=new r({class:"simpleInfographic_drillingOptionsList",itemRenderer:new O});return this.own(t),_.makePopup(t,this,i,{orient:["before","below"]}),t},_updateDrillingOptionsListWithFieldInfo:function(i,t){var e=this;i.onChange=function(){_.close(i),e._selectedOptionsCache[t.variableID]=i.selectedIndex,e._setViewMode(d.VIEW_DATA_DRILLING,!0),e._loadDataDrillingView(t,i.selectedItem.label)};var n=h.getDrillingOptions(this._getCountryID(),t)||[],o=n.map(function(i,t){return{label:i.name,value:t}});i.setItems(o)},_loadDataDrillingOptionsList:function(i){this.drillingOptionsList||(this.drillingOptionsList=this._createDrillingOptionsList(this.drillingOptionsButton)),this._updateDrillingOptionsListWithFieldInfo(this.drillingOptionsList,i),n[this.drillingOptionsList.items.length>1?"add":"remove"](this.dataDrillingViewDiv,"hasMultipleDrillingOptions")},_dataDrillingState:null,_loadDataDrillingView:function(i,t,n,o,l){var a=this;return this._dataDrillingState={fieldInfo:i,optionName:t,calcState:n,sectionVisualState:o},this._destroyDrillingSections(),this._showDDProgress(!0),e(function(){var o=a._getDataDrillingPanelDimensions(),l=h.getDrillingOptionInfo(a._getCountryID(),i,t,o.w,o.h,n),s=l.enrichInfos;return e(s&&s.length&&a.viewModel.enrichFieldData(s),function(){return l})}(),function(s){return e(a._renderStandardOptionInfo(s,i,l,t,n,o),function(){a._showDDProgress(!1)})})},_renderStandardOptionInfo:function(i,t,n,o,l,a){var s,r=this;this._destroyDrillingSections();var d=this._getDataDrillingPanelSectionParams();return d.json={type:S.DETAILS,stack:[i.tableJson]},d.calculationStatesGroup=i.calculationStatesGroup,d.onCalculationStateChanged=function(i){r._loadDataDrillingView(t,o,i,s.getVisualState())},e(n,function(){return D.delay(function(){return s=r._createDataDrillingSection(d),s.fitContentNicely(),s.domNode.style.opacity="0.01",D.delay(function(){s.setVisualState(a),s.domNode.style.opacity=""},100)})})},_renderCustomSectionJson:function(i,t,n,o,l){var a=this;this._destroyDrillingSections(),this._loadDataDrillingOptionsList(null),this._dataDrillingState=null;var s,r=this._getDataDrillingPanelSectionParams();return r.json=i.sectionJson,i.states&&(r.calculationStatesGroup=h.createCalculationStatesGroup(i.states),r.onCalculationStateChanged=function(e){a._renderCustomSectionJson(i,t,null,e,s.getVisualState())}),this._showDDProgress(!0),e(n,function(){return D.delay(function(){return s=a._createDataDrillingSection(r),s.fitContentNicely(),s.domNode.style.opacity="0.01",D.delay(function(){s.setVisualState(l),s.domNode.style.opacity="",a._showDDProgress(!1)})})})},_getDataDrillingPanelSectionParams:function(){var i={};return i.class="infographicContainer_Section infographicContainer_dataDrillingSection",i.initialWidth=this._getDataDrillingPanelDimensions().w,i.viewModel=this.viewModel,i.theme=this.theme,i.parentWidget=this,i.tableClass="infographicContainerTable",i.hasFixedLayout=!1,i},_createDataDrillingSection:function(i){var t=this.viewModel.layoutBuilder.createElement("section",i,this.drilledDataViewDiv);return this._drillingSections.push(t),t.setViewMode(w.PREVIEW_VALUES),t.setResizedHeight(this._getDataDrillingPanelDimensions().h),n[s(".sectionDynamicSettings_settingsButton",this.dataDrillingViewDiv)[0]?"add":"remove"](this.dataDrillingViewDiv,"hasChartSettingsButton"),this.dataDrillingAnimationType===g.ZOOM&&this._setUpDDPanelBackgroundColor(),t},_setUpDDPanelBackgroundColor:function(){y.setUpDDPanelBackgroundColor({viewModel:this.viewModel,theme:this.theme,infographicJson:this._currentInfographicJson,node:this.dataDrillingViewDiv})},_getDataDrillingPanelDimensions:function(){switch(this.dataDrillingAnimationType){case g.ZOOM:return C;default:return{w:this.width,h:this.height}}},_showDDProgress:function(i){var t=this.dataDrillingAnimationType===g.SLIDE?this.domNode:this.dataDrillingViewDiv;m[i?"showProgress":"removeProgress"](t)},_getDataDrillingState:function(){return this._dataDrillingState},_setDataDrillingState:function(i){i&&this._loadDataDrillingView(i.fieldInfo,i.optionName,i.calcState,i.sectionVisualState)},_destroyDrillingSections:function(){this._drillingSections=this._drillingSections||[],this._drillingSections.forEach(function(i){i.destroy()}),this._drillingSections.length=0,this.domNode&&o.empty(this.drilledDataViewDiv)},_destroyDrillingSectionsButtons:function(){this._drillingSectionsButtons=this._drillingSectionsButtons||[],this._drillingSectionsButtons.forEach(function(i){i.destroy()}),this._drillingSectionsButtons.length=0}})});