// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/on","dojo/when","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/query","./SimpleInfographicViewModes","../../grid/coreUtils/GridDataUtil","../dataDrilling/DataDrillingLibrary","../dataDrilling/DataDrillingAnimationTypes","../utils/InfographicJsonUtil","esri/dijit/geoenrichment/utils/DelayUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/TooltipUtil","esri/dijit/geoenrichment/utils/WaitingUtil","../../sections/SectionTypes","../../supportClasses/ViewModes","./DataDrillingBackgroundUtil","./DataDrillingExportUtil","dojo/i18n!esri/nls/jsapi"],function(i,t,n,e,o,a,l,r,s,c,d,u,D,g,h,f,p,m,S,_,I){I=I.geoenrichment.dijit.ReportPlayer.Infographics;var w={w:700,h:600};return i(null,{_drillingSections:null,_drillingSectionsButtons:null,postCreate:function(){var i=this;this.inherited(arguments),t(this.backToMainViewButton,"click",function(){i._setViewMode(r.VIEW_MAIN,!0)}),this.viewModel.dynamicReportInfo&&(_.canPrintDataDrilling(this)&&(h.setTooltipToNode(this.printButton,I.printInfographic),e.add(this.dataDrillingViewDiv,"canPrintDataDrilling"),t(this.printButton,"click",function(){_.printDataDrilling(i)})),_.canExportDataDrilling(this)&&(h.setTooltipToNode(this.exportButton,I.exportInfographic),e.add(this.dataDrillingViewDiv,"canExportDataDrilling"),t(this.exportButton,"click",function(){_.exportDataDrilling(i)})))},_getCountryID:function(){return this.viewModel.dynamicReportInfo.infographicOptions.countryID},_addDataDrillingHandlers:function(i,n){var e=this,l=s.getFieldInfo(n.getFirstCell()),d=u.getDataDrilling(this._currentInfographicJson,l.templateName),D=d&&d.sectionJson?d:null,f=d&&d.isStandard&&c.getDrillingOptions(this._getCountryID(),d.standardId||l),p=f&&f[0];(D||p)&&(i.getTables().forEach(function(i){i.getFieldCells().forEach(function(i){h.setTooltipToNode(i.domNode,null)})}),i.own(t.once(this.domNode,"mouseover",function(){var n=o.create("div",{class:"simpleInfographic_drillDataButton"},i.domNode);o.create("div",{class:"dijitInline simpleInfographic_drillDataButtonIcon esriGESpaceAfterBig"},n);var s=o.create("div",{class:"dijitInline simpleInfographic_drillDataButtonLabel",innerHTML:I.drillForMoreData},n);t(n,"click",function(){var i=e._setViewMode(r.VIEW_DATA_DRILLING,!0,n);D?e._renderCustomSectionJson({customDDPanelInfo:D,fieldInfo:l,animationPromise:i}):e._loadStandardDataDrillingView({fieldInfo:l,optionName:p.name,calcState:null,sectionVisualState:null,animationPromise:i})}),e._drillingSectionsButtons.push({destroy:function(){o.destroy(n)}});var c=[];i.getTables().forEach(function(i){c.push(i.domNode)});var d=g.uniteNodeBoxes(c,i.domNode);a.set(n,{left:d.x+"px",top:d.y+"px",width:d.w+"px",height:d.h+"px",lineHeight:d.h+"px"});var u=g.position(n);u.w>d.w&&a.set(n,"left",d.x-(u.w-d.w)/2+"px"),s.style.maxWidth=d.w-70+"px",s.style.whiteSpace="normal",s.style.lineHeight="20px"})))},_dataDrillingState:null,_loadStandardDataDrillingView:function(i){var t=i.fieldInfo,e=i.optionName,o=i.calcState,a=i.sectionVisualState,l=i.animationPromise,r=this;return this._dataDrillingState={fieldInfo:t,optionName:e,calcState:o,sectionVisualState:a},this._destroyDrillingSections(),this._showDDProgress(!0),n(function(){var i=r._getDataDrillingPanelDimensions(),a=u.getDataDrilling(r._currentInfographicJson,t.templateName),l=c.getDrillingOptionInfo(r._getCountryID(),a.standardId||t,e,i.w,i.h,o),s=l.enrichInfos;return n(s&&s.length&&r.viewModel.enrichFieldData(s),function(){return l})}(),function(i){return n(r._renderStandardOptionInfo({drillingDataOptionInfo:i,fieldInfo:t,animationPromise:l,optionName:e,calcState:o,sectionVisualState:a}),function(){r._showDDProgress(!1)})})},_renderStandardOptionInfo:function(i){var t,e=i.drillingDataOptionInfo,o=i.fieldInfo,a=i.animationPromise,l=i.optionName,r=(i.calcState,i.sectionVisualState),s=this;this._destroyDrillingSections();var c=this._getDataDrillingPanelSectionParams();return c.json={type:p.DETAILS,stack:[e.tableJson]},c.calculationStatesGroup=e.calculationStatesGroup,c.onCalculationStateChanged=function(i){s._loadStandardDataDrillingView({fieldInfo:o,optionName:l,calcState:i,sectionVisualState:t.getVisualState(),animationPromise:null})},n(a,function(){return D.delay(function(){return t=s._createDataDrillingSection(c),t.fitContentNicely(),t.domNode.style.opacity="0.01",D.delay(function(){t.setVisualState(r),t.domNode.style.opacity=""},100)})})},_renderCustomSectionJson:function(i){var t=i.customDDPanelInfo,e=(i.fieldInfo,i.animationPromise),o=(i.calcState,i.sectionVisualState),a=this;this._destroyDrillingSections(),this._dataDrillingState=null;var l,r=this._getDataDrillingPanelSectionParams();return r.json=t.sectionJson,this._showDDProgress(!0),n(e,function(){return D.delay(function(){return l=a._createDataDrillingSection(r),l.fitContentNicely(),l.domNode.style.opacity="0.01",D.delay(function(){l.setVisualState(o),l.domNode.style.opacity="",a._showDDProgress(!1)})})})},_getDataDrillingPanelSectionParams:function(){var i={};return i.class="infographicContainer_dataDrillingSection",i.initialWidth=this._getDataDrillingPanelDimensions().w,i.viewModel=this.viewModel,i.theme=this.theme,i.parentWidget=this,i.hasFixedLayout=!1,i.isDataDrillingView=!0,i.currentFeatureIndex=this.currentFeatureIndex||0,i.initialViewMode=m.PREVIEW_VALUES,i},_createDataDrillingSection:function(i){var t=this.viewModel.layoutBuilder.createElement("section",i,this.drilledDataViewDiv);return this._drillingSections.push(t),t.setResizedHeight(this._getDataDrillingPanelDimensions().h),e[l(".sectionDynamicSettings_settingsButton",this.dataDrillingViewDiv)[0]?"add":"remove"](this.dataDrillingViewDiv,"hasChartSettingsButton"),this.dataDrillingAnimationType===d.ZOOM&&this._setUpDDPanelBackgroundColor(),t},_setUpDDPanelBackgroundColor:function(){S.setUpDDPanelBackgroundColor({viewModel:this.viewModel,theme:this.theme,infographicJson:this._currentInfographicJson,node:this.dataDrillingViewDiv})},_getDataDrillingPanelDimensions:function(){switch(this.dataDrillingAnimationType){case d.ZOOM:return w;default:return{w:this.width,h:this.height}}},_showDDProgress:function(i){var t=this.dataDrillingAnimationType===d.SLIDE?this.domNode:this.dataDrillingViewDiv;f[i?"showProgress":"removeProgress"](t)},_getDataDrillingState:function(){return this._dataDrillingState},_setDataDrillingState:function(i){i&&this._loadStandardDataDrillingView({fieldInfo:i.fieldInfo,optionName:i.optionName,calcState:i.calcState,sectionVisualState:i.sectionVisualState,animationPromise:null})},_destroyDrillingSections:function(){this._drillingSections=this._drillingSections||[],this._drillingSections.forEach(function(i){i.destroy()}),this._drillingSections.length=0,this.domNode&&o.empty(this.drilledDataViewDiv)},_destroyDrillingSectionsButtons:function(){this._drillingSectionsButtons=this._drillingSectionsButtons||[],this._drillingSectionsButtons.forEach(function(i){i.destroy()}),this._drillingSectionsButtons.length=0}})});