// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.25/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dojo/on","dojox/uuid/generateRandomUuid","dijit/_WidgetBase","dijit/_TemplatedMixin","esri/dijit/geoenrichment/Pagination","esri/dijit/geoenrichment/utils/ColorUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/FitUtil","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ViewModes","../themes/BackgroundThemeUtil","../supportClasses/templateJsonUtils/query/TemplateJsonQueryUtil","../sections/sectionUtils/SectionJsonUtil","dojo/text!../templates/InfographicsPage.html","dojo/i18n!esri/nls/jsapi"],function(t,i,e,n,s,o,h,r,a,c,d,l,g,u,_,p,m,f,y,P){function M(t){if(t&&t.children)for(;t.children.length;)t.removeChild(t.children[0])}function v(t){var i=m.getParentBox(t);return i&&i.w?i:f.calcSectionJsonBox(t)}P=P.geoenrichment.dijit.ReportPlayer.Infographics;return t([a,c],{templateString:y,nls:P,viewModel:null,theme:null,parentWidget:null,keepPagePosition:!0,renderBackgroundImage:!1,scaleSectionsToFit:!1,pagination:null,_sections:null,_currentMinWidth:0,_currentMinHeight:0,postCreate:function(){this.inherited(arguments),this._sections=[],this._createPagination(),n[this.scaleSectionsToFit?"add":"remove"](this.domNode,"scaleSectionsToFit")},_createPagination:function(){var t=this;this.pagination=new d({createItemContainer:i.hitch(this,this._createItemContainer),updateItemContainer:i.hitch(this,this._updateItemContainer),onNodePreDestroy:M,onNodePlaced:i.hitch(this,this._onNodePlaced),scrollAnimation:"slide",cyclicPagination:!0,onPageChanged:function(){t.onPageIndexChanged(t.getCurrentPageIndex())}}).placeAt(this.paginationDiv),this.own(this.pagination),this.pagination.set("items",[]),this.pagination.startup()},_createItemContainer:function(){var t=s.create("div",{class:"infographicPage_infographicRoot"});return t.style.minWidth=this._currentMinWidth+"px",t.style.minHeight=this._currentMinHeight+"px",t},_sectionsHash:null,_getSectionByJson:function(t){return this.viewModel.dynamicReportInfo?(this._sectionsHash=this._sectionsHash||{},t._idInPagination||(t._idInPagination=r()),this._sectionsHash[t._idInPagination]):null},_putSectionToHash:function(t,i){this._sectionsHash&&(this._sectionsHash[i._idInPagination]=t)},_updateItemContainer:function(t,i){this._createSectionNode(t,i)},_createSectionNode:function(t,i){if(t&&t.parentNode){M(t),s.empty(t),t.style.minWidth="",t.style.minHeight="";var e=s.create("div",{class:"infographicPage_infographicRootSectionNode"},t),n=v(i);if(this.scaleSectionsToFit){t.style.width=this._currentMinWidth+2+"px",t.style.height=this._currentMinHeight+2+"px";var o=u.fitBox(n,{w:this._currentMinWidth,h:this._currentMinHeight});e.style.transform="scale("+o.ratio+")",e.style.webkitTransform="scale("+o.ratio+")",e.style.position="absolute",e.style.left=(this._currentMinWidth-n.w)/2+"px",e.style.top=(this._currentMinHeight-n.h)/2+"px"}else t.style.width=n.w+2+"px",t.style.height=n.h+2+"px";e.style.width=n.w+"px",e.style.height=n.h+"px";var h=this._getSectionByJson(i);if(h&&h.domNode)h.placeAt(e),g.isNodeInLayout(t)&&this._onNodePlaced(t,i);else{h&&h.destroy();var r={};r.class="adjustableGrid_inCellSection",r.json=i,r.viewModel=this.viewModel,r.theme=this.theme,r.parentWidget=this,r.initialWidth=n.w,r.hasFixedLayout=!1,h=this.viewModel.layoutBuilder.createElement("section",r,e),this._sections.push(h),h.setViewMode(_.PREVIEW_VALUES);var a=!m.getParentBox(i);h.setResizedHeight(n.h,{resizeContentProportionally:a}),h.setWidth(n.w,{resizeContentProportionally:a}),this._putSectionToHash(h,i)}return this._renderNodeBackground(e,i),h}},_renderNodeBackground:function(t,i){var e=m.getParentStyle(i),n=this.viewModel.getDocumentDefaultStyles(this.theme);if(this.renderBackgroundImage&&n){var o=s.create("div",{class:"esriGEAbsoluteStretched"},t,"first");p.applyBackgroundImageFromSettings(o,n.backgroundImage,{documentOptions:this.parentWidget.documentOptions,pos:v(i)})||(o.style.backgroundColor=e&&e.backgroundColor&&!l.isTransparent(e.backgroundColor)?e.backgroundColor:n.backgroundColor)}else t.style.backgroundColor=e&&e.backgroundColor},_currentSection:null,_onNodePlaced:function(t,i){var e=this._getSectionByJson(i);e&&e.notifyShown(),this._currentSection=e,this._isAutoResizeMode&&this._resizePaginationToFitSelectedElement(t)},getCurrentPageIndex:function(){return this.pagination.get("currentPage")},setCurrentPageIndex:function(t){this.pagination.set("currentPage",t)},showNextPage:function(){this.pagination.set("currentPage","next")},showPreviousPage:function(){this.pagination.set("currentPage","prev")},_prevPageState:null,_sectionJsons:null,getNumItems:function(){return this.pagination.items.length},setItems:function(t){return this._setItems(t)},_setItems:function(t,i){function n(){s._resizeContent(),o.resolve()}var s=this;this._sectionJsons=t;var o=new e,h=this._prevPageState===i&&this.keepPagePosition,r=this.pagination.get("currentPage");return this._calcMinWidthAndHeight(),this._destroySections(),this.pagination.set("items",t),this._prevPageState=i,g[t.length?"hide":"show"](this.emptyPlaceholderDiv),h?(this._resizeContent(),this.pagination.set("currentPage",Math.max(r,0)),setTimeout(n,100)):n(),o.promise},_calcMinWidthAndHeight:function(){this.scaleSectionsToFit?(this._currentMinWidth=this._width-120-2,this._currentMinHeight=this._height-60-2):(this._currentMinWidth=0,this._currentMinHeight=0,this._sectionJsons&&this._sectionJsons.forEach(function(t){var i=v(t);this._currentMinWidth=Math.max(this._currentMinWidth,i.w),this._currentMinHeight=Math.max(this._currentMinHeight,i.h)},this))},setHeight:function(t){this.domNode.style.height=t+"px"},_width:0,_height:0,_isAutoResizeMode:!0,_isResizing:!1,_pendingResizeNode:null,resize:function(t,i){this._width=t,this._height=i,this._resizeContent()},_checkAutoResizeMode:function(){this._isAutoResizeMode=0===this._width&&0===this._height},_resizeContent:function(){this._checkAutoResizeMode(),this._isResizing=!0,this._pendingResizeNode=null,this._isAutoResizeMode?(this.domNode.style.width="auto",this.domNode.style.height="auto",this.paginationDiv.style.width=this._currentMinWidth+"px",this.paginationDiv.style.height=this._currentMinHeight+"px",this.pagination.resize(),this.paginationDiv.style.width="auto",this.paginationDiv.style.height="auto"):(this._calcMinWidthAndHeight(),this.domNode.style.width=this._width+"px",this.domNode.style.height=this._height+"px",this.paginationDiv.style.width=this._width+"px",this.paginationDiv.style.height=this._height+"px",this.pagination.resize()),this._isResizing=!1,this._pendingResizeNode&&this._isAutoResizeMode?this._resizePaginationToFitSelectedElement(this._pendingResizeNode):this.onResized()},_resizePaginationToFitSelectedElement:function(t){if(this._isAutoResizeMode){if(this._isResizing)return void(this._pendingResizeNode=t);this._pendingResizeNode=null,this.paginationDiv.style.width=t.clientWidth+120+"px",this.paginationDiv.style.height=t.clientHeight+60+"px",this.onResized(!0)}},notifyShown:function(){this._currentSection&&this._currentSection.notifyShown()},onPageIndexChanged:function(t){},onResized:function(t){},_destroySections:function(){this._sections.forEach(function(t){t.destroy()}),this._sections.length=0},destroy:function(){this._destroySections(),this.inherited(arguments)}})});