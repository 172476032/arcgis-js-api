// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/on","dojo/when","dojo/dom-class","dojo/dom-construct","dojo/dom-geometry","dojo/dom-style","dojo/query","esri/dijit/geoenrichment/FlowList","../grid/coreUtils/GridDataUtil","./dataDrilling/DataDrillingLibrary","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/MouseUtil","esri/dijit/geoenrichment/utils/PopupUtil","esri/dijit/geoenrichment/utils/WaitingUtil","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes","dojo/i18n!../../../../../nls/jsapi"],function(i,t,e,n,l,o,s,a,r,d,c,h,g,u,p,D,m){m=m.geoenrichment.dijit.ReportPlayer.ReportPlayer;var _="viewMain",f="viewDataDrilling",S=i(r.itemRenderers.DefaultItemRenderer,{createLabelNode:!0,labelClass:"TrimWithEllipses esriGEReportPlayerTabs_label"}),v=i(null,{drillingOptionsList:null,_drillingSections:null,_drillingSectionsButtons:null,postCreate:function(){var i=this;this.inherited(arguments),t(this.backToMainViewButton,"click",function(){i._setViewMode(_,!0)})},_addDataDrillingHandlers:function(i,e){var n=this,o=d.getFieldInfo(e.getFieldCells()[0]);if(c.hasDrillingOptions(o)){var a=l.create("div",{"class":"simpleInfographic_drillDataButton"},i.domNode);l.create("div",{"class":"dijitInline simpleInfographic_drillDataButtonIcon esriGESpaceAfterBig"},a),l.create("div",{"class":"dijitInline simpleInfographic_drillDataButtonLabel",innerHTML:m.drillForMoreData},a),t.once(this.domNode,"mouseover",function(){var t=[];i.getTables().forEach(function(i){t.push(i.domNode)});var e=h.intersectNodeBoxes(t,i.domNode);s.set(a,{left:e.x+"px",top:e.y+"px",width:e.w+"px",height:e.h+"px",lineHeight:e.h+"px"})}),t(a,"click",function(){n._selectedOptionsCache=n._selectedOptionsCache||{};var i=n._selectedOptionsCache[o.variableID]||0,t=n._setViewMode(f,!0);n._loadDataDrillingOptionsList(o),n.drillingOptionsList.setSelectedIndex(i),n._loadDataDrillingView(o,n.drillingOptionsList.selectedItem.label,null,null,t)}),this._drillingSectionsButtons.push({destroy:function(){l.destroy(a)}})}},_selectedOptionsCache:null,_createDrillingOptionsList:function(i){this._selectedOptionsCache=this._selectedOptionsCache||{};var t=new r({"class":"simpleInfographic_drillingOptionsList",itemRenderer:new S});return this.own(t),u.makePopup(t,this,i,{orient:["before","below"]}),t},_updateDrillingOptionsListWithFieldInfo:function(i,t){var e=this;i.onChange=function(){u.close(i),e._selectedOptionsCache[t.variableID]=i.selectedIndex,e._setViewMode(f,!0),e._loadDataDrillingView(t,i.selectedItem.label)};var n=c.getDrillingOptions(t).map(function(i,t){return{label:i.name,value:t}});i.setItems(n)},_loadDataDrillingOptionsList:function(i){this.drillingOptionsList||(this.drillingOptionsList=this._createDrillingOptionsList(this.drillingOptionsButton)),this._updateDrillingOptionsListWithFieldInfo(this.drillingOptionsList,i),n[this.drillingOptionsList.items.length>1?"add":"remove"](this.domNode,"hasMultipleDrillingOptions")},_dataDrillingState:null,_loadDataDrillingView:function(i,t,l,o,s){function r(){var n=c.getDrillingOptionInfo(i,t,d.width,d.height,l),o=n.fieldsToEnrich;return e(o&&o.length&&d.viewModel.enrichFieldData(o),function(){return n})}var d=this;this._destroyDrillingSections(),this._dataDrillingState={fieldInfo:i,optionName:t,calcState:l,sectionVisualState:o},p.showProgress(d.waitingDiv),e(r(),function(l){var r,c={};c["class"]="infographicContainer_Section",c.initialWidth=d.width,c.json={type:D.DETAILS,stack:[l.tableJson]},c.viewModel=d.viewModel,c.themeContext=d.themeContext,c.theme=d.theme,c.tableClass="infographicContainerTable",c.hasFixedLayout=!1,c.isInfographicSection=!0,c.calculationStatesGroup=l.calculationStatesGroup,c.onCalculationStateChanged=function(e){d._loadDataDrillingView(i,t,e,r.getVisualState())},e(s,function(){r=d.viewModel.layoutBuilder.createElement("section",c,d.drilledDataViewDiv),r.setResizedHeight(d.height),d._drillingSections.push(r),n[a(".sectionDynamicSettings_settingsButton",d.domNode)[0]?"add":"remove"](d.domNode,"hasChartSettingsButton"),r.domNode.style.opacity="0.01",setTimeout(function(){r.setVisualState(o),r.domNode.style.opacity="",p.removeProgress(d.waitingDiv)})})})},_getDataDrillingState:function(){return this._dataDrillingState},_setDataDrillingState:function(i){i&&this._loadDataDrillingView(i.fieldInfo,i.optionName,i.calcState,i.sectionVisualState)},_destroyDrillingSections:function(){this._drillingSections=this._drillingSections||[],this._drillingSections.forEach(function(i){i.destroy()}),this._drillingSections.length=0,this.domNode&&l.empty(this.drilledDataViewDiv)},_destroyDrillingSectionsButtons:function(){this._drillingSectionsButtons=this._drillingSectionsButtons||[],this._drillingSectionsButtons.forEach(function(i){i.destroy()}),this._drillingSectionsButtons.length=0}});return v.VIEW_MAIN=_,v.VIEW_DATA_DRILLING=f,v});