// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/when","dojo/dom-style","dojo/query","dojo/on","dijit/_WidgetBase","dijit/_TemplatedMixin","esri/dijit/geoenrichment/theme","./_Infographic","../InfographicTypes","esri/dijit/geoenrichment/utils/DelayUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/InvokeUtil","esri/dijit/geoenrichment/utils/MouseUtil","esri/dijit/geoenrichment/utils/WaitingUtil","../utils/InfographicJsonUtil","../extentions/BaseSelectComparisonExt","dojo/text!../../templates/DynamicInfographic.html","dojo/i18n!esri/nls/jsapi","../../../_devConfig"],function(t,i,e,o,r,n,s,a,h,l,g,c,d,u,f,_,p,m,w,v,y,I){y=y.geoenrichment.dijit.ReportPlayer.Infographics;var S={};S[c.ONE_VAR]=230,S[c.AGE_PYRAMID]=0,S[c.RELATED_VARS]=320,S[c.TAPESTRY]=300;var A=t([a,h],{templateString:v,nls:y,viewModel:null,theme:null,currentFeatureIndex:null,_infographic:null,_progressHanlder:null,_stdPolygonsController:null,_thisAreasHighlightController:null,_initPromise:null,buildRendering:function(){w.init(),this.inherited(arguments)},postCreate:function(){this.inherited(arguments),this._showError(!1),this._showEmptyView(!1)},_currentInfographicJson:null,_getWidgetCreationParams:function(t){var i={};switch(t.type){case c.AGE_PYRAMID:i.showVerticalAxis=t.showVerticalAxis;break;case c.ONE_VAR:i.isMultiFeature=!1}return i},updateInfographic:function(t){if(this.viewDiv)return this._destroyCurrentInfographic(),this._currentInfographicJson=t,this.viewModel.dynamicReportInfo&&this._currentInfographicJson.calcData&&c.supportsComparison(this._currentInfographicJson.type)&&(this._stdPolygonsController=this.viewModel.getStdPolygonsController(this._currentInfographicJson.calcData.calculatorName,this.currentFeatureIndex),this._currentInfographicJson.type===c.ONE_VAR&&(this._thisAreasHighlightController=this.viewModel.getThisAreasHighlightController())),this._enrichInfographicJsonWithProps(t),this._initPromise=o(this._createInfographicWidgetFromJson(t),function(){this._applyTheme(t)}.bind(this))},_enrichInfographicJsonWithProps:function(t){m.setLevels(t,t.levels)},_createInfographicWidgetFromJson:function(t){var i=this,r=new e,n=this.viewModel.getInfographicDefaultStyles(this.theme);if(l.set(this.viewDiv,n&&n.agePyramid&&n.agePyramid.theme||"light"),this.viewModel.dynamicReportInfo&&this.viewModel.dynamicReportInfo.infographicOptions){var s=this.viewModel.dynamicReportInfo.infographicOptions;return this.viewModel.dynamicReportInfo.isFixedDataMode||this.viewModel.dynamicReportInfo.geClient.hasCapability("ComparisonLevelsInCalculators")||(t.calcData=null),this._infographic=new g({infographicStyleProvider:n,widgetParams:this._getWidgetCreationParams(t),returnGeometry:!1,autoTitle:!1,subtitle:!1,levels:m.getSubLevels(t),highestLevel:m.getHighestLevel(t),onDataRequest:function(){i._showProgress(!0,"data")},onDataReady:function(){o(i.resize(),function(){i._showProgress(!1,"data"),i._syncWithShownFeatures(),r.resolve()})},onDataError:function(){i._showProgress(!1,"data"),i._showError(!0)},onExpandedStateChanged:function(){i._doResize()},onSelectedFeatureChanged:function(){i._syncWithShownFeatures()}}).placeAt(this.infographicDiv),this._showProgress(!0,"item"),o(function(){if(t.calcData){return{title:t.title,type:t.type,variables:t.variables||t.calcData.variables}}return o(s.getOptions().getItems(s.countryID),function(i){var e;return i.some(function(i){if(i.variables&&i.variables.length){var o=m.analyzeVariables(t),r=i.variables[0];return o.variableID&&-1!==r.indexOf(o.variableID)?(e=i,!0):o.dataCollectionID&&0===r.indexOf(o.dataCollectionID)?(e=i,!0):void 0}}),e})}(),function(e){if(i._showProgress(!1,"item"),e){var n=s.createGeoenrichment({infographicJson:t,areaData:i.viewModel.dynamicReportInfo.fieldData.areaData,isMultiFeature:!1,currentFeatureIndex:i.currentFeatureIndex});i._infographic.setGeoenrichment(n),i._infographic.set("studyArea",s.studyArea),i._infographic.set("countryID",s.countryID),i._infographic.set("type",t.type),i._infographic.set("variables",e.variables),i._infographic.set("title",e.title),i._infographic.startup();var a=!n.isBusy();return t.title=t.title||e.title,o(i.resize(),function(){return a&&(i._showProgress(!1,"data"),i._syncWithShownFeatures(),r.resolve()),r.promise})}i._showError(!0)})}try{return this._createDummyInfographic(t)}catch(t){console.log(t),this._showError(!0)}},_createDummyInfographic:function(t){},_syncWithShownFeatures:function(){if(this._stdPolygonsController&&this._infographic&&this._infographic._widget){this._stdPolygonsController.setAttributeFields(this._infographic.dataProvider.getAttributeFields());var t,i=this._infographic.dataProvider.getAllGeographyAttributes({ignoreFilters:!0});if(this._currentInfographicJson.type===c.ONE_VAR)t=this._infographic.dataProvider.getAllGeographyAttributes();else{t=[];var e=this._infographic._widget.select.getSelectedAttributes();e&&t.push(e)}this._stdPolygonsController.setShownFeatureAttributes(t),this._stdPolygonsController.setAllFeatureAttributes(i),this._currentInfographicJson.type===c.ONE_VAR&&(this._registerStdPolygonsHighlight(i),this._registerThisAreaHighlight())}},_registerStdPolygonsHighlight:function(t){var i=this;this._stdPolygonsController.registerInfographic({highlightInfographicForAttributes:function(t){if(i._infographic.domNode){var e=i._infographic._widget.setTableRowHighlighted(t);e&&(i.viewDiv.scrollTop=e.offsetTop+200-i.viewDiv.clientHeight)}}}).then(function(){if(i._infographic.domNode){var e;s(i._infographic._widget.table,"mouseover, mousemove",function(){var o=i._infographic._widget.getOverRow();if(o&&o!==e){e=o;var r,n=o&&o.cells[0].innerHTML;n&&t.some(function(t){if(t.StdGeographyName===n)return r=t,!0}),r&&(i._stdPolygonsController.highlightGraphicForAttributes(r),i._infographic._widget.setTableRowHighlighted(r))}}),s(i._infographic._widget.table,"mouseout",function(){i._stdPolygonsController.highlightGraphicForAttributes(null),i._infographic._widget.setTableRowHighlighted(null),e=null})}})},_registerThisAreaHighlight:function(){var t=this;this._thisAreasHighlightController.registerTable({highlightTableForAreaIndex:function(i){if(t._infographic.domNode)if(t.currentFeatureIndex===i){var e=t._infographic._widget.setThisAreaTableRowHighlighted();e&&(t.viewDiv.scrollTop=e.offsetTop+200-t.viewDiv.clientHeight)}else t._infographic._widget.setTableRowHighlighted(null)}}).then(function(){if(t._infographic.domNode){var i;s(t._infographic._widget.table,"mouseover, mousemove",function(){var e=t._infographic._widget.getOverRow();e&&e!==i&&(i=e,t._infographic._widget.isThisAreaRow(i)&&(t._thisAreasHighlightController.highlightGraphicForAreaIndex(t.currentFeatureIndex),t._infographic._widget.setThisAreaTableRowHighlighted()))}),s(t._infographic._widget.table,"mouseout",function(){t._thisAreasHighlightController.highlightGraphicForAreaIndex(null),t._infographic._widget.setTableRowHighlighted(null),i=null})}})},_applyTheme:function(t){if(this._infographic){var i=this.viewModel.getInfographicDefaultStyles(this.theme),e=t.style&&t.style.backgroundColor||i&&i.backgroundColor;r.set(this._infographic.domNode,"backgroundColor",e),r.set(this._infographic.domNode,"fontFamily","inherit")}},_destroyCurrentInfographic:function(){this._showError(!1),this._showProgress(!1),this._infographic&&this._infographic.destroy(),this._infographic=null},_itemLoadingState:0,_dataLoadingState:0,_contentLoadingState:0,_showProgress:function(t,i){p[t?"showProgress":"removeProgress"](this.domNode),"item"===i?this._itemLoadingState=t?1:2:"data"===i&&(this._dataLoadingState=t?1:2),1!==this._itemLoadingState&&1!==this._dataLoadingState||0!==this._contentLoadingState||(this._contentLoadingState=1,this.onContentLoadingStart()),2===this._itemLoadingState&&2===this._dataLoadingState&&1===this._contentLoadingState&&(this._contentLoadingState=2,this.onContentLoadingEnd())},_filterRangesStats:null,getFilterRanges:function(){return o(this._initPromise,function(){return this._filterRangesStats=this._infographic.dataProvider.collectFilterRangesStats({excludeThisAreas:!0}),this._filterRangesStats&&this._filterRangesStats.filterRanges}.bind(this))},setFilterRanges:function(t){return o(this._initPromise,function(){this._infographic.dataProvider.setFilterRanges(t,{ignoreThisAreas:this._currentInfographicJson.type===c.ONE_VAR}),this._infographic._widget.select?(this._infographic._widget.select.setFeatures(this._infographic.dataProvider.getData().features),this._infographic._widget.select.setDefaultValue({emitEvent:!0})):(this._infographic._widget.setDataProvider(this._infographic.dataProvider),this._doResize()),this._syncWithShownFeatures(),this._showEmptyView(!this.getNumAreasShown()),this.onContentUpdated()}.bind(this))},getNumAreasTotal:function(){return this._filterRangesStats&&this._filterRangesStats.numAreasTotal||0},getNumAreasShown:function(){return this._currentInfographicJson.type===c.ONE_VAR?this._infographic.dataProvider.getAllGeographyAttributes().length:this._infographic._widget.select.getNumFeatures&&this._infographic._widget.select.getNumFeatures()||0},_showEmptyView:function(t){u[t?"hide":"show"](this.infographicDiv),u[t?"show":"hide"](this.noDataPlaceHolder),t&&this._syncEmptyViewPlaceholder()},_syncEmptyViewPlaceholder:function(){this.noDataPlaceHolder&&r.set(this.noDataPlaceHolder,"paddingTop",(this.height-r.get(this.noDataPlaceHolder,"height"))/2+"px")},_showError:function(t){I.emulateErrors.contentErrors&&(t=!0),u[t?"show":"hide"](this.errorDiv),u[t?"hide":"show"](this.infographicDiv)},_adjustErrorMessage:function(){r.set(this.errorDiv,"paddingTop",r.get(this.domNode,"height")/2-20+"px")},notifyShown:function(){},width:null,height:null,_infographicResizedAtLeastOnce:!1,_hasScroll:!1,resize:function(t,i){return void 0!==t&&(this.width=t,this.height=i),f.invoke(this,"_doResize",50)},_doResize:function(){var t=this;if(this._infographic&&this._infographic.domNode&&u.isNodeInLayout(this.domNode)&&this._currentInfographicJson){this._syncJsonDimensions();var i=this._currentInfographicJson.type,e=Math.max(function(){if("OneVar"===i){var e=n(".OneVarMultiComparison_Table",t.domNode)[0],o=e?r.get(e,"height")+120:0;return Math.max(o,S[i])}if("Tapestry"===i){var e=n(".Tapestry_Main_Table",t.domNode)[0],o=e?r.get(e,"height")+60:0;return Math.max(o,S[i])}return S[i]}(),this.height);this._hasScroll=e>this.height;var o=this.width-(this._hasScroll?u.getScrollbarSize().w+3:0);return r.set(this._infographic.domNode,{width:o+"px",height:e+"px"}),r.set(this.viewDiv,{height:this.height+"px",overflowY:"auto"}),this._infographic.resize(),this._adjustErrorMessage(),d.delay()}},hasScroll:function(){return this._hasScroll},changeScroll:function(t,i){this.domNode.scrollLeft+=t,this.domNode.scrollTop+=i},_syncJsonDimensions:function(){this._currentInfographicJson.style=this._currentInfographicJson.style||{},this._currentInfographicJson.style.width=this.width,this._currentInfographicJson.style.height=this.height},getPreferredHeight:function(){return this._infographic&&r.get(this._infographic.domNode,"height")},collapseContent:function(){this._infographic&&this._infographic.collapseContent()},getVisualState:function(){return{selectedFeatureId:this._infographic&&this._infographic.getSelectedFeatureID()}},setVisualState:function(t){t&&t.selectedFeatureId&&this._infographic&&this._infographic.setSelectedFeatureID(t.selectedFeatureId)},isMouseOver:function(){return _.isMouseOver(this.domNode)||this._infographic&&this._infographic._widget.select&&this._infographic._widget.select.isMouseOver()},toJson:function(){return i.clone(this._currentInfographicJson)},onContentLoadingStart:function(){},onContentLoadingEnd:function(){},onContentUpdated:function(){},destroy:function(){this._stdPolygonsController&&this._stdPolygonsController.setShownFeatureAttributes([]),this._destroyCurrentInfographic(),this.inherited(arguments)}});return A.Infographic=g,A});