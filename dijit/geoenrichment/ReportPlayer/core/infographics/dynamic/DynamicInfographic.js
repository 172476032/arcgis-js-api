// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/when","dojo/dom-style","dojo/query","dijit/_WidgetBase","dijit/_TemplatedMixin","esri/dijit/geoenrichment/theme","./_Infographic","../InfographicTypes","esri/dijit/geoenrichment/utils/DelayUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/InvokeUtil","esri/dijit/geoenrichment/utils/WaitingUtil","../utils/InfographicJsonUtil","../extentions/BaseSelectComparisonExt","dojo/text!../../templates/DynamicInfographic.html","dojo/i18n!esri/nls/jsapi","../../../_devConfig"],function(t,e,i,n,o,r,a,s,h,c,d,g,l,u,f,p,_,m,y){m=m.geoenrichment.dijit.ReportPlayer.Infographics;var v={};v[c.ONE_VAR]=230,v[c.AGE_PYRAMID]=0,v[c.RELATED_VARS]=320,v[c.TAPESTRY]=300;var I=t([r,a],{templateString:_,nls:m,viewModel:null,theme:null,currentFeatureIndex:null,_infographic:null,_progressHanlder:null,buildRendering:function(){p.init(),this.inherited(arguments)},postCreate:function(){this.inherited(arguments),this._showError(!1)},_currentInfographicJson:null,_getWidgetCreationParams:function(t){var e={};switch(t.type){case c.AGE_PYRAMID:e.showVerticalAxis=t.showVerticalAxis;break;case c.ONE_VAR:e.isMultiFeature="number"!=typeof this.currentFeatureIndex&&this.viewModel.dynamicReportInfo&&this.viewModel.dynamicReportInfo.isMultiFeature&&this.viewModel.dynamicReportInfo.analysisAreas.length>1}return e},updateInfographic:function(t){if(this.viewDiv)return this._destroyCurrentInfographic(),this._currentInfographicJson=t,this._enrichInfographicJsonWithProps(t),i(this._createInfographicWidgetFromJson(t),function(){this._applyTheme(t)}.bind(this))},_enrichInfographicJsonWithProps:function(t){f.setLevels(t,t.levels)},_createInfographicWidgetFromJson:function(t){var e=this,n=this.viewModel.getInfographicDefaultStyles(this.theme);if(s.set(this.viewDiv,n&&n.agePyramid&&n.agePyramid.theme||"light"),this.viewModel.dynamicReportInfo&&this.viewModel.dynamicReportInfo.infographicOptions){var o=this.viewModel.dynamicReportInfo.infographicOptions;return this.viewModel.dynamicReportInfo.isFixedDataMode||this.viewModel.dynamicReportInfo.geClient.hasCapability("ComparisonLevelsInCalculators")||(t.calcData=null),this._infographic=new h({infographicStyleProvider:n,widgetParams:this._getWidgetCreationParams(t),returnGeometry:!1,autoTitle:!1,subtitle:!1,levels:f.getSubLevels(t),highestLevel:f.getHighestLevel(t),onDataRequest:function(){e._showProgress(!0,"data")},onDataReady:function(){i(e.resize(),function(){e._showProgress(!1,"data")})},onDataError:function(){e._showProgress(!1,"data"),e._showError(!0)},onExpandedStateChanged:function(){e._doResize()}}).placeAt(this.infographicDiv),this._showProgress(!0,"item"),i(function(){if(t.calcData){return{title:t.title,type:t.type,variables:t.variables||t.calcData.variables}}return i(o.getOptions().getItems(o.countryID),function(e){var i;return e.some(function(e){if(e.variables&&e.variables.length){var n=f.analyzeVariables(t),o=e.variables[0];return n.variableID&&-1!==o.indexOf(n.variableID)?(i=e,!0):n.dataCollectionID&&0===o.indexOf(n.dataCollectionID)?(i=e,!0):void 0}}),i})}(),function(n){if(e._showProgress(!1,"item"),n){var r=e.viewModel.dynamicReportInfo.isMultiFeature&&c.supportsMultiFeature(t.type)&&"number"!=typeof e.currentFeatureIndex,a=o.createGeoenrichment({infographicJson:t,areaData:e.viewModel.dynamicReportInfo.fieldData.areaData,isMultiFeature:r,currentFeatureIndex:e.currentFeatureIndex});e._infographic.setGeoenrichment(a),e._infographic.set("studyArea",o.studyArea),e._infographic.set("countryID",o.countryID),e._infographic.set("type",t.type),e._infographic.set("variables",n.variables),e._infographic.set("title",n.title),e._infographic.startup();var s=!a.isBusy();return t.title=t.title||n.title,i(e.resize(),function(){s&&e._showProgress(!1,"data")})}e._showError(!0)})}return this._createDummyInfographic(t)},_createDummyInfographic:function(t){},_applyTheme:function(t){var e=this.viewModel.getInfographicDefaultStyles(this.theme),i=t.style&&t.style.backgroundColor||e&&e.backgroundColor;n.set(this._infographic.domNode,"backgroundColor",i),n.set(this._infographic.domNode,"fontFamily","inherit")},_destroyCurrentInfographic:function(){this._showError(!1),this._showProgress(!1),this._infographic&&this._infographic.destroy(),this._infographic=null},_itemLoadingState:0,_dataLoadingState:0,_contentLoadingState:0,_showProgress:function(t,e){u[t?"showProgress":"removeProgress"](this.domNode),"item"===e?this._itemLoadingState=t?1:2:"data"===e&&(this._dataLoadingState=t?1:2),1!==this._itemLoadingState&&1!==this._dataLoadingState||0!==this._contentLoadingState||(this._contentLoadingState=1,this.onContentLoadingStart()),2===this._itemLoadingState&&2===this._dataLoadingState&&1===this._contentLoadingState&&(this._contentLoadingState=2,this.onContentLoadingEnd())},_showError:function(t){y.emulateErrors.contentErrors&&(t=!0),g[t?"show":"hide"](this.errorDiv),g[t?"hide":"show"](this.infographicDiv)},_adjustErrorMessage:function(){n.set(this.errorDiv,"paddingTop",n.get(this.domNode,"height")/2-20+"px")},notifyShown:function(){},width:null,height:null,_infographicResizedAtLeastOnce:!1,resize:function(t,e){return void 0!==t&&(this.width=t,this.height=e),l.invoke(this,"_doResize",50)},_doResize:function(){var t=this;if(this._infographic&&this._infographic.domNode&&g.isNodeInLayout(this.domNode)&&this._currentInfographicJson){this._syncJsonDimensions();var e=this._currentInfographicJson.type,i=Math.max(function(){if("OneVar"===e){var i=o(".OneVarMultiComparison_Table",t.domNode)[0],r=i?n.get(i,"height")+120:0;return Math.max(r,v[e])}if("Tapestry"===e){var i=o(".Tapestry_Main_Table",t.domNode)[0],r=i?n.get(i,"height")+60:0;return Math.max(r,v[e])}return v[e]}(),this.height),r=i>this.height,a=this.width-(r?20:0);return n.set(this._infographic.domNode,{width:a+"px",height:i+"px"}),n.set(this.viewDiv,{height:this.height+"px",overflowY:"auto"}),this._infographic.resize(),this._adjustErrorMessage(),d.delay()}},_syncJsonDimensions:function(){this._currentInfographicJson.style=this._currentInfographicJson.style||{},this._currentInfographicJson.style.width=this.width,this._currentInfographicJson.style.height=this.height},getPreferredHeight:function(){return this._infographic&&n.get(this._infographic.domNode,"height")},collapseContent:function(){this._infographic&&this._infographic.collapseContent()},getVisualState:function(){return{selectedFeatureId:this._infographic&&this._infographic.getSelectedFeatureID()}},setVisualState:function(t){t&&t.selectedFeatureId&&this._infographic&&this._infographic.setSelectedFeatureID(t.selectedFeatureId)},toJson:function(){return e.clone(this._currentInfographicJson)},onContentLoadingStart:function(){},onContentLoadingEnd:function(){},destroy:function(){this._destroyCurrentInfographic(),this.inherited(arguments)}});return I.Infographic=h,I});