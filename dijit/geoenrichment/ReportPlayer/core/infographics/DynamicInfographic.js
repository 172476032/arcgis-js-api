// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/when","dojo/dom-class","dojo/dom-style","dojo/on","dojo/query","dijit/focus","dijit/_WidgetBase","dijit/_TemplatedMixin","esri/geometry/Point","esri/dijit/geoenrichment/Infographic","esri/dijit/geoenrichment/AgePyramid","esri/dijit/geoenrichment/RelatedVariables","esri/dijit/geoenrichment/OneVar","esri/dijit/geoenrichment/Tapestry","esri/dijit/geoenrichment/config","esri/dijit/geoenrichment/theme","esri/tasks/geoenrichment/GeometryStudyArea","esri/dijit/geoenrichment/_Invoke","./InfographicTypes","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/WaitingUtil","esri/dijit/geoenrichment/utils/DynamicStyleUtil","dojo/text!../templates/DynamicInfographic.html","dojo/i18n!../../../../../nls/jsapi"],function(e,t,i,r,o,n,a,s,h,d,l,c,g,u,f,p,m,_,v,y,w,C,P,I,S,b,D){D=D.geoenrichment.dijit.ReportPlayer.ReportPlayer;var R={};R[C.ONE_VAR]=230,R[C.AGE_PYRAMID]=0,R[C.RELATED_VARS]=320,R[C.TAPESTRY]=300;var x=e(null,{_createComboBox:function(){this.inherited(arguments),this.select&&this.select.own(i.after(this.select,"onChange",function(){setTimeout(function(){h.curNode&&h.curNode.blur()})}))},getSelectedFeatureID:function(){return this.select&&this.select.get("value")},setSelectedFeatureID:function(e){this.select&&this.select.set("value",e)}}),E=e([u,x],{infographicStyleProvider:null,_onThemeLoad:function(e){function i(e){n.set(e,"color",o.contains(e,"AgePyramid_TextMale")?r.male.backgroundColor:r.female.backgroundColor)}var r=this.infographicStyleProvider&&this.infographicStyleProvider.agePyramid;r&&(e=t.mixin({},e),e.male=e.male||{},e.male.fill=r.male.backgroundColor,e.female=e.female||{},e.female.fill=r.female.backgroundColor),this.inherited(arguments,[e]),r&&(i(this.min),i(this.max))},resize:function(){this.inherited(arguments);var e=this.min&&this.min.parentNode;if(e&&this.parent)for(var t=n.get(this.parent,"width")<400,i=0;i<e.children.length;i++){var r=e.children[i];o[t?"add":"remove"](r,"TrimWithEllipses")}}}),A=e([f,x],{infographicStyleProvider:null,_themeAddedFlag:!1,updateUI:function(){if(this.inherited(arguments),!this._themeAddedFlag){var e=this.infographicStyleProvider&&this.infographicStyleProvider.agePyramid;if(e){var t=this.parent.id;S.addStyle(["#"+t+" .RelatedVariables_PositiveBar { background-color:"+e.male.backgroundColor+"; } #"+t+" .RelatedVariables_NegativeBar { background-color:"+e.female.backgroundColor+"; } #"+t+" .RelatedVariables_DifferenceColumn_Positive { color:"+e.male.backgroundColor+"; } #"+t+" .RelatedVariables_DifferenceColumn_Negative { color:"+e.female.backgroundColor+"; }"],t),this._themeAddedFlag=!0}}},destroy:function(){S.removeStyle(this.parent.id),this.inherited(arguments)}}),j=e(p,{infographicStyleProvider:null,_themeAddedFlag:!1,updateUI:function(){if(this.inherited(arguments),!this._themeAddedFlag){var e=this.infographicStyleProvider&&this.infographicStyleProvider.agePyramid;if(e){var t=this.parent.id;S.addStyle(["#"+t+" .OneVarMultiComparison_Expanded_Value_Primary { color:"+e.male.backgroundColor+"; } #"+t+" .OneVarMultiComparison_Expanded_CurrentBar { background-color:"+e.male.backgroundColor+"; }"],t),this._themeAddedFlag=!0}}},destroy:function(){S.removeStyle(this.parent.id),this.inherited(arguments)}}),T=e(m,{_toDetailView:function(e){this.inherited(arguments),this.onExpandedStateChanged()},collapseContent:function(){o.remove(this._mainTable,"clicked"),this._toMainView(),this.onExpandedStateChanged()},onExpandedStateChanged:function(){}}),V={};V[C.ONE_VAR]=j,V[C.AGE_PYRAMID]=E,V[C.RELATED_VARS]=A,V[C.TAPESTRY]=T;var k=e(g,{infographicStyleProvider:null,widgetParams:null,_requireReport:function(){this.type&&(V[this.type]?this._createReportWidget(this.type,V[this.type]):require([this._getAbsMid("./"+this.type)],t.hitch(this,this._createReportWidget,this.type)))},_createReportWidget:function(e,i){var r=this;if(!this._destroyed&&this.type==e){if(this._ge&&this._ge.isBusy())return void a.once(this._ge,"end",t.hitch(this,this._createReportWidget,this.type,i));if(this._autoTitlePromise)return void this._autoTitlePromise.then(t.hitch(this,this._createReportWidget,this.type,i));if(this.type){var o=this._widget=new i(this.domNode);t.mixin(o,this.widgetParams),o.onExpandedStateChanged=function(){r.onExpandedStateChanged()},o.infographicStyleProvider=this.infographicStyleProvider,o.title="string"==typeof this.title?this.title:this._autoTitle,o.subtitle=this.subtitle,o.expanded=this.expanded,o.on("resize",t.hitch(this,this._onResize)),isNaN(this._lastSelectedComparison)||o.setState({selectedComparison:this._lastSelectedComparison}),o.setDataProvider(this.dataProvider)}}},collapseContent:function(){this._widget&&this._widget.collapseContent&&this._widget.collapseContent()},getSelectedFeatureID:function(){return this._widget&&this._widget.getSelectedFeatureID&&this._widget.getSelectedFeatureID()},setSelectedFeatureID:function(e){this._widget&&this._widget.setSelectedFeatureID&&this._widget.setSelectedFeatureID(e)},onExpandedStateChanged:function(){}}),M=e([d,l,w],{templateString:b,nls:D,viewModel:null,themeContext:null,theme:null,_infographic:null,_progressHanlder:null,postCreate:function(){this.inherited(arguments),this._showError(!1)},_currentInfographicJson:null,_getWidgetCreationParams:function(e){var t={};switch(e.type){case C.AGE_PYRAMID:t.showVerticalAxis=e.showVerticalAxis}return t},updateInfographic:function(e){function t(){if(e.calcData){var t={title:e.title,type:e.type,variables:e.variables};return t}return r(a.getOptions().getItems(a.countryID),function(t){i._showProgress(!1);var r;return t.some(function(t){if(t.variables&&t.variables.length){var i,o,n=e.variables[0];-1!==n.indexOf(".*")?i=n.replace(".*",""):o=n;var a=t.variables[0];return o&&-1!=a.indexOf(o)?(r=t,!0):i&&0==a.indexOf(i)?(r=t,!0):void 0}}),r})}var i=this;if(this.viewDiv){this._destroyCurrentInfographic(),this._currentInfographicJson=e;var o=this.viewModel.getInfographicDefaultStyles(this.theme||this.themeContext);if(this._enrichInfographicJsonWithProps(e),this.viewModel.dynamicReportInfo&&this.viewModel.dynamicReportInfo.infographicOptions){var a=this.viewModel.dynamicReportInfo.infographicOptions;this._infographic=new k({infographicStyleProvider:o,widgetParams:this._getWidgetCreationParams(e),returnGeometry:!1,autoTitle:!1,subtitle:!1,levels:e.levels,highestLevel:e.highestLevel,onDataRequest:function(){i._showProgress(!0)},onDataReady:function(){i._showProgress(!1),i.resize()},onDataError:function(){i._showProgress(!1),i._showError(!0)},onExpandedStateChanged:function(){i._doResize()}}).placeAt(this.infographicDiv),this._infographic.setGeoenrichment(a.createGeoenrichment(e,this.viewModel.dynamicReportInfo.fieldData)),this._infographic.set("studyArea",a.studyArea),this._infographic.set("countryID",a.countryID),this._infographic.set("type",e.type),this._showProgress(!0),r(t(),function(t){return i._showProgress(!1),t?(i._infographic.set("variables",t.variables),i._infographic.set("title",t.title),i._infographic.startup(),i.resize(),void(e.title=e.title||t.title)):void i._showError(!0)})}else this._createDummyInfographic(e);v.set(this.viewDiv,o&&o.agePyramid&&o.agePyramid.theme||"light");var s=e.style&&e.style.backgroundColor||o&&o.backgroundColor;n.set(this._infographic.domNode,"backgroundColor",s)}},_enrichInfographicJsonWithProps:function(e){e.levels=e.levels||_.levels,e.highestLevel=e.highestLevel||_.highestLevel,e.variables||(e.variables=e.dataCollectionID?[e.dataCollectionID+".*"]:[e.variableID]),delete e.dataCollectionID,delete e.variableID},_createDummyInfographic:function(e){},_destroyCurrentInfographic:function(){this._showError(!1),this._showProgress(!1),this._infographic&&this._infographic.destroy(),this._infographic=null},_isContentLoading:!1,_showProgress:function(e){this._isContentLoading&&this.onContentLoadingEnd(),e&&this.onContentLoadingStart(),this._isContentLoading=e,I[e?"showProgress":"removeProgress"](this.waitingDiv)},_showError:function(e){P[e?"show":"hide"](this.errorDiv),P[e?"hide":"show"](this.infographicDiv)},notifyShown:function(){this.resize()},width:null,height:null,resize:function(e,t){void 0!==e&&(this.width=e,this.height=t),this.invoke("_doResize",50)},_doResize:function(){function e(){if("OneVar"==i){var e=s(".OneVarMultiComparison_Table",t.domNode)[0],r=e?n.get(e,"height")+120:0;return Math.max(r,R[i])}if("TapestryNEW"==i){var e=s(".Tapestry_Main_Table",t.domNode)[0],r=e?n.get(e,"height")+60:0;return Math.max(r,R[i])}return R[i]}var t=this;if(this._infographic&&this._infographic.domNode&&P.isNodeInLayout(this.domNode)){var i=this._currentInfographicJson.type,r=Math.max(e(),this.height),o=r>this.height,a=this.width-(o?20:0);n.set(this._infographic.domNode,{width:a+"px",height:r+"px"}),n.set(this.viewDiv,{height:this.height+"px",overflowY:"auto"}),this._infographic.resize()}},getPreferredHeight:function(){return this._infographic&&n.get(this._infographic.domNode,"height")},collapseContent:function(){this._infographic&&this._infographic.collapseContent()},getVisualState:function(){return{selectedFeatureId:this._infographic&&this._infographic.getSelectedFeatureID()}},setVisualState:function(e){e&&e.selectedFeatureId&&this._infographic&&this._infographic.setSelectedFeatureID(e.selectedFeatureId)},toJson:function(){var e=t.clone(this._currentInfographicJson);return e},onContentLoadingStart:function(){},onContentLoadingEnd:function(){},destroy:function(){this._destroyCurrentInfographic(),this.inherited(arguments)}});return M.ThemableInfographic=k,M});