// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/aspect","dojo/when","dojo/dom-class","dojo/dom-style","dojo/on","dojo/query","dijit/focus","dijit/_WidgetBase","dijit/_TemplatedMixin","esri/geometry/Point","esri/dijit/geoenrichment/Infographic","esri/dijit/geoenrichment/AgePyramid","esri/dijit/geoenrichment/RelatedVariables","esri/dijit/geoenrichment/OneVar","esri/dijit/geoenrichment/Tapestry","esri/dijit/geoenrichment/config","esri/dijit/geoenrichment/theme","esri/tasks/geoenrichment/GeometryStudyArea","./InfographicTypes","esri/dijit/geoenrichment/utils/DelayUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/InvokeUtil","esri/dijit/geoenrichment/utils/WaitingUtil","esri/dijit/geoenrichment/utils/DynamicStyleUtil","./infographicUtils/InfographicJsonUtil","./extentions/BaseSelectComparisonExt","dojo/text!../templates/DynamicInfographic.html","dojo/i18n!../../../../../nls/jsapi","../../_devConfig"],function(e,t,i,r,n,o,a,s,h,d,l,c,g,u,f,p,m,_,v,y,S,C,w,I,P,b,D,R,x,E,j){E=E.geoenrichment.dijit.ReportPlayer.ReportPlayer;var A={};A[S.ONE_VAR]=230,A[S.AGE_PYRAMID]=0,A[S.RELATED_VARS]=320,A[S.TAPESTRY]=300;var L=e(null,{getSelectedFeatureID:function(){return this.select&&this.select.get("value")},setSelectedFeatureID:function(e){this.select&&this.select.set("value",e)}}),M=e([u,L],{infographicStyleProvider:null,_onThemeLoad:function(e){function i(e){o.set(e,"color",n.contains(e,"AgePyramid_TextMale")?r.male.backgroundColor:r.female.backgroundColor)}var r=this.infographicStyleProvider&&this.infographicStyleProvider.agePyramid;r&&(e=t.mixin({},e),e.male=e.male||{},e.male.fill=r.male.backgroundColor,e.female=e.female||{},e.female.fill=r.female.backgroundColor),this.inherited(arguments,[e]),r&&(i(this.min),i(this.max))},resize:function(){this.inherited(arguments);var e=this.min&&this.min.parentNode;if(e&&this.parent)for(var t=o.get(this.parent,"width")<400,i=0;i<e.children.length;i++){var r=e.children[i];n[t?"add":"remove"](r,"TrimWithEllipses")}}}),T=e([f,L],{infographicStyleProvider:null,_themeAddedFlag:!1,updateUI:function(){if(this.inherited(arguments),!this._themeAddedFlag){var e=this.infographicStyleProvider&&this.infographicStyleProvider.agePyramid;if(e){var t=this.parent.id;b.addStyle(["#"+t+" .RelatedVariables_PositiveBar { background-color:"+e.male.backgroundColor+"; } #"+t+" .RelatedVariables_NegativeBar { background-color:"+e.female.backgroundColor+"; } #"+t+" .RelatedVariables_DifferenceColumn_Positive { color:"+e.male.backgroundColor+"; } #"+t+" .RelatedVariables_DifferenceColumn_Negative { color:"+e.female.backgroundColor+"; }"],t),this._themeAddedFlag=!0}}},destroy:function(){b.removeStyle(this.parent.id),this.inherited(arguments)}}),F=e(p,{infographicStyleProvider:null,_themeAddedFlag:!1,updateUI:function(){if(this.inherited(arguments),!this._themeAddedFlag){var e=this.infographicStyleProvider&&this.infographicStyleProvider.agePyramid;if(e){var t=this.parent.id;b.addStyle(["#"+t+" .OneVarMultiComparison_Expanded_Value_Primary { color:"+e.male.backgroundColor+"; } #"+t+" .OneVarMultiComparison_Expanded_CurrentBar { background-color:"+e.male.backgroundColor+"; }"],t),this._themeAddedFlag=!0}}},destroy:function(){b.removeStyle(this.parent.id),this.inherited(arguments)}}),V=e(m,{_toDetailView:function(e){this.inherited(arguments),this.onExpandedStateChanged()},collapseContent:function(){this._mainTable&&n.remove(this._mainTable,"clicked"),this._toMainView(),this.onExpandedStateChanged()},onExpandedStateChanged:function(){}}),k={};k[S.ONE_VAR]=F,k[S.AGE_PYRAMID]=M,k[S.RELATED_VARS]=T,k[S.TAPESTRY]=V;var N=e(g,{infographicStyleProvider:null,widgetParams:null,_requireReport:function(){this.type&&(k[this.type]?this._createReportWidget(this.type,k[this.type]):require([this._getAbsMid("./"+this.type)],t.hitch(this,this._createReportWidget,this.type)))},_createReportWidget:function(e,i){var r=this;if(!this._destroyed&&this.type===e){if(this._ge&&this._ge.isBusy())return void a.once(this._ge,"end",t.hitch(this,this._createReportWidget,this.type,i));if(this._autoTitlePromise)return void this._autoTitlePromise.then(t.hitch(this,this._createReportWidget,this.type,i));if(this.type){var n=this._widget=new i(this.domNode);t.mixin(n,this.widgetParams),n.onExpandedStateChanged=function(){r.onExpandedStateChanged()},n.infographicStyleProvider=this.infographicStyleProvider,n.title="string"==typeof this.title?this.title:this._autoTitle,n.subtitle=this.subtitle,n.expanded=this.expanded,n.on("resize",t.hitch(this,this._onResize)),isNaN(this._lastSelectedComparison)||n.setState({selectedComparison:this._lastSelectedComparison}),n.setDataProvider(this.dataProvider)}}},collapseContent:function(){this._widget&&this._widget.collapseContent&&this._widget.collapseContent()},getSelectedFeatureID:function(){return this._widget&&this._widget.getSelectedFeatureID&&this._widget.getSelectedFeatureID()},setSelectedFeatureID:function(e){this._widget&&this._widget.setSelectedFeatureID&&this._widget.setSelectedFeatureID(e)},onExpandedStateChanged:function(){}}),O=e([d,l],{templateString:x,nls:E,viewModel:null,themeContext:null,theme:null,_infographic:null,_progressHanlder:null,buildRendering:function(){R.init(),this.inherited(arguments)},postCreate:function(){this.inherited(arguments),this._showError(!1)},_currentInfographicJson:null,_getWidgetCreationParams:function(e){var t={};switch(e.type){case S.AGE_PYRAMID:t.showVerticalAxis=e.showVerticalAxis}return t},updateInfographic:function(e){function t(){if(e.calcData){var t={title:e.title,type:e.type,variables:e.variables};return t}return r(a.getOptions().getItems(a.countryID),function(t){var i;return t.some(function(t){if(t.variables&&t.variables.length){var r,n;e.variables.length>1&&(e.variables=[e.variables[0].substr(0,e.variables[0].lastIndexOf("."))+".*"]);var o=e.variables[0];-1!==o.indexOf(".*")?r=o.replace(".*",""):n=o;var a=t.variables[0];return n&&-1!==a.indexOf(n)?(i=t,!0):r&&0===a.indexOf(r)?(i=t,!0):void 0}}),i})}var i=this;if(this.viewDiv){this._destroyCurrentInfographic(),this._currentInfographicJson=e;var n=this.viewModel.getInfographicDefaultStyles(this.theme||this.themeContext);if(this._enrichInfographicJsonWithProps(e),this.viewModel.dynamicReportInfo&&this.viewModel.dynamicReportInfo.infographicOptions){var a=this.viewModel.dynamicReportInfo.infographicOptions;this.viewModel.dynamicReportInfo.isFixedDataMode||this.viewModel.dynamicReportInfo.geClient.hasCapability("ComparisonLevelsInCalculators")||(e.calcData=null),this._infographic=new N({infographicStyleProvider:n,widgetParams:this._getWidgetCreationParams(e),returnGeometry:!1,autoTitle:!1,subtitle:!1,levels:D.getSubLevels(e),highestLevel:D.getHighestLevel(e),onDataRequest:function(){i._showProgress(!0,"data")},onDataReady:function(){r(i.resize(),function(){i._showProgress(!1,"data")})},onDataError:function(){i._showProgress(!1,"data"),i._showError(!0)},onExpandedStateChanged:function(){i._doResize()}}).placeAt(this.infographicDiv),this._showProgress(!0,"item"),r(t(),function(t){if(i._showProgress(!1,"item"),t){var n=a.createGeoenrichment(e,i.viewModel.dynamicReportInfo.fieldData.areaData[0]);i._infographic.setGeoenrichment(n),i._infographic.set("studyArea",a.studyArea),i._infographic.set("countryID",a.countryID),i._infographic.set("type",e.type),i._infographic.set("variables",t.variables),i._infographic.set("title",t.title),i._infographic.startup();var o=!n.isBusy();e.title=e.title||t.title,r(i.resize(),function(){o&&i._showProgress(!1,"data")})}else i._showError(!0)})}else this._createDummyInfographic(e);v.set(this.viewDiv,n&&n.agePyramid&&n.agePyramid.theme||"light");var s=e.style&&e.style.backgroundColor||n&&n.backgroundColor;o.set(this._infographic.domNode,"backgroundColor",s),o.set(this._infographic.domNode,"fontFamily","inherit")}},_enrichInfographicJsonWithProps:function(e){D.setLevels(e,e.levels),e.variables||(e.variables=e.dataCollectionID?[e.dataCollectionID+".*"]:[e.variableID]),delete e.dataCollectionID,delete e.variableID},_createDummyInfographic:function(e){},_destroyCurrentInfographic:function(){this._showError(!1),this._showProgress(!1),this._infographic&&this._infographic.destroy(),this._infographic=null},_itemLoadingState:0,_dataLoadingState:0,_contentLoadingState:0,_showProgress:function(e,t){P[e?"showProgress":"removeProgress"](this.domNode),"item"===t?this._itemLoadingState=e?1:2:"data"===t&&(this._dataLoadingState=e?1:2),1!==this._itemLoadingState&&1!==this._dataLoadingState||0!==this._contentLoadingState||(this._contentLoadingState=1,this.onContentLoadingStart()),2===this._itemLoadingState&&2===this._dataLoadingState&&1===this._contentLoadingState&&(this._contentLoadingState=2,this.onContentLoadingEnd())},_showError:function(e){j.emulateErrors.contentErrors&&(e=!0),w[e?"show":"hide"](this.errorDiv),w[e?"hide":"show"](this.infographicDiv)},_adjustErrorMessage:function(){o.set(this.errorDiv,"paddingTop",o.get(this.domNode,"height")/2-20+"px")},notifyShown:function(){},width:null,height:null,resize:function(e,t){return void 0!==e&&(this.width=e,this.height=t),I.invoke(this,"_doResize",50)},_doResize:function(){function e(){if("OneVar"===i){var e=s(".OneVarMultiComparison_Table",t.domNode)[0],r=e?o.get(e,"height")+120:0;return Math.max(r,A[i])}if("Tapestry"===i){var e=s(".Tapestry_Main_Table",t.domNode)[0],r=e?o.get(e,"height")+60:0;return Math.max(r,A[i])}return A[i]}var t=this;if(this._infographic&&this._infographic.domNode&&w.isNodeInLayout(this.domNode)){var i=this._currentInfographicJson.type,r=Math.max(e(),this.height),n=r>this.height,a=this.width-(n?20:0);return o.set(this._infographic.domNode,{width:a+"px",height:r+"px"}),o.set(this.viewDiv,{height:this.height+"px",overflowY:"auto"}),this._infographic.resize(),this._adjustErrorMessage(),C.delay()}},getPreferredHeight:function(){return this._infographic&&o.get(this._infographic.domNode,"height")},collapseContent:function(){this._infographic&&this._infographic.collapseContent()},getVisualState:function(){return{selectedFeatureId:this._infographic&&this._infographic.getSelectedFeatureID()}},setVisualState:function(e){e&&e.selectedFeatureId&&this._infographic&&this._infographic.setSelectedFeatureID(e.selectedFeatureId)},toJson:function(){var e=t.clone(this._currentInfographicJson);return e},onContentLoadingStart:function(){},onContentLoadingEnd:function(){},destroy:function(){this._destroyCurrentInfographic(),this.inherited(arguments)}});return O.ThemableInfographic=N,O});