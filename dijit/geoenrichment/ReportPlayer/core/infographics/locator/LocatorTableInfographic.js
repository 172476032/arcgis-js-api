// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.25/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/when","dojo/string","dojox/uuid/generateRandomUuid","dojo/dom-class","dojo/dom-construct","dojo/dom-style","dijit/_WidgetBase","dijit/_TemplatedMixin","esri/dijit/geoenrichment/Pagination","esri/dijit/geoenrichment/PageNavigator","../../supportClasses/ViewModes","../../sections/supportClasses/SectionContentFitModes","../../../dataProvider/supportClasses/AreaDataUtil","./SectionJsonsBuilder","./ExportToExcelUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/InvokeUtil","esri/dijit/geoenrichment/utils/RegExpUtil","esri/dijit/geoenrichment/utils/WaitingUtil","dojo/text!../../templates/LocatorTableInfographic.html","dojo/i18n!esri/nls/jsapi"],function(t,i,e,n,o,s,a,r,h,l,c,g,u,d,_,p,f,m,P,C,v,w,x){x=x.geoenrichment.dijit.ReportPlayer.Infographics;var I=t([h,l],{templateString:w,nls:x,viewModel:null,theme:null,parentWidget:null,isEditMode:!1,minRowHeight:40,maxBulletsLimit:5,pagination:null,pageNavigator:null,_sections:null,_currentInfographicJson:null,_locatorPointsController:null,_isSinglePage:!1,_sectionJsons:null,_analysisArea:null,postCreate:function(){this.inherited(arguments),this._showEmptyView(!1),this._sections=[],this._createPagination(),this._createPageNavigator()},_createPagination:function(){var t=this;this.pagination=new c({createItemContainer:i.hitch(this,this._createItemContainer),updateItemContainer:i.hitch(this,this._updateItemContainer),scrollAnimation:"slide",cyclicPagination:!1,autoCenter:"stretch:1,1",onPageChanged:function(){t.pageNavigator.setCurrentPageIndex(t.pagination.get("currentPage"))}}).placeAt(this.paginationDiv),this.own(this.pagination),this.pagination.set("items",[]),this.pagination.startup()},_createPageNavigator:function(){var t=this;this.pageNavigator=new g({showArrows:!1,getNumPages:function(){return t.pagination.get("items").length},onPageChanged:function(i){t.pagination.set("currentPage",i)}}).placeAt(this.pageNavigatorDiv),this.own(this.pageNavigator)},_createItemContainer:function(){var t=a.create("div",{class:"locatorTableInfographic_paginationRoot"});return t.style.width=this._getPageWidth()+"px",t.style.height=this._getPageHeight()+"px",t},_updateItemContainer:function(t,e){var n=this;if(t&&t.parentNode){a.empty(t);var o=this._getSectionByJson(e);if(o&&o.domNode)o.placeAt(t);else{o&&o.destroy();var s={};s.class="infographicContainer_Section",s.initialWidth=this._getPageWidth(),s.json=e,s.viewModel=this.viewModel,s.theme=this.theme,s.tableClass="infographicContainerLocatorTable",s.hasFixedLayout=!1,s.parentWidget=this,s.noContentOffset=!0,s.tableParams={trimTextIfOverflows:!0},i.mixin(s,this._prepareSectionCreationParams()),o=this.viewModel.layoutBuilder.createElement("section",s,t),this._sections.push(o),this._putSectionToHash(o,e),o.setViewMode(this.isEditMode?u.EDIT:u.PREVIEW_VALUES),o.setResizedHeight(this._getPageHeight()),o.setWidth(this._getPageWidth());var r=o.getTables()[0];if(this._currentInfographicJson.scaleToFitHeight){var h=r.store.data.length,l=Math.max(this._getPageHeight(),h*this.minRowHeight);r.resizeToFitHeight(l)}r.onSortingChanged=function(t){n._setSorting(t)},this._sorting&&r.setSorting(this._sorting),o.fitContentNicely({fitMode:d.WIDTH}),this._locatorPointsController&&this._locatorPointsController.registerLocatorTable(r)}return o}},_prepareSectionCreationParams:function(t){return null},_getPageWidth:function(){return this.width},_getPageHeight:function(){return this._isSinglePage&&!this._currentInfographicJson.showNumberOfLocations?this.height:this.height-30},_sectionsHash:null,_getSectionByJson:function(t){return this._sectionsHash=this._sectionsHash||{},t._idInPagination||(t._idInPagination=o()),this._sectionsHash[t._idInPagination]},_putSectionToHash:function(t,i){this._sectionsHash&&(this._sectionsHash[i._idInPagination]=t)},_updatePromise:null,_stats:null,_unitedSectionJson:null,updateInfographic:function(t){if(this.domNode)return this._currentInfographicJson=t,this._currentInfographicJson.locatorCalculatorInfo&&this.viewModel.dynamicReportInfo&&(this._analysisArea=this.viewModel.dynamicReportInfo.analysisArea,this._locatorPointsController=this.viewModel.getLocatorPointsController(this._currentInfographicJson.locatorCalculatorInfo),this.own(this._locatorPointsController)),this.onContentLoadingStart(),this._updatePromise=P.invoke(this,"_doUpdateContent",50),v.showProgressPromise(this.domNode,this._updatePromise),this._updatePromise.always(function(){this.onContentLoadingEnd()}.bind(this)),this._updatePromise},_doUpdateContent:function(){if(this.domNode&&this.width){this._destroySections();var t=this._buildSectionJsonsAndStat();this._stats=t&&t.stats,this._unitedSectionJson=t&&t.unitedSectionJson,this._sectionJsons=t&&t.sectionJsons,this._showEmptyView(!t),t&&(this._isSinglePage=1===t.sectionJsons.length,s[this._isSinglePage?"add":"remove"](this.domNode,"singlePage"),this.paginationDiv.style.bottom=this._isSinglePage&&!this._currentInfographicJson.showNumberOfLocations?"":"30px",this.pagination.set("items",t.sectionJsons),this.pageNavigator.showAsBullets(t.sectionJsons.length<=this.maxBulletsLimit),this.pageNavigator.reset(),this._renderNumberOfLocationsFootNote(),this._locatorPointsController&&this._locatorPointsController.setLocatorTableCallbacks({getCellForPointAtFunc:this._getCellForPointAt.bind(this),getPointIndexForCellFunc:this._getPointIndexForCellFunc.bind(this)}),this._resizeContent(),this.onContentUpdated())}},_buildSectionJsonsAndStat:function(){return p.buildSectionJsonsAndStat({infographicJson:this._currentInfographicJson,calculator:this._getCalculatorData(),filterRanges:this._filterRanges,searchTextRe:this._searchTextRe,sorting:this._sorting,locatorPointsController:this._locatorPointsController,minRowHeight:this.minRowHeight,height:this.height,pageHeight:this._getPageHeight()})},_getCalculatorData:function(){return _.getAreaDataObjectCalculator(this.viewModel.dynamicReportInfo.fieldData.areaData[0],this._currentInfographicJson.calculatorName)},_renderNumberOfLocationsFootNote:function(){var t=this.getNumPointsShown()||0;this.footnoteDiv.innerHTML=this._currentInfographicJson.showNumberOfLocations&&t?1===t?x.oneClosestLocations||"One closest location":n.substitute(x.numClosestLocations||"Closest ${numPoints} locations",{numPoints:t}):"",s[this.footnoteDiv.innerHTML?"add":"remove"](this.domNode,"hasFootnote")},_getPointIndexForCellFunc:function(t){return t.gridData.__pointIndex},_getCellForPointAt:function(t){var i,e=-1;if(this._sectionJsons.some(function(n,o){return n.stack[0].data.data.some(function(s){if(s.__pointIndex===t)return e=o,i=n,!0})}),-1!==e){this.pagination.set("currentPage",e,!0);var n,o=this._getSectionByJson(i);return o.getTables()[0].getFieldCells().some(function(i){if(i.gridData.__pointIndex===t)return n=i,!0}),n}},_resizeContent:function(){this.domNode&&(this._syncJsonDimensions(),r.set(this.domNode,{width:this.width+"px",height:this.height+"px"}),this.pagination.resize(),setTimeout(this._syncEmptyViewPlaceholder.bind(this)))},_syncJsonDimensions:function(){this._currentInfographicJson&&(this._currentInfographicJson.style.width=this.width,this._currentInfographicJson.style.height=this.height)},_showEmptyView:function(t){m[t?"hide":"show"]([this.paginationDiv,this.pageNavigatorDiv,this.footnoteDiv]),m[t?"show":"hide"](this.noDataPlaceHolder),s[t?"add":"remove"](this.domNode,"isEmptyState"),t&&this._syncEmptyViewPlaceholder()},_syncEmptyViewPlaceholder:function(){this.noDataPlaceHolder&&r.set(this.noDataPlaceHolder,"paddingTop",(this.height-r.get(this.noDataPlaceHolder,"height"))/2+"px")},_filterRanges:null,_searchText:null,_searchTextRe:null,getStatRanges:function(){return e(this._updatePromise,function(){var t=[];if(this._stats)for(var e in this._stats.ranges)t.push(i.mixin({},this._stats.ranges[e]));return t}.bind(this))},setFilterRanges:function(t){t?(this._filterRanges={},t.forEach(function(t){this._filterRanges[t.fieldName]=t},this)):this._filterRanges=null,P.invoke(this,"_doUpdateContent",50)},setSearchText:function(t){this._searchText=t,this._searchTextRe=t&&C.createRegExp(t,"i",!0),P.invoke(this,"_doUpdateContent",50)},getNumPointsTotal:function(){return this._stats&&this._stats.numPointsTotal},getNumPointsShown:function(){return this._stats&&this._stats.numPointsShown},_sorting:null,_setSorting:function(t){this._sorting=t,P.invoke(this,"_doUpdateContent",50)},getVisualState:function(){if(!this._filterRanges&&!this._searchText&&!this._sorting)return null;var t;if(this._filterRanges){var t=[];for(var i in this._filterRanges)t.push(this._filterRanges[i])}return{filterRanges:t,searchText:this._searchText,sorting:this._sorting}},setVisualState:function(t){t&&(t.filterRanges&&this.setFilterRanges(t.filterRanges),t.searchText&&this.setSearchText(t.searchText),t.sorting&&this._setSorting(t.sorting))},notifyShown:function(){this._sections.forEach(function(t){t.notifyShown()})},width:null,height:null,resize:function(t,i){void 0!==t&&(this.width=t,this.height=i),P.invoke(this,"_doUpdateContent",50)},toJson:function(){return i.clone(this._currentInfographicJson)},canExportToExcel:function(){return this.viewModel.canExportToExcel()},exportToExcel:function(){var t=this;return e(this._updatePromise,function(){return e(t.viewModel.pepareExportToExcelParameters({layerID:t._locatorPointsController.getLayerID(),hasMaps:t._locatorPointsController.getMapInfos()&&t._locatorPointsController.getMapInfos().length}),function(i){return v.showProgressPromise(t.domNode,e(t.prepareExportToExcelParameters(i),function(i){return t.viewModel.exportToExcel(i)}))})})},prepareExportToExcelParameters:function(t){return t=t||{},f.prepareExportParameters({areaName:this._analysisArea.name,areaShortName:this._analysisArea.shortName,layerName:this._locatorPointsController.getLayerName(),layerID:this._locatorPointsController.getLayerID(),sectionJson:this._unitedSectionJson,mapInfos:this._locatorPointsController.getMapInfos(),exportMaps:t.exportMaps})},onContentLoadingStart:function(){},onContentLoadingEnd:function(){},onContentUpdated:function(){},_destroySections:function(){this._stats=null,this._sections.forEach(function(t){t.destroy()}),this._sections.length=0},destroy:function(){this._destroySections(),this.inherited(arguments)}});return I.MIN_ROW_HEIGHT=40,I});