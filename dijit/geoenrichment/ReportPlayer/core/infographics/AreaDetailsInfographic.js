// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-construct","dojo/dom-style","dijit/_WidgetBase","dijit/_TemplatedMixin","esri/dijit/geoenrichment/_Invoke","./infographicUtils/InfographicThemeUtil","./infographicUtils/InfographicLayoutResizer","../supportClasses/TableUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/ObjectUtil","./supportClasses/AreaDetailsLayouts","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes","dojo/text!../templates/AreaDetailsInfographic.html","dojo/i18n!../../../../../nls/jsapi"],function(t,e,i,n,o,s,a,r,l,h,u,c,d,g,m,f){function p(){return _?_:_={getAttributes:function(){return[{alias:"Building Area (sq. feet)",value:1e3},{alias:"Frontage (feet)",value:100},{alias:"Parking",value:30},{alias:"Site Area (sq. feet)",value:500.5},{alias:"Number of Employees",value:300},{alias:"Sales Volume ($)",value:15e5}]},getNotes:function(){return[{text:"This is a placeholder note. Here will be displayed some information about the area."},{text:"This is a placeholder note. Here will be displayed some information about the area."}]}}}f=f.geoenrichment.dijit.ReportPlayer.ReportPlayer;var _,y={_calcBuildInfo:function(t,e){if(!t)return null;var i=t.getAttributes()||[],n=t.getNotes()||[];if(e.showAttributes===!1&&(i=[]),e.showNotes===!1&&(n=[]),!i.length&&!n.length)return null;var o=e.attributesLayout==d.ATTRS_2COLUMNS,s=o?Math.round(i.length/2):i.length,a=(s?s+1:0)+(n.length?n.length+1:0),r=e.style.height-h.getTableHeight(e.header)-1,l=Math.max(h.DEFAULT_ROW_HEIGHT,r/a);return{attrs:i,notes:n,numRows:a,numColumns:o?4:2,width:e.style.width,rowH:l}},buildStack:function(t,i,n,o,s){function a(t,i,a){var r=a?n:o,l=e.mixin({verticalAlign:"middle",horizontalAlign:i?"right":void 0,horizontalPadding:t?5:20},r);return t&&(l.fontSize*=1.2),s&&(l.backgroundColor=s),l}function r(t,e){e=e||0,h.modifyTableJson(u,g,0+e,{text:t?t.alias:"",cellStyle:a(!1,!1,!0),height:l.rowH}),h.modifyTableJson(u,g,1+e,{text:t?c.formatNumber(t.value):"",cellStyle:a(!1,!0,!0)})}var l=this._calcBuildInfo(t,i);if(!l)return null;var u=h.createTable({numColumns:l.numColumns,numRows:l.numRows,style:{width:l.width},useDefaultTheme:!1});u.scaleToFitHeight=!0;var g=0;if(l.attrs.length){var m=i.attributesLayout==d.ATTRS_2COLUMNS;h.modifyTableJson(u,g,0,{text:f.attributes,columnSpan:l.numColumns,cellStyle:a(!0,!1,!0),height:l.rowH}),g++;for(var p=0;p<l.attrs.length;p++){var _=l.attrs[p];r(_),m&&(_=l.attrs[++p],r(_,l.numColumns/2)),g++}}return l.notes.length&&(h.modifyTableJson(u,g,0,{text:f.notes,columnSpan:l.numColumns,cellStyle:a(!0),height:l.rowH}),g++,l.notes.forEach(function(t){h.modifyTableJson(u,g,0,{text:t.text,columnSpan:l.numColumns,cellStyle:a(),height:l.rowH}),g++})),[u]}},v={adjustContent:function(t){var e=t.getFieldCells(),i=[];e.forEach(function(t){if(t.valueLabel&&t.valueLabel.innerHTML){var e=i[t.gridData.index]=i[t.gridData.index]||{};e.cells=e.cells||[],e.cells.push(t),e.h=Math.max(e.h||0,t.getHeight()),e.minH=Math.max(e.minH||0,n.get(t.valueLabel,"height"))}});var o=0,s=0,a=[],r=[];for(var l in i){var h=i[l];if(h.h>h.minH){var u=h.h-h.minH;o+=u,a.push({cells:h.cells,maxHR:u,rowH:h.h})}else if(h.h<h.minH){var c=h.minH-h.h+4;s+=c,r.push({cells:h.cells,hInc:c,rowH:h.h})}}if(s>0){var d=Math.min(1,s/o),g=Math.min(1,o/s);a.forEach(function(e){e.cells.forEach(function(i){t.setCellHeight(i,e.rowH-e.maxHR*d)})}),r.forEach(function(e){e.cells.forEach(function(i){t.setCellHeight(i,e.rowH+e.hInc*g)})})}}};return t([o,s,a],{templateString:m,nls:f,viewModel:null,themeContext:null,theme:null,_sections:null,_currentInfographicJson:null,postCreate:function(){this.inherited(arguments),this._showEmptyView(!1)},_getInfographicBackgroundColor:function(){var t=this.viewModel.getStaticInfographicDefaultStyles(this.theme||this.themeContext);return this._currentInfographicJson.style.backgroundColor||t&&t.backgroundColor},updateInfographic:function(t){this.domNode&&(this._currentInfographicJson=this._applyThemeToJson(t),n.set(this.domNode,"backgroundColor",this._getInfographicBackgroundColor()),this.invoke("_doUpdateContent",50))},_resizeContent:function(){var t={w:this.width,h:this.height};l.resizeLayout(this._currentInfographicJson,t),n.set(this.domNode,{width:this.width+"px",height:this.height+"px"}),setTimeout(function(){n.set(this.noDetailsPlaceHolder,"paddingTop",(this.height-n.get(this.noDetailsPlaceHolder,"height"))/2+"px")}.bind(this))},_doUpdateContent:function(){this._resizeContent(),this._createSections()},_getDetailsSectionStack:function(){var t=this.viewModel.dynamicReportInfo?this.viewModel.dynamicReportInfo.attachmentsStore:p();return y.buildStack(t,this._currentInfographicJson,this._getAttributesStyle(),this._getNotesStyle(),this._getInfographicBackgroundColor())},_createSections:function(){this._destroySections();var t=this._getDetailsSectionStack();if(!t)return void this._showEmptyView(!0);this._showEmptyView(!1);var e=this._currentInfographicJson.header;this._createSection([e],0,!0),this._createSection(t,h.getTableHeight(e))},_createSection:function(t,i,o){var s={};s["class"]="infographicContainer_Section",s.initialWidth=h.getTableWidth(t[0]),s.json={type:g.DETAILS,stack:t},s.viewModel=this.viewModel,s.themeContext=this.themeContext,s.theme=this.theme,s.tableClass="infographicContainerAreaDetailsTable",s.tableParams={trimTextIfOverflows:!0},s.hasFixedLayout=!0,e.mixin(s,this._prepareSectionCreationParams());var a=this.viewModel.layoutBuilder.createElement("section",s,this.contentDiv);a.setResizedHeight(h.getTableHeight(t[0])),n.set(a.domNode,{position:"absolute",left:"0px",top:(i||0)+"px"}),this._sections.push(a),!o&&v.adjustContent(a.getTables()[0])},_prepareSectionCreationParams:function(t){return null},_destroySections:function(){this._sections=this._sections||[],this._sections.forEach(function(t){t.destroy()}),this._sections.length=0},_getAttributesStyle:function(){return this.__getContentStyle("attributesStyle")},_getNotesStyle:function(){return this.__getContentStyle("notesStyle")},__getContentStyle:function(t){var i=this.viewModel.getDocumentDefaultStyles(this.theme||this.themeContext);return e.mixin({},i,this.viewModel.getTableDefaultStyles(this.theme||this.themeContext,"Default"),this._currentInfographicJson[t])},_showEmptyView:function(t){u[t?"show":"hide"](this.noDetailsPlaceHolder)},width:null,height:null,resize:function(t,e){void 0!==t&&(this.width=t,this.height=e),this.invoke("_doUpdateContent",50)},notifyShown:function(){this.resize()},_applyThemeToJson:function(t){var e=this.viewModel.getStaticInfographicDefaultStyles(this.theme||this.themeContext);return r.applyThemeSettingsToJson(t,e)},_undoThemeFromJson:function(t){return t},toJson:function(){var t=e.clone(this._currentInfographicJson);return this._undoThemeFromJson(t)},destroy:function(){this._destroySections(),this.inherited(arguments)}})});