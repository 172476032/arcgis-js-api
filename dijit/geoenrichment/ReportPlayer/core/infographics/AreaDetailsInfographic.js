// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/promise/all","dojo/when","dojo/dom-construct","dojo/dom-style","dijit/_WidgetBase","dijit/_TemplatedMixin","esri/dijit/geoenrichment/_Invoke","./infographicUtils/InfographicThemeUtil","./infographicUtils/InfographicLayoutResizer","../supportClasses/TableUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/WaitingUtil","./supportClasses/AreaDetailsLayouts","../../dataProvider/supportClasses/attachments/AttributesUtil","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes","dojo/text!../templates/AreaDetailsInfographic.html","dojo/i18n!../../../../../nls/jsapi"],function(t,e,i,n,o,s,r,a,l,h,u,c,d,g,f,m,p,y,_){function S(){return v||(v={getAttributes:function(){return[{alias:"Building Area (sq. feet)",value:1e3,type:"esriFieldTypeDouble"},{alias:"Frontage (feet)",value:100,type:"esriFieldTypeDouble"},{alias:"Parking",value:30,type:"esriFieldTypeInteger"},{alias:"Site Area (sq. feet)",value:500.5,type:"esriFieldTypeDouble"},{alias:"Number of Employees",value:300,type:"esriFieldTypeInteger"},{alias:"Address",value:"123 Main Street, City, State 55555",type:"esriFieldTypeString"}]},getNotes:function(){return[{text:"This is a placeholder note. Here will be displayed some information about the area."},{text:"This is a placeholder note. Here will be displayed some information about the area."}]}})}_=_.geoenrichment.dijit.ReportPlayer.Infographics;var v,b={_calcBuildInfo:function(t,e){return t?i([t.getAttributes(),t.getNotes()]).then(function(t){var i=t[0]||[],n=t[1]||[];if(e.showAttributes||(i=[]),e.showNotes||(n=[]),!i.length&&!n.length)return null;var o=e.attributesLayout===f.ATTRS_2COLUMNS,s=o?Math.round(i.length/2):i.length,r=(s?s+1:0)+(n.length?n.length+1:0),a=e.style.height-c.getTableHeight(e.header),l=Math.max(c.DEFAULT_ROW_HEIGHT,a/r);return{attrs:i,notes:n,numRows:r,numColumns:o?4:2,width:e.style.width,rowH:l}}):null},buildStack:function(t,i,o,s,r){return n(this._calcBuildInfo(t,i),function(t){function n(t,i,n){var a=n?o:s,l=e.mixin({verticalAlign:"middle",horizontalAlign:i?"right":void 0,horizontalPadding:t?5:20},a);return t&&(l.fontSize*=1.2),r&&(l.backgroundColor=r),l}function a(e,i){i=i||0,c.modifyTableJson(l,h,0+i,{text:e?e.alias:"",cellStyle:n(!1,!1,!0),height:t.rowH}),c.modifyTableJson(l,h,1+i,{text:m.formatAttributeValue(e),cellStyle:n(!1,!0,!0)})}if(!t)return null;var l=c.createTable({numColumns:t.numColumns,numRows:t.numRows,style:{width:t.width},useDefaultTheme:!1});l.scaleToFitHeight=!0;var h=0;if(t.attrs.length){var u=i.attributesLayout===f.ATTRS_2COLUMNS;c.modifyTableJson(l,h,0,{text:_.attributes,columnSpan:t.numColumns,cellStyle:n(!0,!1,!0),height:t.rowH}),h++;for(var d=0;d<t.attrs.length;d++){var g=t.attrs[d];a(g),u&&(g=t.attrs[++d],a(g,t.numColumns/2)),h++}}return t.notes.length&&(c.modifyTableJson(l,h,0,{text:_.notes,columnSpan:t.numColumns,cellStyle:n(!0),height:t.rowH}),h++,t.notes.forEach(function(e){c.modifyTableJson(l,h,0,{text:e.text,columnSpan:t.numColumns,cellStyle:n(),height:t.rowH}),h++})),[l]})}},w={adjustContent:function(t){var e=t.getFieldCells(),i=[];e.forEach(function(t){if(t.valueLabel&&t.valueLabel.innerHTML){var e=i[t.gridData.index]=i[t.gridData.index]||{};e.cells=e.cells||[],e.cells.push(t),e.h=Math.max(e.h||0,t.getHeight()),e.minH=Math.max(e.minH||0,s.get(t.valueLabel,"height"))}});var n=0,o=0,r=[],a=[];for(var l in i){var h=i[l];if(h.h>h.minH){var u=h.h-h.minH;n+=u,r.push({cells:h.cells,maxHR:u,rowH:h.h})}else if(h.h<h.minH){var c=h.minH-h.h+4;o+=c,a.push({cells:h.cells,hInc:c,rowH:h.h})}}if(o>0){var d=Math.min(1,o/n),g=Math.min(1,n/o);r.forEach(function(e){e.cells.forEach(function(i){t.setCellHeight(i,e.rowH-e.maxHR*d)})}),a.forEach(function(e){e.cells.forEach(function(i){t.setCellHeight(i,e.rowH+e.hInc*g)})})}}};return t([r,a,l],{templateString:y,nls:_,viewModel:null,theme:null,parentWidget:null,_sections:null,_currentInfographicJson:null,postCreate:function(){this.inherited(arguments),this._showEmptyView(!1)},_getInfographicBackgroundColor:function(){var t=this.viewModel.getStaticInfographicDefaultStyles(this.theme);return this._currentInfographicJson.style.backgroundColor||t&&t.backgroundColor},updateInfographic:function(t){this.domNode&&(this._currentInfographicJson=this._applyThemeToJson(t),s.set(this.domNode,"backgroundColor",this._getInfographicBackgroundColor()),this.invoke("_doUpdateContent",50))},_resizeContent:function(){this._syncJsonDimensions(),s.set(this.domNode,{width:this.width+"px",height:this.height+"px"}),setTimeout(function(){s.set(this.noDetailsPlaceHolder,"paddingTop",(this.height-s.get(this.noDetailsPlaceHolder,"height"))/2+"px")}.bind(this))},_syncJsonDimensions:function(){if(this._currentInfographicJson){var t={w:this.width,h:this.height};u.resizeLayout(this._currentInfographicJson,t)}},_doUpdateContent:function(){return this._resizeContent(),this._createSections()},_getDetailsSectionStack:function(){var t=this.viewModel.dynamicReportInfo?this.viewModel.dynamicReportInfo.attachmentsStore:S();return b.buildStack(t,this._currentInfographicJson,this._getAttributesStyle(),this._getNotesStyle(),this._getInfographicBackgroundColor())},_createSections:function(){return this._destroySections(),this.onContentLoadingStart(),g.showProgressPromise(this.domNode,n(this._getDetailsSectionStack(),function(t){if(!t)return void this._showEmptyView(!0);this._showEmptyView(!1);var e=this._currentInfographicJson.header;this._createSection([e],0,!0),this._createSection(t,c.getTableHeight(e)),this.onContentLoadingEnd()}.bind(this)))},_createSection:function(t,i,n){i=i||0;var o={};o.class="infographicContainer_Section",o.initialWidth=c.getTableWidth(t[0]),o.json={type:p.DETAILS,stack:t},o.viewModel=this.viewModel,o.theme=this.theme,o.tableClass="infographicContainerAreaDetailsTable",o.tableParams={trimTextIfOverflows:!0},o.hasFixedLayout=!0,o.parentWidget=this,e.mixin(o,this._prepareSectionCreationParams());var r=this.viewModel.layoutBuilder.createElement("section",o,this.contentDiv);r.setResizedHeight(c.getTableHeight(t[0])),s.set(r.domNode,{position:"absolute",left:"0px",top:i+"px"}),this._sections.push(r),!n&&w.adjustContent(r.getTables()[0]),n||s.set(this.contentDiv,"height",i+r.getResizedHeight()+"px")},_prepareSectionCreationParams:function(t){return null},_destroySections:function(){this._sections=this._sections||[],this._sections.forEach(function(t){t.destroy()}),this._sections.length=0},_getAttributesStyle:function(){return this.__getContentStyle("attributesStyle")},_getNotesStyle:function(){return this.__getContentStyle("notesStyle")},__getContentStyle:function(t){var i=this.viewModel.getDocumentDefaultStyles(this.theme);return e.mixin({},i,this.viewModel.getTableDefaultStyles(this.theme,"Default"),this._currentInfographicJson[t])},_showEmptyView:function(t){d[t?"show":"hide"](this.noDetailsPlaceHolder)},width:null,height:null,resize:function(t,e){void 0!==t&&(this.width=t,this.height=e),this._syncJsonDimensions(),this.invoke("_doUpdateContent",50)},notifyShown:function(){},_applyThemeToJson:function(t){var e=this.viewModel.getStaticInfographicDefaultStyles(this.theme);return h.applyThemeSettingsToJson(t,e)},_undoThemeFromJson:function(t){return t},onContentLoadingStart:function(){},onContentLoadingEnd:function(){},toJson:function(){var t=e.clone(this._currentInfographicJson);return this._undoThemeFromJson(t)},destroy:function(){this._destroySections(),this.inherited(arguments)}})});