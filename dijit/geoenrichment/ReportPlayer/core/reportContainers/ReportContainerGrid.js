// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/Deferred","dojo/on","dojo/sniff","dojo/dom-construct","dojo/dom-class","dojo/dom-geometry","dojo/dom-style","dojo/store/Memory","dijit/_WidgetBase","dijit/_TemplatedMixin","../grid/coreUtils/GridDataUtil","./containerGridUtils/QueryUtil","./containerGridUtils/SerializationManager","./containerGridUtils/ContentLoadingEventManager","./containerGridUtils/ZoomUtil","../supportClasses/DocumentOptions","../supportClasses/templateJsonUtils/FieldInfoBuilder","../themes/ThemeUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes","dojo/text!../templates/ReportContainerGrid.html"],function(t,e,i,n,o,r,a,s,d,l,h,c,u,g,m,f,p,C,_,y,v,x,w){return t([h,c],{templateString:w,viewModel:null,themeContext:null,theme:null,serializationManager:null,loadingManager:null,documentOptions:null,isSourceContainer:!0,isDynamicReportMode:!1,showWatermark:!0,renderOptions:{center:!1,minTop:0},grids:null,postCreate:function(){this.serializationManager=(new this._getSerializationManagerClass)(this),this.grids=[],this.inherited(arguments),this.updateLayout(),this.setViewMode(null),this.isSourceContainer&&a.add(this.domNode,"reportContainerGrid_sourceContainer")},_getSerializationManagerClass:function(){return m},setDocumentOptions:function(t,i){this.documentOptions&&e.mixin(this.documentOptions,t),this.updateLayout(i)},updateLayout:function(t){var e=this;this.documentOptions&&(this._updateContainerSize(),this.grids.forEach(function(i,n){t&&void 0!==t.pageIndex&&t.pageIndex!==n||(e._updateGridWrappingNodeForCurrentDocumentLayout(i),i.setMaxWidth(e._getAllowedPageWidth()),i.resizeToFitAllowedWidth(),i.resizeToFitHeight(e._getPageHeight()))}),this._syncFillerContainer())},getFirstPageDomNode:function(){var t=this.stackContainer.children[0];return t&&t.children[0]},getPageDomNodes:function(){return this._getGridContainers()},_getGridContainers:function(){for(var t=[],e=0;e<this.stackContainer.children.length;e++){var i=this.stackContainer.children[e];i&&t.push(i.children[0])}return t},_placeGridContainer:function(t,e){var i=r.create("div",{"class":"reportContainerGrid_gridContainerWrapper"}),n=void 0!==e&&this.stackContainer.children[e];n?r.place(i,n,"before"):r.place(i,this.stackContainer),r.place(t,i),t.backgroundImage=r.create("div",{"class":"reportContainerGrid_stackContainerBackgroundImage esriGEAbsoluteStretched"},t),o("ie")||this.viewModel.dynamicReportInfo||!this.showWatermark||(this._sampleWatermarkDiv=r.create("div",{"class":"sampleValuesWatermark esriGEAbsoluteStretched"},t,"first"))},_getGridContainer:function(t){return t.domNode&&t.domNode.parentNode},_getGridContainerWrapper:function(t){var e=this._getGridContainer(t);return e&&e.parentNode},_updateGridWrappingNodeForCurrentDocumentLayout:function(t){var e=this._getGridContainer(t);if(e){var i=this.viewModel.getDocumentDefaultStyles(this.theme||this.themeContext);d.set(e,{paddingLeft:(this.documentOptions.left||0)+"px",paddingRight:(this.documentOptions.right||0)+"px",paddingTop:(this.documentOptions.top||0)+"px",paddingBottom:(this.documentOptions.bottom||0)+"px",backgroundColor:this.documentOptions.backgroundColor||i.backgroundColor})}y.applyBackgroundImageFromSettings(e.backgroundImage,i.backgroundImage)},_updateContainerSize:function(){var t=0==this._heigth?"auto":d.get(this.domNode,"height")+"px";d.set(this.mainContainer,"height",t),d.set(this.mainContainer,"maxWidth",this._maxWidth?this._maxWidth+"px":""),d.set(this.mainContainer,"maxHeight",this._maxHeight?this._maxHeight+"px":""),this._syncFillerContainer()},getCurrentPageDim:function(){return C.getPageBox(this.documentOptions)},_getAllowedPageWidth:function(){return this.getCurrentPageDim().contentW},_getPageHeight:function(){return this.getCurrentPageDim().contentH},getCanvasOffsets:function(){var t=s.position(this.mainContainer),e=s.position(this.fillerContainer);return{l:e.x-t.x,r:t.x+t.w-e.x-e.w}},collapseContent:function(){return this.grids.forEach(function(t){t.collapseContent()})},hasHiddenContent:function(){return this.grids.some(function(t){return t.hasHiddenContent()})},resizeRowHeightToShowCellsContent:function(){var t;return this.grids.forEach(function(e){t=e.resizeRowHeightToShowCellsContent()||t}),t},_currentPageIndex:-1,getFullWidth:function(){var t=this.getFirstPageDomNode();return s.getMarginBox(t).w+s.getMarginExtents(this.stackContainer).w},getFullHeight:function(){var t=this.getFirstPageDomNode();return s.getMarginBox(t).h+s.getMarginExtents(this.stackContainer).h},getNumberOfPages:function(){return this.grids.length},showAllPages:function(){this.showPageAt(-1)},showPageAt:function(t){this.grids.forEach(function(e,i){v[-1==t||t==i?"showNodeFromBackground":"hideNodeInBackground"](this._getGridContainerWrapper(e))},this),this._currentPageIndex=t,this._syncFillerContainer()},getCurrentPageIndex:function(){return this._currentPageIndex},_width:0,_heigth:0,resize:function(t,e){this._width=void 0===t?this._width:t,this._heigth=void 0===e?this._heigth:e,void 0!==t&&d.set(this.domNode,"width",0==this._width?"auto":this._width+"px"),void 0!==e&&d.set(this.domNode,"height",0==this._heigth?"auto":this._heigth+"px"),this._updateContainerSize()},_maxWidth:0,_maxHeight:0,setMaxWidth:function(t){this._maxWidth=t},setMaxHeight:function(t){this._maxHeight=t},scrollToElement:function(t,e){if(e=e||{},t&&t.parentGrid){var i=s.position(this.getScrollableContainer()),n=s.position(t.domNode),o=!(n.x>i.x&&i.x+i.w>n.x+n.w),r=!(n.y>i.y&&i.y+i.h>n.y+n.h),a=30,d={x:Math.max(a,(i.w-n.w)/2),y:Math.min(i.h-n.h-a,(i.h-n.h)/2)};if(d.dx=d.x-(n.x-i.x),d.dy=d.y-(n.y-i.y),!e.onlyIfOutOfView||o||r){var l=this._getGridContainerWrapper(t.parentGrid);return l&&(e.scrollHorizontally===!1||!o&&e.onlyIfOutOfView||(this.getScrollableContainer().scrollLeft-=d.dx),r||!e.onlyIfOutOfView)?this._animateScrolling(this.getScrollableContainer().scrollTop-d.dy,e.immdediate):void 0}}},_animateScrolling:function(t,e){this.getScrollableContainer().scrollTop=t},scrollToPageAt:function(t){var e=this.grids[t];this.scrollToElement(e.getFieldCells()[0],{scrollHorizontally:!1})},scrollToLastPage:function(){this.scrollToPageAt(this.grids.length-1)},getCurrentViewedPageIndex:function(){var t=this.getScrollableContainer().scrollHeight/this.grids.length;return Math.round(this.getScrollableContainer().scrollTop/t)},getScrollableContainer:function(){return this.mainContainer},getLayoutCells:function(t){return g.getLayoutCells(this,t)},clear:function(t){this.grids.forEach(function(t){t.destroy()}),this.grids.length=0,r.empty(this.stackContainer),this._syncFillerContainer()},clearLayoutCell:function(t,e){t.parentGrid&&(t.parentGrid.clearCell(t),t.parentGrid.setCellStyle(t,{backgroundColor:"transparent"}),e&&t.parentGrid.insertFieldInfoToCell(t,this.createEmptySectionJson()))},_removeGrid:function(t){if(t){var e=this._getGridContainerWrapper(t);t.destroy(),e&&r.destroy(e),this.grids.splice(this.grids.indexOf(t),1),this._syncFillerContainer()}},setHeight:function(t){d.set(this.mainContainer,"height",t+"px")},_viewMode:null,getViewMode:function(){return this._viewMode},setViewMode:function(t){this._viewMode=t,"edit"==t?(a.add(this.domNode,"reportContainerEditMode"),a.remove(this.domNode,"reportContainerPreviewMode")):(a.remove(this.domNode,"reportContainerEditMode"),a.add(this.domNode,"reportContainerPreviewMode")),this._updateContainerSize(),this._updateGridCellsOverlay(),this.grids.forEach(function(e){e.setViewMode(t)})},_updateGridCellsOverlay:function(){var t=this;this.getLayoutCells().forEach(function(e){t._updateLayoutCellOverlay(e)})},hasFocusedChild:function(){return g.hasFocusedChild(this)},collectFieldInfos:function(t){return g.collectFieldInfos(this,t)},_isLayoutCellDragEnabled:function(t){return!1},createGridFromSectionTableJson:function(i,n){var o=this;void 0!==n&&this._removeGrid(this.grids[n]);var a=i.data||{},s=t(this.viewModel.layoutBuilder.getClass("grid"),{_isDragEnabled:function(t){return this.inherited(arguments)&&o._isLayoutCellDragEnabled(t)}}),d=r.create("div",{"class":"reportContainerGrid_stackContainer"});this._placeGridContainer(d,n);var h=new s(e.mixin({"class":"outerAdjustableGrid",fieldCellClass:"outerAdjustableGridCell",viewModel:this.viewModel,themeContext:this.themeContext,theme:this.theme,viewPortContainer:this.mainContainer,stickToRight:!0,keepGridSizeWhenResized:!1,looseResize:!0,renderBordersFromTheme:!0,inheritThemeBackground:!1,columns:a.columns||[],store:new l({data:a.data||[],idProperty:"id"}),layoutDefaults:{defaultRowHeight:250,rowMinHeight:100,columnMinWidth:100},_preRenderFieldCell:function(t){var e=u.getFieldInfo(t);e||o.isSourceContainer||u.setFieldInfo(t,o.createEmptySectionJson())},_postCreateFieldCell:function(t){o._updateLayoutCellOverlay(t),o._addControlsToLayoutCell(t)},onContentLoadingStart:function(){o.loadingManager&&o.loadingManager.onContentLoadingStart()},onContentLoadingEnd:function(){o.loadingManager&&o.loadingManager.onContentLoadingEnd()}},this._getGridCreationParams()),r.create("div",null,d));return h.setMaxWidth(this._getAllowedPageWidth()),h.setSettings({style:{width:this._getAllowedPageWidth(),left:0,spaceBefore:0,spaceAfter:0}}),h.setViewMode(this._viewMode),this._updateGridWrappingNodeForCurrentDocumentLayout(h),void 0!==n?this.grids.splice(n,0,h):this.grids.push(h),this._syncFillerContainer(),h},createEmptySectionJson:function(){return _.createFieldInfoFromSection({type:x.EMPTY})},_getGridCreationParams:function(){return null},_updateLayoutCellOverlay:function(t){if(!this.isDynamicReportMode){var e=v.enableContent(t.contentBlock,"edit"==this._viewMode);e&&!this.isSourceContainer&&n(e,"dblclick",function(){t.content&&t.content.processDoubleClick&&t.content.processDoubleClick()})}},_addControlsToLayoutCell:function(t){},addEmptyPageGrid:function(t,e){var i=e||this.serializationManager.getEmptyPageJson(!0);this.createGridFromSectionTableJson(i.sectionsTables[0])},notifyShown:function(){this.serializationManager.notifyShown()},getVisualState:function(){return{grids:this.grids.map(function(t){return t.getVisualState()})}},setVisualState:function(t){t&&t.grids&&t.grids.length==this.grids.length&&this.grids.forEach(function(e,i){e.setVisualState(t.grids[i])})},getZoomInfo:function(){return p.getZoomInfo(this)},setZoomInfo:function(t){p.setZoomInfo(this,t)},zoomIn:function(){p.zoomIn(this)},zoomOut:function(){p.zoomOut(this)},zoomToFitPage:function(){p.zoomToFitPage(this)},zoomToFitPageWidth:function(){p.zoomToFitPageWidth(this)},setZoomPercent:function(t){p.setZoomPercent(this,t)},setBestZoom:function(){p.setBestZoom(this)},resetZoom:function(){p.reset(this)},onZoomChanged:function(){},_syncFillerContainer:function(){var t=this.getZoomInfo().scale;if(d.set(this.fillerContainer,"marginTop",""),d.set(this.fillerContainer,{width:d.get(this.scalableContainer,"width")*t+"px",height:d.get(this.scalableContainer,"height")*t+"px"}),this.renderOptions&&this.renderOptions.center){var e=(d.get(this.mainContainer,"height")-d.get(this.fillerContainer,"height"))/2;d.set(this.fillerContainer,"marginTop",Math.max(this.renderOptions.minTop||0,e)+"px")}},fromJson:function(t,e){return this.resetZoom(),this._currentPageIndex=-1,this.loadingManager&&this.loadingManager.destroy(),this.loadingManager=null,e=e||{},e.waitUntilAllContentIsReady?(this.loadingManager=new f,this.loadingManager.init(),this.serializationManager.fromJson(t),this.loadingManager.returnOnLoadEnd()):this.serializationManager.fromJson(t)},toJson:function(){return this.serializationManager.toJson()},onPendingDataApplied:function(){},removeFieldInfoSelection:function(){},emitOnPreChangeEvent:function(t,e){},destroy:function(){this.loadingManager&&this.loadingManager.destroy(),this.loadingManager=null,this.clear(),this.inherited(arguments)}})});