// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/on","dojo/dom-construct","dojo/dom-class","dojo/dom-geometry","dojo/dom-style","dijit/_WidgetBase","dijit/_TemplatedMixin","../grid/ValueField","./containerUtils/QueryUtil","./containerUtils/SerializationManager","../supportClasses/DocumentOptions","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes","esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/ViewModes","dojo/text!../templates/ReportContainer.html"],function(e,t,i,n,o,s,r,l,a,h,c,d,m,u,p,g,f){return e([l,a],{templateString:f,viewModel:null,theme:null,parentWidget:null,documentOptions:null,_sampleWatermarkDiv:null,queryUtil:c,serializationManager:null,postCreate:function(){this.inherited(arguments),this.serializationManager=(new this._getSerializationManagerClass)(this),this.updateLayout(),this.setViewMode(g.PREVIEW_VALUES)},_getSerializationManagerClass:function(){return d},_sectionWidth:0,setDocumentOptions:function(e){this.documentOptions&&t.mixin(this.documentOptions,e),this.updateLayout()},updateLayout:function(){if(this.documentOptions){this._sectionWidth=m.getPageBox(this.documentOptions).contentW,this._updateContainerSize(),r.set(this.stackContainer,{paddingLeft:(this.documentOptions.left||0)+"px",paddingRight:(this.documentOptions.right||0)+"px",paddingTop:(this.documentOptions.top||0)+"px",paddingBottom:(this.documentOptions.bottom||0)+"px"});var e=this;this.getReportElements("setWidth").forEach(function(t){e.getElementSection(t).setWidth(e._getSectionWidth(),{resizeContentToFit:!0,preserveRightOffset:!0}),e.updateReportElement(t)})}},resizeReportElementContentToFitPageWidth:function(e){var t=e&&this.getElementSection(e);t&&t.setWidth(this._getSectionWidth(),{resizeContentToFit:!0,forceResize:!0}),this.updateReportElement(e)},getCurrentPageDim:function(){return m.getPageBox(this.documentOptions)},_updateContainerSize:function(){r.set(this.stackContainer,"width",this._sectionWidth+(this._viewMode===g.EDIT?145:0)+"px"),r.set(this.mainContainer,"height",r.get(this.domNode,"height")+(this._viewMode===g.EDIT?-17:0)+"px")},_getSectionWidth:function(){return this._sectionWidth},resize:function(e,t){void 0!==e&&r.set(this.domNode,{width:e+"px",height:t+"px"}),this._updateContainerSize()},getCanvasOffsets:function(){var e=r.get(this.domNode,"width"),t=r.get(this.stackContainer,"width")+s.getPadBorderExtents(this.stackContainer).w;return{l:Math.max(15,this.stackContainer.offsetLeft),r:Math.max(10,e-(this.stackContainer.offsetLeft+t))}},getFullWidth:function(){return Math.max(this.stackContainer.scrollWidth,r.get(this.stackContainer,"width"))},getFullHeight:function(){return Math.max(this.stackContainer.scrollHeight,r.get(this.stackContainer,"height"))},addSection:function(e,t,i,n,o){var s=this._createSectionCell(e);this._createSection(e,t,s);var r=this._createReportElement(e,s,i,n,t&&t.json,o);return this.updateReportElement(r),r},_createSection:function(e,t,i){var n;if(t=t||{},t.class="reportContainer_Section",t.initialWidth=this._getSectionWidth(),t.viewModel=this.viewModel,t.theme=this.theme,t.parentWidget=this,t.viewPortContainer=this.getScrollableContainer(),"empty"===e)n=this.viewModel.layoutBuilder.createElement("emptySection",t,i.getContentContainerNode());else{n=this.viewModel.layoutBuilder.createElement("section",t,i.getContentContainerNode());var o=this.documentOptions.backgroundColor||this.viewModel.getDocumentDefaultStyles(this.theme).backgroundColor;o&&r.set(n.domNode,"backgroundColor",o)}return i.setContent(n),n},_getSectionCellClass:function(){return h},_getSectionCellParams:function(){return null},_createSectionCell:function(e){return(new this._getSectionCellClass)(t.mixin({sectionId:e,class:"reportContainerCell"},this._getSectionCellParams()))},_createReportElement:function(e,t,i,o,s,r){var l=n.create("div",{class:"reportElement"});l.reportElementContent=n.create("div",{class:"reportElementContent"},l);var a=this._getCellSection(t),h=l._fcPar={isReportElement:!0,sectionId:e,isEmpty:"empty"===e,sectionJson:this.isSourceContainer&&s,cell:t,section:a,coverElement:null,controls:[],dragHandleElement:null,sectionToolbar:null,sectionLabel:null};return n.place(l,i||this.stackContainer,i?o:void 0),this._createAdditionalElementsForReportElement(l,t,a,h),n.place(t.domNode,l.reportElementContent),this.isEmptyElement(i)&&!1!==r&&(this._removeSection(i),this._tryProvidingSmallEmpty(l)),this.viewModel.dynamicReportInfo||(h.coverElement=n.create("div",{class:"reportElement_coverElement"},l.reportElementContent),u.hide(h.coverElement)),l},_createAdditionalElementsForReportElement:function(e,t,i,n){},updateReportElement:function(e){var t=this.getElementParams(e);this._sectionToSectionCell(t.cell),this._sectionCellToSection(t.cell),this._updateChildrenViewMode(e)},_sectionCellToSection:function(e){this._getCellSection(e).setResizedHeight(e.getHeight())},_sectionToSectionCell:function(e){var t=this._getCellSection(e);e.setWidth(t.getWidth()),e.setMinHeight(t.hasTablesThatFitHeight()?20:t.getHeight()),e.setHeight(t.getResizedHeight())},_tryProvidingSmallEmpty:function(e){var t=this;this.getReportElements().filter(function(e){return t.isEmptyElement(e)}).length||this.addSection(p.EMPTY,{isSmallSize:!0},e,"after")},getElementHeight:function(e){return this.getElementCell(e).getHeight()},setElementHeight:function(e,t){var i=this.getElementCell(e);i.setHeight(t),this._sectionCellToSection(i),this.updateReportElement(e)},getElementParams:function(e,t){var i=e&&e._fcPar;return t?i&&i[t]:i},getElementSection:function(e){return this.getElementParams(e,"section")},getElementCell:function(e){return this.getElementParams(e,"cell")},isEmptyElement:function(e){return!!this.getElementParams(e,"isEmpty")},isReportElement:function(e){return this.getElementParams(e)},_getCellSection:function(e){return e.content},scrollToElement:function(e){if(e)return this._animateScrolling(e.offsetTop-this.domNode.clientHeight/5)},_animateScrolling:function(e){this.getScrollableContainer().scrollTop=e},getScrollableContainer:function(){return this.mainContainer},getReportElements:function(e){return c.getReportElements(this,e)},clear:function(e){var t=this;this.getReportElements().forEach(function(i){t._removeSection(i,!0===e)})},_removeSection:function(e,t){var i=this.getElementSection(e),o=this.getElementCell(e);e&&o&&(i&&i.destroy(),o.destroy(),n.destroy(e),0===this.getReportElements().length&&!1!==t&&this.addSection(p.EMPTY))},removeSection:function(e){this._removeSection(e)},removeSectionAtIndex:function(e){this._removeSection(this.getReportElements()[e])},moveSection:function(e,t,i){var o=this.getReportElements()[e];if(o&&o.parentNode){o.parentNode.removeChild(o);var s=this.getReportElements();s.length===t?n.place(o,s[s.length-1],"after"):n.place(o,this.getReportElements()[t],i)}},setHeight:function(e){r.set(this.mainContainer,"height",e+"px")},_viewMode:null,getViewMode:function(){return this._viewMode},setViewMode:function(e){if(this._viewMode!==e){this._viewMode=e,this._memoInViewElementsInfo(),e===g.EDIT?(o.add(this.domNode,"reportContainerEditMode"),o.remove(this.domNode,"reportContainerPreviewMode")):(o.remove(this.domNode,"reportContainerEditMode"),o.add(this.domNode,"reportContainerPreviewMode")),e!==g.PREVIEW_VALUES||this.viewModel.dynamicReportInfo?u.hide(this._sampleWatermarkDiv):(this._sampleWatermarkDiv||(this._sampleWatermarkDiv=n.create("div",{class:"sampleValuesWatermark"},this.stackContainer,"first")),u.show(this._sampleWatermarkDiv)),this._updateContainerSize(),this._updateChildrenViewMode(),this._adjustScrollForNewViewMode()}},_updateChildrenViewMode:function(e){var t=this;(e?[e]:this.getReportElements()).forEach(function(e){var i=t.getElementSection(e),n=t.getElementCell(e);i&&(i.setViewMode&&i.setViewMode(t._viewMode),i.hasLocatorTables&&i.hasLocatorTables()&&t._sectionToSectionCell(n)),t._setChildCovered(e,t._viewMode!==g.EDIT)})},_setChildCovered:function(e,t){var i=this.getElementParams(e,"coverElement");i&&(u[t?"show":"hide"](i),t?(e[this.draggableElementProperty]=i,r.set(i,{position:"absolute",left:"0px",top:"0px",width:r.get(e,"width")+"px",height:r.get(e,"height")+"px"})):e[this.draggableElementProperty]=this.getElementParams(e,"dragHandleElement"))},_inViewElementsInfo:null,_memoInViewElementsInfo:function(){if(this._inViewElementsInfo=null,!(this.mainContainer.scrollTop<1e3)){var e;this.getReportElements().some(function(t){if(t.offsetTop>this.mainContainer.scrollTop)return e=t,!0},this),e&&(this._inViewElementsInfo={scrollTop:this.mainContainer.scrollTop,offsetTop:e.offsetTop,elementInView:e})}},_adjustScrollForNewViewMode:function(){if(this._inViewElementsInfo){var e=this._inViewElementsInfo.offsetTop-this._inViewElementsInfo.scrollTop,t=this._inViewElementsInfo.elementInView.offsetTop-this.mainContainer.scrollTop;this.mainContainer.scrollTop+=t-e}},collectFieldInfos:function(e){return c.collectFieldInfos(this,e)},notifyShown:function(){this.serializationManager.notifyShown()},fromJson:function(e){return this.serializationManager.fromJson(e)},toJson:function(e){return this.serializationManager.toJson(e)},onPendingDataApplied:function(){},onFieldInfoSelected:function(e){},destroy:function(){this.clear(),this.inherited(arguments)}})});