// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.23/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-construct","dojo/dom-class","dojo/dom-style","dojo/store/Memory","dijit/_WidgetBase","dijit/_TemplatedMixin","./_SectionQueryElementsMixin","../supportClasses/TableUtil","../supportClasses/ViewModes","../supportClasses/templateJsonUtils/fieldInfo/FieldInfoBuilder","../grid/coreUtils/GridDataUtil","./supportClasses/SectionLayoutManager","./supportClasses/SectionDynamicSettingsBuilder","./sectionUtils/SectionJsonUtil","../themes/ReportThemes","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes","dojo/text!../templates/Section.html","dojo/i18n!../../../../../nls/jsapi"],function(e,t,i,n,a,o,s,r,l,h,c,d,u,g,m,p,f,_,y,C,E){return E=E.geoenrichment.dijit.ReportPlayer.ReportPlayer,e([s,r,l],{templateString:C,nls:E,json:null,viewModel:null,themeContext:null,theme:null,initialWidth:null,hasFixedLayout:!0,previewFeatureIndex:null,parentWidget:null,parentElementInPageInfo:null,viewPortContainer:null,parentGridCell:null,isInfographicHeaderSection:!1,isInfographicSection:!1,infographicViewController:null,calculationStatesGroup:null,noChartTableOffset:!1,noInfographicTableOffset:!1,tableClass:null,tableParams:null,_stackElements:null,_defaultJson:null,_layoutManager:null,_dynamicSettingsBuilder:null,_topSpacer:null,_bottomSpacer:null,postCreate:function(){this.inherited(arguments),this._showError(!1),this._layoutManager=new g(this),this._stackElements=[],this.infographicViewController&&this.infographicViewController.addSection(this),this.initialWidth&&this.setWidth(this.initialWidth),this.fromJson(this.json||this._defaultJson),this.json=null,this.viewModel.dynamicReportInfo&&(this._dynamicSettingsBuilder=new m(this))},_createStack:function(e){if(this._destroyStack(),e){this._topSpacer=i.create("div",{"class":"stackNodeSpacer"},this.stackNode);var t=this;e.stack.forEach(function(e,i){switch(e.id){case"table":t._createGrid(e);break;case"img":t._createImage(e);break;case"hr":t._createHorizontalLine(e,i);break;case"pageBreak":t._createPageBreak(e)}}),this._bottomSpacer=i.create("div",{"class":"stackNodeSpacer"},this.stackNode),this._updateSpacersForHorizontalLines()}},_addEmptyLine:function(){i.create("div",{"class":"stackNodeEmptyLine"},this.stackNode)},_getGridCreateParams:function(e,t){return null},_createGrid:function(e,n,a,s){var r=this;e.style=e.style||{},e.attributes=e.attributes||{},e.data.columns=e.data.columns||[],e.data.data=e.data.data||[];var l=n&&(n.domNode||n);a=l?a||"after":void 0;var h=l||this.stackNode,c=this.viewModel.layoutBuilder.createElement("grid",t.mixin({"class":"inSectionAdjustableGrid"+(this.tableClass?" "+this.tableClass:""),fieldCellClass:"inSectionAdjustableGridCell"+(this.tableClass?" "+this.tableClass+"Cell":""),viewModel:this.viewModel,themeContext:this.themeContext,theme:this.theme,columns:e.data.columns,store:new o({data:e.data.data,idProperty:"id"}),parentWidget:this,viewPortContainer:this.viewPortContainer,fixedViewMode:e.attributes.viewMode,previewFeatureIndex:this.previewFeatureIndex,getPreviewValueFunction:this.infographicViewController&&function(){return r.infographicViewController.getValueInfo(r)},allowSorting:!this.isInfographicSection&&!!this.viewModel.dynamicReportInfo,onContentLoadingStart:function(){r.onContentLoadingStart()},onContentLoadingEnd:function(){r.onContentLoadingEnd()}},this._getGridCreateParams(e,s),this.tableParams),h);return i.place(c.domNode,h,a),c.setMaxWidth(this.hasFixedLayout?this.getWidth():1e5),c.setSettings({style:{width:e.style.width,left:e.style.left,spaceBefore:e.style.spaceBefore,spaceAfter:e.style.spaceAfter},attributes:{fixedColumns:e.attributes.fixedColumns,dynamicColumns:e.attributes.dynamicColumns,fixedRows:e.attributes.fixedRows,dynamicRows:e.attributes.dynamicRows},scaleToFitWidth:e.scaleToFitWidth,scaleToFitHeight:e.scaleToFitHeight}),c.stackId="table",n?this._stackElements.splice(this._stackElements.indexOf(n)+("after"===a?1:0),0,n):this._stackElements.push(c),this.isInfographicSection||!this.viewModel.dynamicReportInfo||this.hasChart()||this.hasInfographic()||c.set("highlightRowsOnHover",!0),this._syncElementViewMode(c),c},_createImage:function(e){return e.isMapImage||this.viewModel.reportStyle===f.CLASSIC?this._createFloatingImage(e):this._createElementInTable(e,"image")},_createFloatingImage:function(e){var t,i=this,n={viewModel:this.viewModel,themeContext:this.themeContext,theme:this.theme,parentWidget:this,onInitialized:function(){t&&t.resize()},onContentLoadingStart:function(){i.onContentLoadingStart()},onContentLoadingEnd:function(){i.onContentLoadingEnd()},onMapLoadError:function(){i._showError(!0)}};return t=this._doCreateImageWithParams(n,e),t.stackId="img",this._stackElements.push(t),this._syncElementViewMode(t),t},_doCreateImageWithParams:function(e,t){var i=this.viewModel.layoutBuilder.createElement("image",{node:this.stackNode,relativeParent:this.domNode,json:t,creationParams:e});return i},_createElementInTable:function(e,i,n){function a(){if("chart"===i)return{x:0,y:0,w:e.visualProperties.width,h:e.visualProperties.height};e=t.mixin({},e),e.style=t.clone(e.style);var a=n&&n.defaultSize||100;e.style.width=e.style.width||a,e.style.height=e.style.height||a;var o={x:e.style.left||0,y:e.style.top||0,w:e.style.width,h:e.style.height};return e.style.left=0,e.style.top=0,o}e.style=e.style||{};var o,s=a();switch(i){case"image":o=d.createFieldInfoFromImage(e);break;case"shape":o=d.createFieldInfoFromShape(e);break;case"chart":o=d.createFieldInfoFromChart(e)}var r=h.createSingleCellTable({left:s.x,spaceBefore:s.y,width:s.w,height:s.h,fieldInfo:o,cellStyle:{horizontalAlign:e.style.horizontalAlign||"center",verticalAlign:e.style.verticalAlign||"middle",backgroundColor:"transparent"}}),l=this._createGrid(r);return"image"===i&&(l.__isImageTable=!0),l},isImageTable:function(e){return e&&e.__isImageTable},_createHorizontalLine:function(e,t){e.style=e.style||{};var o=i.create("div",{"class":"templateHorizontalLine"},this.stackNode);0===t?(n.add(o,"templateHorizontalLineTop"),this._stackElements.unshift(o),o._isTopLine=!0):(n.add(o,"templateHorizontalLineBottom"),this._stackElements.push(o),o._isTopLine=!1),o.stackId="hr",e.style.backgroundColor&&a.set(o,"backgroundColor",e.style.backgroundColor),e.style.height&&a.set(o,"height",e.style.height+"px")},_updateSpacersForHorizontalLines:function(){var e=this._queryElementsById("hr");a.set(this._topSpacer,"height","0px"),a.set(this._bottomSpacer,"height","0px");var t=this;e.forEach(function(e){a.set(e._isTopLine?t._topSpacer:t._bottomSpacer,"height",a.get(e,"height")+"px")})},_createPageBreak:function(e){var t=i.create("div",{"class":"esriGEReportPlayer_pageBreak"},this.stackNode);t.stackId="pageBreak",i.create("div",{"class":"pageBreakLine dijitInline"},t),i.create("div",{"class":"pageBreakLabel dijitInline",innerHTML:E.pageBreak},t),i.create("div",{"class":"pageBreakLine dijitInline"},t),this._stackElements.push(t)},_destroyStack:function(){for(;this._stackElements.length;)this._removeElement(this._stackElements[0]);this.stackNode&&i.empty(this.stackNode),this._addEmptyLine()},removeElement:function(e){e&&this._removeElement(e)},_removeElement:function(e){e&&(e.destroy?e.destroy():i.destroy(e),this._stackElements.splice(this._stackElements.indexOf(e),1),"hr"===e.stackId&&this._updateSpacersForHorizontalLines())},getWidth:function(){return this._layoutManager.getWidth()},setWidth:function(e,t){this._layoutManager.setWidth(e,t)},getHeight:function(e){return this._layoutManager.getHeight(e)},getResizedHeight:function(){return this._layoutManager.getResizedHeight()},setResizedHeight:function(e,t){this._layoutManager.setResizedHeight(e,t)},getPreferredHeight:function(){return this._layoutManager.getPreferredHeight()},collapseContent:function(){var e=this.getInfographicWithTable();e&&e.infographic.collapseContent()},calculateFloatingContentBox:function(){return this._layoutManager.getFloatingContentBox()},scaleFloatingContentProportionally:function(e){this._layoutManager.scaleFloatingContentProportionally(e)},fitContentNicely:function(e,t){this._layoutManager.fitContentNicely(e,t)},_getFirstCellContent:function(){var e=this.getFirstTable(),t=e&&e.getFirstCell();return t&&t.content},sortChart:function(e){var t=this._getFirstCellContent();t&&t.sortChart(e)},chartToTable:function(){var e=this._getFirstCellContent();e&&e.chartToTable()},tableToChart:function(){var e=this._getFirstCellContent();e&&e.tableToChart()},setChartCalculationState:function(e){this.onCalculationStateChanged(e)},onCalculationStateChanged:function(e){},getSettings:function(){var e=this._queryElementsById("hr"),t=e[0]&&e[0]._isTopLine?e[0]:null,i=e.filter(function(e){return!e._isTopLine})[0],n={type:this._sectionType,hasTopLine:!!t,hasBottomLine:!!i};return t&&(n.topLineHeight=a.get(t,"height"),n.topLineColor=a.get(t,"backgroundColor")),i&&(n.bottomLineHeight=a.get(i,"height"),n.bottomLineColor=a.get(i,"backgroundColor")),n},setSettings:function(e){var t=this;this._queryElementsById("hr").map(function(e){t._removeElement(e)}),e.hasTopLine&&this._createHorizontalLine({style:{height:e.topLineHeight,backgroundColor:e.topLineColor}},0),e.hasBottomLine&&this._createHorizontalLine({style:{height:e.bottomLineHeight,backgroundColor:e.bottomLineColor}})},_notifyContentChanged:function(){this._layoutManager.updateHeightAfterContentChange()},_viewMode:null,_specificViewMode:null,_viewModeKey:null,setViewMode:function(e,t){var i=this,a=e+t;this._viewModeKey!==a&&(this._viewModeKey=a,this._viewMode=e,void 0!==t&&(this._specificViewMode=t),n[this._viewMode===c.EDIT?"add":"remove"](this.domNode,"esriGEReportPlayer_sectionEditMode"),n[this._viewMode===c.EDIT?"remove":"add"](this.domNode,"esriGEReportPlayer_sectionPreviewMode"),this._stackElements.forEach(function(e){i._syncElementViewMode(e)}))},_syncElementViewMode:function(e){e.setViewMode&&e.setViewMode(this._viewMode,this._specificViewMode)},notifyShown:function(){this._stackElements.forEach(function(e){e.notifyShown&&e.notifyShown()})},_sectionType:null,getSectionType:function(){return this._sectionType},isEmpty:function(){return!1},isDataSection:function(){var e=this.getSectionType();return!this.hasPageBreak()&&this.hasNonEmptyTables()&&(e===y.DETAILS||e===y.DETAILS_HEADER||e===y.GROUP)},isPageHeader:function(){return this.getSectionType()===y.PAGE_HEADER},isPageFooter:function(){return this.getSectionType()===y.PAGE_FOOTER},getSectionName:function(){if(this.hasPageBreak())return"";switch(this._sectionType){case y.PAGE_HEADER:return E.pageHeader;case y.DETAILS_HEADER:return E.detailsHeader;case y.DETAILS:return E.details;case y.GROUP:return E.group;case y.REPORT_FOOTER:return E.reportFooter;case y.PAGE_FOOTER:return E.pageFooter}return""},getVisualState:function(){return{stackElements:this._stackElements.map(function(e){return e.getVisualState&&e.getVisualState()})}},setVisualState:function(e){e&&e.stackElements&&e.stackElements.length===this._stackElements.length&&(this._stackElements.forEach(function(t,i){t.setVisualState&&t.setVisualState(e.stackElements[i])}),this._dynamicSettingsBuilder.setVisualState(e))},updateContentFromJson:function(e){this.fromJson(e),this._notifyContentChanged()},fromJson:function(e){this._showError(!1),this._sectionType=e.type,this.previewFeatureIndex=e.previewFeatureIndex,this._createStack(e)},toJson:function(){var e=this,t={type:this._sectionType,stack:[]};return this._stackElements.forEach(function(i){var n;switch(i.stackId){case"table":if(e.isImageTable(i)){var o=i.toJson(),s=p.getTableJsonFirstFieldInfo(o).imageJson;s?(s.style.left=o.style.left,s.style.top=o.style.spaceBefore,n=s):n=o}else n=i.toJson();break;case"img":n=i.toJson();break;case"hr":n={id:"hr",style:{height:a.get(i,"height"),backgroundColor:a.get(i,"backgroundColor")}};break;case"pageBreak":n={id:"pageBreak"}}n&&t.stack.push(n)}),t},onContentLoadingStart:function(){},onContentLoadingEnd:function(){},_showError:function(e){_[e?"show":"hide"](this.errorDiv),_[e?"hide":"show"](this.stackNode)},destroy:function(){this._destroyStack(),this.inherited(arguments)}})});