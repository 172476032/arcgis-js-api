// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.22/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/dom-construct","dojo/dom-class","dojo/dom-style","dojo/store/Memory","dijit/_WidgetBase","dijit/_TemplatedMixin","./_SectionQueryElementsMixin","../supportClasses/TableUtil","../grid/coreUtils/GridDataUtil","./supportClasses/SectionLayoutManager","./supportClasses/SectionDynamicSettingsBuilder","./sectionUtils/SectionJsonUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/ReportPlayer/core/sections/SectionTypes","dojo/text!../templates/Section.html","dojo/i18n!../../../../../nls/jsapi"],function(t,e,i,n,a,o,s,r,l,c,h,d,u,g,p,m,f,_){return _=_.geoenrichment.dijit.ReportPlayer.ReportPlayer,t([s,r,l],{templateString:f,nls:_,json:null,viewModel:null,themeContext:null,theme:null,previewFeatureIndex:null,initialWidth:null,hasFixedLayout:!0,isInfographicSection:!1,parentGridCell:null,infographicViewController:null,calculationStatesGroup:null,tableClass:null,tableParams:null,_stackElements:null,_defaultJson:null,_layoutManager:null,_dynamicSettingsBuilder:null,_topSpacer:null,_bottomSpacer:null,postCreate:function(){this.inherited(arguments),this._showError(!1),this._layoutManager=new d(this),this._stackElements=[],this.initialWidth&&this.setWidth(this.initialWidth),this.infographicViewController&&this.infographicViewController.addSection(this),this.fromJson(this.json||this._defaultJson),this.viewModel.dynamicReportInfo&&(this._dynamicSettingsBuilder=new u(this))},_createStack:function(t){if(this._destroyStack(),t){this._topSpacer=i.create("div",{"class":"stackNodeSpacer"},this.stackNode);var e=this;t.stack.forEach(function(t,i){switch(t.id){case"table":e._createGrid(t);break;case"img":e._createImage(t);break;case"hr":e._createHorizontalLine(t,i);break;case"pageBreak":e._createPageBreak(t)}}),this.setViewMode(this._viewMode),this._bottomSpacer=i.create("div",{"class":"stackNodeSpacer"},this.stackNode),this._updateSpacersForHorizontalLines()}},_addEmptyLine:function(){i.create("div",{"class":"stackNodeEmptyLine"},this.stackNode)},_getGridCreateParams:function(t,e){return null},_createGrid:function(t,n,a,s){var r=this;t.style=t.style||{},t.attributes=t.attributes||{},t.data.columns=t.data.columns||[],t.data.data=t.data.data||[];var l=g.tableJsonHasInfographic(t),c=g.tableJsonHasChart(t),h=n&&(n.domNode||n);a=h?a||"after":void 0;var d=h||this.stackNode,u=this.viewModel.layoutBuilder.createElement("grid",e.mixin({"class":"inSectionAdjustableGrid"+(this.tableClass?" "+this.tableClass:""),fieldCellClass:"inSectionAdjustableGridCell"+(this.tableClass?" "+this.tableClass+"Cell":""),viewModel:this.viewModel,themeContext:this.themeContext,theme:this.theme,columns:t.data.columns,store:new o({data:t.data.data,idProperty:"id"}),allowSorting:!this.isInfographicSection&&!!this.viewModel.dynamicReportInfo,previewFeatureIndex:this.previewFeatureIndex,fixedViewMode:t.attributes.viewMode,renderCellBackground:!l&&!c,getPreviewValueFunction:this.infographicViewController&&function(){return r.infographicViewController.getValueInfo(r)},onContentLoadingStart:function(){r.onContentLoadingStart()},onContentLoadingEnd:function(){r.onContentLoadingEnd()}},this._getGridCreateParams(t,s),this.tableParams),d);return i.place(u.domNode,d,a),u.setMaxWidth(this.hasFixedLayout?this.getWidth():1e5),u.setSettings({style:{width:t.style.width,left:t.style.left,spaceBefore:t.style.spaceBefore,spaceAfter:t.style.spaceAfter},attributes:{fixedColumns:t.attributes.fixedColumns,dynamicColumns:t.attributes.dynamicColumns,fixedRows:t.attributes.fixedRows,dynamicRows:t.attributes.dynamicRows},scaleToFitWidth:t.scaleToFitWidth,scaleToFitHeight:t.scaleToFitHeight}),u.stackId="table",n?this._stackElements.splice(this._stackElements.indexOf(n)+("after"==a?1:0),0,n):this._stackElements.push(u),this.isInfographicSection||!this.viewModel.dynamicReportInfo||this.hasChart()||this.hasInfographic()||u.set("highlightRowsOnHover",!0),u},_createImage:function(t){var e=this;t.style=t.style||{};var i,n={createMapFunc:this.viewModel.dynamicReportInfo&&this.viewModel.dynamicReportInfo.createMapFunc,getDynamicImageFunc:this.viewModel.getDynamicImageFunc.bind(this.viewModel),themeContext:this.themeContext,theme:this.theme,onInitialized:function(){i&&i.resize()},onContentLoadingStart:function(){e.onContentLoadingStart()},onContentLoadingEnd:function(){e.onContentLoadingEnd()},onMapLoadError:function(){e._showError(!0)}};return i=this._doCreateImageWithParams(n,t),i.stackId="img",this._stackElements.push(i),i},_doCreateImageWithParams:function(t,e){var i=this.viewModel.layoutBuilder.createElement("image",{node:this.stackNode,relativeParent:this.domNode,json:e,creationParams:t});return i},_createHorizontalLine:function(t,e){t.style=t.style||{};var o=i.create("div",{"class":"templateHorizontalLine"},this.stackNode);0==e?(n.add(o,"templateHorizontalLineTop"),this._stackElements.unshift(o),o._isTopLine=!0):(n.add(o,"templateHorizontalLineBottom"),this._stackElements.push(o),o._isTopLine=!1),o.stackId="hr",t.style.backgroundColor&&a.set(o,"backgroundColor",t.style.backgroundColor),t.style.height&&a.set(o,"height",t.style.height+"px")},_updateSpacersForHorizontalLines:function(){var t=this._queryElementsById("hr");a.set(this._topSpacer,"height","0px"),a.set(this._bottomSpacer,"height","0px");var e=this;t.forEach(function(t){a.set(t._isTopLine?e._topSpacer:e._bottomSpacer,"height",a.get(t,"height")+"px")})},_createPageBreak:function(t){var e=i.create("div",{"class":"esriGEReportPlayer_pageBreak"},this.stackNode);e.stackId="pageBreak",i.create("div",{"class":"pageBreakLine dijitInline"},e),i.create("div",{"class":"pageBreakLabel dijitInline",innerHTML:_.pageBreak},e),i.create("div",{"class":"pageBreakLine dijitInline"},e),this._stackElements.push(e)},_destroyStack:function(){for(;this._stackElements.length;)this._removeElement(this._stackElements[0]);this.stackNode&&i.empty(this.stackNode),this._addEmptyLine()},removeElement:function(t){t&&this._removeElement(t)},_removeElement:function(t){t.destroy?t.destroy():i.destroy(t),this._stackElements.splice(this._stackElements.indexOf(t),1),"hr"==t.stackId&&this._updateSpacersForHorizontalLines()},getWidth:function(){return this._layoutManager.getWidth()},setWidth:function(t,e){this._layoutManager.setWidth(t,e)},getHeight:function(t){return this._layoutManager.getHeight(t)},getResizedHeight:function(){return this._layoutManager.getResizedHeight()},setResizedHeight:function(t,e){this._layoutManager.setResizedHeight(t,e)},getPreferredHeight:function(){return this._layoutManager.getPreferredHeight()},collapseContent:function(){var t=this.getInfographicWithTable();t&&t.infographic.collapseContent()},calculateFloatingContentBox:function(){return this._layoutManager.getFloatingContentBox()},scaleFloatingContentProportionally:function(t){this._layoutManager.scaleFloatingContentProportionally(t)},fitContentNicely:function(t,e){this._layoutManager.fitContentNicely(t,e)},_getFirstCellContent:function(){var t=this.getFirstTable(),e=t&&t.getFirstCell();return e&&e.content},sortChart:function(t){var e=this._getFirstCellContent();e&&e.sortChart(t)},chartToTable:function(){var t=this._getFirstCellContent();t&&t.chartToTable()},tableToChart:function(){var t=this._getFirstCellContent();t&&t.tableToChart()},setChartCalculationState:function(t){this.onCalculationStateChanged(t)},onCalculationStateChanged:function(t){},getSettings:function(){var t=this._queryElementsById("hr"),e=t[0]&&t[0]._isTopLine?t[0]:null,i=t.filter(function(t){return!t._isTopLine})[0],n={type:this._sectionType,hasTopLine:!!e,hasBottomLine:!!i};return e&&(n.topLineHeight=a.get(e,"height"),n.topLineColor=a.get(e,"backgroundColor")),i&&(n.bottomLineHeight=a.get(i,"height"),n.bottomLineColor=a.get(i,"backgroundColor")),n},setSettings:function(t){var e=this;this._queryElementsById("hr").map(function(t){e._removeElement(t)}),t.hasTopLine&&this._createHorizontalLine({style:{height:t.topLineHeight,backgroundColor:t.topLineColor}},0),t.hasBottomLine&&this._createHorizontalLine({style:{height:t.bottomLineHeight,backgroundColor:t.bottomLineColor}})},_notifyContentChanged:function(){this._layoutManager.updateHeightAfterContentChange()},_viewMode:null,_specificViewMode:null,setViewMode:function(t,e){var i=this;this._viewMode=t,void 0!==e&&(this._specificViewMode=e),this._stackElements.forEach(function(e){e.setViewMode&&e.setViewMode(t,i._specificViewMode)})},notifyShown:function(){this._stackElements.forEach(function(t){t.notifyShown&&t.notifyShown()})},_sectionType:null,getSectionType:function(){return this._sectionType},isEmpty:function(){return!1},isDataSection:function(){var t=this.getSectionType();return!this.hasPageBreak()&&this.hasNonEmptyTables()&&(t==m.DETAILS||t==m.DETAILS_HEADER||t==m.GROUP)},isPageHeader:function(){return this.getSectionType()==m.PAGE_HEADER},isPageFooter:function(){return this.getSectionType()==m.PAGE_FOOTER},getSectionName:function(){if(this.hasPageBreak())return"";switch(this._sectionType){case m.PAGE_HEADER:return _.pageHeader;case m.DETAILS_HEADER:return _.detailsHeader;case m.DETAILS:return _.details;case m.GROUP:return _.group;case m.REPORT_FOOTER:return _.reportFooter;case m.PAGE_FOOTER:return _.pageFooter}return""},getVisualState:function(){return{stackElements:this._stackElements.map(function(t){return t.getVisualState&&t.getVisualState()})}},setVisualState:function(t){t&&t.stackElements&&t.stackElements.length==this._stackElements.length&&(this._stackElements.forEach(function(e,i){e.setVisualState&&e.setVisualState(t.stackElements[i])}),this._dynamicSettingsBuilder.setVisualState(t))},updateContentFromJson:function(t){this.fromJson(t),this._notifyContentChanged()},fromJson:function(t){this._showError(!1),this._sectionType=t.type,this.previewFeatureIndex=t.previewFeatureIndex,this._createStack(t)},toJson:function(){var t={type:this._sectionType,stack:[]};return this._stackElements.forEach(function(e){var i;switch(e.stackId){case"table":case"img":i=e.toJson();break;case"hr":i={id:"hr",style:{height:a.get(e,"height"),backgroundColor:a.get(e,"backgroundColor")}};break;case"pageBreak":i={id:"pageBreak"}}i&&t.stack.push(i)}),t},onContentLoadingStart:function(){},onContentLoadingEnd:function(){},_showError:function(t){p[t?"show":"hide"](this.errorDiv),p[t?"hide":"show"](this.stackNode)},destroy:function(){this._destroyStack(),this.inherited(arguments)}})});