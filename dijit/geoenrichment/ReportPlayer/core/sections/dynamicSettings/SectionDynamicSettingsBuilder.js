// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/on","dojo/promise/all","dojo/dom-class","dojo/dom-construct","esri/dijit/geoenrichment/ReportPlayer/PlayerSelect","esri/dijit/geoenrichment/ReportPlayer/PlayerThemes","esri/dijit/geoenrichment/ReportPlayer/ReportPlayerState","./chart/_ChartSettingsBuilder","./locator/_LocatorSettingsBuilder","./areaDetails/_AreaDetailsSettingsBuilder","./comparison/_ComparisonSettingsBuilder","./map/_MapSettingsBuilder","./multiFeature/_MultiFeatureSettingsBuilder","./SectionDynamicSettings","esri/dijit/geoenrichment/utils/DeviceUtil","esri/dijit/geoenrichment/utils/DomUtil","esri/dijit/geoenrichment/utils/MouseUtil","esri/dijit/geoenrichment/utils/PopupUtil","esri/dijit/geoenrichment/utils/TooltipUtil","dojo/i18n!esri/nls/jsapi"],function(t,e,i,n,o,s,a,r,c,l,g,u,d,h,_,S,p,m,f,b,v){return v=v.geoenrichment.dijit.ReportPlayer.SectionDynamicSettingsBuilder,t(null,{_section:null,_settingsWidget:null,_settingsToolbar:null,_featureSelectDiv:null,_buttonBar:null,_onButtonBarShowCallbacks:null,constructor:function(t){this._section=t,this._createSettings()},_createSettings:function(){var t=this;i({chartSettings:c.provideChartSettings(this._section),locatorSettings:l.provideLocatorSettings(this._section),areaDetailsSettings:g.provideAreaDetailsSettings(this._section),comparisonSettings:u.provideComparisonSettings(this._section),mapSettings:d.provideMapSettings(this._section),multiFeatureSettings:h.provideMultiFeatureSettings(this._section)}).then(function(e){(e.chartSettings||e.locatorSettings||e.areaDetailsSettings||e.comparisonSettings||e.mapSettings||e.multiFeatureSettings)&&(t._addFeatureSelect(e.multiFeatureSettings),t._addLocatorExportButton(e.locatorSettings),t._addSettingsButton(e),(e.locatorSettings&&!e.locatorSettings.hasTitle||e.areaDetailsSettings&&!e.areaDetailsSettings.hasTitle||e.comparisonSettings)&&n.add(t._settingsToolbar,"needsTopOffset"),t._buttonBar&&t._buttonBar.children.length>1&&n.add(t._buttonBar,"hasMultipleButtons"))})},_addFeatureSelect:function(t){var e=this;if(t&&t.canSelectFeatures){var i=this._section.viewModel.dynamicReportInfo.analysisAreas.map(function(t,e){return{value:e,label:t.shortName||t.name}}),n=new s({options:i,value:0,allowRepetitiveSelection:!1,onChange:function(t){var i=e._section.toJson();i.currentFeatureIndex=t.value,e._section.fromJson(i),n.closePopup(),e._settingsWidget&&e._settingsWidget.setVisualState(e._section.getVisualState())}}).placeAt(this._createSettingsToolbar().featureSelectDiv);n.setTheme(a.DARK)}},_addLocatorExportButton:function(t){if(t&&t.canExportToExcel){var i=this._createButton("dijitInline sectionDynamicSettings_exportButton");e(i,"click",function(){t.exportToExcel()}),b.setTooltipToNode(i,v.exportInfographicPanel)}},_addSettingsButton:function(t){function e(){n||(n=!0,f.makePopup(function(){return i._createPopup(t)},this._section,s,{orient:["before","below"]}))}var i=this,n=!1;if(t.chartSettings||t.locatorSettings||t.areaDetailsSettings||t.comparisonSettings||t.mapSettings)var o=t.locatorSettings||t.areaDetailsSettings||t.comparisonSettings&&t.comparisonSettings.statRanges,s=this._createButton("dijitInline  "+(o?"sectionDynamicSettings_filterButton":"sectionDynamicSettings_settingsButton"),e)},_createButton:function(t,e){return o.create("div",{class:t},this._createSettingsToolbar(e).buttonBar)},_createSettingsToolbar:function(t){function i(t){s._section.isDataDrillingView&&(t=!0),s._buttonBar.style.display=!t||!s._section.isDataDrillingView&&r.isViewingDataDrillingZoom?"none":"",t&&s._onButtonBarShowCallbacks.forEach(function(t){return t()}),t||s._closeSettingsPopup(),n[t?"add":"remove"](s._section.domNode,"hasDynamicSettingsToolbar")}var s=this;return this._settingsToolbar||(this._settingsToolbar=o.create("div",{class:"sectionDynamicSettings_toolbar"},this._section.domNode),this._adjustToolbarPosition(),this._featureSelectDiv=o.create("div",{class:"dijitInline"},this._settingsToolbar),this._buttonBar=o.create("div",{class:"dijitInline sectionDynamicSettings_buttonBar"},this._settingsToolbar),this._onButtonBarShowCallbacks=[],i(!1),S.isMobileDevice()||this._section.own(e(document.body,"mousemove",function(){i(m.isMouseOver(s._section.domNode)||m.isMouseOver(s._settingsToolbar)||s._settingsWidget&&(m.isMouseOver(s._settingsWidget.domNode)||m.isMouseOver(s._settingsWidget.domNode.parentNode)))}))),t&&this._onButtonBarShowCallbacks.push(t),S.isMobileDevice()&&setTimeout(function(){i(!0)}),{buttonBar:this._buttonBar,featureSelectDiv:this._featureSelectDiv}},_adjustToolbarPosition:function(){if(this._settingsToolbar){var t=this._section.getMapImages()[0];if(t){var e=p.position(t.domNode),i=p.position(this._section.domNode);this._settingsToolbar.style.top=e.y-i.y+"px",this._settingsToolbar.style.right=i.x+i.w-e.x-e.w+"px"}}},_createPopup:function(t){function e(){n._closeSettingsPopup()}function i(){return n._section.getInfographic().getInnerInfographic()}var n=this;return this._settingsWidget||(this._settingsWidget=new _({chartSettings:t.chartSettings,locatorSettings:t.locatorSettings,areaDetailsSettings:t.areaDetailsSettings,comparisonSettings:t.comparisonSettings,mapSettings:t.mapSettings,onSortChart:function(t){e(),n._section.sortChart(t)},onChartToTable:function(){e(),n._section.chartToTable()},onTableToChart:function(){e(),n._section.tableToChart()},onCalcStateChanged:function(t){e(),n._section.setChartCalculationState(t)},onLocatorFilterChanged:function(t){i().setSearchText(t.searchText),i().setFilterRanges(t.filterRanges)},onAreaDetailsFilterChanged:function(t){i().setSearchText(t.searchText)},onShowChart:function(t){e(),i().setChartView(t)},onComparisonFilterChanged:function(t){i().setFilterRanges(t.filterRanges)},onLegendVisibilityChanged:function(t){n._section.getMapImages()[0].setLegendVisible(t)},onClosePopup:function(){e()}}),this._section.own(this._settingsWidget),this._settingsWidget.setVisualState(this._section.getVisualState())),this._settingsWidget},_closeSettingsPopup:function(){f.close(this._settingsWidget)},setVisualState:function(t){this._settingsWidget&&this._settingsWidget.setVisualState(t)},notifyShown:function(){this._adjustToolbarPosition()}})});