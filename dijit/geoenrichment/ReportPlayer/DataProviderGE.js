// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/promise/all","dojo/when","./dataProvider/_CommandSupport","./dataProvider/_SerializationSupport","./dataProvider/_ServerSerializationSupport","./dataProvider/supportClasses/AnalysisAreaUtil","./dataProvider/supportClasses/AnalysisAreaJsonUtil","./dataProvider/supportClasses/CustomReportsManager","./dataProvider/supportClasses/TemplateJsonLoader","./dataProvider/supportClasses/ReportDataProcessor","./dataProvider/supportClasses/InfographicOptionsProvider","./dataProvider/supportClasses/AreasPreprocessor","./dataProvider/supportClasses/GEUtil","./dataProvider/supportClasses/attachments/DefaultAttachmentsStore","./dataProvider/supportClasses/attachments/CustomAttachmentsStore","./dataProvider/supportClasses/StandardGraphicReportTemplates","./dataProvider/supportClasses/PortalManager","./core/themes/ThemeLibrary","./core/themes/ReportThemes","esri/dijit/geoenrichment/ReportPlayer/countryConfig","esri/dijit/geoenrichment/utils/ProjectionUtil"],function(e,t,r,a,o,n,s,i,p,l,c,u,d,m,h,f,g,A,y,C,I,v,D){return e([o,n,s],{analysisAreasLimit:-1,cacheTemplates:!0,printMapTaskUrl:null,resetReportItemsCache:!0,_infographicOptionsProvider:null,constructor:function(e){t.mixin(this,e),this._infographicOptionsProvider=new d},_getAttachmentsStore:function(e){return new f(e).initialize()},getCustomReports:function(e,t){return l.getCustomReports(e,t)},_currentContext:null,getReportData:function(e,o){var n=this;o=o||function(){};var s=t.mixin({},e);return s.reportID=A.aliasToID(s.countryID,s.reportID)||s.reportID,s.analysisAreas=p.areasFromJson(s.analysisAreas),s.combinedAreasInfo=s.combinedAreasInfo&&p.combinedAreasInfoFromJson(s.combinedAreasInfo)||{},i.pppulateCombinedAreasInfo(s.combinedAreasInfo,s.analysisAreas),s.fieldData={runReportTaskID:null,metadata:{},areaData:[],errors:[]},this._currentContext=s,this.resetReportItemsCache&&l.resetCache(),a(y.getPortalInfo(s.portalUrl),function(e){s.geoenrichmentUrl=s.geoenrichmentUrl||e.portal.helperServices.geoenrichment.url,h.setGeoenrichmentUrl(s.geoenrichmentUrl),n._infographicOptionsProvider.setServerUrl(s);var t=s.geometryServiceUrl||e.portal.helperServices.geometry.url;return D.setGeometryServiceUrl(t),a(m.preprocessAreas(s,{analysisAreasLimit:n.analysisAreasLimit}),function(){return o(.25),setTimeout(function(){n._onCreateReportStarted()}),r({initGE:h.initialize(),countryInfo:h.getCountryInfo(s.countryID),reportObject:l.getCustomReportByID(s),infographicOptions:n._infographicOptionsProvider.getInfographicOptions(s),attachmentsStore:s.attachmentsProvider?g(s.attachmentsProvider):n._getAttachmentsStore(s.analysisAreas),templateJsonInfo:c.getTemplateJsonByID(s,n.cacheTemplates),runReportResult:u.runReportAndGetData(s)}).then(function(e){var r=e.reportObject,n=e.infographicOptions,i=e.attachmentsStore,p=e.templateJsonInfo.templateJson,l=e.templateJsonInfo.templateVariableProvider,c=e.runReportResult;return o(.75),p&&r&&s.fieldData?(u.applyRunReportAndGetDataResults(c,s),v.setCountry(e.countryInfo.country),v.setHierarchyID(r.hierarchy),v.setGeographiesModel(e.countryInfo.geographiesModels[v.getHierarchyID()]),a(i&&u.populateReportDataFromAttachmentsStore(s,i),function(){return o(1),p.theme||(p.theme=C.getReportThemeById(r.isGraphicReport?I.GRAPHIC:I.CLASSIC)),{isClassic:!r.isGraphicReport,isMultiFeature:r.isMultiFeature&&s.analysisAreas.length>1,reportType:r.type,reportTitle:r.title,templateJson:p,reportObject:r,fieldData:s.fieldData,analysisAreas:s.analysisAreas,combinedAreasInfo:s.combinedAreasInfo,reverseAnalysisAreasOnMap:s.reverseAnalysisAreasOnMap,infographicOptions:n,attachmentsStore:i,geClient:h.getClient(),templateVariableProvider:l,config:{portalUrl:s.portalUrl,geoenrichmentUrl:s.geoenrichmentUrl,geometryServiceUrl:t,countryID:s.countryID,hierarchy:r.hierarchy,reportID:s.reportID}}})):null})})})},reportDataToSingleAreaReportData:function(e,r){var a=r.currentFeatureIndex||0,o=t.mixin({},e.fieldData);o.areaData=[o.areaData[a]];var n=[e.analysisAreas[a]],s=e.infographicOptions&&this._infographicOptionsProvider.getInfographicOptionsFromJson(e.infographicOptions.toJsonAt(a)),i=e.attachmentsStore,p=i&&{getAttachments:function(){return i.setCurrentAnalysisAreaIndex&&i.setCurrentAnalysisAreaIndex(a),i.getAttachments()},getAttributes:function(){return i.setCurrentAnalysisAreaIndex&&i.setCurrentAnalysisAreaIndex(a),i.getAttributes()},getNotes:function(){return i.setCurrentAnalysisAreaIndex&&i.setCurrentAnalysisAreaIndex(a),i.getNotes()}};return{isClassic:e.isClassic,isMultiFeature:!1,reportType:e.reportType,reportTitle:r.reportTitle,templateJson:r.templateJson,reportObject:e.reportObject,fieldData:o,analysisAreas:n,combinedAreasInfo:null,reverseAnalysisAreasOnMap:!1,infographicOptions:s,attachmentsStore:p,geClient:e.geClient,templateVariableProvider:e.templateVariableProvider,config:e.config}},_getCurrentContext:function(){return this._currentContext},_onCreateReportStarted:function(){},enrichFieldData:function(e,t){return u.enrichFieldData(e,t)}})});