// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["../../../core/declare","../../../core/Scheduler","../../../core/HandleRegistry","./StreamDataSupplier","./StreamDataLoader","./PreallocArray","../webgl-engine/lib/Util"],function(e,t,i,r,a,s,n){function l(e){this.begin=0,this.budget=0,this.performance=e,this.enabled=!0}var d=n.assert,h={TERRAIN:"terrain",SCENE:"scene",SYMBOLOGY:"symbols"},o=new s(20);l.prototype.now=function(){return this.performance.now()},l.prototype.reset=function(e){this.begin=this.now(),this.budget=this.enabled?e:Number.MAX_VALUE},l.prototype.done=function(){return this.enabled&&this.elapsed()>=this.budget},l.prototype.remaining=function(){return Math.max(this.budget-this.elapsed(),0)},l.prototype.elapsed=function(){return this.now()-this.begin};var m=e(null,{constructor:function(e,r,s){s=s||n.performance,this._clients=[],this._frameWorker=null,this._budget=new l(s),this._idleFrameWorkers=[],this._idleFrameWorkerRobin=0,this._idleUpdatesStartFired=!1,this._lastTargetChangeTime=s.now(),this.navigationTimeout=300,this.animatingFrameTimeBudget=10,this.idleFrameWorkerBudget=30,this.idleFrameTimeBudget=50;var d={},o={};for(var m in h)d[h[m]]=0,o[h[m]]=0;d[h.TERRAIN]=409600,d[h.SCENE]=409600,d[h.SYMBOLOGY]=30720,o[h.TERRAIN]=15,o[h.SCENE]=20,o[h.SYMBOLOGY]=5,this._maxGpuMemory=500,this.streamDataLoader=new a(o),this._cameraListeners=new i,this._cameraListeners.add([e.watch("state.camera",this._cameraChangedHandler.bind(this),!0)]),r||(r=t),this._frameTask=r.addFrameTask({update:this._frameUpdate.bind(this)}),this._view=e,this.stats={frameUpdateTime:new c,idleUpdateTime:new c},this.frameUpdateNavigation=null},destroy:function(){this._frameTask.remove(),this._frameTask=null,this._cameraListeners.remove(),this.streamDataLoader.destroy(),this.streamDataLoader=null},setEnableBudget:function(e){this._budget.enabled=!!e},registerClient:function(e,t,i){return this._clients.push({client:e,type:t}),"function"==typeof e.setMaxGpuMemory&&e.setMaxGpuMemory(this._maxGpuMemory),new r(t,this.streamDataLoader,i)},deregisterClient:function(e){for(var t=0;t<this._clients.length;t++)if(this._clients[t].client===e)return this._clients[t]=this._clients[this._clients.length-1],void this._clients.pop();console.warn("deregistering an unregistered client.")},setMaxGpuMemory:function(e){this._maxGpuMemory=e;for(var t=0;t<this._clients.length;t++){var i=this._clients[t].client;"function"==typeof i.setMaxGpuMemory&&i.setMaxGpuMemory(e)}},registerIdleFrameWorker:function(e,t){var i=this._idleFrameWorkers.some(function(t){return t.client===e});d(!i,"Can only register idle frame workers once per client/layer"),d(!t.idleFrame||t.needsUpdate,"needsUpdate has to be specified if idleFrame is specified"),this._idleFrameWorkers.push({client:e,callbacks:t}),this._isIdle()&&this._idleUpdatesStartFired&&t.idleBegin&&t.idleBegin.call(e)},deregisterIdleFrameWorker:function(e){for(var t=this._idleFrameWorkers,i=0;i<t.length;i++){var r=t[i];if(r.client===e)return this._idleUpdatesStartFired&&r.callbacks.idleEnd&&r.callbacks.idleEnd.call(e),t[i]=t[t.length-1],void t.pop()}},registerFrameWorker:function(e){d(!this._frameWorker,"Only one (non-idle) per-frame worker supported at the moment"),this._frameWorker=e},deregisterFrameWorker:function(){this._frameWorker=null},_cameraChangedHandler:function(){this._lastTargetChangeTime=this._budget.now(),this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._callWorkersNoScheduling("idleEnd"))},_frameUpdate:function(e){var t=this._isIdle()?this.idleFrameWorkerBudget:this.animatingFrameTimeBudget;this._budget.reset(t-e.spendInFrame),this._view.stateManager&&this._view.stateManager.step(e.deltaTime/1e3),this._view.inputManager&&this._view.inputManager._pinchNavigation&&this._view.inputManager._pinchNavigation.momentum.doFrameUpdate(e.deltaTime),this._frameWorker&&(this._frameWorker(this._budget),this.stats.frameUpdateTime.addSample(this._budget.elapsed())),this._isIdle()&&(this._idleUpdatesStartFired||(this._callWorkersNoScheduling("idleBegin"),this._idleUpdatesStartFired=!0),this._budget.reset(this.idleFrameTimeBudget-this._budget.elapsed()),this._budget.remaining()>3&&(this._callWorkersStrictScheduling("idleFrame",this._budget),this.stats.idleUpdateTime.addSample(this._budget.elapsed())))},_isIdle:function(){return this._budget.now()-this._lastTargetChangeTime>this.navigationTimeout},_callWorkersNoScheduling:function(e){for(var t=this._idleFrameWorkers,i=0;i<t.length;i++){var r=t[i];r.callbacks[e]&&r.callbacks[e].call(r.client)}},_callWorkersStrictScheduling:function(e,t){var i,r,a,s=this._idleFrameWorkers,n=s.length;for(o.clear(),r=0,a=this._idleFrameWorkerRobin;n>r;r++)i=s[a++%n],i.callbacks.needsUpdate&&i.callbacks.needsUpdate.call(i.client)&&(0===o.length&&(this._idleFrameWorkerRobin=a),o.push(i));for(var l=t.now(),d=l+t.remaining();o.length>0&&d>l;)t.reset((d-l)/o.length),i=o.pop(),i.callbacks[e].call(i.client,t),l=t.now()}});m.ClientType=h;var c=function(){this.addSample=function(e){this.min=Math.min(this.min,e),this.max=Math.max(this.max,e),this.total+=e,this.numSamples++},this.getAverage=function(){return this.total/this.numSamples},this.reset=function(){this.total=0,this.numSamples=0,this.min=Number.MAX_VALUE,this.max=-Number.MAX_VALUE},this.reset()};return m});