// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["../../../geometry/SpatialReference","../../../geometry/Point","./mathUtils","./earthUtils","../lib/glMatrix","../webgl-engine/lib/BufferVectorMath"],function(e,n,t,a,r,i){var u,f,l,o,c=r.vec3d,s=r.mat4d,h=i.Vec3Compact,M=c.create(),E=c.create(),m=c.create(),S=t.deg2rad(1),x=t.rad2deg(1),R=new e({wkt:'      GEOCCS["Spherical geocentric",        DATUM["Not specified",          SPHEROID["Sphere",'+a.earthRadius+',0]],        PRIMEM["Greenwich",0.0,          AUTHORITY["EPSG","8901"]],        UNIT["m",1.0],        AXIS["Geocentric X",OTHER],        AXIS["Geocentric Y",EAST],        AXIS["Geocentric Z",NORTH]      ]    '}),T=new e({wkt:'      GEOCCS["WGS 84",        DATUM["WGS_1984",          SPHEROID["WGS 84",6378137,298.257223563,            AUTHORITY["EPSG","7030"]],          AUTHORITY["EPSG","6326"]],        PRIMEM["Greenwich",0,          AUTHORITY["EPSG","8901"]],        UNIT["m",1.0,          AUTHORITY["EPSG","9001"]],        AXIS["Geocentric X",OTHER],        AXIS["Geocentric Y",OTHER],        AXIS["Geocentric Z",NORTH],        AUTHORITY["EPSG","4978"]      ]    '}),v={a:6378137,e2:.006694379990137799,a1:42697.67270715754,a2:1823091254.6075456,a3:142.91722289812412,a4:4557728136.518864,a5:42840.589930055656,a6:.9933056200098622},G={SphericalECEFSpatialReference:R,WGS84ECEFSpatialReference:T,vectorToVector:function(e,n,t,a){return 2===e.length?(M[0]=e[0],M[1]=e[1],M[2]=0,e=M):e===t&&(c.set(e,M),e=M),this.bufferToBuffer(e,n,0,t,a,0,1)},pointToVector:function(e,n,t){M[0]=e.x,M[1]=e.y;var a=e.z;return M[2]=void 0!==a?a:0,this.bufferToBuffer(M,e.spatialReference,0,n,t,0,1)},vectorToPoint:function(e,t,a,r){var i;return"esri.SpatialReference"===a.declaredClass?(r=a,i=new n({spatialReference:r})):(i=a,r=r||i.spatialReference),this.bufferToBuffer(e,t,0,M,r,0,1)?(i.x=M[0],i.y=M[1],i.z=M[2],i.spatialReference=r,i):null},xyzToVector:function(e,n,t,a,r,i){return M[0]=e,M[1]=n,M[2]=t,this.bufferToBuffer(M,a,0,r,i,0,1)},bufferToBuffer:function(e,n,t,a,r,i,c){c=c||1,u!==n&&(f=C(n),u=n),l!==r&&(o=C(r),l=r);var s,h,M=t+3*c;if(f!==o||f===N.UNKNOWN&&!n.equals(r)){if(!(f>N.UNKNOWN&&o>N.UNKNOWN))return!1;var m;if(o!==N.WGS84){var S=U[o];if(f!==N.WGS84)for(m=b[f],s=t,h=i;M>s;s+=3,h+=3)m(e,s,E,0,n.wkid),S(E,0,a,h);else for(s=t,h=i;M>s;s+=3,h+=3)S(e,s,a,h)}else for(m=b[f],s=t,h=i;M>s;s+=3,h+=3)m(e,s,a,h,n.wkid)}else if(a!==e||t!==i)for(s=t,h=i;M>s;s++,h++)a[h]=e[s];return!0},computeLinearTransformation:function(e,n,t,a){var r=C(e),i=C(a);if(r===i&&(r!==N.UNKNOWN||e.equals(a)))return s.identity(t),s.translate(t,n),!0;if(i===N.SPHERICAL_ECEF){var u=b[r];if(u){u(n,0,E,0,e.wkid),p(E,0,m,0);var f=S*E[0],l=S*E[1],o=Math.sin(f),c=Math.cos(f),h=Math.sin(l),M=Math.cos(l),x=t;return x[0]=-o,x[4]=-h*c,x[8]=M*c,x[12]=m[0],x[1]=c,x[5]=-h*o,x[9]=M*o,x[13]=m[1],x[2]=0,x[6]=M,x[10]=h,x[14]=m[2],x[3]=0,x[7]=0,x[11]=0,x[15]=1,!0}}else if(i===N.WEBMERC&&(r===N.WGS84||r===N.SPHERICAL_ECEF)){b[r](n,0,E,0,e.wkid);var R=S*E[1];A(E,0,m,0),s.identity(t),s.translate(t,m);var T=1/Math.cos(R);return s.scale(t,[T,T,1]),!0}return!1},mbsToMbs:function(e,n,t,a){var r=C(n),i=C(a);if(r===i&&(r!==N.UNKNOWN||n.equals(a)))return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],!0;if(i===N.SPHERICAL_ECEF){var u=b[r];if(u)return u(e,0,E,0,n.wkid),p(E,0,t,0),t[3]=e[3],!0}else if(i===N.WEBMERC&&(r===N.WGS84||r===N.SPHERICAL_ECEF)){b[r](e,0,E,0,n.wkid);var f=S*E[1];if(f=Math.abs(f)+Math.asin(e[3]/(I+e[2])),A(E,0,t,0),f>.9999*Math.PI)t[3]=Number.MAX_VALUE;else{var l=1/Math.cos(f);t[3]=l*e[3]}return!0}return!1},extentToBoundingBox:function(e,n,t){if(null==e)return!1;var a=!0;return M[0]=null!=e.xmin?e.xmin:0,M[1]=null!=e.ymin?e.ymin:0,M[2]=null!=e.zmin?e.zmin:0,a=a&&this.bufferToBuffer(M,e.spatialReference,0,n,t,0,1),M[0]=null!=e.xmax?e.xmax:0,M[1]=null!=e.ymax?e.ymax:0,M[2]=null!=e.zmax?e.zmax:0,a=a&&this.bufferToBuffer(M,e.spatialReference,0,n,t,3,1),null==e.xmin&&(n[0]=-(1/0)),null==e.ymin&&(n[1]=-(1/0)),null==e.zmin&&(n[2]=-(1/0)),null==e.xmax&&(n[3]=1/0),null==e.ymax&&(n[4]=1/0),null==e.zmax&&(n[5]=1/0),a},extentToBoundingRect:function(e,n,t){if(null==e)return!1;var a=!0;return M[0]=null!=e.xmin?e.xmin:0,M[1]=null!=e.ymin?e.ymin:0,M[2]=null!=e.zmin?e.zmin:0,a=a&&this.bufferToBuffer(M,e.spatialReference,0,M,t,0,1),n[0]=M[0],n[1]=M[1],M[0]=null!=e.xmax?e.xmax:0,M[1]=null!=e.ymax?e.ymax:0,M[2]=null!=e.zmax?e.zmax:0,a=a&&this.bufferToBuffer(M,e.spatialReference,0,M,t,0,1),n[2]=M[0],n[3]=M[1],null==e.xmin&&(n[0]=-(1/0)),null==e.ymin&&(n[1]=-(1/0)),null==e.xmax&&(n[2]=1/0),null==e.ymax&&(n[3]=1/0),a},webMercator:{x2lon:function(e){return e/I},y2lat:function(e){return Math.PI/2-2*Math.atan(Math.exp(-1*e/I))},lon2x:function(e){return e*I},lat2y:function(e){var n=Math.sin(e);return I/2*Math.log((1+n)/(1-n))}}},I=a.earthRadius,N={UNKNOWN:0,SPHERICAL_ECEF:1,WGS84:2,WEBMERC:3,WGS84_ECEF:4},C=function(e){var n;return n=e===R?N.SPHERICAL_ECEF:e.isWGS84?N.WGS84:e.isWebMercator?N.WEBMERC:e===T?N.WGS84_ECEF:N.UNKNOWN},d=function(e,n,t,a){t[a++]=e[n++],t[a++]=e[n++],t[a]=e[n]},W=function(e,n,t,a){t[a++]=x*(e[n++]/I),t[a++]=x*(Math.PI/2-2*Math.atan(Math.exp(-1*e[n++]/I))),t[a]=e[n]},A=function(e,n,a,r){var i=.4999999*Math.PI,u=S*e[n+1];u=t.clamp(u,-i,i);var f=Math.sin(u);a[r++]=S*e[n]*I,a[r++]=I/2*Math.log((1+f)/(1-f)),a[r]=e[n+2]},p=function(e,n,t,a){var r=I+e[n+2],i=S*e[n+1],u=S*e[n],f=Math.cos(i);t[a++]=Math.cos(u)*f*r,t[a++]=Math.sin(u)*f*r,t[a]=Math.sin(i)*r},O=function(e,n,a,r){var i=h.length(e,n),u=t.asin(e[n+2]/i),f=Math.cos(u),l=(e[n+1]>0?1:-1)*t.acos(e[n]/(f*i));a[r++]=x*l,a[r++]=x*u,a[r]=i-I},P=function(e,n,t,a){var r=v,i=S*e[n],u=S*e[n+1],f=e[n+2],l=Math.sin(u),o=Math.cos(u),c=r.a/Math.sqrt(1-r.e2*l*l);t[a++]=(c+f)*o*Math.cos(i),t[a++]=(c+f)*o*Math.sin(i),t[a++]=(c*(1-r.e2)+f)*l},y=function(e,n,t,a){var r,i,u,f,l,o,c,s,h,M,E,m,S,R,T,G,I,N,C,d,W,A,p,O,P=v,C=e[n],d=e[n+1],W=e[n+2];r=Math.abs(W),i=C*C+d*d,u=Math.sqrt(i),f=i+W*W,l=Math.sqrt(f),p=Math.atan2(d,C),o=W*W/f,c=i/f,R=P.a2/l,T=P.a3-P.a4/l,c>.3?(s=r/l*(1+c*(P.a1+R+o*T)/l),A=Math.asin(s),M=s*s,h=Math.sqrt(1-M)):(h=u/l*(1-o*(P.a5-R-c*T)/l),A=Math.acos(h),M=1-h*h,s=Math.sqrt(M)),E=1-P.e2*M,m=P.a/Math.sqrt(E),S=P.a6*m,R=u-m*h,T=r-S*s,I=h*R+s*T,G=h*T-s*R,N=G/(S/E+I),A+=N,O=I+G*N/2,0>W&&(A=-A),t[a++]=x*p,t[a++]=x*A,t[a]=O},U=[void 0,p,d,A,P],b=[void 0,O,d,W,y];return G});