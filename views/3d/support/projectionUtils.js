// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../geometry/Point","../../../geometry/SpatialReference","../lib/glMatrix","./earthUtils","./mathUtils","../webgl-engine/lib/BufferVectorMath"],function(e,n,a,t,r,i,c,l){function o(e,n,a,t){return 2===e.length?(b[0]=e[0],b[1]=e[1],b[2]=0,e=b):e===a&&(r.vec3d.set(e,b),e=b),E(e,n,0,a,t,0,1)}function u(e,n,a){b[0]=e.x,b[1]=e.y;var t=e.z;return b[2]=void 0!==t?t:0,E(b,e.spatialReference,0,n,a,0,1)}function f(e,n,t,r){var i;return"esri.geometry.SpatialReference"===t.declaredClass?(r=t,i=new a({spatialReference:r})):(i=t,r=r||i.spatialReference),E(e,n,0,b,r,0,1)?(i.x=b[0],i.y=b[1],i.z=b[2],i.spatialReference=r,i):null}function s(e,n,a,t,r,i){return b[0]=e,b[1]=n,b[2]=a,E(b,t,0,r,i,0,1)}function E(e,n,a,t,r,i,c){void 0===c&&(c=1),p!==n&&(A=R(n),p=n),P!==r&&(O=R(r),P=r);var l=a+3*c;if(A!==O||A===W.UNKNOWN&&!n.equals(r)){if(!(A>W.UNKNOWN&&O>W.UNKNOWN))return!1;if(O!==W.WGS84){var o=y[O];if(A!==W.WGS84)for(var u=U[A],f=a,s=i;f<l;f+=3,s+=3)u(e,f,w,0),o(w,0,t,s);else for(var f=a,s=i;f<l;f+=3,s+=3)o(e,f,t,s)}else for(var u=U[A],f=a,s=i;f<l;f+=3,s+=3)u(e,f,t,s)}else if(t!==e||a!==i)for(var f=a,s=i;f<l;f++,s++)t[s]=e[f];return!0}function M(e,n,a,t){var i=R(e),c=R(t);if(i===c&&c!==W.SPHERICAL_ECEF&&(i!==W.UNKNOWN||e.equals(t)))return r.mat4d.identity(a),r.mat4d.translate(a,n),!0;if(c===W.SPHERICAL_ECEF){var l=U[i];if(l){l(n,0,w,0),G(w,0,z,0);var o=H*w[0],u=H*w[1],f=Math.sin(o),s=Math.cos(o),E=Math.sin(u),M=Math.cos(u),h=a;return h[0]=-f,h[4]=-E*s,h[8]=M*s,h[12]=z[0],h[1]=s,h[5]=-E*f,h[9]=M*f,h[13]=z[1],h[2]=0,h[6]=M,h[10]=E,h[14]=z[2],h[3]=0,h[7]=0,h[11]=0,h[15]=1,!0}}else if(c===W.WEBMERC&&(i===W.WGS84||i===W.SPHERICAL_ECEF)){U[i](n,0,w,0);var m=H*w[1];C(w,0,z,0),r.mat4d.identity(a),r.mat4d.translate(a,z);var S=1/Math.cos(m);return r.mat4d.scale(a,[S,S,1]),!0}return!1}function h(e,n,a,t,i){r.vec3d.set(e,q),r.vec3d.add(e,n,B),o(q,a,q,i),o(B,a,B,i),r.vec3d.subtract(B,q,t),r.vec3d.normalize(t)}function m(e,n,a,t){var r=R(n),i=R(t);if(r===i&&(r!==W.UNKNOWN||n.equals(t)))return a[0]=e[0],a[1]=e[1],a[2]=e[2],a[3]=e[3],!0;if(i===W.SPHERICAL_ECEF){var c=U[r];if(c)return c(e,0,w,0),G(w,0,a,0),a[3]=e[3],!0}else if(i===W.WEBMERC&&(r===W.WGS84||r===W.SPHERICAL_ECEF)){U[r](e,0,w,0);var l=Math.abs(H*w[1])+Math.asin(e[3]/(F+e[2]));if(C(w,0,a,0),l>.9999*Math.PI)a[3]=Number.MAX_VALUE;else{var o=1/Math.cos(l);a[3]=o*e[3]}return!0}return!1}function S(e,n,a){if(null==e)return!1;var t=!0;return b[0]=null!=e.xmin?e.xmin:0,b[1]=null!=e.ymin?e.ymin:0,b[2]=null!=e.zmin?e.zmin:0,t=t&&E(b,e.spatialReference,0,n,a,0,1),b[0]=null!=e.xmax?e.xmax:0,b[1]=null!=e.ymax?e.ymax:0,b[2]=null!=e.zmax?e.zmax:0,t=t&&E(b,e.spatialReference,0,n,a,3,1),null==e.xmin&&(n[0]=-1/0),null==e.ymin&&(n[1]=-1/0),null==e.zmin&&(n[2]=-1/0),null==e.xmax&&(n[3]=1/0),null==e.ymax&&(n[4]=1/0),null==e.zmax&&(n[5]=1/0),t}function v(e,n,a){if(null==e)return!1;var t=!0;return b[0]=null!=e.xmin?e.xmin:0,b[1]=null!=e.ymin?e.ymin:0,b[2]=null!=e.zmin?e.zmin:0,t=t&&E(b,e.spatialReference,0,b,a,0,1),n[0]=b[0],n[1]=b[1],b[0]=null!=e.xmax?e.xmax:0,b[1]=null!=e.ymax?e.ymax:0,b[2]=null!=e.zmax?e.zmax:0,t=t&&E(b,e.spatialReference,0,b,a,0,1),n[2]=b[0],n[3]=b[1],null==e.xmin&&(n[0]=-1/0),null==e.ymin&&(n[1]=-1/0),null==e.xmax&&(n[2]=1/0),null==e.ymax&&(n[3]=1/0),t}function R(e){return e.wkt===n.SphericalECEFSpatialReference.wkt?W.SPHERICAL_ECEF:e.isWGS84?W.WGS84:e.isWebMercator?W.WEBMERC:e.wkt===n.WGS84ECEFSpatialReference.wkt?W.WGS84_ECEF:W.UNKNOWN}function x(e,n,a,t){a[t++]=e[n++],a[t++]=e[n++],a[t]=e[n]}function d(e,n,a,t){a[t++]=g*(e[n++]/F),a[t++]=g*(Math.PI/2-2*Math.atan(Math.exp(-1*e[n++]/F))),a[t]=e[n]}function C(e,n,a,t){var r=.4999999*Math.PI,i=c.clamp(H*e[n+1],-r,r),l=Math.sin(i);a[t++]=H*e[n]*F,a[t++]=F/2*Math.log((1+l)/(1-l)),a[t]=e[n+2]}function G(e,n,a,t){var r=F+e[n+2],i=H*e[n+1],c=H*e[n],l=Math.cos(i);a[t++]=Math.cos(c)*l*r,a[t++]=Math.sin(c)*l*r,a[t]=Math.sin(i)*r}function T(e,n,a,t){var r=l.Vec3Compact.length(e,n),i=c.asin(e[n+2]/r),o=Math.cos(i),u=(e[n+1]>0?1:-1)*c.acos(e[n]/(o*r));a[t++]=g*u,a[t++]=g*i,a[t]=r-F}function I(e,n,a,t){var r=_,i=H*e[n],c=H*e[n+1],l=e[n+2],o=Math.sin(c),u=Math.cos(c),f=r.a/Math.sqrt(1-r.e2*o*o);a[t++]=(f+l)*u*Math.cos(i),a[t++]=(f+l)*u*Math.sin(i),a[t++]=(f*(1-r.e2)+l)*o}function N(e,n,a,t){var r,i,c,l,o,u,f,s,E,M,h,m,S,v,R,x,d,C,G,T,I,N=_,W=e[n],p=e[n+1],A=e[n+2];r=Math.abs(A),i=W*W+p*p,c=Math.sqrt(i),l=i+A*A,o=Math.sqrt(l),T=Math.atan2(p,W),u=A*A/l,f=i/l,v=N.a2/o,R=N.a3-N.a4/o,f>.3?(s=r/o*(1+f*(N.a1+v+u*R)/o),G=Math.asin(s),M=s*s,E=Math.sqrt(1-M)):(E=c/o*(1-u*(N.a5-v-f*R)/o),G=Math.acos(E),M=1-E*E,s=Math.sqrt(M)),h=1-N.e2*M,m=N.a/Math.sqrt(h),S=N.a6*m,v=c-m*E,R=r-S*s,d=E*v+s*R,x=E*R-s*v,C=x/(S/h+d),G+=C,I=d+x*C/2,A<0&&(G=-G),a[t++]=g*T,a[t++]=g*G,a[t]=I}Object.defineProperty(n,"__esModule",{value:!0}),n.SphericalECEFSpatialReference=new t({wkt:'GEOCCS["Spherical geocentric",\n  DATUM["Not specified",\n    SPHEROID["Sphere",\' + earthUtils.earthRadius + \',0]],\n  PRIMEM["Greenwich",0.0,\n    AUTHORITY["EPSG","8901"]],\n  UNIT["m",1.0],\n  AXIS["Geocentric X",OTHER],\n  AXIS["Geocentric Y",EAST],\n  AXIS["Geocentric Z",NORTH]\n]'}),n.WGS84ECEFSpatialReference=new t({wkt:'GEOCCS["WGS 84",\n  DATUM["WGS_1984",\n    SPHEROID["WGS 84",6378137,298.257223563,\n      AUTHORITY["EPSG","7030"]],\n    AUTHORITY["EPSG","6326"]],\n  PRIMEM["Greenwich",0,\n    AUTHORITY["EPSG","8901"]],\n  UNIT["m",1.0,\n    AUTHORITY["EPSG","9001"]],\n  AXIS["Geocentric X",OTHER],\n  AXIS["Geocentric Y",OTHER],\n  AXIS["Geocentric Z",NORTH],\n  AUTHORITY["EPSG","4978"]\n]'});var W;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SPHERICAL_ECEF=1]="SPHERICAL_ECEF",e[e.WGS84=2]="WGS84",e[e.WEBMERC=3]="WEBMERC",e[e.WGS84_ECEF=4]="WGS84_ECEF"}(W||(W={}));var p,A,P,O;n.vectorToVector=o,n.pointToVector=u,n.vectorToPoint=f,n.xyzToVector=s,n.bufferToBuffer=E,n.computeLinearTransformation=M,n.transformDirection=h,n.mbsToMbs=m,n.extentToBoundingBox=S,n.extentToBoundingRect=v;!function(e){function n(e){return e/F}function a(e){return Math.PI/2-2*Math.atan(Math.exp(-1*e/F))}function t(e){return e*F}function r(e){var n=Math.sin(e);return F/2*Math.log((1+n)/(1-n))}e.x2lon=n,e.y2lat=a,e.lon2x=t,e.lat2y=r}(n.webMercator||(n.webMercator={}));var y=[void 0,G,x,C,I],U=[void 0,T,x,d,N],H=c.deg2rad(1),g=c.rad2deg(1),F=i.earthRadius,_={a:6378137,e2:.006694379990137799,a1:42697.67270715754,a2:1823091254.6075456,a3:142.91722289812412,a4:4557728136.518864,a5:42840.589930055656,a6:.9933056200098622},b=r.vec3d.create(),w=r.vec3d.create(),z=r.vec3d.create(),q=r.vec3d.create(),B=r.vec3d.create()});