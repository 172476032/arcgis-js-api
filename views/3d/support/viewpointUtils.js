// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../geometry/SpatialReference","../../../geometry/Point","../../../geometry/Extent","../../../geometry/Geometry","../../../geometry/support/webMercatorUtils","../../../core/Error","../../../core/promiseUtils","../../../Camera","../../../Viewpoint","../../../Graphic","../lib/glMatrix","./mathUtils","./projectionUtils","../camera/intersectionUtils","./cameraUtils","./aaBoundingBox","./aaBoundingRect","./intersectionUtils"],function(e,t,a,n,r,i,o,c,l,s,m,u,f,d,p,g,v,h,y,x){function R(e){return 360-d.cyclicalDeg.normalize(e)}function w(e){return d.cyclicalDeg.normalize(360-e)}function T(e,t,n){if(!t)return null;var r=e.spatialReference||a.WGS84;if(t.camera){var i=t.get("camera.position.spatialReference");if(!o.canProject(i,r))return null;var c=t.camera.clone();return i.equals(r)||(c.position=o.project(c.position,r)),c}var l=t.get("targetGeometry.spatialReference");if(l&&!o.canProject(l,r))return null;var m=v.internalToExternal(e,e.state.camera),u={noReset:!1};if(null!=t.rotation&&(m.heading=R(t.rotation),u.noReset=!0),null!=n&&(m.tilt=n),"point"===t.targetGeometry.type){var f=t.targetGeometry,d=void 0,g=t.targetGeometry.clone();d=null!=t.scale?v.scaleToDistance(e,t.scale,f.latitude):e.state.camera.distance;var h=v.eyeHeadingTiltForCenterPointAtDistance(e,m.heading,m.tilt,g,d,u),y=p.vectorToPoint(h.eye,e.renderSpatialReference,r);return new s(y,h.heading,h.tilt,m.fov)}var x=t.targetGeometry.extent;return v.fromExtent(e,x,m.heading,m.tilt,u)}function b(e,t,a){return a||(a=new m({camera:new s})),v.internalToExternal(e,t,a.camera),A(e,t,a)}function G(e,t,a){return a||(a=new m),a.camera=t.clone(),A(e,null,a)}function S(e,t){var a=U(e,t);if(!a)return l.reject(new c("viewpointutils-create:no-target","Missing target for creating viewpoint"));var n=new m({camera:new s({fov:e.camera.fov})}),i=null!=a.scale||null!=a.zoom;if(a.target instanceof m)return _(j(e,a.target,a,n));if(a.target instanceof s)return _(B(e,a,a.target,n));if(a.target instanceof r){var o=a.target.xmin===a.target.xmax||a.target.ymin===a.target.ymax;return _(i||o?P(e,a,a.target.center,n):Z(e,a,a.target,n))}var u={boundingBox:h.create(h.NEGATIVE_INFINITY),spatialReference:e.spatialReference,hasZ:!1,screenSpaceObjects:[]};return V(e,a.target,u).then(function(){if(isFinite(u.boundingBox[0])){h.center(u.boundingBox,q),$.x=q[0],$.y=q[1],$.z=q[2],$.spatialReference=e.spatialReference;var t=void 0;return isFinite($.z)&&u.hasZ?t=h.isPoint(u.boundingBox):($.z=void 0,t=y.isPoint(h.toRect(u.boundingBox,W))),i||t?P(e,a,$,n):N(e,a,$,u.boundingBox,k(e,u.screenSpaceObjects),n)}return a.position?I(e,a,n):O(e,a,n)}).then(function(e){return _(e)})}function E(e,t,a){var n=a.scale;return null==n&&null!=a.zoom&&(n=v.zoomToScale(e,a.zoom)),n}function z(e,t){var a=!1;return null!=t.heading?(e.heading=t.heading,a=!0):null!=t.rotation&&(e.heading=R(t.rotation),a=!0),null!=t.tilt&&(e.tilt=t.tilt,a=!0),null!=t.fov&&(e.fov=t.fov),a}function A(e,t,n){var r=e.spatialReference||a.WGS84;return t=t||v.externalToInternal(e,n.camera),n.targetGeometry=p.vectorToPoint(t.center,e.renderSpatialReference,r),n.scale=v.computeScale(e,t),n.rotation=w(n.camera.heading),n}function M(e,t,a){if(t){if(!o.canProject(t.spatialReference,e.spatialReference))throw new c("viewpointutils:incompatible-spatialreference","Spatial reference ("+(t.spatialReference?t.spatialReference.wkid:"unknown")+") is incompatible with the view ("+e.spatialReference.wkid+")",{geometry:t});var n=[];if(!t.hasZ&&e.basemapTerrain){var r=void 0;r="point"===t.type?t:"multipoint"===t.type||"polyline"===t.type?t.extent.center:"extent"===t.type?t.center:t.centroid,r&&o.canProject(r,e.basemapTerrain.spatialReference)?q[2]=e.basemapTerrain.getElevation(r)||0:q[2]=0}var i=ee[t.type];i(t,function(e){n.push(e[0],e[1],e[2])},q);var l=n.length/3;if(0!==l){var s=new Array(n.length);if(p.bufferToBuffer(n,t.spatialReference,0,s,e.spatialReference,0,l)){t.hasZ&&(a.hasZ=!0);for(var m=0;m<s.length;m+=3)t.hasZ?(q[0]=s[m+0],q[1]=s[m+1],q[2]=s[m+2]):(q[0]=s[m+0],q[1]=s[m+1]),h.expand(a.boundingBox,q)}}}}function F(e,t,a){var n=e.whenViewForGraphic(t);return n.then(function(e){return e&&e.whenGraphicBounds?e.whenGraphicBounds(t):void 0}).then(function(e){var t=e.boundingBox;h.expand(a.boundingBox,t),e.screenSpaceObjects&&e.screenSpaceObjects.forEach(function(e){a.screenSpaceObjects.push(e)}),isFinite(t[2])&&(a.hasZ=!0)}).otherwise(function(){M(e,t.geometry,a)})}function V(e,t,n){if(Array.isArray(t)&&2===t.length){var r=t[0],o=t[1];if("number"==typeof r&&"number"==typeof o)return $.x=r,$.y=o,$.z=void 0,$.spatialReference=a.WGS84,M(e,$,n),l.resolve()}if(t&&"function"==typeof t.map)return l.eachAlways(t.map(function(t){return V(e,t,n)}));if(t instanceof i)try{M(e,t,n)}catch(c){return l.reject(c)}else if(t instanceof u)return F(e,t,n);return l.resolve()}function j(e,t,a,n){if(t.camera)return B(e,a,t.camera,n);n.scale=t.scale,n.rotation=t.rotation,n.targetGeometry=t.targetGeometry?t.targetGeometry.clone():null,n.camera=null,null!=a.heading?n.rotation=w(a.heading):null!=a.rotation&&(n.rotation=a.rotation);var r=E(e,n.targetGeometry,a);return null!=r&&(n.scale=r),n.camera=T(e,n,a.tilt),n}function B(e,t,a,n){n.camera=a.clone(),n.camera.fov=e.camera.fov;var r=e.spatialReference,i=n.camera.position.spatialReference;return o.canProject(i,r)?(i.equals(r)||(n.camera.position=o.project(n.camera.position,r)),A(e,null,n)):null}function C(e,t,a,r,i){var o=e.renderSpatialReference;return p.pointToVector(a.position,J,o),p.pointToVector(t,K,o),i.targetGeometry=new n(t),i.camera.position=new n(a.position),f.vec3d.subtract(K,J,X),v.directionToHeadingTilt(e,J,X,r.up,i.camera),i.scale=v.distanceToScale(e,f.vec3d.dist(J,K),i.targetGeometry.latitude),i.rotation=w(i.camera.heading),i}function P(e,t,a,n){if(!a)return null;n.targetGeometry=a.clone();var r=g.cameraOnContentAlongViewDirection(e);if(t.position)return C(e,n.targetGeometry,t,r,n);if(t.zoomFactor){var i=r.distance/t.zoomFactor,o=f.vec3d.scale(r.viewForward,-i,q);f.vec3d.add(r.center,o,r.eye),r.markViewDirty(),n.scale=v.distanceToScale(e,i,a.latitude)}v.internalToExternal(e,r,n.camera);var c={noReset:!1};return z(n.camera,t)&&(c.noReset=!0),t.zoomFactor||(n.scale=E(e,n.targetGeometry,t),null==n.scale&&(p.pointToVector(a,q,e.renderSpatialReference),x.frustumPoint(r.frustumPlanes,q)?n.scale=v.distanceToScale(e,f.vec3d.dist(r.eye,q),a.latitude):n.scale=v.computeScale(e,r)),v.fromCenterScale(e,n.targetGeometry,n.scale,n.camera,c,n.camera))?n:null}function I(e,t,a){var r=g.cameraOnContentAlongViewDirection(e);return f.vec3d.set(r.viewForward,X),v.directionToHeadingTilt(e,r.eye,X,r.up,Q),a.camera.position=new n(t.position),a.camera.heading=null!=t.heading?t.heading:Q.heading,a.camera.tilt=null!=t.tilt?t.tilt:Q.tilt,A(e,null,a)}function O(e,t,a){var n=g.cameraOnContentAlongViewDirection(e),r=p.vectorToPoint(n.center,e.renderSpatialReference,$,e.spatialReference);return P(e,t,r,a)}function Z(e,t,a,n){n.targetGeometry=a.clone();var r=g.cameraOnContentAlongViewDirection(e);v.internalToExternal(e,r,n.camera);var i={noReset:!1};return z(n.camera,t)&&(i.noReset=!0),v.fromExtent(e,a,n.camera.heading,n.camera.tilt,i,n.camera)?n:null}function D(e,t,a,n,r){var i=0;a.hasZ?i=a.z:e.basemapTerrain&&(i=e.basemapTerrain.getElevation(a)),f.vec3d.set3(a.x,a.y,i,q),p.computeLinearTransformation(e.spatialReference,q,H,e.renderSpatialReference),f.mat4d.toMat3(H,Y),f.mat3d.transpose(Y),h.set(L,h.NEGATIVE_INFINITY);for(var o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],c=0;c<o.length;c++){var l=o[c],s=n[l[2]];isFinite(s)||(s=i),f.vec3d.set3(n[l[0]],n[l[1]],s,q),p.vectorToVector(q,e.spatialReference,q,e.renderSpatialReference),h.expand(L,f.mat3d.multiplyVec3(Y,q))}var m=h.width(L),u=h.height(L),d=h.depth(L),g=1/Math.tan(t.fovX/2),v=1/Math.tan(t.fovY/2),y=Math.sqrt(m*m+d*d),x=.5*y*Math.max(v,g)+.5*u,R=.5*u*v+.5*Math.max(m,d),w=Math.max(x,R);return w/r}function N(e,t,a,n,r,i){i.targetGeometry=a.clone();var o=g.cameraOnContentAlongViewDirection(e),c=D(e,o,a,n,r);v.internalToExternal(e,o,i.camera);var l={noReset:!1};return z(i.camera,t)&&(l.noReset=!0),i.scale=v.distanceToScale(e,c,i.targetGeometry.latitude),v.fromCenterScale(e,i.targetGeometry,i.scale,i.camera,l,i.camera)?i:null}function U(e,t){if(!t||!e.spatialReference)return null;var a={target:null};if("declaredClass"in t||Array.isArray(t))a.target=t;else{for(var n in t)a[n]=t[n];t.center&&!a.target&&(a.target=t.center)}return a}function _(e){return e&&(e.rotation=w(e.camera.heading)),l.resolve(e)}function k(e,a){var n=t.DEFAULT_FRAME_COVERAGE;if(!a.length)return n;for(var r=Number.NEGATIVE_INFINITY,i=0;i<a.length;i++){var o=a[i].screenSpaceBoundingRect;r=Math.max(r,Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2]),Math.abs(o[3]))}var c=Math.min(e.width,e.height),l=r/c*2;return n-l}Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_FRAME_COVERAGE=.66,t.rotationToHeading=R,t.headingToRotation=w,t.toCamera=T,t.fromInternalCamera=b,t.fromCamera=G,t.create=S;var q=f.vec3d.create(),H=f.mat4d.create(),Y=f.mat3d.create(),L=h.create(),W=y.create(),X=f.vec3d.create(),J=f.vec3d.create(),K=f.vec3d.create(),Q={heading:0,tilt:0},$=new n,ee={point:function(e,t,a){a[0]=e.x,a[1]=e.y,e.hasZ&&(a[2]=e.z),t(a)},polygon:function(e,t,a){for(var n=e.hasZ,r=0;r<e.rings.length;r++)for(var i=e.rings[r],o=0;o<i.length;o++)a[0]=i[o][0],a[1]=i[o][1],n&&(a[2]=i[o][2]),t(a)},polyline:function(e,t,a){for(var n=e.hasZ,r=0;r<e.paths.length;r++)for(var i=e.paths[r],o=0;o<i.length;o++)a[0]=i[o][0],a[1]=i[o][1],n&&(a[2]=i[o][2]),t(a)},multipoint:function(e,t,a){for(var n=e.points,r=e.hasZ,i=0;i<n.length;i++)a[0]=n[i][0],a[1]=n[i][1],r&&(a[2]=n[i][2]),t(a)},extent:function(e,t,a){e.hasZ?(t(f.vec3d.set3(e.xmin,e.ymin,e.zmin,a)),t(f.vec3d.set3(e.xmax,e.ymin,e.zmin,a)),t(f.vec3d.set3(e.xmin,e.ymax,e.zmin,a)),t(f.vec3d.set3(e.xmax,e.ymax,e.zmin,a)),t(f.vec3d.set3(e.xmin,e.ymin,e.zmax,a)),t(f.vec3d.set3(e.xmax,e.ymin,e.zmax,a)),t(f.vec3d.set3(e.xmin,e.ymax,e.zmax,a)),t(f.vec3d.set3(e.xmax,e.ymax,e.zmax,a))):(t(f.vec3d.set3(e.xmin,e.ymin,a[2],a)),t(f.vec3d.set3(e.xmax,e.ymin,a[2],a)),t(f.vec3d.set3(e.xmin,e.ymax,a[2],a)),t(f.vec3d.set3(e.xmax,e.ymax,a[2],a)))}}});