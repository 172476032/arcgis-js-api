// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../geometry/SpatialReference","../../../geometry/Geometry","../../../geometry/Point","../../../geometry/Extent","../../../geometry/support/webMercatorUtils","../../../core/Error","../../../core/promiseUtils","../../../Camera","../../../Viewpoint","../../../Graphic","../lib/glMatrix","./mathUtils","./projectionUtils","./cameraUtils","./aaBoundingBox","./aaBoundingRect","./intersectionUtils"],function(e,t,n,a,r,i,o,c,l,s,u,m,f,g,p,d,v){function y(e){return 360-m.cyclicalDeg.normalize(e)}function h(e){return m.cyclicalDeg.normalize(360-e)}function x(t,a,i){var o;if(!a)return null;var l,s=t.spatialReference||e.WGS84;if(a.camera){if(l=a.get("camera.position.spatialReference"),!r.canProject(l,s))return null;if(o=a.camera.clone(),!l.equals(s)){var u=r.project(o.position,s);o.position=u}return o}if(l=a.get("targetGeometry.spatialReference"),l&&!r.canProject(l,s))return null;var m=t.navigation.currentCamera;v=g.internalToExternal(t,m);var p={noReset:!1};if(null!=a.rotation&&(v.heading=y(a.rotation),p.noReset=!0),null!=i&&(v.tilt=i),a.targetGeometry instanceof n){var d,v,h=a.targetGeometry,x=a.targetGeometry.clone();d=null!=a.scale?g.scaleToDistance(t,a.scale,h.latitude):m.distance,o=g.eyeHeadingTiltForCenterPointAtDistance(t,v.heading,v.tilt,x,d,p);var T=f.vectorToPoint(o.eye,t.renderSpatialReference,s);return new c(T,o.heading,o.tilt,v.fov)}var R=a.targetGeometry.extent;return g.fromExtent(t,R,v,p)}function T(e,t,n){return null!=e[t]?e[t]:null!=n?"function"==typeof n?n():n:void 0}function R(e,t,n,a){var r=n.scale;return null==r&&null!=n.zoom&&(r=g.zoomToScale(e,n.zoom)),null==r&&null!=n.distance&&(t=t.center||t,r=g.distanceToScale(e,n.distance,t.latitude)),null==r&&a&&(r="function"==typeof a?a():a),r}function G(e,t,n){var a=t.heading;return null==a&&null!=t.rotation&&(a=y(t.rotation)),null==a&&n&&(a="function"==typeof n?n():n),a}function w(t,a,r,i,o){if(!(a&&r.position||a&&r.direction||r.position&&r.direction))return!1;var c=t.spatialReference||e.WGS84,l=t.renderSpatialReference,s=r.direction;if(a&&r.position&&(s=null),r.position&&f.pointToVector(r.position,q,l),a&&f.pointToVector(a,L,l),s){var u=r.position||a,m=new n(u);m.x+=s[0],m.y+=s[1],s.length>2&&(m.z+=s[2]),f.pointToVector(m,O,l),N.subtract(O,r.position?q:L)}if(r.position&&s)o.camera.position=new n(r.position),g.directionToHeadingTilt(t,q,O,i.up,o.camera),N.add(q,O,L),t.navigation.getCenterIntersectTerrain(q,L,L),o.targetGeometry=f.vectorToPoint(L,l,c),o.scale=g.distanceToScale(t,N.dist(q,L),o.targetGeometry.latitude);else if(a&&s){o.targetGeometry=new n(a),o.scale=R(t,o.targetGeometry,r,function(){return g.computeScale(t,i)});var p=g.scaleToDistance(t,o.scale,a.latitude);N.scale(O,p/N.length(O),q),N.add(q,L),o.camera.position=f.vectorToPoint(q,l,c),g.directionToHeadingTilt(t,q,O,i.up,o.camera)}else o.targetGeometry=new n(a),o.camera.position=new n(r.position),N.subtract(L,q,O),g.directionToHeadingTilt(t,q,O,i.up,o.camera),o.scale=g.distanceToScale(t,N.dist(q,L),o.targetGeometry.latitude);return o.rotation=h(o.camera.heading),!0}function E(e,t){var n=!1;return null!=t.heading?(e.heading=t.heading,n=!0):null!=t.rotation&&(e.heading=y(t.rotation),n=!0),null!=t.tilt&&(e.tilt=t.tilt,n=!0),null!=t.fov&&(e.fov=t.fov),n}function S(t,n,a){var r=t.spatialReference||e.WGS84;return n=n||g.externalToInternal(t,a.camera),a.targetGeometry=f.vectorToPoint(n.center,t.renderSpatialReference,r),a.scale=g.computeScale(t,n),a.rotation=h(a.camera.heading),a}function z(e,t,n){return n||(n=new l({camera:new c})),g.internalToExternal(e,t,n.camera),S(e,t,n)}function b(e,t,n){return n||(n=new l),n.camera=t.clone(),S(e,null,n)}function C(e,t,a){if(t){var r=[];if(!t.hasZ&&e.basemapTerrain){var i;i=t.isInstanceOf(n)?t:t.centroid||t.center,i?X[2]=e.basemapTerrain.getElevation(i)||0:X[2]=0}te[t.declaredClass](t,function(e){r.push(e[0],e[1],e[2])},X);var o=r.length/3;if(0!==o){var c=new Array(r.length);if(f.bufferToBuffer(r,t.spatialReference,0,c,e.spatialReference,0,o)){t.hasZ&&(a.hasZ=!0);for(var l=0;l<c.length;l+=3)t.hasZ?(X[0]=c[l+0],X[1]=c[l+1],X[2]=c[l+2]):(X[0]=c[l+0],X[1]=c[l+1]),p.expand(a.boundingBox,X)}}}}function P(e,t,n){var a=e.whenViewForGraphic(t);return a.then(function(e){return e&&e.whenGraphicBounds?e.whenGraphicBounds(t):void 0}).then(function(e){p.expand(n.boundingBox,e),isFinite(e[2])&&(n.hasZ=!0)}).otherwise(function(){C(e,t.geometry,n)})}function I(n,a,r){if(Array.isArray(a)&&2===a.length&&"number"==typeof a[0]&&"number"==typeof a[1])$.x=a[0],$.y=a[1],$.z=void 0,$.spatialReference=e.WGS84,C(n,$,r);else{if(a&&a.forEach)return o.eachAlways(a.map(function(e){return I(n,e,r)}));if(a instanceof t)C(n,a,r);else if(a instanceof s)return P(n,a,r)}return o.resolve()}function A(e,t,n,a){if(t.camera)return B(e,n,t.camera,a);a.scale=t.scale,a.rotation=t.rotation,a.targetGeometry=t.targetGeometry?t.targetGeometry.clone():null,a.camera=null,null!=n.heading?a.rotation=h(n.heading):null!=n.rotation&&(a.rotation=n.rotation);var r=R(e,a.targetGeometry,n);return null!=r&&(a.scale=r),a.camera=x(e,a,n.tilt),a}function B(e,t,n,a){a.camera=n.clone(),a.camera.fov=e.camera.fov;var i=e.spatialReference,o=a.camera.position.spatialReference;if(!r.canProject(o,i))return null;if(!o.equals(i)){var c=r.project(a.camera.position,i);a.camera.position=c}return S(e,null,a)}function F(e,t,n,a){if(!n)return null;a.targetGeometry=n.clone();var r=e.navigation.getCameraIntersectTerrain();if(w(e,a.targetGeometry,t,r,a))return a;g.internalToExternal(e,r,a.camera);var i={noReset:!1};return E(a.camera,t)&&(i.noReset=!0),a.scale=R(e,a.targetGeometry,t),null==a.scale&&(f.pointToVector(n,X,e.renderSpatialReference),v.frustumPoint(r.frustumPlanes,X)?a.scale=g.distanceToScale(e,N.dist(r.eye,X),n.latitude):a.scale=g.computeScale(e,r)),g.fromCenterScale(e,a.targetGeometry,a.scale,a.camera,i,a.camera)?a:null}function M(e,t,a){var r=e.navigation.getCameraIntersectTerrain();if(w(e,null,t,r,a))return a;if(t.position)return N.set(r.viewForward,O),g.directionToHeadingTilt(e,r.eye,O,r.up,Y),a.camera.position=new n(t.position),a.camera.heading=G(e,t,Y.heading),a.camera.tilt=T(t,"tilt",Y.tilt),S(e,null,a);var i=f.vectorToPoint(r.center,e.renderSpatialReference,$,e.spatialReference);return F(e,t,i,a)}function Z(e,t,n,a){a.targetGeometry=n.clone();var r=e.navigation.getCameraIntersectTerrain();g.internalToExternal(e,r,a.camera);var i={noReset:!1};return E(a.camera,t)&&(i.noReset=!0),g.fromExtent(e,n,a.camera,i,a.camera)?a:null}function V(e,t,n,a,r){var i=0;n.hasZ?i=n.z:e.basemapTerrain&&(i=e.basemapTerrain.getElevation(n)),N.set3(n.x,n.y,i,X),f.computeLinearTransformation(e.spatialReference,X,k,e.renderSpatialReference),W.toMat3(k,J),_.transpose(J),p.set(K,p.NEGATIVE_INFINITY);for(var o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],c=0;c<o.length;c++){var l=o[c],s=a[l[2]];isFinite(s)||(s=i),N.set3(a[l[0]],a[l[1]],s,X),f.vectorToVector(X,e.spatialReference,X,e.renderSpatialReference),p.expand(K,_.multiplyVec3(J,X))}var u=p.width(K),m=p.height(K),g=p.depth(K),d=1/Math.tan(t.fovX/2),v=1/Math.tan(t.fovY/2),y=Math.sqrt(u*u+g*g),h=.5*y*Math.max(v,d)+.5*m,x=.5*m*v+.5*Math.max(u,g),T=Math.max(h,x);return T/r}function U(e,t,n,a,r,i){i.targetGeometry=n.clone();var o=e.navigation.getCameraIntersectTerrain(),c=V(e,o,n,a,r);g.internalToExternal(e,o,i.camera);var l={noReset:!1};return E(i.camera,t)&&(l.noReset=!0),i.scale=g.distanceToScale(e,c,i.targetGeometry.latitude),g.fromCenterScale(e,i.targetGeometry,i.scale,i.camera,l,i.camera)?i:null}function j(e,t){if(!t||!e.spatialReference)return null;var n={};if(null!=t.declaredClass||Array.isArray(t))n.target=t;else{for(var a in t)n[a]=t[a];t.center&&!n.target&&(n.target=t.center)}return n}function D(e){return e&&(e.rotation=h(e.camera.heading)),o.resolve(e)}function H(e,t){var n=j(e,t);if(!n)return o.reject(new i("viewpointutils-create:no-target","Missing target for creating viewpoint"));var r=new l({camera:new c({fov:e.camera.fov})}),s=null!=n.scale||null!=n.zoom||null!=n.distance;if(n.target instanceof l)return D(A(e,n.target,n,r));if(n.target instanceof c)return D(B(e,n,n.target,r));if(n.target instanceof a){var u=n.target.xmin===n.target.xmax||n.target.ymin===n.target.ymax;return D(s||u?F(e,n,n.target.center,r):Z(e,n,n.target,r))}var m={boundingBox:p.create(p.NEGATIVE_INFINITY),spatialReference:e.spatialReference,hasZ:!1};return I(e,n.target,m).then(function(){if(isFinite(m.boundingBox[0])){p.center(m.boundingBox,X),$.x=X[0],$.y=X[1],$.z=X[2],$.spatialReference=e.spatialReference;var t;return isFinite($.z)&&m.hasZ?t=p.isPoint(m.boundingBox):($.z=void 0,t=d.isPoint(p.toRect(m.boundingBox,Q))),s||t?F(e,n,$,r):U(e,n,$,m.boundingBox,ne.DEFAULT_FRAME_COVERAGE,r)}return M(e,n,r)}).then(function(e){return D(e)})}var N=u.vec3d,_=u.mat3d,W=u.mat4d,q=N.create(),L=N.create(),O=N.create(),Y={heading:0,tilt:0},X=N.create(),k=W.create(),J=_.create(),K=p.create(),Q=d.create(),$=new n,ee=function(e,t,n){for(var a=e.hasZ,r=0;r<e.rings.length;r++)for(var i=e.rings[r],o=0;o<i.length;o++)n[0]=i[o][0],n[1]=i[o][1],a&&(n[2]=i[o][2]),t(n)},te={"esri.geometry.Point":function(e,t,n){n[0]=e.x,n[1]=e.y,e.hasZ&&(n[2]=e.z),t(n)},"esri.geometry.Polygon":ee,"esri.geometry.Circle":ee,"esri.geometry.Polyline":function(e,t,n){for(var a=e.hasZ,r=0;r<e.paths.length;r++)for(var i=e.paths[r],o=0;o<i.length;o++)n[0]=i[o][0],n[1]=i[o][1],a&&(n[2]=i[o][2]),t(n)},"esri.geometry.Multipoint":function(e,t,n){for(var a=e.points,r=e.hasZ,i=0;i<a.length;i++)n[0]=a[i][0],n[1]=a[i][1],r&&(n[2]=a[i][2]),t(n)},"esri.geometry.Extent":function(e,t,n){e.hasZ?(t(N.set3(e.xmin,e.ymin,e.zmin,n)),t(N.set3(e.xmax,e.ymin,e.zmin,n)),t(N.set3(e.xmin,e.ymax,e.zmin,n)),t(N.set3(e.xmax,e.ymax,e.zmin,n)),t(N.set3(e.xmin,e.ymin,e.zmax,n)),t(N.set3(e.xmax,e.ymin,e.zmax,n)),t(N.set3(e.xmin,e.ymax,e.zmax,n)),t(N.set3(e.xmax,e.ymax,e.zmax,n))):(t(N.set3(e.xmin,e.ymin,n[2],n)),t(N.set3(e.xmax,e.ymin,n[2],n)),t(N.set3(e.xmin,e.ymax,n[2],n)),t(N.set3(e.xmax,e.ymax,n[2],n)))}},ne={create:H,rotationToHeading:y,headingToRotation:h,toCamera:x,fromCamera:b,fromInternalCamera:z,DEFAULT_FRAME_COVERAGE:.66};return ne});