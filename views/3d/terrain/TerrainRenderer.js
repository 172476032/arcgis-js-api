// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["dojo/when","./tileUtils","./TerrainConst","./TileGeometryFactory","./TileRenderData","./ResourceCounter","./TileRenderer","../support/PreallocArray","../../../core/ObjectPool","../../../core/promiseUtils","../support/imageUtils","../webgl-engine/lib/ShaderVariations","dojo/text!./TerrainMaterial.xml","../webgl-engine/materials/internal/MaterialUtil","../webgl-engine/lib/Util","../webgl-engine/lib/Geometry","../webgl-engine/lib/GeometryData","../lib/glMatrix","../webgl-engine/lib/RenderPass","../webgl-engine/lib/RenderSlot","../webgl-engine/lib/tracer","../../webgl/VertexArrayObject","../../webgl/BufferObject","../../webgl/Program","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/DefaultVertexBufferLayouts","../webgl-engine/lib/screenSizePerspectiveUtils","../webgl-engine/lib/glUtil3D","../../webgl/Util"],function(e,t,i,r,n,a,s,l,o,d,h,u,c,f,g,v,p,m,T,b,R,D,x,S,y,E,w,_,A){var O=g.assert,I=m.vec2d,P=m.vec3d,M=m.vec4d,N=m.mat4d.identity(),U=[2,2],L=b.OPAQUE_TERRAIN,B=b.TRANSPARENT_TERRAIN,H=P.create(),G=I.create(),C=function(g,v,p){function m(){for(;xe.length<xe.data.length&&ye.length>0;){var e=ye.pop();xe.push(e)}Se=xe.length}function b(){for(var e=0;e<xe.length;e++){var t=xe.data[e];Ee.release(t),t.callback(e>=Se),t.callback=null}xe.clear()}function I(e,t){var i=e.screenDepth,r=t.screenDepth;return i<r?-de:i>r?de:0}function C(e,t){return 0===e.tiles.length?-de:0===t.tiles.length?de:I(e.tiles.data[0],t.tiles.data[0])}function j(e){for(var t=e.extent,i=e.lij[0],r=0;r<Se;){var n=xe.data[r],a=n.extent;i>=n.minLevel&&i<=n.maxLevel&&a[0]<=t[2]&&a[2]>=t[0]&&a[1]<=t[3]&&a[3]>=t[1]?(xe.swap(r,Se-1),Se--):r++}}v=v||256;var F,V,W,z=!1,q=null,Y=null,Z=null,Q={},X=new o(n),J=new l(10,function(){return{root:null,tiles:new l(300)}}),K=!0,$=new t.IteratorPreorder,ee=null,te=!0,ie=1,re=!0,ne=!1,ae={mode:"none",width:1.5,falloff:1.5,wireOpacity:1,surfaceOpacity:0,color:[1,1,1,0],resolution:64},se=!1,le=!1,oe=!1,de=1,he=!0,ue=!0,ce=null,fe=null,ge=null,ve=!1,pe=[];this.updateTileBackground=function(e){return ge&&ge.cancel(),ge=e?h.requestImage(e).catch(function(){return null}):d.resolve(null),this.renderTileBackground(),ge};var me=0,Te=0,be=0,Re=0;this.resourceCounter=new a,this.castShadows=!0,this.clippingExtent=null,this.loaded=function(){};var De=!1;this.needsRender=!0,this.didRender=!1,this.needsHighlight=!1,this.receiveShadows=!1;var xe=new l(10),Se=0,ye=new l(30),Ee=new o(function(){this.extent=M.create(),this.minLevel=0,this.maxLevel=0,this.callback=null},!1);this.renderTileBackground=function(){if(V&&ge&&fe)return ge.then(function(e){fe&&(ve=!0,fe.setGridImage(e),q&&t.traverseTilesPreorder(q,function(e){fe.updateTileTexture(e)}.bind(this)))}.bind(this))},this.initializeRenderContext=function(t){V=t.rctx,W=t.rctx.gl;var i=function(t){e(t).then(function(){z=!0,this.setNeedsRender()}.bind(this)).catch(i)}.bind(this);i(this.renderTileBackground()),F=t.textureRep;var r=t.shaderSnippets,n=t.programRep;r.vsTerrain||r._parse(c);var a=new u("terrain",["vsTerrain","fsTerrain"],null,n,r,V);a.addDefine("Spherical","SPHERICAL"),a.addDefine("Overlay","OVERLAY"),a.addDefine("Atmosphere","ATMOSPHERE"),a.addDefine("Wireframe","WIREFRAME"),a.addDefine("TileBorders","TILE_BORDERS"),a.addBinaryShaderSnippetSuffix("Wireframe","Wireframe",[!1,!0]),a.addDefine("ReceiveShadows","RECEIVE_SHADOWS"),a.addDefine("ScreenSizePerspective","SCREEN_SIZE_PERSPECTIVE");var l=new u("terrainNormal",["vsTerrainNormal","fsNormal"],null,n,r,V);l.addDefine("Spherical","SPHERICAL"),l.addDefine("AlphaZero","ALPHA_ZERO"),Z={depth:n.get("depth"),depthShadowMap:n.get("depthShadowMap"),depthOnly:new S(V,r.vsTerrainDepthOnly,r.fsTerrainDepthOnly,y.Default3D),highlight:new S(V,r.vsTerrainHighlight,r.fsTerrainHighlight,y.Default3D)},Y={color:a,normal:l},this._updatePrograms(),fe=new s(V,v,n,this.resourceCounter,this.setNeedsRender.bind(this)),this.renderTileBackground(),ce=_.createEmptyTexture(V)},this.uninitializeRenderContext=function(e){null!=ce&&(ce.dispose(),ce=null),fe&&(fe.dispose(),fe=null)},this._updatePrograms=function(){var e="spherical"===g,t="shader"===ae.mode;Z.color=Y.color.getProgram([e,!0,e&&ue,t,se,t||se,this.receiveShadows,ne]),Z.normal=Y.normal.getProgram([e,!0]),this.setNeedsRender()},this.destroy=function(e){this.uninstall(e),ge&&(ge.cancel(),ge=null)},this.install=function(e){e.addExternalRenderer([L,B],this)},this.uninstall=function(e){e.removeExternalRenderer(this)},this.setRootTiles=function(e){q=e,this.setNeedsRender()},this.setNeedsHighlight=function(e){this.needsHighlight=e,this.setNeedsRender()},this.setStencilEnabledLayerExtents=function(e){pe=e,this.setNeedsRender()},this.setTileSize=function(e){v=e,fe&&(fe.tileSize=e),this.setNeedsRender()},this.loadTile=function(e){O(null===e.renderData),e.renderData=X.acquire(),e.renderData.init();var t=this.getLocalOriginOfTile(e);e.createGeometry(e.renderData.updateGeometryState(e),t,"debug"===ae.mode,e.renderData.geometryInfo),e.renderData.localOrigin=t,this._updateTileGeometryBuffers(e),ve&&fe.updateTileTexture(e)},this.queryVisibleLevelRange=function(e,t,i,r){var n=Ee.acquire();M.set(e,n.extent),n.minLevel=t||-Number.MAX_VALUE,n.maxLevel=null!=i?i:Number.MAX_VALUE,n.callback=r,ye.push(n),this.setNeedsRender()},this.updateTileTexture=function(e){fe&&ve&&fe.updateTileTexture(e)},this.updateTileGeometryNeedsUpdate=function(e){return e.renderData.updateGeometryState(e).needsUpdate},this._updateTileGeometry=function(e){for(var t=e.renderData.geometryState,r=e.layerInfo[i.LayerClass.ELEVATION],n=0;n<r.length;n++)r[n].pendingUpdates&=~i.TileUpdateTypes.UPDATE_GEOMETRY;return!!t.needsUpdate&&(e.renderData.vao&&this._releaseTileGeometry(e),e.createGeometry(t,e.renderData.localOrigin,"debug"===ae.mode,e.renderData.geometryInfo),this._updateTileGeometryBuffers(e),!0)},this.updateTileGeometry=function(e){return e.renderData.updateGeometryState(e),this._updateTileGeometry(e)},this.unloadTile=function(e){this._releaseTileGeometry(e),e.renderData.texture&&e.renderData.texture.dispose(),X.release(e.renderData),e.renderData=null},this.getLocalOriginOfTile=function(e){if(e.lij[0]>=10){for(;e.lij[0]>7;)e=e.parent;return e.centerAtSeaLevel}if("spherical"===g)return H;for(;e.parent;)e=e.parent;return e.centerAtSeaLevel},this.setVisibility=function(e){te=e,this.setNeedsRender()},this.getStats=function(){return{numTilesRendered:Te,numTilesCulled:be,numTrianglesRendered:me,numOriginsRendered:Re}},this.setDisableRendering=function(e){le=!!e,this.setNeedsRender()},this.getOpacity=function(){return ie},this.getWireframeEnabled=function(){return"shader"===ae.mode},this.setDebugScreenSizePerspective=function(e){e!==ne&&(ne=e,this._updatePrograms())},this.setWireframe=function(e){if(e&&!0!==e||(e={mode:e?"shader":"none"}),void 0!==e.mode&&ae.mode!==e.mode){var i="debug"===ae.mode,r="debug"===e.mode;ae.mode=e.mode,this._updatePrograms(),i!==r&&q&&t.traverseTilesPreorder(q,function(e){e.renderData&&(e.renderData.vao&&this._releaseTileGeometry(e),e.createGeometry(e.renderData.updateGeometryState(e),e.renderData.localOrigin,r,e.renderData.geometryInfo),this._updateTileGeometryBuffers(e))}.bind(this))}for(var n in e)ae.hasOwnProperty(n)&&(ae[n]=e[n]),this.setNeedsRender();ae.resolution&&(ae.resolution=Math.min(ae.resolution,v),ae.resolution=1<<Math.round(Math.log(ae.resolution)/Math.LN2))},this.setOpacity=function(e){ie=e,this.setNeedsRender()},this.setDrawSkirts=function(e){re=e,this.setNeedsRender()},this.setCullBackFaces=function(e){oe=e,this.setNeedsRender()},this.setRenderOrder=function(e){de=e,this.setNeedsRender()},this.setBorders=function(e){se!==e&&(se=e,this._updatePrograms())},this.setFrontMostTransparent=function(e){he!==e&&(he=e,this.setNeedsRender())},this.setVelvetOverground=function(e){ue!==e&&(ue=e,this._updatePrograms())},this.setNeedsRender=function(){this.needsRender=!0,this.didRender=!1,K=!0},this.resetNeedsRender=function(){this.didRender&&(this.needsRender=0!==ye.length,this.didRender=!1)};var we=P.create();this.isTransparent=function(){return ie<1||"shader"===ae.mode&&(ae.wireOpacity<1||ae.surfaceOpacity<1)},this._renderMaterialPass=function(e,t){var i=this.isTransparent(),r=e.shadowMap&&e.shadowMap.getEnableState();this.receiveShadows!=r&&(this.receiveShadows=r,this._updatePrograms());var n=e.camera;if(V.setDepthTestEnabled(!0),V.setBlendingEnabled(i),i&&V.setBlendFunctionSeparate(W.SRC_ALPHA,W.ONE_MINUS_SRC_ALPHA,W.ONE,W.ONE_MINUS_SRC_ALPHA),i&&he){var a=Z.depthOnly;V.bindProgram(a),V.setColorMask(!1,!1,!1,!1),V.setDepthWriteEnabled(!0),this._renderTilesAuxiliary(e,a,t),V.setColorMask(!0,!0,!0,!0),V.setDepthFunction(W.EQUAL),V.setDepthWriteEnabled(!1)}else V.setDepthFunction(W.LESS);var s=Z.color;V.bindProgram(s),s.setUniform1f("opacity",ie),("shader"===ae.mode||se)&&(s.setUniform1f("wireframe.width",ae.width),s.setUniform1f("wireframe.falloff",Math.min(ae.width,ae.falloff)),s.setUniform1f("wireframe.wireOpacity",ae.wireOpacity*ie),s.setUniform1f("wireframe.surfaceOpacity",ae.surfaceOpacity*ie),s.setUniform4fv("wireframe.color",ae.color));var n=e.camera;e.shadowMap&&e.shadowMap.bind(s),e.ssaoHelper&&e.ssaoHelper.setUniforms(s),s.setUniform1i("tex",4),s.setUniform1i("overlayTex",5),s.setUniformMatrix4fv("viewNormal",n.viewInverseTransposeMatrix),s.setUniformMatrix4fv("proj",n.projectionMatrix),e.lightingData.helper.setUniforms(s,!0);var l=n.viewMatrix;P.set3(l[12],l[13],l[14],we),P.normalize(we),s.setUniform3fv("viewDirection",we),Te=0,be=0,me=0,Re=0,m(),this._renderTiles(e,s,t),V.setBlendingEnabled(!1),V.setDepthFunction(W.LESS),V.setDepthWriteEnabled(!0),b(),Te>0&&!De&&(De=!0,this.loaded&&this.loaded())},this._renderDepthPass=function(e,t,i){var r=e.camera;V.bindProgram(t),V.setBlendingEnabled(!1),V.setDepthTestEnabled(!0),V.setDepthFunction(W.LESS),t.setUniformMatrix4fv("model",N),t.setUniformMatrix4fv("viewNormal",r.viewInverseTransposeMatrix),G[0]=r.near,G[1]=r.far,t.setUniform2fv("nearFar",G),this._renderTilesAuxiliary(e,t,i)},this._renderNormalPass=function(e,t){var i=e.camera,r=Z.normal;V.bindProgram(r),V.setBlendingEnabled(!1),V.setDepthTestEnabled(!0),V.setDepthFunction(W.LESS),r.setUniformMatrix4fv("viewNormal",i.viewInverseTransposeMatrix),this._renderTilesAuxiliary(e,r,t)},this._renderHighlightPass=function(e,t){var i=Z.highlight;V.bindProgram(i),V.setBlendingEnabled(!1),V.setDepthTestEnabled(!0),V.setDepthFunction(W.LESS);var r=e.offscreenRenderingHelper;V.bindTexture(r.getDepthTexture(),6),i.setUniform1i("depthTex",6),i.setUniform4f("highlightViewportPixelSz",0,0,1/r.width,1/r.height),this._renderTilesAuxiliary(e,i,t,!0)},this.render=function(e){if(z&&!le&&te&&q&&ve){var t=this.isTransparent(),i=t?B:L;if(e.slot===i){R.trace("# BEGIN RENDER TERRAIN");var r=e.pass;V.setFaceCullingEnabled(oe);var n=1===e.lightingData.helper.globalFactor;if(r===T.MATERIAL)this._renderMaterialPass(e,this._updatePerOriginTileData());else if(r===T.MATERIAL_DEPTH_SHADOWMAP&&this.castShadows&&n)this._renderDepthPass(e,Z.depthShadowMap,this._updatePerOriginTileData());else if(r===T.MATERIAL_DEPTH)this._renderDepthPass(e,Z.depth,this._updatePerOriginTileData());else if(r===T.MATERIAL_NORMAL)this._renderNormalPass(e,this._updatePerOriginTileData());else if(r===T.MATERIAL_HIGHLIGHT&&this.needsHighlight){this._renderHighlightPass(e,this._updatePerOriginTileData());var a=V.gl;V.clear(a.DEPTH_BUFFER_BIT)}return oe&&V.setFaceCullingEnabled(!1),R.trace("# END RENDER TERRAIN"),!0}}},this._updatePerOriginTileData=function(){if(!K)return J;if(ee=null,this._renderCollectOrigins(),0!==de){for(var e=0;e<J.length;e++)this._sortFrontToBack(J.data[e].tiles,I);this._sortFrontToBack(J,C)}return K=!1,J},this._renderCollectOrigins=function(){J.clear();for(var e=0;e<q.length;e++){var t=q[e],i=J.next();i.root=t,i.origin="spherical"===g?H:t.centerAtSeaLevel,i.tiles.clear(),this._renderCollectOriginsForRoot(i)}return!0},this._renderCollectOriginsForRoot=function(e){for($.reset(e.root);!$.done;){var t=$.next(),i=t.renderData;if(!i||t.visible){var r=J.peek();if(7===t.lij[0]&&(r!==e&&0===r.tiles.length||(r=J.next(),r.tiles.clear()),r.root=t,r.origin=t.centerAtSeaLevel),i){t.lij[0]>=10?J.peek().tiles.push(t):e.tiles.push(t),(!ee||t.vlevel>ee.vlevel)&&(ee=t),$.skip()}}else be++,$.skip()}},this._sortFrontToBack=function(e,t){e.sort(t)},this._updateStencilReadStateForTile=function(e,t){if(e.stencilRenderingHelper&&e.stencilRenderingHelper.getEnableState()){for(var i=!1,r=0;r<pe.length;r++)if(t.intersectsExtent(pe[r])){i=!0;break}i?e.stencilRenderingHelper.enableStencilRead():e.stencilRenderingHelper.disableStencilRead()}},this._renderTilesAuxiliary=function(e,t,i,r){var n=e.camera,a=n.viewMatrix,s=e.rctx;t.setUniformMatrix4fv("proj",n.projectionMatrix),r&&t.setUniform1i("overlayTex",5);for(var l=0;l<i.length;l++){var o=i.data[l];t.setUniform3fv("origin",o.origin),f.bindView(o.origin,a,t);for(var d=0;d<o.tiles.length;d++){var h=o.tiles.data[d],u=h.renderData;r&&(u.highlightOverlayTexId?_e(t,u,u.highlightOverlayTexId):s.bindTexture(ce,5)),this._updateStencilReadStateForTile(e,h),s.bindVAO(u.vao),A.assertCompatibleVertexAttributeLocations(u.vao,t);var c=u.vao.indexBuffer.size;re||(c=u.geometryInfo.numWithoutSkirtIndices),s.drawElements(W.TRIANGLES,c,u.vao.indexBuffer.indexType,0)}}s.bindVAO(null),s.stencilRenderingHelper&&s.stencilRenderingHelper.disableStencilRead()},this._renderTiles=function(e,t,i){var r=e.camera,n=r.viewMatrix;if(ne){var a=w.getSettings(g);a.update({distance:p.distanceToSurface,fovY:p.fovY}),f.bindScreenSizePerspective(a,t,"screenSizePerspective")}for(var s=0;s<i.length;s++){var l=i.data[s];t.setUniform3fv("origin",l.origin),f.bindView(l.origin,n,t),e.shadowMap&&e.shadowMap.bindView(t,l.origin),Re++;var o=l.tiles;if(0!==o.length){var d=W.TRIANGLES;"debug"===ae.mode&&(d=W.LINES);var h,u,c=ee;c?(h=c.vlevel,u=v/ae.resolution):(h=16,u=v/64);for(var m=0;m<o.length;m++){var T=o.data[m],l=T.renderData;this._updateStencilReadStateForTile(e,T),R.trace("# RENDER TILE "+T.lij[0]+"/"+T.lij[1]+"/"+T.lij[2]+", screenDepth:"+T.screenDepth),t.setUniform2fv("texOffset",l.texOffset),t.setUniform1f("texScale",l.texScale);var b=l.textureReference||l.texture;if(V.bindTexture(b,4),l.overlayTexId?_e(t,l,l.overlayTexId):(t.setUniform2fv("overlayTexOffset",U),V.bindTexture(ce,5)),"shader"===ae.mode||se){var D=u*(1<<h-T.vlevel);t.setUniform1f("wireframe.subdivision",D)}var x=l.vao.indexBuffer.size;re||(x=l.geometryInfo.numWithoutSkirtIndices),V.bindVAO(l.vao),A.assertCompatibleVertexAttributeLocations(l.vao,t),V.drawElements(d,x,l.vao.indexBuffer.indexType,0),T.renderOrder=Te,Te++,me+=x/3,j(T)}}}V.bindVAO(null),e.stencilRenderingHelper&&e.stencilRenderingHelper.disableStencilRead()};var _e=function(e,t,i){var r=Q[i];r||(r=F.aquire(i).getGLTexture(),O(r),Q[i]=r),e.setUniform2fv("overlayTexOffset",t.overlayTexOffset),e.setUniform2fv("overlayTexScale",t.overlayTexScale),e.setUniform1f("overlayOpacity",t.overlayOpacity),V.bindTexture(r,5)},Ae=P.create(),Oe=P.create(),Ie=P.create(),Pe=this.clippingExtent;this.intersect=function(e,i,r){if(q&&(!e.isSelection||!this.isTransparent())&&e.enableTerrain){P.subtract(r,i,Ae);var n=e.getMinResult(),a=e.getMaxResult();$.reset(q);for(var s={};!$.done;){var l=$.next();if(null!==l.renderData){if(e.enableInvisibleTerrain){if(!l.visible&&Pe&&!l.intersectsExtent(Pe))continue}else if(!l.visible)continue;var o=l.renderData.geometryInfo;k.getData().getAttribute("terrain").data=o.vertexAttributes,k.getData()._indices.terrain=o.indices;var d=o.boundingBox;P.set3(d[0],d[1],d[2],k.boundingInfo.bbMin),P.set3(d[3],d[4],d[5],k.boundingInfo.bbMax),k.boundingInfo.indices=o.indices,k.boundingInfo.positionData=k.getData().getAttribute("terrain");var h=l.renderData.localOrigin;P.subtract(i,h,Oe),P.subtract(r,h,Ie),f.intersectTriangleGeometry(k,s,void 0,e,Oe,Ie,function(i,r,s){if((re||!(3*s>=l.renderData.geometryInfo.numWithoutSkirtIndices))&&i>=0&&(e.enableBackfacesTerrain||P.dot(r,Ae)<0)){var o;(void 0===n.dist||i<n.dist)&&(o=t.lij2str(l.lij[0],l.lij[1],l.lij[2]),n.set(void 0,o,i,r,void 0),n.setIntersector("terrain")),(void 0===a.dist||i>a.dist)&&(o=t.lij2str(l.lij[0],l.lij[1],l.lij[2]),a.set(void 0,o,i,r,void 0),a.setIntersector("terrain"))}})}}}},this._updateTileGeometryBuffers=function(e){var t=e.renderData,i=t.geometryInfo.vertexAttributes,r=t.geometryInfo.indices;t.vao=new D(V,y.Default3D,{geometry:E.Pos3Tex},{geometry:x.createVertex(V,W.STATIC_DRAW,i)},x.createIndex(V,W.STATIC_DRAW,r)),this.setNeedsRender()},this._releaseTileGeometry=function(e){var t=e.renderData;t.vao.dispose(!0),t.vao=null,r.releaseGeometry(t.geometryInfo),this.setNeedsRender()}},j=new p({terrain:{data:null,size:5}},{terrain:null}),k=new v(j,"tmpTerrainGeometry",{bbMin:P.create(),bbMax:P.create(),indices:null,positionData:null,getBBMin:function(){return this.bbMin},getBBMax:function(){return this.bbMax},getPrimitiveIndices:function(){},getChildren:function(){},getIndices:function(){return this.indices},getPosition:function(){return this.positionData}});return C.TileRenderData=n,C});