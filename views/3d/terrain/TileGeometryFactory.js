// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../support/aaBoundingBox","../support/ArrayPool","../support/earthUtils","../support/mathUtils","./TerrainConst"],function(r,a,e,t,n,i,o){function u(r){d.put(r.vertexAttributes),r.vertexAttributes=null,r.indices=null}function v(r,a,e){for(var t=0;t<e.length;t++){var n=e[t];if(n){var u=n.safeWidth,v=n.width,s=n.pixelData,f=i.clamp(n.dy*(n.y1-a),0,u),l=i.clamp(n.dx*(r-n.x0),0,u),c=Math.floor(f),A=Math.floor(l),I=c*v+A,d=I+v,T=s[I],h=s[d],E=s[I+1],S=s[d+1];if(T+h+E+S<.5*o.ELEVATION_NODATA_VALUE){f-=c,l-=A;var p=T+(E-T)*l;return p+(h+(S-h)*l-p)*f}}}return null}function s(r,a,t,o,u,s,f,c,T){var h=t[0],M=t[1],_=t[2],y=t[3],x=Math.max(.9,1-.5*(_-h)),N=r-1,w=r-1,L=r*r,b=2*N+2*w,g=d.get(5*(L+b)),O=T.boundingBox;e.set(O,e.NEGATIVE_INFINITY);for(var P=a[2]-a[0],V=a[3]-a[1],G=_-h,R=s[0],U=s[1],k=s[2],B=0;B<=N;B++){var X=B/N,F=h+X*G;E[B]=Math.sin(F),S[B]=Math.cos(F),p[B]=X,m[B]=a[0]+X*P}for(var D=0,W=0;W<=w;W++){var Y=W/w,j=i.lerp(M,y,Y),q=Math.cos(j),C=Math.sin(j),z=void 0;o?(z=n.earthRadius/2*Math.log((1+C)/(1-C)),Y=(z-a[1])/V):z=180*j/Math.PI;for(var B=0;B<=N;B++){var X=p[B],H=E[B],J=S[B],K=n.earthRadius;u&&(K+=v(m[B],z,u)||0);var Q=J*q*K,Z=H*q*K,$=C*K,rr=Q-R,ar=Z-U,er=$-k;A(rr,ar,er,O);var tr=5*D;g[tr+0]=rr,g[tr+1]=ar,g[tr+2]=er,g[tr+3]=X,g[tr+4]=Y;var nr=-1;if(0===W&&(nr=L+B),B===N&&(nr=L+N+W),W===w&&(nr=L+N+w+(N-B)),0===B&&W>0&&(nr=L+2*N+w+(w-W)),nr>-1){var ir=Q*x-R,or=Z*x-U,ur=$*x-k;A(ir,or,ur,O),tr=5*nr,g[tr+0]=ir,g[tr+1]=or,g[tr+2]=ur,g[tr+3]=X,g[tr+4]=Y}++D}}if(o){var vr=!!(1&f),sr=!!(2&f);vr&&I(-1,N,g,L,O),sr&&I(1,N,g,L+N+w,O)}T.numVertsPerRow=r,T.vertexAttributes=g,l(T,r,o?f:0,c)}function f(r,a,t,n,i,o,u){var s=a[0],f=a[1],c=a[2]-s,I=a[3]-f,T=.1*c,h=r-1,E=r-1,S=r*r,p=2*h+2*E,m=d.get(5*(S+p)),M=u.boundingBox;e.set(M,e.NEGATIVE_INFINITY);for(var _=0,y=0;y<=E;y++){var x=y/E,N=f+x*I;o&&(N<o[1]?(N=o[1],x=(N-f)/I):N>o[3]&&(N=o[3],x=(N-f)/I));for(var w=0;w<=h;w++){var L=w/h,b=s+L*c;o&&(b<o[0]?(b=o[0],L=(b-s)/c):b>o[2]&&(b=o[2],L=(b-s)/c));var g=t?v(b,N,t)||0:0,O=b-n[0],P=N-n[1],V=g-n[2];A(O,P,V,M),m[5*_]=O,m[5*_+1]=P,m[5*_+2]=V,m[5*_+3]=L,m[5*_+4]=x;var G=-1;0===y&&(G=S+w),w===h&&(G=S+h+y),y===E&&(G=S+h+E+(h-w)),0===w&&y>0&&(G=S+2*h+E+(E-y)),G>-1&&(m[5*G]=O,m[5*G+1]=P,m[5*G+2]=V-T,m[5*G+3]=L,m[5*G+4]=x,A(O,P,V-T,M)),++_}}u.numVertsPerRow=r,u.vertexAttributes=m,l(u,r,0,i)}function l(r,a,e,t){var n=(2&e)>0,i=a+(t?1024:0)+(n?2048:0),o=h[i];o||(o=c(a,n,t),h[i]=o),r.indices=o.values,r.numSurfaceIndices=o.numSurfaceIndices,r.numSkirtIndices=o.numSkirtIndices,r.numWithoutSkirtIndices=r.numSurfaceIndices+(e?6*(a-1)*(t?2:1):0)}function c(r,a,e){var t=r-1,n=r-1,i=r*r,o=2*t+2*n,u=t*n*2*3,v=6*o,s=6*(2*t+n-1);e&&(u*=2,v*=2,s*=2);for(var f,l,c,A,I=i+o>T?new Uint32Array(u+v):new Uint16Array(u+v),d=0,h=0,E=u,S=0,p=0;p<=n;p++){a&&(S=0===p?s:p===n?-s:0),E+=S;for(var m=0;m<=t;m++){var M=-1,_=-1;if(0===p&&(M=i+m,m!==t&&(_=d+1)),m===t&&(M=i+t+p,p<n&&(_=d+t+1)),p===n&&(M=i+t+n+(t-m),m>0&&(_=d-1)),0===m&&p>0&&(M=i+2*t+n+(n-p),_=d-(t+1)),M>-1){var y=0===m&&1===p?i:M+1;_>-1&&(f=d,l=M,c=y,A=_,e?(I[E+0]=f,I[E+1]=l,I[E+2]=l,I[E+3]=c,I[E+4]=c,I[E+5]=f,I[E+6]=c,I[E+7]=A,I[E+8]=A,I[E+9]=f,I[E+10]=f,I[E+11]=c,E+=12):(I[E+0]=f,I[E+1]=l,I[E+2]=c,I[E+3]=c,I[E+4]=A,I[E+5]=f,E+=6))}++d,m<t&&p<n&&(f=p*(t+1)+m,l=f+1,c=l+(t+1),A=c-1,e?(I[h+0]=f,I[h+1]=l,I[h+2]=l,I[h+3]=c,I[h+4]=c,I[h+5]=f,I[h+6]=c,I[h+7]=A,I[h+8]=A,I[h+9]=f,I[h+10]=f,I[h+11]=c,h+=12):(I[h+0]=f,I[h+1]=l,I[h+2]=c,I[h+3]=c,I[h+4]=A,I[h+5]=f,h+=6))}E-=S}return{values:I,numSurfaceIndices:u,numSkirtIndices:v}}function A(r,a,e,t){r<t[0]&&(t[0]=r),r>t[3]&&(t[3]=r),a<t[1]&&(t[1]=a),a>t[4]&&(t[4]=a),e<t[2]&&(t[2]=e),e>t[5]&&(t[5]=e)}function I(r,a,e,t,i){for(var o=r*n.earthRadius,u=0;u<=a;u++)e[5*t]=0,e[5*t+1]=0,e[5*t+2]=o,A(0,0,o,i),t++}Object.defineProperty(a,"__esModule",{value:!0});var d=new t.ArrayPool(Float32Array);a.releaseGeometry=u,a.elevationSampler=v;var T=65536;a.createSphericalGlobeTile=s,a.createPlanarGlobeTile=f;var h=[],E=new Array(o.MAX_TILE_TESSELATION+1),S=new Array(o.MAX_TILE_TESSELATION+1),p=new Array(o.MAX_TILE_TESSELATION+1),m=new Array(o.MAX_TILE_TESSELATION+1)});