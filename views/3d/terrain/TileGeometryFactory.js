// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["../webgl-engine/lib/Geometry","../webgl-engine/lib/GeometryData","../lib/glMatrix","../support/earthUtils","../support/mathUtils","./TerrainConst"],function(t,e,r,n,a,i){function u(t,e,r,n,a){t<n[0]&&(n[0]=t),t>a[0]&&(a[0]=t),e<n[1]&&(n[1]=e),e>a[1]&&(a[1]=e),r<n[2]&&(n[2]=r),r>a[2]&&(a[2]=r)}function s(t,e,r){for(var n=0;n<r.length;n++){var u=r[n];if(u){var s=u.safeWidth,o=u.width,c=u.pixelData,l=a.clamp(u.dy*(u.y1-e),0,s),v=a.clamp(u.dx*(t-u.x0),0,s),f=Math.floor(l),g=Math.floor(v),d=f*o+g,h=d+o,A=c[d],m=c[h],y=c[d+1],I=c[h+1];if(A+m+y+I<.5*i.ELEVATION_NODATA_VALUE){l-=f,v-=g;var M=A+(y-A)*v,S=m+(I-m)*v;return M+(S-M)*l}}}return null}var o=n.earthRadius,c=r.vec3d,l=a.lerp,v=function(){var t,e,r,n=c.create(),a=c.create(),i=c.create();this.init=function(u,s){e=u,r=s,c.subtract(i,a,n),t=.5*c.length(n),c.lerp(a,i,.5,n)},this.getCenter=function(){return n},this.getBSRadius=function(){return t},this.getBBMin=function(){return a},this.getBBMax=function(){return i},this.getPosition=function(){return e},this.getIndices=function(){return r},this.getPrimitiveIndices=function(){},this.getChildren=function(){}},f=function(t,e,r,n){for(var a=t*o,i=0;e>=i;i++)r[5*n]=0,r[5*n+1]=0,r[5*n+2]=a,n++},g=50,d=50,h=function(){var r=new Array(g),n=0,a={};this.get=function(u){var s=a[u];s||(s={ptr:0,data:new Array(d)},a[u]=s);var o;if(s.ptr>0?(i.vertexArrayHits++,o=s.data[--s.ptr],s.data[s.ptr]=null):(i.vertexArrayMisses++,o=new Float32Array(u)),n>0){i.geometryHits++;var c=r[--n];return r[n]=null,c.getData().getVertexAttr().terrain.data=o,c}i.geometryMisses++;var l={terrain:null},f={};f.terrain={size:5,data:o};var g=new v;return new t(new e(f,l),"tile",g)},this.put=function(t){var e=t.getData(),i=e.getVertexAttr(),u=i.terrain.data,s=a[u.length];s.ptr<d&&(s.data[s.ptr++]=u),i.terrain.data=null,e.indices.terrain=null,g>n&&(r[n++]=t)};var i={geometryHits:0,geometryMisses:0,vertexArrayHits:0,vertexArrayMisses:0};this.stats=i,this._pools={geometry:r,vertexArray:a}},A=new h,m=[],y=new Array(i.MAX_TILE_TESSELATION+1),I=new Array(i.MAX_TILE_TESSELATION+1),M=new Array(i.MAX_TILE_TESSELATION+1),S=new Array(i.MAX_TILE_TESSELATION+1),p=65536,w=function(t,e,r,n,a,i,v,g,d){var h=o,m=r[0],p=r[1],w=r[2],x=r[3],T=Math.max(.9,1-.5*(w-m)),B=t-1,_=t-1,b=t*t,L=2*B+2*_,D=A.get(5*(b+L)),O=D.getData().getVertexAttr().terrain.data,V=e[2]-e[0],N=e[3]-e[1],P=w-m,k=i[0],G=i[1],U=i[2],H=D.getBoundingInfo(),X=H.getBBMin(),C=H.getBBMax();c.set3(1e7,1e7,1e7,X),c.set3(-1e7,-1e7,-1e7,C);var R,W;for(R=0;B>=R;R++){var j=R/B,z=m+j*P;y[R]=Math.sin(z),I[R]=Math.cos(z),M[R]=j,S[R]=e[0]+j*V}var F=0;for(W=0;_>=W;W++){var q,J=W/_,K=l(p,x,J),Q=Math.cos(K),Y=Math.sin(K);for(n?(q=o/2*Math.log((1+Y)/(1-Y)),J=(q-e[1])/N):q=180*K/Math.PI,R=0;B>=R;R++){j=M[R];var Z=y[R],$=I[R],tt=h;a&&(tt+=s(S[R],q,a)||0);var et=$*Q*tt,rt=Z*Q*tt,nt=Y*tt,at=et-k,it=rt-G,ut=nt-U;u(at,it,ut,X,C);var st=5*F;O[st+0]=at,O[st+1]=it,O[st+2]=ut,O[st+3]=j,O[st+4]=J;var ot=-1;if(0===W&&(ot=b+R),R===B&&(ot=b+B+W),W===_&&(ot=b+B+_+(B-R)),0===R&&W>0&&(ot=b+2*B+_+(_-W)),ot>-1){var ct=et*T-k,lt=rt*T-G,vt=nt*T-U;u(ct,lt,vt,X,C),st=5*ot,O[st+0]=ct,O[st+1]=lt,O[st+2]=vt,O[st+3]=j,O[st+4]=J}++F}}if(n){var ft=!!(1&v),gt=!!(2&v);ft&&f(-1,B,O,b),gt&&f(1,B,O,b+B+_)}return E(D,t,n?v:0,g,d)},x=function(t,e,r,n,a,i,o){var l,v,f=e[0],g=e[1],d=e[2]-f,h=e[3]-g,m=.1*d,y=t-1,I=t-1,M=t*t,S=2*y+2*I,p=A.get(5*(M+S)),w=p.getData().getVertexAttr().terrain.data,x=0,T=p.getBoundingInfo(),B=T.getBBMin(),_=T.getBBMax();for(c.set3(1e7,1e7,1e7,B),c.set3(-1e7,-1e7,-1e7,_),v=0;I>=v;v++){var b=v/I,L=g+b*h;for(i&&(L<i[1]?(L=i[1],b=(L-g)/h):L>i[3]&&(L=i[3],b=(L-g)/h)),l=0;y>=l;l++){var D=l/y,O=f+D*d;i&&(O<i[0]?(O=i[0],D=(O-f)/d):O>i[2]&&(O=i[2],D=(O-f)/d));var V=r?s(O,L,r)||0:0,N=O-n[0],P=L-n[1],k=V-n[2];u(N,P,k,B,_),w[5*x]=N,w[5*x+1]=P,w[5*x+2]=k,w[5*x+3]=D,w[5*x+4]=b;var G=-1;0===v&&(G=M+l),l===y&&(G=M+y+v),v===I&&(G=M+y+I+(y-l)),0===l&&v>0&&(G=M+2*y+I+(I-v)),G>-1&&(w[5*G]=N,w[5*G+1]=P,w[5*G+2]=k-m,w[5*G+3]=D,w[5*G+4]=b,u(N,P,k-m,B,_)),++x}}return E(p,t,0,a,o)},T={values:null,numSurfaceIndices:0,numSkirtIndices:0},B=function(t,e,r){return r||(t.values=e.values),t.numSurfaceIndices=e.numSurfaceIndices,t.numSkirtIndices=e.numSkirtIndices,t},E=function(t,e,r,n,a){var i=_(e,r,n,T),u=t.getData(),s=u.getAttribute("terrain");return u.indices.terrain=i.values,t.getBoundingInfo().init(s,i.values),a||(a={}),a.geometry=t,a.numWithoutSkirtIndices=i.numSurfaceIndices+(r?6*(e-1)*(n?2:1):0),a.numVertsPerRow=e,B(a,i,!0)},_=function(t,e,r,n){var a=2&e,i=t+(r?1024:0)+(a?2048:0),u=m[i];if(n||(n={}),u)return B(n,u),n;var s,o=t-1,c=t-1,l=t*t,v=2*o+2*c,f=o*c*2*3,g=6*v,d=6*(2*o+c-1);r&&(f*=2,g*=2,d*=2),s=l+v>p?new Uint32Array(f+g):new Uint16Array(f+g);for(var h,A,y,I,M=0,S=0,w=f,x=0,T=0;c>=T;T++){a&&(x=0===T?d:T===c?-d:0),w+=x;for(var E=0;o>=E;E++){var _=-1,b=-1;if(0===T&&(_=l+E,E!==o&&(b=M+1)),E===o&&(_=l+o+T,c>T&&(b=M+o+1)),T===c&&(_=l+o+c+(o-E),E>0&&(b=M-1)),0===E&&T>0&&(_=l+2*o+c+(c-T),b=M-(o+1)),_>-1){var L=0===E&&1===T?l:_+1;b>-1&&(h=M,A=_,y=L,I=b,r?(s[w+0]=h,s[w+1]=A,s[w+2]=A,s[w+3]=y,s[w+4]=y,s[w+5]=h,s[w+6]=y,s[w+7]=I,s[w+8]=I,s[w+9]=h,s[w+10]=h,s[w+11]=y,w+=12):(s[w+0]=h,s[w+1]=A,s[w+2]=y,s[w+3]=y,s[w+4]=I,s[w+5]=h,w+=6))}++M,o>E&&c>T&&(h=T*(o+1)+E,A=h+1,y=A+(o+1),I=y-1,r?(s[S+0]=h,s[S+1]=A,s[S+2]=A,s[S+3]=y,s[S+4]=y,s[S+5]=h,s[S+6]=y,s[S+7]=I,s[S+8]=I,s[S+9]=h,s[S+10]=h,s[S+11]=y,S+=12):(s[S+0]=h,s[S+1]=A,s[S+2]=y,s[S+3]=y,s[S+4]=I,s[S+5]=h,S+=6))}w-=x}return n.values=s,n.numSurfaceIndices=f,n.numSkirtIndices=g,m[i]=B({},n),n};return{createPlanarGlobeTile:x,createSphericalGlobeTile:w,releaseGeometry:A.put,elevationSampler:s,_geometryObjectPool:A}});