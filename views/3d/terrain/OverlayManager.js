// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/on","../../../Graphic","../../../core/Accessor","../../../core/Handles","../../../core/Logger","../../../core/accessorSupport/decorators","../../../geometry/Point","../../../symbols/SimpleMarkerSymbol","../lib/glMatrix","../state/utils/viewUtils","../support/aaBoundingRect","../support/debugFlags","../support/debugFlags","../support/earthUtils","../support/mathUtils","../support/projectionUtils","../webgl-engine/Stage","../webgl-engine/lib/Selector","../webgl-engine/lib/Texture"],function(e,t,i,r,a,n,s,o,l,c,h,v,d,y,p,u,_,g,f,w,x,S,O){function T(e,t){for(var i=u.TESTS_DISABLE_UPDATE_THROTTLE_THRESHOLDS?0:M.EXTENTS_DIFFER_THRESHOLD*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]),r=0;r<4;r++)if(Math.abs(t[r]-e[r])>i)return!0;return!1}var m,E=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],R=l.getLogger("esri.views.3d.OverlayManager"),M=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._handles=new o,t._overlaySR=null,t._renderSR=null,t._overlaySREqualsRenderSR=!0,t._connectedLayers={},t._scale=0,t._dirty=!1,t._isSpherical=!1,t._latestOriginId=0,t.opacity=0,t}return i(t,e),Object.defineProperty(t.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._stage=this.view._stage,this._renderer=this._stage.getTextureGraphicsRenderer(),this._renderer.onHasHighlightsChanged=function(){return e.onHasHighlightsChanged()},this._initialEmptyTexture=O.createEmpty("initialOverlayTexture"),this.groundSelector=new S(this.view.viewingMode),this.groundSelector.enableBackfacesTerrain=!0,this.groundSelector.enableInvisibleTerrain=!0,this.groundSelector.enableHUDSelection=!1,this._stage.add(x.ModelContentType.TEXTURE,this._initialEmptyTexture),this._handles.add(this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location"],function(){return e.setOverlayDirty()}))},t.prototype.destroy=function(){for(var e in this._connectedLayers)this.unregisterLayerView(this._connectedLayers[e].layerView);this._disposeOverlays(),this._stage.remove(x.ModelContentType.TEXTURE,this._initialEmptyTexture.id),this._handles&&(this._handles.destroy(),this._handles=null)},t.prototype.onHasHighlightsChanged=function(){this.setOverlayDirty(),this.notifyChange("hasHighlights")},t.prototype.hasOverlays=function(){return!!this._overlays},t.prototype.setSpatialReference=function(e,t){this._overlaySR=e,e?(this._renderSR=this.view.renderSpatialReference,this._overlaySREqualsRenderSR=this._overlaySR.equals(this._renderSR),this._isSpherical=t,this._longitudeCyclical=t?e.isWebMercator?new f.Cyclical(-20037508.342788905,20037508.342788905):new f.Cyclical(-180,180):null):(this._disposeOverlays(),this._longitudeCyclical=null)},t.prototype.registerLayerView=function(e){var t=this,i=e.layer.uid;if(this._connectedLayers[i])return void R.warn("[OverlayManager#registerLayerView]: Layer "+i+" is already connected");var r=a(e,"draped-data-change",function(){return t.setOverlayDirty()});if(this._connectedLayers[i]={eventHandles:[r],layerView:e},e.setDrapingExtent&&this._overlays)for(var n=0;n<this._overlays.length;n++){var s=this._overlays[n];e.setDrapingExtent(n,s.extent,this._overlaySR,2048,s.renderLocalOrigin)}this.setOverlayDirty(),this._setLayerViewOverlayUpdating(e,this._dirty)},t.prototype.unregisterLayerView=function(e){for(var t in this._connectedLayers){var i=this._connectedLayers[t];if(i.layerView===e){if(i.eventHandles)for(var r=0;r<i.eventHandles.length;r++)i.eventHandles[r].remove();delete this._connectedLayers[t],this.setOverlayDirty(),e.destroyed||(e._overlayUpdating=!1,e._evaluateUpdatingState())}}},t.prototype.setOverlayDirty=function(){this._dirty||(this._setOverlayUpdating(!0),this._dirty=!0)},t.prototype._setLayerViewOverlayUpdating=function(e,t){(!t||!e.suspended&&e.hasDraped)&&(e._overlayUpdating=t,e._evaluateUpdatingState())},t.prototype._setOverlayUpdating=function(e){for(var t in this._connectedLayers){var i=this._connectedLayers[t].layerView;this._setLayerViewOverlayUpdating(i,e)}var r=this.view._graphicsView;r&&(r._overlayUpdating=e,r._evaluateUpdatingState())},t.prototype.updateOverlay=function(){if(this._overlaySR){var e=this._computeOverlayExtents();if(e){this._overlays||this._initOverlays();for(var t=0;t<this._overlays.length;t++){var i=this._overlays[t];if(T(e[t],i.extent)){d.vec4d.set(e[t],i.extent),i.renderLocalOrigin={id:"OV_"+this._latestOriginId++,vec3:p.center(i.extent,d.vec3d.create())};for(var r in this._connectedLayers){var a=this._connectedLayers[r].layerView;a.setDrapingExtent&&a.setDrapingExtent(t,e[t],this._overlaySR,2048,i.renderLocalOrigin)}}}this._setOverlayUpdating(!1),this._drawOverlays(),this.terrainSurface._updateTileOverlayParams(),this._dirty=!1}}},t.prototype.overlaysNeedUpdate=function(){return this._dirty&&!!this._overlaySR},t.prototype.updateOpacity=function(e){var t=1;if(this._overlays){var i=this._scale,r=this.view.renderCoordsHelper.getAltitude(e);3.5*r<i&&(t=(r-i/10)/(i/3.5-i/10),t=Math.sqrt(f.clamp(t,0,1)))}return t},t.prototype.setOverlayParamsOfTile=function(e,t,i){var r=e.extent,a=this._overlayForTile(e);if(!a)return t.overlayTexId=null,void(t.highlightOverlayTexId=null);var n=a.extent;t.overlayTexScale[0]=(r[2]-r[0])/(n[2]-n[0]),t.overlayTexScale[1]=(r[3]-r[1])/(n[3]-n[1]);var s=r[0];if(this._longitudeCyclical){s=this._longitudeCyclical.minimalMonotonic(n[0],s);var o=this._longitudeCyclical.minimalMonotonic(n[0],r[2]);s>o&&(s=o-(r[2]-r[0]))}d.vec2d.set2((s-n[0])/(n[2]-n[0]),(r[1]-n[1])/(n[3]-n[1]),t.overlayTexOffset),a.valid?t.overlayTexId=a.texture.id:t.overlayTexId=this._initialEmptyTexture.id,a.highlightValid?t.highlightOverlayTexId=a.highlightTexture.id:t.highlightOverlayTexId=this._initialEmptyTexture.id,t.overlayOpacity=void 0!==i?i:1},t.prototype.overlayPixelSizeInMapUnits=function(e){var t;return this._overlays&&(this._overlays[0]&&this._pointIsInExtent(e,this._overlays[0].extent)?t=this._overlays[0].extent:this._overlays[1]&&(t=this._overlays[1].extent)),t?(t[2]-t[0])/2048:0},t.prototype._overlayForTile=function(e){var t=e.extent,i=e.clippingArea?p.intersection(t,e.clippingArea,H):t;return this._rectInsideRect(i,this._overlays[0].extent)?this._overlays[0]:this._rectanglesOverlap(i,this._overlays[1].extent)?this._overlays[1]:null},t.prototype._createEmptyOverlay=function(){var e=new O(null,"overlay",{wrapClamp:!0,mipmap:!0});this._stage.add(x.ModelContentType.TEXTURE,e);var t=new O(null,"highlightOverlay",{wrapClamp:!0,mipmap:!0});return this._stage.add(x.ModelContentType.TEXTURE,t),{extent:d.vec4d.create(),texture:e,valid:!1,highlightTexture:t,highlightValid:!1,renderLocalOrigin:{id:"O",vec3:[0,0,0]}}},t.prototype._initOverlays=function(){this._overlays=[this._createEmptyOverlay(),this._createEmptyOverlay()]},t.prototype._disposeOverlays=function(){if(this._overlays){var e=this._stage;this._overlays.forEach(function(t){e.remove(x.ModelContentType.TEXTURE,t.texture.id),e.remove(x.ModelContentType.TEXTURE,t.highlightTexture.id)}),this._overlays=null}},t.prototype._intersectGroundFromView=function(e,t,i,r){var a=d.vec3d.createFrom(t*this.view.width,i*this.view.height,1);d.vec3d.unproject(a,e.viewMatrix,e.projectionMatrix,e.fullViewport,a);var n=d.vec3d.createFrom(t*this.view.width,i*this.view.height,0);return d.vec3d.unproject(n,e.viewMatrix,e.projectionMatrix,e.fullViewport,n),this.groundSelector.init([],n,a,null,e,null,!1),this.view.basemapTerrain.intersect(this.groundSelector,n,a),this.groundSelector.minResult.getIntersectionPoint(r)},t.prototype._findHorizonBasedPointOfInterest=function(e,t,i){var r=.5;if("global"===this.view.viewingMode){var a=d.vec3d.create(e.eye);d.vec3d.normalize(a),d.vec3d.negate(a);var n=d.vec3d.length(t),s=Math.asin(n/d.vec3d.length(e.eye)),o=Math.acos(d.vec3d.dot(e.viewForward,a)),l=s-(o-.5*e.fovY),c=f.clamp(l/e.fovY,0,1),h=-s-(o-.5*e.fovY),v=f.clamp(h/e.fovY,0,1);r=1===c&&0===v?.5:v+.55*(c-v)}else{var y=.5*Math.PI-Math.acos(-e.viewForward[2]),p=Math.tan(y),u=d.mat4d.multiplyVec4(e.projectionMatrix,d.vec4d.createFrom(0,p,1,0))[1],_=f.clamp(.5+.5*u,0,1);r=1===_||0===_?.5:e.eye[2]>0?.55*_:1-.55*(1-_)}return!!this._intersectGroundFromView(e,.5,r,i)},t.prototype._computeOverlayExtents=function(){var e=this.view.state.camera,t=this.terrainSurface.extent,i=d.vec3d.create(),r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;this._findHorizonBasedPointOfInterest(e,this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i)||d.vec3d.set(r,i),this._scale=this.view.renderCoordsHelper.getAltitude(e.eye);var a=d.vec3d.dist(e.eye,i),s=y.viewAngle(this.view.renderCoordsHelper,r,e.eye),o=Math.PI/2-Math.abs(s-Math.PI/2);if(_.OVERLAY_SHOW_CENTER){var l=new v({color:[255,0,0],outline:{color:[255,255,255],width:2}}),c=new h;w.vectorToPoint(i,this._renderSR,c,this._overlaySR);var u=new n({geometry:c,symbol:l});void 0!==m&&this.view.graphics.remove(m),this.view.graphics.add(u),m=u}this._overlaySREqualsRenderSR||w.vectorToVector(i,this._renderSR,i,this._overlaySR);var x=1024*e.perPixelRatio*a*2,S=!1,O=1/0;this._isSpherical&&(this._overlaySR.isWebMercator?(x/=Math.cos(w.webMercator.y2lat(i[1])),O=this.terrainSurface.extent[3],O*=.999):(S=!0,x/=g.metersPerDegree,O=90),x>=O&&(x=O,i[1]=0,this._overlaySR.isWebMercator&&(i[0]=0)));var T=1;S&&(T=1/Math.max(.2,Math.cos(Math.abs(f.deg2rad(i[1])))),x*T>180&&(T=180/x));var R=x*T,M=U[0];M[0]=i[0]-R,M[1]=i[1]-x,M[2]=i[0]+R,M[3]=i[1]+x,this._isSpherical&&this._shiftExtentToFitBounds(M,1/0,O);var C=U[1];if(d.vec4d.set(M,C),6*R>t[2]-t[0])d.vec4d.set(t,C);else if(o<=.25*Math.PI)C[0]-=R,C[1]-=x,C[2]+=R,C[3]+=x;else{w.vectorToVector(e.eye,this._renderSR,b,this._overlaySR),d.vec2d.subtract(i,b,H);var L=-Math.atan2(H[1],H[0])+.125*Math.PI;L<0&&(L+=2*Math.PI);var I=Math.floor(L/(.25*Math.PI));d.vec4d.scale(E[I],2*x,H),H[0]*=T,H[2]*=T,d.vec4d.add(C,H,C)}if(this._isSpherical&&(C[0]=this._longitudeCyclical.clamp(C[0]),C[2]=this._longitudeCyclical.clamp(C[2]),C[1]=Math.max(C[1],-O),C[3]=Math.min(C[3],O)),!this._isSpherical&&t){var F=p.intersection(M,t,V),P=p.intersection(C,t,D);p.contains(F,P)&&(C[2]=C[0],C[3]=C[1])}return this.opacity=1,U},t.prototype._drawOverlays=function(){for(var e=this._overlays[0].extent[2]-this._overlays[0].extent[0],t=this._renderer,i=0;i<this._overlays.length;i++){var r=this._overlays[i].extent,a=!!this._longitudeCyclical&&r[2]>this._longitudeCyclical.max,n=!!this._longitudeCyclical&&r[0]<this._longitudeCyclical.min;if(a||n){C.views=I;var s=void 0;s=a?this._longitudeCyclical.max-r[0]:this._longitudeCyclical.min-r[0];var o=Math.round(s/(r[2]-r[0])*2048),l=C.views[0];d.vec4d.set4(0,0,o,2048,l.viewport),d.vec4d.set4(r[0],r[1],this._longitudeCyclical.max,r[3],l.extent),a||(l.extent[0]+=this._longitudeCyclical.range);var c=C.views[1];d.vec4d.set4(o,0,2048-o,2048,c.viewport),d.vec4d.set4(this._longitudeCyclical.min,r[1],r[2],r[3],c.extent),a&&(c.extent[2]-=this._longitudeCyclical.range)}else C.views=L,d.vec4d.set(r,C.views[0].extent),d.vec4d.set4(0,0,2048,2048,C.views[0].viewport);C.width=2048,C.height=2048,C.pixelRatio=e/(r[2]-r[0]),this._overlays[i].valid=t.draw(this._overlays[i].texture,C),this._overlays[i].highlightValid=t.drawHighlights(this._overlays[i].highlightTexture,C)}},t.prototype._rectanglesOverlap=function(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):p.intersects(e,t)},t.prototype._rectInsideRect=function(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:p.contains(t,e)},t.prototype._pointIsInExtent=function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];var i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]},t.prototype._shiftExtentToFitBounds=function(e,t,i){var r=0,a=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?a=e[1]+i:e[3]>i&&(a=i-e[3]),p.offset(e,r,a)},t.EXTENTS_DIFFER_THRESHOLD=1e-5,r([c.property()],t.prototype,"view",void 0),r([c.property()],t.prototype,"terrainSurface",void 0),r([c.property({type:Boolean})],t.prototype,"hasHighlights",null),t=r([c.subclass("esri.views.3d.terrain.OverlayManager")],t)}(c.declared(s)),C={width:0,height:0,pixelRatio:0,views:null},L=[{viewport:d.vec4d.create(),extent:d.vec4d.create()}],I=[L[0],{viewport:d.vec4d.create(),extent:d.vec4d.create()}],H=d.vec4d.create(),b=d.vec3d.create(),U=[d.vec4d.create(),d.vec4d.create()],V=p.create(),D=p.create();return M});