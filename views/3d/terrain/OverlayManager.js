// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/on","../../../core/Logger","../../../core/Accessor","../../../core/HandleRegistry","../../../core/accessorSupport/decorators","../../../geometry/Point","../lib/glMatrix","../support/mathUtils","../support/earthUtils","../support/projectionUtils","../support/aaBoundingRect","../webgl-engine/Stage","../webgl-engine/lib/Texture","../webgl-engine/lib/Selector","../support/debugFlags","../../../symbols/SimpleMarkerSymbol","../../../Graphic"],function(e,t,i,r,a,n,s,o,l,h,c,y,v,d,p,u,_,g,f,w,x){function m(e,t){for(var i=F.EXTENTS_DIFFER_THRESHOLD*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]),r=0;4>r;r++)if(Math.abs(t[r]-e[r])>i)return!0;return!1}var S,O=c.vec2d,T=c.vec3d,R=c.vec4d,M=2048,C=3.5,E=10,I={width:0,height:0,pixelRatio:0,views:null},H=[{viewport:R.create(),extent:R.create()}],b=[H[0],{viewport:R.create(),extent:R.create()}],L=R.create(),V=T.create(),U=[R.create(),R.create()],P=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],D=n.getLogger("esri.views.3d.OverlayManager"),F=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._handles=new o,t._overlaySR=null,t._renderSR=null,t._overlaySREqualsRenderSR=!0,t._connectedLayers={},t._scale=0,t._dirty=!1,t._isSpherical=!1,t._latestOriginId=0,t.opacity=0,t}return i(t,e),Object.defineProperty(t.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._stage=this.view._stage,this._renderer=this._stage.getTextureGraphicsRenderer(),this._renderer.onHasHighlightsChanged=function(){return e.onHasHighlightsChanged()},this._initialEmptyTexture=new _(new Uint8Array([0,0,0,0]),"overlayEmpty",{width:1,height:1,wrapClamp:!0}),this.groundSelector=new g(this.view.viewingMode),this.groundSelector.enableBackfacesTerrain=!0,this.groundSelector.enableInvisibleTerrain=!0,this.groundSelector.enableHUDSelection=!1,this._stage.add(u.ModelContentType.TEXTURE,this._initialEmptyTexture),this._handles.add(this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location"],function(){return e.setOverlayDirty()}))},t.prototype.destroy=function(){for(var e in this._connectedLayers)this.unregisterLayerView(this._connectedLayers[e].layerView);this._disposeOverlays(),this._stage.remove(u.ModelContentType.TEXTURE,this._initialEmptyTexture.getId()),this._handles&&(this._handles.destroy(),this._handles=null)},t.prototype.onHasHighlightsChanged=function(){this.setOverlayDirty(),this.notifyChange("hasHighlights")},t.prototype.hasOverlays=function(){return!!this._overlays},t.prototype.setSpatialReference=function(e,t){this._overlaySR=e,e?(this._renderSR=this.view.renderSpatialReference,this._overlaySREqualsRenderSR=this._overlaySR.equals(this._renderSR),this._isSpherical=t,t?this._longitudeCyclical=e.isWebMercator?new y.Cyclical(-20037508.342788905,20037508.342788905):new y.Cyclical(-180,180):this._longitudeCyclical=null):(this._disposeOverlays(),this._longitudeCyclical=null)},t.prototype.registerLayerView=function(e){var t=this,i=e.layer.uid;if(this._connectedLayers[i])return void D.warn("[OverlayManager#registerLayerView]: Layer "+i+" is already connected");var r=a(e,"draped-data-change",function(){return t.setOverlayDirty()});if(this._connectedLayers[i]={eventHandles:[r],layerView:e},e.setDrapingExtent&&this._overlays)for(var n=0;n<this._overlays.length;n++){var s=this._overlays[n];e.setDrapingExtent(n,s.extent,this._overlaySR,M,s.renderLocalOrigin)}this.setOverlayDirty()},t.prototype.unregisterLayerView=function(e){for(var t in this._connectedLayers){var i=this._connectedLayers[t];if(i.layerView===e){if(i.eventHandles)for(var r=0;r<i.eventHandles.length;r++)i.eventHandles[r].remove();delete this._connectedLayers[t],this.setOverlayDirty(),e.destroyed||(e._overlayUpdating=!1,e._evaluateUpdatingState())}}},t.prototype.setOverlayDirty=function(){this._dirty||(this._setOverlayUpdating(!0),this._dirty=!0)},t.prototype._setOverlayUpdating=function(e){for(var t in this._connectedLayers){var i=this._connectedLayers[t].layerView;(!e||!i.suspended&&i.hasDraped)&&(i._overlayUpdating=e,i._evaluateUpdatingState())}var r=this.view._graphicsView;r&&(r._overlayUpdating=e,r._evaluateUpdatingState())},t.prototype.updateOverlay=function(){if(this._overlaySR){var e=this._computeOverlayExtents();if(e){this._overlays||this._initOverlays();for(var t=0;t<this._overlays.length;t++){var i=this._overlays[t];if(m(e[t],i.extent)){R.set(e[t],i.extent),i.renderLocalOrigin={id:"OV_"+this._latestOriginId++,vec3:p.center(i.extent,T.create())};for(var r in this._connectedLayers){var a=this._connectedLayers[r].layerView;a.setDrapingExtent&&a.setDrapingExtent(t,e[t],this._overlaySR,M,i.renderLocalOrigin)}}}this._setOverlayUpdating(!1),this._drawOverlays(),this.terrainSurface._updateTileOverlayParams(),this._dirty=!1}}},t.prototype.overlaysNeedUpdate=function(){return this._dirty&&!!this._overlaySR},t.prototype.updateOpacity=function(e){var t=1;if(this._overlays){var i=this._scale,r=this.view.renderCoordsHelper.getAltitude(e);i>r*C&&(t=(r-i/E)/(i/C-i/E),t=Math.sqrt(y.clamp(t,0,1)))}return t},t.prototype.setOverlayParamsOfTile=function(e,t,i){var r=e.extent,a=-1;if(this._rectInsideRect(r,this._overlays[0].extent)?a=0:this._rectanglesOverlap(r,this._overlays[1].extent)&&(a=1),a>=0){var n=this._overlays[a].extent;t.overlayTexScale[0]=(r[2]-r[0])/(n[2]-n[0]),t.overlayTexScale[1]=(r[3]-r[1])/(n[3]-n[1]);var s=r[0];if(this._longitudeCyclical){s=this._longitudeCyclical.minimalMonotonic(n[0],s);var o=this._longitudeCyclical.minimalMonotonic(n[0],r[2]);s>o&&(s=o-(r[2]-r[0]))}O.set2((s-n[0])/(n[2]-n[0]),(r[1]-n[1])/(n[3]-n[1]),t.overlayTexOffset),this._overlays[a].valid?t.overlayTexId=this._overlays[a].texture.getId():t.overlayTexId=this._initialEmptyTexture.getId(),this._overlays[a].highlightValid?t.highlightOverlayTexId=this._overlays[a].highlightTexture.getId():t.highlightOverlayTexId=this._initialEmptyTexture.getId(),void 0!==i?t.overlayOpacity=i:t.overlayOpacity=1}else t.overlayTexId=null,t.highlightOverlayTexId=null},t.prototype.overlayPixelSizeInMapUnits=function(e){var t;return this._overlays&&(this._overlays[0]&&this._pointIsInExtent(e,this._overlays[0].extent)?t=this._overlays[0].extent:this._overlays[1]&&(t=this._overlays[1].extent)),t?(t[2]-t[0])/M:0},t.prototype._createEmptyOverlay=function(){var e=new _(null,"overlay",{wrapClamp:!0,mipmap:!0});this._stage.add(u.ModelContentType.TEXTURE,e);var t=new _(null,"highlightOverlay",{wrapClamp:!0,mipmap:!0});return this._stage.add(u.ModelContentType.TEXTURE,t),{extent:R.create(),texture:e,valid:!1,highlightTexture:t,highlightValid:!1,renderLocalOrigin:{id:"O",vec3:[0,0,0]}}},t.prototype._initOverlays=function(){this._overlays=[this._createEmptyOverlay(),this._createEmptyOverlay()]},t.prototype._disposeOverlays=function(){if(this._overlays){var e=this._stage;this._overlays.forEach(function(t){e.remove(u.ModelContentType.TEXTURE,t.texture.getId()),e.remove(u.ModelContentType.TEXTURE,t.highlightTexture.getId())}),this._overlays=null}},t.prototype._intersectGroundFromView=function(e,t,i,r){var a=T.createFrom(t*this.view.width,i*this.view.height,1);T.unproject(a,e.viewMatrix,e.projectionMatrix,e.fullViewport,a);var n=T.createFrom(t*this.view.width,i*this.view.height,0);return T.unproject(n,e.viewMatrix,e.projectionMatrix,e.fullViewport,n),this.groundSelector.init([],n,a,null,e,null,!1),this.view.basemapTerrain.intersect(this.groundSelector,n,a),this.groundSelector.minResult.getIntersectionPoint(r)},t.prototype._findHorizonBasedPointOfInterest=function(e,t,i){var r=.5,a=.55;if("global"===this.view.viewingMode){var n=T.create(e.eye);T.normalize(n),T.negate(n);var s=T.length(t),o=Math.asin(s/T.length(e.eye)),l=Math.acos(T.dot(e.viewForward,n)),h=o-(l-.5*e.fovY),v=y.clamp(h/e.fovY,0,1),d=-o-(l-.5*e.fovY),p=y.clamp(d/e.fovY,0,1);r=1===v&&0===p?.5:p+a*(v-p)}else{var u=.5*Math.PI-Math.acos(-e.viewForward[2]),_=Math.tan(u),g=c.mat4d.multiplyVec4(e.projectionMatrix,R.createFrom(0,_,1,0))[1],f=y.clamp(.5+.5*g,0,1);r=1===f||0===f?.5:e.eye[2]>0?f*a:1-(1-f)*a}return this._intersectGroundFromView(e,.5,r,i)?!0:!1},t.prototype._computeOverlayExtents=function(){var e=this.view.navigation.currentCamera,t=this.terrainSurface.extent,i=T.create(),r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;this._findHorizonBasedPointOfInterest(e,this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i)||T.set(r,i),this._scale=this.view.renderCoordsHelper.getAltitude(e.eye);var a=T.dist(e.eye,i),n=this.view.renderCoordsHelper.viewAngle(r,e.eye),s=Math.PI/2-Math.abs(n-Math.PI/2);if(f.OVERLAY_SHOW_CENTER){var o=new w({color:[255,0,0],outline:{color:[255,255,255],width:2}}),l=new h;d.vectorToPoint(i,this._renderSR,l,this._overlaySR);var c=new x({geometry:l,symbol:o});void 0!==S&&this.view.graphics.remove(S),this.view.graphics.add(c),S=c}this._overlaySREqualsRenderSR||d.vectorToVector(i,this._renderSR,i,this._overlaySR);var p=.5*M*e.perPixelRatio*a*2,u=!1,_=1/0;this._isSpherical&&(this._overlaySR.isWebMercator?(p/=Math.cos(d.webMercator.y2lat(i[1])),_=this.terrainSurface.extent[3],_*=.999):(u=!0,p/=v.metersPerDegree,_=90),p>=_&&(p=_,i[1]=0,this._overlaySR.isWebMercator&&(i[0]=0)));var g=1;u&&(g=1/Math.max(.2,Math.cos(Math.abs(y.deg2rad(i[1])))),p*g>180&&(g=180/p));var m=p*g,C=U[0];C[0]=i[0]-m,C[1]=i[1]-p,C[2]=i[0]+m,C[3]=i[1]+p,this._isSpherical&&this._shiftExtentToFitBounds(C,1/0,_);var E=U[1];if(R.set(C,E),6*m>t[2]-t[0])R.set(t,E);else if(s<=.25*Math.PI)E[0]-=m,E[1]-=p,E[2]+=m,E[3]+=p;else{d.vectorToVector(e.eye,this._renderSR,V,this._overlaySR),O.subtract(i,V,L);var I=-Math.atan2(L[1],L[0])+.125*Math.PI;0>I&&(I+=2*Math.PI);var H=Math.floor(I/(.25*Math.PI));R.scale(P[H],2*p,L),L[0]*=g,L[2]*=g,R.add(E,L,E)}return this._isSpherical&&(E[0]=this._longitudeCyclical.clamp(E[0]),E[2]=this._longitudeCyclical.clamp(E[2]),E[1]=Math.max(E[1],-_),E[3]=Math.min(E[3],_)),this.opacity=1,U},t.prototype._drawOverlays=function(){for(var e=this._overlays[0].extent[2]-this._overlays[0].extent[0],t=this._renderer,i=0;i<this._overlays.length;i++){var r=this._overlays[i].extent,a=this._longitudeCyclical?r[2]>this._longitudeCyclical.max:!1,n=this._longitudeCyclical?r[0]<this._longitudeCyclical.min:!1;if(a||n){I.views=b;var s=void 0;s=a?this._longitudeCyclical.max-r[0]:this._longitudeCyclical.min-r[0];var o=Math.round(s/(r[2]-r[0])*M),l=I.views[0];R.set4(0,0,o,M,l.viewport),R.set4(r[0],r[1],this._longitudeCyclical.max,r[3],l.extent),a||(l.extent[0]+=this._longitudeCyclical.range);var h=I.views[1];R.set4(o,0,M-o,M,h.viewport),R.set4(this._longitudeCyclical.min,r[1],r[2],r[3],h.extent),a&&(h.extent[2]-=this._longitudeCyclical.range)}else I.views=H,R.set(r,I.views[0].extent),R.set4(0,0,M,M,I.views[0].viewport);I.width=M,I.height=M,I.pixelRatio=e/(r[2]-r[0]),this._overlays[i].valid=t.draw(this._overlays[i].texture,I),this._overlays[i].highlightValid=t.drawHighlights(this._overlays[i].highlightTexture,I)}},t.prototype._rectanglesOverlap=function(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):!(e[0]>t[2]||e[2]<t[0]||e[1]>t[3]||e[3]<t[1])},t.prototype._rectInsideRect=function(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:e[0]>t[0]&&e[2]<t[2]&&e[1]>t[1]&&e[3]<t[3]},t.prototype._pointIsInExtent=function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];var i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]},t.prototype._shiftExtentToFitBounds=function(e,t,i){var r=0,a=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?a=e[1]+i:e[3]>i&&(a=i-e[3]),p.offset(e,r,a)},t.EXTENTS_DIFFER_THRESHOLD=1e-5,r([l.property()],t.prototype,"view",void 0),r([l.property()],t.prototype,"terrainSurface",void 0),r([l.property({type:Boolean})],t.prototype,"hasHighlights",null),t=r([l.subclass("esri.views.3d.terrain.OverlayManager")],t)}(l.declared(s));return F});