// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/on","../../../core/Logger","../../../core/Accessor","../../../core/HandleRegistry","../../../core/accessorSupport/decorators","../../../geometry/Point","../lib/glMatrix","../state/utils/viewUtils","../support/mathUtils","../support/earthUtils","../support/projectionUtils","../support/aaBoundingRect","../support/debugFlags","../webgl-engine/Stage","../webgl-engine/lib/Texture","../webgl-engine/lib/Selector","../support/debugFlags","../../../symbols/SimpleMarkerSymbol","../../../Graphic"],function(e,t,i,r,a,n,s,o,l,c,h,v,d,y,p,u,_,g,f,w,x,S,O){function m(e,t){for(var i=_.TESTS_DISABLE_UPDATE_THROTTLE_THRESHOLDS?0:L.EXTENTS_DIFFER_THRESHOLD*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]),r=0;4>r;r++)if(Math.abs(t[r]-e[r])>i)return!0;return!1}var T,E=2048,R=3.5,M=10,C=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],I=n.getLogger("esri.views.3d.OverlayManager"),L=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._handles=new o,t._overlaySR=null,t._renderSR=null,t._overlaySREqualsRenderSR=!0,t._connectedLayers={},t._scale=0,t._dirty=!1,t._isSpherical=!1,t._latestOriginId=0,t.opacity=0,t}return i(t,e),Object.defineProperty(t.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;this._stage=this.view._stage,this._renderer=this._stage.getTextureGraphicsRenderer(),this._renderer.onHasHighlightsChanged=function(){return e.onHasHighlightsChanged()},this._initialEmptyTexture=new f(new Uint8Array([0,0,0,0]),"overlayEmpty",{width:1,height:1,wrapClamp:!0}),this.groundSelector=new w(this.view.viewingMode),this.groundSelector.enableBackfacesTerrain=!0,this.groundSelector.enableInvisibleTerrain=!0,this.groundSelector.enableHUDSelection=!1,this._stage.add(g.ModelContentType.TEXTURE,this._initialEmptyTexture),this._handles.add(this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location"],function(){return e.setOverlayDirty()}))},t.prototype.destroy=function(){for(var e in this._connectedLayers)this.unregisterLayerView(this._connectedLayers[e].layerView);this._disposeOverlays(),this._stage.remove(g.ModelContentType.TEXTURE,this._initialEmptyTexture.getId()),this._handles&&(this._handles.destroy(),this._handles=null)},t.prototype.onHasHighlightsChanged=function(){this.setOverlayDirty(),this.notifyChange("hasHighlights")},t.prototype.hasOverlays=function(){return!!this._overlays},t.prototype.setSpatialReference=function(e,t){this._overlaySR=e,e?(this._renderSR=this.view.renderSpatialReference,this._overlaySREqualsRenderSR=this._overlaySR.equals(this._renderSR),this._isSpherical=t,t?this._longitudeCyclical=e.isWebMercator?new d.Cyclical(-20037508.342788905,20037508.342788905):new d.Cyclical(-180,180):this._longitudeCyclical=null):(this._disposeOverlays(),this._longitudeCyclical=null)},t.prototype.registerLayerView=function(e){var t=this,i=e.layer.uid;if(this._connectedLayers[i])return void I.warn("[OverlayManager#registerLayerView]: Layer "+i+" is already connected");var r=a(e,"draped-data-change",function(){return t.setOverlayDirty()});if(this._connectedLayers[i]={eventHandles:[r],layerView:e},e.setDrapingExtent&&this._overlays)for(var n=0;n<this._overlays.length;n++){var s=this._overlays[n];e.setDrapingExtent(n,s.extent,this._overlaySR,E,s.renderLocalOrigin)}this.setOverlayDirty(),this._setLayerViewOverlayUpdating(e,this._dirty)},t.prototype.unregisterLayerView=function(e){for(var t in this._connectedLayers){var i=this._connectedLayers[t];if(i.layerView===e){if(i.eventHandles)for(var r=0;r<i.eventHandles.length;r++)i.eventHandles[r].remove();delete this._connectedLayers[t],this.setOverlayDirty(),e.destroyed||(e._overlayUpdating=!1,e._evaluateUpdatingState())}}},t.prototype.setOverlayDirty=function(){this._dirty||(this._setOverlayUpdating(!0),this._dirty=!0)},t.prototype._setLayerViewOverlayUpdating=function(e,t){(!t||!e.suspended&&e.hasDraped)&&(e._overlayUpdating=t,e._evaluateUpdatingState())},t.prototype._setOverlayUpdating=function(e){for(var t in this._connectedLayers){var i=this._connectedLayers[t].layerView;this._setLayerViewOverlayUpdating(i,e)}var r=this.view._graphicsView;r&&(r._overlayUpdating=e,r._evaluateUpdatingState())},t.prototype.updateOverlay=function(){if(this._overlaySR){var e=this._computeOverlayExtents();if(e){this._overlays||this._initOverlays();for(var t=0;t<this._overlays.length;t++){var i=this._overlays[t];if(m(e[t],i.extent)){h.vec4d.set(e[t],i.extent),i.renderLocalOrigin={id:"OV_"+this._latestOriginId++,vec3:u.center(i.extent,h.vec3d.create())};for(var r in this._connectedLayers){var a=this._connectedLayers[r].layerView;a.setDrapingExtent&&a.setDrapingExtent(t,e[t],this._overlaySR,E,i.renderLocalOrigin)}}}this._setOverlayUpdating(!1),this._drawOverlays(),this.terrainSurface._updateTileOverlayParams(),this._dirty=!1}}},t.prototype.overlaysNeedUpdate=function(){return this._dirty&&!!this._overlaySR},t.prototype.updateOpacity=function(e){var t=1;if(this._overlays){var i=this._scale,r=this.view.renderCoordsHelper.getAltitude(e);i>r*R&&(t=(r-i/M)/(i/R-i/M),t=Math.sqrt(d.clamp(t,0,1)))}return t},t.prototype.setOverlayParamsOfTile=function(e,t,i){var r=e.extent,a=this._overlayForTile(e);if(!a)return t.overlayTexId=null,void(t.highlightOverlayTexId=null);var n=a.extent;t.overlayTexScale[0]=(r[2]-r[0])/(n[2]-n[0]),t.overlayTexScale[1]=(r[3]-r[1])/(n[3]-n[1]);var s=r[0];if(this._longitudeCyclical){s=this._longitudeCyclical.minimalMonotonic(n[0],s);var o=this._longitudeCyclical.minimalMonotonic(n[0],r[2]);s>o&&(s=o-(r[2]-r[0]))}h.vec2d.set2((s-n[0])/(n[2]-n[0]),(r[1]-n[1])/(n[3]-n[1]),t.overlayTexOffset),a.valid?t.overlayTexId=a.texture.getId():t.overlayTexId=this._initialEmptyTexture.getId(),a.highlightValid?t.highlightOverlayTexId=a.highlightTexture.getId():t.highlightOverlayTexId=this._initialEmptyTexture.getId(),void 0!==i?t.overlayOpacity=i:t.overlayOpacity=1},t.prototype.overlayPixelSizeInMapUnits=function(e){var t;return this._overlays&&(this._overlays[0]&&this._pointIsInExtent(e,this._overlays[0].extent)?t=this._overlays[0].extent:this._overlays[1]&&(t=this._overlays[1].extent)),t?(t[2]-t[0])/E:0},t.prototype._overlayForTile=function(e){var t=e.extent,i=e.clippingArea?u.intersection(t,e.clippingArea,V):t;return this._rectInsideRect(i,this._overlays[0].extent)?this._overlays[0]:this._rectanglesOverlap(i,this._overlays[1].extent)?this._overlays[1]:null},t.prototype._createEmptyOverlay=function(){var e=new f(null,"overlay",{wrapClamp:!0,mipmap:!0});this._stage.add(g.ModelContentType.TEXTURE,e);var t=new f(null,"highlightOverlay",{wrapClamp:!0,mipmap:!0});return this._stage.add(g.ModelContentType.TEXTURE,t),{extent:h.vec4d.create(),texture:e,valid:!1,highlightTexture:t,highlightValid:!1,renderLocalOrigin:{id:"O",vec3:[0,0,0]}}},t.prototype._initOverlays=function(){this._overlays=[this._createEmptyOverlay(),this._createEmptyOverlay()]},t.prototype._disposeOverlays=function(){if(this._overlays){var e=this._stage;this._overlays.forEach(function(t){e.remove(g.ModelContentType.TEXTURE,t.texture.getId()),e.remove(g.ModelContentType.TEXTURE,t.highlightTexture.getId())}),this._overlays=null}},t.prototype._intersectGroundFromView=function(e,t,i,r){var a=h.vec3d.createFrom(t*this.view.width,i*this.view.height,1);h.vec3d.unproject(a,e.viewMatrix,e.projectionMatrix,e.fullViewport,a);var n=h.vec3d.createFrom(t*this.view.width,i*this.view.height,0);return h.vec3d.unproject(n,e.viewMatrix,e.projectionMatrix,e.fullViewport,n),this.groundSelector.init([],n,a,null,e,null,!1),this.view.basemapTerrain.intersect(this.groundSelector,n,a),this.groundSelector.minResult.getIntersectionPoint(r)},t.prototype._findHorizonBasedPointOfInterest=function(e,t,i){var r=.5,a=.55;if("global"===this.view.viewingMode){var n=h.vec3d.create(e.eye);h.vec3d.normalize(n),h.vec3d.negate(n);var s=h.vec3d.length(t),o=Math.asin(s/h.vec3d.length(e.eye)),l=Math.acos(h.vec3d.dot(e.viewForward,n)),c=o-(l-.5*e.fovY),v=d.clamp(c/e.fovY,0,1),y=-o-(l-.5*e.fovY),p=d.clamp(y/e.fovY,0,1);r=1===v&&0===p?.5:p+a*(v-p)}else{var u=.5*Math.PI-Math.acos(-e.viewForward[2]),_=Math.tan(u),g=h.mat4d.multiplyVec4(e.projectionMatrix,h.vec4d.createFrom(0,_,1,0))[1],f=d.clamp(.5+.5*g,0,1);r=1===f||0===f?.5:e.eye[2]>0?f*a:1-(1-f)*a}return this._intersectGroundFromView(e,.5,r,i)?!0:!1},t.prototype._computeOverlayExtents=function(){var e=this.view.state.camera,t=this.terrainSurface.extent,i=h.vec3d.create(),r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation;this._findHorizonBasedPointOfInterest(e,this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,i)||h.vec3d.set(r,i),this._scale=this.view.renderCoordsHelper.getAltitude(e.eye);var a=h.vec3d.dist(e.eye,i),n=v.viewAngle(this.view.renderCoordsHelper,r,e.eye),s=Math.PI/2-Math.abs(n-Math.PI/2);if(x.OVERLAY_SHOW_CENTER){var o=new S({color:[255,0,0],outline:{color:[255,255,255],width:2}}),l=new c;p.vectorToPoint(i,this._renderSR,l,this._overlaySR);var _=new O({geometry:l,symbol:o});void 0!==T&&this.view.graphics.remove(T),this.view.graphics.add(_),T=_}this._overlaySREqualsRenderSR||p.vectorToVector(i,this._renderSR,i,this._overlaySR);var g=.5*E*e.perPixelRatio*a*2,f=!1,w=1/0;this._isSpherical&&(this._overlaySR.isWebMercator?(g/=Math.cos(p.webMercator.y2lat(i[1])),w=this.terrainSurface.extent[3],w*=.999):(f=!0,g/=y.metersPerDegree,w=90),g>=w&&(g=w,i[1]=0,this._overlaySR.isWebMercator&&(i[0]=0)));var m=1;f&&(m=1/Math.max(.2,Math.cos(Math.abs(d.deg2rad(i[1])))),g*m>180&&(m=180/g));var R=g*m,M=F[0];M[0]=i[0]-R,M[1]=i[1]-g,M[2]=i[0]+R,M[3]=i[1]+g,this._isSpherical&&this._shiftExtentToFitBounds(M,1/0,w);var I=F[1];if(h.vec4d.set(M,I),6*R>t[2]-t[0])h.vec4d.set(t,I);else if(s<=.25*Math.PI)I[0]-=R,I[1]-=g,I[2]+=R,I[3]+=g;else{p.vectorToVector(e.eye,this._renderSR,D,this._overlaySR),h.vec2d.subtract(i,D,V);var L=-Math.atan2(V[1],V[0])+.125*Math.PI;0>L&&(L+=2*Math.PI);var H=Math.floor(L/(.25*Math.PI));h.vec4d.scale(C[H],2*g,V),V[0]*=m,V[2]*=m,h.vec4d.add(I,V,I)}if(this._isSpherical&&(I[0]=this._longitudeCyclical.clamp(I[0]),I[2]=this._longitudeCyclical.clamp(I[2]),I[1]=Math.max(I[1],-w),I[3]=Math.min(I[3],w)),!this._isSpherical&&t){var b=u.intersection(M,t,P),U=u.intersection(I,t,A);u.contains(b,U)&&(I[2]=I[0],I[3]=I[1])}return this.opacity=1,F},t.prototype._drawOverlays=function(){for(var e=this._overlays[0].extent[2]-this._overlays[0].extent[0],t=this._renderer,i=0;i<this._overlays.length;i++){var r=this._overlays[i].extent,a=this._longitudeCyclical?r[2]>this._longitudeCyclical.max:!1,n=this._longitudeCyclical?r[0]<this._longitudeCyclical.min:!1;if(a||n){H.views=U;var s=void 0;s=a?this._longitudeCyclical.max-r[0]:this._longitudeCyclical.min-r[0];var o=Math.round(s/(r[2]-r[0])*E),l=H.views[0];h.vec4d.set4(0,0,o,E,l.viewport),h.vec4d.set4(r[0],r[1],this._longitudeCyclical.max,r[3],l.extent),a||(l.extent[0]+=this._longitudeCyclical.range);var c=H.views[1];h.vec4d.set4(o,0,E-o,E,c.viewport),h.vec4d.set4(this._longitudeCyclical.min,r[1],r[2],r[3],c.extent),a&&(c.extent[2]-=this._longitudeCyclical.range)}else H.views=b,h.vec4d.set(r,H.views[0].extent),h.vec4d.set4(0,0,E,E,H.views[0].viewport);H.width=E,H.height=E,H.pixelRatio=e/(r[2]-r[0]),this._overlays[i].valid=t.draw(this._overlays[i].texture,H),this._overlays[i].highlightValid=t.drawHighlights(this._overlays[i].highlightTexture,H)}},t.prototype._rectanglesOverlap=function(e,t){return this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):u.intersects(e,t)},t.prototype._rectInsideRect=function(e,t){return this._longitudeCyclical?this._longitudeCyclical.contains(t[0],t[2],e[0])&&this._longitudeCyclical.contains(t[0],t[2],e[2])&&e[1]>t[1]&&e[3]<t[3]:u.contains(t,e)},t.prototype._pointIsInExtent=function(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];var i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]},t.prototype._shiftExtentToFitBounds=function(e,t,i){var r=0,a=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?a=e[1]+i:e[3]>i&&(a=i-e[3]),u.offset(e,r,a)},t.EXTENTS_DIFFER_THRESHOLD=1e-5,r([l.property()],t.prototype,"view",void 0),r([l.property()],t.prototype,"terrainSurface",void 0),r([l.property({type:Boolean})],t.prototype,"hasHighlights",null),t=r([l.subclass("esri.views.3d.terrain.OverlayManager")],t)}(l.declared(s)),H={width:0,height:0,pixelRatio:0,views:null},b=[{viewport:h.vec4d.create(),extent:h.vec4d.create()}],U=[b[0],{viewport:h.vec4d.create(),extent:h.vec4d.create()}],V=h.vec4d.create(),D=h.vec3d.create(),F=[h.vec4d.create(),h.vec4d.create()],P=u.create(),A=u.create();return L});