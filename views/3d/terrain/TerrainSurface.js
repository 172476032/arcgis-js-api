// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessorSupport/decorators","../../../core/Accessor","../../../core/arrayUtils","../../../core/CollectionFlattener","../../../core/ObjectPool","../../../core/Logger","../../../core/watchUtils","../../../geometry/Point","../lib/glMatrix","../support/aaBoundingRect","../support/Evented","../support/mathUtils","../support/PreallocArray","../support/projectionUtils","../support/PromiseLightweight","../support/ResourceController","./OverlayManager","./PlanarTile","./SphericalTile","./SurfaceExtentHelper","./SurfaceTilingSchemeLogic","./TerrainConst","./TerrainRenderer","./terrainUtils","./TileGeometryFactory","./TilemapOnlyTile","./tileUtils","./tileUtils"],function(e,t,i,r,a,n,s,l,o,p,h,d,u,c,_,y,v,g,f,T,m,E,L,w,S,x,P,O,R,C,U,I){function b(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function V(e){return e&&("cancel"===e||"cancel"===e.dojoType)}function D(e){e.remove()}var A=u.vec3d,M=u.vec4d,q=u.mat4d,j=O.weakAssert,B=p.getLogger("esri.views.3d.terrain.TerrainSurface"),N=function(e){function t(){var t=e.call(this)||this;t.defaultTileBackground=x.DEFAULT_TILE_BACKGROUND,t.hideSkirtsDistanceFromExtentMargin=F,t.hideSkirtsMinimumCameraTilt=k,t._clippingExtent=null,t._dataExtent=null,t._elevationBounds=[0,0],t._rootExtent=[0,0,0,0],t._iteratorPool=new o(I.IteratorPreorder),t._postorderIterator=new I.IteratorPostorder,t.visible=!1,t.suspended=!1,t._pendingUpdates=!1,t._lvPendingUpdates=!1,t._updateNextFrame=0,t._vectorTileLayerRequests=0,t._curOverlayOpacity=1,t._curEyePos=A.create(),t._curSplitLimits=[0,0,0,0,0,0],t._curFrustumPlanes=new Array(6),t._viewProjectionMatrix=q.identity(),t.tilemapStats={tilemapRequestsSent:0,tilemapRequestsPending:0,tilemapRequestErrors:0,fullTilemaps:0,emptyTilemaps:0,tilesRequested:0,tileRequestsSent:0,tileRequestErrors:0,tilesNotPresent:0},t._layerViews=[[],[]],t._layerIndexByLayerViewId=[{},{}],t._basemapLayerViewHandles={},t._layerViewChangesHandle=null,t._viewChangeListenerHandles=[],t._frameUpdateLowerPrio=new v(500),t._topLevelTilemapOnlyTiles=new Array(x.TILEMAP_SIZE_EXP+1),t.loaded=!1,t.maxTextureScale=1.2,t.rootTiles=null;for(var i=0;i<t._topLevelTilemapOnlyTiles.length;i++)t._topLevelTilemapOnlyTiles[i]=new C([i-x.TILEMAP_SIZE_EXP,0,0]);for(var i=0;6>i;i++)t._curFrustumPlanes[i]=M.create();return t}return i(t,e),t.prototype.normalizeCtorArgs=function(e,t){return this._view=e,this._stage=e._stage,this._set("manifold",t),{}},t.prototype.initialize=function(){var e=this;this.tilePool="planar"===this.manifold?E.Pool:L.Pool,this._renderer=new P(this.manifold,null,this._view.pointsOfInterest),this._renderer.loaded=this._setLoaded.bind(this),this._renderer.updateTileBackground(this.tileBackground),this._renderer.install(this._view._stage),this._set("overlayManager",new m({terrainSurface:this,view:this._view})),this.watch("overlayManager.hasHighlights",this._handleHasHighlights.bind(this));var t={layers:this._view.map.allLayers,layerViews:this._view.allLayerViews,spatialReference:this._view.spatialReference};this.extentHelper="spherical"===this.manifold?new w.SurfaceExtentHelperGlobal(t):new w.SurfaceExtentHelperLocal(t),h.init(this.extentHelper,"stencilEnabledExtents",function(t){e._renderer.setStencilEnabledLayerExtents(t)});var i;i=this._view.defaultsFromMap?new l({root:this._view.map,rootCollectionNames:this._view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:function(e){return e.layers}}):this._view.map.allLayers;var r=new S({layers:i,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this._view.spatialReference});this._set("tilingSchemeLogic",r),this.tilingSchemeLogic.watch("tilingScheme",this._updateTilingSchemeAndExtent.bind(this),!0),this.tilingSchemeLogic.watch("extent",this._updateTilingSchemeAndExtent.bind(this),!0),this._updateTilingSchemeAndExtent(),this._streamDataSupplier=this._view.resourceController.registerClient(this,T.ClientType.TERRAIN);var a={needsUpdate:this._needsIdleUpdate,idleFrame:this._idleUpdate};this._view.resourceController.registerFrameWorker(this._frameUpdate.bind(this)),this._view.resourceController.registerIdleFrameWorker(this,a),this._viewChangeUpdate=this._viewChangeUpdate.bind(this),this._viewChangeListenerHandles.push(this._view.on("resize",this._viewChangeUpdate)),this._viewChangeListenerHandles.push(h.on(this._view,"navigation","currentViewChanged",this._viewChangeUpdate)),this._viewChangeListenerHandles.push(this._view.watch("qualitySettings.tiledSurface.lodBias",this._viewChangeUpdate)),this._layerViewChangesHandle=this._view.allLayerViews.on("change",this._handleLayerViewChanges.bind(this)),this._handleLayerViewChanges({added:this._view.allLayerViews.toArray(),removed:[],moved:[]}),this._clippingChangedHandle=this._view.watch("clippingArea",this._clippingChanged.bind(this)),this._updateClippingExtent(),this.notifyChange("extent")},t.prototype.destroy=function(){this._removeAllTiles(),this.tilingSchemeLogic.destroy(),this._set("tilingSchemeLogic",null),this.extentHelper.destroy(),this.extentHelper=null;for(var e in this._basemapLayerViewHandles)this._unregisterTiledLayerView(e);this._view.resourceController.deregisterFrameWorker(),this._view.resourceController.deregisterIdleFrameWorker(this),this._view.resourceController.deregisterClient(this),this._viewChangeListenerHandles.forEach(D),this._layerViewChangesHandle.remove(),this._clippingChangedHandle.remove(),this.overlayManager&&(this.overlayManager.destroy(),this._set("overlayManager",null)),this._renderer.uninstall(this._stage),this._renderer=null,this._view=null,this._stage=null,this._streamDataSupplier=null},Object.defineProperty(t.prototype,"cullBackFaces",{set:function(e){this._renderer.setCullBackFaces(e),this._set("cullBackFaces",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"extent",{get:function(){return this._clippingExtent||this._rootExtent},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"frontMostTransparent",{set:function(e){this._renderer.setFrontMostTransparent(e),this._set("frontMostTransparent",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"opacity",{set:function(e){this._renderer.setOpacity(e),this._set("opacity",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ready",{get:function(){return!!this.rootTiles},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"renderOrder",{set:function(e){this._renderer.setRenderOrder(e),this._set("renderOrder",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"skirts",{set:function(e){this._renderer.setDrawSkirts(e),this._set("skirts",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"tileBackground",{set:function(e){e!==this.tileBackground&&this._renderer.updateTileBackground(e),this._set("tileBackground",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"velvetOverground",{set:function(e){e!==this.velvetOverground&&this._renderer.setVelvetOverground(e),this._set("velvetOverground",e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"wireframe",{set:function(e){this._renderer.setWireframe(e),this._set("wireframe",e),this._view._stage.setRenderParams({earlyOcclusionPixelDraw:e})},enumerable:!0,configurable:!0}),t.prototype.setVisibility=function(e){e!==this.visible&&(this.visible=e,this._renderer.setVisibility(e),this.setUpdatesDisabled(!e),e&&this._viewChangeUpdate())},t.prototype.isVisible=function(){return this.visible&&this.ready},t.prototype.isSeeThrough=function(){return this._renderer.isTransparent()},t.prototype.setUpdatesDisabled=function(e){this.suspended=e,e||this._viewChangeUpdate()},t.prototype.intersect=function(e,t,i){this._renderer.intersect(e,t,i)},t.prototype.getElevation=function(e){if(!this.ready)return null;var t=x.LayerClass.ELEVATION,i=this.rootTiles,r=i[0].layerInfo[t].length;if(0===r)return null;K.length<r&&(K.length=r);var a;if(e instanceof d){if(!g.pointToVector(e,W,this.tilingScheme.spatialReference))return B.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;a=W}else a=e;for(var n,s=0;s<i.length;s++){var l=i[s];if(U.isPosWithinTile(l,a)){do{var o=l.layerInfo[t];for(n=0;r>n;n++)null!=o[n].data&&(z[n]=o[n].data);var p=0;a[0]>.5*(l.extent[0]+l.extent[2])&&(p+=1),a[1]<.5*(l.extent[1]+l.extent[3])&&(p+=2),l=l.children[p]}while(null!=l);break}}for(n=0;r>n;n++)K[n]=z[n]?z[n].samplerData:null;var h=R.elevationSampler(a[0],a[1],K);for(n=0;r>n;n++)K[n]=void 0;return h},t.prototype.getElevationBounds=function(){return this._elevationBounds},t.prototype.getScale=function(e){if(this.tilingScheme){if(!g.pointToVector(e,W,this.spatialReference))return B.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;if(this.rootTiles)for(var t=0;t<this.rootTiles.length;t++){var i=this.rootTiles[t];if(U.isPosWithinTile(i,W)){for(;i.children[0];){var r=0;W[0]>i.children[0].extent[2]&&(r+=1),W[1]<i.children[0].extent[1]&&(r+=2),i=i.children[r]}return this._getLodBiasCorrectedScale(i.lij[0])}}}return 1e100},t.prototype.queryVisibleScaleRange=function(e,t,i,r){var a=t?this.tilingScheme.levelAtScale(t):0,n=i?this.tilingScheme.levelAtScale(i):1/0,s=this._getLodBias();this._renderer.queryVisibleLevelRange(e,a+s,n+s,r)},t.prototype._setLoaded=function(){this.loaded||this._set("loaded",!0)},t.prototype._updateTilingSchemeAndExtent=function(){var e=this.tilingSchemeLogic.extent,t=this.tilingSchemeLogic.tilingScheme,i=!1;e&&!c.equals(e,this._dataExtent)&&(i=!0,this._dataExtent?c.set(this._dataExtent,e):this._dataExtent=c.create(e)),t!==this.tilingScheme&&(j(!!t,"tiling scheme cannot be reset to undefined"),i=!0,this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",t),this._updateClippingExtent(),t&&(this._updateTiledLayers(),this._renderer.setTileSize(t.pixelSize[0]),this.overlayManager.setSpatialReference(t.spatialReference,"spherical"===this.manifold))),i&&this._updateRootTiles()},t.prototype._acquireTile=function(e,t,i,r){var a=this.tilePool.acquire();return Z[0]=e,Z[1]=t,Z[2]=i,a.init(Z,r,this,this.tilingScheme),a},t.prototype._releaseTile=function(e){e.dispose(),e.parent=null,e.parentSurface=null,this.tilePool.release(e)},t.prototype._updateRootTiles=function(){var e=this,t=this._clippingExtent||this._dataExtent,i=this.tilingScheme;if(t&&i){var r=W,a=i.rootTilesInExtent(t,r,1/0);if(this.rootTiles){if(a.length>G)return void B.warn(x.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);var n=this.rootTiles.map(function(e){return e.lij}),l=s.difference(n,a,b);if(l.removed.length>0||l.added.length>0){var o=this.rootTiles.filter(function(t){var i=s.findIndex(l.removed,b.bind(null,t.lij));return i>-1?(e._purgeChildTiles(t),e._purgeTile(t),!1):!0});l.added.forEach(function(t){var i=e._acquireTile(0,t[1],t[2],null);o.push(i),e._loadTile(i)}),this._set("rootTiles",o),this._renderer.setRootTiles(this.rootTiles)}}else a.length>G&&(B.warn(x.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),a=i.rootTilesInExtent(t,r,G)),this._set("rootTiles",a.map(function(t){var i=e._acquireTile(0,t[1],t[2],null);return e._loadTile(i),i})),this._renderer.setRootTiles(this.rootTiles);s.equals(r,this._rootExtent)||(this._rootExtent=M.create(r),this._hasFixedExtent()||this.notifyChange("extent")),this.setVisibility(!0),this._viewChangeUpdate(),this.notifyChange("ready")}},t.prototype._viewChangeUpdate=function(){this._stage&&!this.suspended&&this.tilingScheme&&this.visible&&(this._updateViewDependentParameters(),this._updateOverlayOpacity(this._curEyePos),this._updateTiles(this.rootTiles))},t.prototype._updateTiles=function(e){var t=this._iteratorPool.acquire();t.reset(e);var i,r,a=this._curSplitLimits,n=this._curFrustumPlanes,s=this._curEyePos;for(U.hasVisibleSiblings(e)?(i=this._elevationBounds[0],r=this._elevationBounds[1]):(i=1/0,r=-(1/0));!t.done;){var l=t.next();l.updateClippingStatus(this._clippingExtent);var o=l.updateVisibility(n,s),p=!0;if(o){l.updateScreenDepth(this._viewProjectionMatrix),l.renderData&&(i=Math.min(l.elevationBounds[0],i),r=Math.max(l.elevationBounds[1],r));var h=l.shouldSplit(a,s);h===Y.SPLIT?(l.pendingUpdates&=~Y.MERGE,l.renderData?(p=!1,l.pendingUpdates|=Y.SPLIT,t.skip()):p=!1):(l.pendingUpdates&=~Y.SPLIT,h===Y.VSPLITMERGE&&l.updateAgents(x.LayerClass.ELEVATION),t.skip())}else t.skip();if(p&&!l.renderData){l.pendingUpdates|=Y.MERGE,l.pendingUpdates&=~Y.SPLIT;var d=this._iteratorPool.acquire();for(d.reset(l);!d.done;){var u=d.next();u.updateVisibility(n,s),u.visible&&u.updateScreenDepth(this._viewProjectionMatrix)}this._iteratorPool.release(d)}0!==l.pendingUpdates&&(this._pendingUpdates=!0)}this._iteratorPool.release(t),isFinite(i)&&isFinite(r)&&(this._elevationBounds[0]!==i||this._elevationBounds[1]!==r)&&(this._elevationBounds[0]=i,this._elevationBounds[1]=r,this.emit("elevation-bounds-change",null))},t.prototype._updateViewDependentParameters=function(){var e=this._view.navigation.currentCamera,t=Math.tan(.5*e.fovX),i=Math.tan(.5*e.fovY),r=this.tilingScheme.pixelSize,a=Math.pow(2,-this._getLodBias());this._curSplitLimits[0]=t,this._curSplitLimits[1]=r[0]/e.width*this.maxTextureScale*a,this._curSplitLimits[2]=i,this._curSplitLimits[3]=r[1]/e.height*this.maxTextureScale*a,this._curSplitLimits[4]=this.tilingScheme.getMaxLod(),this._curSplitLimits[5]=this._view.qualitySettings.tiledSurface.angledSplitBias,e.copyFrustumPlanes(this._curFrustumPlanes),q.multiply(e.projectionMatrix,e.viewMatrix,this._viewProjectionMatrix),A.set(e.eye,this._curEyePos),O.autoUpdateSkirtsVisibility(this,this._curEyePos)},t.prototype._setLayerViewsUpdating=function(){for(var e=0;e<x.LayerClass.LAYER_CLASS_COUNT;e++)for(var t=this._layerViews[e],i=0;i<t.length;i++)t[i]._evaluateUpdatingState(this._pendingUpdates)},t.prototype._frameUpdateTraversal=function(e){if(!this.suspended){this._frameUpdateLowerPrio.clear();var t=this._renderer.resourceCounter.numTileTexturesComposited,i=this._iteratorPool.acquire();i.reset(this.rootTiles);for(var r=!1,a=!1;!i.done&&(e.remaining()>1||!r)&&this._renderer.resourceCounter.numTileTexturesComposited-t<X;){var n=i.next();n.pendingUpdates&Y.MERGE?(this._mergeTile(n),n.pendingUpdates&=~Y.MERGE,r=!0,i.skip()):n.pendingUpdates&Y.SPLIT?(this._splitTile(n),n.pendingUpdates&=~Y.SPLIT,r=!0,i.skip()):n.pendingUpdates>0&&this._frameUpdateLowerPrio.push(n),0!==n.pendingUpdates&&(a=!0)}return this._pendingUpdates=a||!i.done,this._iteratorPool.release(i),r}},t.prototype._updateTileGeometry=function(e){this._renderer._updateTileGeometry(e),J.spatialReference=this.spatialReference,J.tile=e,this.emit("tile-geometry-change",J)},t.prototype._updateTileTexture=function(e){this._renderer.updateTileTexture(e)},t.prototype._frameUpdate=function(e){if(this.rootTiles){for(var t=this._frameUpdateTraversal(e);(e.remaining()>1||!t)&&this._frameUpdateLowerPrio.length>0;){var i=this._frameUpdateLowerPrio.pop();i.pendingUpdates&Y.DECODE_ELEVATION?(this._decodeElevation(i),i.pendingUpdates&=~Y.DECODE_ELEVATION,t=!0):i.pendingUpdates&Y.UPDATE_GEOMETRY?(this._renderer.updateTileGeometryNeedsUpdate(i),this._updateTileGeometry(i),t=!0,i.pendingUpdates&=~Y.UPDATE_GEOMETRY):i.pendingUpdates&Y.UPDATE_TEXTURE&&(this._updateTileTexture(i),i.pendingUpdates&=~Y.UPDATE_TEXTURE,t=!0),0!==i.pendingUpdates&&(this._pendingUpdates=!0)}this._frameUpdateLowerPrio.length>0&&(this._pendingUpdates=!0),(this._streamDataSupplier.hasPendingDownloads()||0!==this._vectorTileLayerRequests)&&(this._pendingUpdates=!0),this._pendingUpdates!==this._lvPendingUpdates&&(this._pendingUpdates||20===++this._updateNextFrame)&&(this._setLayerViewsUpdating(),this._lvPendingUpdates=this._pendingUpdates,this._updateNextFrame=0)}},t.prototype._needsIdleUpdate=function(){return this.isVisible()&&this.overlayManager&&this.overlayManager.overlaysNeedUpdate()},t.prototype._idleUpdate=function(){this.overlayManager.updateOverlay(),this._updateOverlayOpacity(this._curEyePos)},t.prototype._updateClippingExtent=function(){if(!this.spatialReference)return!1;var e=[0,0,0,0],t=null;return g.extentToBoundingRect(this._view.clippingArea,e,this.spatialReference)&&(t=e),s.equals(t,this._clippingExtent)?!1:(this._clippingExtent=t,this._renderer.clippingExtent=t,this.notifyChange("extent"),!0)},t.prototype._clippingChanged=function(){this._updateClippingExtent()&&this._updateRootTiles()},t.prototype._getLodBias=function(){return Math.round(this._view.qualitySettings.tiledSurface.lodBias)},t.prototype._getLodBiasCorrectedScale=function(e){var t=this.tilingScheme.levels,i=y.clamp(e-this._getLodBias(),0,t.length-1);return t[i].scale},t.prototype._cancelTilemapRequests=function(e){for(var t=0;t<x.LayerClass.LAYER_CLASS_COUNT;t++){var i=e.layerInfo[t];if(i)for(var r=0;r<i.length;r++){var a=i[r];a.tilemapRequest&&(a.tilemapRequest.cancel(),a.tilemapRequest=null)}}},t.prototype._removeAllTiles=function(){var e=this;this.rootTiles&&(this.rootTiles.forEach(function(t){e._purgeChildTiles(t),e._purgeTile(t)}),this._set("rootTiles",null),this.notifyChange("ready"));for(var t=0;t<this._topLevelTilemapOnlyTiles.length;t++){var i=this._topLevelTilemapOnlyTiles[t];this._cancelTilemapRequests(i)}this.setVisibility(!1)},t.prototype._purgeChildTiles=function(e){var t=this._postorderIterator;for(t.reset(e);!t.done;){for(var i=t.next(),r=0;4>r;r++)i.children[r]=null;i!==e&&this._purgeTile(i)}},t.prototype._purgeTile=function(e){e.unload(this._renderer),this._cancelTilemapRequests(e),e.parent=null,this._releaseTile(e)},t.prototype._splitTile=function(e){var t=e.lij[0]+1,i=2*e.lij[1],r=2*e.lij[2];e.children[0]=this._createTile(t,i,r,e),e.children[1]=this._createTile(t,i,r+1,e),e.children[2]=this._createTile(t,i+1,r,e),e.children[3]=this._createTile(t,i+1,r+1,e),e.unload(this._renderer),$.spatialReference=this.spatialReference,$.extent=e.extent,$.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",$)},t.prototype._createTile=function(e,t,i,r){j(!!r,"_createTile sanity check");var a=this._acquireTile(e,t,i,r);if(a.updateClippingStatus(this._clippingExtent),a.updateVisibility(this._curFrustumPlanes,this._curEyePos),a.visible){a.updateScreenDepth(this._viewProjectionMatrix);var n=a.shouldSplit(this._curSplitLimits,this._curEyePos);n===Y.SPLIT&&(a.pendingUpdates|=Y.SPLIT,this._pendingUpdates=!0)}return this._loadTile(a),a},t.prototype._mergeTile=function(e){j(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._purgeChildTiles(e),$.spatialReference=this.spatialReference,$.extent=e.extent,$.scale=this._getLodBiasCorrectedScale(e.lij[0]),this.emit("scale-change",$)},t.prototype._loadTile=function(e){e.load(this._renderer),this.overlayManager&&this.overlayManager.hasOverlays()&&this.overlayManager.setOverlayParamsOfTile(e,e.renderData,this._curOverlayOpacity),J.tile=e,J.spatialReference=this.tilingScheme.spatialReference,this.emit("tile-geometry-change",J)},t.prototype._handleHasHighlights=function(e){this._renderer.setNeedsHighlight(e)},t.prototype._decodeElevation=function(e){var t=x.LayerClass.ELEVATION,i=e.layerInfo[t];if(i)for(var r=0;r<i.length;r++){var a=i[r];if(a.pendingUpdates&=~Y.DECODE_ELEVATION,a.rawData){var n=e.decodeElevationData(a.rawData);if(a.rawData=null,n){a.data=n;var s=e.lij[0],l=this._iteratorPool.acquire();for(l.reset(e);!l.done;){var o=l.next();o.findElevationBoundsForLayer(r,s),o.computeElevationBounds()}this._iteratorPool.release(l),e.dataArrived(r,t,n),this._updateTiles(e),Q.spatialReference=this.spatialReference,Q.extent=e.extent,this._emitElevationChange(Q)}}}},t.prototype._handleLayerViewChanges=function(e){var t=this,i=!1;e.added.forEach(function(e){var r=e.layer;O.isTiledLayerView(e)?(t._registerTiledLayer(e),r.loaded&&(i=!0)):e.supportsDraping&&t.overlayManager&&t.overlayManager.registerLayerView(e)}),e.removed.forEach(function(e){O.isTiledLayerView(e)?(i=!0,t._unregisterTiledLayerView(e.uid)):e.supportsDraping&&t.overlayManager&&t.overlayManager.unregisterLayerView(e)}),i=i||e.moved.filter(O.isTiledLayerView).length>0,i&&this._updateTiledLayers()},t.prototype._registerTiledLayer=function(e){var t=this,i=[];i.push(e.watch("suspended",function(){t._updateTiledLayers()})),i.push(e.watch("fullOpacity",function(){return t._updateTileTextures()})),e.on("data-changed",function(){var i=O.isElevationLayerView(e)?x.LayerClass.ELEVATION:x.LayerClass.MAP,r=t._layerIndexByLayerViewId[i][e.uid];null!=r&&t._invalidateLayerData(r,i)}),this._basemapLayerViewHandles[e.uid]=i},t.prototype._unregisterTiledLayerView=function(e){var t=this._basemapLayerViewHandles[e];if(t){for(var i=0;i<t.length;i++)t[i].remove();delete this._basemapLayerViewHandles[e]}},t.prototype._updateTiledLayers=function(){var e=this;if(this.tilingScheme){var t=this._view.allLayerViews,i=[[],[]],r=x.LayerClass,a=null,n=c.create(c.NEGATIVE_INFINITY),s=function(t){var s=t.layer;if(t.layer&&t&&!t.suspended&&O.isTiledLayerView(t)){var l=t.fullExtent;if(l){if(!e.tilingScheme.compatibleWith(t.tileInfo))return void B.warn("Terrain: tiling scheme of layer "+s.id+" is incompatible with other tiled layers, will not be drawn");c.expand(n,l),O.isElevationLayerView(t)?i[r.ELEVATION].push(t):(t.maxDataLevel!==1/0&&(null===a||t.maxDataLevel>a)&&(a=t.maxDataLevel),i[r.MAP].push(t))}else B.warn("Terrain: Map or elevation layer does not have fullExtent: "+s.id)}};t.forEach(s,this);for(var l=function(e){var t=o._layerViews[e],a=i[e];a.reverse();var n=t.length!==a.length,s=a.length,l=new Array(s),p=new Array(t.length);o._layerIndexByLayerViewId[e]={};for(var h=0;s>h;h++){var d=a[h].uid;o._layerIndexByLayerViewId[e][d]=h;var u=t.indexOf(a[h]);l[h]=u,h!==u&&(n=!0),u>-1&&(p[u]=h)}if(n){o._topLevelTilemapOnlyTiles.forEach(function(t){return t.modifyLayers(p,l,e)});var c=o._postorderIterator;if(o.rootTiles)for(c.reset(o.rootTiles);!c.done;)c.next().modifyLayers(p,l,e);if(o._layerViews[e]=a,o.rootTiles){for(c.reset(o.rootTiles);!c.done;){var _=c.next();_.restartAgents(e),e===r.ELEVATION&&_.computeElevationBounds()}o._updateTiles(o.rootTiles)}e===r.ELEVATION&&o.tilingScheme&&(Q.spatialReference=o.tilingScheme.spatialReference,Q.extent=H,o._emitElevationChange(Q))}},o=this,p=0;p<r.LAYER_CLASS_COUNT;p++)l(p);this.tilingScheme.levels.length-1<a&&(this.tilingScheme.ensureMaxLod(a),this._viewChangeUpdate())}},t.prototype._emitElevationChange=function(e){this.emit("elevation-change",e)},t.prototype._hasFixedExtent=function(){return!!this._clippingExtent},t.prototype.layerViewByIndex=function(e,t){return this._layerViews[t][e]},t.prototype.numLayers=function(e){return this._layerViews[e].length},t.prototype.numTotalLayers=function(){return this._layerViews.reduce(function(e,t){return t.length+e},0)},t.prototype._updateTileTextures=function(){var e=this._iteratorPool.acquire();for(e.reset(this.rootTiles);!e.done;)e.next().updateTexture();this._iteratorPool.release(e)},t.prototype._invalidateLayerData=function(e,t){var i=this._iteratorPool.acquire();for(i.reset(this.rootTiles);!i.done;)i.next().removeLayerAgent(e,t);for(i.reset(this.rootTiles);!i.done;)i.next().invalidateLayerData(e,t);this._iteratorPool.release(i)},t.prototype.requestTileData=function(e,t,i){var r=this;this.tilemapStats.tilesRequested++;var a=this.layerViewByIndex(t,i),n=a.layer;if(n.tilemapCache){var s=this.getTilemapTile(e),l=s.layerInfo[i][t];if(!l.tilemap){l.tilemapRequest||(l.tilemapRequest=this.requestTilemap(s,t,i,a,n));var o,p=new f.Promise(function(){o&&o.cancel()});return l.tilemapRequest.always(function(){if(l.tilemapRequest=null,!p.isCancelled()){var t=r._layerIndexByLayerViewId[i][a.uid];null!=t&&(s.tileDataAvailable(e,t,i)?(o=r._requestTileData(e,t,i,a),o.then(function(){return p.resolve()})):(r.tilemapStats.tilesNotPresent++,r._dispatchDataEvent(e,"dataMissing",i,a,{notInTilemap:!0}),p.reject()))}}),p}if(!s.tileDataAvailable(e,t,i)){this.tilemapStats.tilesNotPresent++,this._dispatchDataEvent(e,"dataMissing",i,a,{notInTilemap:!0});var h=new f.Promise;return h.reject(),h}}return this._requestTileData(e,t,i,a)},t.prototype._requestTileData=function(e,t,i,r){return this.tilemapStats.tileRequestsSent++,i===x.LayerClass.ELEVATION?this._requestElevationTileData(e,t,i,r):this._requestMapTileData(e,t,i,r)},t.prototype._requestElevationTileData=function(e,t,i,r){function a(t){var a=l._layerIndexByLayerViewId[i][r.uid];if(null!=a){var n=e.layerInfo[i][a];n.rawData=t,e.pendingUpdates|=Y.DECODE_ELEVATION,n.pendingUpdates|=Y.DECODE_ELEVATION,l._pendingUpdates=!0}else B.warn("TerrainSurface: received data from unknown layer %d %s",i,e.lij.toString())}function n(t){V(t)||(l.tilemapStats.tileRequestErrors++,l._dispatchDataEvent(e,"dataMissing",i,r,t))}var s,l=this;if(O.isElevationLayerView(r)){var o=r.layer;if(O.useFetchTileForLayer(o))s=o.fetchTile(e.lij[0],e.lij[1],e.lij[2],x.ELEVATION_NODATA_VALUE),s.then(function(e){return a(e)},n);else{var p=r.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);s=this._streamDataSupplier.request(p,"binary"),s.then(function(e,t){t.url=e,a(t)},n)}}else j(!1,"_requestElevationTileData can only be called for elevation layer views");return s},t.prototype._requestMapTileData=function(e,t,i,r){function a(t){l._dispatchDataEvent(e,"dataArrived",i,r,t)}function n(t){V(t)||(l._dispatchDataEvent(e,"dataMissing",i,r,t),l.tilemapStats.tileRequestErrors++)}var s,l=this;if(O.isVectorTileLayerView(r)){var o=r.tileHandler,p=r.schemeHelper.getCompatibleLevelRowCol(e.lij);s=o.getVectorTileWithLRC(p[0],p[1],p[2],0),s.then(a).otherwise(n).always(function(){l._vectorTileLayerRequests=o.ongoingRequestCount}),this._vectorTileLayerRequests=o.ongoingRequestCount}else if(O.useFetchTileForLayer(r.layer)&&O.isTileLayerView(r)){var h=r.layer;s=h.fetchTile(e.lij[0],e.lij[1],e.lij[2]),s.then(a).otherwise(n)}else{var d=r.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);s=this._streamDataSupplier.request(d,"image"),s.then(function(e,t){return a(t)},n)}return s},t.prototype.requestTilemap=function(e,t,i,r,a){var n=this,s=e.lij[0]+x.TILEMAP_SIZE_EXP,l=e.lij[1]<<x.TILEMAP_SIZE_EXP,o=e.lij[2]<<x.TILEMAP_SIZE_EXP;return this.tilemapStats.tilemapRequestsSent++,this.tilemapStats.tilemapRequestsPending++,a.tilemapCache.fetchTilemap(s,l,o,{timeout:6e3}).then(function(a){n.tilemapStats.tilemapRequestsPending--,t=n._layerIndexByLayerViewId[i][r.uid],null!=t&&(e.layerInfo[i][t].tilemap=a)}).otherwise(function(e){n.tilemapStats.tilemapRequestsPending--,n.tilemapStats.tilemapRequestErrors++})},t.prototype.getTilemapTile=function(e){var t=e.lij[0];return t>x.TILEMAP_SIZE_EXP?U.getTileNLevelsUp(e,x.TILEMAP_SIZE_EXP):this._topLevelTilemapOnlyTiles[t]},t.prototype._dispatchDataEvent=function(e,t,i,r,a){var n=this._layerIndexByLayerViewId[i][r.uid];null!=n?e[t](n,i,a):B.warn("TerrainSurface: received data from unknown layer")},t.prototype._updateTileOverlayParams=function(){if(this.rootTiles){var e=this._iteratorPool.acquire();for(e.reset(this.rootTiles);!e.done;){var t=e.next();t.renderData&&this.overlayManager&&this.overlayManager.setOverlayParamsOfTile(t,t.renderData,this._curOverlayOpacity)}this._iteratorPool.release(e),this._renderer.setNeedsRender()}},t.prototype._updateOverlayOpacity=function(e){if(this.overlayManager){var t=this.overlayManager.updateOpacity(e);if(!isNaN(t)){if(t!==this._curOverlayOpacity&&this.rootTiles){var i=this._iteratorPool.acquire();for(i.reset(this.rootTiles);!i.done;){var r=i.next();r.renderData&&r.renderData.overlayTexId&&(r.renderData.overlayOpacity=t)}this._iteratorPool.release(i)}this._curOverlayOpacity=t,this._renderer.setNeedsRender()}}},t.prototype.getStats=function(){var e=0,t=0,i=0,r=[],a=this._iteratorPool.acquire();for(a.reset(this.rootTiles);!a.done;){var n=a.next();if(e++,n.renderData&&(t++,n.visible)){i++;var s=n.lij[0];r[s]=null!=r[s]?r[s]+1:1}}return this._iteratorPool.release(a),{numNodes:e,numLeaves:t,numVisible:i,numVisiblePerLevel:r}},t.prototype.getTile=function(e){var t=e.split("/").map(function(e){return+e});if(0===t[0])return this.rootTiles.forEach(function(e){return e.lij[1]===t[1]&&e.lij[2]===t[2]?e:void 0}),null;var i,r=Math.pow(2,t[0]),a=Math.floor(t[1]/r),n=Math.floor(t[2]/r);if(this.rootTiles.some(function(e){return e.lij[1]===a&&e.lij[2]===n?(i=e,!0):!1}),i){for(var s=1<<t[0]-1;i.lij[0]<t[0];){var l=t[1]&s?2:0;if((t[2]&s)>0&&l++,!i.children[l])return console.log("Tile "+e+" doesn't exist, smallest ancestor is "+U.tile2str(i)),null;i=i.children[l],s>>=1}return j(i.lij[0]===t[0]&&i.lij[1]===t[1]&&i.lij[2]===t[2],"not the right tile?"),i}return null},t.prototype.hasPendingUpdates=function(){if(this._streamDataSupplier.hasPendingDownloads()||0!==this._vectorTileLayerRequests)return!0;var e=this._iteratorPool.acquire();for(e.reset(this.rootTiles);!e.done;){var t=e.next();if(t.pendingUpdates>0)return this._iteratorPool.release(e),!0}return this._iteratorPool.release(e),!1},t.prototype.setBorders=function(e){this._renderer.setBorders(e)},t.prototype.setDisableRendering=function(e){this._renderer.setDisableRendering(e)},r([a.property({value:!1})],t.prototype,"cullBackFaces",null),r([a.property({readOnly:!0})],t.prototype,"extent",null),r([a.property({value:!1})],t.prototype,"frontMostTransparent",null),r([a.property({readOnly:!0})],t.prototype,"loaded",void 0),r([a.property({value:1})],t.prototype,"opacity",null),r([a.property({readOnly:!0})],t.prototype,"overlayManager",void 0),r([a.property({readOnly:!0})],t.prototype,"manifold",void 0),r([a.property()],t.prototype,"maxTextureScale",void 0),r([a.property({readOnly:!0})],t.prototype,"ready",null),r([a.property({value:1})],t.prototype,"renderOrder",null),r([a.property({readOnly:!0})],t.prototype,"rootTiles",void 0),r([a.property({value:!0})],t.prototype,"skirts",null),r([a.property({readOnly:!0,aliasOf:"tilingScheme.spatialReference"})],t.prototype,"spatialReference",void 0),r([a.property({value:x.DEFAULT_TILE_BACKGROUND})],t.prototype,"tileBackground",null),r([a.property({readOnly:!0})],t.prototype,"tilingScheme",void 0),r([a.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],t.prototype,"tilingSchemeLocked",void 0),r([a.property({readOnly:!0})],t.prototype,"tilingSchemeLogic",void 0),r([a.property({value:!0})],t.prototype,"velvetOverground",null),r([a.property({value:!1})],t.prototype,"wireframe",null),t=r([a.subclass("esri.views.3d.terrain.TerrainSurface")],t)}(a.declared(n,_.Evented)),F=1.2,k=80/180*Math.PI,H=[-(1/0),-(1/0),1/0,1/0],G=x.MAX_ROOT_TILES,X=12,Y=x.TileUpdateTypes,W=M.create(),Z=[0,0,0],z=new Array(10),K=new Array(10),J={spatialReference:null,tile:null},Q={spatialReference:null,extent:null},$={spatialReference:null,extent:null,scale:0};return N});