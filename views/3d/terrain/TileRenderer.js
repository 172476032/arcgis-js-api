// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../lib/glMatrix","./TerrainConst","../webgl-engine/lib/DefaultVertexAttributeLocations","../webgl-engine/lib/DefaultVertexBufferLayouts","../../vectorTiles/tileRendererHelper3D","../../vectorTiles/VectorTileDisplayObject","../../webgl/BufferObject","../../webgl/FramebufferObject","../../webgl/Texture","../../webgl/Util","../../webgl/VertexArrayObject"],function(e,t,r,i,a,s,n,o,l,d,h,p,u){var c=r.vec2d,f=new Array(20),x=[0,0];return function(){function e(e,t,r,i,n){this._gridTex=null,this.tileSize=256,this._context=e,this.tileSize=t,this._resourceCounter=i,this._setNeedsRender=n,e.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=Math.min(8,e.parameters.maxMaxAnisotropy));var o=new Float32Array(20);o[0]=-1,o[1]=-1,o[2]=0,o[3]=0,o[4]=0,o[5]=1,o[6]=-1,o[7]=0,o[8]=1,o[9]=0,o[10]=-1,o[11]=1,o[12]=0,o[13]=0,o[14]=1,o[15]=1,o[16]=1,o[17]=0,o[18]=1,o[19]=1,this._vaoQuad=new u(e,a.Default3D,{geometry:s.Pos3Tex},{geometry:l.createVertex(e,35044,o)}),this._blendLayersProgram=r.get("blendLayers")}return e.prototype.dispose=function(){this._fbo&&(this._fbo.dispose(),this._fbo=null),this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null),this._gridTex&&(this._gridTex.dispose(),this._gridTex=null),this._blendLayersProgram&&(this._blendLayersProgram.dispose(),this._blendLayersProgram=null),this._context&&(this._context=null)},e.prototype.updateTileTexture=function(e){for(var t=i.LayerClass.MAP,r=e.layerInfo[t],a=0;a<r.length;a++)r[a].pendingUpdates&=~i.TileUpdateTypes.UPDATE_TEXTURE;if(e.renderData){var s,n,o,l,d=e.renderData,h=0,p=!0;for(l=0;l<r.length;l++){s=r[l];var u=e.parentSurface.layerViewByIndex(l,t),x=u.fullOpacity;if(f[l]=x,(s.data||s.upsampleFromTile)&&(h++,!u.isTransparent)){p=!1;break}}l===r.length&&l--,0===h&&this._gridTex?(d.textureReference=this._gridTex,c.set2(0,0,d.texOffset),d.texScale=1):1!==h||p?(this._composeMapLayers(e,r,l,p,f),d.textureReference=null,c.set2(0,0,d.texOffset),d.texScale=1):(s=r[l],s.data?(n=s,c.set2(0,0,d.texOffset),d.texScale=1):(o=s.upsampleFromTile,n=o.tile.layerInfo[t][l],c.set(o.offset,d.texOffset),d.texScale=o.scale),n&&(n.data instanceof HTMLImageElement&&(n.data=this._buildTexture(n.data)),d.textureReference=n.data)),this._setNeedsRender()}},e.prototype.setGridImage=function(e){this._gridTex=this._buildTexture(e)},e.prototype._buildTexture=function(e){var t,r={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},i=this._context;if(e)try{t=new h(i,r,e)}catch(e){r.width=r.height=this.tileSize,t=new h(i,r),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}else r.width=r.height=this.tileSize,t=new h(i,r);return i.bindTexture(t),t.generateMipmap(),t},e.prototype._drawVectorData=function(e,t,r,i,a,s,o,l,d){void 0===d&&(d=1),n(this._context,r,e,t.renderer,t.schemeHelper,r[0],i,a,0,s,o,l,d)},e.prototype._drawRasterData=function(e,t,r,i){void 0===i&&(i=1);var a=this._context,s=this._blendLayersProgram,n=this._vaoQuad;a.bindProgram(s),a.bindVAO(n),p.assertCompatibleVertexAttributeLocations(n,s),a.bindTexture(e,0),s.setUniform1i("tex",0),s.setUniform1f("scale",t),s.setUniform2f("offset",r[0],r[1]),s.setUniform1f("opacity",i),a.drawArrays(5,0,p.vertexCount(n,"geometry"))},e.prototype._composeMapLayers=function(e,t,r,a,s){var n=i.LayerClass.MAP,l=this._context;e.renderData.texture||(e.renderData.texture=this._buildTexture());var h=e.renderData.texture,p=this._fbo;p&&p.width===h.descriptor.width&&p.height===h.descriptor.height||(p=d.create(l,{colorTarget:0,depthStencilTarget:1,width:h.descriptor.width,height:h.descriptor.height}),this._fbo=p);var u=l.gl;l.bindFramebuffer(p),l.setViewport(0,0,this.tileSize,this.tileSize),l.setClearColor(0,0,0,0),l.setClearDepth(1),l.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT),l.setDepthTestEnabled(!1),l.setBlendFunctionSeparate(1,771,1,771),l.setBlendEquation(32774),l.setBlendingEnabled(!0);var c,f,g,_;a&&this._gridTex&&this._drawRasterData(this._gridTex,1,x);for(var m=r;m>=0;m--){var T=null;if(c=t[m],c.data)T=c,f=x,g=1;else if(c.upsampleFromTile){var b=c.upsampleFromTile;T=b.tile.layerInfo[n][m],_=b.tile.lij[0],f=b.offset,g=b.scale}if(T)if((T.data instanceof HTMLImageElement||T.data instanceof HTMLCanvasElement)&&(T.data=this._buildTexture(T.data)),T.data instanceof o){var y=e.parentSurface.layerViewByIndex(m,n);this._drawVectorData(T.data,y,e.lij,h.descriptor.width,h.descriptor.height,g,f,_,s[m])}else this._drawRasterData(T.data,g,f,s[m])}l.bindTexture(h),u.copyTexImage2D(l.gl.TEXTURE_2D,0,h.descriptor.pixelFormat,0,0,h.descriptor.width,h.descriptor.height,0),h.generateMipmap(),l.bindFramebuffer(null),l.setBlendFunctionSeparate(770,771,1,771),l.setBlendingEnabled(!1),this._resourceCounter.incrementNumTileTexturesComposited()},e}()});