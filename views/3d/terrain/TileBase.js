// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["./terrainUtils","./tileUtils","./TerrainConst","./ElevationData","./TilePerLayerInfo","./ElevationTileAgent","./MapTileAgent","../support/mathUtils","../lib/glMatrix","../../../core/arrayUtils"],function(e,t,i,n,a,r,s,l,o,h){function p(e){return e===i.LayerClass.ELEVATION?r:s}var d=o.vec3d,u=o.vec2d,g=o.vec4d,f=o.mat4d,c=e.weakAssert,v=d.create(),y=g.create(),A=g.create(),E=d.create(),T=s.AGENT_DONE,m=i.LayerClass.LAYER_CLASS_COUNT,I=i.LayerClass.MAP,L=i.LayerClass.ELEVATION,D=i.TileUpdateTypes,U=function(e,t,i){this.lij=[0,0,0],this.extent=g.create(),this.extentWGS84Rad=g.create(),this.centerAtSeaLevel=d.create(),this.center=d.create(),this.tileUp=E,this.elevationBounds=u.create(),this.children=[null,null,null,null],this.layerInfo=new Array(m),this.isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this._maxTesselation=0};return U.prototype.init=function(e,t,n,r){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],r.getExtent(e[0],e[1],e[2],this.extent,this.extentWGS84Rad),this.isWithinClippingArea=!0,this.intersectsClippingArea=!0,this.clippingArea=null,this.edgeLen=0,this.radius=0,this.vlevel=e?e[0]:0,t&&t.elevationBounds?u.set(t.elevationBounds,this.elevationBounds):u.set2(0,0,this.elevationBounds),this.parent=t;for(var s=0;s<4;s++)this.children[s]=null;this.pendingUpdates=0,this.renderData=null,this.screenDepth=0,this.renderOrder=0,this.visible=!1,this.parentSurface=n;for(var l=0;l<m;l++)if(n){var o,h=n.numLayers(l);this.layerInfo[l]?(o=this.layerInfo[l],o.length=h):(o=new Array(h),this.layerInfo[l]=o);for(var p=0;p<h;p++)o[p]=a.makeEmptyLayerInfo(l,o[p]),l==L&&this.findElevationBoundsForLayer(p,-1)}else this.layerInfo[l]=null;this.computeElevationBounds(),this._maxTesselation=Math.min(r.pixelSize[0],i.MAX_TILE_TESSELATION)},U.prototype.dispose=function(){for(var e=0;e<m;e++)for(var t=this.layerInfo[e],i=0;i<t.length;i++)t[i].dispose()},U.prototype.updateScreenDepth=function(e){d.set(this.center,A),A[3]=1,f.multiplyVec4(e,A,A),this.screenDepth=A[2]/A[3]},U.prototype.shouldSplit=function(e,t){var i=this.lij[0];d.subtract(this.center,t,v);var n=d.length(v),a=e[0],r=e[2],s=a*n*2,o=r*n*2,h=this.edgeLen/s,p=this.edgeLen/o,u=e[1],g=e[3],f=e[4],c=e[5];if(h<u)return this.vlevel!==this.lij[0]?(this.vlevel=this.lij[0],D.VSPLITMERGE):D.NONE;if(i>=f){var A=i+Math.ceil(-l.log2(u/h));return A!==this.vlevel?(this.vlevel=A,D.VSPLITMERGE):D.NONE}if(i>6&&(d.scale(this.tileUp,d.dot(this.tileUp,v),y),d.subtract(y,v),d.length2(y)>this.radius*this.radius)){d.scale(y,this.radius/d.length(y)),d.add(y,this.center),d.subtract(t,y,y);var E=this.elevationBounds[1]-this.elevationBounds[0];if(Math.min(1,(Math.abs(d.dot(y,this.tileUp))+.5*E+this.curvatureHeight)/d.length(y))*p<.1/c*g)return D.NONE}return D.SPLIT},U.prototype.decodeElevationData=function(e){var t;if(e instanceof ArrayBuffer)try{t=n.createFromLERC(this.lij,this.extent,e,i.noDataValueOpt)}catch(t){console.warn("Error decoding %s: %s",e.url,t.message)}else t=n.createFromFetchTileResult(this.lij,this.extent,e);return t},U.prototype.getWGS84Extent=function(){return this.extentWGS84Rad.map(l.rad2deg)},U.prototype.load=function(e){for(var t=0;t<m;t++)this.layerInfo[t]&&this._createOrUpdateAgents(0,t);e.loadTile(this)},U.prototype.unload=function(e){this.renderData&&e.unloadTile(this);for(var t=0;t<m;t++)for(var n=this.layerInfo[t],a=0;a<n.length;a++){var r=n[a];if(r.loadingAgent&&r.loadingAgent!==T){r.loadingAgent.dispose();var s=p(t);s.Pool.release(r.loadingAgent),r.loadingAgent=null}r.pendingUpdates=0}this.pendingUpdates&=~i.TileUpdateTypes.UPDATE_GEOMETRY,this.pendingUpdates&=~i.TileUpdateTypes.UPDATE_TEXTURE},U.prototype.updateClippingStatus=function(e){if(h.equals(e,this.clippingArea))return!1;var t=this.intersectsClippingArea,i=this.isWithinClippingArea;e?(this.intersectsClippingArea=this.intersectsExtent(e),this.isWithinClippingArea=this.isWithinExtent(e)):(this.intersectsClippingArea=!0,this.isWithinClippingArea=!0),this.clippingArea=e;var n=i&&this.isWithinClippingArea,a=!(i||t||this.isWithinClippingArea||this.intersectsClippingArea);return!this.renderData||n||a||this.updateGeometry(),!0},U.prototype.updateVisibility=function(e,t,i){var n=(i||this.isVisible(e,t))&&this.intersectsClippingArea;if(n!==this.visible){this.visible=n;for(var a=this.layerInfo[0],r=0;r<a.length;r++){var s=a[r];s.loadingAgent&&s.loadingAgent!==T&&s.loadingAgent.setSuspension(!n)}}return n},U.prototype.getLayerInfo=function(e,t){return this.layerInfo[t][e]},U.prototype.hasLayerData=function(e,t){var i=this.layerInfo[t][e];return i&&i.data&&!i.dataInvalidated},U.prototype.tileDataAvailable=function(e,t,i){var n=this.layerInfo[i][t].tilemap;return!n||"unavailable"!==n.getAvailability(e.lij[1],e.lij[2])},U.prototype.requestLayerData=function(e,t,n){i.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d requested by tile %s",this.lij.toString(),t,e,n.tile.lij.toString());var a=this.layerInfo[t][e];if(a.waitingAgents.indexOf(n)>-1)return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),n.tile.lij.toString(),t,e),!0;if(a.data&&!a.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),n.tile.lij.toString(),t,e),a.waitingAgents.push(n),setTimeout(n.dataArrived.bind(n,this),0),!0;if(a.pendingUpdates&D.DECODE_ELEVATION)return a.waitingAgents.push(n),!0;if(a.waitingAgents.push(n),!a.requestPromise){var r=this.parentSurface.requestTileData(this,e,t);if(r.isFulfilled())return!1;var s=function(){a.requestPromise===r&&(a.requestPromise=null)};return a.requestPromise=r,r.then(s,s),!!r}return!0},U.prototype.descendants=function(e){e||(e=[]);for(var t=0;t<4;t++){var i=this.children[t];i&&(i.descendants(e),e.unshift(this.children[t]))}return e},U.prototype.isLij=function(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]==e[2]},U.prototype.findByLij=function(e){if(this.isLij(e))return this;for(var t=0;t<4;t++){var i=this.children[t];if(i){var n=i.findByLij(e);if(n)return n}}return null},U.prototype.unrequestLayerData=function(t,n,a){i.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d canceled by tile %s",this.lij.toString(),n,t,a.tile.lij.toString());var r=this.layerInfo[n][t],s=r.waitingAgents,l=s.indexOf(a);if(c(l>-1,"agent has not requested this piece of map data"),s[l]=s[s.length-1],--s.length<1){var o=r.requestPromise,h=!1;if(n===I){var p=this.parentSurface.layerViewByIndex(t,I);h=e.isVectorTileLayerView(p)}h||c(o||r.rawData,"no pending operations on layerInfo that agents were waiting for"),o&&!o.isFulfilled()&&(o.cancel(),r.requestPromise=null),i.TILE_LOADING_DEBUGLOG&&console.log("tile %s layer %d/%d request/loading canceled",this.lij.toString(),n,t)}},U.prototype.dataArrived=function(e,t,i){var n=this.layerInfo[t][e];n.data=i,n.dataInvalidated=!1;for(var a=0;a<n.waitingAgents.length;a++)n.waitingAgents[a].dataArrived(this);n.waitingAgents.length=0},U.prototype.dataMissing=function(e,t,i){i.notInTilemap||console.error("Tile %s layer %d/%d error",this.lij.toString(),t,e);var n=this.layerInfo[t][e];n.dataMissing=!0;for(var a=0;a<n.waitingAgents.length;a++)n.waitingAgents[a].dataMissing(this);n.waitingAgents.length=0},U.prototype.updateTexture=function(e){this.renderData&&(e?this.parentSurface._renderer.updateTileTexture(this):(this.pendingUpdates=this.pendingUpdates|i.TileUpdateTypes.UPDATE_TEXTURE,this.parentSurface._pendingUpdates=!0))},U.prototype.invalidateLayerData=function(e,t){this.layerInfo[t][e].invalidateSourceData(),this.restartAgents(t)},U.prototype.computeElevationBounds=function(){u.set2(Number.MAX_VALUE,-Number.MAX_VALUE,this.elevationBounds);for(var e=this.layerInfo[L],t=!1,i=0;i<e.length;i++){var n=e[i];n.elevationBounds&&(this.elevationBounds[0]=Math.min(this.elevationBounds[0],n.elevationBounds[0]),this.elevationBounds[1]=Math.max(this.elevationBounds[1],n.elevationBounds[1]),t=!0)}t||u.set2(0,0,this.elevationBounds),this.updateRadiusAndCenter()},U.prototype.updateRadiusAndCenter=function(){var e=.5*(this.elevationBounds[0]+this.elevationBounds[1]);d.scale(this.tileUp,e,y),d.add(this.centerAtSeaLevel,y,this.center)},U.prototype.findElevationBoundsForLayer=function(e,n){var a=this.layerInfo[L][e];if(!a.elevationBounds||a.elevationBounds[2]<n){var r=this.parentSurface.layerViewByIndex(e,L);if(t.fallsWithinLayer(this,r.layer,!1)){var s=y,l=!1;if(a.data)u.set(a.data.bounds,s),s[2]=this.lij[0],l=!0;else{for(var o=this.parent,h=0,p=null,g=a.data;o&&(!g||h<i.ELEVATION_DESIRED_RESOLUTION_LEVEL)&&(h=this.vlevel-o.lij[0],p=g||p,!(!(g=o.layerInfo[L][e].data)&&p&&h>=i.ELEVATION_DESIRED_RESOLUTION_LEVEL));)o=o.parent;g=g||p,g&&(g.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],s),s[0]!==1/0&&(s[2]=g.level,l=!0))}l&&(a.elevationBounds?d.set(s,a.elevationBounds):a.elevationBounds=[s[0],s[1],s[2]])}}},U.prototype.updateGeometry=function(){this.pendingUpdates=this.pendingUpdates|i.TileUpdateTypes.UPDATE_GEOMETRY,this.parentSurface._pendingUpdates=!0},U.prototype.modifyLayers=function(e,t,i){for(var n=t.length,r=this.layerInfo[i],s=new Array(n),l=0;l<r.length;l++){var o=r[l];if(o.loadingAgent&&o.loadingAgent!==T){o.loadingAgent.dispose();p(i).Pool.release(o.loadingAgent),o.loadingAgent=null}o.waitingAgents.length=0}if(i===I)for(var h=0;h<r.length;h++)if(void 0===e[h]){var d=r[h];d.dispose()}for(l=0;l<n;l++){var u=t[l];s[l]=u>-1?r[u]:a.makeEmptyLayerInfo(i)}this.layerInfo[i]=s},U.prototype.restartAgents=function(e){if(this.renderData)if(this._createOrUpdateAgents(0,e),e===L){this.updateGeometry();for(var t=this.layerInfo[e],n=0;n<t.length;n++)t[n].pendingUpdates|=i.TileUpdateTypes.UPDATE_GEOMETRY;this.parentSurface._pendingUpdates=!0}else this.updateTexture(!0)},U.prototype.updateAgents=function(e){if(this.renderData){for(var t=this.layerInfo[e],i=0;i<t.length;i++){var n=t[i];n.loadingAgent===T&&(n.loadingAgent=null)}this._createOrUpdateAgents(0,e)}},U.prototype.removeLayerAgent=function(e,t){var i=this.layerInfo[t][e];i.loadingAgent&&i.loadingAgent!==T&&i.loadingAgent.dispose(),i.loadingAgent=null},U.prototype.agentDone=function(e,t){var i=this.layerInfo[t],n=i[e];n.loadingAgent=T,n.data||n.upsampleFromTile||e<i.length-1&&this._createOrUpdateAgents(e+1,t)},U.prototype._createOrUpdateAgents=function(e,i){var n;n=i!==L&&!this.visible;for(var a=e,r=this.layerInfo[i];a<r.length;){var s=r[a],l=!1,o=this.parentSurface.layerViewByIndex(a,i);if(null!==s.loadingAgent&&s.loadingAgent!==T)l=s.loadingAgent.update();else if(s.loadingAgent!==T&&t.fallsWithinLayer(this,o.layer,!1)){var h=p(i),d=h.Pool.acquire();l=d.init(this,a,i,n),l?s.loadingAgent=d:(d.dispose(),h.Pool.release(d),s.loadingAgent=T)}if(l&&!o.isTransparent)break;a++}},U.prototype.geometryState=function(e){var t,n,a,r=this._getElevationInfo(e?e.samplerData:null),s=this.lij[0],o=!1;if(r.samplerData){t=this.vlevel-s,n=Math.max(s-r.maxTileLevel,i.ELEVATION_DESIRED_RESOLUTION_LEVEL-t);var p=this._maxTesselation;a=l.clamp(1+(p>>n),2,p+1)}else a=s<8?this._numSubdivisionsAtLevel[s]+1:2;var d=this.clippingArea;return this.intersectsClippingArea&&!this.isWithinClippingArea||(d=null),e?(e.numVertsPerRow!==a&&(e.numVertsPerRow=a,o=!0),r.changed&&(e.samplerData=r.samplerData,o=!0),h.equals(e.clippingArea,d)||(e.clippingArea=d,o=!0),e.needsUpdate=o):e={numVertsPerRow:a,samplerData:r.samplerData,needsUpdate:!0,clippingArea:d},e},U.prototype._getElevationInfo=function(e){for(var i=this.layerInfo[L],n=i.length,a=new Array(n),r=0,s=0,l=!1,o=0;o<n;o++){var h=i[o];if(h.upsampleFromTile){var p=h.upsampleFromTile.tile,d=p.layerInfo[L][o].data;e&&e[r]===d.samplerData||(l=!0),a[r++]=d.samplerData,s=Math.max(s,p.lij[0])}else if(h.data){var u=this.parentSurface.layerViewByIndex(o,L);t.fallsWithinLayer(this,u.layer,!1)&&(e&&e[r]===h.data.samplerData||(l=!0),a[r++]=h.data.samplerData,s=this.lij[0])}}return e&&e.length!==r&&(l=!0),r>0?a.length=r:a=null,{changed:l,samplerData:a,maxTileLevel:s}},U.prototype.isWithinExtent=function(e){var t=this.extent;return t[0]>=e[0]&&e[2]>=t[2]&&t[1]>=e[1]&&e[3]>=t[3]},U.prototype.intersectsExtent=function(e){var t=this.extent;return t[2]>=e[0]&&e[2]>=t[0]&&t[3]>=e[1]&&e[3]>=t[1]},U});