// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["../../../core/Error","../../../geometry/SpatialReference","../../../geometry/support/scaleUtils","../support/projectionUtils","../support/mathUtils"],function(e,i,t,r,l){function n(i,t){return new e(i,t)}var o=r.webMercator.x2lon,s=r.webMercator.y2lat,a=[0,0,0,0],h=function(e){var i=h._checkUnsupported(e);if(i)throw i;this.spatialReference=e.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isWGS84=this.spatialReference.isWGS84,this.origin=[e.origin.x,e.origin.y],this.pixelSize=[e.size[0],e.size[1]];var t=e.lods.reduce(function(e,i,t){return i.level<e.min&&(e.min=i.level,e.minIndex=t),e.max=Math.max(e.max,i.level),e},{min:1/0,minIndex:0,max:-1/0}),r=e.lods[t.minIndex],l=Math.pow(2,r.level),n=r.resolution*l,o=r.scale*l;this.levels=new Array(t.max+1);for(var s=0;s<this.levels.length;s++)this.levels[s]={resolution:n,scale:o,tileSize:[n*e.size[0],n*e.size[1]]},n/=2,o/=2};return h.prototype={getExtent:function(e,i,t,r,n){r=r||new Array(4);var a=this.levels[e],h=a.tileSize[0],u=a.tileSize[1];r[0]=this.origin[0]+t*h,r[2]=r[0]+h,r[3]=this.origin[1]-i*u,r[1]=r[3]-u,n&&(this._isWebMercator?(n[0]=o(r[0]),n[1]=s(r[1]),n[2]=o(r[2]),n[3]=s(r[3])):this._isWGS84&&(n[0]=l.deg2rad(r[0]),n[1]=l.deg2rad(r[1]),n[2]=l.deg2rad(r[2]),n[3]=l.deg2rad(r[3])))},ensureMaxLod:function(e){for(;this.levels.length<=e;){var i=this.levels[this.levels.length-1],t=i.resolution/2;this.levels.push({resolution:t,scale:i.scale/2,tileSize:[t*this.pixelSize[0],t*this.pixelSize[1]]})}},capMaxLod:function(e){this.levels.length>e+1&&(this.levels.length=e+1)},getMaxLod:function(){return this.levels.length-1},scaleAtLevel:function(e){return this.levels[0].scale/Math.pow(2,e)},levelAtScale:function(e){var i=this.levels[0].scale;return e>=i?0:Math.log(i/e)*Math.LOG2E},compatibleWith:function(e){if(!(e instanceof h)){if(h._checkUnsupported(e))return!1;e=new h(e)}if(!e.spatialReference.equals(this.spatialReference))return!1;if(e.pixelSize[0]!==this.pixelSize[0]||e.pixelSize[1]!==this.pixelSize[1])return!1;var i=Math.min(this.levels.length,e.levels.length)-1,t=this.levels[i].resolution,r=l.floatEqualAbsolute,n=.5*t;if(!r(e.origin[0],this.origin[0],n)||!r(e.origin[1],this.origin[1],n))return!1;var o=Math.max(this.pixelSize[0],this.pixelSize[1]);return n=.5*t/Math.pow(2,i)/o*12,r(t,e.levels[i].resolution,n)},rootTilesInExtent:function(e,i,t){var r=this.levels[0].tileSize;h.computeRowColExtent(e,r,this.origin,a);var l=a[1],n=a[3],o=a[0],s=a[2],u=s-o,c=n-l;if(u*c>t){var f=Math.floor(Math.sqrt(t));c>f&&(l=l+Math.floor(.5*c)-Math.floor(.5*f),n=l+f),u>f&&(o=o+Math.floor(.5*u)-Math.floor(.5*f),s=o+f)}for(var p=new Array((s-o)*(n-l)),v=0,g=l;g<n;g++)for(var m=o;m<s;m++)p[v++]=[0,g,m];return i&&(i[0]=this.origin[0]+o*r[0],i[1]=this.origin[1]-n*r[1],i[2]=this.origin[0]+s*r[0],i[3]=this.origin[1]-l*r[1]),p}},h.computeRowColExtent=function(e,i,t,r){var l=.001*(e[2]-e[0]+(e[3]-e[1]));r[0]=Math.floor((e[0]+l-t[0])/i[0]),r[2]=Math.ceil((e[2]-l-t[0])/i[0]),r[1]=Math.floor((t[1]-e[3]+l)/i[1]),r[3]=Math.ceil((t[1]-e[1]-l)/i[1])},h.isPowerOfTwo=function(e){var i=e.lods,t=i[0].resolution*Math.pow(2,i[0].level);return!i.some(function(e){return!l.floatEqualRelative(e.resolution,t/Math.pow(2,e.level))})},h.hasGapInLevels=function(e){var i=e.lods.map(function(e){return e.level});i.sort(function(e,i){return e-i});for(var t=1;t<i.length;t++)if(i[t]!==i[0]+t)return!0;return!1},h.tileSizeSupported=function(e){var i=e.size[1];return i===e.size[0]&&0==(i&i-1)&&i>=128&&i<=512},h._checkUnsupported=function(e){return e?e.lods.length<1?n("tilingscheme:generic","Tiling scheme must have at least one level"):h.isPowerOfTwo(e)?null:n("tilingscheme:power-of-two","Tiling scheme must be power of two"):n("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")},h.checkUnsupported=function(e){var i=h._checkUnsupported(e);return i||(h.hasGapInLevels(e)?n("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):h.tileSizeSupported(e)?null:n("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"))},h.fromExtent=function(e,i){var r=e[2]-e[0],l=e[3]-e[1],n=t.getMetersPerUnitForSR(i),o=1.2*Math.max(r,l),s=new h({size:[256,256],origin:{x:e[0]-.5*(o-r),y:e[3]+.5*(o-l)},lods:[{level:0,resolution:o/256,scale:1/(256/96*.0254/(o*n))}],spatialReference:i});return s.ensureMaxLod(20),s},h.WebMercatorAuxiliarySphereTileInfo={size:[256,256],origin:{x:-20037508.342787,y:20037508.342787},spatialReference:i.WebMercator,lods:[{level:0,resolution:156543.03392800014,scale:591657527.591555}]},h.makeWebMercatorAuxiliarySphere=function(e){e=null!=e?e:19;var i=new h(h.WebMercatorAuxiliarySphereTileInfo);return i.ensureMaxLod(e),i},h.WebMercatorAuxiliarySphere=h.makeWebMercatorAuxiliarySphere(19),h.makeWGS84WithTileSize=function(e,t){t=null!=t?t:16;var r=256/e,l=new h({size:[e,e],origin:{x:-180,y:90},spatialReference:i.WGS84,lods:[{level:0,resolution:.703125*r,scale:295497598.570834*r}]});return l.ensureMaxLod(t),l},h});