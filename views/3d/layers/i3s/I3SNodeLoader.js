// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","dojo/_base/lang","dojo/Deferred","dojo/errors/CancelError","../../webgl-engine/lib/Util","./I3SUtil","./I3SBinaryReader","../../../../core/promiseUtils","../../../../core/urlUtils"],function(e,t,r,a,n,i,o,u,l,s){var d=function(){function e(t,r,a,n,i){this.logger=r,this.defaultGeometrySchema=a,this.requiredAttributes=n,this.options=i,this.loadShared=function(t){if(null==t.sharedResource)return l.resolve({});var r=s.makeAbsolute(t.sharedResource.href,t.baseUrl);return this.loadJSON(r).then(function(t){return e.fixTextureEncodings(t),e.addAbsoluteHrefTexture(t,r),t})},this.loader=t,this.cancelled=!1}return e.prototype.cancel=function(){this.cancelled=!0},e.prototype.loadJSON=function(e){var t=this.loader.request(e,"json"),r=new a;return t.then(function(e,t){r.resolve(t)},function(t){r.reject(new Error("Failed to load: "+e))}),r.promise},e.prototype.loadBinary=function(e){var t=this.loader.request(e,"binary"),r=new a;return t.then(function(e,t){r.resolve(t)},function(t){r.reject(new Error("Failed to load: "+e))}),r.promise},e.prototype.loadImage=function(e){var t=this.loader.request(e,"image"),r=new a;return t.then(function(e,t){r.resolve(t)},function(t){r.reject(new Error("Failed to load: "+e))}),r.promise},e.prototype.loadAttribute=function(e,t,r){var a=s.makeAbsolute(r,e);return this.loadBinary(a).then(function(e){return u.readBinaryAttribute(t,e)})},e.prototype.loadAttributes=function(e,t,r){var a=this,n=r.map(function(r){return null==e.attributeData||null==e.attributeData[r.index]?(a.logger.error("Missing attributeData for '"+r.name+"' on node '"+e.id+"'"),l.resolve(null)):a.loadAttribute(t,r.attributeStorageInfo,e.attributeData[r.index].href).otherwise(function(t){return a.logger.error("Failed to load attributeData for '"+r.name+"' on node '"+e.id+"'"),null})});return l.all(n).then(function(e){for(var t={},a=0;a<r.length;++a)e[a]&&(t[r[a].name]=e[a]);return t})},e.prototype.prepareBinaryGeometryData=function(e,t,a,n){var i=e.geometries[0];if(r.mixin(i.params,a),n||null!=a.vertexAttributes.region||delete a.vertexAttributes.region,null!=a.featureAttributes){var l=a.featureAttributes;if(l.faceRange){var s=u.createTypedView(t,l.faceRange),d=l.faceRange.valuesPerElement,f=a.header.fields.featureCount;e.componentOffsets=o.convertFlatRangesToOffsets(s,f,d)}if(l.id){e.featureIds=[];var c=1,h=u.valueType2TypedArrayClassMap[l.id.valueType];"UInt64"===l.id.valueType&&(h=Uint32Array,c=2);for(var m=new h(t,l.id.byteOffset,l.id.count*l.id.valuesPerElement*c),p=0;p<a.header.fields.featureCount;p++)if(e.featureIds[p]=m[p*l.id.valuesPerElement*c],2===c){var g=m[p*l.id.valuesPerElement*c+1];if(g>=2097150)throw new Error("ID exceeded maximum range supported by javascript (max = 53bit-1 = 9007199254740991)");e.featureIds[p]+=4294967296*g}}}},e.prototype.loadBundleData=function(e,t){var r=this,a=e.baseUrl,n=null,i=this.loadShared(e),o=null;null!=this.requiredAttributes&&(o=this.loadAttributes(e,a,this.requiredAttributes));var d=null;if(null!=e.geometryData){var f=e.geometryData[t],c=s.makeAbsolute(f.href,a);d=this.loadBinary(c)}return i.then(function(a){r.handleCancelled();var i=r.options.loadFeatureData?r.loadFeatureData(e,t):l.resolve(null);return i.then(function(t){r.handleCancelled();var i,s=r.options.loadFeatureData?r.collectGeometries(e,t,a):r.meshPyramidGeometryData(e,a);i=null!=d?d.then(function(e){n=e;var t=Object.keys(a.materialDefinitions)[0],i=a.materialDefinitions[t].params.vertexRegions,o=u.createGeometryDataIndex(e,r.defaultGeometrySchema,i);return r.prepareBinaryGeometryData(s[0],e,o,i),s}):l.resolve(s);var f=r.loadTextures(s,a);return l.all([f,i,o])}).then(function(e){var t=e[0],i=e[1],o=e[2];r.handleCancelled();var u=null;return o&&(u={attributeData:o,loadedAttributes:r.requiredAttributes}),{allGeometryData:i,attributeDataInfo:u,geometryBuffer:n,sharedResource:a,textureData:t}})})},e.addAbsoluteHrefTexture=function(e,t){var r=e.textureDefinitions;if(null!=r)for(var a=0,n=Object.keys(r);a<n.length;a++)for(var i=n[a],o=0,u=r[i].images;o<u.length;o++){var l=u[o];Array.isArray(l.href)?l.hrefConcat=l.href.map(function(e){return s.makeAbsolute(e,t)}):l.hrefConcat=s.makeAbsolute(l.href,t)}},e.fixTextureEncodings=function(e){var t=e.textureDefinitions;if(null!=t)for(var r in t){var a=t[r];if(Array.isArray(a.encoding))for(var n=0;n<a.encoding.length;n++){var i=a.encoding[n];"data:"===i.substring(0,5)&&(a.encoding[n]=i.substring(5))}else{var i=a.encoding;"data:"===i.substring(0,5)&&(a.encoding=i.substring(5))}}},e.prototype.loadTexture=function(e,t,r,a){var n=this;return a===o.DDS_ENCODING_STRING?this.loadBinary(e).then(function(e){return n.handleCancelled(),{i3sTexId:t,data:e,encoding:a}}):this.loadImage(e).then(function(e){var i=e;n.handleCancelled();var o=4096,u=2;if(r&&e.width*e.height>=o){var l=Math.ceil(e.width/u),s=Math.ceil(e.height/u),d=document.createElement("canvas");d.width=l,d.height=s;var f=d.getContext("2d");f.drawImage(e,0,0,l,s),i=d}return{i3sTexId:t,data:i,encoding:a}})},e.prototype.loadTextures=function(t,r){for(var a=[],n=0;n<t.length;n++){var u=t[n].geometries;if(null!=u)for(var s=0,d=u;s<d.length;s++){var f=d[s],c=f.params.textureID||"none";if("none"!==c){(null==r.textureDefinitions||null==r.textureDefinitions[c])&&this.logger.warn("textureDefinitions missing in shared resource. i3sTexId: "+c);var h=r.textureDefinitions[c];if(i.assert(void 0!==h,"geometry wants unknown texture "+c),0===h.images.length)continue;var m=h.images.length-1,p=h.images[m],g=this.options.textureFormat===e.TextureFormat.Compressed,v=this.options.textureFormat===e.TextureFormat.Downsampled,y=o.getAppropriateTextureEncoding(h.encoding,g),D=y>-1?h.encoding[y]:h.encoding,b=y>-1?p.hrefConcat[y]:p.hrefConcat;this.options.loadTextureData?a.push(this.loadTexture(b,c,v,D)):a.push({i3sTexId:c,encoding:D,data:null})}}}return l.all(a)},e.prototype.meshPyramidGeometryData=function(e,t){var r=t.materialDefinitions?Object.keys(t.materialDefinitions)[0]:null,a=t.textureDefinitions?Object.keys(t.textureDefinitions)[0]:null;return[{featureIds:[],geometries:[{type:"ArrayBufferView",params:{materialID:r,textureID:a}}],featureDataPosition:[0,0,0]}]},e.prototype.collectGeometries=function(e,t,r){for(var a=[],n=0,i=t.featureData;n<i.length;n++){var o=i[n],u=o.geometries;if(null!=u)for(var l=0;l<u.length;l++){var s=o.geometries[l];a.push({featureIds:[o.id],featureDataPosition:o.position,geometries:[s]})}else null!=o.position&&a.push({featureIds:[o.id],featureDataPosition:o.position,geometries:null})}return a},e.prototype.loadFeatureData=function(e,t){var r=s.makeAbsolute(e.featureData[t].href,e.baseUrl);return this.loadJSON(r)},e.prototype.handleCancelled=function(){if(this.cancelled)throw new n},e}();return function(e){var t;!function(e){e[e.Compressed=0]="Compressed",e[e.Normal=1]="Normal",e[e.Downsampled=2]="Downsampled"}(t=e.TextureFormat||(e.TextureFormat={}))}(d||(d={})),d});