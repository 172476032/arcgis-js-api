// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../request","../../../../core/promiseUtils","../../../../core/Error","../../../../core/urlUtils","../../../../geometry/SpatialReference","../../../../geometry/support/webMercatorUtils","../../../../tasks/QueryTask","../../../../tasks/support/Query","../../support/projectionUtils","../../lib/glMatrix","../../webgl-engine/lib/Util","./I3SBinaryReader"],function(e,r,t,n,a,o,i,l,u,s,c,f,d,h){function p(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function v(e,r,t){switch(r){case"none":g(e);break;case"east-north-up":break;case"earth-centered":var n=c.SphericalECEFSpatialReference;t(e.normals,n);break;case"vertex-reference-frame":break;default:throw new Error("Received unexpected normalReferenceFrame: "+r)}}function g(e){var r=e.normals,t=e.positions,n=e.normalInd,a=e.positionInd;d.assert(e.normalInd.length===e.positionInd.length);for(var o=f.vec3d.create(),i=f.vec3d.create(),l=t.data,u=t.offsetIdx,s=t.strideIdx,c=r.data,h=r.offsetIdx,p=r.strideIdx,v=0;v<a.length;v+=3){var g=a[v],y=u+s*g,m=l[y],b=l[y+1],w=l[y+2];g=a[v+1],y=u+s*g,o[0]=l[y]-m,o[1]=l[y+1]-b,o[2]=l[y+2]-w,g=a[v+2],y=u+s*g,i[0]=l[y]-m,i[1]=l[y+1]-b,i[2]=l[y+2]-w,f.vec3d.cross(o,i,o),f.vec3d.normalize(o);for(var S=0;3>S;S++){var I=n[v+S],R=h+p*I;c[R]=o[0],c[R+1]=o[1],c[R+2]=o[2]}}}function y(e,t){if(Array.isArray(e)){if(t){var n=e.indexOf(r.DDS_ENCODING_STRING);if(n>-1)return n}for(var a=0;a<e.length;a++)if(r.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(e[a])>-1)return a;throw new Error("Could not find appropriate texture encoding (among "+e.toString()+")")}return-1}function m(e,r,t,n,a,o){if(null!=t){var i=Q;if(c.mbsToMbs(t.mbs,n,i,r),0!==b(e,i)){o.push(t);for(var l=null!=t.children?t.children.length:0,u=0;l>u;u++){var s=a[t.children[u].id];m(e,r,s,n,a,o)}}}}function b(e,r){var t=r[0],n=r[1],a=r[2],o=r[3],i=0;if(t<e[0]){var l=e[0]-t;i+=l*l}if(n<e[1]){var l=e[1]-n;i+=l*l}if(a<e[2]){var l=e[2]-a;i+=l*l}if(t>e[3]){var l=t-e[3];i+=l*l}if(n>e[4]){var l=n-e[4];i+=l*l}if(a>e[5]){var l=a-e[5];i+=l*l}if(i>o*o)return 0;if(i>0)return 1;var u=1/0;return t-e[0]<u&&(u=t-e[0]),n-e[1]<u&&(u=n-e[1]),a-e[2]<u&&(u=a-e[2]),e[3]-t<u&&(u=e[3]-t),e[4]-n<u&&(u=e[4]-n),e[5]-a<u&&(u=e[5]-a),u>o?2:1}function w(e,r,t){for(var n=[],a=t&&t.missingFields,o=t&&t.originalFields,i=0,l=e;i<l.length;i++){for(var u=l[i],s=u.toLowerCase(),c=!1,f=0,d=r;f<d.length;f++){var h=d[f];if(s===h.name.toLowerCase()){n.push(h.name),c=!0,o&&o.push(u);break}}!c&&a&&a.push(u)}return n}function S(e,r,t,o,i,l){var u=(l&&l.populateObjectId)===!0,s=l.ignoreUnavailableFields?void 0:[],c=1===o.length&&"*"===o[0];!c&&u&&(o=I(o,t));var f=c?o:w(o,e.fields,{missingFields:s});if(s&&0!==s.length)return n.reject(new a("scenelayer:unknown-fields","This scene layer does not have the requested fields",{unknownFields:s}));if(0===r.length)return n.resolve(r);var d=e.associatedLayer,h=e.attributeStorageInfo,p=c?e.fields.map(function(e){return e.name}):f;if(d)return R(d,r,t,p);var v=x(p,r[0]);if(0===v.length)return n.resolve(r);if(h){var g=i();return null==g?n.reject(new a("scenelayer:feature-not-loaded","Tried to query attributes for unloaded features")):k(h,g.node,g.indices,v,l).then(function(e){for(var t=0;t<r.length;t++){for(var n=0,a=p;n<a.length;n++){var o=a[n];o in e[t]||(e[t][o]=r[t].attributes[o])}r[t].attributes=e[t]}return r})}return n.reject(new a("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))}function I(e,r){return e.filter(function(e){return e.toLowerCase()!==r.toLowerCase()}).concat([r])}function R(e,r,t,n){r.sort(function(e,r){return e.attributes[t]-r.attributes[t]});var a=r.map(function(e){return e.attributes[t]}),o=[],i=w(n,e.fields,{originalFields:o});return C(e,a,i).then(function(e){for(var t=0;t<r.length;t++){var n=r[t],a=e[t];n.attributes={};for(var l=0;l<o.length;l++)n.attributes[o[l]]=a[i[l]]}return r})}function x(e,r){for(var t=[],n=0,a=e;n<a.length;n++){var o=a[n];o in r.attributes||t.push(o)}return t}function C(e,r,t){if(null!=e.maxRecordCount&&r.length>e.maxRecordCount){var o=T(r,e.maxRecordCount);return n.all(o.map(function(r){return C(e,r,t)})).then(E)}var i=new s({objectIds:r,outFields:t,orderByFields:[e.objectIdField]}),l=new u(e.parsedUrl.path);return l.execute(i).then(function(e){return e&&e.features&&e.features.length===r.length?e.features.map(function(e){return e.attributes}):n.reject(new a("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer"))})}function k(e,r,i,l,u){for(var s=[],c=0;c<r.attributeData.length;c++){var f=r.attributeData[c],d=e[c];if(d&&-1!==l.indexOf(d.name)){var p=o.makeAbsolute(f.href,r.baseUrl);s.push({url:p,storageInfo:d})}}return n.eachAlways(s.map(function(e){return t(e.url,{responseType:"array-buffer"}).then(function(r){return h.readBinaryAttribute(e.storageInfo,r.data)})})).then(function(e){var r=[];if(!u.ignoreUnavailableFields&&e.some(function(e){return null==e.value})){for(var t=[],o=0;o<e.length;o++)null==e[o].value&&t.push({name:s[o].storageInfo.name,error:e[o].error});return n.reject(new a("scenelayer:attribute-request-failed","Request for scene layer attributes failed",{failedAttributes:t}))}for(var l=0,c=i;l<c.length;l++){for(var f=c[l],d={},o=0;o<e.length;o++)null!=e[o].value&&(d[s[o].storageInfo.name]=A(e[o].value,f));r.push(d)}return r})}function A(e,r){var t=e[r];if(e instanceof Int16Array)return t===K?null:t;if(e instanceof Int32Array)return t===H?null:t;var n=t!==t;return n?null:t}function T(e,r){for(var t=e.length,n=Math.ceil(t/r),a=[],o=0;n>o;o++){var i=Math.floor(t*o/n),l=Math.floor(t*(o+1)/n);a.push(e.slice(i,l))}return a}function E(e){for(var r=[],t=0,n=e;t<n.length;t++){var a=n[t];r=r.concat(a)}return r}function M(e,r,t){void 0===t&&(t=2);for(var n=3,o=null!=r?r:e.length/t,i=new Uint32Array(o+1),l=0;o>l;l++){var u=e[l*t],s=u*n;i[l]=s;var c=(l-1)*t+1;if(c>=0&&u-1!==e[c])throw new a("Face ranges are not continuous")}var f=e[(o-1)*t+1],d=(f+1)*n;return i[i.length-1]=d,i}function F(e){var r=new i(p(e.store.indexCRS||e.store.geographicCRS));return r.equals(e.spatialReference)?e.spatialReference:r}function G(e){var r=new i(p(e.store.vertexCRS||e.store.projectedCRS));return r.equals(e.spatialReference)?e.spatialReference:r}function N(e,r){return r===c.SphericalECEFSpatialReference?"@ECEF":e.equals(r)?"":null!=r.wkid?"@"+r.wkid:null}function O(e,r,t){if(!l.canProject(e,r))throw new a("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===t&&e.isGeographic)throw new a("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function _(e,r,t){var n=F(e),a=G(e);O(n,r,t),O(a,r,t)}function j(e){return null!=e.geometryType&&"triangles"!==e.geometryType?!1:null!=e.topology&&"PerAttributeArray"!==e.topology?!1:null==e.vertexAttributes||null==e.vertexAttributes.position?!1:!0}function D(e){if(null==e.store||null==e.store.defaultGeometrySchema||!j(e.store.defaultGeometrySchema))throw new a("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{})}function U(e,r){_(e,r.spatialReference,r.viewingMode)}function q(e){return null==e.geometryType||"points"!==e.geometryType?!1:null!=e.topology&&"PerAttributeArray"!==e.topology?!1:null!=e.encoding&&""!==e.encoding&&"lepcc-xyz"!==e.encoding?!1:null==e.vertexAttributes||null==e.vertexAttributes.position?!1:!0}function L(e){if(null==e.store||null==e.store.defaultGeometrySchema||!q(e.store.defaultGeometrySchema))throw new a("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function P(e,r){O(e.spatialReference,r.spatialReference,r.viewingMode)}function B(e,r,t){var n=85,a=n,o=2*n;if(null==e||"ignore"===r)return t[0]=255,t[1]=255,t[2]=255,void(t[3]=255);t[0]=Math.floor(255*e[0]),t[1]=Math.floor(255*e[1]),t[2]=Math.floor(255*e[2]);var i=Math.floor(e[3]*n);0===i?t[3]=0:"tint"===r?t[3]=i:"replace"===r?t[3]=i+a:t[3]=i+o}function V(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}function W(e){return"mesh-3d"===e.type}function z(e){if(null==e||!V(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;var r=e.getSymbols();if(0===r.length)return!0;for(var t=0,n=r;t<n.length;t++){var a=n[t];if(!W(a)||0===a.symbolLayers.length)return!0;for(var o=0,i=a.symbolLayers.items;o<i.length;o++){var l=i[o];if("fill"!==l.type||null==l.material||"replace"!==l.material.colorMixMode)return!0}}return!1}Object.defineProperty(r,"__esModule",{value:!0}),r.DDS_ENCODING_STRING="image/vnd-ms.dds",r.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"],r.extractWkid=p,r.processNormals=v,r.getAppropriateTextureEncoding=y,r.findIntersectingNodes=m;var Q=f.vec4d.create();r.intersectBoundingBoxWithMbs=b,r.findFieldsCaseInsensitive=w,r.whenGraphicAttributes=S;var K=-Math.pow(2,15),H=-Math.pow(2,31);r.getCachedAttributeValue=A,r.convertFlatRangesToOffsets=M,r.getIndexCrs=F,r.getVertexCrs=G,r.getCacheKeySuffix=N,r.checkSpatialReference=O,r.checkSpatialReferences=_,r.checkSceneLayerValid=D,r.checkSceneLayerCompatibleWithView=U,r.checkPointCloudLayerValid=L,r.checkPointCloudLayerCompatibleWithView=P,r.encodeSymbolColor=B,r.rendererNeedsTextures=z});