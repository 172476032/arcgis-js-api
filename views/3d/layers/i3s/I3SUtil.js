// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","dojo/_base/lang","dojo/promise/all","../../../../request","../../../../core/promiseUtils","../../../../core/Error","../../../../core/urlUtils","../../../../geometry/SpatialReference","../../../../geometry/support/webMercatorUtils","../../../../tasks/QueryTask","../../../../tasks/support/Query","../../support/projectionUtils","../../lib/glMatrix","../../webgl-engine/lib/Util","./I3SBinaryReader"],function(e,r,t,n,o,a,i,u,l,s,c,f,p,h,d,v){function g(e){return"/"!==e[e.length-1]&&(e+="/"),e}function m(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function y(e,r,t){switch(r){case"none":b(e);break;case"east-north-up":break;case"earth-centered":var n=p.SphericalRenderSpatialReference;t(e.normals,n);break;case"vertex-reference-frame":break;default:throw new Error("Received unexpected normalReferenceFrame: "+r)}}function b(e){var r=e.normals,t=e.positions,n=e.normalInd,o=e.positionInd;d.assert(e.normalInd.length===e.positionInd.length);for(var a=h.vec3d.create(),i=h.vec3d.create(),u=0;u<o.length;u+=3){var l=3*o[u],s=t[l],c=t[l+1],f=t[l+2];l=3*o[u+1],a[0]=t[l]-s,a[1]=t[l+1]-c,a[2]=t[l+2]-f,l=3*o[u+2],i[0]=t[l]-s,i[1]=t[l+1]-c,i[2]=t[l+2]-f,h.vec3d.cross(a,i,a),h.vec3d.normalize(a);for(var p=0;3>p;p++){var v=3*n[u+p];r[v]=a[0],r[v+1]=a[1],r[v+2]=a[2]}}}function w(e,t){if(Array.isArray(e)){if(t){var n=e.indexOf(r.DDS_ENCODING_STRING);if(n>-1)return n}for(var o=0;o<e.length;o++)if(r.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(e[o])>-1)return o;throw new Error("Could not find appropriate texture encoding (among "+e.toString()+")")}return-1}function R(e,r,t,n,o,a){if(null!=t){var i=V;if(p.mbsToMbs(t.mbs,n,i,r),0!==S(e,i)){a.push(t);for(var u=null!=t.children?t.children.length:0,l=0;u>l;l++){var s=o[t.children[l].id];R(e,r,s,n,o,a)}}}}function S(e,r){var t=r[0],n=r[1],o=r[2],a=r[3],i=0;if(t<e[0]){var u=e[0]-t;i+=u*u}if(n<e[1]){var u=e[1]-n;i+=u*u}if(o<e[2]){var u=e[2]-o;i+=u*u}if(t>e[3]){var u=t-e[3];i+=u*u}if(n>e[4]){var u=n-e[4];i+=u*u}if(o>e[5]){var u=o-e[5];i+=u*u}if(i>a*a)return 0;if(i>0)return 1;var l=1/0;return t-e[0]<l&&(l=t-e[0]),n-e[1]<l&&(l=n-e[1]),o-e[2]<l&&(l=o-e[2]),e[3]-t<l&&(l=e[3]-t),e[4]-n<l&&(l=e[4]-n),e[5]-o<l&&(l=e[5]-o),l>a?2:1}function C(e,r,t){for(var n=[],o=0,a=e;o<a.length;o++){for(var i=a[o],u=i.toLowerCase(),l=!1,s=0,c=r;s<c.length;s++){var f=c[s];if(u===f.name.toLowerCase()){n.push(f.name),l=!0;break}}l||void 0===t||t.push(i)}return n}function x(e,r,n,o,u){if(0===r.length)return a.resolve(r);var l=Object.keys(r[0].attributes).map(function(e){return e.toLowerCase()}),s=o.filter(function(e){return l.indexOf(e.toLowerCase())<0});if(0===s.length)return a.resolve(r);var c=function(e){for(var n=0;n<r.length;n++)t.mixin(r[n].attributes,e[n]);return r},f=e.companionFeatureLayer,p=e.attributeStorageInfo;if(f){r.sort(function(e,r){return e.attributes[n]-r.attributes[n]});var h=r.map(function(e){return e.attributes[n]});return I(f,h,s).then(c)}if(p){var d=u();if(null!=d)return A(p,d.node,d.indices,s,e.token).then(c)}return a.reject(new i("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))}function I(e,r,t){if(void 0===t&&(t=["*"]),null!=e.maxRecordCount&&r.length>e.maxRecordCount){var o=k(r,e.maxRecordCount);return n(o.map(function(r){return I(e,r,t)})).then(M)}var u=new f({objectIds:r,outFields:t,orderByFields:[e.objectIdField]}),l=new c(e.parsedUrl.path);return l.execute(u).then(function(e){return e&&e.features&&e.features.length===r.length?e.features.map(function(e){return e.attributes}):a.reject(new i("scenelayer:feature-not-in-companion","Feature not found in companion feature layer"))})}function A(e,r,t,i,l){void 0===i&&(i=["*"]);var s=i.some(function(e){return"*"===e}),c=s?null:i.map(function(e){return e.toLowerCase()});return n(r.attributeData.map(function(t,n){var i=e[n].name.toLowerCase();if(!s&&!c.some(function(e){return i===e}))return a.resolve(null);var f=u.makeAbsolute(t.href,r.baseUrl);return o(f,{query:{token:l},responseType:"array-buffer"}).then(function(r){return v.readBinaryAttribute(e[n],r.data)}).otherwise(function(){return null})})).then(function(r){for(var n=[],o=0,a=t;o<a.length;o++){for(var i=a[o],u={},l=0;l<r.length;l++)null!=r[l]&&(u[e[l].name]=T(r[l],i));n.push(u)}return n})}function T(e,r){var t=e[r];if(e instanceof Int16Array)return t===W?null:t;if(e instanceof Int32Array)return t===q?null:t;var n=t!==t;return n?null:t}function k(e,r){for(var t=e.length,n=Math.ceil(t/r),o=[],a=0;n>a;a++){var i=Math.floor(t*a/n),u=Math.floor(t*(a+1)/n);o.push(e.slice(i,u))}return o}function M(e){for(var r=[],t=0,n=e;t<n.length;t++){var o=n[t];r=r.concat(o)}return r}function G(e,r,t){void 0===t&&(t=2);for(var n=3,o=null!=r?r:e.length/t,a=new Uint32Array(o+1),u=0;o>u;u++){var l=e[u*t],s=l*n;a[u]=s;var c=(u-1)*t+1;if(c>=0&&l-1!==e[c])throw new i("Face ranges are not continuous")}var f=e[(o-1)*t+1],p=3*(f+1);return a[a.length-1]=p,a}function O(e){var r=new l(m(e.store.indexCRS||e.store.geographicCRS));return r.equals(e.spatialReference)?e.spatialReference:r}function _(e){var r=new l(m(e.store.vertexCRS||e.store.projectedCRS));return r.equals(e.spatialReference)?e.spatialReference:r}function E(e,r,t){if(!s.canProject(e,r))throw new i("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===t&&e.isGeographic)throw new i("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function N(e,r,t){var n=O(e),o=_(e);E(n,r,t),E(o,r,t)}function j(e){return null!=e.geometryType&&"triangles"!==e.geometryType?!1:null!=e.topology&&"PerAttributeArray"!==e.topology?!1:null==e.vertexAttributes||null==e.vertexAttributes.position?!1:!0}function D(e){if(null==e.store||null==e.store.defaultGeometrySchema||!j(e.store.defaultGeometrySchema))throw new i("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{})}function L(e,r){N(e,r.spatialReference,r.viewingMode)}function P(e){return null==e.geometryType||"points"!==e.geometryType?!1:null!=e.topology&&"PerAttributeArray"!==e.topology?!1:null!=e.encoding&&""!==e.encoding&&"lepcc-xyz"!==e.encoding?!1:null==e.vertexAttributes||null==e.vertexAttributes.position?!1:!0}function U(e){if(null==e.store||null==e.store.defaultGeometrySchema||!P(e.store.defaultGeometrySchema))throw new i("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function F(e,r){E(e.spatialReference,r.spatialReference,r.viewingMode)}function B(e,r,t){var n=85,o=n,a=2*n;if(null==e||"ignore"===r)return t[0]=255,t[1]=255,t[2]=255,void(t[3]=255);t[0]=Math.floor(255*e[0]),t[1]=Math.floor(255*e[1]),t[2]=Math.floor(255*e[2]);var i=Math.floor(e[3]*n);0===i?t[3]=0:"tint"===r?t[3]=i:"replace"===r?t[3]=i+o:t[3]=i+a}Object.defineProperty(r,"__esModule",{value:!0}),r.DDS_ENCODING_STRING="image/vnd-ms.dds",r.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"],r.addTrailingSlash=g,r.extractWkid=m,r.processNormals=y,r.getAppropriateTextureEncoding=w,r.findIntersectingNodes=R;var V=h.vec4d.create();r.intersectBoundingBoxWithMbs=S,r.findFieldsCaseInsensitive=C,r.whenGraphicAttributes=x;var W=-Math.pow(2,15),q=-Math.pow(2,31);r.getCachedAttributeValue=T,r.convertFlatRangesToOffsets=G,r.getIndexCrs=O,r.getVertexCrs=_,r.checkSpatialReference=E,r.checkSpatialReferences=N,r.checkSceneLayerValid=D,r.checkSceneLayerCompatibleWithView=L,r.checkPointCloudLayerValid=U,r.checkPointCloudLayerCompatibleWithView=F,r.encodeSymbolColor=B});