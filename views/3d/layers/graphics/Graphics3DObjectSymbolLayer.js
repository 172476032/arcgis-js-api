// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/_base/lang","../../../../Color","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./ElevationAligners","./Graphics3DSymbolCommonCode","./graphicUtils","./FastSymbolUpdates","./objectResourceUtils","../../lib/glMatrix","../../support/aaBoundingBox","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/materials/Material","../../webgl-engine/materials/internal/MaterialUtil"],function(e,t,r,i,a,o,s,n,l,c,p,u,h,d,m,_,y,f,g){var v=h.mat4d,b=h.vec3d,M=[1,1,1],x=[1,1,1,1],S=[0,0,0],P=[-.5,-.5,-.5,.5,.5,.5],O=[-.5,-.5,0,.5,.5,1],C=[-.5,-.5,0,.5,.5,.5],E={sphere:P,cube:P,cylinder:O,cone:O,"inverted-cone":O,tetrahedron:C,diamond:P},T=[m.ModelContentType.MATERIAL,m.ModelContentType.TEXTURE,m.ModelContentType.GEOMETRY],A=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._prepareResources=function(){var e=this.symbol,t=this._getStageIdHint();if(e.resource&&e.resource.href)this._prepareModelResources(e.resource.href,t);else{var r=e.resource?e.resource.primitive:"sphere";this._preparePrimitiveResources(r,t)}},t.prototype._preparePrimitiveResources=function(e,t){var r=this.symbol;if("sphere"===e)this._geometryData=y.createPolySphereGeometry(.5,2,!0);else if("cube"===e)this._geometryData=y.createBoxGeometry(1);else if("cylinder"===e)this._geometryData=y.createCylinderGeometry(1,.5,32,[0,0,1],[0,0,.5]);else if("cone"===e)r.height<0?(this._geometryData=y.createConeGeometry(1,.5,15,!0),r.height=-r.height):this._geometryData=y.createConeGeometry(1,.5,15,!1),y.cgToGIS(this._geometryData);else if("inverted-cone"===e)this._geometryData=y.createConeGeometry(1,.5,15,!0),y.cgToGIS(this._geometryData);else if("tetrahedron"===e)this._geometryData=y.createTetrahedronGeometry(1),y.cgToGIS(this._geometryData);else{if("diamond"!==e)return console.warn("Unknown object symbol primitive: "+e),void this.reject();this._geometryData=y.createDiamondGeometry(1),y.cgToGIS(this._geometryData)}this._geometry=new _(this._geometryData,t),this._context.stage.add(m.ModelContentType.GEOMETRY,this._geometry),this._resourceBoundingBox=E[e],this._resourceSize=d.size(this._resourceBoundingBox),this._symbolSize=r.computeSizeWithResourceSize(this._resourceSize);var o=this._getMaterialOpacity(),s={specular:[0,0,0],shininess:3,opacity:o,transparent:1>o||this._isPropertyDriven("opacity"),instanced:["transformation"],ambient:M,diffuse:M};if(this._isPropertyDriven("color"))s.externalColor=x;else{var n=r.material?a.toUnitRGBA(r.material.color):x;s.externalColor=n}r.material&&r.material.colorMixMode&&(s.externalColorMixMode=g.externalColorMixModes[r.material.colorMixMode]),this._fastUpdates=p.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled?(i.mixin(s,this._fastUpdates.materialParameters),s.instanced.push("featureAttribute")):this._hasPerInstanceColor()&&s.instanced.push("color"),this._material=new f(s,t+"_objectmat"),this._context.stage.add(m.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype._prepareModelResources=function(e,t){var r=this,a={materialParamsMixin:{instanced:["transformation"]},bakeTransformations:!0,idHint:t,streamDataSupplier:this._context.streamDataSupplier};this._fastUpdates=p.initFastSymbolUpdatesState(this._context.renderer,this._supportsShaderVisualVariables(),this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled?(i.mixin(a.materialParamsMixin,this._fastUpdates.materialParameters),a.materialParamsMixin.instanced.push("featureAttribute")):this._hasPerInstanceColor()&&a.materialParamsMixin.instanced.push("color"),this._symbolLoaderPromise=u.fetch(e,a),this._symbolLoaderPromise.then(function(e){if(r._symbolLoaderPromise=null,!r.isRejected()){var t=e.stageResources,i=r._context.stage,a=r.symbol.material,o=r._computeModelColorOverride(a),s=r._computeModelOpacityOverride(),n=t[m.ModelContentType.MATERIAL];e.originalMaterialOpacities=new Array(n.length),n.forEach(function(t,r){var i=t.getParameterValues();e.originalMaterialOpacities[r]=i.opacity,o&&t.setParameterValues(o),null!=s.overwrite?t.setParameterValues({opacity:s.overwrite,transparent:s.blendingRequired}):null!=s.multiply&&(i.opacity*=s.multiply,i.transparent=i.opacity<1,t.setParameterValues({opacity:i.opacity,transparent:i.transparent}))}),T.forEach(function(e){for(var r=t[e],a=0;r&&a<r.length;a++)i.add(e,r[a])}),r._resourceBoundingBox=u.computeBoundingBox(e),r._resourceSize=d.size(r._resourceBoundingBox),r._pivotOffset=e.pivotOffset,r._symbolSize=r.symbol.computeSizeWithResourceSize(r._resourceSize),r._i3sModel=e,p.updateFastSymbolUpdatesState(r._fastUpdates,r._context.renderer,r._fastVisualVariableConvertOptions())&&n.forEach(function(e){return e.setParameterValues(r._fastUpdates.materialParameters)}),r.resolve()}},function(){r._symbolLoaderPromise=null,r.isFulfilled()||r.reject()})},t.prototype._forEachMaterial=function(e){if(this._i3sModel){var t=this._i3sModel.stageResources[m.ModelContentType.MATERIAL];t.forEach(e)}else e(this._material)},t.prototype._computeModelOpacityOverride=function(){var e={overwrite:null,blendingRequired:!1,multiply:null},t=this._getMaterialOpacity();return this._isPropertyDriven("opacity")?(e.overwrite=t,e.blendingRequired=!0):this.symbol.material&&void 0!==this.symbol.material.transparency?(e.overwrite=t,e.blendingRequired=e.overwrite<1):1>t&&(e.multiply=t,e.blendingRequired=!0),e},t.prototype._computeModelColorOverride=function(e){var t={};return e&&e.colorMixMode&&(t.externalColorMixMode=g.externalColorMixModes[e.colorMixMode]),this._isPropertyDriven("color")?t.externalColor=x:e&&e.color?t.externalColor=a.toUnitRGBA(e.color):(t.externalColor=x,t.externalColorMixMode=g.externalColorMixModes.ignore),t},t.prototype.destroy=function(){this.isFulfilled()||this.reject(),this._symbolLoaderPromise&&this._symbolLoaderPromise.cancel();var e=this._context.stage;if(this._i3sModel){var t=this._i3sModel.stageResources;T.forEach(function(r){for(var i=t[r],a=0;i&&a<i.length;a++)e.remove(r,i[a].getId())})}else this._material&&e.remove(m.ModelContentType.MATERIAL,this._material.getId()),this._geometry&&e.remove(m.ModelContentType.GEOMETRY,this._geometry.getId())},t.prototype._getGeometry=function(e){var t=e.geometry;return"polyline"===t.type?l.placePointOnPolyline(t):"polygon"===t.type?l.placePointOnPolygon(t):"extent"===t.type?t.center:"point"!==t.type?(this._logWarning("unsupported geometry type for object symbol: "+t.type),null):t},t.prototype.createGraphics3DGraphic=function(e,t){var r=this._getGeometry(e);if(null===r)return null;var i="graphic"+e.uid,a=this._getGraphicElevationInfo(e);return this._createAs3DShape(e,r,t,a,i,e.uid)},t.prototype.layerPropertyChanged=function(e,t,r){var i=this;if("opacity"===e){if(this._i3sModel){var a=this._computeModelOpacityOverride(),o=this._i3sModel.stageResources[m.ModelContentType.MATERIAL];o.forEach(function(e,t){if(null!=a.overwrite)e.setParameterValues({opacity:a.overwrite,transparent:a.blendingRequired});else{var r=i._i3sModel.originalMaterialOpacities[t];null!=a.multiply&&(r*=a.multiply),e.setParameterValues({opacity:r,transparent:1>r})}})}else{var c=this._getMaterialOpacity();this._material.setParameterValues({opacity:c,transparent:1>c||this._isPropertyDriven("opacity")})}return!0}if("elevationInfo"===e){this._updateElevationInfo();var p=this._context.elevationProvider,u=this._context.renderCoordsHelper,h=n.perObjectElevationAligner,d=l.ELEV_MODES.ABSOLUTE_HEIGHT;for(var _ in t){var y=t[_],f=y._graphics[r];if(f&&f instanceof s){var g=y.graphic,v=this._getGraphicElevationInfo(g);f.elevationAligner=v.mode!==d?h:null,f.elevationInfo.set(v),h(f,p,u)}}return!0}return!1},t.prototype.applyRendererDiff=function(e,t,r,i){var a=this;for(var o in e.diff)switch(o){case"visualVariables":if(!p.updateFastSymbolUpdatesState(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return!1;this._forEachMaterial(function(e){return e.setParameterValues(a._fastUpdates.materialParameters)});break;default:return!1}return!0},t.prototype._createAs3DShape=function(e,t,r,i,a,o){var u,h=this,d=null,_=null,y=this._getFastUpdateAttrValues(e);y&&(d=d||{},d.featureAttribute=y,_=function(e){return p.evaluateModelTransform(h._fastUpdates.materialParameters,d.featureAttribute,e)}),!this._fastUpdates.enabled&&this._hasPerInstanceColor()&&(d=d||{},d.color=c.mixinColorAndOpacity(r.color,r.opacity));var f=this._context.layer.id,g=v.identity();if(this._applyObjectRotation(r,this.symbol,g),this._applyObjectScale(r,g),this._applyAnchor(g),this._i3sModel){var b=this._i3sModel.stageResources[m.ModelContentType.GEOMETRY],M=this._i3sModel.materialsByComponent;if(u=l.createStageObjectForPoint.call(this,t,null,null,null,null,i,a,f,o),null===u)return null;for(var x=0;x<b.length;x++){var S=M[x];u.object.addGeometry(b[x],S,g,d,null,_)}}else u=l.createStageObjectForPoint.call(this,t,[this._geometry],[[this._material]],[g],d,i,a,f,o,null,_);if(null===u)return null;if(this._fastUpdates.enabled){var P=p.getMaterialParams(this._fastUpdates.visualVariables,this._fastVisualVariableConvertOptions());this._forEachMaterial(function(e){return e.setParameterValues(P)})}u.object.setCastShadow(!0);var O=null;i.mode!==l.ELEV_MODES.ABSOLUTE_HEIGHT&&(O=n.perObjectElevationAligner);var C=new s(this,u.object,null,null,null,O,i,s.VisibilityModes.REMOVE_OBJECT);return C.alignedTerrainElevation=u.terrainElevation,l.extendPointGraphicElevationInfo(C,t,this._context.elevationProvider),C},t.prototype._computeObjectScale=function(e){for(var t,r=new Array(3),i=this._isPropertyDriven("size")&&e&&e.size?e.size:this._symbolSize,a=0,o=2;o>=0;o--){var s=i[o],n=void 0;null!=s&&isFinite(s)?n=s/this._resourceSize[o]:("symbolValue"===s||0===o&&!t)&&(n=this._symbolSize[o]/this._resourceSize[o]),null!=n&&(r[o]=n,t=n,a=Math.max(a,Math.abs(n)))}for(var o=2;o>=0;o--)null==r[o]?r[o]=t:0===r[o]&&(r[o]=.001*a);for(var l=this._context.renderCoordsHelper.unitInMeters,o=2;o>=0;o--)r[o]/=l;return r},t.prototype._applyObjectScale=function(e,t){if(!this._fastUpdates.enabled||!this._fastUpdates.customTransformation){var r=this._computeObjectScale(e);(1!==r[0]||1!==r[1]||1!==r[2])&&v.scale(t,r)}},t.prototype._applyObjectRotation=function(e,t,r){if(!this._fastUpdates.enabled||!this._fastUpdates.customTransformation){var i=e.rotationAngle||0,a=t.heading||0,o=i+a;return 0!==o?v.rotateZ(r,-o/180*Math.PI,r):null}},t.prototype._computeAnchor=function(){switch(this.symbol.anchor){case"center":return b.scale(d.center(this._resourceBoundingBox),-1);case"bottom":var e=d.center(this._resourceBoundingBox);return[-e[0],-e[1],-this._resourceBoundingBox[2]];case"origin":default:return this._pivotOffset?b.scale(this._pivotOffset,-1,new Array(3)):S}},t.prototype._applyAnchor=function(e){if(!this._fastUpdates.enabled||!this._fastUpdates.customTransformation){var t=this._computeAnchor();t&&v.translate(e,t)}},t.prototype._hasPerInstanceColor=function(){return this._isPropertyDriven("color")||this._isPropertyDriven("opacity")},t.prototype._supportsShaderVisualVariables=function(){return this._context.stage.has("angleInstancedArrays")?!0:!1},t.prototype._fastVisualVariableConvertOptions=function(){var e=this._resourceBoundingBox?d.size(this._resourceBoundingBox):M,t=this._resourceBoundingBox?this._computeAnchor():S;return{modelSize:e,symbolSize:this._symbolSize||M,unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:t,scale:this._symbolSize&&this._resourceSize?this._computeObjectScale():M,rotation:this.symbol.heading||0}}},t}(o);return A.PRIMITIVE_BOUNDING_BOX=E,A});