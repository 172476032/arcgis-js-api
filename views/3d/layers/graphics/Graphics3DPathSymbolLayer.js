// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../../core/declare","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./Graphics3DSymbolCommonCode","./ElevationInfo","../../support/projectionUtils","../../../../views/3d/lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/materials/Material","../../webgl-engine/lib/Util"],function(e,t,r,i,a,n,o,s,l,c,h,p,g){var d=o.vec3d,v=o.mat4d,y=g.assert,u=d.create(),m={},f={verticalDistanceToGround:0,terrainElevation:0},_=10,E=e([t],{_prepareResources:function(){var e=this.symbol,t="c3dsymbol"+e.id,r=this._getMaterialOpacityAndColor(),i=d.create(r),a=r[3],n={diffuse:i,ambient:i,opacity:a,transparent:1>a||this._isPropertyDriven("opacity"),vertexColors:this._isPropertyDriven("color")||this._isPropertyDriven("opacity")};this._material=new p(n,t+"_3dlinemat"),this._context.stage.add(s.ModelContentType.MATERIAL,this._material),this.resolve()},destroy:function(){this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(s.ModelContentType.MATERIAL,this._material.getId()),this._material=null)},createGraphics3DGraphic:function(e,t){var r=e.geometry;if("polyline"!==r.type)return this._logWarning("unsupported geometry type for path symbol: "+r.type),null;var i="polygon"===r.type?"rings":"paths",a="graphic"+e.uid,n=this._getGraphicElevationInfo(e);return this._createAs3DShape(e,i,t,n,a,e.uid)},layerPropertyChanged:function(e,t,r){if("opacity"===e){var a=this._getMaterialOpacity(),n=1>a||this._isPropertyDriven("opacity");return this._material.setParameterValues({opacity:a,transparent:n}),!0}if("elevationInfo"===e){this._updateElevationInfo();var o=this._context.elevationProvider,s=this._context.renderCoordsHelper,l=i.ELEV_MODES.ABSOLUTE_HEIGHT;for(var c in t){var h=t[c],p=h._graphics[r];if(p){var g=h.graphic,d=this._getGraphicElevationInfo(g);p.elevationAligner=d.mode!==l?b:null,p.elevationInfo.set(d),b(p,o,s)}}return!0}return!1},_getPathSize:function(e,t){var r=e.size&&this._isPropertyDriven("size")?i.getSingleSizeDriver(e.size):this.symbol.size||this.symbol.width||1;return r/=this._context.renderCoordsHelper.unitInMeters},_createAs3DShape:function(e,t,a,o,s,p){var g=e.geometry,y=g.hasZ,u=g[t],m=u.length;if(m>0){for(var f=[],E=[],x=[],D=d.create(),A=this._context.renderSpatialReference,S=A===n.SphericalRenderSpatialReference,I=new Array(6),T=this._getPathSize(a,this.symbol),G=i.getGeometryVertexData3D(u,y,g.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,o),O=G.geometryData.outlines,P=G.eleVertexData,w=G.vertexData,C=0;C<O.length;++C){var M=O[C],R=M.index,V=M.count;if(!this._context.clippingExtent||(i.computeBoundingBox(P,R,V,I),!i.boundingBoxClipped(I,this._context.clippingExtent))){i.chooseOrigin(w,R,V,D),i.subtractCoordinates(w,R,V,D);var z=new Float64Array(P.buffer,3*R*P.BYTES_PER_ELEMENT,3*V),L=i.flatArrayToArrayOfArrays(w,R,V),H=h.createTubeGeometry(L,.5*T,_,S,D);if(H.getVertexAttr().mapPos={size:3,data:z},this._material.getParams().vertexColors){var B=this._getVertexOpacityAndColor(a);H=h.addVertexColors(H,B,!0)}var U=new c(H,s+"path"+C);U.singleUse=!0,f.push(U),E.push([this._material]);var j=v.identity();v.translate(j,D,j),x.push(j)}}if(f.length>0){var F=this._context.layer.id,N=new l({geometries:f,materials:E,transformations:x,castShadow:!0,metadata:{layerId:F,graphicId:p},idHint:s}),W=null;o.mode!==i.ELEV_MODES.ABSOLUTE_HEIGHT&&(W=b);var Y=new r(this,N,f,null,null,W,o);return Y.alignedTerrainElevation=G.terrainElevation,Y}}return null}}),x=g.VertexAttrConstants,b=function(e,t,r){for(var n=e.stageObject,o=e.elevationInfo,s=n.getGeometryRecords(),l=s.length,c=o.mode!==a.MODES.ABSOLUTE_HEIGHT,h=0,p=0;l>p;p++){var g=s[p].geometry,d=[s[p].transformation[12],s[p].transformation[13],s[p].transformation[14]],v=g.getData().getVertexAttr(),E=v[x.POSITION].data,b=v.zOffset.data,D=v.mapPos.data,A=D.length/3;y(E.length/3===A*_+2,"unexpected tube geometry");var S=0,I=0;m.spatialReference=t.spatialReference;for(var T=0,G=0;A>G;G++){m.x=D[3*G],m.y=D[3*G+1],m.z=D[3*G+2];var O=i.computeElevation(t,m,o,c?f:null);c&&(T+=f.terrainElevation);var P=_;(0===G||G===A-1)&&P++;for(var w=0;P>w;w++)u[0]=E[S]+d[0],u[1]=E[S+1]+d[1],u[2]=E[S+2]+d[2],r.setAltitude(O+b[I],u,0),E[S]=u[0]-d[0],E[S+1]=u[1]-d[1],E[S+2]=u[2]-d[2],S+=3,I+=1;g.invalidateBoundingInfo()}n.geometryVertexAttrsUpdated(p),h+=T/A}e.alignedTerrainElevation=h/l};return E});