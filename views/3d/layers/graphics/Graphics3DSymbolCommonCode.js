// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../geometry/Point","../../../../symbols/callouts/calloutUtils","../../../../geometry/support/coordsUtils","./graphicUtils","../../support/projectionUtils","../../lib/glMatrix","../../webgl-engine/lib/Object3D"],function(e,t,n,r,o,a,i,l,u){function c(e,t,n,r,o,a,i,l,c,s,f){var v=t?t.length:0,g=this._context.clippingExtent;if(U(e,B,this._context.elevationProvider.spatialReference),g&&!_(B,g))return null;U(e,B,this._context.renderSpatialReference);for(var d=this._context.localOriginFactory.getOrigin(B),p=!!s,x=new u({castShadow:!1,metadata:{layerUid:l,graphicId:c,usesVerticalDistanceToGround:p},idHint:i}),m=0;v>m;m++){var y=r?r[m]:N;x.addGeometry(t[m],n[m],y,o,d,f)}var E=h(x,e,a,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper);return{object:x,terrainElevation:E.terrainElevation}}function s(e,t,r){var o=e.elevationContext,a=r.spatialReference;U(t,B,a),o.centerPointInElevationSR=new n({x:B[0],y:B[1],z:t.hasZ?B[2]:0,spatialReference:a})}function f(e){var t=e.paths[0];if(!t||0===t.length)return null;var r=o.getPointOnPath(t,o.getPathLength(t)/2);return new n({x:r[0],y:r[1],z:r[2],spatialReference:e.spatialReference})}function v(e){return a.computeCentroid(e)}function g(e,t,n,r,o){var a=0,i=t.z||0,l=0,u=n.mode,c=n.calculateOffsetRenderUnits(r),s=n.featureExpressionInfoContext;return"on-the-ground"===u?(l=e.getElevation(t,"ground")||0,a=l,o&&(o.verticalDistanceToGround=0,o.terrainElevation=l)):"relative-to-ground"===u?(l=e.getElevation(t,"ground")||0,a=c,null==s&&(a+=i),o&&(o.verticalDistanceToGround=a,o.terrainElevation=l),a+=l):"relative-to-scene"===u?(l=e.getElevation(t,"scene")||0,a=c,o&&(o.verticalDistanceToGround=a,o.terrainElevation=l),a+=l):"absolute-height"===u&&(a=c,null==s&&(a+=i),o&&(l=e.getElevation(t,"ground")||0,o.verticalDistanceToGround=a-l,o.terrainElevation=l)),a}function d(e,t,n,r,o,a,i,l){var u=l.mode,c=0,s=0,f=0,v=l.calculateOffsetRenderUnits(i),g=l.featureExpressionInfoContext;X.spatialReference=e.spatialReference,n*=3,o*=3;for(var d=0;a>d;++d)X.x=t[n+0],X.y=t[n+1],X.z=t[n+2],"on-the-ground"===u?(c=e.getElevation(X)||0,s=c,f+=c):"relative-to-ground"===u?(c=e.getElevation(X)||0,s=c+v,null==g&&(s+=X.z),f+=c):"relative-to-scene"===u?(c=e.getElevation(X,"scene")||0,s=c+v,f+=c):"absolute-height"===u&&(s=v,null==g&&(s+=X.z)),r[o+0]=t[n+0],r[o+1]=t[n+1],r[o+2]=s,n+=3,o+=3;return f/=a,{terrainElevation:f}}function h(e,t,n,r,o,l){var u,c=0;if(e.metadata.usesVerticalDistanceToGround)c=g(o,t,n,l,F),a.updateVertexAttributeAuxpos1w(e,F.verticalDistanceToGround),u=F.terrainElevation;else{var s="absolute-height"!==n.mode;c=g(o,t,n,l,s?F:null),s&&(u=F.terrainElevation)}var f=e.getObjectTransformation();B[0]=t.x,B[1]=t.y,B[2]=c;var v=i.computeLinearTransformation(t.spatialReference,B,f,r);return v?e.setObjectTransformation(f):console.warn("Could not locate symbol object properly, it might be misplaced"),{terrainElevation:u}}function p(e,t){return void 0===t&&(t=0),isFinite(e[t])?e[t]:null}function x(e){for(var t=0,n=e.length-1,r=0;n>r;r++)t+=e[r][0]*e[r+1][1]-e[r+1][0]*e[r][1];return t>=0}function m(e,t,n,r,o,a){r*=3;for(var i=0;o>i;++i){var l=e[t++];n[r++]=l[0],n[r++]=l[1],n[r++]=a?l[2]:0}return r/3}function y(e,t){for(var n=e.length,r=new Array(n),o=new Array(n),a=new Array(n),i=0,l=0,u=0,c=0,s=0;n>s;++s)c+=e[s].length;for(var f=new Float64Array(3*c),v=0,g=n-1;g>=0;g--){var d=e[g];if(x(d))r[i++]=d;else{for(var h=d.length,s=0;i>s;++s)h+=r[s].length;var p={index:v,pathLengths:new Array(i+1),count:h,holeIndices:new Array(i)};p.pathLengths[0]=d.length,d.length>0&&(a[u++]={index:v,count:d.length}),v=m(d,0,f,v,d.length,t);for(var y=0;i>y;++y){var E=r[y];p.holeIndices[y]=v,p.pathLengths[y+1]=E.length,E.length>0&&(a[u++]={index:v,count:E.length}),v=m(E,0,f,v,E.length,t)}i=0,p.count>0&&(o[l++]=p)}}for(var y=0;i>y;++y){var E=r[y];E.length>0&&(a[u++]={index:v,count:E.length}),v=m(E,0,f,v,E.length,t)}return n>l&&(o.length=l),n>u&&(a.length=u),{vertexData:f,polygons:o,outlines:a}}function E(e,t,n,r,o){t*=3,r*=3;for(var a=0;o>a;++a)n[r++]=e[t++],n[r++]=e[t++],n[r++]=e[t++]}function b(e,t,n,r){var o=Math.floor(t+(n-1)/2);r[0]=e[3*o+0],r[1]=e[3*o+1],r[2]=e[3*o+2]}function A(e,t,n,r){t*=3;for(var o=0;n>o;++o)e[t++]-=r[0],e[t++]-=r[1],e[t++]-=r[2]}function D(e,t,n,r){t*=3;for(var o=0;n>o;++o)e[t+2]=r,t+=3}function O(e,t,n,r){t*=3;for(var o=0;n>o;++o)e[t+2]+=r,t+=3}function P(e,t,n,r){t*=3;for(var o=0;n>o;++o)e[t+2]*=r,t+=3}function j(e,t,n){var r=[];t*=3;for(var o=0;n>o;++o)r.push([e[t++],e[t++],e[t++]]);return r}function w(e,t,n,r,o,a,l){return i.bufferToBuffer(e,n,t,r,a,o,l)}function U(e,t,n){i.pointToVector(e,t,n)}function V(e,t,n,r,o,a,i){var l=o.spatialReference,u=y(e,t),c=u.vertexData,s=c.length/3,f=new Float64Array(c.length),v=!0;n.equals(l)?E(c,0,f,0,c.length):v=w(c,0,n,f,0,l,s);var g=d(o,f,0,c,0,s,a,i);return l.equals(r)||w(c,0,l,c,0,r,s),{geometryData:u,vertexData:c,eleVertexData:f,terrainElevation:g.terrainElevation,projectionSuccess:v}}function R(e,t,n){var r=y(e,!1),o=r.vertexData,a=o.length/3,l=!0;return t.equals(n)||(l=i.bufferToBuffer(o,t,0,o,n,0,a)),{geometryData:r,vertexData:o,projectionSuccess:l}}function T(e,t,n,r){r[0]=Number.MAX_VALUE,r[1]=Number.MAX_VALUE,r[2]=Number.MAX_VALUE,r[3]=-Number.MAX_VALUE,r[4]=-Number.MAX_VALUE,r[5]=-Number.MAX_VALUE,t*=3;for(var o=0;n>o;++o){var a=e[t++],i=e[t++],l=e[t++];a<r[0]&&(r[0]=a),i<r[1]&&(r[1]=i),l<r[2]&&(r[2]=l),a>r[3]&&(r[3]=a),i>r[4]&&(r[4]=i),l>r[5]&&(r[5]=l)}return r}function _(e,t){return!(e[0]>t[3]||e[0]<t[0]||e[1]>t[4]||e[1]<t[1])}function C(e,t){return!(t[0]>e[3]||t[3]<e[0]||t[1]>e[4]||t[4]<e[1])}function G(e,t){return t?!C(e,t):!1}function L(e){return"relative-to-ground"===e||"relative-to-scene"===e}function S(e){return"absolute-height"!==e}function I(e,t,n,o){if(t.needsOffsetAdjustment===!1||t.supportsOffsetAdjustment===!1)return!1;if("on-the-ground"===e.mode)return!1;if(0===e.meterUnitOffset){if(t.needsOffsetAdjustment===!0)return!0;if(r.isCalloutSupport(o)&&o.hasVisibleVerticalOffset())return!1;if("relative-to-ground"===e.mode&&(!n.hasZ||e.featureExpressionInfoContext))return!0;if("relative-to-scene"===e.mode)return!0}return!1}Object.defineProperty(t,"__esModule",{value:!0});var M=l.mat4d,z=l.vec3d,B=z.create(),N=M.identity(),X=new n({x:0,y:0,z:0,spatialReference:null});t.createStageObjectForPoint=c,t.extendPointGraphicElevationContext=s,t.placePointOnPolyline=f,t.placePointOnPolygon=v,t.computeElevation=g,t.getSingleSizeDriver=p,t.isCounterClockwise=x,t.copyPointData=m,t.copyPathData=y,t.copyVertices=E,t.chooseOrigin=b,t.subtractCoordinates=A,t.setZ=D,t.offsetZ=O,t.scaleZ=P,t.flatArrayToArrayOfArrays=j,t.reproject=w,t.reprojectPoint=U,t.getGeometryVertexData3D=V,t.getGeometryVertexDataDraped=R,t.computeBoundingBox=T,t.pointInBox2D=_,t.boxesIntersect2D=C,t.boundingBoxClipped=G,t.needsElevationUpdates2D=L,t.needsElevationUpdates3D=S,t.needsOffsetAdjustment=I;var F={verticalDistanceToGround:0,terrainElevation:0}});