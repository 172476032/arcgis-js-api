// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../../geometry/Point","../../../../geometry/support/mathUtils","./graphicUtils","./ElevationInfo","../../support/projectionUtils","../../lib/glMatrix","../../webgl-engine/lib/Object3D"],function(e,t,n,r,a,o,i){var l=o.mat4d,c=o.vec3d.create(),u=l.identity(),f={x:0,y:0,z:0,spatialReference:null},v={createStageObjectForPoint:function(e,t,n,r,a,o,l,f,s,p,g){var E=t?t.length:0,h=this._context.clippingExtent;if(v.reprojectPoint(e,c,this._context.elevationProvider.spatialReference),h&&!v.pointInBox2D(c,h))return null;v.reprojectPoint(e,c,this._context.renderSpatialReference);var D=this._context.localOriginFactory.getOrigin(c);p=void 0===p?!1:p;for(var d=new i({castShadow:!1,metadata:{layerId:f,graphicId:s,usesVerticalDistanceToGround:p},idHint:l}),y=0;E>y;y++){var x=r?r[y]:u;d.addGeometry(t[y],n[y],x,a,D,g)}var O=v.setObjectElevation(d,e,o,this._context.renderSpatialReference,this._context.elevationProvider);return{object:d,terrainElevation:O.terrainElevation}},extendPointGraphicElevationInfo:function(e,t,n){var r=e.elevationInfo,a=n.spatialReference;v.reprojectPoint(t,c,a),r.centerPointInElevationSR={x:c[0],y:c[1],z:t.hasZ?c[2]:void 0,spatialReference:a}},placePointOnPolyline:function(n){var r=n.paths[0],a=t.getPointOnPath(r,t.getPathLength(r)/2);return new e(a[0],a[1],a[2],n.spatialReference)},placePointOnPolygon:function(e){return n.computeCentroid(e)},computeElevation:function(e,t,n,a){var o=0,i=t.z||0,l=0,c=n.mode,u=n.offset||0;return c===r.MODES.ON_THE_GROUND?(l=e.getElevation(t)||0,o=l,a&&(a.verticalDistanceToGround=0,a.terrainElevation=l)):c===r.MODES.RELATIVE_TO_GROUND?(l=e.getElevation(t)||0,o=u,null==n.featureExpression&&(o+=i),a&&(a.verticalDistanceToGround=o,a.terrainElevation=l),o+=l):c===r.MODES.ABSOLUTE_HEIGHT&&(o=i+u,a&&(l=e.getElevation(t)||0,a.verticalDistanceToGround=o-l,a.terrainElevation=l)),o},applyElevation:function(e,t,n,a,o,i,l){var c=l.mode,u=l.offset,v=0,s=0,p=0;f.spatialReference=e.spatialReference,n*=3,o*=3;for(var g=0;i>g;++g)f.x=t[n+0],f.y=t[n+1],f.z=t[n+2],c===r.MODES.ON_THE_GROUND?(v=e.getElevation(f)||0,s=v,p+=v):c===r.MODES.RELATIVE_TO_GROUND?(v=e.getElevation(f)||0,s=v+u,null==l.featureExpression&&(s+=f.z),p+=v):c===r.MODES.ABSOLUTE_HEIGHT&&(s=f.z+u),a[o+0]=t[n+0],a[o+1]=t[n+1],a[o+2]=s,n+=3,o+=3;return p/=i,{terrainElevation:p}},setObjectElevation:function(e,t,o,i,l){var u,f=0;if(e.metadata.usesVerticalDistanceToGround)f=v.computeElevation(l,t,o,s),n.updateVertexAttributeAuxpos1w(e,s.verticalDistanceToGround),u=s.terrainElevation;else{var p=o.mode!==r.MODES.ABSOLUTE_HEIGHT;f=v.computeElevation(l,t,o,p?s:null),p&&(u=s.terrainElevation)}var g=e.getObjectTransformation();return c[0]=t.x,c[1]=t.y,c[2]=f,a.computeLinearTransformation(t.spatialReference,c,g,i)?e.setObjectTransformation(g):console.warn("Could not locate symbol object properly, it might be misplaced"),{terrainElevation:u}},getSingleSizeDriver:function(e){return isFinite(e[0])?e[0]:null},isCounterClockwise:function(e){for(var t=0,n=e.length-1,r=0;n>r;r++)t+=e[r][0]*e[r+1][1]-e[r+1][0]*e[r][1];return t>=0},copyPointData:function(e,t,n,r,a,o){r*=3;for(var i=0;a>i;++i){var l=e[t++];n[r++]=l[0],n[r++]=l[1],n[r++]=o?l[2]:0}return r/3},copyPathData:function(e,t){for(var n=e.length,r=new Array(n),a=new Array(n),o=new Array(n),i=0,l=0,c=0,u=0,f=0;n>f;++f)u+=e[f].length;for(var s=new Float64Array(3*u),p=0,g=n-1;g>=0;g--){var E=e[g];if(v.isCounterClockwise(E))r[i++]=E;else{var h=E.length;for(f=0;i>f;++f)h+=r[f].length;var D={index:p,pathLengths:new Array(i+1),count:h,holeIndices:new Array(i)};D.pathLengths[0]=E.length,E.length>0&&(o[c++]={index:p,count:E.length}),p=v.copyPointData(E,0,s,p,E.length,t);for(var d=0;i>d;++d){var y=r[d];D.holeIndices[d]=p,D.pathLengths[d+1]=y.length,y.length>0&&(o[c++]={index:p,count:y.length}),p=v.copyPointData(y,0,s,p,y.length,t)}i=0,D.count>0&&(a[l++]=D)}}for(d=0;i>d;++d)y=r[d],y.length>0&&(o[c++]={index:p,count:y.length}),p=v.copyPointData(y,0,s,p,y.length,t);return n>l&&(a.length=l),n>c&&(o.length=c),{vertexData:s,polygons:a,outlines:o}},copyVertices:function(e,t,n,r,a){t*=3,r*=3;for(var o=0;a>o;++o)n[r++]=e[t++],n[r++]=e[t++],n[r++]=e[t++]},chooseOrigin:function(e,t,n,r){var a=Math.floor(t+(n-1)/2);r[0]=e[3*a+0],r[1]=e[3*a+1],r[2]=e[3*a+2]},subtractCoordinates:function(e,t,n,r){t*=3;for(var a=0;n>a;++a)e[t++]-=r[0],e[t++]-=r[1],e[t++]-=r[2]},setZ:function(e,t,n,r){t*=3;for(var a=0;n>a;++a)e[t+2]=r,t+=3},offsetZ:function(e,t,n,r){t*=3;for(var a=0;n>a;++a)e[t+2]+=r,t+=3},scaleZ:function(e,t,n,r){t*=3;for(var a=0;n>a;++a)e[t+2]*=r,t+=3},flatArrayToArrayOfArrays:function(e,t,n){var r=[];t*=3;for(var a=0;n>a;++a)r.push([e[t++],e[t++],e[t++]]);return r},reproject:function(e,t,n,r,o,i,l){a.bufferToBuffer(e,n,t,r,i,o,l)},reprojectPoint:function(e,t,n){a.pointToVector(e,t,n)},getGeometryVertexData3D:function(e,t,n,r,a,o){var i=a.spatialReference,l=v.copyPathData(e,t),c=l.vertexData,u=c.length/3,f=new Float64Array(c.length);n.equals(i)?v.copyVertices(c,0,f,0,c.length):v.reproject(c,0,n,f,0,i,u);var s=v.applyElevation(a,f,0,c,0,u,o);return i.equals(r)||v.reproject(c,0,i,c,0,r,u),{geometryData:l,vertexData:c,eleVertexData:f,terrainElevation:s.terrainElevation}},getGeometryVertexDataDraped:function(e,t,n){var r=v.copyPathData(e,!1),o=r.vertexData,i=o.length/3;return t.equals(n)||a.bufferToBuffer(o,t,0,o,n,0,i),{geometryData:r,vertexData:o}},computeBoundingBox:function(e,t,n,r){r[0]=Number.MAX_VALUE,r[1]=Number.MAX_VALUE,r[2]=Number.MAX_VALUE,r[3]=-Number.MAX_VALUE,r[4]=-Number.MAX_VALUE,r[5]=-Number.MAX_VALUE,t*=3;for(var a=0;n>a;++a){var o=e[t++],i=e[t++],l=e[t++];o<r[0]&&(r[0]=o),i<r[1]&&(r[1]=i),l<r[2]&&(r[2]=l),o>r[3]&&(r[3]=o),i>r[4]&&(r[4]=i),l>r[5]&&(r[5]=l)}return r},pointInBox2D:function(e,t){return!(e[0]>t[3]||e[0]<t[0]||e[1]>t[4]||e[1]<t[1])},boxesIntersect2D:function(e,t){return!(t[0]>e[3]||t[3]<e[0]||t[1]>e[4]||t[4]<e[1])},boundingBoxClipped:function(e,t){return t?!v.boxesIntersect2D(e,t):!1},ELEV_MODES:r.MODES},s={verticalDistanceToGround:0,terrainElevation:0};return v});