// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../support/earthUtils","../../support/projectionUtils","../../support/intersectionUtils","../../support/mathUtils","../../support/aaBoundingBox","../../support/aaBoundingRect","../../lib/glMatrix"],function(t,e,i,n,r,s,o,a,u){var l=-.3*i.earthRadius,c=1.2,p=.5*Math.PI,d=p/Math.PI*180,h=p*i.earthRadius,f=.9*i.earthRadius,y=function(){function t(){this.extent=new Array(4),this.planes=new Array(4),this.maxSpan=0,this.center={origin:u.vec3d.create(),direction:u.vec3d.create()};for(var t=0;4>t;t++)this.extent[t]={origin:u.vec3d.create(),originLength:0,direction:u.vec3d.create(),cap:{next:null,direction:u.vec3d.create()}},this.planes[t]=u.vec4d.create();this.planes[4]=u.vec4d.create()}return t.prototype.toRenderBoundingExtent=function(t,e,i,r){var l=5;a.center(t,m),m[2]=r,n.computeLinearTransformation(i,m,x,e),u.mat4d.inverse(x,V),o.set(b,o.NEGATIVE_INFINITY);for(var c=0,p=v;c<p.length;c++)for(var d=p[c],h=d.x0,f=d.x1,y=d.y0,g=d.y1,w=0;l>w;w++){var E=w/(l-1);m[0]=s.lerp(t[h],t[f],E),m[1]=s.lerp(t[y],t[g],E),m[2]=r,n.vectorToVector(m,i,m,e),u.mat4d.multiplyVec3(V,m),o.expand(b,m)}u.mat4d.multiplyVec3(x,u.vec3d.set3(b[0],b[1],b[2],this.extent[0].origin)),u.mat4d.multiplyVec3(x,u.vec3d.set3(b[3],b[1],b[2],this.extent[1].origin)),u.mat4d.multiplyVec3(x,u.vec3d.set3(b[3],b[4],b[2],this.extent[2].origin)),u.mat4d.multiplyVec3(x,u.vec3d.set3(b[0],b[4],b[2],this.extent[3].origin))},t.prototype.update=function(t,e,i,n,r,s){var o=this.extent;this.toRenderBoundingExtent(t,i,n,s),u.vec3d.add(o[0].origin,o[2].origin,this.center.origin),u.vec3d.scale(this.center.origin,.5),e(this.center.origin,this.center.direction);for(var a=0;4>a;a++){var l=o[a];e(l.origin,l.direction),l.originLength=u.vec3d.length(l.origin);var c=o[3===a?0:a+1];l.cap.next=c.origin,u.vec3d.direction(c.origin,l.origin,l.cap.direction),this._computePlane(l.cap.direction,l.direction,l.origin,this.planes[a])}this._computePlane(o[1].cap.direction,o[0].cap.direction,o[0].origin,this.planes[4]),this.maxSpan=Math.max(Math.abs(t[0]-t[2]),Math.abs(t[1]-t[3]))},t.prototype.isVisibleInFrustumGlobal=function(t){if(u.vec3d.dot(this.center.direction,t.direction)<0)return!0;for(var e=0;4>e;e++){var i=this.extent[e];if(u.vec3d.dot(i.direction,t.direction)<0)return!0}return!1},t.prototype.isVisibleInFrustum=function(t,e,i){if("global"===t.viewingMode){var n=t.spatialReference.isWGS84?d:h;if(this.maxSpan>n)return!0;if(e.altitude>=f)return this.isVisibleInFrustumGlobal(e)}for(var s=0;s<this.extent.length;s++){var o=this.extent[s];if(r.frustumRay(e.planes,o.origin,null,o.direction))return!0;if(r.frustumLineSegment(e.planes,o.origin,o.cap.next,o.cap.direction))return!0}for(var s=0;s<e.lines.length;s++){var a=e.lines[s];if(r.frustumLineSegment(this.planes,a.origin,a.endpoint,a.direction))return!0}return!1},t.prototype._computePlane=function(t,e,i,n){u.vec3d.cross(t,e,n),n[3]=-u.vec3d.dot(n,i)},t}(),g=function(){function t(){this.frustumVisibility=!0,this.frustumVisibilityDirty=!0,this.extent=null,this.extentEngine=new y,this.extentEngineDirty=!0,this.renderSREqualsViewSR=null,this._isVisibleBelowSurface=!1,this.layerView=null}return t.prototype.initialize=function(t){this.layerView=t;var e=t.view.spatialReference,i=t.view.renderSpatialReference;this.renderSREqualsViewSR=i.equals(e)},t.prototype.destroy=function(){this.layerView=null,this.extent=null,this.extentEngine=null},t.prototype.needsIdleUpdate=function(){return this.frustumVisibilityDirty},t.prototype.canResume=function(){return this.frustumVisibility},t.prototype.setExtent=function(t){this.extent=t,this.extentEngineDirty=!0,this.frustumVisibilityDirty=!0},t.prototype.viewChange=function(){this.frustumVisibilityDirty=!0},t.prototype.elevationBoundsChange=function(){this.frustumVisibilityDirty=!0,this.extentEngineDirty=!0},Object.defineProperty(t.prototype,"isVisibleBelowSurface",{set:function(t){this._isVisibleBelowSurface=t,this.frustumVisibilityDirty=!0,this.extentEngineDirty=!0},enumerable:!0,configurable:!0}),t.prototype.idleUpdate=function(t){t.done()||this.frustumVisibilityDirty&&(this.updateSuspendFrustumVisible(),this.frustumVisibilityDirty=!1)},t.prototype.updateExtentEngine=function(){if(this.extentEngineDirty){this.extentEngineDirty=!1;var t,e=this.layerView.view,i=e.renderCoordsHelper.worldUpAtPosition.bind(e.renderCoordsHelper);if(this._isVisibleBelowSurface)t=l;else{var n=e.basemapTerrain.getElevationBounds(),r=n[0],s=n[1],o=Math.max(1,(s-r)*(c-1));t=r-o}this.extentEngine.update(this.extent,i,e.renderSpatialReference,e.spatialReference,this.renderSREqualsViewSR,t)}},t.prototype.updateSuspendFrustumVisible=function(){if(!this.extent)return void(this.frustumVisibility=!0);this.updateExtentEngine();var t=this.layerView.view.frustum,e=this.extentEngine.isVisibleInFrustum(this.layerView.view,t,this._isVisibleBelowSurface);e!==this.frustumVisibility&&(this.frustumVisibility=e,this.layerView._notifySuspendedChange())},t}(),v=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],m=u.vec3d.create(),x=u.mat4d.create(),V=u.mat4d.create(),b=o.create();return g});