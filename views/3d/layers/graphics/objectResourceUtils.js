// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/sniff","dojo/_base/lang","dojo/Deferred","dojo/errors/CancelError","../../../../request","../../../../core/Error","../../../../core/Version","../../../../core/Logger","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/materials/Material","../../webgl-engine/lib/Texture","../../support/aaBoundingBox"],function(e,r,a,t,n,i,s,o,l,u,c,p,f,m,d,v,g,y){function x(e,r){r=r||{};var a=r.streamDataSupplier;if(a){var t=a.request(e,"json"),n=new i(function(){return a.cancelRequest(t)});return t.then(function(e,a){try{var t=j(a,r);return n.resolve(t)}catch(i){return n.reject(i)}},function(e){n.reject(e instanceof s?e:b(e))}),n.promise}var l=o(e),u=new i(function(){return l.cancel()});return l.then(function(e){try{var a=j(e.data,r);return u.resolve(a)}catch(t){return u.reject(t)}},function(r){u.reject(r instanceof s?r:b(e))}),u.promise}function b(e){return new l("","Request for object resource failed: "+e)}function h(e){for(var r=e.stageResources[f.ModelContentType.GEOMETRY],a=y.create(y.NEGATIVE_INFINITY),t=[0,0,0],n=[0,0,0],i=0;i<r.length;i++){var s=r[i],o=s.getBoundingInfo();p.vec3d.set(o.getBBMin(),t),p.vec3d.set(o.getBBMax(),n);for(var l=0;3>l;++l)a[l]=Math.min(a[l],t[l]),a[l+3]=Math.max(a[l+3],n[l])}return a}function w(e){var r=e.params,a=r.topology,t=!0;switch(r.vertexAttributes||(I.warn("Geometry must specify vertex attributes"),t=!1),r.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:if(r.faces){if(r.vertexAttributes)for(var n in r.vertexAttributes){var i=r.faces[n];i&&i.values?(null!=i.valueType&&"UInt32"!==i.valueType&&(I.warn("Unsupported indexed geometry indices type '"+i.valueType+"', only UInt32 is currently supported"),t=!1),null!=i.valuesPerElement&&1!==i.valuesPerElement&&(I.warn("Unsupported indexed geometry values per element '"+i.valuesPerElement+"', only 1 is currently supported"),t=!1)):(I.warn("Indexed geometry does not specify face indices for '"+n+"' attribute"),t=!1)}}else I.warn("Indexed geometries must specify faces"),t=!1;break;default:I.warn("Unsupported topology '"+a+"'"),t=!1}e.params.material||(I.warn("Geometry requires material"),t=!1);var s=e.params.vertexAttributes;for(var o in s){var l=s[o];l.values||(I.warn("Geometries with externally defined attributes are not yet supported"),t=!1)}return t}function j(e,r){var a=[],i=[],s=[],o=[],l=[],c=u.Version.parse(e.version||"1.0","wosr");U.validate(c);var p="meshsymbol_"+e.model.name,f=e.textureDefinitions,y={};for(var x in f){var b=f[x],h=b.images[0].data;if(h){var j=b.encoding+";base64,"+h,E="/textureDefinitions/"+x,T={noUnpackFlip:!0,wrapClamp:!1};t("enable-feature:jkieboom/alpha-channel-usage")&&(T.wrapClamp=!0);var B=new g(j,p,T);l.push(B),y[E]={engineTexObj:B,alphaChannelUsage:"rgba"===b.channels?b.alphaChannelUsage||"transparency":"none"}}else I.warn("Externally referenced texture data is not yet supported")}for(var C=e.model.geometries,P=e.materialDefinitions,G=0;G<C.length;G++){var O=C[G];if(w(O)){var R=M(O),k=O.params.vertexAttributes,q={};for(var D in k){var S=k[D],V=S.values;q[D]={data:V,size:S.valuesPerElement}}s.push([]);var _={};if("PerAttributeArray"===O.params.topology){var F=q.position.data.length/q.position.size,N=A(F);for(var z in q)_[z]=N}else for(var L in O.params.faces)_[L]=new Uint32Array(O.params.faces[L].values);var Y=R.texture?y[R.texture]:null,H=o[R.material]?o[R.material][R.texture]:null;if(!H){var J=R.material.substring(R.material.lastIndexOf("/")+1),K=P[J].params;1===K.transparency&&(K.transparency=0);var Q={ambient:K.diffuse,diffuse:K.diffuse,specular:[0,0,0],shininess:0,opacity:1-(K.transparency||0),transparent:K.transparency>0,textureId:Y?Y.engineTexObj.getId():void 0,doubleSided:!0,cullFace:"none",flipV:!1,colorMixMode:K.externalColorMixMode||"tint"};t("enable-feature:jkieboom/alpha-channel-usage")&&(!Y||"transparency"!==Y.alphaChannelUsage&&"maskAndTransparency"!==Y.alphaChannelUsage||(Q.transparent=!0)),r&&r.materialParamsMixin&&n.mixin(Q,r.materialParamsMixin),H=new v(Q,p),o[R.material]||(o[R.material]={}),o[R.material][R.texture]=H,i.push(H)}s[G].push(H);var W=new m(new d(q,_),p);a.push(W)}}return{stageResources:{textures:l,materials:i,geometries:a},materialsByComponent:s,pivotOffset:e.model.pivotOffset}}function M(e){var r=e.params;return{id:1,material:r.material,texture:r.texture,region:r.texture}}function A(e){for(var r=new Uint32Array(e),a=0;e>a;a++)r[a]=a;return r}Object.defineProperty(r,"__esModule",{value:!0});var I=c.getLogger("esri.views.3d.layers.graphics.objectResourceUtils"),U=new u.Version(1,1,"wosr");r.fetch=x,r.computeBoundingBox=h,r.createStageResources=j});