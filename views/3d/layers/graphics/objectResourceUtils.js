// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/Deferred","dojo/sniff","dojo/_base/lang","dojo/errors/CancelError","../../../../request","../../../../core/Error","../../../../core/Logger","../../../../core/Version","../../lib/glMatrix","../../support/aaBoundingBox","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Texture","../../webgl-engine/materials/DefaultMaterial"],function(e,r,a,t,n,i,s,o,l,u,c,p,f,m,d,v,g,y){function x(e,r){r=r||{};var a=r.streamDataSupplier;if(a){var n=a.request(e,"json"),i=new t(function(){return a.cancelRequest(n)});return n.then(function(e,a){try{var t=j(a,r);return i.resolve(t)}catch(e){return i.reject(e)}},function(e){i.reject(e instanceof s?e:b(e))}),i.promise}var l=o(e),u=new t(function(){return l.cancel()});return l.then(function(e){try{var a=j(e.data,r);return u.resolve(a)}catch(e){return u.reject(e)}},function(r){u.reject(r instanceof s?r:b(e))}),u.promise}function b(e){return new l("","Request for object resource failed: "+e)}function h(e){for(var r=e.stageResources[m.ModelContentType.GEOMETRY],a=f.create(f.NEGATIVE_INFINITY),t=[0,0,0],n=[0,0,0],i=0;i<r.length;i++){var s=r[i],o=s.getBoundingInfo();p.vec3d.set(o.getBBMin(),t),p.vec3d.set(o.getBBMax(),n);for(var l=0;l<3;++l)a[l]=Math.min(a[l],t[l]),a[l+3]=Math.max(a[l+3],n[l])}return a}function w(e){var r=e.params,a=r.topology,t=!0;switch(r.vertexAttributes||(U.warn("Geometry must specify vertex attributes"),t=!1),r.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:if(r.faces){if(r.vertexAttributes)for(var n in r.vertexAttributes){var i=r.faces[n];i&&i.values?(null!=i.valueType&&"UInt32"!==i.valueType&&(U.warn("Unsupported indexed geometry indices type '"+i.valueType+"', only UInt32 is currently supported"),t=!1),null!=i.valuesPerElement&&1!==i.valuesPerElement&&(U.warn("Unsupported indexed geometry values per element '"+i.valuesPerElement+"', only 1 is currently supported"),t=!1)):(U.warn("Indexed geometry does not specify face indices for '"+n+"' attribute"),t=!1)}}else U.warn("Indexed geometries must specify faces"),t=!1;break;default:U.warn("Unsupported topology '"+a+"'"),t=!1}e.params.material||(U.warn("Geometry requires material"),t=!1);var s=e.params.vertexAttributes;for(var o in s){s[o].values||(U.warn("Geometries with externally defined attributes are not yet supported"),t=!1)}return t}function j(e,r){var a=[],t=[],s=[],o=[],l=[],u=c.Version.parse(e.version||"1.0","wosr");I.validate(u);var p="meshsymbol_"+e.model.name,f=e.textureDefinitions,m={};for(var x in f){var b=f[x],h=b.images[0].data;if(h){var j=b.encoding+";base64,"+h,E="/textureDefinitions/"+x,T={noUnpackFlip:!0,wrapClamp:!1};n("enable-feature:jkieboom/alpha-channel-usage")&&(T.wrapClamp=!0);var B=new g(j,p,T);l.push(B),m[E]={engineTexObj:B,alphaChannelUsage:"rgba"===b.channels?b.alphaChannelUsage||"transparency":"none"}}else U.warn("Externally referenced texture data is not yet supported")}for(var C=e.model.geometries,P=e.materialDefinitions,D=0;D<C.length;D++){var G=C[D];if(w(G)){var O=M(G),R=G.params.vertexAttributes,k={};for(var q in R){var S=R[q],V=S.values;k[q]={data:V,size:S.valuesPerElement}}s.push([]);var _={};if("PerAttributeArray"===G.params.topology){var F=k.position.data.length/k.position.size,N=A(F);for(var z in k)_[z]=N}else for(var L in G.params.faces)_[L]=new Uint32Array(G.params.faces[L].values);var Y=O.texture?m[O.texture]:null,H=o[O.material]?o[O.material][O.texture]:null;if(!H){var J=O.material.substring(O.material.lastIndexOf("/")+1),K=P[J].params;1===K.transparency&&(K.transparency=0);var Q={ambient:K.diffuse,diffuse:K.diffuse,specular:[0,0,0],opacity:1-(K.transparency||0),transparent:K.transparency>0,textureId:Y?Y.engineTexObj.id:void 0,doubleSided:!0,cullFace:"none",flipV:!1,colorMixMode:K.externalColorMixMode||"tint"};n("enable-feature:jkieboom/alpha-channel-usage")&&(!Y||"transparency"!==Y.alphaChannelUsage&&"maskAndTransparency"!==Y.alphaChannelUsage||(Q.transparent=!0)),r&&r.materialParamsMixin&&i.mixin(Q,r.materialParamsMixin),H=new y(Q,p),o[O.material]||(o[O.material]={}),o[O.material][O.texture]=H,t.push(H)}s[D].push(H);var W=new d(new v(k,_),p);a.push(W)}}return{stageResources:{textures:l,materials:t,geometries:a},materialsByComponent:s,pivotOffset:e.model.pivotOffset}}function M(e){var r=e.params;return{id:1,material:r.material,texture:r.texture,region:r.texture}}function A(e){for(var r=new Uint32Array(e),a=0;a<e;a++)r[a]=a;return r}Object.defineProperty(r,"__esModule",{value:!0});var U=u.getLogger("esri.views.3d.layers.graphics.objectResourceUtils"),I=new c.Version(1,1,"wosr");r.fetch=x,r.computeBoundingBox=h,r.createStageResources=j});