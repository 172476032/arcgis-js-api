// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/_base/lang","dojo/Deferred","dojo/errors/CancelError","../../../../request","../../../../core/Error","../../../../core/Version","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Util","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/materials/Material","../../webgl-engine/lib/Texture","../../support/aaBoundingBox"],function(e,r,t,n,a,o,i,s,l,u,c,p,m,d,f,v,g){function y(e,r){r=r||{};var t=r.streamDataSupplier;if(t){var n=t.request(e,"json"),s=new a(function(){return t.cancelRequest(n)});return n.then(function(e,t){try{var n=h(t,r);return s.resolve(n)}catch(a){return s.reject(a)}},function(e){s.reject(e instanceof o?e:x(e))}),s.promise}var l=i(e),u=new a(function(){return l.cancel()});return l.then(function(e){try{var t=h(e.data,r);return u.resolve(t)}catch(n){return u.reject(n)}},function(r){u.reject(r instanceof o?r:x(e))}),u.promise}function x(e){return new s("","Request for object resource failed: "+e)}function b(e){for(var r=e.stageResources[c.ModelContentType.GEOMETRY],t=g.create(g.NEGATIVE_INFINITY),n=[0,0,0],a=[0,0,0],o=0;o<r.length;o++)for(var i=r[o],s=i.getNumGroups(),l=0;s>l;++l){var u=i.getBoundingInfo(l);I.set(u.getBBMin(),n),I.set(u.getBBMax(),a);for(var p=0;3>p;++p)t[p]=Math.min(t[p],n[p]),t[p+3]=Math.max(t[p+3],a[p])}return t}function h(e,r){var t=[],a=[],o=[],i=[],s=[],u=l.Version.parse(e.version||"1.0","wosr");j.validate(u);var p="meshsymbol_"+e.model.name,g=e.textureDefinitions,y={};for(var x in g){var b=g[x],h=b.images[0].data;T(h,"symbol resources must have embedded texture data (at the moment)");var I=b.encoding+";base64,"+h,E="/textureDefinitions/"+x,B=new v(I,p,{noUnpackFlip:!0});s.push(B),y[E]={engineTexObj:B,transparent:"rgba"===b.channels}}for(var A=e.model.geometries,O=e.materialDefinitions,R=0;R<A.length;R++){var C=A[R];C.params.components||w(C);var S=C.params.components,D=S.length,G=C.params.faces,q=C.params.vertexAttributes,P=C.params.topology||"Indexed",U={};for(var V in q){var _=q[V],N=_.values;T(_.values,"symbol resources with external geometry bin not yet supported"),U[V]={data:N,size:_.valuesPerElement}}var F=void 0,Y=void 0,z=new Array(D);if("Indexed"===P){F=G.componentIndices,Y={};for(var k in G)Y[k]=G[k].byteOffset}else"PerAttributeArray"!==P?console.warn("I3S symbol loader: unsupported topology type "+P):1!==D&&console.warn("I3S symbol loader: if topology is not Indexed, only single component geometries are supported");o.push([]);for(var H=0;H<S.length;H++){var K=S[H],L={type:"triangle",positionKey:"position",indices:{}};if(F){var X=D-1>H?F[H+1]-F[H]:G.position.count-F[H];for(var J in G)if("componentIndices"!==J){var Q=G[J];T(Q.values,"symbol resources with external geometry bin not yet supported"),L.indices[J]=new Uint32Array(Q.values),Y[J]+=4*X}}else{var W=M(U.position.data.length/U.position.size);for(var Z in U)L.indices[Z]=W}z[H]=L;var $=void 0;K.texture&&($=y[K.texture].engineTexObj.getId());var ee=i[K.material]?i[K.material][K.texture]:null;if(!ee){var re=K.material.substring(K.material.lastIndexOf("/")+1),te=O[re].params;1===te.transparency&&(te.transparency=0);var ne={ambient:te.diffuse,diffuse:te.diffuse,specular:[0,0,0],shininess:0,opacity:1-te.transparency,transparent:te.transparency>0,textureId:$,doubleSided:!0,cullFace:"none",flipV:!1,colorMixMode:te.externalColorMixMode||"tint"};r.materialParamsMixin&&n.mixin(ne,r.materialParamsMixin),ee=new f(ne,p),i[K.material]||(i[K.material]={}),i[K.material][K.texture]=ee,a.push(ee)}o[R].push(ee)}var ae=new m(new d(z,U),p);t.push(ae)}return{stageResources:(oe={},oe[c.ModelContentType.TEXTURE]=s,oe[c.ModelContentType.MATERIAL]=a,oe[c.ModelContentType.GEOMETRY]=t,oe),materialsByComponent:o,pivotOffset:e.model.pivotOffset};var oe}function w(e){var r=e.params;T(r.material),r.components=[{id:1,material:e.params.material,texture:e.params.texture,region:e.params.texture}],r.faces&&(r.faces.componentIndices=[r.faces.position.count])}function M(e){for(var r=new Uint32Array(e),t=0;e>t;t++)r[t]=t;return r}Object.defineProperty(r,"__esModule",{value:!0});var I=u.vec3d,T=p.assert,j=new l.Version(1,1,"wosr");r.fetch=y,r.computeBoundingBox=b,r.createStageResources=h});