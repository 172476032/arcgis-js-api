// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/Handles","../../../../core/Logger","../../../../core/watchUtils","./deconflictorDebug","../../lib/glMatrix","../../support/aaBoundingRect","../../support/PreallocArray","../../webgl-engine/lib/screenSizePerspectiveUtils","../../webgl-engine/lib/Util","../../webgl-engine/materials/HUDMaterial","../../webgl-engine/materials/internal/MaterialUtil"],function(i,t,e,r,s,a,n,c,o,l,h,p,u,f){function d(i){return!!i&&"selection"===i.type}var g=c.vec2d,v=c.vec4d,y=p.VertexAttrConstants,m=s.getLogger("esri.views.3d.graphics.Deconflictor"),w=v.create(),b=v.create(),B=v.create(),x=v.create(),I=g.create(),G=o.create(),M=o.create(),D=new Set,S=p.lerp,T={icons:new l(100),labels:new l(100)},V=function(){function i(i,t){this.creator=i,this.disposer=t,this.list=[],this.currentIndex=0}return i.prototype.alloc=function(){for(var i=[],t=0;t<arguments.length;t++)i[t]=arguments[t];return this.currentIndex>=this.list.length&&this.list.push(new this.creator(i)),this.list[this.currentIndex++]},i.prototype.freeAll=function(){for(var i=this.currentIndex,t=this.disposer,e=this.list;--i>=0;)t(e[i]);this.currentIndex=0},i}(),N=function(){function i(){this.graphics3DGraphic=null,this.positions=[g.create(),g.create(),g.create(),g.create()],this.xMin=0,this.xMax=0,this.yMin=0,this.yMax=0,this.posView=0,this.graphicsOwner=null,this.id=0,this.graphicId=0}return i.release=function(i){i.graphics3DGraphic=null,i.graphicsOwner=null},i}(),O=function(){function i(i){var t=this;this.graphicsOwners=[],this.deconflictTimeoutId=0,this.handles=new r,this.graphicInfoPool=new V(N,N.release),this.nextGraphicInfoId=0,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0,this.iconMarginFactor=-.1,this.view=i,this.handles.add([i.watch("state.camera",function(){return t.scheduleRun()}),a.whenNot(i,"ready",function(){return t.clearDeconflictTimeout()})])}return i.prototype.destroy=function(){this.handles.destroy(),this.handles=null,this.clearDeconflictTimeout(),this.graphicInfoPool.freeAll(),this.graphicInfoPool=null,this.view=null},i.prototype.clearDeconflictTimeout=function(){this.deconflictTimeoutId&&(clearTimeout(this.deconflictTimeoutId),this.deconflictTimeoutId=0)},i.prototype.addGraphicsOwner=function(i){var t=this;this.graphicsOwners.push(i),this.setDirty(),i.layer&&"function"==typeof i.layer.watch&&i.layer.watch("featureReduction",function(e,r){d(e)?t.setDirty():d(r)&&(t._removeIconVisibilityFlags(i),t.setDirty())})},i.prototype.removeGraphicsOwner=function(i){var t=this.graphicsOwners.indexOf(i);t>=0&&this.graphicsOwners.splice(t,1),this.setDirty()},i.prototype.setDirty=function(){this.scheduleRun(10)},i.prototype.initializeLabelVisibility=function(i){i.setVisibilityFlag(2,!1,1)},i.prototype.doesIntersectExistingPoly=function(i){var t=i.graphicId,e=i.positions,r=D;r.clear();for(var s=Math.floor(i.xMin/this.accBinsSizeX);s<=Math.floor(i.xMax/this.accBinsSizeX);s++)if(!(s<0||s>=this.accBinsNumX))for(var a=Math.floor(i.yMin/this.accBinsSizeY);a<=Math.floor(i.yMax/this.accBinsSizeY);a++)if(!(a<0||a>=this.accBinsNumY)){var n=this.accBins[s][a];i:for(var c=0;c<n.length;c++){var o=n.data[c];if(o.graphicId!==t&&!r.has(o.id)){r.add(o.id);var l=o.positions;this.accNumTests++;for(var h=0;h<2;h++){var p=0===h?e:l,u=0===h?l:e;t:for(var f=0;f<4;f++){var d=p[f],v=p[(f+1)%4],y=p[(f+2)%4];I[0]=v[0]-d[0],I[1]=v[1]-d[1];var m=g.normalize(I);M=[-m[1],m[0]],m[0]=M[0],m[1]=M[1];for(var w=m[0]*d[0]+m[1]*d[1],b=m[0]*y[0]+m[1]*y[1]<w,B=0;B<4;B++){var x=u[B],G=m[0]*x[0]+m[1]*x[1];if(b&&G<w||!b&&G>w)continue t}continue i}}return!0}}}return!1;var M},i.prototype.initBins=function(i,t){if(null==this.accBins){this.accBins=[];for(var e=0;e<this.accBinsNumX;e++){this.accBins.push([]);for(var r=this.accBins[this.accBins.length-1],s=0;s<this.accBinsNumY;s++)r.push(new l(10))}}for(var e=0;e<this.accBinsNumX;e++)for(var s=0;s<this.accBinsNumY;s++)this.accBins[e][s].clear();this.accBinsSizeX=i/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0},i.prototype.addToBins=function(i){for(var t=Math.floor(i.xMin/this.accBinsSizeX);t<=Math.floor(i.xMax/this.accBinsSizeX);t++)if(!(t<0||t>=this.accBinsNumX))for(var e=Math.floor(i.yMin/this.accBinsSizeY);e<=Math.floor(i.yMax/this.accBinsSizeY);e++)e<0||e>=this.accBinsNumY||this.accBins[t][e].push(i)},i.prototype.scheduleRun=function(i){var t=this;void 0===i&&(i=200),0===this.deconflictTimeoutId&&(this.deconflictTimeoutId=setTimeout(function(){return t.run()},i))},i.prototype.run=function(){var i=this.view;if(this.clearDeconflictTimeout(),!i.ready)return void this.setDirty();var t=i.state.camera;this.graphicInfoPool.freeAll(),this.nextGraphicInfoId=0;var e=t.fullWidth,r=t.fullHeight;n.prepare(i),T.icons.clear(),T.labels.clear();for(var s=!1,a=0;a<this.graphicsOwners.length;a++){var c=this.graphicsOwners[a];if(null!=c.getGraphics3DGraphics&&null!=c.getGraphics3DGraphicsKeys){var o=null!=c.labelsEnabled&&c.labelsEnabled(),l=d(c.layer?c.layer.featureReduction:null);if(o||l){s||(this.initBins(e,r),s=!0);for(var h=c.getGraphics3DGraphics(),p=c.getGraphics3DGraphicsKeys(),u=0;u<p.length;u++){var f=h[p[u]];f.areVisibilityFlagsSet(void 0,2)&&(l&&this._collectGraphics(f,!1,c,t,T.icons,this.iconMarginFactor),o&&this._collectGraphics(f,!0,c,t,T.labels))}}}}T.icons.sort(function(i,t){return t.posView-i.posView}),T.labels.sort(function(i,t){return t.posView-i.posView}),this._deconflictVisibleObjects(T.icons,!1),T.labels.length&&this._deconflictVisibleObjects(T.labels,!0),n.drawAccelerationStruct(this,T.icons),n.drawAccelerationStruct(this,T.labels)},i.prototype._collectGraphics=function(i,t,e,r,s,a){void 0===a&&(a=0);var n=t?i._labelGraphics:i._graphics,c=t?1:0;if(n.length){for(var l,p,d,g=o.set(G,o.NEGATIVE_INFINITY),v=0,I=n;v<I.length;v++){var D=I[v];if(D&&!D.isDraped()){var T=D.stageObject,V=T?T.getNumGeometryRecords():0;if(!(V<1)){var N=T.getGeometryRecord(0),O=N.materials[0];if(O instanceof u)if(V>1)m.warn("Graphic objects with more than 1 geometry record are not supported");else{var A=N.geometry.getData(),X=A.getVertexAttr();if(!p){var Y=T.getCenter(),F=N.origin.vec3,_=f.transformToWorld(Y,F,w);p=f.transformToView(_,F,r.viewMatrix,b);var R=X[y.NORMAL].data;O.applyVerticalOffsetTransformation(p,R,T.objectTransformation,r,z);var j=X[y.AUXPOS1].data,U="screen"!==O.getParams().centerOffsetUnits,E=U?j:[0,0,0],H=f.transformToProjection(p,r.projectionMatrix,E,B);d=f.transformToNDC(H,x),U||(d[0]+=j[0]/r.fullWidth*2,d[1]+=j[1]/r.fullHeight*2);var K=d[0]<-1||d[1]<-1||d[2]<-1||d[0]>=1||d[1]>=1;if(K)break;l=p[2],i.areVisibilityFlagsSet(2,void 0,c)&&(l*=.7)}var L=D.getScreenSize(P);h.applyPrecomputedScaleFactorVec2(L,z.factor,L);var W=o.offset(O.calculateRelativeScreenBounds(L,z.scaleAlignment,M),S(0,r.fullWidth,.5+.5*d[0]),S(0,r.fullHeight,.5+.5*d[1]));if(0!==a){var C=a*Math.min(o.width(W),o.height(W));W[0]-=C,W[1]-=C,W[2]+=C,W[3]+=C}o.expand(g,W)}}}}if(null!=l){var k=this.graphicInfoPool.alloc();k.id=this.nextGraphicInfoId++,k.graphicId=i.graphic.uid,k.xMin=g[0],k.yMin=g[1],k.xMax=g[2],k.yMax=g[3],k.positions[0][0]=g[0],k.positions[0][1]=g[1],k.positions[1][0]=g[0],k.positions[1][1]=g[3],k.positions[2][0]=g[2],k.positions[2][1]=g[3],k.positions[3][0]=g[2],k.positions[3][1]=g[1],k.graphics3DGraphic=i,k.posView=l,k.graphicsOwner=e,s.push(k)}}},i.prototype._deconflictVisibleObjects=function(i,t){for(var e=t?1:0,r=0;r<i.length;r++){var s=i.data[r],a=s.graphics3DGraphic,c=t&&!1===a.areVisibilityFlagsSet(2,void 0),o=!c&&!this.doesIntersectExistingPoly(s);o&&this.addToBins(s),a.setVisibilityFlag(2,o,e),n.drawPoly(s.positions,o?"green":"red")}},i.prototype._removeIconVisibilityFlags=function(i){if(null!=i.getGraphics3DGraphics&&null!=i.getGraphics3DGraphicsKeys)for(var t=i.getGraphics3DGraphics(),e=i.getGraphics3DGraphicsKeys(),r=0,s=e;r<s.length;r++){var a=s[r],n=t[a];n.setVisibilityFlag(2,void 0)}},i}(),z={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},scaleAlignment:0,minPixelSizeAlignment:0},P=g.create();return O});