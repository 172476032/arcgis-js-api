// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","./ElevationInfo","../../webgl-engine/Stage","../../lib/glMatrix","../../support/aaBoundingBox"],function(e,t,i,n,s,r,o,a,u){function l(e,t,i){return i||(i=u.create()),u.setMin(i,e.getBBMin(t)),u.setMax(i,e.getBBMax(t)),i}var h=a.vec3d,g=a.mat4d,c=[0,0,0],d=function(){function e(t,i,n,s,r,o,a,u){this._addedToStage=!1,this.alignedTerrainElevation=0,this.graphics3DSymbolLayer=t,this.uniqueMaterials=s,this.uniqueGeometries=n,this.uniqueTextures=r,this.stageObject=i,this.elevationAligner=o,this.elevationInfo=new f(a),this.stage=null,this.stageLayer=null,this._shown=!1,this._visibilityFlags={},this.visibilityMode=null!=u?u:e.VisibilityModes.HIDE_FACERANGE}return e.prototype.initialize=function(e,t){if(this.stageLayer=e,this.stage=t,this.uniqueMaterials)for(var i=0;i<this.uniqueMaterials.length;i++)t.add(o.ModelContentType.MATERIAL,this.uniqueMaterials[i]);if(this.uniqueGeometries)for(var i=0;i<this.uniqueGeometries.length;i++)t.add(o.ModelContentType.GEOMETRY,this.uniqueGeometries[i]);if(this.uniqueTextures)for(var i=0;i<this.uniqueTextures.length;i++)t.add(o.ModelContentType.TEXTURE,this.uniqueTextures[i]);t.add(o.ModelContentType.OBJECT,this.stageObject)},e.prototype.isDraped=function(){return!1},e.prototype.areVisibilityFlagsSet=function(e,t){for(var i=!0,n=Object.keys(this._visibilityFlags),s=0;s<n.length;s++){var r=n[s];if(r!==t){if(r===e)return this._visibilityFlags[r];i=i&&this._visibilityFlags[r]}}return i},e.prototype.setVisibilityFlag=function(e,t){return this._visibilityFlags[e]=t,this._calcAndSetVisibility()},e.prototype._calcAndSetVisibility=function(){if(null!=this.stage){var t=this.areVisibilityFlagsSet();return this._shown!==t?(this._shown=t,this._shown?this._addedToStage?this.stageObject.unhideAllComponents():(this.stageLayer.addObject(this.stageObject),this._addedToStage=!0):this.visibilityMode===e.VisibilityModes.HIDE_FACERANGE?this.stageObject.hideAllComponents():(this.stageLayer.removeObject(this.stageObject),this._addedToStage=!1),!0):!1}},e.prototype.destroy=function(){var e=this.stage;if(this.stageLayer){if(this.uniqueMaterials)for(var t=0;t<this.uniqueMaterials.length;t++)e.remove(o.ModelContentType.MATERIAL,this.uniqueMaterials[t].getId());if(this.uniqueGeometries)for(var t=0;t<this.uniqueGeometries.length;t++)e.remove(o.ModelContentType.GEOMETRY,this.uniqueGeometries[t].getId());if(this.uniqueTextures)for(var t=0;t<this.uniqueTextures.length;t++)e.remove(o.ModelContentType.TEXTURE,this.uniqueTextures[t].getId())}e.remove(o.ModelContentType.OBJECT,this.stageObject.getId()),this._addedToStage&&(this.stageLayer.removeObject(this.stageObject),this._addedToStage=!1),this._shown=!1,this.stageLayer=null,this.stage=null},e.prototype.mustAlignToTerrain=function(){return null!==this.elevationAligner},e.prototype.alignWithElevation=function(e,t){this.elevationAligner&&this.elevationAligner(this,e,t)},e.prototype.setDrawOrder=function(e,t,i){},e.prototype.getBSRadius=function(){return this.stageObject.getBSRadius()},e.prototype.getCenterObjectSpace=function(){return this.stageObject.getCenter(!0)},e.prototype.getBoundingBoxObjectSpace=function(e){return l(this.stageObject,!0,e)},e.prototype.getProjectedBoundingBox=function(e,t,i){return s(this,void 0,void 0,function(){var s,o,a,l,a,h,d,f;return n(this,function(n){switch(n.label){case 0:for(s=this.getBoundingBoxObjectSpace(i),o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],a=0;a<o.length;a++)l=o[a],y[0]=s[l[0]],y[1]=s[l[1]],y[2]=s[l[2]],g.multiplyVec3(this.stageObject.objectTransformation,y),p[3*a+0]=y[0],p[3*a+1]=y[1],p[3*a+2]=y[2];if(!e(p,0,8))return[3,6];for(u.set(s,u.NEGATIVE_INFINITY),a=0;a<p.length;a+=3)for(h=0;3>h;h++)s[h]=Math.min(s[h],p[a+h]),s[h+3]=Math.max(s[h+3],p[a+h]);if(!t)return[3,5];if(u.center(s,c),this.elevationInfo.mode===r.MODES.ABSOLUTE_HEIGHT)return[3,5];d=void 0,n.label=1;case 1:return n.trys.push([1,3,,4]),[4,t.queryElevation(c[0],c[1])];case 2:return d=n.sent(),[3,4];case 3:return f=n.sent(),d=null,[3,4];case 4:null!=d&&u.offset(s,0,0,-this.alignedTerrainElevation+d),n.label=5;case 5:return[2,s];case 6:return[2,null]}})})},e.prototype.getScreenSize=function(){throw new Error("Not implemented for this symbol layer/graphic type")},e}();d.VisibilityModes={REMOVE_OBJECT:0,HIDE_FACERANGE:1};var p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],y=h.create(),f=function(e){function t(t){var i=e.call(this,t)||this;return i.centerPointInElevationSR=null,i}return i(t,e),t}(r);return d});