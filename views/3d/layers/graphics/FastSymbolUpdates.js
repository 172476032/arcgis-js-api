// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../../renderers/support/utils","../../lib/glMatrix","../../support/mathUtils"],function(e,o,t,n,i){function a(e){return null!==e&&void 0!==e}function l(e){return"number"==typeof e}function r(e){return"string"==typeof e}function s(e){return null==e||r(e)}function u(e,o){e&&e.push(o),v(o)}function f(e){M&&console.warn("[FastSymbolUpdates] "+e)}function v(e){M&&console.info("[FastSymbolUpdates] "+e)}function d(e,o,n,i,r){var s=e.minSize,f=e.maxSize;if(e.expression)return u(r,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){var v=i.symbolSize[n];return o.minSize[n]=v,o.maxSize[n]=v,o.offset[n]=o.minSize[n],o.factor[n]=0,o.type[n]=1,!0}if(a(e.field))return a(e.stops)?2===e.stops.length&&l(e.stops[0].size)&&l(e.stops[1].size)?(c(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,o,n),o.type[n]=1,!0):(u(r,"Could not convert size info: stops only supported with 2 elements"),!1):l(s)&&l(f)&&a(e.minDataValue)&&a(e.maxDataValue)?(c(s,f,e.minDataValue,e.maxDataValue,o,n),o.type[n]=1,!0):null!=t.meterIn[e.valueUnit]?(o.minSize[n]=-(1/0),o.maxSize[n]=1/0,o.offset[n]=0,o.factor[n]=1/t.meterIn[e.valueUnit],o.type[n]=1,!0):"unknown"===e.valueUnit?(u(r,"Could not convert size info: proportional size not supported"),!1):(u(r,"Could not convert size info: scale-dependent size not supported"),!1);if(!a(e.field)){if(e.stops&&e.stops[0]&&l(e.stops[0].size))return o.minSize[n]=e.stops[0].size,o.maxSize[n]=e.stops[0].size,o.offset[n]=o.minSize[n],o.factor[n]=0,o.type[n]=1,!0;if(l(s))return o.minSize[n]=s,o.maxSize[n]=s,o.offset[n]=s,o.factor[n]=0,o.type[n]=1,!0}return u(r,"Could not convert size info: unsupported variant of sizeInfo"),!1}function c(e,o,t,n,i,a){var l=Math.abs(n-t)>0?(o-e)/(n-t):0;i.minSize[a]=l>0?e:o,i.maxSize[a]=l>0?o:e,i.offset[a]=e-t*l,i.factor[a]=l}function z(e,o,t,n){if(e.normalizationField||e.valueRepresentation)return u(n,"Could not convert size info: unsupported property"),null;if(!s(e.field))return u(n,"Could not convert size info: field is not a string"),null;if(o.size){if(e.field)if(o.size.field){if(e.field!==o.size.field)return u(n,"Could not convert size info: multiple fields in use"),null}else o.size.field=e.field}else o.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[0,0,0]};var i;switch(e.axis){case"width":return i=d(e,o.size,0,t,n),i?o:null;case"height":return i=d(e,o.size,2,t,n),i?o:null;case"depth":return i=d(e,o.size,1,t,n),i?o:null;case"width-and-depth":return i=d(e,o.size,0,t,n),i&&d(e,o.size,1,t,n),i?o:null;case null:case void 0:case"all":return i=d(e,o.size,0,t,n),i=i&&d(e,o.size,1,t,n),i=i&&d(e,o.size,2,t,n),i?o:null;default:return u(n,'Could not convert size info: unknown axis "'+e.axis+'""'),null}}function p(e,o,t){for(var n=0;3>n;++n){var i=o.unitInMeters;1===e.type[n]&&(i*=o.modelSize[n],e.type[n]=2),e.minSize[n]=e.minSize[n]/i,e.maxSize[n]=e.maxSize[n]/i,e.offset[n]=e.offset[n]/i,e.factor[n]=e.factor[n]/i}var a;if(0!==e.type[0])a=0;else if(0!==e.type[1])a=1;else{if(0===e.type[2])return u(t,"No size axis contains a valid size or scale"),!1;a=2}for(var n=0;3>n;++n)0===e.type[n]&&(e.minSize[n]=e.minSize[a],e.maxSize[n]=e.maxSize[a],e.offset[n]=e.offset[a],e.factor[n]=e.factor[a],e.type[n]=e.type[a]);return!0}function m(e,o,t){e[4*o+0]=t.r/255,e[4*o+1]=t.g/255,e[4*o+2]=t.b/255,e[4*o+3]=t.a}function S(e,o,t){if(e.normalizationField)return u(t,"Could not convert color info: unsupported property"),null;if(r(e.field))if(e.stops){if(e.stops.length>8)return u(t,"Could not convert color info: too many color stops"),null;o.color={field:e.field,values:[],colors:[]};for(var n=e.stops,i=0;8>i;++i){var l=Math.min(i,n.length-1),s=n[l];o.color.values[i]=s.value,m(o.color.colors,i,s.color)}}else{if(!e.colors)return u(t,"Could not convert color info: missing stops or colors"),null;if(!a(e.minDataValue)||!a(e.maxDataValue))return u(t,"Could not convert color info: missing data values"),null;if(2!==e.colors.length)return u(t,"Could not convert color info: invalid colors array"),null;o.color={field:e.field,values:[],colors:[]},o.color.values[0]=e.minDataValue,m(o.color.colors,0,e.colors[0]),o.color.values[1]=e.maxDataValue,m(o.color.colors,1,e.colors[1]);for(var i=2;8>i;++i)o.color.values[i]=e.maxDataValue,m(o.color.colors,i,e.colors[1])}else{if(!(e.stops&&e.stops.length>=0||e.colors&&e.colors.length>=0))return u(t,"Could not convert color info: no field and no colors/stops"),null;var f=e.stops&&e.stops.length>=0?e.stops[0].color:e.colors[0];o.color={field:null,values:new Array(8),colors:new Array(32)};for(var i=0;8>i;i++)o.color.values[i]=1/0,m(o.color.colors,i,f)}return o}function b(e,o,t){return r(e.field)?(o.rotation={field:e.field,rotationType:e.rotationType},o):(u(t,"Could not convert rotation info: field is not a string"),null)}function y(e,o,t){if(!e)return null;M&&(t=t||[]);var n=e.reduce(function(e,n){if(!e)return e;if(n.valueExpression)return u(t,"Could not convert visual variables: arcade expressions not supported"),null;switch(n.type){case"size":return z(n,e,o,t);case"color":return S(n,e,t);case"rotation":return b(n,e,t);default:return u(t,"Could not convert visual variables: unsupported type "+n.type),null}},{size:null,color:null,rotation:null});return n&&n.size&&!p(n.size,o,t)?null:n}function x(e){return e&&(null!=e.size||null!=e.rotation)}function V(e,o,t){if(E)return f("State not initialized, fast updates disabled (globally disabled)"),{enabled:!1};if(!o)return f("State not initialized, fast updates disabled (no shader support)"),{enabled:!1};if(!e)return f("State not initialized, fast updates disabled (no renderer)"),{enabled:!1};var n=e;if(n.disableFastUpdates)return f("State not initialized, fast updates disabled (renderer.disableFastUpdates set)"),{enabled:!1};var i=y(e.visualVariables,t);return i?(v("State initialized, fast updates enabled"),{enabled:!0,visualVariables:i,materialParameters:g(i,t),customTransformation:x(i)}):(f("State not initialized, fast updates disabled (conversion failed)"),{enabled:!1})}function h(e,o,t){if(!o||!e.enabled)return!1;var n=e.visualVariables,i=y(o.visualVariables,t);return i?C(n.size,i.size,"size")&&C(n.color,i.color,"color")&&C(n.rotation,i.rotation,"rotation")?(e.visualVariables=i,e.materialParameters=g(i,t),e.customTransformation=x(i),v("State updated"),!0):!1:(f("State update failed (conversion failed)"),!1)}function C(e,o,t){return!!e!=!!o?(f("State update failed ({$name} enabled/disabled)"),!1):e&&e.field!==o.field?(f("State update failed ({$name} field changed)"),!1):!0}function g(e,o){var t={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvAnchorValue:null,vvRotationEnabled:!1,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null},n=x(e);return e&&e.size?(t.vvSizeEnabled=!0,t.vvSizeMinSize=e.size.minSize,t.vvSizeMaxSize=e.size.maxSize,t.vvSizeOffset=e.size.offset,t.vvSizeFactor=e.size.factor):e&&n&&(t.vvSizeValue=o.transformation.scale),e&&e.rotation&&(t.vvRotationEnabled=!0),e&&n&&(t.vvRotationValue=o.transformation.rotation,t.vvAnchorValue=o.transformation.anchor),e&&e.color&&(t.vvColorEnabled=!0,t.vvColorValues=e.color.values,t.vvColorColors=e.color.colors),t}var M=!1,E=!1;o.convertVisualVariables=y,o.initFastSymbolUpdatesState=V,o.updateFastSymbolUpdatesState=h,o.getMaterialParams=g;var F;!function(e){function o(e,o,t){return o>e?o:e>t?t:e}function t(e,t,n){var l=e.vvSizeEnabled||e.vvRotationEnabled;if(!l)return n;a.identity(r);var u=0;if(e.vvRotationEnabled&&(u+=t[2]),null!=e.vvRotationValue&&(u+=i.deg2rad(e.vvRotationValue)),0!==u&&a.rotateZ(r,-u,r),e.vvSizeEnabled){for(var f=0;3>f;++f){var v=e.vvSizeOffset[f]+t[0]*e.vvSizeFactor[f];s[f]=o(v,e.vvSizeMinSize[f],e.vvSizeMaxSize[f])}a.scale(r,s,r)}else a.scale(r,e.vvSizeValue,r);return a.translate(r,e.vvAnchorValue,r),a.multiply(n,r,r),r}var a=n.mat4d,l=n.vec3,r=a.create(),s=l.create();e.evaluateModelTransform=t}(F||(F={})),o.evaluateModelTransform=F.evaluateModelTransform});