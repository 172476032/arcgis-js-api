// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","dojo/promise/all","../../../../core/HandleRegistry","../../../../core/watchUtils","../../../../layers/support/LabelClass","../../lib/glMatrix","../../webgl-engine/lib/TextTextureAtlas","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/materials/HUDMaterial","./Graphics3DWebStyleSymbol"],function(e,t,r,a,i,l,s,n,o,h,c){function f(e){return e instanceof c?e.graphics3DSymbol:e}var b,p=s.vec3d,y="VISIBILITY_LABEL_SHOW",u=function(){function e(){this.textTextureAtlas=null,this.hudMaterialCollection=null,this.labelVisibilityDirty=!1,this.labelClasses=[],this.eventHandles=new a,this.layerView=null,this.layer=null,this.graphicsCore=null}return e.prototype.initialize=function(e,t,r,a){var l=this;this.layerView=e,this.layer=t,this.graphicsCore=a,this.labelGraphicsCreated=r,this.layerView.view.labelManager.addSceneServiceLayerView(this),this.eventHandles.add(i.whenNot(this.layerView,"suspended",function(){return l.resume()}))},e.prototype.destroy=function(){this.layerView.view.labelManager.removeSceneServiceLayerView(this),this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null),this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null),this.labelClasses=null,this.eventHandles.destroy(),this.eventHandles=null,this.layerView=null,this.layer=null,this.graphicsCore=null},e.prototype.clear=function(){this.layerView.view.labelManager.setDirty(),this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null),this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null)},e.prototype.updateLabelingInfo=function(){var e=this;return this.removeLabels(),this.layer.then(function(){var t=e.layer.labelingInfo&&e.layer.labelingInfo.filter(function(e){return!!e.symbol});if(t&&t.length>0){var a=new Array(t.length),i=t.map(function(t,r){var i=e.graphicsCore.getOrCreateGraphics3DSymbol(t.symbol),l=f(i);return a[r]={labelClass:t,graphics3DSymbolLayer:l,options:t.getOptions()},i});return r(i).then(function(){return a})}return null}).then(function(t){e.labelClasses=t,e.labelVisibilityChanged()})},e.prototype.createLabelsForGraphic=function(e,t){var r=!1;if(this.labelClasses&&0!==this.labelClasses.length&&t._graphics[0]){for(var a=0;a<this.labelClasses.length;a++){var i=this.labelClasses[a],s=i.labelClass;if(l.evaluateWhere(s.where,e.attributes)){var h=s.getLabelExpression();if(h.expression){var c=l.buildLabelText(h.expression,e,this.layer.fields,i.options);if(c){var f=i.graphics3DSymbolLayer.childGraphics3DSymbols[0],b=this.evalLabelPlacementParams(e,t);null==this.textTextureAtlas&&(this.textTextureAtlas=new n(this.layer.id,this.layerView.view._stage),this.hudMaterialCollection=new o(this.layerView.view._stage));var p={text:c,centerOffset:b.centerOffset,translation:b.translation,screenOffset:b.screenOffset,anchor:b.anchor},u=f.createGraphics3DGraphic(e,p,this.hudMaterialCollection,this.textTextureAtlas);u&&(u._labelClass=i.labelClass,t.addLabelGraphic(u,this.graphicsCore.labelStageLayer,this.graphicsCore.stage),u.setVisibilityFlag(y,this.layerLabelsEnabled()),this.layerView.view.labelManager.setInitialLabelGraphicState(u),r=!0);break}}}}r&&this.labelGraphicsCreated&&this.labelGraphicsCreated(e,t)}},e.prototype.evalLabelPlacementParams=function(e,t){var r=this.layer.labelingInfo[0],a=g[r.labelPlacement]||g["default"];if("polygon"===e.geometry.type)return{anchor:"center"};if("polyline"===e.geometry.type)return{anchor:"center"};if("extent"===e.geometry.type)return{anchor:"center"};if("point"!==e.geometry.type)return{anchor:a.anchor};var i=t.graphics3DSymbol,l=i instanceof c?i.graphics3DSymbol:i,s=l.symbol.symbolLayers.getItemAt(0),n={screenOffset:[0,0],centerOffset:[0,0,0,-1],translation:p.create(t.getCenterObjectSpace()),anchor:a.anchor},o=t._graphics[0];if("Icon"===s.type){var f=o.getScreenSize();if(t.isDraped())n.anchor="center";else{var b=o.stageObject.getGeometryRecords()[0].materials[0];if(b instanceof h){var y=b.getParams();n.screenOffset=[f[0]/2*(a.normalizedOffset[0]-2*(y.anchorPos[0]-.5)),f[1]/2*(a.normalizedOffset[1]-2*(y.anchorPos[1]-.5))]}else n.screenOffset=[f[0]/2*a.normalizedOffset[0],f[1]/2*a.normalizedOffset[1]]}}else if("Object"===s.type){var u=o.getBoundingBoxObjectSpace(),f=[u[3]-u[0],u[4]-u[1],u[5]-u[2]],d=1.1,v=Math.max(f[0],f[1]);n.centerOffset[0]=v*d/2*a.normalizedOffset[0],n.translation[2]+=f[2]*d/2*a.normalizedOffset[1];var m=p.length(f);n.centerOffset[2]=m*d/2*a.normalizedOffset[2]}return n},e.prototype.layerLabelsEnabled=function(){return this.layer.labelsVisible},e.prototype.getGraphics3DGraphics=function(){return this.graphicsCore.getGraphics3DGraphics()},e.prototype.getGraphics3DGraphicsKeys=function(){return this.graphicsCore.getGraphics3DGraphicsKeys()},e.prototype.labelVisibilityChanged=function(){var e=this;if(this.layerView.suspended)return void(this.labelVisibilityDirty=!0);if(this.layerView.loadedGraphics){var t=this.layerLabelsEnabled();this.layerView.loadedGraphics.forEach(function(r){var a=e.graphicsCore.getGraphics3DGraphicById(r.uid);if(a){t&&0===a._labelGraphics.length&&e.createLabelsForGraphic(r,a);for(var i=0;i<a._labelGraphics.length;i++){var l=a._labelGraphics[i];l.setVisibilityFlag(y,t)}}}),this.layerView.view.labelManager.setDirty(),this.labelVisibilityDirty=!1}},e.prototype.elevationInfoChange=function(){this.labelClasses&&this.labelClasses.forEach(function(e){e.graphics3DSymbolLayer.layerPropertyChanged("elevationInfo",{})})},e.prototype.resume=function(){this.labelVisibilityDirty&&this.labelVisibilityChanged()},e.prototype.removeLabels=function(){var e=this;this.layerView.loadedGraphics&&(this.layerView.loadedGraphics.forEach(function(t){var r=e.graphicsCore.getGraphics3DGraphicById(t.uid);r&&(r._labelGraphics&&r._labelGraphics.forEach(function(e){return e._labelClass=null}),r.clearLabelGraphics())}),this.labelClasses=null,this.layerView.view.labelManager.setDirty())},e}(),g={"above-center":{normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{normalizedOffset:[0,0,1],anchor:"center"},"center-left":{normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{normalizedOffset:[1,0,0],anchor:"left"}},d={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(var v in d){var m=d[v];b=g[v],m.forEach(function(e){g[e]=b})}return Object.freeze&&(Object.freeze(g),Object.keys(g).forEach(function(e){Object.freeze(g[e]),Object.freeze(g[e].normalizedOffset)})),u});