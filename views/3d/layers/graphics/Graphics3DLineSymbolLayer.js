// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./Graphics3DDrapedGraphicLayer","./ElevationAligners","./Graphics3DSymbolCommonCode","./lineUtils","../../../../core/screenUtils","../../../../geometry/Polygon","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/RenderGeometry","./graphicUtils"],function(e,t,r,i,a,n,o,s,l,h,p,y,u,g,c,d,v){var _=y.vec3d,m=y.mat4d,f=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._prepareResources=function(){var e=this.symbol,t=this._isPropertyDriven("size")||this._isPropertyDriven("color")||this._isPropertyDriven("opacity"),r={idHint:this._getStageIdHint(),width:this._getWidth(e),color:this._getMaterialOpacityAndColor()};if(!this._isPropertyDriven("size")){var i=v.validateSymbolLayerSize(r.width);if(i)return this._logWarning(i),void this.reject()}if(t||r.width>=1.5)this._isPropertyDriven("size")&&(r.width=0),this._isNativeLineMaterial=!1,this._material=l.createRibbonMaterial(r);else{if(!(r.width>0))return void this.reject();this._isNativeLineMaterial=!0,this._material=l.createNativeMaterial(r)}this._context.stage.add(u.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype._getWidth=function(e){return null!=e.size?h.pt2px(e.size):1},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(u.ModelContentType.MATERIAL,this._material.getId()),this._material=null)},t.prototype.createGraphics3DGraphic=function(e,t){var r=this._validateGeometry(e.geometry);if("polyline"!==r.type&&"polygon"!==r.type&&"extent"!==r.type)return this._logWarning("unsupported geometry type for line symbol: "+r.type),null;var i="polygon"===r.type||"extent"===r.type?"rings":"paths",a="graphic"+e.uid,n=this._getVertexOpacityAndColor(t,Float32Array,255),o=0;t.size&&this._isPropertyDriven("size")&&(o=s.getSingleSizeDriver(t.size),o=h.pt2px(o));var l=this.getGraphicElevationInfo(e);return"on-the-ground"===l.mode?this._createAsOverlay(e,i,n,o,l,a):this._createAs3DShape(e,i,n,o,l,a,e.uid)},t.prototype.layerPropertyChanged=function(e,t,r){if("opacity"===e){if(this._isNativeLineMaterial){var i=this._material.getColor();i[3]=this._getMaterialOpacity(),this._material.setColor(i)}else{var a=this._material.getParameterValues();a.color[3]=this._getMaterialOpacity(),this._material.setParameterValues({color:a.color})}return!0}if("elevationInfo"===e){var n=this._elevationInfo.mode;this._updateElevationInfo();var o=this._elevationInfo.mode;if(null==n||null==o)return!1;if("on-the-ground"===n&&"on-the-ground"===o)return!0;if(n!==o&&("on-the-ground"===n||"on-the-ground"===o))return!1;var l=s.needsElevationUpdates2D(o);for(var h in t){var p=t[h],y=r(p);if(y&&!y.isDraped()){var u=p.graphic;y.needsElevationUpdates=l,y.elevationInfo.set(this.getGraphicElevationInfo(u))}}return!0}return!1},t.prototype._getOutlineGeometry=function(e,t){return t},t.prototype._getGeometry=function(e){var t=this._validateGeometry(e.geometry);return"extent"===t.type&&(t=p.fromExtent(t)),t},t.prototype._createAs3DShape=function(e,t,r,i,n,h,p){var y=this._getGeometry(e),u=y.hasZ,d=y[t],v=this._getOutlineGeometry(y,d),f=[],x=[],E=[],D=_.create(),b=new Array(6),G=s.getGeometryVertexData3D(v,u,y.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,n);if(this._logGeometryCreationWarnings(G,d,t,"LineSymbol3DLayer"),v.length>0){for(var w=G.geometryData.outlines,S=G.eleVertexData,A=G.vertexData,L=0;L<w.length;++L){var M=w[L],P=M.index,C=M.count;if(!this._context.clippingExtent||(s.computeBoundingBox(S,P,C,b),!s.boundingBoxClipped(b,this._context.clippingExtent))){s.chooseOrigin(A,P,C,D),s.subtractCoordinates(A,P,C,D);var R=new Float64Array(S.buffer,3*P*S.BYTES_PER_ELEMENT,3*C),O=new Float64Array(A.buffer,3*P*A.BYTES_PER_ELEMENT,3*C),I=l.createPolylineGeometry(O,R,"rings"===t,r,i),T=new c(I,h+"path"+L);T.singleUse=!0,f.push(T),x.push([this._material]);var z=m.identity();m.translate(z,D,z),E.push(z)}}if(f.length>0){var B=new g({geometries:f,materials:x,transformations:E,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicId:p},idHint:h}),U=o.perVertexElevationAligner,N=new a(this,B,f,null,null,U,n);return N.alignedTerrainElevation=G.terrainElevation,N.needsElevationUpdates=s.needsElevationUpdates2D(n.mode),N}}return null},t.prototype._createAsOverlay=function(e,t,r,i,a,o){var h=this._getGeometry(e);this._material.setRenderPriority(this._symbolLayerOrder);var p=h[t],y=this._getOutlineGeometry(h,p),u=[],g=new Array(6),c=_.create(),v=s.getGeometryVertexDataDraped(y,h.spatialReference,this._context.overlaySR);if(this._logGeometryCreationWarnings(v,p,t,"LineSymbol3DLayer"),y.length>0){for(var f=v.vertexData,x=v.geometryData.outlines,E=0;E<x.length;++E){var D=x[E],b=D.index,G=D.count;if(s.computeBoundingBox(f,b,G,g),!s.boundingBoxClipped(g,this._context.clippingExtent)){s.chooseOrigin(f,b,G,c),s.subtractCoordinates(f,b,G,c),s.setZ(f,b,G,this._getDrapedZ());var w=new Float64Array(f.buffer,3*b*f.BYTES_PER_ELEMENT,3*G),S=m.identity();m.translate(S,c,S);var A=l.createPolylineGeometry(w,null,"rings"===t,r,i),L=new d(A);L.material=this._material,L.center=[.5*(g[0]+g[3]),.5*(g[1]+g[4]),0],L.bsRadius=.5*Math.sqrt((g[3]-g[0])*(g[3]-g[0])+(g[4]-g[1])*(g[4]-g[1])),L.transformation=S,L.name=o,L.uniqueName=o+"#"+A.id,u.push(L)}}return new n(this,u,null,null,g,a)}return null},t}(i);return f});