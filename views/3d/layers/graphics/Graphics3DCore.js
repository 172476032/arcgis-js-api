// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/watchUtils","../../../../core/arrayUtils","../../../../core/Error","../../../../core/Logger","../../../../core/promiseUtils","../../support/projectionUtils","../../../../renderers/UniqueValueRenderer","../../../../renderers/support/rendererConversion","../../../../renderers/support/diffUtils","../../../../geometry/Point","../../../../geometry/Extent","../../webgl-engine/Stage","../../webgl-engine/lib/Util","../../webgl-engine/lib/Layer","../../webgl-engine/lib/FloatingBoxLocalOriginFactory","../../../../symbols/WebStyleSymbol","../../../../symbols/LabelSymbol3D","../../../../symbols/TextSymbol","../../../../symbols/support/symbolConversion","../../../../symbols/support/unitConversionUtils","../../lib/glMatrix","./featureExpressionInfoUtils","./Graphics3DGraphic","./Graphics3DWebStyleSymbol","./graphicUtils","./Graphics3DSymbolFactory","./Graphics3DOwner","./ElevationQuery","../../support/aaBoundingBox","../../support/mathUtils","dojo/Deferred"],function(e,t,i,a,r,s,n,o,l,h,p,d,c,y,u,g,f,b,m,v,S,w,C,D,x,G,V,I,R,E,U,L,F,B,O){function H(e){var t=e.elevationInfo&&e.elevationInfo.unit;t&&!D.supportsUnit(t)&&W.warn("elevationInfo.unit","'"+t+"' is not a valid unit")}function z(e){return"point"===e.type}function T(e){return"polygon"===e.type||"polyline"===e.type||"multipoint"===e.type}var A=x.vec3d,q=!1,k=!1,_=500,j=new y,P=A.create(),W=o.getLogger("esri.views.3d.layers.graphics.Graphics3DCore"),M=function(){function e(e){void 0===e&&(e=!0),this.elevationFeatureExpressionEnabled=e,this.graphics={},this.graphicsDrapedIds={},this.graphicsBySymbol={},this.graphicsKeys=[],this.symbols={},this.graphicsWithoutSymbol={},this.computedExtent=null,this.symbolCreationContext=new U.Graphics3DSymbolCreationContext,this.hasDraped=!1,this.updatingGraphicIds=new Set,this.lastFastUpdate=null,this.tilingSchemeHandle=null,this.stageLayer=null,this.labelStageLayer=null,this.stage=null,this.onComputedExtentChange=null,this.graphicTransformFunc=null,this.eventHandles=[],this.viewSR=null,this.layerView=null,this.layer=null,this.elevation=null,this.scaleVisibility=null,this.spatialIndex=null,this.labeling=null,this.elevationQueryService=null,this.highlights=null,this.sharedSymbolResourcesOwnerHandle=null,this.whenGraphics3DGraphicRequests={}}return e.prototype.initialize=function(t,i,a,s,n,o,l,h,p,d){var c=this;this.layerView=t,this.layer=i,this.viewSR=t.view.spatialReference,this.elevation=a,this.scaleVisibility=s,this.spatialIndex=n,this.labeling=o,this.highlights=l,this.onComputedExtentChange=h,this.graphicTransformFunc=p;var y=this.layerView.view;this.elevationQueryService=new L.ElevationQuery(this.viewSR,function(){return y.map.ground},{maximumAutoTileRequests:4}),this.initializeStage(y,this.layer.uid),this.symbolCreationContext.sharedResources=y.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=y.sharedSymbolResources.addGraphicsOwner(this),this.symbolCreationContext.renderer=this.layer.renderer,this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataSupplier=y.sharedSymbolResources.streamDataSupplier,this.symbolCreationContext.renderSpatialReference=y.renderSpatialReference,this.symbolCreationContext.renderCoordsHelper=y.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.layerView=this.layerView,this.symbolCreationContext.layerOrder=0,this.symbolCreationContext.localOriginFactory=e.createLocalOriginFactory(),this.symbolCreationContext.elevationProvider=y.elevationProvider,H(this.layer);var u=G.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=G.createContext(u,this.viewSR,W),y.deconflictor.addGraphicsOwner(this),this.symbolCreationContext.screenSizePerspectiveEnabled=y.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.tilingSchemeHandle=r.when(d,"tilingScheme",function(e){e.spatialReference.equals(c.symbolCreationContext.overlaySR)||(c.symbolCreationContext.overlaySR=d.spatialReference,c.recreateAllGraphics())}),this.eventHandles.push(this.layerView.watch("suspended",function(){return c.suspendedChange()})),this.eventHandles.push(this.layerView.watch("layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled",function(){c.symbolCreationContext.screenSizePerspectiveEnabled=y.screenSizePerspectiveEnabled&&c.layer.screenSizePerspectiveEnabled,c.recreateAllGraphics()})),this.eventHandles.push(r.on(t,"loadedGraphics","change",function(e){return c.graphicsCollectionChanged(e)},function(){c.clearSymbolsAndGraphics(),c.graphicsCollectionChanged({added:c.layerView.loadedGraphics.toArray(),removed:[]})})),this.validateRenderer(this.layer.renderer)},e.prototype.destroy=function(){var e=this;if(this.layerView.view.deconflictor.removeGraphicsOwner(this),this.clear(),this.stage){var t=[this.stageLayer.getId()];this.labelStageLayer&&t.push(this.labelStageLayer.getId()),this.stage.removeFromViewContent(t),t.forEach(function(t){return e.stage.remove(g.ModelContentType.LAYER,t)}),this.stageLayer=null,this.labelStageLayer=null,this.stage=null}this.tilingSchemeHandle&&(this.tilingSchemeHandle.remove(),this.tilingSchemeHandle=null),this.eventHandles.forEach(function(e){return e.remove()}),this.eventHandles=null,this.onComputedExtentChange=null,this.viewSR=null,this.scaleVisibility=null,this.labeling=null,this.layerView=null;for(var i in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[i].reject(new n("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null,this.sharedSymbolResourcesOwnerHandle&&(this.sharedSymbolResourcesOwnerHandle.remove(),this.sharedSymbolResourcesOwnerHandle=null)},e.prototype.clear=function(){var e=!1;for(var t in this.graphics){var i=this.graphics[t];e=e||i.isDraped(),i.destroy()}this.graphics={},this.graphicsKeys=null;for(var a in this.symbols){var r=this.symbols[a];r&&r.destroy()}this.symbols={},this.graphicsBySymbol={},this.graphicsWithoutSymbol={},this.hasDraped=!1,e&&this.layerView._notifyDrapedDataChange()},e.prototype.initializeStage=function(e,t){this.stage=e._stage,this.stageLayer=new b(t,{state:this.layerView.suspended?"HIDDEN":"VISIBLE"},t),this.stage.add(g.ModelContentType.LAYER,this.stageLayer);var i=[this.stageLayer.getId()];this.labeling&&(this.labelStageLayer=new b(t,{state:this.layerView.suspended?"HIDDEN":"IGNORED"},t+"_labels"),this.stage.add(g.ModelContentType.LAYER,this.labelStageLayer),i.push(this.labelStageLayer.getId())),this.stage.addToViewContent(i)},e.prototype.setDrawingOrder=function(e){this.symbolCreationContext.layerOrder=e;var t={},i={};for(var a in this.graphics){var r=this.graphics[a];r.setDrawOrder(e,t,i)}for(var s in i){var n=this.symbols[s];n&&n.setDrawOrder(e,t)}f.objectEmpty(t)||(this.stage.getTextureGraphicsRenderer().updateRenderOrder(t),this.layerView._notifyDrapedDataChange())},e.prototype.suspendedChange=function(){this.layerView.suspended===!0?(this.stageLayer.setState("HIDDEN"),this.labelStageLayer&&this.labelStageLayer.setState("HIDDEN"),this.hideAllGraphics()):this.layerView.suspended===!1&&(this.stageLayer.setState("VISIBLE"),this.labelStageLayer&&this.labelStageLayer.setState("IGNORED"),this.updateAllGraphicsVisibility())},e.prototype.getGraphics3DGraphics=function(){return this.graphics},e.prototype.getGraphics3DGraphicById=function(e){return this.graphics[e]},e.prototype.getGraphics3DGraphicsKeys=function(){return null===this.graphicsKeys&&(this.graphicsKeys=Object.keys(this.graphics)),this.graphicsKeys},e.prototype.labelsEnabled=function(){return!(!this.labeling||!this.labeling.layerLabelsEnabled())},e.prototype.getSymbolUpdateType=function(){var e=0,t=0,i=0;for(var a in this.symbols){var r=this.symbols[a];if(r){var s=r.getFastUpdateStatus();e+=s.loading,i+=s.fast,t+=s.slow}}return e>0?"unknown":i>=0&&0===t?"fast":t>=0&&0===i?"slow":"mixed"},e.prototype.numNodesUpdating=function(){return this.updatingGraphicIds.size},e.prototype.needsIdleUpdate=function(){return!!this.lastFastUpdate&&performance.now()-this.lastFastUpdate>_},e.prototype.idleUpdate=function(e){e.done()||(this.lastFastUpdate&&(this.labeling&&this.labeling.updateLabelingInfo(),this.lastFastUpdate=null),this.layerView._evaluateUpdatingState())},e.prototype.whenGraphics3DGraphic=function(e){var t=this.graphics[e.uid];if(t)return l.resolve(t);var i=this.whenGraphics3DGraphicRequests[e.uid];return i||(i=new O,this.whenGraphics3DGraphicRequests[e.uid]=i),i.promise},e.prototype.boundsForGraphics3DGraphic=function(e){return a(this,void 0,void 0,function(){var t,a,r,s,n,o,l,p,d;return i(this,function(i){switch(i.label){case 0:return t=this.layerView.view.spatialReference,a=this.layerView.view.renderSpatialReference,r=this.layerView.view.basemapTerrain.spatialReference,s=function(e,i,r){return h.bufferToBuffer(e,a,i,e,t,i,r)},n=function(e,i,a){return h.bufferToBuffer(e,r,i,e,t,i,a)},[4,e.getProjectedBoundingBox(s,n,this.elevationQueryService)];case 1:return(o=i.sent())?(l=o.boundingBox,o.requiresDrapedElevation&&(p=this.symbolCreationContext.elevationProvider,p&&(F.center(l,P),j.x=P[0],j.y=P[1],j.z=void 0,j.spatialReference=t,d=p.getElevation(j)||0,l[2]=Math.min(l[2],d),l[5]=Math.max(l[5],d))),[2,{boundingBox:l,screenSpaceObjects:o.screenSpaceObjects}]):[2,null]}})})},e.prototype.whenGraphicBounds=function(e){var t=this;return r.whenOnce(this.layerView,"loadedGraphics").then(function(){var i=t.layerView.layer&&t.layerView.layer.objectIdField,a=t.layerView.loadedGraphics.find(function(t){return t===e?!0:i&&t.attributes&&e.attributes&&t.attributes[i]===e.attributes[i]?!0:!1});if(a)return t.whenGraphics3DGraphic(a);throw new n("internal:graphic-not-part-of-view","Graphic is not part of this view")}).then(function(e){return t.boundsForGraphics3DGraphic(e)})},e.prototype.graphicsCollectionChanged=function(e){var t=this.graphicTransformFunc?this.graphicTransformFunc(e.added):e.added;this.add(t),this.remove(e.removed)},e.prototype.graphicUpdateHandler=function(e){var t=this.graphics[e.graphic.uid];if(t)switch(e.property){case"visible":var i=t.setVisibilityFlag(0,e.newValue);i&&(t.isDraped()&&this.layerView._notifyDrapedDataChange(),this.labeling&&this.layerView.view.deconflictor.setDirty())}},e.prototype.beginGraphicUpdate=function(e){this.updatingGraphicIds.add(e.uid),"symbolsUpdating"in this.layerView&&!this.layerView.get("symbolsUpdating")&&this.layerView.set("symbolsUpdating",!0),this.layerView._evaluateUpdatingState()},e.prototype.endGraphicUpdate=function(e){e&&this.updatingGraphicIds["delete"](e.uid),"symbolsUpdating"in this.layerView&&this.layerView.get("symbolsUpdating")&&0===this.updatingGraphicIds.size&&(this.layerView.view.flushDisplayModifications(),this.layerView.set("symbolsUpdating",!1)),this.layerView._evaluateUpdatingState()},e.prototype.expandComputedExtent=function(t){var i,a,r,s,n,o;if(z(t))i=a=t.x,r=s=t.y,t.z&&(n=o=t.z);else if(T(t)){var l=t.extent;if(!l)return;i=l.xmin,a=l.xmax,r=l.ymin,s=l.ymax,n=l.zmin,o=l.zmax}var p=this.viewSR,d=e.tmpVec;if(!t.spatialReference.equals(p))if(h.xyzToVector(i,r,0,t.spatialReference,d,p))i=d[0],r=d[1],h.xyzToVector(a,s,0,t.spatialReference,d,p),a=d[0],s=d[1];else if(q)throw new Error("Geometry has incompatible spatial reference");if(B.isFinite(i)&&B.isFinite(a)&&B.isFinite(r)&&B.isFinite(s)){var c=this.computedExtent;c?(i<c.xmin&&(c.xmin=i),a>c.xmax&&(c.xmax=a),r<c.ymin&&(c.ymin=r),s>c.ymax&&(c.ymax=s)):(c=new u(i,r,a,s,t.spatialReference),this.computedExtent=c),B.isFinite(n)&&!B.isFinite(o)&&((null==c.zmin||n<c.zmin)&&(c.zmin=n),(null==c.zmax||o>c.zmax)&&(c.zmax=o)),this.onComputedExtentChange&&this.onComputedExtentChange()}},e.prototype.updateHasDraped=function(){this.hasDraped=!1;for(var e in this.graphicsDrapedIds)if(this.graphicsDrapedIds.hasOwnProperty(e)){this.hasDraped=!0;break}},e.prototype.elevationInfoChange=function(){H(this.layer);var e=G.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=G.createContext(e,this.viewSR,W),this.labeling&&this.labeling.elevationInfoChange(),this.layer.renderer!==this.symbolCreationContext.renderer&&this.rendererChange(this.layer.renderer);for(var t in this.graphicsBySymbol){var i=this.symbols[t],a=this.graphicsBySymbol[t];if(i&&i.layerPropertyChanged("elevationInfo",a)){for(var r in a){var s=a[r],n=s.graphic,o=s._labelGraphics;this.elevation&&this.elevation.markGraphicElevationDirty(n.uid);for(var l=0;l<o.length;l++){var h=o[l],p=h.graphics3DSymbolLayer;p.updateGraphicElevationContext(n,h)}}this.layerView._evaluateUpdatingState()}else k&&W.warn("Could not apply elevation change to symbol "+t),this._recreateSymbol(t)}},e.prototype.clearSymbolsAndGraphics=function(){this.clear(),this.elevation&&this.elevation.clear(),this.labeling&&this.labeling.clear()},e.prototype.recreateAllGraphics=function(){k&&W.warn("Recreating all graphics"),this.clearSymbolsAndGraphics(),this.computedExtent=null,this.onComputedExtentChange&&this.onComputedExtentChange(),this.layerView.loadedGraphics&&this.layerView.view.basemapTerrain.tilingScheme&&this.add(this.layerView.loadedGraphics.toArray())},e.prototype._recreateSymbol=function(e){k&&W.warn("Recreating symbol "+e);var t=this.graphicsBySymbol[e],i=[],a=!1;for(var r in t){var s=t[r],n=s.isDraped();n&&(delete this.graphicsDrapedIds[r],a=!0),i.push(s.graphic),s.destroy(),delete this.graphics[r]}this.graphicsBySymbol[e]={};var o=this.symbols[e];o&&o.destroy(),delete this.symbols[e],this.updateHasDraped(),a&&this.layerView._notifyDrapedDataChange(),this.add(i)},e.prototype.add=function(e){if(this.layerView.view.basemapTerrain&&this.layerView.view.basemapTerrain.tilingScheme){for(var t=e.length,i=new Array(t),a=new Array(t),r=new Array(t),s=!1,n=0;t>n;n++){var o=e[n],l=o.geometry;if(l){this.expandComputedExtent(l);var h=this.layerView.getRenderingInfo?this.layerView.getRenderingInfo(o):{symbol:o.symbol};if(this.graphicsWithoutSymbol[o.uid]=o,h&&h.symbol){a[n]=h.symbol,r[n]=h;var p=this.getOrCreateGraphics3DSymbol(a[n],h.renderer);p?(i[n]=p,this.beginGraphicUpdate(o)):k&&W.warn("Graphics3DGraphic for graphic "+o.uid+" not created - could not create Graphics3DSymbol for symbol "+a[n].id)}else s||(s=!0,W.warn("Graphic in layer "+this.layer.id+" has no symbol and will not render"))}}for(var n=0;t>n;n++)this.waitForSymbol(i[n],a[n],e[n],r[n])}},e.prototype.waitForSymbol=function(e,t,i,a){var r=this;e&&e.then(function(){r.createGraphics3DGraphic(e,i,a),r.endGraphicUpdate(i),r.labeling&&r.layerView.view.deconflictor.setDirty()},function(){k&&W.warn("Graphics3DGraphic for graphic "+i.uid+" not created - Graphics3DSymbol for symbol "+t.id+" rejected"),r.endGraphicUpdate(i)})},e.prototype.remove=function(e){for(var t=!1,i=e.length,a=0;i>a;a++){var r=e[a].uid,s=this.graphics[r];if(s){var n=s.isDraped();n&&(delete this.graphicsDrapedIds[r],t=!0);var o=s.graphics3DSymbol.symbol.id;s.destroy(),delete this.graphics[r],delete this.graphicsBySymbol[o][r],delete this.graphicsWithoutSymbol[r],this.graphicsKeys=null}}this.updateHasDraped(),t&&this.layerView._notifyDrapedDataChange(),this.layerView.view.deconflictor.setDirty()},e.prototype.hasLabelingContext=function(e){if(e instanceof S||e instanceof w){var t=this.symbolCreationContext.layer;return t.labelingInfo?t.labelingInfo.some(function(t){return t.symbol===e}):!1}return!1},e.prototype.hasValidSymbolCreationContext=function(e){return e instanceof S&&!this.hasLabelingContext(e)?(W.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1):!0},e.prototype.createGraphics3DSymbol=function(e,t){if(!this.hasValidSymbolCreationContext(e))return null;var i=C.to3D(e,!0,!1,this.hasLabelingContext(e));if(i.symbol){var a=void 0;if(t&&t.backgroundFillSymbol){var r=C.to3D(t.backgroundFillSymbol,!1,!0);r.symbol&&(a=r.symbol.symbolLayers)}return E.make(i.symbol,this.symbolCreationContext,a)}return k?W.warn("Graphics3DSymbol for symbol "+e.id+" not created - could not convert symbol"):i.error&&W.error(i.error.message),null},e.prototype.getOrCreateGraphics3DSymbol=function(e,t){var i=this,a=this.symbols[e.id];return void 0===a&&(a=e instanceof v?new I(e,function(e){return i.createGraphics3DSymbol(e,t)}):this.createGraphics3DSymbol(e,t),this.symbols[e.id]=a),a},e.prototype.createGraphics3DGraphic=function(e,t,i){if(delete this.graphicsWithoutSymbol[t.uid],!this.symbols[e.symbol.id])return void this.add([t]);if(!this.graphics[t.uid]){var a=e.createGraphics3DGraphic(t,i);this.graphics[t.uid]=a,this.graphicsKeys=null,this.graphicsBySymbol[e.symbol.id]||(this.graphicsBySymbol[e.symbol.id]={}),this.graphicsBySymbol[e.symbol.id][t.uid]=a,a.initialize(this.stageLayer,this.stage);var r=a.isDraped();r&&(this.graphicsDrapedIds[t.uid]=!0,this.hasDraped=!0,this.layerView._notifyDrapedDataChange()),a.centroid=null,"point"!==t.geometry.type&&a instanceof V&&(a.centroid=R.computeCentroid(t.geometry,this.viewSR));var s=this.scaleVisibility&&this.scaleVisibility.scaleRangeActive();this.spatialIndex&&this.spatialIndex.shouldAddToSpatialIndex(t,a,s)&&this.spatialIndex.addGraphicToSpatialIndex(t,a),this.labeling&&this.labeling.layerLabelsEnabled()&&this.labeling.createLabelsForGraphic(t,a),s&&this.scaleVisibility.updateGraphicScaleVisibility(t,a),a.setVisibilityFlag(0,t.visible&&!this.layerView.suspended);var n=this.whenGraphics3DGraphicRequests[t.uid];n&&(delete this.whenGraphics3DGraphicRequests[t.uid],n.resolve(a)),this.highlights&&this.highlights.graphicCreated(a)}},e.prototype.rendererChange=function(e){var t=this.symbolCreationContext.renderer;if(e!==t){this.validateRenderer(e);var i=c.diff(t,e);if(this.updateUnchangedSymbolMappings(i,e,t),this.symbolCreationContext.renderer=e,!i)return void(k&&W.warn("Renderer change: no diff, change ignored"));if("complete"===i.type)k&&W.warn("Renderer change: complete diff, recreating all graphics"),this.recreateAllGraphics();else if("partial"===i.type){if(!this.applyRendererDiff(i,e,t))return k&&W.warn("Renderer change: could not apply partial diff, recreating all graphics"),void this.recreateAllGraphics();k&&W.warn("Renderer change: applied partial diff (fast update)"),this.volatileGraphicsUpdated()}}},e.prototype.diffHasSymbolChange=function(e){for(var t in e.diff)switch(t){case"visualVariables":break;case"defaultSymbol":break;case"uniqueValueInfos":break;case"authoringInfo":case"fieldDelimiter":delete e.diff[t];break;default:return!0}return!1},e.prototype.applySymbolSetDiff=function(e,t,i,a){var r=!1;e=e||[],t=t||[];for(var s=[],n=0;n<t.length;n++){var o=t[n],l=this.graphicsBySymbol[o.id];for(var h in l){var p=l[h],d=p.graphic;(o!==i.defaultSymbol||i.getSymbol(d)!==i.defaultSymbol)&&(p.isDraped()&&(delete this.graphicsDrapedIds[h],r=!0),e.length||i.defaultSymbol?s.push(d):this.graphicsWithoutSymbol[h]=d,p.destroy(),this.highlights&&this.highlights.graphicDeleted(this.graphics[h]),delete l[h],delete this.graphics[h],this.graphicsKeys=null)}if(void 0===l||0===Object.keys(l).length){delete this.graphicsBySymbol[o.id];var c=this.symbols[o.id];c&&c.destroy(),delete this.symbols[o.id]}}if(e.length||s.length){for(var h in this.graphicsWithoutSymbol)s.push(this.graphicsWithoutSymbol[h]);this.graphicsWithoutSymbol={},this.add(s)}this.updateHasDraped(),r&&this.layerView._notifyDrapedDataChange(),this.layerView.view.deconflictor.setDirty()},e.prototype.applyUniqueValueRendererDiff=function(e,t,i){var a=e.diff.defaultSymbol,r=e.diff.uniqueValueInfos;if(a||r){var s=r?r.added.map(function(e){return e.symbol}):[],n=r?r.removed.map(function(e){return e.symbol}):[];if(r)for(var o=0;o<r.changed.length;o++)s.push(r.changed[o].newValue.symbol),n.push(r.changed[o].oldValue.symbol);return a?(i.defaultSymbol&&n.push(i.defaultSymbol),t.defaultSymbol&&s.push(t.defaultSymbol)):i.defaultSymbol&&s.length&&n.push(t.defaultSymbol),this.applySymbolSetDiff(s,n,t,i),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1},e.prototype.calculateUnchangedSymbolMapping=function(e,t,i){if(t instanceof p&&i instanceof p)if(e){if("partial"===e.type){var a=e.diff,r=a.defaultSymbol,s=a.uniqueValueInfos,n=void 0;return n=s?s.unchanged.map(function(e){return{oldId:e.oldValue.symbol.id,newId:e.newValue.symbol.id}}):i.uniqueValueInfos.map(function(e,i){return{oldId:e.symbol.id,newId:t.uniqueValueInfos[i].symbol.id}}),!r&&i.defaultSymbol&&n.push({oldId:i.defaultSymbol.id,newId:t.defaultSymbol.id}),n}}else if(i&&i.defaultSymbol)return[{oldId:i.defaultSymbol.id,newId:t.defaultSymbol.id}];return[]},e.prototype.updateUnchangedSymbolMappings=function(e,t,i){for(var a=this.calculateUnchangedSymbolMapping(e,t,i),r=0,s=a;r<s.length;r++){var n=s[r],o=n.oldId,l=n.newId;if(o&&o!==l){var h=this.graphicsBySymbol[o];delete this.graphicsBySymbol[o],void 0!==h&&(this.graphicsBySymbol[l]=h);var p=this.symbols[o];delete this.symbols[o],void 0!==p&&(this.symbols[l]=p,p.symbol.id=l)}}},e.prototype.applyRendererDiff=function(e,t,i){var a=!1;if(this.diffHasSymbolChange(e))return k&&W.warn("Could not apply renderer diff - diff could lead to graphics changing symbols"),!1;if(t instanceof p&&i instanceof p&&this.applyUniqueValueRendererDiff(e,t,i)&&0===Object.keys(e.diff).length)return!0;for(var r in this.graphicsBySymbol){var s=this.symbols[r];if(s){var n=this.graphicsBySymbol[r];if(!s.applyRendererDiff(e,t,n))return!1;if(!a)for(var o in n)if(n[o].isDraped()){this.layerView._notifyDrapedDataChange(),a=!0;break}}}return!0},e.prototype.opacityChange=function(){var e=!1;for(var t in this.graphicsBySymbol){var i=this.symbols[t];if(i){var a=this.graphicsBySymbol[t];if(i.layerPropertyChanged("opacity"),!e)for(var r in a)if(a[r].isDraped()){this.layerView._notifyDrapedDataChange(),e=!0;break}}}},e.prototype.setClippingExtent=function(e,t){var i=this.symbolCreationContext.clippingExtent,a=[];return h.extentToBoundingRect(e,a,t)?this.symbolCreationContext.clippingExtent=[a[0],a[1],-(1/0),a[2],a[3],1/0]:this.symbolCreationContext.clippingExtent=null,!s.equals(this.symbolCreationContext.clippingExtent,i)},e.prototype.forEachGraphics3DGraphic=function(e){var t=this;if(this.layerView.loadedGraphics){var i=!1,a=!1;this.layerView.loadedGraphics.forEach(function(r){var s=t.getGraphics3DGraphicById(r.uid);if(s){var n=e(s,r);n&&(i=!0,a=a||s.isDraped())}}),i&&this.layerView.view.deconflictor.setDirty(),a&&this.layerView._notifyDrapedDataChange()}},e.prototype.updateAllGraphicsVisibility=function(){var e=this;this.forEachGraphics3DGraphic(function(t,i){var a=t.setVisibilityFlag(0,i.visible),r=!1;return e.scaleVisibility&&(r=e.scaleVisibility.updateGraphicScaleVisibility(i,t)),a||r})},e.prototype.hideAllGraphics=function(){this.forEachGraphics3DGraphic(function(e){return e.setVisibilityFlag(0,!1)})},e.prototype.validateRenderer=function(e){var t=d.validateTo3D(e);if(t){var i="Renderer for layer '"+(this.layer.title?this.layer.title+", ":"")+", id:"+this.layer.id+"' is not supported in a SceneView";W.warn(i,t.message)}},e.prototype.volatileGraphicsUpdated=function(){this.labeling&&(this.lastFastUpdate=performance.now()),this.stageLayer.invalidateSpatialQueryAccelerator(),this.stageLayer.shaderTransformationChanged(),this.layerView._evaluateUpdatingState()},e.createLocalOriginFactory=function(){return new m(5e6,16)},e.prototype.snapshotInternals=function(){var e=this;return{graphics:Object.keys(this.graphics).sort(),symbols:Object.keys(this.symbols).sort(),graphicsBySymbol:Object.keys(this.graphicsBySymbol).sort().map(function(t){return{symbolId:t,graphics:Object.keys(e.graphicsBySymbol[t]).sort()}}),graphicsWithoutSymbol:Object.keys(this.graphicsWithoutSymbol).sort(),graphicsDrapedIds:Object.keys(this.graphicsDrapedIds).sort()}},e.tmpVec=x.vec3d.create(),e}();return M});