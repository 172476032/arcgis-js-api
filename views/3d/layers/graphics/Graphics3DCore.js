// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","../../../../core/watchUtils","../../../../core/arrayUtils","../../../../core/Error","../../../../core/Logger","../../../../core/promiseUtils","../../support/projectionUtils","../../../../renderers/UniqueValueRenderer","../../../../renderers/support/rendererConversion","../../../../renderers/support/diffUtils","../../../../geometry/Point","../../../../geometry/Extent","../../webgl-engine/Stage","../../webgl-engine/lib/Util","../../webgl-engine/lib/Layer","../../webgl-engine/lib/FloatingBoxLocalOriginFactory","../../../../symbols/WebStyleSymbol","../../../../symbols/support/symbolConversion","../../lib/glMatrix","./Graphics3DGraphic","./Graphics3DSymbol","./Graphics3DWebStyleSymbol","./graphicUtils","./Graphics3DOwner","./ElevationQuery","../../support/aaBoundingBox","../../support/mathUtils","dojo/Deferred"],function(e,i,t,a,r,s,n,l,o,h,p,d,c,y,u,g,f,m,b,v,w,S,D,C,G,V,x,R,I,E,L){function U(e){return"point"===e.type}function F(e){return"polygon"===e.type||"polyline"===e.type||"multipoint"===e.type}var B=S.vec3d,H=!1,A=!1,T=500,q="VISIBILITY_GRAPHIC",z=new y,M=B.create(),O=l.getLogger("esri.views.3d.LayerView3D"),_=function(){function e(){this.graphics={},this.graphicsDrapedIds={},this.graphicsBySymbol={},this.graphicsKeys=[],this.symbols={},this.graphicsWithoutSymbol={},this.computedExtent=null,this.symbolCreationContext=new x.Graphics3DSymbolCreationContext,this.hasDraped=!1,this.updatingGraphicIds=new Set,this.lastFastUpdate=null,this.tilingSchemeHandle=null,this.stageLayer=null,this.labelStageLayer=null,this.stage=null,this.onComputedExtentChange=null,this.graphicTransformFunc=null,this.eventHandles=[],this.viewSR=null,this.layerView=null,this.layer=null,this.elevation=null,this.scaleVisibility=null,this.spatialIndex=null,this.labeling=null,this.elevationQueryService=null,this.whenGraphics3DGraphicRequests={}}return e.prototype.initialize=function(i,t,a,s,n,l,o,h,p){var d=this;this.layerView=i,this.layer=t,this.viewSR=i.view.spatialReference,this.elevation=a,this.scaleVisibility=s,this.spatialIndex=n,this.labeling=l,this.onComputedExtentChange=o,this.graphicTransformFunc=h,this.elevationQueryService=new R.ElevationQuery(this.viewSR,function(){return d.layerView.view.map.ground},{maximumAutoTileRequests:4}),this.initializeStage(this.layerView.view,this.layer.id),this.symbolCreationContext.sharedResources=this.layerView.view.sharedSymbolResources,this.symbolCreationContext.renderer=this.layer.renderer,this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataSupplier=this.layerView.view.sharedSymbolResources.streamDataSupplier,this.symbolCreationContext.renderSpatialReference=this.layerView.view.renderSpatialReference,this.symbolCreationContext.renderCoordsHelper=this.layerView.view.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.layerView=this.layerView,this.symbolCreationContext.layerOrder=0,this.symbolCreationContext.localOriginFactory=e.createLocalOriginFactory(),this.symbolCreationContext.elevationProvider=p,this.tilingSchemeHandle=r.when(p,"tilingScheme",function(e){e.spatialReference.equals(d.symbolCreationContext.overlaySR)||(d.symbolCreationContext.overlaySR=p.spatialReference,d.recreateAllGraphics())}),this.eventHandles.push(this.layerView.watch("suspended",function(){return d.suspendedChange()})),this.eventHandles.push(r.on(i,"loadedGraphics","change",function(e){return d.graphicsCollectionChanged(e)},function(){d.clearSymbolsAndGraphics(),d.graphicsCollectionChanged({added:d.layerView.loadedGraphics.toArray(),removed:[]})})),this.validateRenderer(this.layer.renderer)},e.prototype.destroy=function(){var e=this;if(this.clear(),this.stage){var i=[this.stageLayer.getId()];this.labelStageLayer&&i.push(this.labelStageLayer.getId()),this.stage.removeFromViewContent(i),i.forEach(function(i){return e.stage.remove(g.ModelContentType.LAYER,i)}),this.stageLayer=null,this.labelStageLayer=null,this.stage=null}this.tilingSchemeHandle&&(this.tilingSchemeHandle.remove(),this.tilingSchemeHandle=null),this.eventHandles.forEach(function(e){return e.remove()}),this.eventHandles=null,this.onComputedExtentChange=null,this.viewSR=null,this.scaleVisibility=null,this.labeling=null,this.layerView=null;for(var t in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[t].reject(new n("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null},e.prototype.clear=function(){var e=!1;for(var i in this.graphics){var t=this.graphics[i];e=e||t.isDraped(),t.destroy()}this.graphics={},this.graphicsKeys=null;for(var a in this.symbols){var r=this.symbols[a];r&&r.destroy()}this.symbols={},this.graphicsBySymbol={},this.graphicsWithoutSymbol={},this.hasDraped=!1,e&&this.layerView._notifyDrapedDataChange()},e.prototype.initializeStage=function(e,i){this.stage=e._stage,this.stageLayer=new m(i,{state:this.layerView.suspended?"HIDDEN":"VISIBLE"},i),this.stage.add(g.ModelContentType.LAYER,this.stageLayer);var t=[this.stageLayer.getId()];this.labeling&&(this.labelStageLayer=new m(i,{state:this.layerView.suspended?"HIDDEN":"IGNORED"},i+"_labels"),this.stage.add(g.ModelContentType.LAYER,this.labelStageLayer),t.push(this.labelStageLayer.getId())),this.stage.addToViewContent(t)},e.prototype.setDrawingOrder=function(e){this.symbolCreationContext.layerOrder=e;var i={},t={};for(var a in this.graphics){var r=this.graphics[a];r.setDrawOrder(e,i,t)}for(var s in t){var n=this.symbols[s];n&&n.setDrawOrder(e,i)}f.objectEmpty(i)||(this.stage.getTextureGraphicsRenderer().updateRenderOrder(i),this.layerView._notifyDrapedDataChange())},e.prototype.suspendedChange=function(){this.layerView.suspended===!0?(this.stageLayer.setState("HIDDEN"),this.labelStageLayer&&this.labelStageLayer.setState("HIDDEN"),this.hideAllGraphics()):this.layerView.suspended===!1&&(this.stageLayer.setState("VISIBLE"),this.labelStageLayer&&this.labelStageLayer.setState("IGNORED"),this.updateAllGraphicsVisibility())},e.prototype.getGraphics3DGraphics=function(){return this.graphics},e.prototype.getGraphics3DGraphicById=function(e){return this.graphics[e]},e.prototype.getGraphics3DGraphicsKeys=function(){return null===this.graphicsKeys&&(this.graphicsKeys=Object.keys(this.graphics)),this.graphicsKeys},e.prototype.getSymbolUpdateType=function(){var e=0,i=0,t=0;for(var a in this.symbols){var r=this.symbols[a];if(r){var s=r.getFastUpdateStatus();e+=s.loading,t+=s.fast,i+=s.slow}}return e>0?"unknown":t>=0&&0===i?"fast":i>=0&&0===t?"slow":"mixed"},e.prototype.numNodesUpdating=function(){return this.updatingGraphicIds.size},e.prototype.needsIdleUpdate=function(){return!!this.lastFastUpdate&&performance.now()-this.lastFastUpdate>T},e.prototype.idleUpdate=function(e){e.done()||(this.lastFastUpdate&&(this.labeling&&this.labeling.updateLabelingInfo(),this.lastFastUpdate=null),this.layerView._evaluateUpdatingState())},e.prototype.whenGraphics3DGraphic=function(e){var i=this.graphics[e.uid];if(i)return o.resolve(i);var t=this.whenGraphics3DGraphicRequests[e.uid];return t||(t=new L,this.whenGraphics3DGraphicRequests[e.uid]=t),t.promise},e.prototype.boundsForGraphics3DGraphic=function(e){return a(this,void 0,void 0,function(){var i,a,r,s,n,l,o,p,d;return t(this,function(t){switch(t.label){case 0:return i=this.layerView.view.spatialReference,a=this.layerView.view.renderSpatialReference,r=this.layerView.view.basemapTerrain.spatialReference,s=function(e,t,r){return h.bufferToBuffer(e,a,t,e,i,t,r)},n=function(e,t,a){return h.bufferToBuffer(e,r,t,e,i,t,a)},[4,e.getProjectedBoundingBox(s,n,this.elevationQueryService)];case 1:return(l=t.sent())?(o=l.boundingBox,l.requiresDrapedElevation&&(p=this.symbolCreationContext.elevationProvider,p&&(I.center(o,M),z.x=M[0],z.y=M[1],z.z=void 0,z.spatialReference=i,d=p.getElevation(z)||0,o[2]=Math.min(o[2],d),o[5]=Math.max(o[5],d))),[2,o]):[2,null]}})})},e.prototype.whenGraphicBounds=function(e){var i=this;return r.whenOnce(this.layerView,"loadedGraphics").then(function(){if(i.layerView.loadedGraphics.some(function(i){return i===e}))return i.whenGraphics3DGraphic(e);throw new n("internal:graphic-not-part-of-view","Graphic is not part of this view")}).then(function(e){return i.boundsForGraphics3DGraphic(e)})},e.prototype.graphicsCollectionChanged=function(e){var i=this.graphicTransformFunc?this.graphicTransformFunc(e.added):e.added;this.add(i),this.remove(e.removed)},e.prototype.graphicUpdateHandler=function(e){var i=this.graphics[e.graphic.uid];if(i)switch(e.property){case"visible":var t=i.setVisibilityFlag(q,e.newValue);t&&(i.isDraped()&&this.layerView._notifyDrapedDataChange(),this.labeling&&this.layerView.view.labelManager.setDirty())}},e.prototype.beginGraphicUpdate=function(e){this.updatingGraphicIds.add(e.uid),this.layerView.get("symbolsUpdating")||this.layerView.set("symbolsUpdating",!0),this.layerView._evaluateUpdatingState()},e.prototype.endGraphicUpdate=function(e){e&&this.updatingGraphicIds["delete"](e.uid),this.layerView.get("symbolsUpdating")&&0===this.updatingGraphicIds.size&&(this.layerView.view.flushDisplayModifications(),this.layerView.set("symbolsUpdating",!1)),this.layerView._evaluateUpdatingState()},e.prototype.expandComputedExtent=function(i){var t,a,r,s,n,l;if(U(i))t=a=i.x,r=s=i.y,i.z&&(n=l=i.z);else if(F(i)){var o=i.extent;if(!o)return;t=o.xmin,a=o.xmax,r=o.ymin,s=o.ymax,n=o.zmin,l=o.zmax}var p=this.viewSR,d=e.tmpVec;if(!i.spatialReference.equals(p))if(h.xyzToVector(t,r,0,i.spatialReference,d,p))t=d[0],r=d[1],h.xyzToVector(a,s,0,i.spatialReference,d,p),a=d[0],s=d[1];else if(H)throw new Error("Geometry has incompatible spatial reference");if(E.isFinite(t)&&E.isFinite(a)&&E.isFinite(r)&&E.isFinite(s)){var c=this.computedExtent;c?(c.xmin=Math.min(t,c.xmin),c.xmax=Math.max(a,c.xmax),c.ymin=Math.min(r,c.ymin),c.ymax=Math.max(s,c.ymax)):(c=new u(t,r,a,s,i.spatialReference),this.computedExtent=c),E.isFinite(n)&&!E.isFinite(l)&&(c.zmin=null!=c.zmin?Math.min(n,c.zmin):n,c.zmax=null!=c.zmax?Math.max(l,c.zmax):l),this.onComputedExtentChange&&this.onComputedExtentChange()}},e.prototype.updateHasDraped=function(){this.hasDraped=!1;for(var e in this.graphicsDrapedIds)if(this.graphicsDrapedIds.hasOwnProperty(e)){this.hasDraped=!0;break}},e.prototype.elevationInfoChange=function(){this.labeling&&this.labeling.elevationInfoChange();for(var e in this.graphicsBySymbol){var i=this.symbols[e],t=this.graphicsBySymbol[e];if(i&&i.layerPropertyChanged("elevationInfo",t))for(var a in t)for(var r=t[a],s=r.graphic,n=r._labelGraphics,l=0;l<n.length;l++){var o=n[l],h=o.graphics3DSymbolLayer;h.updateGraphicElevationInfo(s,o)}else A&&O.warn("Could not apply elevation change to symbol "+e),this.recreateSymbol(e)}},e.prototype.clearSymbolsAndGraphics=function(){this.clear(),this.elevation&&this.elevation.clear(),this.labeling&&this.labeling.clear()},e.prototype.recreateAllGraphics=function(){A&&O.warn("Recreating all graphics"),this.clearSymbolsAndGraphics(),this.computedExtent=null,this.onComputedExtentChange&&this.onComputedExtentChange(),this.layerView.loadedGraphics&&this.layerView.view.basemapTerrain.tilingScheme&&this.add(this.layerView.loadedGraphics.toArray())},e.prototype.recreateSymbol=function(e){A&&O.warn("Recreating symbol "+e);var i=this.graphicsBySymbol[e],t=[],a=!1;for(var r in i){var s=i[r],n=s.isDraped();n&&(delete this.graphicsDrapedIds[r],a=!0),t.push(s.graphic),s.destroy(),delete this.graphics[r]}this.graphicsBySymbol[e]={};var l=this.symbols[e];l&&l.destroy(),delete this.symbols[e],this.updateHasDraped(),a&&this.layerView._notifyDrapedDataChange(),this.add(t)},e.prototype.add=function(e){if(this.layerView.view.basemapTerrain&&this.layerView.view.basemapTerrain.tilingScheme){for(var i=e.length,t=new Array(i),a=new Array(i),r=new Array(i),s=0;i>s;s++){var n=e[s],l=n.geometry;if(l){this.expandComputedExtent(l);var o=this.layerView.getRenderingInfo?this.layerView.getRenderingInfo(n):{symbol:n.symbol};if(o&&o.symbol){a[s]=o.symbol,r[s]=o;var h=this.getOrCreateGraphics3DSymbol(a[s],o.renderer);h?(t[s]=h,this.beginGraphicUpdate(n)):(A&&O.warn("Graphics3DGraphic for graphic "+n.uid+" not created - could not create Graphics3DSymbol for symbol "+a[s].id),this.graphicsWithoutSymbol[n.uid]=n)}else A&&O.warn("Graphics3DGraphic for graphic "+n.uid+" not created - graphic has no symbol"),this.graphicsWithoutSymbol[n.uid]=n}}for(var s=0;i>s;s++)this.waitForSymbol(t[s],a[s],e[s],r[s])}},e.prototype.waitForSymbol=function(e,i,t,a){var r=this;e&&e.then(function(){r.graphicsBySymbol[i.id]||(r.graphicsBySymbol[i.id]={}),r.createGraphics3DGraphic(e,t,a),r.endGraphicUpdate(t),r.labeling&&r.layerView.view.labelManager.setDirty()},function(){A&&O.warn("Graphics3DGraphic for graphic "+t.uid+" not created - Graphics3DSymbol for symbol "+i.id+" rejected"),r.endGraphicUpdate(t)})},e.prototype.remove=function(e){for(var i=!1,t=e.length,a=0;t>a;a++){var r=e[a].uid,s=this.graphics[r];if(s){var n=s.isDraped();n&&(delete this.graphicsDrapedIds[r],i=!0);var l=s.graphics3DSymbol.symbol.id;s.destroy(),delete this.graphics[r],delete this.graphicsBySymbol[l][r],delete this.graphicsWithoutSymbol[r],this.graphicsKeys=null}}this.updateHasDraped(),i&&this.layerView._notifyDrapedDataChange(),this.labeling&&this.layerView.view.labelManager.setDirty()},e.prototype.createGraphics3DSymbol=function(e,i){var t=w.to3D(e,!0,!1);if(t.symbol){var a=void 0;if(i&&i.backgroundFillSymbol){var r=w.to3D(i.backgroundFillSymbol,!1,!0);r.symbol&&(a=r.symbol.symbolLayers)}return new C(t.symbol,this.symbolCreationContext,a)}return A&&O.warn("Graphics3DSymbol for symbol "+e.id+" not created - could not convert symbol"),null},e.prototype.getOrCreateGraphics3DSymbol=function(e,i){var t=this,a=this.symbols[e.id];return void 0===a&&(a=e instanceof v?new G(e,function(e){return t.createGraphics3DSymbol(e,i)}):this.createGraphics3DSymbol(e,i),this.symbols[e.id]=a),a},e.prototype.createGraphics3DGraphic=function(e,i,t){if(!this.graphics[i.uid]){var a=e.createGraphics3DGraphic(i,t);this.graphics[i.uid]=a,this.graphicsKeys=null,this.graphicsBySymbol[e.symbol.id][i.uid]=a,a.initialize(this.stageLayer,this.stage);var r=a.isDraped();r&&(this.graphicsDrapedIds[i.uid]=!0,this.hasDraped=!0,this.layerView._notifyDrapedDataChange()),a.centroid=null,"point"!==i.geometry.type&&a instanceof D&&(a.centroid=V.computeCentroid(i.geometry,this.viewSR));var s=this.scaleVisibility&&this.scaleVisibility.scaleRangeActive();this.spatialIndex&&this.spatialIndex.shouldAddToSpatialIndex(i,a,s)&&this.spatialIndex.addGraphicToSpatialIndex(i,a),this.labeling&&this.labeling.layerLabelsEnabled()&&this.labeling.createLabelsForGraphic(i,a),s&&this.scaleVisibility.updateGraphicScaleVisibility(i,a),a.setVisibilityFlag(q,i.visible&&!this.layerView.suspended);var n=this.whenGraphics3DGraphicRequests[i.uid];n&&(delete this.whenGraphics3DGraphicRequests[i.uid],n.resolve(a))}},e.prototype.rendererChange=function(e){var i=this.symbolCreationContext.renderer;this.validateRenderer(e),this.symbolCreationContext.renderer=e;var t=c.diff(i,e);if(!t)return void(A&&O.warn("Renderer change: no diff, change ignored"));if("complete"===t.type)A&&O.warn("Renderer change: complete diff, recreating all graphics"),this.recreateAllGraphics();else if("partial"===t.type){if(!this.applyRendererDiff(t,e,i))return A&&O.warn("Renderer change: could not apply partial diff, recreating all graphics"),void this.recreateAllGraphics();A&&O.warn("Renderer change: applied partial diff (fast update)"),this.volatileGraphicsUpdated()}},e.prototype.diffHasSymbolChange=function(e){for(var i in e.diff)switch(i){case"visualVariables":break;case"defaultSymbol":break;case"uniqueValueInfos":break;default:return!0}return!1},e.prototype.applySymbolSetDiff=function(e,i,t,a){var r=!1;e=e||[],i=i||[];for(var s=[],n=0;n<i.length;n++){var l=i[n],o=this.graphicsBySymbol[l.id];for(var h in o){var p=o[h],d=p.graphic;(l!==a.defaultSymbol||t.getSymbol(d)!==a.defaultSymbol)&&(p.isDraped&&(delete this.graphicsDrapedIds[h],r=!0),e.length||t.defaultSymbol?s.push(d):this.graphicsWithoutSymbol[h]=d,p.destroy(),delete o[h],delete this.graphics[h],this.graphicsKeys=null)}l.destroy(),delete this.graphicsBySymbol[l.id],delete this.symbols[l.id]}if(e.length||s.length){for(var h in this.graphicsWithoutSymbol)s.push(this.graphicsWithoutSymbol[h]);this.graphicsWithoutSymbol={},this.add(s)}this.updateHasDraped(),r&&this.layerView._notifyDrapedDataChange(),this.labeling&&this.layerView.view.labelManager.setDirty()},e.prototype.applyUniqueValueRendererDiff=function(e,i,t){var a=e.diff.defaultSymbol,r=e.diff.uniqueValueInfos;if(a||r){var s=r?r.added.map(function(e){return e.symbol}):[],n=r?r.removed.map(function(e){return e.symbol}):[];if(r)for(var l=0;l<r.changed.length;l++)s.push(r.changed[l].newValue.symbol),n.push(r.changed[l].oldValue.symbol);return a?(t.defaultSymbol&&n.push(t.defaultSymbol),i.defaultSymbol&&s.push(i.defaultSymbol)):t.defaultSymbol&&s.length&&n.push(t.defaultSymbol),this.applySymbolSetDiff(s,n,i,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1},e.prototype.applyRendererDiff=function(e,i,t){var a=!1;if(this.diffHasSymbolChange(e))return A&&O.warn("Could not apply renderer diff - diff could lead to graphics changing symbols"),!1;if(i instanceof p&&t instanceof p&&this.applyUniqueValueRendererDiff(e,i,t)&&0===Object.keys(e.diff).length)return!0;for(var r in this.graphicsBySymbol){var s=this.symbols[r];if(s){var n=this.graphicsBySymbol[r];if(!s.applyRendererDiff(e,i,n))return!1;if(!a)for(var l in n)if(n[l].isDraped()){this.layerView._notifyDrapedDataChange(),a=!0;break}}}return!0},e.prototype.opacityChange=function(){var e=!1;for(var i in this.graphicsBySymbol){var t=this.symbols[i];if(t){var a=this.graphicsBySymbol[i];if(t.layerPropertyChanged("opacity"),!e)for(var r in a)if(a[r].isDraped()){this.layerView._notifyDrapedDataChange(),e=!0;break}}}},e.prototype.setClippingExtent=function(e,i){var t=this.symbolCreationContext.clippingExtent,a=[];return h.extentToBoundingRect(e,a,i)?this.symbolCreationContext.clippingExtent=[a[0],a[1],-(1/0),a[2],a[3],1/0]:this.symbolCreationContext.clippingExtent=null,!s.equals(this.symbolCreationContext.clippingExtent,t)},e.prototype.updateAllGraphicsVisibility=function(){var e=this;if(this.layerView.loadedGraphics){var i=!1;this.layerView.loadedGraphics.forEach(function(t){var a=e.getGraphics3DGraphicById(t.uid);if(a){var r=a.setVisibilityFlag(q,t.visible);if(e.scaleVisibility){var s=e.scaleVisibility.updateGraphicScaleVisibility(t,a);r=r||s}r&&a.isDraped()&&(i=!0)}}),i&&this.layerView._notifyDrapedDataChange(),this.layerView.view.labelManager.setDirty()}},e.prototype.hideAllGraphics=function(){var e=this;if(this.layerView.loadedGraphics){var i=!1;this.layerView.loadedGraphics.forEach(function(t){var a=e.getGraphics3DGraphicById(t.uid);if(a){var r=a.setVisibilityFlag(q,!1);r&&a.isDraped()&&(i=!0)}}),i&&this.layerView._notifyDrapedDataChange(),this.layerView.view.labelManager.setDirty()}},e.prototype.validateRenderer=function(e){var i=d.validateTo3D(e);if(i){var t="Renderer for layer '"+(this.layer.title?this.layer.title+", ":"")+", id:"+this.layer.id+"' is not supported in a SceneView";O.warn(t,i.message)}},e.prototype.volatileGraphicsUpdated=function(){this.labeling&&(this.lastFastUpdate=performance.now()),this.stageLayer.invalidateSpatialQueryAccelerator(),this.layerView._evaluateUpdatingState()},e.createLocalOriginFactory=function(){return new b(5e6,16)},e}();return _.tmpVec=S.vec3d.create(),_});