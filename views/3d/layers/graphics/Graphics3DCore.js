// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/generatorHelper","../../../../core/tsSupport/awaiterHelper","dojo/Deferred","../../../../core/arrayUtils","../../../../core/Error","../../../../core/Logger","../../../../core/promiseUtils","../../../../core/watchUtils","../../../../geometry/Extent","../../../../geometry/Point","../../../../renderers/UniqueValueRenderer","../../../../renderers/support/diffUtils","../../../../renderers/support/rendererConversion","../../../../symbols/LabelSymbol3D","../../../../symbols/TextSymbol","../../../../symbols/WebStyleSymbol","../../../../symbols/support/symbolConversion","../../../../symbols/support/unitConversionUtils","./ElevationQuery","./featureExpressionInfoUtils","./Graphics3DGraphic","./Graphics3DOwner","./Graphics3DSymbolFactory","./Graphics3DWebStyleSymbol","./graphicUtils","../../lib/glMatrix","../../support/aaBoundingBox","../../support/mathUtils","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/FloatingBoxLocalOriginFactory","../../webgl-engine/lib/Layer","../../webgl-engine/lib/Util"],function(e,i,t,a,r,s,n,o,l,h,p,d,c,y,u,b,g,f,m,v,w,S,C,x,D,G,V,I,R,E,U,L,F,B,O){function z(e){var i=e.elevationInfo&&e.elevationInfo.unit;i&&!v.supportsUnit(i)&&P.warn("elevationInfo.unit","'"+i+"' is not a valid unit")}function H(e){return"point"===e.type}function T(e){return"polygon"===e.type||"polyline"===e.type||"multipoint"===e.type}var A=I.vec3d,k=new d,q=A.create(),P=o.getLogger("esri.views.3d.layers.graphics.Graphics3DCore");return function(){function e(e){void 0===e&&(e=!0),this.elevationFeatureExpressionEnabled=e,this.graphics={},this.graphicsDrapedIds={},this.graphicsBySymbol={},this.graphicsKeys=[],this.symbols={},this.graphicsWithoutSymbol={},this.computedExtent=null,this.symbolCreationContext=new x.Graphics3DSymbolCreationContext,this.hasDraped=!1,this.updatingGraphicIds=new Set,this.lastFastUpdate=null,this.tilingSchemeHandle=null,this.stageLayer=null,this.labelStageLayer=null,this.stage=null,this.onComputedExtentChange=null,this.graphicTransformFunc=null,this.eventHandles=[],this.viewSR=null,this.layerView=null,this.layer=null,this.elevation=null,this.scaleVisibility=null,this.spatialIndex=null,this.labeling=null,this.elevationQueryService=null,this.elevationQueryView=null,this.highlights=null,this.sharedSymbolResourcesOwnerHandle=null,this.whenGraphics3DGraphicRequests={}}return e.prototype.initialize=function(i,t,a,r,s,n,o,l,p,d){var c=this;this.layerView=i,this.layer=t,this.viewSR=i.view.spatialReference,this.elevation=a,this.scaleVisibility=r,this.spatialIndex=s,this.labeling=n,this.highlights=o,this.onComputedExtentChange=l,this.graphicTransformFunc=p;var y=this.layerView.view;this.elevationQueryService=new w.ElevationQuery(this.viewSR,function(){return y.map.ground},{maximumAutoTileRequests:4}),this.elevationQueryView=new w.ElevationQueryView(this.viewSR,y.basemapTerrain),this.initializeStage(y,this.layer.uid),this.symbolCreationContext.sharedResources=y.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=y.sharedSymbolResources.addGraphicsOwner(this),this.symbolCreationContext.renderer=this.layer.renderer,this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataSupplier=y.sharedSymbolResources.streamDataSupplier,this.symbolCreationContext.renderSpatialReference=y.renderSpatialReference,this.symbolCreationContext.renderCoordsHelper=y.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.layerView=this.layerView,this.symbolCreationContext.layerOrder=0,this.symbolCreationContext.localOriginFactory=e.createLocalOriginFactory(),this.symbolCreationContext.elevationProvider=y.elevationProvider,z(this.layer);var u=S.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=S.createContext(u,this.viewSR,P),y.deconflictor.addGraphicsOwner(this),this.symbolCreationContext.screenSizePerspectiveEnabled=y.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.tilingSchemeHandle=h.when(d,"tilingScheme",function(e){e.spatialReference.equals(c.symbolCreationContext.overlaySR)||(c.symbolCreationContext.overlaySR=d.spatialReference,c.recreateAllGraphics())}),this.eventHandles.push(this.layerView.watch("suspended",function(){return c.suspendedChange()})),this.eventHandles.push(this.layerView.watch("layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled",function(){c.symbolCreationContext.screenSizePerspectiveEnabled=y.screenSizePerspectiveEnabled&&c.layer.screenSizePerspectiveEnabled,c.recreateAllGraphics()})),this.eventHandles.push(h.on(i,"loadedGraphics","change",function(e){return c.graphicsCollectionChanged(e)},function(){c.clearSymbolsAndGraphics(),c.graphicsCollectionChanged({added:c.layerView.loadedGraphics.toArray(),removed:[]})})),this.validateRenderer(this.layer.renderer)},e.prototype.destroy=function(){var e=this;if(this.layerView.view.deconflictor.removeGraphicsOwner(this),this.clear(),this.stage){var i=[this.stageLayer.id];this.labelStageLayer&&i.push(this.labelStageLayer.id),this.stage.removeFromViewContent(i),i.forEach(function(i){return e.stage.remove(L.ModelContentType.LAYER,i)}),this.stageLayer=null,this.labelStageLayer=null,this.stage=null}this.tilingSchemeHandle&&(this.tilingSchemeHandle.remove(),this.tilingSchemeHandle=null),this.eventHandles.forEach(function(e){return e.remove()}),this.eventHandles=null,this.onComputedExtentChange=null,this.viewSR=null,this.scaleVisibility=null,this.labeling=null,this.layerView=null;for(var t in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[t].reject(new n("graphic:layer-destroyed","Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null,this.sharedSymbolResourcesOwnerHandle&&(this.sharedSymbolResourcesOwnerHandle.remove(),this.sharedSymbolResourcesOwnerHandle=null)},e.prototype.clear=function(){var e=!1;for(var i in this.graphics){var t=this.graphics[i];e=e||t.isDraped(),t.destroy()}this.graphics={},this.graphicsKeys=null;for(var a in this.symbols){var r=this.symbols[a];r&&r.destroy()}this.symbols={},this.graphicsBySymbol={},this.graphicsWithoutSymbol={},this.hasDraped=!1,e&&this.layerView._notifyDrapedDataChange()},e.prototype.initializeStage=function(e,i){this.stage=e._stage,this.stageLayer=new B(i,{isPickable:!this.layerView.suspended},i),this.stage.add(L.ModelContentType.LAYER,this.stageLayer);var t=[this.stageLayer.id];this.labeling&&(this.labelStageLayer=new B(i,{isPickable:!1},i+"_labels"),this.stage.add(L.ModelContentType.LAYER,this.labelStageLayer),t.push(this.labelStageLayer.id)),this.stage.addToViewContent(t)},e.prototype.setDrawingOrder=function(e){this.symbolCreationContext.layerOrder=e;var i={},t={};for(var a in this.graphics){this.graphics[a].setDrawOrder(e,i,t)}for(var r in t){var s=this.symbols[r];s&&s.setDrawOrder(e,i)}O.objectEmpty(i)||(this.stage.getTextureGraphicsRenderer().updateRenderOrder(i),this.layerView._notifyDrapedDataChange())},e.prototype.suspendedChange=function(){!0===this.layerView.suspended?(this.stageLayer.isPickable=!1,this.hideAllGraphics()):!1===this.layerView.suspended&&(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility())},e.prototype.getGraphics3DGraphics=function(){return this.graphics},e.prototype.getGraphics3DGraphicById=function(e){return this.graphics[e]},e.prototype.getGraphics3DGraphicsKeys=function(){return null===this.graphicsKeys&&(this.graphicsKeys=Object.keys(this.graphics)),this.graphicsKeys},e.prototype.labelsEnabled=function(){return!(!this.labeling||!this.labeling.layerLabelsEnabled())},e.prototype.getSymbolUpdateType=function(){var e=0,i=0,t=0;for(var a in this.symbols){var r=this.symbols[a];if(r){var s=r.getFastUpdateStatus();e+=s.loading,t+=s.fast,i+=s.slow}}return e>0?"unknown":t>=0&&0===i?"fast":i>=0&&0===t?"slow":"mixed"},e.prototype.numNodesUpdating=function(){return this.updatingGraphicIds.size},e.prototype.needsIdleUpdate=function(){return!!this.lastFastUpdate&&performance.now()-this.lastFastUpdate>500},e.prototype.idleUpdate=function(e){e.done()||(this.lastFastUpdate&&(this.labeling&&this.labeling.updateLabelingInfo(),this.lastFastUpdate=null),this.layerView._evaluateUpdatingState())},e.prototype.whenGraphics3DGraphic=function(e){var i=this.graphics[e.uid];if(i)return l.resolve(i);var t=this.whenGraphics3DGraphicRequests[e.uid];return t||(t=new r,this.whenGraphics3DGraphicRequests[e.uid]=t),t.promise},e.prototype.boundsForGraphics3DGraphic=function(e,i){return a(this,void 0,void 0,function(){var a,r,s,n,o,l,h,p,d,c;return t(this,function(t){switch(t.label){case 0:return a=this.layerView.view.spatialReference,r=this.layerView.view.renderSpatialReference,s=this.layerView.view.basemapTerrain.spatialReference,n=function(e,i,t){return U.bufferToBuffer(e,r,i,e,a,i,t)},o=function(e,i,t){return U.bufferToBuffer(e,s,i,e,a,i,t)},l=i&&i.useViewElevation?this.elevationQueryView:this.elevationQueryService,[4,e.getProjectedBoundingBox(n,o,l)];case 1:return(h=t.sent())?(p=h.boundingBox,h.requiresDrapedElevation&&(d=this.symbolCreationContext.elevationProvider)&&(R.center(p,q),k.x=q[0],k.y=q[1],k.z=void 0,k.spatialReference=a,c=d.getElevation(k)||0,p[2]=Math.min(p[2],c),p[5]=Math.max(p[5],c)),[2,{boundingBox:p,screenSpaceObjects:h.screenSpaceObjects}]):[2,null]}})})},e.prototype.whenGraphicBounds=function(e,i){var t=this;return h.whenOnce(this.layerView,"loadedGraphics").then(function(){var i=t.layerView.layer&&t.layerView.layer.objectIdField,a=t.layerView.loadedGraphics.find(function(t){return t===e||!!(i&&t.attributes&&e.attributes&&t.attributes[i]===e.attributes[i])});if(a)return t.whenGraphics3DGraphic(a);throw new n("internal:graphic-not-part-of-view","Graphic is not part of this view")}).then(function(e){return t.boundsForGraphics3DGraphic(e,i)})},e.prototype.graphicsCollectionChanged=function(e){var i=this.graphicTransformFunc?this.graphicTransformFunc(e.added):e.added;this.add(i),this.remove(e.removed)},e.prototype.graphicUpdateHandler=function(e){var i=this.graphics[e.graphic.uid];if(i)switch(e.property){case"visible":i.setVisibilityFlag(0,e.newValue)&&(i.isDraped()&&this.layerView._notifyDrapedDataChange(),this.labeling&&this.layerView.view.deconflictor.setDirty())}},e.prototype.beginGraphicUpdate=function(e){this.updatingGraphicIds.add(e.uid),"symbolsUpdating"in this.layerView&&!this.layerView.get("symbolsUpdating")&&this.layerView.set("symbolsUpdating",!0),this.layerView._evaluateUpdatingState()},e.prototype.endGraphicUpdate=function(e){e&&this.updatingGraphicIds.delete(e.uid),"symbolsUpdating"in this.layerView&&this.layerView.get("symbolsUpdating")&&0===this.updatingGraphicIds.size&&(this.layerView.view.flushDisplayModifications(),this.layerView.set("symbolsUpdating",!1)),this.layerView._evaluateUpdatingState()},e.prototype.expandComputedExtent=function(i){var t,a,r,s,n,o;if(H(i))t=a=i.x,r=s=i.y,i.z&&(n=o=i.z);else if(T(i)){var l=i.extent;if(!l)return;t=l.xmin,a=l.xmax,r=l.ymin,s=l.ymax,n=l.zmin,o=l.zmax}var h=this.viewSR,d=e.tmpVec;if(i.spatialReference.equals(h)||U.xyzToVector(t,r,0,i.spatialReference,d,h)&&(t=d[0],r=d[1],U.xyzToVector(a,s,0,i.spatialReference,d,h),a=d[0],s=d[1]),E.isFinite(t)&&E.isFinite(a)&&E.isFinite(r)&&E.isFinite(s)){var c=this.computedExtent;c?(t<c.xmin&&(c.xmin=t),a>c.xmax&&(c.xmax=a),r<c.ymin&&(c.ymin=r),s>c.ymax&&(c.ymax=s)):(c=new p(t,r,a,s,i.spatialReference),this.computedExtent=c),E.isFinite(n)&&!E.isFinite(o)&&((null==c.zmin||n<c.zmin)&&(c.zmin=n),(null==c.zmax||o>c.zmax)&&(c.zmax=o)),this.onComputedExtentChange&&this.onComputedExtentChange()}},e.prototype.updateHasDraped=function(){this.hasDraped=!1;for(var e in this.graphicsDrapedIds)if(this.graphicsDrapedIds.hasOwnProperty(e)){this.hasDraped=!0;break}},e.prototype.elevationInfoChange=function(){z(this.layer);var e=S.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=S.createContext(e,this.viewSR,P),this.labeling&&this.labeling.elevationInfoChange(),this.layer.renderer!==this.symbolCreationContext.renderer&&this.rendererChange(this.layer.renderer);for(var i in this.graphicsBySymbol){var t=this.symbols[i],a=this.graphicsBySymbol[i];if(t&&t.layerPropertyChanged("elevationInfo",a)){for(var r in a){var s=a[r],n=s.graphic,o=s._labelGraphics;this.elevation&&this.elevation.markGraphicElevationDirty(n.uid);for(var l=0;l<o.length;l++){var h=o[l];h.graphics3DSymbolLayer.updateGraphicElevationContext(n,h)}}this.layerView._evaluateUpdatingState()}else this._recreateSymbol(i)}},e.prototype.clearSymbolsAndGraphics=function(){this.clear(),this.elevation&&this.elevation.clear(),this.labeling&&this.labeling.clear()},e.prototype.recreateAllGraphics=function(){this.clearSymbolsAndGraphics(),this.computedExtent=null,this.onComputedExtentChange&&this.onComputedExtentChange(),this.layerView.loadedGraphics&&this.layerView.view.basemapTerrain.tilingScheme&&this.add(this.layerView.loadedGraphics.toArray())},e.prototype._recreateSymbol=function(e){var i=this.graphicsBySymbol[e],t=[],a=!1;for(var r in i){var s=i[r];s.isDraped()&&(delete this.graphicsDrapedIds[r],a=!0),t.push(s.graphic),s.destroy(),delete this.graphics[r]}this.graphicsBySymbol[e]={};var n=this.symbols[e];n&&n.destroy(),delete this.symbols[e],this.updateHasDraped(),a&&this.layerView._notifyDrapedDataChange(),this.add(t)},e.prototype.add=function(e){if(this.layerView.view.basemapTerrain&&this.layerView.view.basemapTerrain.tilingScheme){for(var i=e.length,t=new Array(i),a=new Array(i),r=new Array(i),s=!1,n=0;n<i;n++){var o=e[n],l=o.geometry;if(l){this.expandComputedExtent(l);var h=this.layerView.getRenderingInfo?this.layerView.getRenderingInfo(o):{symbol:o.symbol};if(this.graphicsWithoutSymbol[o.uid]=o,h&&h.symbol){a[n]=h.symbol,r[n]=h;var p=this.getOrCreateGraphics3DSymbol(a[n],h.renderer);p&&(t[n]=p,this.beginGraphicUpdate(o))}else s||(s=!0,P.warn("Graphic in layer "+this.layer.id+" has no symbol and will not render"))}}for(var n=0;n<i;n++)this.waitForSymbol(t[n],a[n],e[n],r[n])}},e.prototype.waitForSymbol=function(e,i,t,a){var r=this;e&&e.then(function(){r.createGraphics3DGraphic(e,t,a),r.endGraphicUpdate(t),r.labeling&&r.layerView.view.deconflictor.setDirty()},function(){r.endGraphicUpdate(t)})},e.prototype.remove=function(e){for(var i=!1,t=e.length,a=0;a<t;a++){var r=e[a].uid,s=this.graphics[r];if(s){s.isDraped()&&(delete this.graphicsDrapedIds[r],i=!0);var n=s.graphics3DSymbol.symbol.id;s.destroy(),delete this.graphics[r],delete this.graphicsBySymbol[n][r],delete this.graphicsWithoutSymbol[r],this.graphicsKeys=null}}this.updateHasDraped(),i&&this.layerView._notifyDrapedDataChange(),this.layerView.view.deconflictor.setDirty()},e.prototype.hasLabelingContext=function(e){if(e instanceof b||e instanceof g){var i=this.symbolCreationContext.layer;return!!i.labelingInfo&&i.labelingInfo.some(function(i){return i.symbol===e})}return!1},e.prototype.hasValidSymbolCreationContext=function(e){return!(e instanceof b&&!this.hasLabelingContext(e))||(P.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1)},e.prototype.createGraphics3DSymbol=function(e,i){if(!this.hasValidSymbolCreationContext(e))return null;var t=m.to3D(e,!0,!1,this.hasLabelingContext(e));if(t.symbol){var a=void 0;if(i&&i.backgroundFillSymbol){var r=m.to3D(i.backgroundFillSymbol,!1,!0);r.symbol&&(a=r.symbol.symbolLayers)}return D.make(t.symbol,this.symbolCreationContext,a)}return t.error&&P.error(t.error.message),null},e.prototype.getOrCreateGraphics3DSymbol=function(e,i){var t=this,a=this.symbols[e.id];return void 0===a&&(a=e instanceof f?new G(e,function(e){return t.createGraphics3DSymbol(e,i)}):this.createGraphics3DSymbol(e,i),this.symbols[e.id]=a),a},e.prototype.createGraphics3DGraphic=function(e,i,t){if(delete this.graphicsWithoutSymbol[i.uid],!this.symbols[e.symbol.id])return void this.add([i]);if(!this.graphics[i.uid]){var a=e.createGraphics3DGraphic(i,t);this.graphics[i.uid]=a,this.graphicsKeys=null,this.graphicsBySymbol[e.symbol.id]||(this.graphicsBySymbol[e.symbol.id]={}),this.graphicsBySymbol[e.symbol.id][i.uid]=a,a.initialize(this.stageLayer,this.stage);a.isDraped()&&(this.graphicsDrapedIds[i.uid]=!0,this.hasDraped=!0,this.layerView._notifyDrapedDataChange()),a.centroid=null,"point"!==i.geometry.type&&a instanceof C&&(a.centroid=V.computeCentroid(i.geometry,this.viewSR));var r=this.scaleVisibility&&this.scaleVisibility.scaleRangeActive();this.spatialIndex&&this.spatialIndex.shouldAddToSpatialIndex(i,a,r)&&this.spatialIndex.addGraphicToSpatialIndex(i,a),this.labeling&&this.labeling.layerLabelsEnabled()&&this.labeling.createLabelsForGraphic(i,a),r&&this.scaleVisibility.updateGraphicScaleVisibility(i,a),a.setVisibilityFlag(0,i.visible&&!this.layerView.suspended);var s=this.whenGraphics3DGraphicRequests[i.uid];s&&(delete this.whenGraphics3DGraphicRequests[i.uid],s.resolve(a)),this.highlights&&this.highlights.graphicCreated(a)}},e.prototype.rendererChange=function(e){var i=this.symbolCreationContext.renderer;if(e!==i){this.validateRenderer(e);var t=y.diff(i,e);if(this.updateUnchangedSymbolMappings(t,e,i),this.symbolCreationContext.renderer=e,t)if("complete"===t.type)this.recreateAllGraphics();else if("partial"===t.type){if(!this.applyRendererDiff(t,e,i))return void this.recreateAllGraphics();this.volatileGraphicsUpdated()}}},e.prototype.diffHasSymbolChange=function(e){for(var i in e.diff)switch(i){case"visualVariables":case"defaultSymbol":case"uniqueValueInfos":break;case"authoringInfo":case"fieldDelimiter":delete e.diff[i];break;default:return!0}return!1},e.prototype.applySymbolSetDiff=function(e,i,t,a){var r=!1;e=e||[],i=i||[];for(var s=[],n=0;n<i.length;n++){var o=i[n],l=this.graphicsBySymbol[o.id];for(var h in l){var p=l[h],d=p.graphic;o===t.defaultSymbol&&t.getSymbol(d)===t.defaultSymbol||(p.isDraped()&&(delete this.graphicsDrapedIds[h],r=!0),e.length||t.defaultSymbol?s.push(d):this.graphicsWithoutSymbol[h]=d,p.destroy(),this.highlights&&this.highlights.graphicDeleted(this.graphics[h]),delete l[h],delete this.graphics[h],this.graphicsKeys=null)}if(void 0===l||0===Object.keys(l).length){delete this.graphicsBySymbol[o.id];var c=this.symbols[o.id];c&&c.destroy(),delete this.symbols[o.id]}}if(e.length||s.length){for(var h in this.graphicsWithoutSymbol)s.push(this.graphicsWithoutSymbol[h]);this.graphicsWithoutSymbol={},this.add(s)}this.updateHasDraped(),r&&this.layerView._notifyDrapedDataChange(),this.layerView.view.deconflictor.setDirty()},e.prototype.applyUniqueValueRendererDiff=function(e,i,t){var a=e.diff.defaultSymbol,r=e.diff.uniqueValueInfos;if(a||r){var s=r?r.added.map(function(e){return e.symbol}):[],n=r?r.removed.map(function(e){return e.symbol}):[];if(r)for(var o=0;o<r.changed.length;o++)s.push(r.changed[o].newValue.symbol),n.push(r.changed[o].oldValue.symbol);return a?(t.defaultSymbol&&n.push(t.defaultSymbol),i.defaultSymbol&&s.push(i.defaultSymbol)):t.defaultSymbol&&s.length&&n.push(i.defaultSymbol),this.applySymbolSetDiff(s,n,i,t),delete e.diff.defaultSymbol,delete e.diff.uniqueValueInfos,!0}return!1},e.prototype.calculateUnchangedSymbolMapping=function(e,i,t){if(i instanceof c&&t instanceof c)if(e){if("partial"===e.type){var a=e.diff,r=a.defaultSymbol,s=a.uniqueValueInfos,n=void 0;return n=s?s.unchanged.map(function(e){return{oldId:e.oldValue.symbol.id,newId:e.newValue.symbol.id}}):t.uniqueValueInfos.map(function(e,t){return{oldId:e.symbol.id,newId:i.uniqueValueInfos[t].symbol.id}}),!r&&t.defaultSymbol&&n.push({oldId:t.defaultSymbol.id,newId:i.defaultSymbol.id}),n}}else if(t&&t.defaultSymbol)return[{oldId:t.defaultSymbol.id,newId:i.defaultSymbol.id}];return[]},e.prototype.updateUnchangedSymbolMappings=function(e,i,t){for(var a=this.calculateUnchangedSymbolMapping(e,i,t),r=0,s=a;r<s.length;r++){var n=s[r],o=n.oldId,l=n.newId;if(o&&o!==l){var h=this.graphicsBySymbol[o];delete this.graphicsBySymbol[o],void 0!==h&&(this.graphicsBySymbol[l]=h);var p=this.symbols[o];delete this.symbols[o],void 0!==p&&(this.symbols[l]=p,p.symbol.id=l)}}},e.prototype.applyRendererDiff=function(e,i,t){var a=!1;if(this.diffHasSymbolChange(e))return!1;if(i instanceof c&&t instanceof c&&this.applyUniqueValueRendererDiff(e,i,t)&&0===Object.keys(e.diff).length)return!0;for(var r in this.graphicsBySymbol){var s=this.symbols[r];if(s){var n=this.graphicsBySymbol[r];if(!s.applyRendererDiff(e,i,n))return!1;if(!a)for(var o in n)if(n[o].isDraped()){this.layerView._notifyDrapedDataChange(),a=!0;break}}}return!0},e.prototype.opacityChange=function(){var e=!1;for(var i in this.graphicsBySymbol){var t=this.symbols[i];if(t){var a=this.graphicsBySymbol[i];if(t.layerPropertyChanged("opacity"),!e)for(var r in a)if(a[r].isDraped()){this.layerView._notifyDrapedDataChange(),e=!0;break}}}},e.prototype.setClippingExtent=function(e,i){var t=this.symbolCreationContext.clippingExtent,a=[];return U.extentToBoundingRect(e,a,i)?this.symbolCreationContext.clippingExtent=[a[0],a[1],-1/0,a[2],a[3],1/0]:this.symbolCreationContext.clippingExtent=null,!s.equals(this.symbolCreationContext.clippingExtent,t)},e.prototype.forEachGraphics3DGraphic=function(e){var i=this;if(this.layerView.loadedGraphics){var t=!1,a=!1;this.layerView.loadedGraphics.forEach(function(r){var s=i.getGraphics3DGraphicById(r.uid);if(s){e(s,r)&&(t=!0,a=a||s.isDraped())}}),t&&this.layerView.view.deconflictor.setDirty(),a&&this.layerView._notifyDrapedDataChange()}},e.prototype.updateAllGraphicsVisibility=function(){var e=this;this.forEachGraphics3DGraphic(function(i,t){var a=i.setVisibilityFlag(0,t.visible),r=!1;return e.scaleVisibility&&(r=e.scaleVisibility.updateGraphicScaleVisibility(t,i)),a||r})},e.prototype.hideAllGraphics=function(){this.forEachGraphics3DGraphic(function(e){return e.setVisibilityFlag(0,!1)})},e.prototype.validateRenderer=function(e){var i=u.validateTo3D(e);if(i){var t="Renderer for layer '"+(this.layer.title?this.layer.title+", ":"")+", id:"+this.layer.id+"' is not supported in a SceneView";P.warn(t,i.message)}},e.prototype.volatileGraphicsUpdated=function(){this.labeling&&(this.lastFastUpdate=performance.now()),this.stageLayer.invalidateSpatialQueryAccelerator(),this.stageLayer.shaderTransformationChanged(),this.layerView._evaluateUpdatingState()},e.createLocalOriginFactory=function(){return new F(5e6,16)},e.prototype.snapshotInternals=function(){var e=this;return{graphics:Object.keys(this.graphics).sort(),symbols:Object.keys(this.symbols).sort(),graphicsBySymbol:Object.keys(this.graphicsBySymbol).sort().map(function(i){return{symbolId:i,graphics:Object.keys(e.graphicsBySymbol[i]).sort()}}),graphicsWithoutSymbol:Object.keys(this.graphicsWithoutSymbol).sort(),graphicsDrapedIds:Object.keys(this.graphicsDrapedIds).sort()}},e.tmpVec=I.vec3d.create(),e}()});