// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./Graphics3DSymbolCommonCode","../../../../geometry/Polygon","../../../../geometry/Point","../../support/projectionUtils","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/materials/Material","../../webgl-engine/lib/Util","./earcut/earcut","./graphicUtils"],function(e,t,r,a,n,i,o,s,l,p,c,h,u,g,y,d,v,f){function m(e,t,r,a,n,i,o,s,l,p,c,h,u,g){var y=r.length/3,d=0,v=!0;v&&(c+=2*a.count),E(e,t,a.index,a.count,r,0,y,n,i,o,s,l,p,c,h,u,g),l+=2*a.count,c+=2*y,v&&(c-=2*a.count+2*y),x(n,i,s,o,d,a.pathLengths[0],a.count,l,p,c,h),l+=4*a.pathLengths[0],c+=2*a.pathLengths[0],d+=a.pathLengths[0];for(var f=1;f<a.pathLengths.length;++f)x(n,i,s,o,d,a.pathLengths[f],a.count,l,p,c,h),l+=4*a.pathLengths[f],c+=2*a.pathLengths[f],d+=a.pathLengths[f]}function E(e,t,r,a,n,i,o,s,l,p,c,h,u,g,y,d,v){w.set(d,C);for(var f=y>0?1:-1,m=3*r,E=h,_=3*E,x=h+a,b=3*x,S=0;a>S;++S)v&&(C[0]=e[m+0],C[1]=e[m+1],C[2]=e[m+2],w.normalize(C)),s[_+0]=e[m+0],s[_+1]=e[m+1],s[_+2]=e[m+2],l[_+0]=t[m+0],l[_+1]=t[m+1],l[_+2]=t[m+2],p[_+0]=-f*C[0],p[_+1]=-f*C[1],p[_+2]=-f*C[2],c[E]=0,s[b+0]=e[m+0]+y*C[0],s[b+1]=e[m+1]+y*C[1],s[b+2]=e[m+2]+y*C[2],l[b+0]=t[m+0],l[b+1]=t[m+1],l[b+2]=t[m+2],p[b+0]=f*C[0],p[b+1]=f*C[1],p[b+2]=f*C[2],c[x]=y,_+=3,b+=3,m+=3,E+=1,x+=1;m=3*i,_=3*g,b=3*(g+o);var A=!1;A===!1&&(_=3*(g+o),b=3*g);var L=P,D=z;0>y&&(L=z,D=P);for(var S=0;o>S;++S)u[_+0]=n[m+L[0]],u[_+1]=n[m+L[1]],u[_+2]=n[m+L[2]],u[b+0]=n[m+D[0]]+a,u[b+1]=n[m+D[1]]+a,u[b+2]=n[m+D[2]]+a,_+=3,b+=3,m+=3}function _(e,t,r,a,n,i,o){a[i]=a[o],o*=3,i*=3,e[i+0]=e[o+0],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i+0]=t[o+0],t[i+1]=t[o+1],t[i+2]=t[o+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2]}function x(e,t,r,a,n,i,o,s,l,p,c){var h=n,u=n+1,g=n+o,y=n+o+1,d=s,v=s+1,f=s+2*i,m=s+2*i+1;0>c&&(h=n+o+1,y=n),p*=3;for(var E=0;i>E;++E)E===i-1&&(c>0?(u=n,y=n+o):(u=n,h=n+o)),b(e,h,u,g,I),_(e,t,a,r,I,d,h),_(e,t,a,r,I,v,u),_(e,t,a,r,I,f,g),_(e,t,a,r,I,m,y),l[p++]=d,l[p++]=f,l[p++]=m,l[p++]=d,l[p++]=m,l[p++]=v,h++,u++,g++,y++,d+=2,v+=2,f+=2,m+=2}function b(e,t,r,a,n){t*=3,r*=3,a*=3,w.set3(e[t++],e[t++],e[t++],G),w.set3(e[r++],e[r++],e[r++],O),w.set3(e[a++],e[a++],e[a++],U),w.subtract(O,G,F),w.subtract(U,G,N),w.cross(N,F,n),w.normalize(n,n)}function S(e,t,r,a){var n=a.setAltitude;M.spatialReference=r.spatialReference;for(var o=e.getGeometryRecords(),s=o.length,l="absolute-height"!==t.mode,p=0,c=0;s>c;c++){var h=o[c].geometry,u=o[c].transformation,g=h.getData();V[0]=u[12],V[1]=u[13],V[2]=u[14],h.invalidateBoundingInfo();for(var y=g.getVertexAttr(),d=y[A.POSITION].data,v=y[A.SIZE].data,f=y.mapPos.data,m=d.length/3,E=0,_=0,x=!1,b=0,S=0;m>S;S++){M.x=f[_],M.y=f[_+1],M.z=f[_+2],B[0]=d[E],B[1]=d[E+1],B[2]=d[E+2];var w=i.computeElevation(r,M,t,a,l?R:null);l&&(b+=R.terrainElevation),D[0]=d[E]+V[0],D[1]=d[E+1]+V[1],D[2]=d[E+2]+V[2],n(w+v[E/3],D),d[E]=D[0]-V[0],d[E+1]=D[1]-V[1],d[E+2]=D[2]-V[2];var L=.01/a.unitInMeters;(Math.abs(B[0]-d[E])>L||Math.abs(B[1]-d[E+1])>L||Math.abs(B[2]-d[E+2])>L)&&(x=!0),_+=3,E+=3}x&&e.geometryVertexAttrsUpdated(c),p+=b/m}return p/s}var A=d.VertexAttrConstants,w=p.vec3d,L=p.mat4d,D=w.create(),C=w.create(),P=[0,2,1],z=[0,1,2],M=new s,R={verticalDistanceToGround:0,terrainElevation:0},T=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return r(t,e),t.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var e=f.validateSymbolLayerSize(this._getSymbolSize());if(e)return this._logWarning(e),void this.reject()}var t=this._getStageIdHint(),r=this._getMaterialOpacityAndColor(),a=w.create(r),n=r[3],i={diffuse:a,ambient:a,opacity:n,transparent:1>n||this._isPropertyDriven("opacity"),vertexColors:!0};this._material=new y(i,t+"_3dlinemat"),this._context.stage.add(c.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&this._context.stage.remove(c.ModelContentType.MATERIAL,this._material.getId())},t.prototype.createGraphics3DGraphic=function(e,t){var r=this._validateGeometry(e.geometry);if("polygon"!==r.type&&"extent"!==r.type)return this._logWarning("unsupported geometry type for extrude symbol: "+r.type),null;var a="polygon"===r.type||"extent"===r.type?"rings":"paths",n="graphic"+e.uid,i=this._getVertexOpacityAndColor(t,Float32Array,255),o=this.getGraphicElevationContext(e);return this._createAs3DShape(e,a,t,i,o,n,e.uid)},t.prototype.layerPropertyChanged=function(e,t,r){if("opacity"===e){var a=this._getMaterialOpacity(),n=1>a||this._isPropertyDriven("opacity");return this._material.setParameterValues({opacity:a,transparent:n}),!0}if("elevationInfo"===e){this._updateElevationContext();for(var o in t){var s=t[o],l=r(s);if(l){var p=s.graphic,c=this.getGraphicElevationContext(p);l.needsElevationUpdates=i.needsElevationUpdates3D(c.mode),l.elevationContext.set(c)}}return!0}return!1},t.prototype._getExtrusionSize=function(e){var t;return t=e.size&&this._isPropertyDriven("size")?i.getSingleSizeDriver(e.size,2):this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){return this.symbol.size||1},t.prototype._createAs3DShape=function(e,t,r,a,s,p,c){var g=e.geometry;"extent"===g.type&&(g=o.fromExtent(g));var y=g[t],d=g.hasZ,f=[],E=[],_=[],x=w.create(),b=new Array(6),A=this._context.renderSpatialReference===l.SphericalECEFSpatialReference,D=this._getExtrusionSize(r),C=w.create();A||this._context.renderCoordsHelper.worldUpAtPosition(null,C);var P=i.getGeometryVertexData3D(y,d,g.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,s);if(this._logGeometryCreationWarnings(P,y,t,"ExtrudeSymbol3DLayer"),y.length>0){for(var z=P.geometryData.polygons,M=P.eleVertexData,R=P.vertexData,T=R.length/3,I=new Float64Array(3*T*6),G=new Float64Array(3*T*6),O=new Float64Array(3*T*6),U=new Float64Array(1*T*6),F=0,N=function(e){var t=z[e],r=t.count,n=t.index;if(B._context.clippingExtent&&(i.computeBoundingBox(M,n,r,b),i.boundingBoxClipped(b,B._context.clippingExtent)))return"continue";var o=new Float64Array(M.buffer,3*n*I.BYTES_PER_ELEMENT,3*r),s=t.holeIndices.map(function(e){return e-n}),l=v(o,s,3);if(l.length>0){i.chooseOrigin(R,n,r,x);var c=3*r*2+2*l.length,h=new Uint32Array(c),g=6*r,y=new Float64Array(I.buffer,3*F*I.BYTES_PER_ELEMENT,3*g),d=new Float64Array(G.buffer,3*F*G.BYTES_PER_ELEMENT,3*g),S=new Float64Array(O.buffer,3*F*O.BYTES_PER_ELEMENT,3*g),w=new Float64Array(U.buffer,1*F*U.BYTES_PER_ELEMENT,1*g);m(R,M,l,t,y,S,d,w,0,h,0,D,C,A),i.subtractCoordinates(y,0,g,x),F+=6*r;var P=B._createExtrudeGeometry(h,{positions:y,elevation:S,normals:d,heights:w},a),T=new u(P,p+"path"+e);T.singleUse=!0,f.push(T),E.push([B._material]);var N=L.identity();L.translate(N,x,N),_.push(N)}},B=this,V=0;V<z.length;++V)N(V);if(f.length>0){var H=new h({geometries:f,materials:E,transformations:_,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicId:c},idHint:p}),Y=S,j=new n(this,H,f,null,null,Y,s);return j.alignedTerrainElevation=P.terrainElevation,j.needsElevationUpdates=i.needsElevationUpdates3D(s.mode),j}return null}return null},t.prototype._createExtrudeGeometry=function(e,t,r){for(var a=e.length,n=e,i=new Uint32Array(a),o=0;a>o;o++)i[o]=0;var s={},l={};return s[A.POSITION]=n,s[A.NORMAL]=n,s[A.COLOR]=i,l[A.POSITION]={size:3,data:t.positions},l[A.NORMAL]={size:3,data:t.normals},l[A.COLOR]={size:4,data:r},l[A.SIZE]={size:1,data:t.heights},t.elevation&&(l.mapPos={size:3,data:t.elevation},s.mapPos=n),new g(l,s)},t}(a),I=w.create(),G=w.create(),O=w.create(),U=w.create(),F=w.create(),N=w.create(),B=w.create(),V=w.create();return T});