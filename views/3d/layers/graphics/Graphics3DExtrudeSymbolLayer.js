// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/earcut/earcut","../../../../geometry/Point","../../../../geometry/Polygon","./Graphics3DGraphicLayer","./Graphics3DSymbolCommonCode","./Graphics3DSymbolLayer","./graphicUtils","../support/edgeUtils","../../lib/glMatrix","../../support/projectionUtils","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Util","../../webgl-engine/materials/DefaultMaterial"],function(e,t,r,a,n,i,o,s,l,c,p,h,g,u,d,y,v,f,m){function _(e,t,r,a,n,i,o,s,l,c,p,h,g,u){var d=r.length/3,y=0;p+=2*a.count,E(e,t,a.index,a.count,r,0,d,n,i,o,s,l,c,p,h,g,u),l+=2*a.count,p+=2*d,p-=2*a.count+2*d,x(n,i,s,o,y,a.pathLengths[0],a.count,l,c,p,h),l+=4*a.pathLengths[0],p+=2*a.pathLengths[0],y+=a.pathLengths[0];for(var v=1;v<a.pathLengths.length;++v)x(n,i,s,o,y,a.pathLengths[v],a.count,l,c,p,h),l+=4*a.pathLengths[v],p+=2*a.pathLengths[v],y+=a.pathLengths[v]}function E(e,t,r,a,n,i,o,s,l,c,p,h,g,u,d,y,v){O.set(y,C);for(var f=d>0?1:-1,m=3*r,_=h,E=3*_,b=h+a,x=3*b,S=0;S<a;++S)v&&(C[0]=e[m+0],C[1]=e[m+1],C[2]=e[m+2],O.normalize(C)),s[E+0]=e[m+0],s[E+1]=e[m+1],s[E+2]=e[m+2],l[E+0]=t[m+0],l[E+1]=t[m+1],l[E+2]=t[m+2],c[E+0]=-f*C[0],c[E+1]=-f*C[1],c[E+2]=-f*C[2],p[_]=0,s[x+0]=e[m+0]+d*C[0],s[x+1]=e[m+1]+d*C[1],s[x+2]=e[m+2]+d*C[2],l[x+0]=t[m+0],l[x+1]=t[m+1],l[x+2]=t[m+2],c[x+0]=f*C[0],c[x+1]=f*C[1],c[x+2]=f*C[2],p[b]=d,E+=3,x+=3,m+=3,_+=1,b+=1;m=3*i,E=3*u,x=3*(u+o);E=3*(u+o),x=3*u;var w=z,A=M;d<0&&(w=M,A=z);for(var S=0;S<o;++S)g[E+0]=n[m+w[0]],g[E+1]=n[m+w[1]],g[E+2]=n[m+w[2]],g[x+0]=n[m+A[0]]+a,g[x+1]=n[m+A[1]]+a,g[x+2]=n[m+A[2]]+a,E+=3,x+=3,m+=3}function b(e,t,r,a,n,i,o){a[i]=a[o],o*=3,i*=3,e[i+0]=e[o+0],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i+0]=t[o+0],t[i+1]=t[o+1],t[i+2]=t[o+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2]}function x(e,t,r,a,n,i,o,s,l,c,p){var h=n,g=n+1,u=n+o,d=n+o+1,y=s,v=s+1,f=s+2*i,m=s+2*i+1;p<0&&(h=n+o+1,d=n),c*=3;for(var _=0;_<i;++_)_===i-1&&(p>0?(g=n,d=n+o):(g=n,h=n+o)),S(e,h,g,u,G),b(e,t,a,r,G,y,h),b(e,t,a,r,G,v,g),b(e,t,a,r,G,f,u),b(e,t,a,r,G,m,d),l[c++]=y,l[c++]=f,l[c++]=m,l[c++]=y,l[c++]=m,l[c++]=v,h++,g++,u++,d++,y+=2,v+=2,f+=2,m+=2}function S(e,t,r,a,n){t*=3,r*=3,a*=3,O.set3(e[t++],e[t++],e[t++],I),O.set3(e[r++],e[r++],e[r++],U),O.set3(e[a++],e[a++],e[a++],F),O.subtract(U,I,j),O.subtract(F,I,N),O.cross(N,j,n),O.normalize(n,n)}function w(e,t,r,a){var n=a.setAltitude;P.spatialReference=r.spatialReference;for(var i=e.getGeometryRecords(),o=i.length,l="absolute-height"!==t.mode,c=0,p=0;p<o;p++){var h=i[p].geometry,g=i[p].transformation,u=h.getData();V[0]=g[12],V[1]=g[13],V[2]=g[14],h.invalidateBoundingInfo();for(var d=u.getVertexAttr(),y=d[A.POSITION].data,v=d[A.SIZE].data,f=d.mapPos.data,m=y.length/3,_=0,E=0,b=!1,x=0,S=0;S<m;S++){P.x=f[E],P.y=f[E+1],P.z=f[E+2],B[0]=y[_],B[1]=y[_+1],B[2]=y[_+2];var w=s.computeElevation(r,P,t,a,l?R:null);l&&(x+=R.terrainElevation),D[0]=y[_]+V[0],D[1]=y[_+1]+V[1],D[2]=y[_+2]+V[2],n(w+v[_/3],D),y[_]=D[0]-V[0],y[_+1]=D[1]-V[1],y[_+2]=D[2]-V[2];var O=.01/a.unitInMeters;(Math.abs(B[0]-y[_])>O||Math.abs(B[1]-y[_+1])>O||Math.abs(B[2]-y[_+2])>O)&&(b=!0),E+=3,_+=3}b&&e.geometryVertexAttrsUpdated(p),c+=x/m}return c/o}var A=f.VertexAttrConstants,O=h.vec3d,L=h.mat4d,D=O.create(),C=O.create(),z=[0,2,1],M=[0,1,2],P=new n,R={verticalDistanceToGround:0,terrainElevation:0},T=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._edgeStageObjects=new Set,t}return r(t,e),t.prototype._prepareResources=function(){if(!this._isPropertyDriven("size")){var e=c.validateSymbolLayerSize(this._getSymbolSize());if(e)return this._logWarning(e),void this.reject()}var t=this._getStageIdHint(),r=this._getMaterialOpacityAndColor(),a=O.create(r),n=r[3],i={diffuse:a,ambient:a,opacity:n,transparent:n<1||this._isPropertyDriven("opacity"),vertexColors:!0};this._material=new m(i,t+"_3dlinemat"),this._context.stage.add(u.ModelContentType.MATERIAL,this._material),this.resolve()},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.isFulfilled()||this.reject(),this._material&&this._context.stage.remove(u.ModelContentType.MATERIAL,this._material.id)},t.prototype.createGraphics3DGraphic=function(e,t){var r=this._validateGeometry(e.geometry);if("polygon"!==r.type&&"extent"!==r.type)return this._logWarning("unsupported geometry type for extrude symbol: "+r.type),null;var a="polygon"===r.type||"extent"===r.type?"rings":"paths",n="graphic"+e.uid,i=this._getVertexOpacityAndColor(t,Float32Array,255),o=this.getGraphicElevationContext(e);return this._createAs3DShape(e,a,t,i,o,n,e.uid)},t.prototype.layerPropertyChanged=function(e,t,r){if("opacity"===e){var a=this._getMaterialOpacity(),n=a<1||this._isPropertyDriven("opacity");if(this._material.setParameterValues({opacity:a,transparent:n}),this._edgeStageObjects.size>0){var i=this._context.stage.view.getEdgeView(),o=this._getLayerOpacity(),l=this.symbol.edges?this.symbol.edges.color.a:0;this._edgeStageObjects.forEach(function(e){i.updateComponentOpacity(e,0,l*o)})}return!0}if("elevationInfo"===e){this._updateElevationContext();for(var c in t){var p=t[c],h=r(p);if(h){var g=p.graphic,u=this.getGraphicElevationContext(g);h.needsElevationUpdates=s.needsElevationUpdates3D(u.mode),h.elevationContext.set(u)}}return!0}return!1},t.prototype._getExtrusionSize=function(e){var t;return t=e.size&&this._isPropertyDriven("size")?s.getSingleSizeDriver(e.size,2):this._getSymbolSize(),t/=this._context.renderCoordsHelper.unitInMeters},t.prototype._getSymbolSize=function(){return this.symbol.size||1},t.prototype._createAs3DShape=function(e,t,r,n,l,c,h){var u=this,y=e.geometry;"extent"===y.type&&(y=i.fromExtent(y));var f=y[t],m=y.hasZ,E=[],b=[],x=[],S=O.create(),A=new Array(6),D=this._context.renderSpatialReference===g.SphericalECEFSpatialReference,C=this._getExtrusionSize(r),z=O.create();D||this._context.renderCoordsHelper.worldUpAtPosition(null,z);var M=s.getGeometryVertexData3D(f,m,y.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,this._context.renderCoordsHelper,l);if(this._logGeometryCreationWarnings(M,f,t,"ExtrudeSymbol3DLayer"),f.length>0){for(var P=M.geometryData.polygons,R=M.eleVertexData,T=M.vertexData,G=T.length/3,I=new Float64Array(3*G*6),U=new Float64Array(3*G*6),F=new Float64Array(3*G*6),j=new Float64Array(1*G*6),N=0,B=this,V=0;V<P.length;++V)!function(e){var t=P[e],r=t.count,i=t.index;if(B._context.clippingExtent&&(s.computeBoundingBox(R,i,r,A),s.boundingBoxClipped(A,B._context.clippingExtent)))return"continue";var o=new Float64Array(R.buffer,3*i*I.BYTES_PER_ELEMENT,3*r),l=t.holeIndices.map(function(e){return e-i}),p=a(o,l,3);if(p.length>0){s.chooseOrigin(T,i,r,S);var h=3*r*2+2*p.length,g=new Uint32Array(h),u=6*r,y=new Float64Array(I.buffer,3*N*I.BYTES_PER_ELEMENT,3*u),v=new Float64Array(U.buffer,3*N*U.BYTES_PER_ELEMENT,3*u),f=new Float64Array(F.buffer,3*N*F.BYTES_PER_ELEMENT,3*u),m=new Float64Array(j.buffer,1*N*j.BYTES_PER_ELEMENT,1*u);_(T,R,p,t,y,f,v,m,0,g,0,C,z,D),s.subtractCoordinates(y,0,u,S),N+=6*r;var w=B._createExtrudeGeometry(g,{positions:y,elevation:f,normals:v,heights:m},n),O=new d(w,c+"path"+e);O.singleUse=!0,E.push(O),b.push([B._material]);var M=L.identity();L.translate(M,S,M),x.push(M)}}(V);if(E.length>0){var H=new v({geometries:E,materials:b,transformations:x,castShadow:!0,metadata:{layerUid:this._context.layer.uid,graphicId:h},idHint:c}),Y=function(e){var t=u._context.stage.view.getEdgeView();if(t){t.removeObject(e),u._edgeStageObjects.delete(e);var r=p.createMaterial(t,u.symbol,u._getLayerOpacity());r&&(u._edgeStageObjects.add(e),t.addObject(e,[r]))}};Y(H);var W=function(e,t,r,a){var n=w(e,t,r,a);return Y(e),n},Z=new o(this,H,E,null,null,W,l);return Z.alignedTerrainElevation=M.terrainElevation,Z.needsElevationUpdates=s.needsElevationUpdates3D(l.mode),Z}return null}return null},t.prototype._createExtrudeGeometry=function(e,t,r){for(var a=e.length,n=e,i=new Uint32Array(a),o=0;o<a;o++)i[o]=0;var s={},l={};return s[A.POSITION]=n,s[A.NORMAL]=n,s[A.COLOR]=i,l[A.POSITION]={size:3,data:t.positions},l[A.NORMAL]={size:3,data:t.normals},l[A.COLOR]={size:4,data:r},l[A.SIZE]={size:1,data:t.heights},t.elevation&&(l.mapPos={size:3,data:t.elevation},s.mapPos=n),new y(l,s)},t}(l),G=O.create(),I=O.create(),U=O.create(),F=O.create(),j=O.create(),N=O.create(),B=O.create(),V=O.create();return T});