// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../../../core/declare","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./Graphics3DSymbolCommonCode","./ElevationInfo","../../../../geometry/Polygon","../../support/projectionUtils","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryData","../../webgl-engine/materials/Material","../../webgl-engine/lib/Util","./earcut/earcut"],function(e,t,r,a,n,i,o,s,l,c,h,p,g,u,d){function v(e,t,r,a,n,i,o,s,l,c,h,p,g,u){var d=r.length/3,v=0,y=!0;y&&(h+=2*a.count),f(e,t,a.index,a.count,r,0,d,n,i,o,s,l,c,h,p,g,u),l+=2*a.count,h+=2*d,y&&(h-=2*a.count+2*d),E(n,i,s,o,v,a.pathLengths[0],a.count,l,c,h,p),l+=4*a.pathLengths[0],h+=2*a.pathLengths[0],v+=a.pathLengths[0];for(var _=1;_<a.pathLengths.length;++_)E(n,i,s,o,v,a.pathLengths[_],a.count,l,c,h,p),l+=4*a.pathLengths[_],h+=2*a.pathLengths[_],v+=a.pathLengths[_]}function f(e,t,r,a,n,i,o,s,l,c,h,p,g,u,d,v,f){x.set(v,S);for(var y=d>0?1:-1,E=3*r,_=p,m=3*_,b=p+a,A=3*b,T=0;a>T;++T)f&&(S[0]=e[E+0],S[1]=e[E+1],S[2]=e[E+2],x.normalize(S)),s[m+0]=e[E+0],s[m+1]=e[E+1],s[m+2]=e[E+2],l[m+0]=t[E+0],l[m+1]=t[E+1],l[m+2]=t[E+2],c[m+0]=-y*S[0],c[m+1]=-y*S[1],c[m+2]=-y*S[2],h[_]=0,s[A+0]=e[E+0]+d*S[0],s[A+1]=e[E+1]+d*S[1],s[A+2]=e[E+2]+d*S[2],l[A+0]=t[E+0],l[A+1]=t[E+1],l[A+2]=t[E+2],c[A+0]=y*S[0],c[A+1]=y*S[1],c[A+2]=y*S[2],h[b]=d,m+=3,A+=3,E+=3,_+=1,b+=1;E=3*i,m=3*u,A=3*(u+o);var w=!1;w===!1&&(m=3*(u+o),A=3*u);var O=I,M=L;for(0>d&&(O=L,M=I),T=0;o>T;++T)g[m+0]=n[E+O[0]],g[m+1]=n[E+O[1]],g[m+2]=n[E+O[2]],g[A+0]=n[E+M[0]]+a,g[A+1]=n[E+M[1]]+a,g[A+2]=n[E+M[2]]+a,m+=3,A+=3,E+=3}function y(e,t,r,a,n,i,o){a[i]=a[o],o*=3,i*=3,e[i+0]=e[o+0],e[i+1]=e[o+1],e[i+2]=e[o+2],t[i+0]=t[o+0],t[i+1]=t[o+1],t[i+2]=t[o+2],r[i+0]=n[0],r[i+1]=n[1],r[i+2]=n[2]}function E(e,t,r,a,n,i,o,s,l,c,h){var p=n,g=n+1,u=n+o,d=n+o+1,v=s,f=s+1,E=s+2*i,m=s+2*i+1;0>h&&(p=n+o+1,d=n),c*=3;for(var x=0;i>x;++x)x===i-1&&(h>0?(g=n,d=n+o):(g=n,p=n+o)),_(e,p,g,u,M),y(e,t,a,r,M,v,p),y(e,t,a,r,M,f,g),y(e,t,a,r,M,E,u),y(e,t,a,r,M,m,d),l[c++]=v,l[c++]=E,l[c++]=m,l[c++]=v,l[c++]=m,l[c++]=f,p++,g++,u++,d++,v+=2,f+=2,E+=2,m+=2}function _(e,t,r,a,n){t*=3,r*=3,a*=3,x.set3(e[t++],e[t++],e[t++],D),x.set3(e[r++],e[r++],e[r++],P),x.set3(e[a++],e[a++],e[a++],R),x.subtract(P,D,G),x.subtract(R,D,z),x.cross(z,G,n),x.normalize(n,n)}var m=u.VertexAttrConstants,x=s.vec3d,b=s.mat4d,A=x.create(),S=x.create(),I=[0,2,1],L=[0,1,2],T={},w={verticalDistanceToGround:0,terrainElevation:0},O=e([t],{_prepareResources:function(){var e=this._getStageIdHint(),t=this._getMaterialOpacityAndColor(),r=x.create(t),a=t[3],n={diffuse:r,ambient:r,opacity:a,transparent:1>a||this._isPropertyDriven("opacity"),vertexColors:!0};this._material=new g(n,e+"_3dlinemat"),this._context.stage.add(l.ModelContentType.MATERIAL,this._material),this.resolve()},destroy:function(){this.isFulfilled()||this.reject(),this._material&&this._context.stage.remove(l.ModelContentType.MATERIAL,this._material.getId())},createGraphics3DGraphic:function(e,t){var r=e.geometry;if("polygon"!==r.type&&"extent"!==r.type)return this._logWarning("unsupported geometry type for extrude symbol: "+r.type),null;var a="polygon"===r.type||"extent"===r.type?"rings":"paths",n="graphic"+e.uid,i=this._getVertexOpacityAndColor(t,Float32Array,255),o=this._getGraphicElevationInfo(e);return this._createAs3DShape(e,a,t,i,o,n,e.uid)},layerPropertyChanged:function(e,t,r){if("opacity"===e){var n=this._getMaterialOpacity(),i=1>n||this._isPropertyDriven("opacity");return this._material.setParameterValues({opacity:n,transparent:i}),!0}if("elevationInfo"===e){this._updateElevationInfo();var o=this._context.elevationProvider,s=this._context.renderCoordsHelper,l=a.ELEV_MODES.ABSOLUTE_HEIGHT;for(var c in t){var h=t[c],p=h._graphics[r];if(p){var g=h.graphic,u=this._getGraphicElevationInfo(g);p.elevationAligner=u.mode!==l?F:null,p.elevationInfo.set(u),F(p,o,s)}}return!0}return!1},_getExtrusionSize:function(e,t){var r=e.size&&this._isPropertyDriven("size")?a.getSingleSizeDriver(e.size):this.symbol.size||1;return r/=this._context.renderCoordsHelper.unitInMeters},_createAs3DShape:function(e,t,n,s,l,p,g){var u=e.geometry;"extent"===u.type&&(u=i.fromExtent(u));var f=u[t],y=u.hasZ,E=f.length;if(E>0){var _=[],m=[],A=[],S=x.create(),I=new Array(6),L=this._context.renderSpatialReference===o.SphericalRenderSpatialReference,T=this._getExtrusionSize(n,this.symbol.size),w=x.create();L||this._context.renderCoordsHelper.worldUpAtPosition(null,w);for(var O=a.getGeometryVertexData3D(f,y,u.spatialReference,this._context.renderSpatialReference,this._context.elevationProvider,l),M=O.geometryData.polygons,D=O.eleVertexData,P=O.vertexData,R=P.length/3,G=new Float64Array(3*R*6),z=new Float64Array(3*R*6),C=new Float64Array(3*R*6),B=new Float64Array(1*R*6),H=0,N=0;N<M.length;++N){var U=M[N],V=U.count,Y=U.index;if(!this._context.clippingExtent||(a.computeBoundingBox(D,Y,V,I),!a.boundingBoxClipped(I,this._context.clippingExtent))){var j=new Float64Array(D.buffer,3*Y*G.BYTES_PER_ELEMENT,3*V),Z=U.holeIndices.map(function(e){return e-Y}),W=d(j,Z,3);if(W.length>0){a.chooseOrigin(P,Y,V,S);var k=3*V*2+2*W.length,q=new Uint32Array(k),J=6*V,K=new Float64Array(G.buffer,3*H*G.BYTES_PER_ELEMENT,3*J),Q=new Float64Array(z.buffer,3*H*z.BYTES_PER_ELEMENT,3*J),X=new Float64Array(C.buffer,3*H*C.BYTES_PER_ELEMENT,3*J),$=new Float64Array(B.buffer,1*H*B.BYTES_PER_ELEMENT,1*J);v(P,D,W,U,K,X,Q,$,0,q,0,T,w,L),a.subtractCoordinates(K,0,J,S),H+=6*V;var ee=this._createExtrudeGeometry(q,{positions:K,elevation:X,normals:Q,heights:$},s),te=new h(ee,p+"path"+N);te.singleUse=!0,_.push(te),m.push([this._material]);var re=b.identity();b.translate(re,S,re),A.push(re)}}}if(_.length>0){var ae=this._context.layer.id,ne=new c({geometries:_,materials:m,transformations:A,castShadow:!0,metadata:{layerId:ae,graphicId:g},idHint:p}),ie=null;l.mode!==a.ELEV_MODES.ABSOLUTE_HEIGHT&&(ie=F);var oe=new r(this,ne,_,null,null,ie,l);return oe.alignedTerrainElevation=O.terrainElevation,oe}return null}return this._logWarning("no paths found for extrusion symbol"),null},_createExtrudeGeometry:function(e,t,r){for(var a=e.length,n=e,i=new Uint32Array(a),o=0;a>o;o++)i[o]=0;var s={},l={};return s[m.POSITION]=n,s[m.NORMAL]=n,s[m.COLOR]=i,l[m.POSITION]={size:3,data:t.positions},l[m.NORMAL]={size:3,data:t.normals},l[m.COLOR]={size:4,data:r},l[m.SIZE]={size:1,data:t.heights},t.elevation&&(l.mapPos={size:3,data:t.elevation},s.mapPos=n),new p(l,s)}}),M=x.create(),D=x.create(),P=x.create(),R=x.create(),G=x.create(),z=x.create(),C=x.create(),B=x.create(),F=function(e,t,r){var i=e.stageObject,o=e.elevationInfo,s=r.setAltitude;T.spatialReference=t.spatialReference;for(var l=i.getGeometryRecords(),c=l.length,h=o.mode!==n.MODES.ABSOLUTE_HEIGHT,p=0,g=0;c>g;g++){var u=l[g].geometry,d=l[g].transformation;B[0]=d[12],B[1]=d[13],B[2]=d[14],u.invalidateBoundingInfo();for(var v=u.getData().getVertexAttr(),f=v[m.POSITION].data,y=v[m.SIZE].data,E=v.mapPos.data,_=f.length/3,x=0,b=0,S=!1,I=0,L=0;_>L;L++){T.x=E[b],T.y=E[b+1],T.z=E[b+2],C[0]=f[x],C[1]=f[x+1],C[2]=f[x+2];var O=a.computeElevation(t,T,o,h?w:null);h&&(I+=w.terrainElevation),A[0]=f[x]+B[0],A[1]=f[x+1]+B[1],A[2]=f[x+2]+B[2],s(O+y[x/3],A,0),f[x]=A[0]-B[0],f[x+1]=A[1]-B[1],f[x+2]=A[2]-B[2];var M=.01/r.unitInMeters;(Math.abs(C[0]-f[x])>M||Math.abs(C[1]-f[x+1])>M||Math.abs(C[2]-f[x+2])>M)&&(S=!0),b+=3,x+=3}S&&i.geometryVertexAttrsUpdated(g),p+=I/_}e.alignedTerrainElevation=p/c};return O});