// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessorSupport/decorators","../../../layers/IntegratedMeshLayer","../../../core/arrayUtils","../../../core/watchUtils","../../../core/promiseUtils","../../../core/Logger","../../../core/lang","dojo/_base/lang","dojox/color/_base","dojo/has","../../layers/LayerView","../../../Graphic","../../../symbols/Symbol3D","../../../geometry/Extent","./i3s/I3SUtil","./i3s/I3SBinaryReader","./i3s/I3SProjectionUtil","./i3s/I3SQueryEngine","./graphics/graphicUtils","./support/LayerViewUpdatingPercentage","../support/intersectionUtils","../support/projectionUtils","../support/aaBoundingBox","../webgl-engine/Stage","../webgl-engine/lib/Layer","../webgl-engine/lib/Geometry","../webgl-engine/lib/GeometryData","../webgl-engine/lib/Object3D","../webgl-engine/lib/Texture","../webgl-engine/materials/Material","../webgl-engine/lib/Util","../webgl-engine/lib/base64Binary","../lib/glMatrix"],function(e,t,r,n,i,a,o,s,d,l,u,c,h,g,f,p,m,_,y,v,b,I,x,M,O,E,T,A,w,D,C,L,F,j,R,B,V){function S(e){return e.getMetadata()}function P(e,t,r,n){var i,a=!1;t.encoding===y.DDS_ENCODING_STRING?i=F.DDS_ENCODING:a=!(k(e.width)&&k(e.height));var o=t.usedByEngineMats.some(function(e){return e.getParams().atlasRegions}),s=o||t.atlas,d=(r||!s)&&!a,l=s||!t.wrap,u=s&&d&&n;return{mipmap:d,wrapClamp:l,disableAnisotropy:u,encoding:i,noUnpackFlip:!0}}function N(e){return null!=e.featureIds?e.featureIds.length:1}function G(e,t){for(var r=t.toLowerCase(),n=0,i=Object.keys(e);n<i.length;n++){var a=i[n];if(a.toLowerCase()===r)return e[a]}return null}var U=l.getLogger("esri.layers.SceneService"),z=R.assert,q=R.clamp,k=R.isPowerOfTwo,X=R.fallbackIfUndefined,H=R.objectEmpty,Q=R.VertexAttrConstants,Y=!1,J=!1,W=!1,K=!1,Z=!1,$=[1,1,1,1],ee=A.ModelContentType,te=[.8,.8,.8],re=[.5,.5,.5],ne=64,ie=9,ae=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._queryEngine=null,t._controllerCreated=!1,t._definitionExpressionErrors=0,t._maxDefinitionExpressionErrors=20,t._featuresChangedEventScheduled=!1,t._featuresChangedEvent=null,t}return r(t,e),t.prototype.initialize=function(){var e=this;y.checkSceneLayerValid(this.layer),y.checkSceneLayerCompatibleWithView(this.layer,this.view);var t=this.layer.version,r=!g("trident")||t.major>1||1===t.major&&t.minor>3;this.useCompressedTextures=this.view.has("s3tc")&&r,this._enableAtlasMipMaps=this.view.has("standardDerivatives"),this._disableAtlasAnisotropy=this._enableAtlasMipMaps&&!this.view.has("shaderTextureLOD"),this._initGraphicsController(),this.dbg=!1,this.maxGpuMemory=1e3,this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._matId2Meta={},this._texId2Meta={},this._requestedTexImageIds={},this._nodeId2Meta={},this._colorOverride=null;for(var n=new Uint8Array(256),i=0;i<n.length;i++)n[i]=255;this._whiteTexture=new F(n,"white",{width:8,height:8}),this._stage.add(A.ModelContentType.TEXTURE,this._whiteTexture),this._layerEventHandles=[s.init(this.layer,"renderer",function(t){return e._rendererChange(t)}),s.watch(this,"fullOpacity",function(t){return e._opacityChange(t)}),s.init(this.layer,"objectIdFilter",function(){return e._filterChange()}),s.init(this,"_controller.parsedDefinitionExpression",function(){return e._filterChange()}),s.init(this.view,"clippingArea",function(){return e._clippingAreaChanged()})],this._addThisLayerToStage(),this.setVisibility(!this.suspended),this.debugNodeVis=J,this.debugLODVis=!1},t.prototype.destroy=function(){this._stage.remove(A.ModelContentType.TEXTURE,this._whiteTexture.getId()),this._removeThisLayerFromStage();var e=function(e){e.remove()};this._layerEventHandles.forEach(e),this._stage=null,null!=this._controller&&(this._controller.destroy(),this._controller=null),this._matId2Meta=null,this._texId2Meta=null,this._nodeId2Meta=null},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return this._controllerCreated?!(!this._controller||!this._controller.updating):!1},t.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t},t.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},t.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t},t.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},t.prototype.isBundleAlreadyAddedToStage=function(e,t){return this._nodeId2Meta[e.id]&&this._nodeId2Meta[e.id].engineObjectsPerBundle&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle[t]},t.prototype._initGraphicsController=function(){var e=this,t={addBundle:this._addBundle.bind(this),isBundleAlreadyAddedToStage:function(t,r){return e.isBundleAlreadyAddedToStage(t,r)},isOverMemory:function(){return e.isOverMemory()},removeNodeData:function(t){return e._removeNodeDataFromStage(t)},removeFeatures:function(t,r){return e._removeFeatures(t,r)},getAddedFeatures:function(t){return e._getAddedFeatures(t)},getAddedNodeIDs:function(){return e._getAddedNodeIDs()},areAllBundlesLoaded:function(t){return e._areAllBundlesLoaded(t)},wholeNodeSwitchEnabled:!0},r={additionalStartNodeLoadingHandler:function(){return e._startNodeLoading()},additionalCancelNodeLoadingHandler:function(){return e.cancelNodeLoading()},getTexturePrefetchFunctions:function(){return{_calcDesiredTextureLOD:function(t,r){return e._calcDesiredTextureLOD(t,r)},_imageIsPartOfTextureBundle:function(t){return e._imageIsPartOfTextureBundle(t)},_matId2Meta:e._matId2Meta,_texId2Meta:e._texId2Meta,useCompressedTextures:function(){return e.useCompressedTextures}}},_nodeDebugVisualizer:this._nodeDebugVisualizer,setPolygonOffset:function(t,r){return e._setPolygonOffset(t,r?1:0)},traversalOptions:{initDepthFirst:!0,neighborhood:!0,perLevelTraversal:!1,allowPartialOverlaps:!1},getLoadedAttributes:function(t){return e.getLoadedAttributes(t)},setAttributeData:function(t,r,n){return e.setAttributeData(t,r,n)}};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:t,layerViewOptionalFunctions:r}).then(function(t){t.watch("rootNodeVisible",function(){e.notifyChange("suspended")})}).always(function(){e._controllerCreated=!0,e.notifyChange("updating")})},t.prototype.setMaxGpuMemory=function(e){this.maxGpuMemory=e},t.prototype.setVisibility=function(e){if(this._stage&&this._engineLayer){var t=this._engineLayer.getId(),r=this._stage.getViewContent(),n=r.indexOf(t)>=0;if(!!e===n)return;var i=[t];null!=this._nodeDebugVisualizer&&i.push(this._nodeDebugVisualizer.engineLayer.getId()),e?this._stage.addToViewContent(i):this._stage.removeFromViewContent(i)}},t.prototype.getEngineLayer=function(){return this._engineLayer},t.prototype.getStats=function(){var e={nodesInIndex:0,knownFeatures:0,activeMaterials:0};if(!this._controller)return e;for(var t=0,r=Object.keys(this._controller.nodeIndex);t<r.length;t++){var n=r[t];e.nodesInIndex++;var i=this._controller.nodeIndex[n];null!=i.features&&(e.knownFeatures+=i.features.length)}return e.activeMaterials=Object.keys(this._matId2Meta).length,e},t.prototype._addThisLayerToStage=function(){var e=this._stage;this._initTexture=new F(null,"i3sInitTexture"),e.add(ee.TEXTURE,this._initTexture);var t=this.layer.id,r=new w(t,{},t);this._engineLayer=r,e.add(ee.LAYER,r),null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose(),J&&(this._nodeDebugVisualizer=y.makeNodeDebugVisualizer(e,this.view.renderCoordsHelper,t),window._nodeDebugVisualizer=this._nodeDebugVisualizer)},t.prototype._removeThisLayerFromStage=function(){if(this.cancelNodeLoading(),null!=this._engineLayer){var e=this._stage;if(e.remove(ee.TEXTURE,this._initTexture.getId()),null!=this._controller)for(var t in this._controller.nodeIndex)if(this._controller.nodeIndex.hasOwnProperty(t)){var r=this._controller.nodeIndex[t];this._removeNodeDataFromStage(r),delete this._controller.nodeIndex[t]}z(H(this._nodeId2Meta)),z(H(this._matId2Meta)),z(H(this._texId2Meta)),e.remove(ee.LAYER,this._engineLayer.getId()),null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose(),this._nodeDebugVisualizer=void 0,this._matId2Meta={},this._texId2Meta={},this._requestedTexImageIds={},this._nodeId2Meta={},this._engineLayer=void 0,this.gpuMemoryEstimate=0}},t.prototype._startNodeLoading=function(){this._updateAllTextureLOD()},t.prototype.cancelNodeLoading=function(){null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.clear(),this._requestedTexImageIds={}},t.prototype._isAllHidden=function(e){for(var t=this._nodeId2Meta[e.id].engineObjects,r=0;r<t.length;r++)if(!t[r].isAllHidden())return!1;return!0},t.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta[e.id];return t&&1===t.engineObjects.length?S(t.engineObjects[0]).loadedAttributes:void 0},t.prototype.setAttributeData=function(e,t,r){var n=this._nodeId2Meta[e.id];if(n&&1===n.engineObjects.length){var i=n.engineObjects[0],a=S(i);a.loadedAttributes=t,a.attributeData=r,this._setObjectSymbology(i),this._applyFilters(e)}},t.prototype._createUnitTestData=function(e){var t=this.view.navigation.targetCamera,r=[],n={viewParams:{eye:t.eye,center:t.center,up:t.up,viewMatrix:t.viewMatrix,projectionMatrix:t.projectionMatrix,fovX:t.fovX,viewport:t.viewport,perPixelRatio:t.perPixelRatio},visibleObjects:r},i=e.getAll("objects");for(var a in i){var o=i[a];if(o.getParentLayer()===this._engineLayer){var s=S(o),d=s.features,l=s.i3sNode,u=d.map(function(e){return e.id});u.sort();var c={featureIDs:u,nodeId:l};n.visibleObjects.push(c)}}return console.debug(""+n.visibleObjects.length),JSON.stringify(n)},t.prototype.isOverMemory=function(){return this.gpuMemoryEstimate>this.maxGpuMemory?(U.warn("over memory: "+this.gpuMemoryEstimate+" tex "+this.texMemoryEstimate+" geom "+this.geoMemoryEstimate),!0):!1},t.prototype._getAddedFeatures=function(e){var t=this._nodeId2Meta[e];if(null==t)return null;for(var r=[],n=this._nodeId2Meta[e].engineObjects,i=0;i<n.length;i++){var a=n[i];r=r.concat(S(a).features)}return r},t.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodeId2Meta)},t.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){var n=this.fullOpacity,i=1-q(X(t.transparency,0),0,1),a=n*i,o=1>a||e&&u.endsWith(e.channels,"a")||t.useVertexColorAlpha===!0||r;return{opacity:a,transparent:o}},t.prototype._calcEngineMaterialDoubleSidedParams=function(e){return null!=e.doubleSided?e.doubleSided:!0},t.prototype._calcEngineMaterialCullFaceParams=function(e){return e.cullFace?e.cullFace:null!=e.doubleSided?e.doubleSided?"none":"back":"none"},t.prototype._createEngineMaterial=function(e,t,r,n,i,o){var s,d;null!=e&&(d=this._texId2Meta[t],s=d&&d.engineTex?d.engineTex.getId():this._initTexture.getId());var l,u,h=r.params,g=X(h.diffuse,te);null!=e&&(u=y.getAppropriateTextureEncoding(e.encoding,this.useCompressedTextures),l=u>-1?e.encoding[u]:e.encoding),"standard"!==r.type&&U.warn("Unknown material type '"+r.type+"', must be 'standard'"),void 0===h.reflectivity&&U.warn("Material parameter 'reflectivity' is missing.");var f=this.layer instanceof a,p={ambient:this._colorOverride||g,diffuse:this._colorOverride||g,specular:X(h.specular,re),shininess:X(h.shininess,ne),atlasRegions:h.vertexRegions,textureId:s&&this._colorOverride?this._whiteTexture.getId():s,vertexColors:!0,flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(h),cullFace:this._calcEngineMaterialCullFaceParams(h),writeStencil:f,receiveSSAO:!f};if(!f){var m=this._calcEngineMaterialTransparencyParams(e,h);c.mixin(p,m)}var _=new j(p,n);if(_.metadata={i3sMatId:n,i3sTexId:t,i3sTex:e,i3sMatParams:h},null!=e){d?d.usedByEngineMats.push(_):(d={id:t,featureMBS:[],usedByEngineMats:[_],images:e.images,encoding:l,encodingIdx:u,atlas:e.atlas===!0,wrap:"none"!==e.wrap[0]||"none"!==e.wrap[1]},this._texId2Meta[t]=d);for(var v=0;v<i.length;v++){var b=i[v];d.featureMBS.push(b.engineMBS)}if(void 0!==o[t]){if(null==d.engineTex){var I=o[t],x=I.data,M=P(x,d,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);d.engineTex=new F(x,d.id,M),this._stage.add(ee.TEXTURE,d.engineTex),d.desiredLOD=o[t].desiredLOD,d.curLOD=d.desiredLOD,this.memEstimateTextureAdded(d.engineTex)}for(var O=d.engineTex.getId(),E=0;E<d.usedByEngineMats.length;E++){var T=d.usedByEngineMats[E];null==this._colorOverride&&T.setParameterValues({textureId:O}),T.metadata.originalTextureId=O}o[t].createdTextureForDomImage(),delete o[t]}else this._updateTextureLOD(d)}return this._matId2Meta[n]||(this._matId2Meta[n]={}),this._matId2Meta[n][t]={engineMat:_,refCount:1},W&&console.debug("new mat "+_.getId()),_},t.prototype._createVertexArrays=function(e,t){var r,n=!0,i=e.params.vertexAttributes,a={};for(var o in i)if(i.hasOwnProperty(o)){if("classification"===o)continue;var s=i[o];r=v.valueType2TypedArrayClassMap[s.valueType],z(null!=r,"unsupported vertex attribute value type: "+s.valueType),a[o]={data:new r(t,s.byteOffset,s.count*s.valuesPerElement),size:s.valuesPerElement}}if(n&&null==a[Q.COLOR]){r=v.valueType2TypedArrayClassMap.UInt8,a[Q.COLOR]={data:new r(4*i.position.count),size:4};for(var d=0;d<a[Q.COLOR].data.length;d++)a[Q.COLOR].data[d]=d%3===0?255:0}var l=!1;return null==a[Q.NORMAL]&&(l=!0,r=v.valueType2TypedArrayClassMap.Float32,a[Q.NORMAL]={data:new r(3*i.position.count),size:3}),a},t.prototype._createEngineMats=function(e,t,r,n,i){for(var a=e.params.components.length,o=new Array(a),s=0;a>s;s++){var d=e.params.components[s],l=d.materialID,u=r.materialDefinitions[l];null!=u.href&&(u=n[u.hrefConcat].materialDefinitions[l]),z(void 0!==u,"geometry wants unknown material "+l);var c=d.textureID||"none",h=void 0;"none"!==c&&((null==r.textureDefinitions||null==r.textureDefinitions[c])&&U.warn("textureDefinitions missing in shared resource"),h=r.textureDefinitions[c]);var g=void 0;if(this._matId2Meta[l]&&this._matId2Meta[l][c]){var f=this._matId2Meta[l][c];g=f.engineMat,f.refCount++,W&&console.debug("reused mat "+g.getId()+", increased refcount "+f.refCount)}else g=this._createEngineMaterial(h,c,u,l,t,i);o[s]=g}return o},t.prototype._areAllBundlesLoaded=function(e){if(null==this._nodeId2Meta[e.id]||null==this._nodeId2Meta[e.id].engineObjectsPerBundle)return!1;for(var t=0;t<e.featureData.length;t++)if(null==this._nodeId2Meta[e.id].engineObjectsPerBundle[t])return!1;return!0},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._findGraphicNodeAndIndex=function(e){for(var t=G(e.attributes,this._getObjectIdField()),r=0,n=Object.keys(this._nodeId2Meta);r<n.length;r++)for(var i=n[r],a=this._nodeId2Meta[i].engineObjects,o=0;o<a.length;o++){var s=a[o],d=S(s),l=d.featureIds.indexOf(t);if(-1!==l)return{node:this._controller.nodeIndex[i],nodeId:i,bundleNr:o,index:l}}return null},t.prototype._getGraphicIndices=function(e,t,r){var n=this._nodeId2Meta[e.id].engineObjects;if(!n||!n[t])return[];for(var i=S(n[t]),a=[],o=this._getObjectIdField(),s=0,d=r;s<d.length;s++){var l=d[s],u=G(l.attributes,o),c=i.featureIds.indexOf(u);-1!==c&&a.push(c)}return a},t.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(null!=t){var r=this._nodeId2Meta[t.nodeId].engineObjects[t.bundleNr],n=S(r),i=n.faceRanges[t.index],a=new Float64Array(24);if(this._boundingBoxCornerPoints(i,r,a),E.bufferToBuffer(a,this.view.renderSpatialReference,0,a,this.view.spatialReference,0,8)){var o=T.create(T.NEGATIVE_INFINITY);return T.expandBuffer(o,a,0,8),d.resolve(o)}}return d.reject()},t.prototype.whenGraphicAttributes=function(e,t){var r=this,n=function(){var t=r._findGraphicNodeAndIndex(e);return{node:t.node,indices:[t.index]}};return y.whenGraphicAttributes(this.layer,[e],this._getObjectIdField(),t,n).then(function(e){return e[0]})},t.prototype.getGraphicsFromStageObject=function(e,t){if(this.layer instanceof a)return d.reject();var r=S(e),n=e.getFaceRangeIndexFromTriangleNr(t);if(null!=n&&null!=r.featureIds&&n<r.featureIds.length){var i=this._createGraphic(n,r);return d.resolve(i)}return d.reject()},t.prototype._addBundle=function(e,t,r,n,i,a,o){if(this.debugNodeVis===!0&&null!=this._nodeDebugVisualizer){var s="grey";switch(e.level){case 1:s="red";break;case 2:s="green";break;case 3:s="blue";break;case 4:s="yellow";break;case 5:s="magenta";break;case 6:s="brown"}this._nodeDebugVisualizer.show(e,this._controller.crsIndex,s)}var d=this._stage,l={};l[ee.OBJECT]={},l[ee.GEOMETRY]={},l[ee.MATERIAL]={},l[ee.TEXTURE]={};var u=this._engineLayer,c=u.getId(),h=n[e.sharedResource.hrefConcat];if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle&&this._nodeId2Meta[e.id].engineObjectsPerBundle[o])return this._applyFilters(e),void(null!=i&&i.done());if(!this.isOverMemory()){if(null==this._nodeId2Meta[e.id]&&(this._nodeId2Meta[e.id]={engineObjects:[],engineObjectsPerBundle:[]}),this._nodeId2Meta[e.id].engineObjectsPerBundle[o]=[],Z&&null==this.allUnitTestData&&(this.allUnitTestData={}),null==t)return void(null!=i&&i.done());for(var g=0,f=0;f<t.length;f++){var p=t[f],m=p.faceRanges,_=p.componentOffsets,v=p.geometries,I=p.featureIds,x=p.features,M=n[e.geometryData[o].hrefConcat];z(M instanceof ArrayBuffer,"I3S: geometry data is not an ArrayBuffer"),null==M._isReprojected&&(M._isReprojected={});for(var O=e.id+"|"+x[0].id.toString(),E=[],T=[],A=[],w=void 0,F=function(t){var r=v[t];W&&console.debug("adding geometry "+t);var i=j._createVertexArrays(r,M),o=new C(i,C.DefaultIndices,_||C.DefaultOffsets),s=j._createEngineMats(r,x,h,n,a),d=void 0;Z&&(d={},d.inputPositions=B.encode(new Uint8Array(i.position.data.buffer)));var u=M._isReprojected[r.id],c=j._controller.crsIndex,g=j.view.renderSpatialReference,f=j._controller.isMeshPyramid?b.ReprojectionTypes.PER_VERTEX:b.ReprojectionTypes.BOUNDINGBOX;if(w=b.reprojectPoints(f,i.position.data,e.mbs,u,c,j._controller.crsVertex,g),M._isReprojected[r.id]=!0,j._controller.isMeshPyramid){var p={normals:o.vertexAttributes.normal.data,positions:o.vertexAttributes.position.data,normalInd:o.indices.normal,positionInd:o.indices.position},m=j.layer.normalReferenceFrame||"none",I=function(t,r){var n=e.mbs;b.reprojectNormalsPerVertex(t,n,c,r,g)};y.processNormals(p,m,I)}Z&&(d.perVertexReprojectedPositions=B.encode(new Uint8Array(i.position.data.buffer)),d.matrices=w,d.mbs=e.mbs,d.crsIndex=j._controller.crsIndex,d.crsVertex=j._controller.crsVertex,d.crsEngine=j.view.renderSpatialReference);var L=w.localTrafo;null!=r.transformation&&(L=V.mat4d.create(r.transformation),V.mat4d.multiply(w.localTrafo,L,L));for(var F=0;F<s.length;F++){var R=s[F];l[ee.MATERIAL][R.getId()]=R}var S=new D(o,O+"_"+t);j.memEstimateGeometryAdded(S.getData()),l[ee.GEOMETRY][S.getId()]=S,E[t]=S,T[t]=L,A[t]=s,Z&&(j.allUnitTestData[S.getId()]=d)},j=this,R=0;R<v.length;++R)F(R);var P={i3sNode:e.id,ceLayer:c,features:x,faceRanges:m,featureIds:I,attributeData:r?r.attributeData:null,loadedAttributes:r?r.loadedAttributes:null,layerId:this.layer.id};g+=N(P);var G=new L({idHint:e.id,name:O,geometries:E,materials:A,transformations:T,castShadow:!0,metadata:P}),U=V.mat4d.create();V.mat4d.identity(U),V.mat4d.multiply(U,w.globalTrafo,U),G.setObjectTransformation(U),this._nodeId2Meta[e.id].engineObjectsPerBundle[o].push(G),this._nodeId2Meta[e.id].engineObjects.push(G),l[ee.OBJECT][G.getId()]=G,this._setObjectSymbology(G),this._applyFilters(e)}if(K){for(var x="",q=this._nodeId2Meta[e.id].engineObjectsPerBundle[o],k=0;k<q.length;k++)for(var X=S(q[k]).features,H=0;H<X.length;H++)x+="f "+X[H].id+" rf "+X[H].rootFeature+", ";console.debug("_addNodeDataToStage node "+e.id+" bundle "+o+" features "+x)}if(Y){var Q=function(e){return Object.keys(e).length};console.log("objs: "+Q(l[ee.OBJECT])+" geoms: "+Q(l[ee.GEOMETRY])+" mats: "+Q(l[ee.MATERIAL])+" texts: "+Q(l[ee.TEXTURE]))}d.beginMod();var J=l[ee.OBJECT];for(var $ in J)J.hasOwnProperty($)&&u.addObject(J[$]);for(var te in l)if(l.hasOwnProperty(te)){var re=l[te];for(var ne in re)if(re.hasOwnProperty(ne)){if(null!=d.get(te,ne))continue;d.add(te,re[ne])}}d.endMod(),null!=i&&i.done(),this._notifyFeaturesChanged(g,0)}},t.prototype._clippingAreaChanged=function(){var e=this,t=[];if(E.extentToBoundingBox(this.view.clippingArea,t,this.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null,this._updateFilters(),this._controller){var r=this._controller.nodeIndex;r&&Object.keys(this._nodeId2Meta).forEach(function(t){return e._applyFilters(r[t])}),this._controller.updateClippingArea(this.view.clippingArea)}},t.prototype._filterChange=function(){if(this._updateFilters(),this._controller){var e=this._controller.nodeIndex;if(e)for(var t=0,r=Object.keys(this._nodeId2Meta);t<r.length;t++){var n=r[t];this._applyFilters(e[n])}}},t.prototype._updateFilters=function(){var e=this,t=[];if(this.layer.objectIdFilter){var r=new Float64Array(this.layer.objectIdFilter.ids),n="include"===this.layer.objectIdFilter.method;r.sort(),t.push(function(t,i){return e._objectIdFilter(r,n,i)})}if(this._controller&&this._controller.parsedDefinitionExpression&&this._controller.definitionExpressionFields){this._definitionExpressionErrors=0;var i=this._controller.parsedDefinitionExpression,a=this._controller.definitionExpressionFields;t.push(function(t,r){return e._sqlFilter(t,i,a,r)})}this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,e._clippingArea,r)}),this._filters=t},t.prototype._sqlFilter=function(e,t,r,n){var i={},a=new p(null,null,i);a.layer=this.layer;for(var o=0,s=0,d=function(e){for(var d=S(e),u=d.featureIds,c=d.attributeData,h=r.every(function(e){return null!=c[e]}),g=0;g<u.length&&o<n.length;g++)if(n[o]===u[g]){var f=!0;if(h){for(var p=0,m=r;p<m.length;p++){var _=m[p];i[_]=y.getCachedAttributeValue(c[_],g)}f=l._evaluateClause(t,a)}f&&(n[s]=n[o],s++),o++}},l=this,u=0,c=this._nodeId2Meta[e.id].engineObjects;u<c.length;u++){var h=c[u];d(h)}n.length=s},t.prototype._evaluateClause=function(e,t){try{return!!e.calculateValue(t)}catch(r){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&U.error("Error while evaluating definitionExpression: "+r),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&U.error("Further errors are ignored"),!1}},t.prototype._objectIdFilter=function(e,t,r){for(var n=0,i=0;n<r.length;){var a=o.binaryIndexOf(e,r[n])>=0;a===t&&(r[i]=r[n],i++),n++}r.length=i},t.prototype._boundingboxFilter=function(e,t,r){var n=[0,0,0,0];E.mbsToMbs(e.mbs,this._controller.crsIndex,n,this.view.renderSpatialReference);var i=null!=t?y.intersectBoundingBoxWithMbs(t,n):2;if(2!==i)for(var a=0,o=0,s=this._nodeId2Meta[e.id].engineObjects;o<s.length;o++){var d=s[o],l=S(d).featureIds;if(0!==i){var u=d.getObjectTransformation(),c=d.getGeometryRecords()[0].getShaderTransformation();if(V.mat4d.multiply(u,c),0===u[1]&&0===u[2]&&0===u[3]&&0===u[4]&&0===u[6]&&0===u[7]&&0===u[8]&&0===u[9]&&0===u[11]&&1===u[15])for(var h=(t[0]-u[12])/u[0],g=(t[1]-u[13])/u[5],f=(t[2]-u[14])/u[10],p=(t[3]-u[12])/u[0],m=(t[4]-u[13])/u[5],_=(t[5]-u[14])/u[10],v=d.getGeometryRecords()[0].geometry.getData(),b=v.getFaces()[0].indices.position,I=v.getVertexAttr().position.data,x=S(d).faceRanges,M=void 0,O=void 0,T=void 0,A=void 0,w=void 0,D=void 0,C=0;C<x.length&&a<r.length;C+=1)if(r[a]===l[C]){var L=x[C],F=L[0],j=L[1];M=O=T=Number.MAX_VALUE,A=w=D=-Number.MAX_VALUE;for(var R=F;j>=R;R+=1)for(var B=0;3>B;B+=1){var P=3*b[3*R+B],N=I[P],G=I[P+1],U=I[P+2];M=Math.min(N,M),O=Math.min(G,O),T=Math.min(U,T),A=Math.max(N,A),w=Math.max(G,w),D=Math.max(U,D)}var z=M>p||h>A||O>m||g>w||T>_||f>D;z?r.splice(a,1):a++}}else{for(var q=0,C=0;C<l.length&&a+q<r.length;C+=1)r[a+q]===l[C]&&q++;r.splice(a,q)}}},t.prototype._applyFilters=function(e){if(this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjects){for(var t=this._nodeId2Meta[e.id].engineObjects,r=0,n=t;r<n.length;r++){var i=n[r];i.unhideAllComponents()}if(0!==this._filters.length){for(var a=[],o=0,s=t;o<s.length;o++){var i=s[o];a=a.concat(S(i).featureIds)}for(var d=a.length,l=0;l<this._filters.length;l++)this._filters[l](e,a);if(a.length!==d)for(var u=0,c=0,h=t;c<h.length;c++)for(var i=h[c],g=i.getGeometryRecords()[0],f=S(i).featureIds,p=0;p<f.length;p+=1){var m=f[p];u>=a.length||a[u]!==m?i.setComponentVisibility(g,p,!1):u++}}}},t.prototype._hideFeatures=function(e,t){for(var r=0,n=this._nodeId2Meta[e.id].engineObjects;r<n.length;r++)for(var i=n[r],a=i.getGeometryRecords()[0],o=S(i).features,s=i.hasComponents(),d=0,l=t;d<l.length;d++)for(var u=l[d],c=0;c<o.length;c++)u===o[c].id&&(s?i.setComponentVisibility(a,c,!1):i.hideAllComponents())},t.prototype._removeFeatures=function(e,t){null!=this._nodeId2Meta[e.id]&&(this._hideFeatures(e,t),this._isAllHidden(e)===!0&&(K&&console.debug("all hidden for node "+e.id+". removing."),this._removeNodeDataFromStage(e)))},t.prototype._removeNodeDataFromStage=function(e){if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjects){for(var t=this._stage,r=this._engineLayer,n=0,i=this._nodeId2Meta[e.id].engineObjects,a=0;a<i.length;++a){var o=i[a];n+=N(S(o)),r.removeObject(o);for(var s=o.getGeometryRecords(),d=0;d<s.length;d++){var l=s[d];this.memEstimateGeometryRemoved(l.geometry.getData()),t.remove(ee.GEOMETRY,l.geometry.getId());for(var u=0;u<l.materials.length;u++){var c=l.materials[u],h=c.getId(),g=c.metadata.i3sMatId,f=c.metadata.i3sTexId||"none",p=this._matId2Meta[g][f];z(p.refCount>0),p.refCount--,W&&console.debug("decreased refcount material "+h+" "+("geometry "+d+", count "+p.refCount)),0===p.refCount&&this._removeMaterial(h,f,g,c,t)}}t.remove(ee.OBJECT,o.getId())}delete this._nodeId2Meta[e.id],this._notifyFeaturesChanged(0,n)}},t.prototype._emitFeaturesChangedEvent=function(){this.emit("features-changed",this._featuresChangedEvent),this._featuresChangedEvent=null,this._featuresChangedEventScheduled=!1},t.prototype._cancelFeaturesChangedEvent=function(){this._featuresChangedEventScheduled=!1},t.prototype._notifyFeaturesChanged=function(e,t){var r=this;null==this._featuresChangedEvent&&(this._featuresChangedEvent={addedCount:0,removedCount:0}),this._featuresChangedEvent.addedCount+=e,this._featuresChangedEvent.removedCount+=t,this._featuresChangedEventScheduled||null==this._controller||(this._featuresChangedEventScheduled=!0,this._controller.queueAnimationFrameFunctionCall(function(){return r._emitFeaturesChangedEvent()},null,null,function(){return r._cancelFeaturesChangedEvent()},null))},t.prototype._removeMaterial=function(e,t,r,n,i){if(i.remove(ee.MATERIAL,e),"none"!==t){var a=this._texId2Meta[t],o=a.usedByEngineMats,s=o.indexOf(n);if(z(s>-1),o[s]=o[o.length-1],o.pop(),o.length<1){var d=a.engineTex;d&&d!==this._initTexture&&(this.memEstimateTextureRemoved(d),i.remove(ee.TEXTURE,a.engineTex.getId())),a.engineTex=void 0,a.desiredLOD=-1,a.curLOD=-1,delete this._texId2Meta[t]}}delete this._matId2Meta[r][t],H(this._matId2Meta[r])&&delete this._matId2Meta[r]},t.prototype._updateAllTextureLOD=function(){for(var e in this._texId2Meta)if(this._texId2Meta.hasOwnProperty(e)){var t=this._texId2Meta[e];this._updateTextureLOD(t)}},t.prototype._calcDesiredTextureLOD=function(e,t){for(var r,n=0,i=0,a=e;i<a.length;i++){var o=a[i],s=V.vec3.dist(o,this._controller.camPos),d=2*o[3],l=d/s*this._controller.screenSizeFactor;l>n&&(n=l)}for(n/=ie,r=t.length-1;r>0&&t[r].size<n;)r--;return r},t.prototype._updateTextureLOD=function(e){var t=this;e.desiredLOD=this._calcDesiredTextureLOD(e.featureMBS,e.images);var r=e.curLOD!==e.desiredLOD&&(e.curLOD<0||!e.curLOD||0===e.desiredLOD||e.desiredLOD>e.curLOD||e.desiredLOD<e.curLOD-1);if(r){if(0===e.images.length)return;var n=e.images[e.desiredLOD],i=e.encodingIdx>-1?n.hrefConcat[e.encodingIdx]:n.hrefConcat;if(!this._requestedTexImageIds[n.id]){var a={metadata:{texMeta:e,image:n}};this._requestedTexImageIds[n.id]=!0,this._imageIsPartOfTextureBundle(n)?this._controller.streamDataSupplier.request(i,"binary",a).then(this._extractTextureImageFromBlob.bind(this)):this._controller.streamDataSupplier.request(i,"image",a).then(function(e,r,n,i){t._textureImageLoaded(e,r,i.image,i.texMeta)})}}if(e.engineTex||(e.engineTex=this._initTexture,e.curLOD=-1),this.debugLODVis)for(var o=h.fromHsv(e.desiredLOD/e.images.length*270,100,100).toRgb().map(function(e){return e/255}),s=0;s<e.usedByEngineMats.length;s++){var d=e.usedByEngineMats[s],l={ambient:o,diffuse:o};d.setParameterValues(l)}},t.prototype._extractTextureImageFromBlob=function(e,t,r,n){var i=n.texMeta;if(i.desiredLOD<0||n.image.size>i.images[i.desiredLOD].size)return void delete this._requestedTexImageIds[n.image.id];var a=this;z("binary"===r);var o="";try{var s=0,d=0;i.encodingIdx>-1?(s=n.image.byteOffset[i.encodingIdx],d=n.image.length[i.encodingIdx]):(s=n.image.byteOffset,d=n.image.length);var l=new Uint8Array(t,s,d),u=new Blob([l],{type:i.encoding});o=window.URL.createObjectURL(u)}catch(c){o="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4T2P8zyD6n4ECwDhqAMNoGDCMhgEwDw2DdAAAdzkhQdS8dl8AAAAASUVORK5CYII=",U.error("error loading texture "+e+" "+c)}var h=new Image;h.onerror=function(){window.URL.revokeObjectURL(o),h.src="",h.onerror=void 0,h.onload=void 0},h.onload=function(){a._controller.queueAnimationFrameFunctionCall(a._textureImageLoaded,a,[e,h,n.image,n.texMeta,o],void 0,1),window.URL.revokeObjectURL(o),h.src="",h.onerror=void 0,h.onload=void 0},h.src=o},t.prototype._textureImageLoaded=function(e,t,r,n){if(delete this._requestedTexImageIds[r.id],!(n.desiredLOD<0)){var i=n.images[n.desiredLOD],a=n.images[n.curLOD];if((!this.isOverMemory()||!(null==a||r.size>a.size))&&(!a||r.size>a.size&&r.size<=i.size||r.size<a.size&&r.size>=i.size)){var o=n.engineTex;o&&o!==this._initTexture&&(this.memEstimateTextureRemoved(o),this._stage.remove(ee.TEXTURE,n.engineTex.getId()));var s=P(t,n,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);n.engineTex=new F(t,n.id,s),this._stage.add(ee.TEXTURE,n.engineTex),n.curLOD=n.desiredLOD,this.memEstimateTextureAdded(n.engineTex);for(var d=n.engineTex.getId(),l=0;l<n.usedByEngineMats.length;l++){var u=n.usedByEngineMats[l];null==this._colorOverride&&u.setParameterValues({textureId:d}),u.metadata.originalTextureId=d}if(r!==i&&(n.curLOD=n.images.indexOf(r),z(n.curLOD>-1),!this._requestedTexImageIds[i.id])){var c={metadata:{texMeta:n,image:i}};this._requestedTexImageIds[i.id]=!0,this._controller.streamDataSupplier.request(i.hrefConcat,"binary",c).then(this._extractTextureImageFromBlob.bind(this))}}}},t.prototype._imageIsPartOfTextureBundle=function(e){return!this._controller.isMeshPyramid},t.prototype._setPolygonOffset=function(e,t){if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle)for(var r={polygonOffset:t},n=0;n<this._nodeId2Meta[e.id].engineObjectsPerBundle.length;n++)for(var i=this._nodeId2Meta[e.id].engineObjectsPerBundle[n],a=0;a<i.length;a++)for(var o=i[a].getGeometryRecords(),s=0;s<o.length;s++)for(var d=o[s].materials,l=0;l<d.length;l++)d[l].setParameterValues(r)},t.prototype._rendererChange=function(e){this._currentRenderer=e,e&&(e.colorInfo||e.sizeInfo)&&U.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead.")},t.prototype._getRenderingInfo=function(e){var t=this._currentRenderer,r=t&&t.getSymbol(e);if(!(r&&r instanceof m))return null;var n,i,a={symbol:r};if(t&&t.visualVariables)for(var o=t.getVisualVariableValues(e),s=0;s<o.length;s++){var d=o[s],l=d.variable.type;"color"===l?n=d.value:"opacity"===l&&(i=d.value)}return n&&(a.color=[n.r/255,n.g/255,n.b/255]),null!=i?a.opacity=i:n&&null!=n.a&&(a.opacity=n.a),a},t.prototype._getSymbolFillColor=function(e){for(var t=e.symbolLayers,r=0;r<t.length;r++){var n=t.getItemAt(r);if("Fill"===n.type&&n.material&&n.material.color){var i=n.material.color;return[i.r/255,i.g/255,i.b/255,i.a];
}}},t.prototype._setObjectSymbology=function(e){if(!(this.layer instanceof a)){for(var t=S(e),r=[],n=!1,i=t.faceRanges?t.faceRanges.length:1,o={attributes:{}},s=this.layer.objectIdField,d=this._currentRenderer&&this._currentRenderer.requiredFields,l=0;i>l;l++){if(null!=s&&null!=t.featureIds&&(o.attributes[s]=t.featureIds[l]),null!=d&&null!=t.attributeData)for(var u=0,c=d;u<c.length;u++){var h=c[u];t.attributeData[h]&&(o.attributes[h]=y.getCachedAttributeValue(t.attributeData[h],l))}var g=this._getRenderingInfo(o),f=null!=t.faceRanges?t.faceRanges[l]:null;if(g){var p=g.color,m=g.opacity;if(null==p||null==m){var _=this._getSymbolFillColor(g.symbol);p=x.overrideColor(p,m,_,_&&_[3],$)}else p=x.overrideColor(p,m,null,null,$);p[3]<1&&(n=!0),r.push({faceRanges:f,color:p})}else r.push({faceRanges:f,color:void 0})}this.layer.cachedDrawingInfo.color?e.setFacerangeColors(r,"replace"):e.setFacerangeColors(r,"blend");for(var v=e.getGeometryRecords(),b=0;b<v.length;b++)for(var I=v[b],M=0;M<I.materials.length;M++){var O=I.materials[M],E=O.getParams().transparent,T=O.getParams().opacity;O.metadata.symbolIsTransparent=n;var A=this._calcEngineMaterialTransparencyParams(O.metadata.i3sTex,O.metadata.i3sMatParams,O.metadata.symbolIsTransparent);(E!==A.transparent||T!==A.opacity)&&O.setParameterValues({transparent:A.transparent,opacity:A.opacity})}}},t.prototype._opacityChange=function(e){for(var t in this._matId2Meta)for(var r in this._matId2Meta[t]){var n=this._matId2Meta[t][r].engineMat,i=n.getParams().transparent,a=n.getParams().opacity,o=this._calcEngineMaterialTransparencyParams(n.metadata.i3sTex,n.metadata.i3sMatParams,n.metadata.symbolIsTransparent);(i!==o.transparent||a!==o.opacity)&&n.setParameterValues({transparent:o.transparent,opacity:o.opacity})}},t.prototype.queryExtent=function(e){return this._ensureQueryEngine().queryExtent(e)},t.prototype.queryFeatureCount=function(e){return this._ensureQueryEngine().queryFeatureCount(e)},t.prototype.queryFeatures=function(e){return this._ensureQueryEngine().queryFeatures(e)},t.prototype.queryObjectIds=function(e){return this._ensureQueryEngine().queryObjectIds(e)},t.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},t.prototype._createQueryEngine=function(){var e=this,t={id:0,index:0,object:null,bbCorners:new Float64Array(24)};return new I({forAll:function(r,n){var i=function(n,i,a){t.id=n,t.index=i,t.object=a;var o=S(t.object),s=o.faceRanges[t.index];e._boundingBoxCornerPoints(s,t.object,t.bbCorners),r(t)};e._forAllFeatures(i,n)},createGraphic:function(t){return e._createGraphic(t.index,S(t.object))},requestFields:function(t,r,n){var i=function(){var n=e._getGraphicIndices(t.node,t.bundleNr,r);return{node:t.node,indices:n}};return y.whenGraphicAttributes(e.layer,r,e._getObjectIdField(),n,i)},createExtentBuilder:function(){return e._createExtentBuilder()},createVisibilityFilter:function(){return e._createVisibilityFilter()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField,addVisibilityFilter:!0})},t.prototype._createExtentBuilder=function(){var e=this.view.renderSpatialReference,t=this.view.spatialReference,r=T.create(T.NEGATIVE_INFINITY),n=new Float64Array(24);return{add:function(i){E.bufferToBuffer(i.bbCorners,e,0,n,t,0,8)&&T.expandBuffer(r,n,0,8)},getExtent:function(){return new _({xmin:r[0],ymin:r[1],zmin:r[2],xmax:r[3],ymax:r[4],zmax:r[5],spatialReference:t})}}},t.prototype._createVisibilityFilter=function(){var e=this.view._stage.getCamera().frustumPlanes,t=0;return function(r){var n=O.conservativeFrustumConvexBuffer(e,r.bbCorners,0,8,t);return n>=0?(t=n,!1):!0}},t.prototype._forAllFeatures=function(e,t){for(var r=0,n=Object.keys(this._nodeId2Meta);r<n.length;r++)for(var i=n[r],a=this._nodeId2Meta[i].engineObjects,o=0;o<a.length;o++){for(var s=a[o],d=S(s).featureIds,l=s.getGeometryRecords()[0],u=0;u<d.length;u++)if(s.getComponentVisibility(l,u)){var c=d[u];e(c,u,s)}t&&t({node:this._controller.nodeIndex[i],bundleNr:o})}},t.prototype._createGraphic=function(e,t){var r={};r[this._getObjectIdField()]=t.featureIds[e];for(var n=0,i=Object.keys(t.attributeData);n<i.length;n++){var a=i[n];r[a]=y.getCachedAttributeValue(t.attributeData[a],e)}var o=new p(null,null,r);return o.layer=this.layer,o},t.prototype._boundingBoxCornerPoints=function(e,t,r){for(var n=t.geometries[0].calculateAABB(0,e),i=0;8>i;++i){var a=[1&i?n[0]:n[3],2&i?n[1]:n[4],4&i?n[2]:n[5]];V.mat4d.multiplyVec3(t.objectTransformation,a),r[3*i]=a[0],r[3*i+1]=a[1],r[3*i+2]=a[2]}return r},t}(i.declared(f,M));return n([i.property()],ae.prototype,"layer",void 0),n([i.property()],ae.prototype,"view",void 0),n([i.property()],ae.prototype,"_controller",void 0),n([i.property({dependsOn:["_controller.updating"]})],ae.prototype,"updating",void 0),n([i.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],ae.prototype,"updatingPercentageValue",void 0),ae=n([i.subclass("esri.views.3d.layers.SceneLayerView3D")],ae)});