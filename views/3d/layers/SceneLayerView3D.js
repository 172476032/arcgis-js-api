// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","dojo/has","dojo/_base/lang","dojo/errors/CancelError","../../../Graphic","../../../core/arrayUtils","../../../core/Collection","../../../core/lang","../../../core/Logger","../../../core/promiseUtils","../../../core/requireUtils","../../../core/scheduling","../../../core/watchUtils","../../../core/workers","../../../core/accessorSupport/decorators","../../../geometry/support/scaleUtils","../../../layers/IntegratedMeshLayer","../../../renderers/support/diffUtils","../../../symbols/FillSymbol3DLayer","../../../symbols/Symbol3D","../../../symbols/support/unitConversionUtils","../../../tasks/support/Query","./LayerView3D","./SceneLayerWorker","./graphics/graphicUtils","./i3s/Highlights","./i3s/I3SElevationProvider","./i3s/I3SGeometryUtil","./i3s/I3SQueryEngine","./i3s/I3SUtil","./i3s/IDBCache","./support/attributeUtils","./support/edgeUtils","./support/LayerViewUpdatingPercentage","../lib/glMatrix","../support/aaBoundingBox","../support/orientedBoundingBox","../support/projectionUtils","../webgl-engine/Stage","../webgl-engine/lib/Geometry","../webgl-engine/lib/Layer","../webgl-engine/lib/Object3D","../webgl-engine/lib/PreinterleavedGeometryData","../webgl-engine/lib/Texture","../webgl-engine/lib/Util","../webgl-engine/lib/TextureBackedBuffer/BufferManager","../webgl-engine/materials/DefaultMaterial","module"],function(e,t,r,n,i,a,o,s,l,d,u,c,h,p,f,g,y,m,_,v,b,x,I,M,E,C,w,O,T,D,S,A,j,F,B,V,G,R,P,L,N,U,k,q,H,K,z,Q,J,X,Y){function W(e,t,r,n,i){var a,o=!1;t.encoding===j.DDS_ENCODING_STRING?a=z.DDS_ENCODING:o=!(Q.isPowerOfTwo(e.width)&&Q.isPowerOfTwo(e.height));var s=t.usedByEngineMats.some(function(e){return e.getParams().atlasRegions}),l=s||t.atlas,d=(l?n:r)&&!o;return{mipmap:d,wrapClamp:l||!t.wrap,disableAnisotropy:l&&d&&i,encoding:a,noUnpackFlip:!0}}function Z(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];if(i.i3sTexId===t)return i.data}return null}function $(e){return e.data instanceof ArrayBuffer}function ee(e,t){for(var r=1024,n=0,i=e;n<i.length;n++){var a=i[n];r+=a.interleavedVertexData.byteLength+(a.indices?a.indices.byteLength:0)}for(var o=0,s=t;o<s.length;o++){var l=s[o];l.data instanceof ArrayBuffer&&(r+=l.data.byteLength)}return r}var te=U.ModelContentType,re=c.getLogger("esri.views.3d.layers.SceneLayerView3D"),ne=[1,1,1,1],ie=[.8,.8,.8],ae=[.5,.5,.5],oe=8,se=function(t){function c(){var e=null!==t&&t.apply(this,arguments)||this;return e._queryEngine=null,e._highlights=new T(e),e._elevationProvider=null,e._worker=new w,e._workerThread=null,e._controllerCreated=!1,e._idbCache=new F.IDBCache("esri-scenelayer-cache","geometries",oe),e._cancelCount=0,e._hasColors=!1,e._hasTextures=!1,e._hasData=!1,e.alwaysLoadEverythingModeEnabled=!1,e._cacheKeySuffix=null,e._definitionExpressionErrors=0,e._maxDefinitionExpressionErrors=20,e}return r(c,t),Object.defineProperty(c.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"rendererNeedsTextures",{get:function(){return j.rendererNeedsTextures(this.layer.renderer)},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"elevationOffset",{get:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=_.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=M.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this._useCompressedTextures},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"_useCompressedTextures",{get:function(){var e=this.layer.version,t=!i("trident")||e.major>1||1===e.major&&e.minor>3;return this.view._stage.has("s3tc")&&t},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps&&this.view._stage.has("standardDerivatives")},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"_atlasBiasCompensationEnabled",{get:function(){return!this.view._stage.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(c.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0}),c.prototype.initialize=function(){var t=this;y.open(p.getAbsMid("./SceneLayerWorker",e,Y),{client:this}).then(function(e){t.destroyed?e.close():t._workerThread=e}),j.checkSceneLayerValid(this.layer),j.checkSceneLayerCompatibleWithView(this.layer,this.view),this._initGraphicsController(),this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._isIntegratedMesh()||(this._edgeView=this._stage.view.getEdgeView()),this._texId2Meta=new Map,this._nodeId2Meta=new Map,this._addThisLayerToStage(),this._elevationProvider=new D({layerView:this,stageLayer:this._stageLayer}),this.handles.add([g.init(this.view,"clippingArea",function(){return t._clippingAreaChanged()}),g.init(this.layer,"renderer",function(e){return t._rendererChange(e)}),g.init(this.layer,"objectIdFilter",function(){return t._filterChange()}),g.init(this.layer,"elevationInfo",function(){return t._elevationInfoChanged()}),g.init(this.layer,"rangeInfos",function(e){return t._rangeInfosChanged(e)}),g.init(this,"_controller.parsedDefinitionExpression",function(){return t._filterChange()}),g.watch(this,"fullOpacity",function(e){return t._opacityChange(e)}),g.watch(this,["elevationOffset","rendererNeedsTextures"],function(){return t._reloadAll()}),g.watch(this,"uncompressedTextureDownsamplingEnabled",function(){return t._reloadAll()}),g.init(this,"suspended",function(e){return t.setVisibility(!e)})],"sceneLayerHandles"),this._idbCache.init(),this._cacheKeySuffix=j.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference),this._componentColorManager=this._hasSymbolColors()?new J.BufferManager(this._stage.view.renderingContext):null},c.prototype.destroy=function(){this.handles.remove("sceneLayerHandles"),this._workerThread&&(this._workerThread.close(),this._workerThread=null),this._removeThisLayerFromStage(),this._stage=null,this._idbCache&&(this._idbCache.destroy(),this._idbCache=null),null!=this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._texId2Meta=null,this._nodeId2Meta=null,this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)},c.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},c.prototype.isUpdating=function(){return!this._controllerCreated||!(!this._controller||!this._controller.updating)},c.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequiredMB();return this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t,t},c.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t,this.gpuMemoryEstimate<9.5367431640625e-7&&(this.gpuMemoryEstimate=0,this.texMemoryEstimate=0)},c.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage()/1048576;return this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t,t},c.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage()/1048576;this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t,this.gpuMemoryEstimate<9.5367431640625e-7&&(this.gpuMemoryEstimate=0,this.texMemoryEstimate=0)},c.prototype._isBundleLoaded=function(e){return this._nodeId2Meta.has(e.id)},c.prototype._initGraphicsController=function(){var e=this,t={addBundle:function(t,r){return e._addBundle(t,r)},isBundleLoaded:function(t){return e._isBundleLoaded(t)},getMemoryUsage:function(){return e.view.resourceController.getUsedMemory()},removeNodeData:function(t){return e._removeNodeDataFromStage(t.id)},getAddedNodeIDs:function(){return e._getAddedNodeIDs()}},r={setPolygonOffset:function(t,r){return e._setPolygonOffset(t,!!r)},textureOptions:{useCompressedTextures:this._useCompressedTextures},getLoadedAttributes:function(t){return e._getLoadedAttributes(t)},getAttributeData:function(t){return e._getAttributeData(t)},setAttributeData:function(t,r,n){return e._setAttributeData(t,r,n)},additionalCancelNodeLoadingHandler:function(){return e._cancel()},loadCachedBundle:function(t,r){return e._loadCachedBundle(t,r)},addCachedBundle:function(t,r,n){return e._addCachedBundle(t,r,n)}};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:t,layerViewOptionalFunctions:r}).then(function(t){e._controller=t,t.watch("rootNodeVisible",function(){e.notifyChange("suspended")})}).always(function(){e._controllerCreated=!0,e.notifyChange("updating")})},c.prototype.getUsedMemory=function(){return this.gpuMemoryEstimate},c.prototype.getUnloadedMemory=function(){return this._controller?this._controller.getUnloadedMemoryEstimate():0},c.prototype.removeCachedData=function(){this._removeAllNodeDataFromStage()},c.prototype.setVisibility=function(e){var t=this;if(this._nodeId2Meta.forEach(function(r){var n=r.engineObject;n.setHidden(n.geometryRecords[0],!e),t._edgeView&&t._edgeView.updateObjectVisibility(n,e)}),e){var r=this._isIntegratedMesh()?"im":"scene";this.view.elevationProvider.register(r,this._elevationProvider),this.visibleGeometryChanged()}else this.visibleGeometryChanged(),this.view.elevationProvider.unregister(this._elevationProvider)},c.prototype.getStats=function(){var e={nodesInIndex:0,knownFeatures:0,activeMaterials:0,"Total GPU Memory Estimate":this.gpuMemoryEstimate+"MB","Geometry Memory Estimate":this.geoMemoryEstimate+"MB","Texture Memory Estimate":this.texMemoryEstimate+"MB"};return this._controller?(e.nodesInIndex=Object.keys(this._controller.nodeIndex).length,e):e},c.prototype._addThisLayerToStage=function(){for(var e=this._stage,t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;this._whiteTexture=new z(t,"white",{width:8,height:8}),e.add(te.TEXTURE,this._whiteTexture);var n=this.layer.id,i=new q(n,{},n);this._stageLayer=i,e.add(te.LAYER,i),this._stage.addToViewContent([i.id])},c.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var e=this._stage;e.remove(te.TEXTURE,this._whiteTexture.id),this._removeAllNodeDataFromStage(),Q.assert(0===this._nodeId2Meta.size),Q.assert(0===this._texId2Meta.size),e.remove(te.LAYER,this._stageLayer.id),this._stageLayer=void 0,this.gpuMemoryEstimate=0}},c.prototype._getLoadedAttributes=function(e){var t=this._nodeId2Meta.get(e.id);if(t)return t.loadedAttributes},c.prototype._getAttributeData=function(e){var t=this._nodeId2Meta.get(e.id);if(t)return t.attributeData},c.prototype._setAttributeData=function(e,t,r){var n=this._nodeId2Meta.get(e.id);n&&(n.loadedAttributes=t,n.attributeData=r,this._setObjectSymbology(n),this._applyFilters(e),this.visibleGeometryChanged(n.engineObject))},c.prototype._getAddedNodeIDs=function(){return j.mapToKeys(this._nodeId2Meta)},c.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){var n=this.fullOpacity,i=1-Q.clamp(Q.fallbackIfUndefined(t.transparency,0),0,1);return{opacity:i,layerOpacity:n,transparent:i<1||n<1||e&&u.endsWith(e.channels,"a")||!0===t.useVertexColorAlpha||r}},c.prototype._calcEngineMaterialDoubleSidedParams=function(e){return null==e.doubleSided||e.doubleSided},c.prototype._calcEngineMaterialCullFaceParams=function(e){return e.cullFace?e.cullFace:null!=e.doubleSided?e.doubleSided?"none":"back":"none"},c.prototype._getMaterialParameters=function(e,t,r,n){var i;if(null!=e){var o=this._texId2Meta.get(t);i=o&&o.engineTex?o.engineTex.id:this._whiteTexture.id}var s=r.params,l=Q.fallbackIfUndefined(s.diffuse,ie);"standard"!==r.type&&re.warn("Unknown material type '"+r.type+"', must be 'standard'");var d=this._isIntegratedMesh(),u={ambient:l,diffuse:l,specular:Q.fallbackIfUndefined(s.specular,ae),atlasRegions:s.vertexRegions,textureId:i,vertexColors:this._hasVertexColors(),componentIndices:this._hasSymbolColors(),componentColorBuffer:this._hasSymbolColors()&&n?n.textureBuffer:null,flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(s),cullFace:this._calcEngineMaterialCullFaceParams(s),writeStencil:d,receiveSSAO:!d,groundNormalShading:d,compressedNormals:!d};if(!d){var c=this._calcEngineMaterialTransparencyParams(e,s);a.mixin(u,c)}return u},c.prototype._createEngineMaterial=function(e,t,r,n,i,a,o){var s=null!=t?this._getI3STexEncoding(t):null,l=this._getMaterialParameters(t,r,n,o),d=new X(l,i);if(d.metadata={i3sMatId:i,i3sTexId:r,i3sTex:t,i3sMatParams:n.params},null!=t){var u=this._texId2Meta.get(r);u?u.usedByEngineMats.push(d):(u={id:r,usedByEngineMats:[d],images:t.images,encoding:s,atlas:!0===t.atlas,wrap:"none"!==t.wrap[0]||"none"!==t.wrap[1]},this._texId2Meta.set(r,u));var c=Z(a,r);if(null!=c&&null==u.engineTex){var h=W(c,u,this._enableMipMaps,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);u.engineTex=new z(c,u.id,h),this._stage.add(te.TEXTURE,u.engineTex),e.memory+=this.memEstimateTextureAdded(u.engineTex)}if(null!=u.engineTex)for(var p=u.engineTex.id,f=0,g=u.usedByEngineMats;f<g.length;f++){var y=g[f];y.setParameterValues({textureId:p})}}return d},c.prototype._getI3STexEncoding=function(e){var t=j.getAppropriateTextureEncoding(e.encoding,this._useCompressedTextures);return t>-1?e.encoding[t]:e.encoding},c.prototype._getVertexBufferLayout=function(e,t){var r=e.params.materialID,n=t.materialDefinitions[r];Q.assert(void 0!==n,"geometry wants unknown material "+r);var i,a=e.params.textureID||"none";"none"!==a&&(null!=t.textureDefinitions&&null!=t.textureDefinitions[a]||re.warn("textureDefinitions missing in shared resource"),i=t.textureDefinitions[a]);var o=this._getMaterialParameters(i,a,n);return X.getVertexBufferLayout(o)},c.prototype._createEngineMat=function(e,t,r,n,i){var a=t.params.materialID,o=r.materialDefinitions[a];Q.assert(void 0!==o,"geometry wants unknown material "+a);var s,l=t.params.textureID||"none";return"none"!==l&&(null!=r.textureDefinitions&&null!=r.textureDefinitions[l]||re.warn("textureDefinitions missing in shared resource"),s=r.textureDefinitions[l]),this._createEngineMaterial(e,s,l,o,a,n,i)},c.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},c.prototype._findGraphicNodeAndIndex=function(e){var t=B.attributeLookup(e.attributes,this._getObjectIdField()),r=null;return this._nodeId2Meta.forEach(function(e,n){var i=null==r?e.featureIds.indexOf(t):-1;-1!==i&&(r={node:e.node,nodeId:n,index:i})}),r},c.prototype._getGraphicIndices=function(e,t){var r=this._nodeId2Meta.get(e.id);if(!r)return[];for(var n=[],i=this._getObjectIdField(),a=0,o=t;a<o.length;a++){var s=o[a],l=B.attributeLookup(s.attributes,i),d=r.featureIds.indexOf(l);-1!==d&&n.push(d)}return n},c.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(null!=t){var r=this._nodeId2Meta.get(t.nodeId).engineObject,n=this._boundingBoxCornerPoints(t.index,r,new Float64Array(24));if(N.bufferToBuffer(n,this.view.renderSpatialReference,0,n,this.view.spatialReference,0,8)){var i=P.create(P.NEGATIVE_INFINITY);return P.expandBuffer(i,n,0,8),h.resolve({boundingBox:i,screenSpaceObjects:[]})}}return h.reject()},c.prototype.whenGraphicAttributes=function(e,t){var r=this,n=function(){var t=r._findGraphicNodeAndIndex(e);return{node:t.node,indices:[t.index]}};return j.whenGraphicAttributes(this.layer,[e],this._getObjectIdField(),t,n,{ignoreUnavailableFields:!0,populateObjectId:!0}).then(function(e){return e[0]})},c.prototype.getGraphicsFromStageObject=function(e,t){if(this.layer instanceof v)return h.reject();var r=this._getMetadata(e),n=e.getComponentFromTriangleNr(0,t);if(null!=n&&null!=r.featureIds&&n<r.featureIds.length){var i=this._createGraphic(n,r);return h.resolve(i)}return h.reject()},c.prototype._getMetadata=function(e){var t=e.getMetadata();return this._nodeId2Meta.get(t.i3sNode)},c.prototype._getCacheKey=function(e){return e.baseUrl+this._cacheKeySuffix},c.prototype._cachingEnabled=function(){return!this._controller.disableCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix},c.prototype._cancel=function(){this._cancelCount=this._cancelCount+1|0},c.prototype._handleCancelled=function(e){if((this._cancelCount-e|0)>0)throw new o},c.prototype._loadCachedBundle=function(e,t){var r=this,n=this._cancelCount;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(e)).then(function(i){if(null==i)return null;if(r._handleCancelled(n),i.nodeVersion!==e.version)return r._idbCache.remove(r._getCacheKey(e)),null;e.obb=L.clone(i.nodeObb);var a=function(e){if(null==e.data)return!0;var t=i.sharedResource.textureDefinitions[e.i3sTexId],n=r._getI3STexEncoding(t);return e.encoding!==n};return r.rendererNeedsTextures&&i.textureData.some(a)?t(i.allGeometryData,i.sharedResource).then(function(t){return i.textureData=t,t.every($)&&r._idbCache.put(r._getCacheKey(e),i).catch(function(t){return re.warn("Failed to update node with textures in IndexedDB cache: "+e.id+": "+t)}),r._handleCancelled(n),i}):i}):h.resolve(null)},c.prototype._addBundle=function(e,t){var r=this;return this._transformBundle(e,t).then(function(n){e.obb=n.obb;var i={allGeometryData:t.allGeometryData,transformedGeometries:n.transformedGeometries,textureData:t.textureData,sharedResource:t.sharedResource,nodeVersion:e.version,nodeObb:e.obb,byteSize:ee(n.transformedGeometries,t.textureData)};if(r._cachingEnabled()){var a=i.textureData.map(function(e){return $(e)?e:{i3sTexId:e.i3sTexId,encoding:e.encoding,data:null}});r._idbCache.put(r._getCacheKey(e),{allGeometryData:i.allGeometryData,transformedGeometries:i.transformedGeometries,textureData:a,sharedResource:i.sharedResource,nodeVersion:i.nodeVersion,nodeObb:i.nodeObb,byteSize:i.byteSize}).catch(function(t){return re.warn("Failed to store node in IndexedDB cache: "+e.id+": "+t)})}return r._addCachedBundle(e,i,t.attributeDataInfo)})},c.prototype._transformBundle=function(e,t){for(var r=[],n=[t.geometryBuffer],i=0,a=t.allGeometryData;i<a.length;i++)for(var o=a[i].geometries,s=0,l=o;s<l.length;s++){var d=l[s];r.push(this._getVertexBufferLayout(d,t.sharedResource))}var u={geometryBuffer:t.geometryBuffer,geometryData:t.allGeometryData,layouts:r,center:e.mbs,obb:e.obb,elevationOffset:this.elevationOffset,hasColors:this._hasColors,needNormals:!this._isIntegratedMesh()&&this._controller.isMeshPyramid,normalReferenceFrame:this.layer.normalReferenceFrame||"none",indexSR:this._controller.crsIndex.toJSON(),vertexSR:this._controller.crsVertex.toJSON(),renderSR:this.view.renderSpatialReference.toJSON()};return this._workerThread?this._workerThread.invoke("process",u,n):h.resolve(this._worker.transform(u))},c.prototype._addCachedBundle=function(e,t,r){var n=t.allGeometryData,i=t.transformedGeometries,a=t.textureData,o=t.sharedResource;if(!this.rendererNeedsTextures)for(var s=0,l=a;s<l.length;s++){var d=l[s];d.data=null}var u=this._stage,c={};c[te.OBJECT]={},c[te.GEOMETRY]={},c[te.MATERIAL]={},c[te.TEXTURE]={};var p=this._stageLayer;if(this._nodeId2Meta.has(e.id))return this._applyFilters(e),h.resolve();if(!this.alwaysLoadEverythingModeEnabled&&!this._controller.isGeometryVisible(e))return h.resolve();e.memory=0;for(var f=0,g=this._hasColors,y=0,m=n;y<m.length;y++){var _=m[y],v=_.componentOffsets,b=_.geometries,x=_.featureIds,I=null,M=null;if(this._hasSymbolColors()){I=this._componentColorManager.getBuffer(x.length),M=new Uint16Array(x.length);for(var E=0;E<x.length;E++)M[E]=I.aquireIndex()}for(var C=e.id+"|"+x[0],w=[],O=[],T=[],D=void 0,A=0,j=b;A<j.length;A++){var F=j[A],B=this._createEngineMat(e,F,o,a,I),V=i[f++];g=g||V.hasNonWhiteColors;var G=S.extractPositionData(V.interleavedVertexData,V.layout,V.indices),P=new K(new Float32Array(V.interleavedVertexData),V.layout,G,v||K.DefaultOffsets,V.indices||K.DefaultIndices);this._hasSymbolColors()&&this._setComponentIndices(P,M),D=V.corMatrices;var L=R.mat4d.create(D.localTrafo);if(null!=F.transformation){var N=F.transformation;R.mat4d.multiply(L,N,L)}var U=w.length,q=C+(U>0?"_"+U:""),z=new k(P,q);w.push(z),O.push(L),T.push([B]),e.memory+=this.memEstimateGeometryAdded(z.getData()),c[te.MATERIAL][B.id]=B,c[te.GEOMETRY][z.id]=z}var Q={i3sNode:e.id,layerUid:this.layer.uid},J=new H({idHint:e.id,name:C,geometries:w,materials:T,transformations:O,castShadow:!0,metadata:Q}),X=R.mat4d.create();R.mat4d.identity(X),R.mat4d.multiply(X,D.globalTrafo,X),J.setObjectTransformation(X),c[te.OBJECT][J.id]=J;var Y={node:e,engineObject:J,featureIds:x,attributeData:r?r.attributeData:null,loadedAttributes:r?r.loadedAttributes:null,componentColorBuffer:I,componentIndices:M};this._nodeId2Meta.set(e.id,Y),this._setObjectSymbology(Y),this._applyFilters(e),this._highlights.objectCreated(J),this.visibleGeometryChanged(J)}u.beginMod();var W=c[te.OBJECT];for(var Z in W)W.hasOwnProperty(Z)&&p.addObject(W[Z]);for(var $ in c)if(c.hasOwnProperty($)){var ee=c[$];for(var re in ee)if(ee.hasOwnProperty(re)){if(null!=u.get($,re))continue;u.add($,ee[re])}}return u.endMod(),!this._hasTextures&&null!=e.textureData&&e.textureData.length>0&&(this._hasTextures=!0),this._hasColors=g,this._hasData=!0,this.notifyChange("hasTexturesOrVertexColors"),h.resolve()},c.prototype._clippingAreaChanged=function(){var e=this,t=[];N.extentToBoundingBox(this.view.clippingArea,t,this.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null,this._updateFilters(),this._nodeId2Meta.forEach(function(t){return e._applyFilters(t.node)}),this._controller&&this._controller.updateClippingArea(this.view.clippingArea)},c.prototype._filterChange=function(){var e=this;this._updateFilters(),this._nodeId2Meta.forEach(function(t){return e._applyFilters(t.node)})},c.prototype._updateFilters=function(){var e=this,t=[];if(this.layer.objectIdFilter){var r=new Float64Array(this.layer.objectIdFilter.ids),n="include"===this.layer.objectIdFilter.method;r.sort(),t.push(function(t,i){return e._objectIdFilter(r,n,i)})}if(this._controller&&this._controller.parsedDefinitionExpression&&this._controller.definitionExpressionFields){this._definitionExpressionErrors=0;var i=this._controller.parsedDefinitionExpression,a=this._controller.definitionExpressionFields;t.push(function(t,r){return e._sqlFilter(t,i,a,r)})}this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,e._clippingArea,r)}),this._filters=t},c.prototype._sqlFilter=function(e,t,r,n){var i={},a=new s(null,null,i);a.layer=this.layer,a.sourceLayer=this.layer;for(var o=this.layer.objectIdField,l=0,d=0,u=this._nodeId2Meta.get(e.id),c=u.featureIds,h=u.attributeData,p=r.every(function(e){return null!=h[e]||e===o}),f=0;f<c.length&&l<n.length;f++)if(n[l]===c[f]){var g=!0;if(p){i[o]=c[f];for(var y=0,m=r;y<m.length;y++){var _=m[y];_!==o&&(i[_]=j.getCachedAttributeValue(h[_],f))}g=this._evaluateClause(t,a)}g&&(n[d]=n[l],d++),l++}n.length=d},c.prototype._evaluateClause=function(e,t){try{return e.testFeature(t)}catch(e){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&re.error("Error while evaluating definitionExpression: "+e),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&re.error("Further errors are ignored"),!1}},c.prototype._objectIdFilter=function(e,t,r){for(var n=0,i=0;n<r.length;){l.binaryIndexOf(e,r[n])>=0===t&&(r[i]=r[n],i++),n++}r.length=i},c.prototype._boundingboxFilter=function(e,t,r){var n=[0,0,0,0];N.mbsToMbs(e.mbs,this._controller.crsIndex,n,this.view.renderSpatialReference);var i=null!=t?j.intersectBoundingBoxWithMbs(t,n):2;if(2!==i){if(0===i)return void(r.length=0);var a=0,o=0,s=this._nodeId2Meta.get(e.id),l=s.featureIds,d=s.engineObject.getObjectTransformation(),u=s.engineObject.getGeometryRecords()[0].getShaderTransformation();if(R.mat4d.multiply(d,u),0===d[1]&&0===d[2]&&0===d[3]&&0===d[4]&&0===d[6]&&0===d[7]&&0===d[8]&&0===d[9]&&0===d[11]&&1===d[15]){var c=de;c[0]=(t[0]-d[12])/d[0],c[1]=(t[1]-d[13])/d[5],c[2]=(t[2]-d[14])/d[10],c[3]=(t[3]-d[12])/d[0],c[4]=(t[4]-d[13])/d[5],c[5]=(t[5]-d[14])/d[10];for(var h=s.engineObject.getGeometryRecords()[0].geometry,p=h.getComponentCount(),f=0;f<p&&a<r.length;f++)if(r[a]===l[f]){var g=h.getComponentAABB(f,ue);P.intersects(c,g)&&(r[o]=r[a],o++),a++}r.length=o}}},c.prototype._updateEdgeMaterialPartial=function(e,t,r){if(this._edgeView){var n=this._edgeView.getComponentMaterial(e,t),i=b.diff(n,r);if(!i)return!0;if("partial"===i.type){var a=Object.keys(i.diff);if(1===a.length&&"color"===a[0])return this._edgeView.updateComponentColor(e,t,r.color),!0}return!1}},c.prototype._addOrUpdateEdgeRendering=function(e){if(this._edgeView){var t=e.engineObject,r=this._edgeView.hasObject(t),n=this._extractObjectEdgeMaterials(e),i=n.hasNonTransparent,a=n.edgeMaterials;if(r&&i){for(var o=e.featureIds,s=0;s<o.length;s++)if(!this._updateEdgeMaterialPartial(t,s,a[s])){this._edgeView.removeObject(t),this._edgeView.addObject(t,a);break}}else r?this._edgeView.removeObject(t):i&&this._edgeView.addObject(t,a);var l=t.isHidden(t.geometryRecords[0]);this._edgeView.updateObjectVisibility(t,!l)}},c.prototype._applyFilters=function(e){var t=this._nodeId2Meta.get(e.id);t&&(this._applyFiltersToObjects(e,t),this._addOrUpdateEdgeRendering(t))},c.prototype._applyFiltersToObjects=function(e,t){var r=t.engineObject;if(r.unhideAllComponents(),0!==this._filters.length){for(var n=t.featureIds,i=n.slice(),a=0,o=this._filters;a<o.length;a++){(0,o[a])(e,i)}if(i.length!==n.length)for(var s=0,l=r.getGeometryRecords()[0],d=0;d<n.length;d++){var u=n[d];s>=i.length||i[s]!==u?r.setComponentVisibility(l,d,!1):s++}}},c.prototype._removeAllNodeDataFromStage=function(){var e=this;this._nodeId2Meta.forEach(function(t,r){e._removeNodeDataFromStage(r)})},c.prototype._removeNodeDataFromStage=function(e){var t=this._nodeId2Meta.get(e);if(t){var r=this._stage,n=this._stageLayer,i=t.engineObject;this._highlights.objectDeleted(i),this._edgeView&&this._edgeView.removeObject(i),this.visibleGeometryChanged(i),n.removeObject(i);for(var a=0,o=i.getGeometryRecords();a<o.length;a++){var s=o[a];this.memEstimateGeometryRemoved(s.geometry.getData()),r.remove(te.GEOMETRY,s.geometry.id);for(var l=0,d=s.materials;l<d.length;l++){var u=d[l];this._removeMaterial(u,r)}}if(t.componentIndices){for(var c=0;c<t.componentIndices.length;c++)t.componentColorBuffer.releaseIndex(t.componentIndices[c]);this._componentColorManager.garbageCollect()}r.remove(te.OBJECT,i.id),this._nodeId2Meta.delete(e)}},c.prototype._removeMaterial=function(e,t){t.remove(te.MATERIAL,e.id);var r=e.metadata.i3sTexId||"none";if("none"!==r){var n=this._texId2Meta.get(r),i=n.usedByEngineMats,a=i.indexOf(e);if(a>-1?(i[a]=i[i.length-1],i.pop()):re.error("Missing reference from material to texture"),0===i.length){var o=n.engineTex;o&&o!==this._whiteTexture&&(this.memEstimateTextureRemoved(o),t.remove(te.TEXTURE,n.engineTex.id)),this._texId2Meta.delete(r)}}},c.prototype._setPolygonOffset=function(e,t){var r=this._nodeId2Meta.get(e.id);if(r)for(var n=0,i=r.engineObject.getGeometryRecords();n<i.length;n++)for(var a=i[n],o=0,s=a.materials;o<s.length;o++){var l=s[o];l.setParameterValues({polygonOffset:t})}},c.prototype._rendererChange=function(e){if(this._currentRenderer=e,e&&(e.colorInfo||e.sizeInfo)&&re.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead."),e)for(var t=0,r=e.getSymbols();t<r.length;t++){var n=r[t];"mesh-3d"!==n.type&&re.error("Symbols of type '"+n.type+"' are not supported for 3D Object Scene Services.")}this.view.resourceController.setMemoryDirty()},c.prototype._getRenderingInfo=function(e,t){var r=this._currentRenderer,n=r&&r.getSymbol(e);if(!(n instanceof I&&this._hasSymbolColors()))return null;var i,a;if(r&&r.visualVariables)for(var o=r.getVisualVariableValues(e),s=0;s<o.length;s++){var l=o[s],d=l.variable.type;"color"===d?i=l.value:"opacity"===d&&(a=l.value)}return t.symbol=n,t.color=i?[i.r/255,i.g/255,i.b/255]:null,null!=a?t.opacity=a:i&&null!=i.a?t.opacity=i.a:t.opacity=null,t},c.prototype._getSymbolFillMaterial=function(e,t){for(var r=0,n=e.symbolLayers.items;r<n.length;r++){var i=n[r];if("fill"===i.type){var a=i.material,o=null!=a?a.color:null;return null!=o?(ce[0]=o.r/255,ce[1]=o.g/255,ce[2]=o.b/255,ce[3]=o.a,t.color=ce):t.color=null,void(t.colorMixMode=null!=a?a.colorMixMode:null)}}t.color=null,t.colorMixMode=null},c.prototype._hasSymbolColors=function(){if(this._isIntegratedMesh()||!this.layer.store.defaultGeometrySchema)return!1;var e=this.layer.store.defaultGeometrySchema.featureAttributes;return!!(e&&e.faceRange&&e.id)},c.prototype._isIntegratedMesh=function(){return this.layer instanceof v},c.prototype._hasVertexColors=function(){return null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color)},c.prototype._extractObjectEdgeMaterials=function(e){for(var t,r=[],n=e.featureIds?e.featureIds.length:1,i=this.layer.objectIdField,a=new s(null,null,{}),o=a.attributes,l=this._currentRenderer&&this._currentRenderer.requiredFields,d=this._edgeView.createSolidEdgeMaterial({color:[0,0,0,0]}),u=0,c=this.fullOpacity,h=0;h<n;h++){if(t=d,null!=i&&null!=e.featureIds&&(o[i]=e.featureIds[h]),null!=l&&null!=e.attributeData)for(var p=Object.keys(e.attributeData),f=0,g=p;f<g.length;f++){var y=g[f];o[y]=j.getCachedAttributeValue(e.attributeData[y],h)}var m=this._getRenderingInfo(a,he),_=e.engineObject;if(_.getComponentVisibility(_.getGeometryRecords()[0],h)&&c>0&&m&&m.symbol instanceof I)for(var v=0,b=m.symbol.symbolLayers.items;v<b.length;v++){var M=b[v];if(M instanceof x){var E=V.createMaterial(this._edgeView,M,c);if(E){t=E;break}}}r.push(t),u+=t.color[3]}return{hasNonTransparent:u>0,edgeMaterials:r}},c.prototype._setObjectSymbology=function(e){if(this._hasSymbolColors()){for(var t=e.featureIds?e.featureIds.length:1,r=new s(null,null,{}),n=r.attributes,i=this.layer.objectIdField,a=this._currentRenderer&&this._currentRenderer.requiredFields,o=!1,l=new Uint8Array(4),d={color:null,colorMixMode:null},u=[0,0,0,0],c=null,h=0;h<t;h++){if(null!=i&&null!=e.featureIds&&(n[i]=e.featureIds[h]),null!=a&&null!=e.attributeData)for(var p=Object.keys(e.attributeData),f=0,g=p;f<g.length;f++){var y=g[f];n[y]=j.getCachedAttributeValue(e.attributeData[y],h)}var m=this._getRenderingInfo(r,he);if(m){m.symbol!==c&&(c=m.symbol,this._getSymbolFillMaterial(m.symbol,d));var _=m.color,v=m.opacity;_=null==_||null==v?O.overrideColor(_,v,d.color,d.color&&d.color[3],ne,u):O.overrideColor(_,v,null,null,ne,u),_[3]<1&&(o=!0),j.encodeSymbolColor(_,d.colorMixMode,l)}else j.encodeSymbolColor(null,null,l);var b=e.componentIndices[h];e.componentColorBuffer.textureBuffer.setData(b,l[0],l[1],l[2],l[3])}this._updateObjectOpacity(e.engineObject,o)}},c.prototype._setComponentIndices=function(e,t){for(var r=e.getAttribute(Q.VertexAttrConstants.COMPONENTINDEX),n=r.data,i=r.offsetIdx,a=r.strideIdx,o=e.getIndices(Q.VertexAttrConstants.COMPONENTINDEX),s=0;s<t.length;s++)for(var l=e.componentOffsets[s],d=e.componentOffsets[s+1],u=l;u<d;u++){var c=i+o[u]*a;n[c]=t[s]}},c.prototype._elevationInfoChanged=function(){var e=this.layer.elevationInfo&&this.layer.elevationInfo.unit;e&&!M.supportsUnit(e)&&re.warn("elevationInfo.unit","'"+e+"' is not a valid unit")},c.prototype._rangeInfosChanged=function(e){null!=e&&e.length>0&&re.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},c.prototype._reloadAll=function(){this._removeAllNodeDataFromStage(),
null!=this._controller&&this._controller.restartNodeLoading()},c.prototype._opacityChange=function(e){var t=this;this._nodeId2Meta.forEach(function(e){t._updateObjectOpacity(e.engineObject),t._addOrUpdateEdgeRendering(e)})},c.prototype._updateObjectOpacity=function(e,t){for(var r=0,n=e.getGeometryRecords();r<n.length;r++)for(var i=n[r],a=0,o=i.materials;a<o.length;a++){var s=o[a],l=s.metadata;void 0!==t&&(l.symbolIsTransparent=t);var d=s.getParams(),u=this._calcEngineMaterialTransparencyParams(l.i3sTex,l.i3sMatParams,l.symbolIsTransparent);d.transparent===u.transparent&&d.layerOpacity===u.layerOpacity||s.setParameterValues(u)}},c.prototype.queryExtent=function(e){return this._ensureQueryEngine().queryExtent(e)},c.prototype.queryFeatureCount=function(e){return this._ensureQueryEngine().queryFeatureCount(e)},c.prototype.queryFeatures=function(e){return this._ensureQueryEngine().queryFeatures(e)},c.prototype.queryObjectIds=function(e){return this._ensureQueryEngine().queryObjectIds(e)},c.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},c.prototype._createQueryEngine=function(){var e=this,t={id:0,index:0,meta:null,bbCorners:new Float64Array(24)};return new A({forAll:function(r,n){var i=function(n,i,a){t.id=n,t.index=i,t.meta=a,e._boundingBoxCornerPoints(i,a.engineObject,t.bbCorners),r(t)};e._forAllFeatures(i,n)},createGraphic:function(t){return e._createGraphic(t.index,t.meta)},requestFields:function(t,r,n){var i=function(){var n=e._getGraphicIndices(t,r);return{node:t,indices:n}};return j.whenGraphicAttributes(e.layer,r,e._getObjectIdField(),n,i,{ignoreUnavailableFields:!1})},createExtentBuilder:function(){return e._createExtentBuilder()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})},c.prototype._createExtentBuilder=function(){var e=this.view.renderSpatialReference,t=this.view.spatialReference,r=P.create(P.NEGATIVE_INFINITY),n=new Float64Array(24);return{add:function(i){N.bufferToBuffer(i.bbCorners,e,0,n,t,0,8)&&P.expandBuffer(r,n,0,8)},getExtent:function(){return P.toExtent(r,t)}}},c.prototype._forAllFeatures=function(e,t,r){var n=this;this._nodeId2Meta.forEach(function(i,a){n._forAllFeaturesOfNode(i,e,r),t&&t(i.node)})},c.prototype._forAllFeaturesOfNode=function(e,t,r){for(var n=e.featureIds,i=e.engineObject.getGeometryRecords()[0],a=0;a<n.length;a++)if(r||e.engineObject.getComponentVisibility(i,a)){var o=n[a];t(o,a,e,i)}},c.prototype._createGraphic=function(e,t){var r={};if(null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]),null!=t.attributeData)for(var n=0,i=Object.keys(t.attributeData);n<i.length;n++){var a=i[n];r[a]=j.getCachedAttributeValue(t.attributeData[a],e)}var o=new s(null,null,r);return o.layer=this.layer,o.sourceLayer=this.layer,o},c.prototype._boundingBoxCornerPoints=function(e,t,r){for(var n=t.geometries[0].getComponentAABB(e,de),i=0;i<8;++i)le[0]=1&i?n[0]:n[3],le[1]=2&i?n[1]:n[4],le[2]=4&i?n[2]:n[5],R.mat4d.multiplyVec3(t.objectTransformation,le),r[3*i]=le[0],r[3*i+1]=le[1],r[3*i+2]=le[2];return r},c.prototype.highlight=function(e,t){var r=this,n=this._highlights;if(e instanceof E){var i=n.acquireSet(t),a=i.set,o=i.handle;return this.queryObjectIds(e).then(function(e){return n.setFeatureIds(a,e)}),o}if("number"==typeof e)return this.highlight([e],t);if(e instanceof s)return this.highlight([e],t);if(e instanceof d&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof s){var l=e,u=l.map(function(e){return B.attributeLookup(e.attributes,r._getObjectIdField())}),c=n.acquireSet(t),h=c.set,o=c.handle;return n.setFeatureIds(h,u),o}if("number"==typeof e[0]){var u=e,p=n.acquireSet(t),h=p.set,o=p.handle;return n.setFeatureIds(h,u),o}}return{remove:function(){}}},c.prototype.visibleGeometryChanged=function(e){var t=this;e?this._elevationProvider.objectChanged(e):this._elevationProvider.layerChanged(),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=f.schedule(function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))},n([m.property()],c.prototype,"layer",void 0),n([m.property()],c.prototype,"_controller",void 0),n([m.property({dependsOn:["_controller.updating"]})],c.prototype,"updating",void 0),n([m.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],c.prototype,"updatingPercentageValue",void 0),n([m.property({readOnly:!0})],c.prototype,"hasTexturesOrVertexColors",null),n([m.property({readOnly:!0,dependsOn:["layer.renderer"]})],c.prototype,"rendererNeedsTextures",null),n([m.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],c.prototype,"elevationOffset",null),n([m.property()],c.prototype,"alwaysLoadEverythingModeEnabled",void 0),n([m.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","_useCompressedTextures"]})],c.prototype,"uncompressedTextureDownsamplingEnabled",null),n([m.property({dependsOn:["layer.version"]})],c.prototype,"_useCompressedTextures",null),c=n([m.subclass("esri.views.3d.layers.SceneLayerView3D")],c)}(m.declared(C,G)),le=R.vec3d.create(),de=P.create(),ue=P.create(),ce=[0,0,0,0],he={symbol:null};return se});