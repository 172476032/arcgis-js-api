// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessorSupport/decorators","../../../layers/IntegratedMeshLayer","../../../core/arrayUtils","../../../core/watchUtils","../../../core/promiseUtils","../../../core/Logger","../../../core/Collection","../../../core/lang","../../../geometry/support/scaleUtils","../../../symbols/support/unitConversionUtils","dojo/_base/lang","dojo/has","../../../Graphic","../../../symbols/Symbol3D","../../../tasks/support/Query","./LayerView3D","./i3s/I3SUtil","./i3s/I3SBinaryReader","./i3s/I3SElevationProvider","./i3s/I3SProjectionUtil","./i3s/I3SQueryEngine","./i3s/Highlights","./i3s/FeatureChangeNotifier","./graphics/graphicUtils","./support/LayerViewUpdatingPercentage","../support/projectionUtils","../support/aaBoundingBox","../webgl-engine/Stage","../webgl-engine/lib/Layer","../webgl-engine/lib/Geometry","../webgl-engine/lib/GeometryData","../webgl-engine/lib/Object3D","../webgl-engine/lib/Texture","../webgl-engine/materials/Material","./support/attributeUtils","../webgl-engine/lib/Util","../lib/glMatrix"],function(e,t,r,i,n,a,o,s,l,d,u,h,c,p,f,g,y,m,v,_,b,I,M,x,E,O,C,A,T,w,j,F,S,D,R,P,B,L,V,G,N){function U(e){return e.getMetadata()}function k(e,t,r,i){var n,a=!1;t.encoding===b.DDS_ENCODING_STRING?n=B.DDS_ENCODING:a=!(G.isPowerOfTwo(e.width)&&G.isPowerOfTwo(e.height));var o=t.usedByEngineMats.some(function(e){return e.getParams().atlasRegions}),s=o||t.atlas,l=(r||!s)&&!a,d=s||!t.wrap,u=s&&l&&i;return{mipmap:l,wrapClamp:d,disableAnisotropy:u,encoding:n,noUnpackFlip:!0}}function q(e){return null!=e.featureIds?e.featureIds.length:1}var X=F.ModelContentType,Q=d.getLogger("esri.views.3d.layers.SceneLayerView3D"),Y=[1,1,1,1],z=[.8,.8,.8],H=[.5,.5,.5],J=64,W=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._queryEngine=null,t._highlights=new O(t),t._elevationProvider=null,t._featureChangeNotifier=null,t._controllerCreated=!1,t._hasColors=!1,t._hasTextures=!1,t._hasData=!1,t._definitionExpressionErrors=0,t._maxDefinitionExpressionErrors=20,t}return r(t,e),Object.defineProperty(t.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"elevationOffset",{get:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=c.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=p.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;b.checkSceneLayerValid(this.layer),b.checkSceneLayerCompatibleWithView(this.layer,this.view),this.addResolvingPromise(this.getHeightModelInfoResolvingPromise());var t=this.layer.version,r=!g("trident")||t.major>1||1===t.major&&t.minor>3;this._useCompressedTextures=this.view.has("s3tc")&&r,this._enableAtlasMipMaps=this.view.has("standardDerivatives"),this._disableAtlasAnisotropy=this._enableAtlasMipMaps&&!this.view.has("shaderTextureLOD"),this._initGraphicsController(),this.maxGpuMemory=1e3,this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._matId2Meta={},this._texId2Meta={},this._nodeId2Meta={};for(var i=new Uint8Array(256),n=0;n<i.length;n++)i[n]=255;this._whiteTexture=new B(i,"white",{width:8,height:8}),this._stage.add(X.TEXTURE,this._whiteTexture),this._addThisLayerToStage(),this._elevationProvider=new M({layerView:this,stageLayer:this._stageLayer}),this.handles.add([s.init(this.view,"clippingArea",function(){return e._clippingAreaChanged()}),s.init(this.layer,"renderer",function(t){return e._rendererChange(t)}),s.init(this.layer,"objectIdFilter",function(){return e._filterChange()}),s.init(this.layer,"elevationInfo",function(){return e._elevationInfoChanged()}),s.init(this,"_controller.parsedDefinitionExpression",function(){return e._filterChange()}),s.watch(this,"fullOpacity",function(t){return e._opacityChange(t)}),s.watch(this,"elevationOffset",function(){return e._elevationOffsetChange()}),s.init(this,"suspended",function(t){return e.setVisibility(!t)})],"sceneLayerHandles")},t.prototype.destroy=function(){this.handles.remove("sceneLayerHandles"),this._stage.remove(X.TEXTURE,this._whiteTexture.getId()),this._removeThisLayerFromStage(),this._stage=null,null!=this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._matId2Meta=null,this._texId2Meta=null,this._nodeId2Meta=null},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return this._controllerCreated?!(!this._controller||!this._controller.updating):!0},t.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t},t.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},t.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t},t.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},t.prototype.isBundleAlreadyAddedToStage=function(e,t){return null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle[t]},t.prototype._initGraphicsController=function(){var e=this,t={addBundle:function(t,r,i){return e._addBundle(t,r,i)},isBundleAlreadyAddedToStage:function(t,r){return e.isBundleAlreadyAddedToStage(t,r)},isOverMemory:function(){return e._isOverMemory()},removeNodeData:function(t){return e._removeNodeDataFromStage(t.id)},getAddedNodeIDs:function(){return e._getAddedNodeIDs()},areAllBundlesLoaded:function(t){return e._areAllBundlesLoaded(t)}},r={setPolygonOffset:function(t,r){return e._setPolygonOffset(t,r?1:0)},traversalOptions:{initDepthFirst:!0,neighborhood:!0,perLevelTraversal:!1,allowPartialOverlaps:!1},textureOptions:{useCompressedTextures:this._useCompressedTextures},getLoadedAttributes:function(t){return e._getLoadedAttributes(t)},setAttributeData:function(t,r,i){return e._setAttributeData(t,r,i)}};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:t,layerViewOptionalFunctions:r}).then(function(t){e._controller=t,e._featureChangeNotifier=new C.FeatureChangeNotifier(e,t),t.watch("rootNodeVisible",function(){e.notifyChange("suspended")})}).always(function(){e._controllerCreated=!0,e.notifyChange("updating")})},t.prototype.setMaxGpuMemory=function(e){this.maxGpuMemory=e},t.prototype.setVisibility=function(e){if(this._stage&&this._stageLayer){var t=this._stageLayer.getId(),r=this._stage.getViewContent(),i=r.indexOf(t)>=0;if(!!e===i)return;var n=[t];if(e){this._stage.addToViewContent(n);var a=this._isIntegratedMesh()?"im":"scene";this.view.elevationProvider.register(a,this._elevationProvider),this._elevationProvider.visibilityChanged()}else this._stage.removeFromViewContent(n),this._elevationProvider.visibilityChanged(),this.view.elevationProvider.unregister(this._elevationProvider)}},t.prototype.getStats=function(){var e={nodesInIndex:0,knownFeatures:0,activeMaterials:0,"Total GPU Memory Estimate":this.gpuMemoryEstimate+"MB","Geometry Memory Estimate":this.geoMemoryEstimate+"MB","Texture Memory Estimate":this.texMemoryEstimate+"MB"};return this._controller?(e.nodesInIndex=Object.keys(this._controller.nodeIndex).length,e.activeMaterials=Object.keys(this._matId2Meta).length,e):e},t.prototype._addThisLayerToStage=function(){var e=this._stage;this._initTexture=new B(null,"i3sInitTexture"),e.add(X.TEXTURE,this._initTexture);var t=this.layer.id,r=new S(t,{},t);this._stageLayer=r,e.add(X.LAYER,r)},t.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var e=this._stage;e.remove(X.TEXTURE,this._initTexture.getId()),this._removeAllNodeDataFromStage(),G.assert(G.objectEmpty(this._nodeId2Meta)),G.assert(G.objectEmpty(this._matId2Meta)),G.assert(G.objectEmpty(this._texId2Meta)),e.remove(X.LAYER,this._stageLayer.getId()),this._matId2Meta={},this._texId2Meta={},this._nodeId2Meta={},this._stageLayer=void 0,this.gpuMemoryEstimate=0}},t.prototype._getLoadedAttributes=function(e){var t=this._nodeId2Meta[e.id];return t&&1===t.engineObjects.length?U(t.engineObjects[0]).loadedAttributes:void 0},t.prototype._setAttributeData=function(e,t,r){var i=this._nodeId2Meta[e.id];if(i&&1===i.engineObjects.length){var n=i.engineObjects[0],a=U(n);a.loadedAttributes=t,a.attributeData=r,this._setObjectSymbology(n),this._applyFilters(e),this._elevationProvider.visibilityChanged(n)}},t.prototype._isOverMemory=function(){if(this.gpuMemoryEstimate>this.maxGpuMemory&&this.gpuMemoryEstimate!==this.warnGpuMemoryEstimate){this.warnGpuMemoryEstimate=this.gpuMemoryEstimate;var e=function(e){return e.toLocaleString(void 0,{maximumFractionDigits:1})+" Mb"};Q.warn("GPU Memory Limit exceeded!\nLimit: "+e(this.maxGpuMemory)+" Current: "+e(this.gpuMemoryEstimate)+"\n(Textures: "+e(this.texMemoryEstimate)+" Geometry: "+e(this.geoMemoryEstimate)+")")}return this.gpuMemoryEstimate>this.maxGpuMemory},t.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodeId2Meta)},t.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){var i=this.fullOpacity,n=1-G.clamp(G.fallbackIfUndefined(t.transparency,0),0,1),a=1>n||1>i||e&&h.endsWith(e.channels,"a")||t.useVertexColorAlpha===!0||r;return{opacity:n,layerOpacity:i,transparent:a}},t.prototype._calcEngineMaterialDoubleSidedParams=function(e){return null!=e.doubleSided?e.doubleSided:!0},t.prototype._calcEngineMaterialCullFaceParams=function(e){return e.cullFace?e.cullFace:null!=e.doubleSided?e.doubleSided?"none":"back":"none"},t.prototype._createEngineMaterial=function(e,t,r,i,n){var a,o;null!=e&&(o=this._texId2Meta[t],a=o&&o.engineTex?o.engineTex.getId():this._initTexture.getId());var s,l,d=r.params,u=G.fallbackIfUndefined(d.diffuse,z);null!=e&&(l=b.getAppropriateTextureEncoding(e.encoding,this._useCompressedTextures),s=l>-1?e.encoding[l]:e.encoding),"standard"!==r.type&&Q.warn("Unknown material type '"+r.type+"', must be 'standard'"),void 0===d.reflectivity&&Q.warn("Material parameter 'reflectivity' is missing.");var h=this._isIntegratedMesh(),c={ambient:u,diffuse:u,specular:G.fallbackIfUndefined(d.specular,H),shininess:G.fallbackIfUndefined(d.shininess,J),atlasRegions:d.vertexRegions,textureId:a,vertexColors:this._hasVertexColors(),symbolColors:this._hasSymbolColors(),flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(d),cullFace:this._calcEngineMaterialCullFaceParams(d),writeStencil:h,receiveSSAO:!h,groundNormalShading:h};if(!h){var p=this._calcEngineMaterialTransparencyParams(e,d);f.mixin(c,p)}var g=new L(c,i);if(g.metadata={i3sMatId:i,i3sTexId:t,i3sTex:e,i3sMatParams:d},null!=e&&(o?o.usedByEngineMats.push(g):(o={id:t,usedByEngineMats:[g],images:e.images,encoding:s,encodingIdx:l,atlas:e.atlas===!0,wrap:"none"!==e.wrap[0]||"none"!==e.wrap[1]},this._texId2Meta[t]=o),null!=n[t])){if(null==o.engineTex){var y=n[t],m=y.data,v=k(m,o,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);o.engineTex=new B(m,o.id,v),this._stage.add(X.TEXTURE,o.engineTex),this.memEstimateTextureAdded(o.engineTex)}for(var _=o.engineTex.getId(),I=0,M=o.usedByEngineMats;I<M.length;I++){var x=M[I];x.setParameterValues({textureId:_})}}return this._matId2Meta[i]||(this._matId2Meta[i]={}),this._matId2Meta[i][t]={engineMat:g,refCount:1},g},t.prototype._createVertexArrays=function(e,t,r){for(var i=e.params.vertexAttributes,n={},a=0,o=Object.keys(i);a<o.length;a++){var s=o[a];if("classification"!==s&&(r||s!==G.VertexAttrConstants.NORMAL)){var l=i[s],d=I.valueType2TypedArrayClassMap[l.valueType];if(null!=d){var u=new d(t,l.byteOffset,l.count*l.valuesPerElement),h=new d(u);n[s]={data:h,size:l.valuesPerElement}}else Q.error("unsupported vertex attribute value type: "+l.valueType)}}var c=Array.isArray(i.position)?i.position.length/3:i.position.count;if(this._hasVertexColors()&&null==n[G.VertexAttrConstants.COLOR]){var p=new Uint8Array(4*c);n[G.VertexAttrConstants.COLOR]={data:p,size:4};for(var f=0;f<p.length;f++)p[f]=255}if(this._hasSymbolColors()){var p=new Uint8Array(4*c);n[G.VertexAttrConstants.SYMBOLCOLOR]={data:p,size:4}}if(r&&null==n[G.VertexAttrConstants.NORMAL]){var p=new Float32Array(3*c);n[G.VertexAttrConstants.NORMAL]={data:p,size:3}}return n},t.prototype._hasNonWhiteColors=function(e){if("color"in e)for(var t=e.color.data,r=0;r<t.length;r++)if(255!==t[r])return!0;return!1},t.prototype._createEngineMats=function(e,t,r){var i=e.params.materialID,n=t.materialDefinitions[i];G.assert(void 0!==n,"geometry wants unknown material "+i);var a,o=e.params.textureID||"none";"none"!==o&&((null==t.textureDefinitions||null==t.textureDefinitions[o])&&Q.warn("textureDefinitions missing in shared resource"),a=t.textureDefinitions[o]);var s;if(this._matId2Meta[i]&&this._matId2Meta[i][o]){var l=this._matId2Meta[i][o];s=l.engineMat,l.refCount++}else s=this._createEngineMaterial(a,o,n,i,r);return[s]},t.prototype._areAllBundlesLoaded=function(e){if(null==this._nodeId2Meta[e.id]||null==this._nodeId2Meta[e.id].engineObjectsPerBundle)return!1;for(var t=0;t<e.featureData.length;t++)if(null==this._nodeId2Meta[e.id].engineObjectsPerBundle[t])return!1;return!0},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._findGraphicNodeAndIndex=function(e){for(var t=V.attributeLookup(e.attributes,this._getObjectIdField()),r=0,i=Object.keys(this._nodeId2Meta);r<i.length;r++)for(var n=i[r],a=this._nodeId2Meta[n].engineObjects,o=0;o<a.length;o++){var s=a[o],l=U(s),d=l.featureIds.indexOf(t);if(-1!==d)return{node:this._controller.nodeIndex[n],nodeId:n,bundleNr:o,index:d}}return null},t.prototype._getGraphicIndices=function(e,t,r){var i=this._nodeId2Meta[e.id].engineObjects;if(!i||!i[t])return[];for(var n=U(i[t]),a=[],o=this._getObjectIdField(),s=0,l=r;s<l.length;s++){var d=l[s],u=V.attributeLookup(d.attributes,o),h=n.featureIds.indexOf(u);-1!==h&&a.push(h)}return a},t.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(null!=t){var r=this._nodeId2Meta[t.nodeId].engineObjects[t.bundleNr],i=this._boundingBoxCornerPoints(t.index,r,new Float64Array(24));if(w.bufferToBuffer(i,this.view.renderSpatialReference,0,i,this.view.spatialReference,0,8)){var n=j.create(j.NEGATIVE_INFINITY);return j.expandBuffer(n,i,0,8),l.resolve({boundingBox:n,screenSpaceObjects:[]})}}return l.reject()},t.prototype.whenGraphicAttributes=function(e,t){var r=this,i=function(){var t=r._findGraphicNodeAndIndex(e);return{node:t.node,indices:[t.index]}};return b.whenGraphicAttributes(this.layer,[e],this._getObjectIdField(),t,i).then(function(e){return e[0]})},t.prototype.getGraphicsFromStageObject=function(e,t){if(this.layer instanceof a)return l.reject();var r=U(e),i=e.getFaceRangeIndexFromTriangleNr(t);if(null!=i&&null!=r.featureIds&&i<r.featureIds.length){var n=this._createGraphic(i,r);return l.resolve(n)}return l.reject()},t.prototype._addBundle=function(e,t,r){if(this._isOverMemory())return l.reject();var i=r.allGeometryData,n=r.attributeDataInfo,a=r.geometryBuffers,o=r.preloadedDomImages,s=r.sharedResource,d=this._stage,u={};u[X.OBJECT]={},u[X.GEOMETRY]={},u[X.MATERIAL]={},u[X.TEXTURE]={};var h=this._stageLayer,c=h.getId();if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle&&this._nodeId2Meta[e.id].engineObjectsPerBundle[t])return this._applyFilters(e),l.resolve();null==this._nodeId2Meta[e.id]&&(this._nodeId2Meta[e.id]={engineObjects:[],engineObjectsPerBundle:[]}),this._nodeId2Meta[e.id].engineObjectsPerBundle[t]=[];for(var p=0,f=this._hasColors,g=0,y=i;g<y.length;g++){for(var m=y[g],v=m.faceRanges,_=m.componentOffsets,I=m.geometries,M=m.featureIds,E=a[e.geometryData[t].hrefConcat],O=e.id+"|"+M[0],C=[],A=[],T=[],w=void 0,j=function(t){var r=!F._isIntegratedMesh(),i=F._createVertexArrays(t,E,r),n=F._createEngineMats(t,s,o);f=f||F._hasNonWhiteColors(i);var a=new R(i,R.DefaultIndices,_||R.DefaultOffsets),l=F._controller.crsIndex,d=F._controller.crsVertex,h=F.view.renderSpatialReference,c=N.vec4d.set(e.mbs,$);if(c[2]+=F.elevationOffset,w=x.reprojectPoints(x.ReprojectionTypes.PER_VERTEX,i.position.data,c,l,d,h),r&&F._controller.isMeshPyramid){var p={normals:a.vertexAttributes.normal.data,positions:a.vertexAttributes.position.data,normalInd:a.indices.normal,positionInd:a.indices.position},g=F.layer.normalReferenceFrame||"none";b.processNormals(p,g,function(e,t){return x.reprojectNormalsPerVertex(e,c,l,t,h)})}var y=w.localTrafo;if(null!=t.transformation){var m=N.mat4d.create(t.transformation);N.mat4d.multiply(y,m,y)}var v=C.length,I=O+(v>0?"_"+v:""),M=new D(a,I);C.push(M),A.push(y),T.push(n),F.memEstimateGeometryAdded(M.getData());for(var j=0,S=n;j<S.length;j++){var P=S[j];u[X.MATERIAL][P.getId()]=P}u[X.GEOMETRY][M.getId()]=M},F=this,S=0,B=I;S<B.length;S++){var L=B[S];j(L)}var V={i3sNode:e.id,ceLayer:c,faceRanges:v,featureIds:M,attributeData:n?n.attributeData:null,loadedAttributes:n?n.loadedAttributes:null,layerUid:this.layer.uid};p+=q(V);var G=new P({idHint:e.id,name:O,geometries:C,materials:T,transformations:A,castShadow:!0,metadata:V}),U=N.mat4d.create();N.mat4d.identity(U),N.mat4d.multiply(U,w.globalTrafo,U),G.setObjectTransformation(U),this._nodeId2Meta[e.id].engineObjectsPerBundle[t].push(G),this._nodeId2Meta[e.id].engineObjects.push(G),u[X.OBJECT][G.getId()]=G,this._setObjectSymbology(G),this._applyFilters(e),this._highlights.objectCreated(G),this._elevationProvider.objectCreated(G)}d.beginMod();var k=u[X.OBJECT];for(var Q in k)k.hasOwnProperty(Q)&&h.addObject(k[Q]);for(var Y in u)if(u.hasOwnProperty(Y)){var z=u[Y];for(var H in z)if(z.hasOwnProperty(H)){if(null!=d.get(Y,H))continue;d.add(Y,z[H])}}return d.endMod(),!this._hasTextures&&null!=e.textureData&&e.textureData.length>0&&(this._hasTextures=!0),this._hasColors=f,this._hasData=!0,this.notifyChange("hasTexturesOrVertexColors"),this._featureChangeNotifier.notify(p,0),l.resolve()},t.prototype._clippingAreaChanged=function(){var e=this,t=[];if(w.extentToBoundingBox(this.view.clippingArea,t,this.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null,this._updateFilters(),this._controller){var r=this._controller.nodeIndex;r&&Object.keys(this._nodeId2Meta).forEach(function(t){return e._applyFilters(r[t])}),this._controller.updateClippingArea(this.view.clippingArea)}},t.prototype._filterChange=function(){if(this._updateFilters(),this._controller){var e=this._controller.nodeIndex;if(e)for(var t=0,r=Object.keys(this._nodeId2Meta);t<r.length;t++){var i=r[t];this._applyFilters(e[i])}}},t.prototype._updateFilters=function(){var e=this,t=[];if(this.layer.objectIdFilter){var r=new Float64Array(this.layer.objectIdFilter.ids),i="include"===this.layer.objectIdFilter.method;r.sort(),t.push(function(t,n){return e._objectIdFilter(r,i,n)})}if(this._controller&&this._controller.parsedDefinitionExpression&&this._controller.definitionExpressionFields){this._definitionExpressionErrors=0;var n=this._controller.parsedDefinitionExpression,a=this._controller.definitionExpressionFields;t.push(function(t,r){return e._sqlFilter(t,n,a,r)})}this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,e._clippingArea,r)}),this._filters=t},t.prototype._sqlFilter=function(e,t,r,i){var n={},a=new y(null,null,n);a.layer=this.layer;for(var o=this.layer.objectIdField,s=0,l=0,d=function(e){for(var d=U(e),h=d.featureIds,c=d.attributeData,p=r.every(function(e){return null!=c[e]||e===o}),f=0;f<h.length&&s<i.length;f++)if(i[s]===h[f]){var g=!0;if(p){n[o]=h[f];for(var y=0,m=r;y<m.length;y++){var v=m[y];v!==o&&(n[v]=b.getCachedAttributeValue(c[v],f))}g=u._evaluateClause(t,a)}g&&(i[l]=i[s],l++),s++}},u=this,h=0,c=this._nodeId2Meta[e.id].engineObjects;h<c.length;h++){var p=c[h];d(p)}i.length=l},t.prototype._evaluateClause=function(e,t){try{return e.testFeature(t)}catch(r){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&Q.error("Error while evaluating definitionExpression: "+r),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&Q.error("Further errors are ignored"),!1}},t.prototype._objectIdFilter=function(e,t,r){for(var i=0,n=0;i<r.length;){var a=o.binaryIndexOf(e,r[i])>=0;a===t&&(r[n]=r[i],n++),i++}r.length=n},t.prototype._boundingboxFilter=function(e,t,r){var i=[0,0,0,0];w.mbsToMbs(e.mbs,this._controller.crsIndex,i,this.view.renderSpatialReference);var n=null!=t?b.intersectBoundingBoxWithMbs(t,i):2;if(2!==n)for(var a=0,o=0,s=this._nodeId2Meta[e.id].engineObjects;o<s.length;o++){var l=s[o],d=U(l).featureIds;if(0!==n){var u=l.getObjectTransformation(),h=l.getGeometryRecords()[0].getShaderTransformation();if(N.mat4d.multiply(u,h),0===u[1]&&0===u[2]&&0===u[3]&&0===u[4]&&0===u[6]&&0===u[7]&&0===u[8]&&0===u[9]&&0===u[11]&&1===u[15])for(var c=(t[0]-u[12])/u[0],p=(t[1]-u[13])/u[5],f=(t[2]-u[14])/u[10],g=(t[3]-u[12])/u[0],y=(t[4]-u[13])/u[5],m=(t[5]-u[14])/u[10],v=l.getGeometryRecords()[0].geometry.getData(),_=v.getFaces()[0].indices.position,I=v.getVertexAttr().position.data,M=U(l).faceRanges,x=void 0,E=void 0,O=void 0,C=void 0,A=void 0,T=void 0,j=0;j<M.length&&a<r.length;j+=1)if(r[a]===d[j]){var F=M[j],S=F[0],D=F[1];x=E=O=Number.MAX_VALUE,C=A=T=-Number.MAX_VALUE;for(var R=S;D>=R;R+=1)for(var P=0;3>P;P+=1){var B=3*_[3*R+P],L=I[B],V=I[B+1],G=I[B+2];x=Math.min(L,x),E=Math.min(V,E),O=Math.min(G,O),C=Math.max(L,C),A=Math.max(V,A),T=Math.max(G,T)}var k=x>g||c>C||E>y||p>A||O>m||f>T;k?r.splice(a,1):a++}}else{for(var q=0,j=0;j<d.length&&a+q<r.length;j+=1)r[a+q]===d[j]&&q++;r.splice(a,q)}}},t.prototype._applyFilters=function(e){if(this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjects){for(var t=this._nodeId2Meta[e.id].engineObjects,r=0,i=t;r<i.length;r++){var n=i[r];n.unhideAllComponents()}if(0!==this._filters.length){for(var a=[],o=0,s=t;o<s.length;o++){var n=s[o];a=a.concat(U(n).featureIds)}for(var l=a.length,d=0;d<this._filters.length;d++)this._filters[d](e,a);if(a.length!==l)for(var u=0,h=0,c=t;h<c.length;h++)for(var n=c[h],p=n.getGeometryRecords()[0],f=U(n).featureIds,g=0;g<f.length;g+=1){var y=f[g];u>=a.length||a[u]!==y?n.setComponentVisibility(p,g,!1):u++}}}},t.prototype._removeAllNodeDataFromStage=function(){for(var e=0,t=Object.keys(this._nodeId2Meta);e<t.length;e++){var r=t[e];this._removeNodeDataFromStage(r)}},t.prototype._removeNodeDataFromStage=function(e){if(null!=this._nodeId2Meta[e]&&null!=this._nodeId2Meta[e].engineObjects){for(var t=this._stage,r=this._stageLayer,i=0,n=this._nodeId2Meta[e].engineObjects,a=0;a<n.length;++a){var o=n[a];this._highlights.objectDeleted(o),this._elevationProvider.objectDeleted(o),i+=q(U(o)),r.removeObject(o);for(var s=o.getGeometryRecords(),l=0;l<s.length;l++){var d=s[l];this.memEstimateGeometryRemoved(d.geometry.getData()),t.remove(X.GEOMETRY,d.geometry.getId());for(var u=0;u<d.materials.length;u++){var h=d.materials[u],c=h.getId(),p=h.metadata.i3sMatId,f=h.metadata.i3sTexId||"none",g=this._matId2Meta[p][f];G.assert(g.refCount>0),g.refCount--,0===g.refCount&&this._removeMaterial(c,f,p,h,t)}}t.remove(X.OBJECT,o.getId())}delete this._nodeId2Meta[e],this._featureChangeNotifier.notify(0,i)}},t.prototype._removeMaterial=function(e,t,r,i,n){if(n.remove(X.MATERIAL,e),"none"!==t){var a=this._texId2Meta[t],o=a.usedByEngineMats,s=o.indexOf(i);if(G.assert(s>-1),o[s]=o[o.length-1],o.pop(),o.length<1){var l=a.engineTex;l&&l!==this._initTexture&&(this.memEstimateTextureRemoved(l),n.remove(X.TEXTURE,a.engineTex.getId())),a.engineTex=void 0,delete this._texId2Meta[t]}}delete this._matId2Meta[r][t],G.objectEmpty(this._matId2Meta[r])&&delete this._matId2Meta[r]},t.prototype._setPolygonOffset=function(e,t){if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle)for(var r={polygonOffset:t},i=0;i<this._nodeId2Meta[e.id].engineObjectsPerBundle.length;i++)for(var n=this._nodeId2Meta[e.id].engineObjectsPerBundle[i],a=0;a<n.length;a++)for(var o=n[a].getGeometryRecords(),s=0;s<o.length;s++)for(var l=o[s].materials,d=0;d<l.length;d++)l[d].setParameterValues(r)},t.prototype._rendererChange=function(e){if(this._currentRenderer=e,e&&(e.colorInfo||e.sizeInfo)&&Q.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead."),e)for(var t=0,r=e.getSymbols();t<r.length;t++){var i=r[t];"mesh-3d"!==i.type&&Q.error("Symbols of type '"+i.type+"' are not supported for 3D Object Scene Services.")}},t.prototype._getRenderingInfo=function(e){var t=this._currentRenderer,r=t&&t.getSymbol(e);if(!(r instanceof m))return null;var i,n,a={symbol:r};if(t&&t.visualVariables)for(var o=t.getVisualVariableValues(e),s=0;s<o.length;s++){var l=o[s],d=l.variable.type;"color"===d?i=l.value:"opacity"===d&&(n=l.value)}return i&&(a.color=[i.r/255,i.g/255,i.b/255]),null!=n?a.opacity=n:i&&null!=i.a&&(a.opacity=i.a),a},t.prototype._getSymbolFillColor=function(e){for(var t=0,r=e.symbolLayers.items;t<r.length;t++){var i=r[t];if("fill"===i.type){var n=i.material,a=null!=n?n.color:null;if(null!=a)return[a.r/255,a.g/255,a.b/255,a.a]}}return null},t.prototype._getSymbolFillColorMixMode=function(e){for(var t=0,r=e.symbolLayers.items;t<r.length;t++){var i=r[t];if("fill"===i.type){var n=i.material,a=null!=n?n.colorMixMode:null;if(null!=a)return a}}return null},t.prototype._hasSymbolColors=function(){return!this._isIntegratedMesh()},t.prototype._isIntegratedMesh=function(){return this.layer instanceof a},t.prototype._hasVertexColors=function(){return null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color)},t.prototype._setObjectSymbology=function(e){if(this._hasSymbolColors()){for(var t=U(e),r=t.faceRanges?t.faceRanges.length:1,i=new y(null,null,{}),n=i.attributes,a=this.layer.objectIdField,o=this._currentRenderer&&this._currentRenderer.requiredFields,s=e.geometryRecords[0].geometry.data.vertexAttributes,l=s[G.VertexAttrConstants.SYMBOLCOLOR].data,d=!1,u=new Uint8Array(4),h=0;r>h;h++){if(null!=a&&null!=t.featureIds&&(n[a]=t.featureIds[h]),null!=o&&null!=t.attributeData)for(var c=0,p=o;c<p.length;c++){var f=p[c];null!=t.attributeData[f]&&(n[f]=b.getCachedAttributeValue(t.attributeData[f],h))}var g=this._getRenderingInfo(i),m=null!=t.faceRanges?t.faceRanges[h]:null;if(g){var v=this._getSymbolFillColorMixMode(g.symbol),_=g.color,I=g.opacity;if(null==_||null==I){var M=this._getSymbolFillColor(g.symbol);_=A.overrideColor(_,I,M,M&&M[3],Y)}else _=A.overrideColor(_,I,null,null,Y);_[3]<1&&(d=!0),b.encodeSymbolColor(_,v,u)}else b.encodeSymbolColor(null,null,u);this._setFaceRangeColor(m,l,u)}e.geometryColorAttrsUpdated(0);for(var x=e.getGeometryRecords(),E=0;E<x.length;E++)for(var O=x[E],C=0;C<O.materials.length;C++){var T=O.materials[C],w=T.getParams().transparent,j=T.getParams().opacity;T.metadata.symbolIsTransparent=d;var F=this._calcEngineMaterialTransparencyParams(T.metadata.i3sTex,T.metadata.i3sMatParams,T.metadata.symbolIsTransparent);(w!==F.transparent||j!==F.opacity)&&T.setParameterValues({transparent:F.transparent,opacity:F.opacity})}}},t.prototype._setFaceRangeColor=function(e,t,r){for(var i=12*e[0],n=12*e[1]+12,a=i;n>a;a+=4)t[a+0]=r[0],t[a+1]=r[1],t[a+2]=r[2],t[a+3]=r[3]},t.prototype._elevationInfoChanged=function(){var e=this.layer.elevationInfo&&this.layer.elevationInfo.unit;e&&!p.supportsUnit(e)&&Q.warn("elevationInfo.unit","'"+e+"' is not a valid unit")},t.prototype._elevationOffsetChange=function(){this._removeAllNodeDataFromStage(),null!=this._controller&&this._controller.restartNodeLoading()},t.prototype._opacityChange=function(e){for(var t in this._matId2Meta)for(var r in this._matId2Meta[t]){var i=this._matId2Meta[t][r].engineMat,n=i.getParams(),a=this._calcEngineMaterialTransparencyParams(i.metadata.i3sTex,i.metadata.i3sMatParams,i.metadata.symbolIsTransparent);(n.transparent!==a.transparent||n.layerOpacity!==a.layerOpacity)&&i.setParameterValues(a)}},t.prototype.queryExtent=function(e){return this._ensureQueryEngine().queryExtent(e)},t.prototype.queryFeatureCount=function(e){return this._ensureQueryEngine().queryFeatureCount(e)},t.prototype.queryFeatures=function(e){return this._ensureQueryEngine().queryFeatures(e)},t.prototype.queryObjectIds=function(e){return this._ensureQueryEngine().queryObjectIds(e)},t.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},t.prototype._createQueryEngine=function(){var e=this,t={id:0,index:0,object:null,bbCorners:new Float64Array(24)};return new E({forAll:function(r,i){var n=function(i,n,a){t.id=i,t.index=n,t.object=a,e._boundingBoxCornerPoints(t.index,t.object,t.bbCorners),r(t)};e._forAllFeatures(n,i)},createGraphic:function(t){return e._createGraphic(t.index,U(t.object))},requestFields:function(t,r,i){var n=function(){var i=e._getGraphicIndices(t.node,t.bundleNr,r);return{node:t.node,indices:i}};return b.whenGraphicAttributes(e.layer,r,e._getObjectIdField(),i,n)},createExtentBuilder:function(){return e._createExtentBuilder()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})},t.prototype._createExtentBuilder=function(){var e=this.view.renderSpatialReference,t=this.view.spatialReference,r=j.create(j.NEGATIVE_INFINITY),i=new Float64Array(24);return{add:function(n){w.bufferToBuffer(n.bbCorners,e,0,i,t,0,8)&&j.expandBuffer(r,i,0,8)},getExtent:function(){return j.toExtent(r,t)}}},t.prototype._forAllFeatures=function(e,t,r){for(var i=0,n=Object.keys(this._nodeId2Meta);i<n.length;i++)for(var a=n[i],o=this._nodeId2Meta[a].engineObjects,s=0;s<o.length;s++){var l=o[s];this._forAllFeaturesOfObject(l,e,r),t&&t({node:this._controller.nodeIndex[a],bundleNr:s})}},t.prototype._forAllFeaturesOfObject=function(e,t,r){for(var i=U(e).featureIds,n=e.getGeometryRecords()[0],a=0;a<i.length;a++)if(r||e.getComponentVisibility(n,a)){var o=i[a];t(o,a,e,n)}},t.prototype._createGraphic=function(e,t){var r={};if(null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]),null!=t.attributeData)for(var i=0,n=Object.keys(t.attributeData);i<n.length;i++){var a=n[i];r[a]=b.getCachedAttributeValue(t.attributeData[a],e)}var o=new y(null,null,r);return o.layer=this.layer,o},t.prototype._boundingBoxCornerPoints=function(e,t,r){for(var i=t.geometries[0].getComponentAABB(e,Z),n=0;8>n;++n)K[0]=1&n?i[0]:i[3],K[1]=2&n?i[1]:i[4],K[2]=4&n?i[2]:i[5],N.mat4d.multiplyVec3(t.objectTransformation,K),r[3*n]=K[0],r[3*n+1]=K[1],r[3*n+2]=K[2];return r},t.prototype.highlight=function(e,t){var r=this,i=this._highlights;if(e instanceof v){var n=i.acquireSet(t),a=n.set,o=n.handle;return this.queryObjectIds(e).then(function(e){return i.setFeatureIds(a,e)}),o}if("number"==typeof e)return this.highlight([e],t);if(e instanceof y)return this.highlight([e],t);if(e instanceof u&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof y){var s=e,l=s.map(function(e){return V.attributeLookup(e.attributes,r._getObjectIdField())}),d=i.acquireSet(t),h=d.set,o=d.handle;return i.setFeatureIds(h,l),o}if("number"==typeof e[0]){var l=e,c=i.acquireSet(t),h=c.set,o=c.handle;return i.setFeatureIds(h,l),o}}return{remove:function(){}}},i([n.property()],t.prototype,"layer",void 0),i([n.property()],t.prototype,"_controller",void 0),i([n.property({dependsOn:["_controller.updating"]})],t.prototype,"updating",void 0),i([n.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],t.prototype,"updatingPercentageValue",void 0),i([n.property({readOnly:!0})],t.prototype,"hasTexturesOrVertexColors",null),i([n.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],t.prototype,"elevationOffset",null),t=i([n.subclass("esri.views.3d.layers.SceneLayerView3D")],t)}(n.declared(_,T)),K=N.vec3d.create(),Z=[0,0,0,0,0,0],$=N.vec4d.create();
return W});