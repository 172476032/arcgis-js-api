// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessorSupport/decorators","../../../layers/IntegratedMeshLayer","../../../core/arrayUtils","../../../core/watchUtils","../../../core/promiseUtils","../../../core/Logger","../../../core/Collection","../../../core/Scheduler","../../../core/lang","../../../geometry/support/scaleUtils","../../../symbols/support/unitConversionUtils","dojo/_base/lang","dojo/has","dojo/errors/CancelError","../../../Graphic","../../../symbols/Symbol3D","../../../tasks/support/Query","./LayerView3D","./i3s/I3SUtil","./i3s/I3SElevationProvider","./i3s/I3SGeometryUtil","./i3s/I3SProjectionUtil","./i3s/I3SQueryEngine","./i3s/Highlights","./i3s/IDBCache","./graphics/graphicUtils","./support/LayerViewUpdatingPercentage","../support/projectionUtils","../support/aaBoundingBox","../webgl-engine/Stage","../webgl-engine/lib/Layer","../webgl-engine/lib/Geometry","../webgl-engine/lib/PreinterleavedGeometryData","../webgl-engine/lib/Object3D","../webgl-engine/lib/Texture","../webgl-engine/materials/Material","./support/attributeUtils","../webgl-engine/lib/Util","../lib/glMatrix"],function(e,t,r,n,i,a,o,s,l,d,u,h,c,p,f,g,y,m,_,v,b,I,x,M,C,E,O,w,T,A,j,S,D,F,B,G,P,R,V,L,N,U,k){function q(e){return e.getMetadata()}function H(e,t,r,n,i){var a,o=!1;t.encoding===x.DDS_ENCODING_STRING?a=V.DDS_ENCODING:o=!(U.isPowerOfTwo(e.width)&&U.isPowerOfTwo(e.height));var s=t.usedByEngineMats.some(function(e){return e.getParams().atlasRegions}),l=s||t.atlas,d=(l?n:r)&&!o,u=l||!t.wrap,h=l&&d&&i;return{mipmap:d,wrapClamp:u,disableAnisotropy:h,encoding:a,noUnpackFlip:!0}}function K(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];if(i.i3sTexId===t)return i.data}return null}function Q(e){return e.data instanceof ArrayBuffer}function Y(e,t){for(var r=1024,n=0,i=e;n<i.length;n++){var a=i[n];r+=a.interleavedVertexData.byteLength}for(var o=0,s=t;o<s.length;o++){var l=s[o];l.data instanceof ArrayBuffer&&(r+=l.data.byteLength)}return r}var z=F.ModelContentType,W=d.getLogger("esri.views.3d.layers.SceneLayerView3D"),X=[1,1,1,1],J=[.8,.8,.8],Z=[.5,.5,.5],$=64,ee=4,te=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._queryEngine=null,t._highlights=new w(t),t._elevationProvider=null,t._controllerCreated=!1,t._idbCache=new T.IDBCache("esri-scenelayer-cache","geometries",ee),t._cancelCount=0,t._hasColors=!1,t._hasTextures=!1,t._hasData=!1,t.alwaysLoadEverythingModeEnabled=!1,t._cacheKeySuffix=null,t._definitionExpressionErrors=0,t._maxDefinitionExpressionErrors=20,t}return r(t,e),Object.defineProperty(t.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rendererNeedsTextures",{get:function(){return x.rendererNeedsTextures(this.layer.renderer)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"elevationOffset",{get:function(){var e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){var t=p.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=f.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this._useCompressedTextures},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_useCompressedTextures",{get:function(){var e=this.layer.version,t=!y("trident")||e.major>1||1===e.major&&e.minor>3,r=this.view.has("s3tc");return r&&t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps&&this.view.has("standardDerivatives")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_atlasBiasCompensationEnabled",{get:function(){return!this.view.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!0,configurable:!0}),t.prototype.initialize=function(){var e=this;x.checkSceneLayerValid(this.layer),x.checkSceneLayerCompatibleWithView(this.layer,this.view),this._initGraphicsController(),this.maxGpuMemory=1e3,this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._matId2Meta={},this._texId2Meta={},this._nodeId2Meta={},this._addThisLayerToStage(),this._elevationProvider=new M({layerView:this,stageLayer:this._stageLayer}),this.handles.add([s.init(this.view,"clippingArea",function(){return e._clippingAreaChanged()}),s.init(this.layer,"renderer",function(t){return e._rendererChange(t)}),s.init(this.layer,"objectIdFilter",function(){return e._filterChange()}),s.init(this.layer,"elevationInfo",function(){return e._elevationInfoChanged()}),s.init(this,"_controller.parsedDefinitionExpression",function(){return e._filterChange()}),s.watch(this,"fullOpacity",function(t){return e._opacityChange(t)}),s.watch(this,["elevationOffset","rendererNeedsTextures"],function(){return e._reloadAll()}),s.watch(this,"uncompressedTextureDownsamplingEnabled",function(){return e._reloadAll()}),s.init(this,"suspended",function(t){return e.setVisibility(!t)})],"sceneLayerHandles"),this._idbCache.init(),this._cacheKeySuffix=x.getCacheKeySuffix(this.layer.spatialReference,this.view.renderSpatialReference)},t.prototype.destroy=function(){this.handles.remove("sceneLayerHandles"),this._removeThisLayerFromStage(),this._stage=null,this._idbCache&&(this._idbCache.destroy(),this._idbCache=null),null!=this._controller&&(this._controller.destroy(),this._controller=null),this._highlights.destroy(),this._matId2Meta=null,this._texId2Meta=null,this._nodeId2Meta=null,this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return this._controllerCreated?!(!this._controller||!this._controller.updating):!0},t.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t},t.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},t.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t},t.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},t.prototype.isBundleAlreadyAddedToStage=function(e,t){return null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle[t]},t.prototype._initGraphicsController=function(){var e=this,t={addBundle:function(t,r,n){return e._addBundle(t,r,n)},isBundleAlreadyAddedToStage:function(t,r){return e.isBundleAlreadyAddedToStage(t,r)},isOverMemory:function(){return e._isOverMemory()},removeNodeData:function(t){return e._removeNodeDataFromStage(t.id)},getAddedNodeIDs:function(){return e._getAddedNodeIDs()},areAllBundlesLoaded:function(t){return e._areAllBundlesLoaded(t)}},r={setPolygonOffset:function(t,r){return e._setPolygonOffset(t,r?1:0)},traversalOptions:{initDepthFirst:!1,neighborhood:!0,perLevelTraversal:!1,allowPartialOverlaps:!1},textureOptions:{useCompressedTextures:this._useCompressedTextures},getLoadedAttributes:function(t){return e._getLoadedAttributes(t)},setAttributeData:function(t,r,n){return e._setAttributeData(t,r,n)},additionalCancelNodeLoadingHandler:function(){return e._cancel()},loadCachedBundle:function(t,r,n){return e._loadCachedBundle(t,r,n)},addCachedBundle:function(t,r,n,i){return e._addCachedBundle(t,r,n,i)}};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:t,layerViewOptionalFunctions:r}).then(function(t){e._controller=t,t.watch("rootNodeVisible",function(){e.notifyChange("suspended")})}).always(function(){e._controllerCreated=!0,e.notifyChange("updating")})},t.prototype.setMaxGpuMemory=function(e){this.maxGpuMemory=e},t.prototype.setVisibility=function(e){if(this._stage&&this._stageLayer){var t=this._stageLayer.getId(),r=this._stage.getViewContent(),n=r.indexOf(t)>=0;if(!!e===n)return;var i=[t];if(e){this._stage.addToViewContent(i);var a=this._isIntegratedMesh()?"im":"scene";this.view.elevationProvider.register(a,this._elevationProvider),this.visibleGeometryChanged()}else this._stage.removeFromViewContent(i),this.visibleGeometryChanged(),this.view.elevationProvider.unregister(this._elevationProvider)}},t.prototype.getStats=function(){var e={nodesInIndex:0,knownFeatures:0,activeMaterials:0,"Total GPU Memory Estimate":this.gpuMemoryEstimate+"MB","Geometry Memory Estimate":this.geoMemoryEstimate+"MB","Texture Memory Estimate":this.texMemoryEstimate+"MB"};return this._controller?(e.nodesInIndex=Object.keys(this._controller.nodeIndex).length,e.activeMaterials=Object.keys(this._matId2Meta).length,e):e},t.prototype._addThisLayerToStage=function(){for(var e=this._stage,t=8,r=8,n=new Uint8Array(t*r*4),i=0;i<n.length;i++)n[i]=255;this._whiteTexture=new V(n,"white",{width:t,height:r}),e.add(z.TEXTURE,this._whiteTexture);var a=this.layer.id,o=new B(a,{},a);this._stageLayer=o,e.add(z.LAYER,o)},t.prototype._removeThisLayerFromStage=function(){if(null!=this._stageLayer){var e=this._stage;e.remove(z.TEXTURE,this._whiteTexture.getId()),this._removeAllNodeDataFromStage(),U.assert(U.objectEmpty(this._nodeId2Meta)),U.assert(U.objectEmpty(this._matId2Meta)),U.assert(U.objectEmpty(this._texId2Meta)),e.remove(z.LAYER,this._stageLayer.getId()),this._matId2Meta={},this._texId2Meta={},this._nodeId2Meta={},this._stageLayer=void 0,this.gpuMemoryEstimate=0}},t.prototype._getLoadedAttributes=function(e){var t=this._nodeId2Meta[e.id];return t&&1===t.engineObjects.length?q(t.engineObjects[0]).loadedAttributes:void 0},t.prototype._setAttributeData=function(e,t,r){var n=this._nodeId2Meta[e.id];if(n&&1===n.engineObjects.length){var i=n.engineObjects[0],a=q(i);a.loadedAttributes=t,a.attributeData=r,this._setObjectSymbology(i),this._applyFilters(e),this.visibleGeometryChanged(i)}},t.prototype._isOverMemory=function(){if(this.gpuMemoryEstimate>this.maxGpuMemory&&this.gpuMemoryEstimate!==this.warnGpuMemoryEstimate){this.warnGpuMemoryEstimate=this.gpuMemoryEstimate;var e=function(e){return e.toLocaleString(void 0,{maximumFractionDigits:1})+" Mb"};W.warn("GPU Memory Limit exceeded!\nLimit: "+e(this.maxGpuMemory)+" Current: "+e(this.gpuMemoryEstimate)+"\n(Textures: "+e(this.texMemoryEstimate)+" Geometry: "+e(this.geoMemoryEstimate)+")")}return this.gpuMemoryEstimate>this.maxGpuMemory},t.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodeId2Meta)},t.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){var n=this.fullOpacity,i=1-U.clamp(U.fallbackIfUndefined(t.transparency,0),0,1),a=1>i||1>n||e&&c.endsWith(e.channels,"a")||t.useVertexColorAlpha===!0||r;return{opacity:i,layerOpacity:n,transparent:a}},t.prototype._calcEngineMaterialDoubleSidedParams=function(e){return null!=e.doubleSided?e.doubleSided:!0},t.prototype._calcEngineMaterialCullFaceParams=function(e){return e.cullFace?e.cullFace:null!=e.doubleSided?e.doubleSided?"none":"back":"none"},t.prototype._getMaterialParameters=function(e,t,r){var n;if(null!=e){var i=this._texId2Meta[t];n=i&&i.engineTex?i.engineTex.getId():this._whiteTexture.getId()}var a=r.params,o=U.fallbackIfUndefined(a.diffuse,J);"standard"!==r.type&&W.warn("Unknown material type '"+r.type+"', must be 'standard'"),void 0===a.reflectivity&&W.warn("Material parameter 'reflectivity' is missing.");var s=this._isIntegratedMesh(),l={ambient:o,diffuse:o,specular:U.fallbackIfUndefined(a.specular,Z),shininess:U.fallbackIfUndefined(a.shininess,$),atlasRegions:a.vertexRegions,textureId:n,vertexColors:this._hasVertexColors(),symbolColors:this._hasSymbolColors(),flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(a),cullFace:this._calcEngineMaterialCullFaceParams(a),writeStencil:s,receiveSSAO:!s,groundNormalShading:s};if(!s){var d=this._calcEngineMaterialTransparencyParams(e,a);g.mixin(l,d)}return l},t.prototype._createEngineMaterial=function(e,t,r,n,i){var a=null!=e?this._getI3STexEncoding(e):null,o=this._getMaterialParameters(e,t,r),s=new L(o,n);if(s.metadata={i3sMatId:n,i3sTexId:t,i3sTex:e,i3sMatParams:r.params},null!=e){var l=this._texId2Meta[t];l?l.usedByEngineMats.push(s):(l={id:t,usedByEngineMats:[s],images:e.images,encoding:a,atlas:e.atlas===!0,wrap:"none"!==e.wrap[0]||"none"!==e.wrap[1]},this._texId2Meta[t]=l);var d=K(i,t);if(null!=d&&null==l.engineTex){var u=H(d,l,this._enableMipMaps,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);l.engineTex=new V(d,l.id,u),this._stage.add(z.TEXTURE,l.engineTex),this.memEstimateTextureAdded(l.engineTex)}if(null!=l.engineTex)for(var h=l.engineTex.getId(),c=0,p=l.usedByEngineMats;c<p.length;c++){var f=p[c];f.setParameterValues({textureId:h})}}return this._matId2Meta[n]||(this._matId2Meta[n]={}),this._matId2Meta[n][t]={engineMat:s,refCount:1},s},t.prototype._getI3STexEncoding=function(e){var t=x.getAppropriateTextureEncoding(e.encoding,this._useCompressedTextures),r=t>-1?e.encoding[t]:e.encoding;return r},t.prototype._hasNonWhiteColors=function(e){for(var t=e.data,r=e.size,n=e.offsetIdx,i=e.strideIdx,a=n;a<t.length;a+=i)for(var o=0;r>o;o++)if(255!==t[a+o])return!0;return!1},t.prototype._getVertexBufferLayout=function(e,t){var r=e.params.materialID,n=t.materialDefinitions[r];U.assert(void 0!==n,"geometry wants unknown material "+r);var i,a=e.params.textureID||"none";"none"!==a&&((null==t.textureDefinitions||null==t.textureDefinitions[a])&&W.warn("textureDefinitions missing in shared resource"),i=t.textureDefinitions[a]);var o=this._getMaterialParameters(i,a,n);return L.getVertexBufferLayout(o)},t.prototype._createEngineMat=function(e,t,r){var n=e.params.materialID,i=t.materialDefinitions[n];U.assert(void 0!==i,"geometry wants unknown material "+n);var a,o=e.params.textureID||"none";"none"!==o&&((null==t.textureDefinitions||null==t.textureDefinitions[o])&&W.warn("textureDefinitions missing in shared resource"),a=t.textureDefinitions[o]);var s;if(this._matId2Meta[n]&&this._matId2Meta[n][o]){var l=this._matId2Meta[n][o];s=l.engineMat,l.refCount++}else s=this._createEngineMaterial(a,o,i,n,r);return s},t.prototype._areAllBundlesLoaded=function(e){if(null==this._nodeId2Meta[e.id]||null==this._nodeId2Meta[e.id].engineObjectsPerBundle)return!1;for(var t=0;t<e.featureData.length;t++)if(null==this._nodeId2Meta[e.id].engineObjectsPerBundle[t])return!1;return!0},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._findGraphicNodeAndIndex=function(e){for(var t=N.attributeLookup(e.attributes,this._getObjectIdField()),r=0,n=Object.keys(this._nodeId2Meta);r<n.length;r++)for(var i=n[r],a=this._nodeId2Meta[i].engineObjects,o=0;o<a.length;o++){var s=a[o],l=q(s),d=l.featureIds.indexOf(t);if(-1!==d)return{node:this._controller.nodeIndex[i],nodeId:i,bundleNr:o,index:d}}return null},t.prototype._getGraphicIndices=function(e,t,r){var n=this._nodeId2Meta[e.id].engineObjects;if(!n||!n[t])return[];for(var i=q(n[t]),a=[],o=this._getObjectIdField(),s=0,l=r;s<l.length;s++){var d=l[s],u=N.attributeLookup(d.attributes,o),h=i.featureIds.indexOf(u);-1!==h&&a.push(h)}return a},t.prototype.whenGraphicBounds=function(e){var t=this._findGraphicNodeAndIndex(e);if(null!=t){var r=this._nodeId2Meta[t.nodeId].engineObjects[t.bundleNr],n=this._boundingBoxCornerPoints(t.index,r,new Float64Array(24));if(S.bufferToBuffer(n,this.view.renderSpatialReference,0,n,this.view.spatialReference,0,8)){var i=D.create(D.NEGATIVE_INFINITY);return D.expandBuffer(i,n,0,8),l.resolve({boundingBox:i,screenSpaceObjects:[]})}}return l.reject()},t.prototype.whenGraphicAttributes=function(e,t){var r=this,n=function(){var t=r._findGraphicNodeAndIndex(e);return{node:t.node,indices:[t.index]}};return x.whenGraphicAttributes(this.layer,[e],this._getObjectIdField(),t,n,{ignoreUnavailableFields:!0,populateObjectId:!0}).then(function(e){return e[0]})},t.prototype.getGraphicsFromStageObject=function(e,t){if(this.layer instanceof a)return l.reject();var r=q(e),n=e.getComponentFromTriangleNr(0,t);if(null!=n&&null!=r.featureIds&&n<r.featureIds.length){var i=this._createGraphic(n,r);return l.resolve(i)}return l.reject()},t.prototype._getCacheKey=function(e){return e.baseUrl+this._cacheKeySuffix},t.prototype._cachingEnabled=function(){return!this._controller.disableCache&&0===this.elevationOffset&&null!=this._cacheKeySuffix},t.prototype._cancel=function(){this._cancelCount=this._cancelCount+1|0},t.prototype._handleCancelled=function(e){var t=(this._cancelCount-e|0)>0;if(t)throw new m},t.prototype._loadCachedBundle=function(e,t,r){var n=this,i=this._cancelCount;return this._cachingEnabled()?this._idbCache.get(this._getCacheKey(e)).then(function(t){if(null==t)return null;if(n._handleCancelled(i),t.nodeVersion!==e.version)return n._idbCache.remove(n._getCacheKey(e)),null;var a=function(e){if(null==e.data)return!0;var r=t.sharedResource.textureDefinitions[e.i3sTexId],i=n._getI3STexEncoding(r);return e.encoding!==i};return n.rendererNeedsTextures&&t.textureData.some(a)?r(t.allGeometryData,t.sharedResource).then(function(r){return t.textureData=r,r.every(Q)&&n._idbCache.put(n._getCacheKey(e),t).otherwise(function(){return W.warn("Failed to update node with textures in IndexedDB cache: "+e.id)}),n._handleCancelled(i),t}):t}):l.resolve(null)},t.prototype._addBundle=function(e,t,r){var n=this;return this._transformBundle(e,t,r).then(function(i){if(n._cachingEnabled()){var a=i.allGeometryData,o=i.transformedGeometries,s=i.textureData,l=i.sharedResource,d=i.byteSize,u=s.map(function(e){return Q(e)?e:{i3sTexId:e.i3sTexId,encoding:e.encoding,data:null}});n._idbCache.put(n._getCacheKey(e),{allGeometryData:a,transformedGeometries:o,textureData:u,sharedResource:l,nodeVersion:e.version,byteSize:d}).otherwise(function(){return W.warn("Failed to store node in IndexedDB cache: "+e.id)})}return n._addCachedBundle(e,t,i,r.attributeDataInfo)})},t.prototype._transformBundle=function(e,t,r){for(var n=r.allGeometryData,i=r.geometryBuffer,a=r.textureData,o=r.sharedResource,s=this._hasColors,d=[],u=0,h=n;u<h.length;u++)for(var c=h[u],p=c.componentOffsets,f=c.geometries,g=function(t){var r=y._getVertexBufferLayout(t,o),n=[{name:U.VertexAttrConstants.NORMAL,byteValue:0},{name:U.VertexAttrConstants.COLOR,byteValue:255},{name:U.VertexAttrConstants.SYMBOLCOLOR,byteValue:0}],a=C.interleaveGeometryBuffer(t,i,r,n),l=new P(new Float32Array(a),r,p||P.DefaultOffsets),u=y._controller.crsIndex,h=y._controller.crsVertex,c=y.view.renderSpatialReference,f=k.vec4d.set(e.mbs,ae);f[2]+=y.elevationOffset;var g=E.reprojectPoints(E.ReprojectionTypes.PER_VERTEX,l.getAttribute(U.VertexAttrConstants.POSITION),f,u,h,c),m=!y._isIntegratedMesh();if(m&&y._controller.isMeshPyramid){var _={normals:l.getAttribute(U.VertexAttrConstants.NORMAL),positions:l.getAttribute(U.VertexAttrConstants.POSITION),normalInd:l.getIndices(U.VertexAttrConstants.NORMAL),positionInd:l.getIndices(U.VertexAttrConstants.POSITION)},v=y.layer.normalReferenceFrame||"none";x.processNormals(_,v,function(e,t){return E.reprojectNormalsPerVertex(e,f,u,t,c)})}var b=l.getAttribute(U.VertexAttrConstants.COLOR);b&&(s=s||y._hasNonWhiteColors(b)),d.push({layout:r,interleavedVertexData:a,corMatrices:g,hasNonWhiteColors:s})},y=this,m=0,_=f;m<_.length;m++){var v=_[m];g(v)}return l.resolve({allGeometryData:n,transformedGeometries:d,textureData:a,sharedResource:o,nodeVersion:e.version,byteSize:Y(d,a)})},t.prototype._addCachedBundle=function(e,t,r,n){if(this._isOverMemory())return l.reject();var i=r.allGeometryData,a=r.transformedGeometries,o=r.textureData,s=r.sharedResource;if(!this.rendererNeedsTextures)for(var d=0,u=o;d<u.length;d++){var h=u[d];h.data=null}var c=this._stage,p={};p[z.OBJECT]={},p[z.GEOMETRY]={},p[z.MATERIAL]={},p[z.TEXTURE]={};var f=this._stageLayer,g=f.getId();if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle&&this._nodeId2Meta[e.id].engineObjectsPerBundle[t])return this._applyFilters(e),l.resolve();null==this._nodeId2Meta[e.id]&&(this._nodeId2Meta[e.id]={engineObjects:[],engineObjectsPerBundle:[]}),this._nodeId2Meta[e.id].engineObjectsPerBundle[t]=[];for(var y=0,m=this._hasColors,_=0,v=i;_<v.length;_++){for(var b=v[_],I=b.componentOffsets,x=b.geometries,M=b.featureIds,C=e.id+"|"+M[0],E=[],O=[],w=[],T=void 0,A=0,j=x;A<j.length;A++){var S=j[A],D=this._createEngineMat(S,s,o),F=a[y++];m=m||F.hasNonWhiteColors;var B=new P(new Float32Array(F.interleavedVertexData),F.layout,I||P.DefaultOffsets);T=F.corMatrices;var V=k.mat4d.create(T.localTrafo);if(null!=S.transformation){var L=S.transformation;k.mat4d.multiply(V,L,V)}var N=E.length,U=C+(N>0?"_"+N:""),q=new G(B,U);E.push(q),O.push(V),w.push([D]),this.memEstimateGeometryAdded(q.getData()),p[z.MATERIAL][D.getId()]=D,p[z.GEOMETRY][q.getId()]=q}var H={i3sNode:e.id,ceLayer:g,featureIds:M,attributeData:n?n.attributeData:null,loadedAttributes:n?n.loadedAttributes:null,layerUid:this.layer.uid},K=new R({idHint:e.id,name:C,geometries:E,materials:w,transformations:O,castShadow:!0,metadata:H}),Q=k.mat4d.create();k.mat4d.identity(Q),k.mat4d.multiply(Q,T.globalTrafo,Q),K.setObjectTransformation(Q),this._nodeId2Meta[e.id].engineObjectsPerBundle[t].push(K),this._nodeId2Meta[e.id].engineObjects.push(K),p[z.OBJECT][K.getId()]=K,this._setObjectSymbology(K),this._applyFilters(e),this._highlights.objectCreated(K),this.visibleGeometryChanged(K)}c.beginMod();var Y=p[z.OBJECT];for(var W in Y)Y.hasOwnProperty(W)&&f.addObject(Y[W]);for(var X in p)if(p.hasOwnProperty(X)){var J=p[X];for(var Z in J)if(J.hasOwnProperty(Z)){if(null!=c.get(X,Z))continue;c.add(X,J[Z])}}return c.endMod(),!this._hasTextures&&null!=e.textureData&&e.textureData.length>0&&(this._hasTextures=!0),this._hasColors=m,this._hasData=!0,this.notifyChange("hasTexturesOrVertexColors"),l.resolve()},t.prototype._clippingAreaChanged=function(){var e=this,t=[];if(S.extentToBoundingBox(this.view.clippingArea,t,this.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null,this._updateFilters(),this._controller){var r=this._controller.nodeIndex;r&&Object.keys(this._nodeId2Meta).forEach(function(t){return e._applyFilters(r[t])}),this._controller.updateClippingArea(this.view.clippingArea)}},t.prototype._filterChange=function(){if(this._updateFilters(),this._controller){var e=this._controller.nodeIndex;if(e)for(var t=0,r=Object.keys(this._nodeId2Meta);t<r.length;t++){var n=r[t];this._applyFilters(e[n])}}},t.prototype._updateFilters=function(){var e=this,t=[];if(this.layer.objectIdFilter){var r=new Float64Array(this.layer.objectIdFilter.ids),n="include"===this.layer.objectIdFilter.method;r.sort(),t.push(function(t,i){return e._objectIdFilter(r,n,i)})}if(this._controller&&this._controller.parsedDefinitionExpression&&this._controller.definitionExpressionFields){this._definitionExpressionErrors=0;var i=this._controller.parsedDefinitionExpression,a=this._controller.definitionExpressionFields;t.push(function(t,r){return e._sqlFilter(t,i,a,r)})}this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,e._clippingArea,r)}),this._filters=t},t.prototype._sqlFilter=function(e,t,r,n){var i={},a=new _(null,null,i);a.layer=this.layer;for(var o=this.layer.objectIdField,s=0,l=0,d=function(e){for(var d=q(e),h=d.featureIds,c=d.attributeData,p=r.every(function(e){return null!=c[e]||e===o}),f=0;f<h.length&&s<n.length;f++)if(n[s]===h[f]){var g=!0;if(p){i[o]=h[f];for(var y=0,m=r;y<m.length;y++){var _=m[y];_!==o&&(i[_]=x.getCachedAttributeValue(c[_],f))}g=u._evaluateClause(t,a)}g&&(n[l]=n[s],l++),s++}},u=this,h=0,c=this._nodeId2Meta[e.id].engineObjects;h<c.length;h++){var p=c[h];d(p)}n.length=l},t.prototype._evaluateClause=function(e,t){try{return e.testFeature(t)}catch(r){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&W.error("Error while evaluating definitionExpression: "+r),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&W.error("Further errors are ignored"),!1}},t.prototype._objectIdFilter=function(e,t,r){for(var n=0,i=0;n<r.length;){var a=o.binaryIndexOf(e,r[n])>=0;a===t&&(r[i]=r[n],i++),n++}r.length=i},t.prototype._boundingboxFilter=function(e,t,r){var n=[0,0,0,0];S.mbsToMbs(e.mbs,this._controller.crsIndex,n,this.view.renderSpatialReference);var i=null!=t?x.intersectBoundingBoxWithMbs(t,n):2;if(2!==i){if(0===i)return void(r.length=0);for(var a=0,o=0,s=0,l=this._nodeId2Meta[e.id].engineObjects;s<l.length;s++){var d=l[s],u=q(d).featureIds,h=d.getObjectTransformation(),c=d.getGeometryRecords()[0].getShaderTransformation();if(k.mat4d.multiply(h,c),0===h[1]&&0===h[2]&&0===h[3]&&0===h[4]&&0===h[6]&&0===h[7]&&0===h[8]&&0===h[9]&&0===h[11]&&1===h[15]){var p=ne;p[0]=(t[0]-h[12])/h[0],p[1]=(t[1]-h[13])/h[5],p[2]=(t[2]-h[14])/h[10],p[3]=(t[3]-h[12])/h[0],p[4]=(t[4]-h[13])/h[5],p[5]=(t[5]-h[14])/h[10];for(var f=d.getGeometryRecords()[0].geometry,g=f.getComponentCount(),y=0;g>y&&a<r.length;y++)if(r[a]===u[y]){var m=f.getComponentAABB(y,ie);D.intersects(p,m)&&(r[o]=r[a],o++),a++}}}r.length=o}},t.prototype._applyFilters=function(e){if(this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjects){for(var t=this._nodeId2Meta[e.id].engineObjects,r=0,n=t;r<n.length;r++){var i=n[r];i.unhideAllComponents()}if(0!==this._filters.length){for(var a=[],o=0,s=t;o<s.length;o++){var i=s[o];a=a.concat(q(i).featureIds)}for(var l=a.length,d=0;d<this._filters.length;d++)this._filters[d](e,a);if(a.length!==l)for(var u=0,h=0,c=t;h<c.length;h++)for(var i=c[h],p=i.getGeometryRecords()[0],f=q(i).featureIds,g=0;g<f.length;g++){var y=f[g];u>=a.length||a[u]!==y?i.setComponentVisibility(p,g,!1):u++}}}},t.prototype._removeAllNodeDataFromStage=function(){for(var e=0,t=Object.keys(this._nodeId2Meta);e<t.length;e++){var r=t[e];this._removeNodeDataFromStage(r)}},t.prototype._removeNodeDataFromStage=function(e){if(null!=this._nodeId2Meta[e]&&null!=this._nodeId2Meta[e].engineObjects){for(var t=this._stage,r=this._stageLayer,n=this._nodeId2Meta[e].engineObjects,i=0;i<n.length;++i){var a=n[i];this._highlights.objectDeleted(a),this.visibleGeometryChanged(a),r.removeObject(a);for(var o=a.getGeometryRecords(),s=0;s<o.length;s++){var l=o[s];this.memEstimateGeometryRemoved(l.geometry.getData()),t.remove(z.GEOMETRY,l.geometry.getId());for(var d=0;d<l.materials.length;d++){var u=l.materials[d],h=u.getId(),c=u.metadata.i3sMatId,p=u.metadata.i3sTexId||"none",f=this._matId2Meta[c][p];U.assert(f.refCount>0),f.refCount--,0===f.refCount&&this._removeMaterial(h,p,c,u,t)}}t.remove(z.OBJECT,a.getId())}delete this._nodeId2Meta[e]}},t.prototype._removeMaterial=function(e,t,r,n,i){if(i.remove(z.MATERIAL,e),"none"!==t){var a=this._texId2Meta[t],o=a.usedByEngineMats,s=o.indexOf(n);if(U.assert(s>-1),o[s]=o[o.length-1],o.pop(),o.length<1){var l=a.engineTex;l&&l!==this._whiteTexture&&(this.memEstimateTextureRemoved(l),i.remove(z.TEXTURE,a.engineTex.getId())),a.engineTex=void 0,delete this._texId2Meta[t]}}delete this._matId2Meta[r][t],U.objectEmpty(this._matId2Meta[r])&&delete this._matId2Meta[r]},t.prototype._setPolygonOffset=function(e,t){if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle)for(var r={polygonOffset:t},n=0;n<this._nodeId2Meta[e.id].engineObjectsPerBundle.length;n++)for(var i=this._nodeId2Meta[e.id].engineObjectsPerBundle[n],a=0;a<i.length;a++)for(var o=i[a].getGeometryRecords(),s=0;s<o.length;s++)for(var l=o[s].materials,d=0;d<l.length;d++)l[d].setParameterValues(r)},t.prototype._rendererChange=function(e){if(this._currentRenderer=e,e&&(e.colorInfo||e.sizeInfo)&&W.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead."),e)for(var t=0,r=e.getSymbols();t<r.length;t++){var n=r[t];"mesh-3d"!==n.type&&W.error("Symbols of type '"+n.type+"' are not supported for 3D Object Scene Services.")}},t.prototype._getRenderingInfo=function(e){var t=this._currentRenderer,r=t&&t.getSymbol(e);if(!(r instanceof v&&this._hasSymbolColors()))return null;var n,i,a={symbol:r};if(t&&t.visualVariables)for(var o=t.getVisualVariableValues(e),s=0;s<o.length;s++){var l=o[s],d=l.variable.type;"color"===d?n=l.value:"opacity"===d&&(i=l.value)}return n&&(a.color=[n.r/255,n.g/255,n.b/255]),null!=i?a.opacity=i:n&&null!=n.a&&(a.opacity=n.a),a},t.prototype._getSymbolFillMaterial=function(e,t){for(var r=0,n=e.symbolLayers.items;r<n.length;r++){var i=n[r];if("fill"===i.type){var a=i.material,o=null!=a?a.color:null;return null!=o?(oe[0]=o.r/255,oe[1]=o.g/255,oe[2]=o.b/255,oe[3]=o.a,t.color=oe):t.color=null,void(t.colorMixMode=null!=a?a.colorMixMode:null)}}t.color=null,t.colorMixMode=null},t.prototype._hasSymbolColors=function(){if(this._isIntegratedMesh()||!this.layer.store.defaultGeometrySchema)return!1;var e=this.layer.store.defaultGeometrySchema.featureAttributes;return e&&e.faceRange&&e.id},t.prototype._isIntegratedMesh=function(){return this.layer instanceof a},t.prototype._hasVertexColors=function(){return null!=this.layer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.layer.cachedDrawingInfo||!this.layer.cachedDrawingInfo.color)},t.prototype._setObjectSymbology=function(e){if(this._hasSymbolColors()){for(var t=q(e),r=t.featureIds?t.featureIds.length:1,n=new _(null,null,{}),i=n.attributes,a=this.layer.objectIdField,o=this._currentRenderer&&this._currentRenderer.requiredFields,s=e.geometryRecords[0].geometry,l=s.data.getAttribute(U.VertexAttrConstants.SYMBOLCOLOR),d=!1,u=new Uint8Array(4),h={color:null,colorMixMode:null},c=null,p=0;r>p;p++){if(null!=a&&null!=t.featureIds&&(i[a]=t.featureIds[p]),null!=o&&null!=t.attributeData)for(var f=0,g=o;f<g.length;f++){var y=g[f];null!=t.attributeData[y]&&(i[y]=x.getCachedAttributeValue(t.attributeData[y],p))}var m=this._getRenderingInfo(n);if(m){m.symbol!==c&&(c=m.symbol,this._getSymbolFillMaterial(m.symbol,h));var v=m.color,b=m.opacity;v=null==v||null==b?A.overrideColor(v,b,h.color,h.color&&h.color[3],X):A.overrideColor(v,b,null,null,X),v[3]<1&&(d=!0),x.encodeSymbolColor(v,h.colorMixMode,u)}else x.encodeSymbolColor(null,null,u);this._setComponentColor(s,p,l,u)}e.geometryColorAttrsUpdated(0);for(var I=e.getGeometryRecords(),M=0;M<I.length;M++)for(var C=I[M],E=0;E<C.materials.length;E++){var O=C.materials[E],w=O.getParams().transparent,T=O.getParams().opacity;O.metadata.symbolIsTransparent=d;var j=this._calcEngineMaterialTransparencyParams(O.metadata.i3sTex,O.metadata.i3sMatParams,O.metadata.symbolIsTransparent);(w!==j.transparent||T!==j.opacity)&&O.setParameterValues({transparent:j.transparent,opacity:j.opacity})}}},t.prototype._setComponentColor=function(e,t,r,n){var i=r.data,a=r.size,o=r.offsetIdx,s=r.strideIdx;U.assert(4===a);for(var l=e.data.componentOffsets[t],d=e.data.componentOffsets[t+1],u=o+l*s,h=o+d*s,c=u;h>c;c+=s)i[c]=n[0],i[c+1]=n[1],i[c+2]=n[2],i[c+3]=n[3]},t.prototype._elevationInfoChanged=function(){var e=this.layer.elevationInfo&&this.layer.elevationInfo.unit;e&&!f.supportsUnit(e)&&W.warn("elevationInfo.unit","'"+e+"' is not a valid unit")},t.prototype._reloadAll=function(){this._removeAllNodeDataFromStage(),null!=this._controller&&this._controller.restartNodeLoading()},t.prototype._opacityChange=function(e){for(var t in this._matId2Meta)for(var r in this._matId2Meta[t]){var n=this._matId2Meta[t][r].engineMat,i=n.getParams(),a=this._calcEngineMaterialTransparencyParams(n.metadata.i3sTex,n.metadata.i3sMatParams,n.metadata.symbolIsTransparent);
(i.transparent!==a.transparent||i.layerOpacity!==a.layerOpacity)&&n.setParameterValues(a)}},t.prototype.queryExtent=function(e){return this._ensureQueryEngine().queryExtent(e)},t.prototype.queryFeatureCount=function(e){return this._ensureQueryEngine().queryFeatureCount(e)},t.prototype.queryFeatures=function(e){return this._ensureQueryEngine().queryFeatures(e)},t.prototype.queryObjectIds=function(e){return this._ensureQueryEngine().queryObjectIds(e)},t.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},t.prototype._createQueryEngine=function(){var e=this,t={id:0,index:0,object:null,bbCorners:new Float64Array(24)};return new O({forAll:function(r,n){var i=function(n,i,a){t.id=n,t.index=i,t.object=a,e._boundingBoxCornerPoints(t.index,t.object,t.bbCorners),r(t)};e._forAllFeatures(i,n)},createGraphic:function(t){return e._createGraphic(t.index,q(t.object))},requestFields:function(t,r,n){var i=function(){var n=e._getGraphicIndices(t.node,t.bundleNr,r);return{node:t.node,indices:n}};return x.whenGraphicAttributes(e.layer,r,e._getObjectIdField(),n,i,{ignoreUnavailableFields:!1})},createExtentBuilder:function(){return e._createExtentBuilder()}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})},t.prototype._createExtentBuilder=function(){var e=this.view.renderSpatialReference,t=this.view.spatialReference,r=D.create(D.NEGATIVE_INFINITY),n=new Float64Array(24);return{add:function(i){S.bufferToBuffer(i.bbCorners,e,0,n,t,0,8)&&D.expandBuffer(r,n,0,8)},getExtent:function(){return D.toExtent(r,t)}}},t.prototype._forAllFeatures=function(e,t,r){for(var n=0,i=Object.keys(this._nodeId2Meta);n<i.length;n++)for(var a=i[n],o=this._nodeId2Meta[a].engineObjects,s=0;s<o.length;s++){var l=o[s];this._forAllFeaturesOfObject(l,e,r),t&&t({node:this._controller.nodeIndex[a],bundleNr:s})}},t.prototype._forAllFeaturesOfObject=function(e,t,r){for(var n=q(e).featureIds,i=e.getGeometryRecords()[0],a=0;a<n.length;a++)if(r||e.getComponentVisibility(i,a)){var o=n[a];t(o,a,e,i)}},t.prototype._createGraphic=function(e,t){var r={};if(null!=t.featureIds&&(r[this._getObjectIdField()]=t.featureIds[e]),null!=t.attributeData)for(var n=0,i=Object.keys(t.attributeData);n<i.length;n++){var a=i[n];r[a]=x.getCachedAttributeValue(t.attributeData[a],e)}var o=new _(null,null,r);return o.layer=this.layer,o},t.prototype._boundingBoxCornerPoints=function(e,t,r){for(var n=t.geometries[0].getComponentAABB(e,ne),i=0;8>i;++i)re[0]=1&i?n[0]:n[3],re[1]=2&i?n[1]:n[4],re[2]=4&i?n[2]:n[5],k.mat4d.multiplyVec3(t.objectTransformation,re),r[3*i]=re[0],r[3*i+1]=re[1],r[3*i+2]=re[2];return r},t.prototype.highlight=function(e,t){var r=this,n=this._highlights;if(e instanceof b){var i=n.acquireSet(t),a=i.set,o=i.handle;return this.queryObjectIds(e).then(function(e){return n.setFeatureIds(a,e)}),o}if("number"==typeof e)return this.highlight([e],t);if(e instanceof _)return this.highlight([e],t);if(e instanceof u&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof _){var s=e,l=s.map(function(e){return N.attributeLookup(e.attributes,r._getObjectIdField())}),d=n.acquireSet(t),h=d.set,o=d.handle;return n.setFeatureIds(h,l),o}if("number"==typeof e[0]){var l=e,c=n.acquireSet(t),h=c.set,o=c.handle;return n.setFeatureIds(h,l),o}}return{remove:function(){}}},t.prototype.visibleGeometryChanged=function(e){var t=this;e?this._elevationProvider.objectChanged(e):this._elevationProvider.layerChanged(),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=h.schedule(function(){t.emit("visible-geometry-changed"),t._visibleGeometryChangedSchedulerHandle=null}))},n([i.property()],t.prototype,"layer",void 0),n([i.property()],t.prototype,"_controller",void 0),n([i.property({dependsOn:["_controller.updating"]})],t.prototype,"updating",void 0),n([i.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],t.prototype,"updatingPercentageValue",void 0),n([i.property({readOnly:!0})],t.prototype,"hasTexturesOrVertexColors",null),n([i.property({readOnly:!0,dependsOn:["layer.renderer"]})],t.prototype,"rendererNeedsTextures",null),n([i.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],t.prototype,"elevationOffset",null),n([i.property()],t.prototype,"alwaysLoadEverythingModeEnabled",void 0),n([i.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","_useCompressedTextures"]})],t.prototype,"uncompressedTextureDownsamplingEnabled",null),n([i.property({dependsOn:["layer.version"]})],t.prototype,"_useCompressedTextures",null),t=n([i.subclass("esri.views.3d.layers.SceneLayerView3D")],t)}(i.declared(I,j)),re=k.vec3d.create(),ne=D.create(),ie=D.create(),ae=k.vec4d.create(),oe=[0,0,0,0];return te});