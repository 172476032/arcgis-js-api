// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessorSupport/decorators","../../../core/HandleRegistry","../../../core/watchUtils","../../../core/promiseUtils","../../../core/screenUtils","../../../request","../../layers/LayerView","../support/projectionUtils","../support/orientedBoundingBox","./support/LayerViewUpdatingPercentage","../lib/glMatrix","./i3s/I3SBinaryReader","./i3s/I3SUtil","./i3s/PointRenderer","./i3s/PagedNodeIndex","./i3s/LoDUtil","./i3s/LEPCC","dojo/Deferred","dojo/promise/all","dojo/errors/CancelError","../webgl-engine/lib/RenderSlot"],function(e,r,t,n,i,o,d,a,s,u,l,p,h,c,f,_,y,g,v,m,b,x,w,N,P){function S(e,r){void 0===r&&(r="RGB");for(var t=0;t<e.length;t++){var n=e[t];if(n.name===r&&null!=n.attributeValues&&"UInt8"===n.attributeValues.valueType&&3===n.attributeValues.valuesPerElement)return n}return null}function C(e,r){for(var t=0;t<e.length;t++){var n=e[t];if(n.name===r)return n}return null}function R(e){var r=[];return e.forEach(function(e){return r.push(e)}),r}function k(e){var r=null,t=e.renderer,n=!1;t&&"pointCloudUniqueValueRenderer"===t.type?r=C(e.attributeStorageInfo,t.field):t&&"pointCloudStretchRenderer"===t.type?r=C(e.attributeStorageInfo,t.field):t&&"pointCloudClassBreaksRenderer"===t.type?r=C(e.attributeStorageInfo,t.field):t&&"pointCloudRGBRenderer"===t.type?(r=S(e.attributeStorageInfo,t.field),n=null!=r):(r=S(e.attributeStorageInfo),n=null!=r);var i=null!=r?"embedded-elevation"===r.encoding:t&&"elevation"===t.field.toLowerCase();return i&&(r=null),{renderer:t,attributeInfo:r,useElevation:i,isRGBAttribute:n}}function V(e,r,t,n){var i=e.renderer,o=e.attributeInfo,d=e.useElevation,a=e.isRGBAttribute,s=d?B(t):r&&_.readBinaryAttribute(o,r,n);if(r&&a)return s;if(r&&i&&"pointCloudUniqueValueRenderer"===i.type){for(var u=i.colorUniqueValueInfos,l=new Uint8Array(3*n),p=F(i.fieldTransformType),h=0;n>h;h++)for(var c=p?p(s[h]):s[h],f=c+"",y=0;y<u.length;y++)if(u[y].values.indexOf(f)>=0){l[3*h]=u[y].color.r,l[3*h+1]=u[y].color.g,l[3*h+2]=u[y].color.b;break}return l}if((r||d)&&i&&"pointCloudStretchRenderer"===i.type){for(var g=i.stops,l=new Uint8Array(3*n),p=F(i.fieldTransformType),h=0;n>h;h++){var c=p?p(s[h]):s[h],v=g.length-1;if(c<g[0].value)l[3*h]=g[0].color.r,l[3*h+1]=g[0].color.g,l[3*h+2]=g[0].color.b;else if(c>=g[v].value)l[3*h]=g[v].color.r,l[3*h+1]=g[v].color.g,l[3*h+2]=g[v].color.b;else for(var y=1;y<g.length;y++)if(c<g[y].value){var m=(c-g[y-1].value)/(g[y].value-g[y-1].value);l[3*h]=g[y].color.r*m+g[y-1].color.r*(1-m),l[3*h+1]=g[y].color.g*m+g[y-1].color.g*(1-m),l[3*h+2]=g[y].color.b*m+g[y-1].color.b*(1-m);break}}return l}if((r||d)&&i&&"pointCloudClassBreaksRenderer"===i.type){for(var b=i.colorClassBreakInfos,l=new Uint8Array(3*n),p=F(i.fieldTransformType),h=0;n>h;h++)for(var c=p?p(s[h]):s[h],y=0;y<b.length;y++)if(c>=b[y].minValue&&c<=b[y].maxValue){l[3*h]=b[y].color.r,l[3*h+1]=b[y].color.g,l[3*h+2]=b[y].color.b;break}return l}return null}function z(e){var r=e&&e.pointSizeAlgorithm;return r&&"splat"===r.type?r:null}function A(e){var r=e&&e.pointSizeAlgorithm;return r&&"fixed-size"===r.type?r:null}function I(e){var r=e&&e.pointSizeAlgorithm;return r&&r.type?"fixed-size"===r.type:!1}function B(e){for(var r=e.length/3,t=new Float64Array(r),n=0;r>n;n++)t[n]=e[3*n+2];return t}function F(e){return null==e||"none"===e?null:"low-four-bit"===e?function(e){return 15&e}:"high-four-bit"===e?function(e){return(240&e)>>4}:"absolute-value"===e?function(e){return Math.abs(e)}:"modulo-ten"===e?function(e){return e%10}:null}var Q=8,O=8,W=f.vec4d.create(),L=function(e){function r(){var r=null!==e&&e.apply(this,arguments)||this;return r.maximumPointCount=4e6,r._renderer=null,r._rendererAdded=!1,r._renderedNodes=new Set,r._updateViewNeeded=!0,r._idleUpdatesEnabled=!0,r._lodFactor=1,r._handles=new o,r._indexQueue=[],r._workQueue=[],r._idleQueue=[],r._indexPagesLoading=new Map,r._loadingNodes=new Map,r._totalWork=0,r._index=null,r._nodeIdArray=[],r}return t(r,e),Object.defineProperty(r.prototype,"pointScale",{get:function(){var e=z(this.layer.renderer),r=1;return e&&null!=e.scaleFactor?e.scaleFactor:r},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pointMinSize",{get:function(){var e=z(this.layer.renderer),r=4;return e&&null!=e.minSize?e.minSize:r},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"useRealWorldSymbolSizes",{get:function(){var e=A(this.layer.renderer),r=!1;return e&&null!=e.useRealWorldSymbolSizes?e.useRealWorldSymbolSizes:r},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"pointSize",{get:function(){var e=A(this.layer.renderer),r=0;return e&&null!=e.size?e.size:r},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"inverseDensity",{get:function(){var e=96;return this.layer.renderer?1*e/this.layer.renderer.pointsPerInch:5},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"_clippingBox",{get:function(){var e=[];return p.extentToBoundingBox(this.view.clippingArea,e,this.view.renderSpatialReference)?e:null},enumerable:!0,configurable:!0}),r.prototype.initialize=function(){var e=this;y.checkPointCloudLayerValid(this.layer),y.checkPointCloudLayerCompatibleWithView(this.layer,this.view),this._initRenderer();var r=this._initNodePages(),t={idleBegin:function(){return e._idleBegin()},idleEnd:function(){return e._idleEnd()},needsUpdate:function(){return!0},idleFrame:function(r){return e._idleFrame(r)}};r.then(function(){e._handles.add(d.init(e,"suspended",function(r){r?e.view.resourceController.deregisterIdleFrameWorker(e):e.view.resourceController.registerIdleFrameWorker(e,t)}))}),this._handles.add(d.init(this,"_clippingBox",function(){return e._updateViewNeeded=!0})),this._handles.add(d.init(this.layer,"renderer",function(){return e._rendererChanged()})),this.addResolvingPromise(r)},r.prototype.destroy=function(){this.view.resourceController.deregisterIdleFrameWorker(this),this._handles.destroy(),this._destroyRenderer()},r.prototype._initRenderer=function(){var e=this;this._renderer=new g,this._handles.add(d.init(this.layer,"id",function(r){e._renderer.layerId=r})),this._handles.add(d.init(this,"_clippingBox",function(r){e._renderer.clippingBox=r})),this._handles.add(d.init(this,"suspended",function(r){e._setPointsVisible(!r)})),this._handles.add(d.init(this,"pointScale",function(r){e._renderer.scaleFactor=r})),this._handles.add(d.init(this,"pointMinSize",function(r){var t=s.pt2px(r);e._renderer.minSizePx=t})),this._handles.add(d.init(this,"useRealWorldSymbolSizes",function(r){e._renderer.useRealWorldSymbolSizes=r})),this._handles.add(d.init(this,"pointSize",function(r){var t=s.pt2px(r);e._renderer.size=r,e._renderer.sizePx=t})),this._handles.add(d.init(this,["inverseDensity","maximumPointCount"],function(){e._updateViewNeeded=!0})),this._handles.add(d.init(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",function(r){e._lodFactor=r,e._updateViewNeeded=!0}))},r.prototype._destroyRenderer=function(){this._setPointsVisible(!1)},r.prototype._setPointsVisible=function(e){e&&!this._rendererAdded?(this.view._stage.addExternalRenderer([P.OPAQUE_EXTERNAL],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeExternalRenderer(this._renderer),this._rendererAdded=!1)},r.prototype._rendererChanged=function(){var e=this;this._renderedNodes.forEach(function(r){return e._removeFromRenderer(r)}),this._updateViewNeeded=!0,this._renderer.useFixedSizes=I(this.layer.renderer)},r.prototype.displayNodes=function(e){this.cancelLoading(),this._workQueue=m.nodeDiff(R(this._renderedNodes),e,this._index),m.sortFrontToBack(this._workQueue,this.view._stage.getCamera().viewForward,this._index),this._totalWork=this._computeWork(),this._updateLoading()},r.prototype.cancelLoading=function(){var e=[];this._loadingNodes.forEach(function(r){return e.push(r)}),this._loadingNodes.clear();for(var r=0,t=e;r<t.length;r++){var n=t[r];n.cancel()}this._totalWork=0,this._updateLoading()},r.prototype._idleBegin=function(){this._idleUpdatesEnabled&&(this._updateViewNeeded=!1,this.updateViewWhenIdle())},r.prototype._idleEnd=function(){this.cancelLoading()},r.prototype._idleFrame=function(e){if(this._idleUpdatesEnabled){for(this._updateViewNeeded&&!e.done()&&(this._updateViewNeeded=!1,this.updateViewWhenIdle());this._indexQueue.length>0&&!e.done();)this._processIndexQueue();for(;this._workQueue.length>0&&this._canSchedule(this._workQueue[0])&&!e.done();)this._processWorkQueue();for(;this._idleQueue.length>0&&!e.done();){var r=this._idleQueue.shift();r.resolve()}}},r.prototype._schedule=function(){var e=new x;return this._idleQueue.push(e),e.promise},r.prototype._processIndexQueue=function(){var e=this,r=this._indexQueue.shift();this._indexPagesLoading.set(r,this._loadNodePage(r)),this._indexPagesLoading.get(r).then(function(t){e._index.addPage(r,t),e._updateViewNeeded=!0}).always(function(){e._indexPagesLoading["delete"](r)})},r.prototype._canSchedule=function(e){if(this._loadingNodes.size>=O)return!1;for(var r=0;r<e.remove.length;r++)if(!this._renderedNodes.has(e.remove[r]))return!1;return!0},r.prototype._processWorkQueue=function(){var e=this,r=this._workQueue.shift();if(0!==r.load.length){var t=r.load.length>Q&&1===r.remove.length;if(t){var n=m.splitWorkEntry(r,this._index);r=n[0];for(var i=1;i<n.length;i++)this._workQueue.push(n[i])}w(r.load.map(function(r){return e._loadingNodes.has(r)||e._loadingNodes.set(r,e.loadNode(r)),e._loadingNodes.get(r)})).then(function(t){for(var n=0;n<r.load.length;n++)e._addToRenderer(r.load[n],t[n]);for(var n=0;n<r.remove.length;n++)e._removeFromRenderer(r.remove[n])}).always(function(){for(var t=0;t<r.load.length;t++)e._loadingNodes["delete"](r.load[t]);e._updateLoading()}),this._updateLoading()}else for(var i=0;i<r.remove.length;i++)this._removeFromRenderer(r.remove[i])},r.prototype._computeWork=function(){for(var e=0,r=0;r<this._workQueue.length;r++)e+=this._workQueue[r].load.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._updateViewNeeded?100:0},Object.defineProperty(r.prototype,"updating",{get:function(){var e=this._computeWork();return e>0},enumerable:!0,configurable:!0}),Object.defineProperty(r.prototype,"updatingPercentageValue",{get:function(){var e=this._computeWork();return 100*Math.max(0,this._totalWork-e)/this._totalWork},enumerable:!0,configurable:!0}),r.prototype._updateLoading=function(){this.notifyChange("updating"),this.notifyChange("updatingPercentageValue")},r.prototype._initNodePages=function(){var e=this;return this._index=new v(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,this.layer.store.index.nodePerIndexBlock),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadNodePage(0).then(function(r){e._index.addPage(0,r)})},r.prototype._loadNodePage=function(e){var r=e*this._index.pageSize,t=this.layer.parsedUrl.path+"/nodepages/"+r;return this._requestJSON(t).then(function(e){return e.data.nodes})},r.prototype.updateViewWhenIdle=function(){for(var e=this.inverseDensity/this._lodFactor,r=this.maximumPointCount*this._lodFactor,t=this._computeNodesForMinimumDensity(e),n=this._computePointCount(t),i=Math.sqrt(n/(.75*r));n>r;)e*=i,t=this._computeNodesForMinimumDensity(e),n=this._computePointCount(t),i=Math.sqrt(2);this.displayNodes(t)},r.prototype._computePointCount=function(e){for(var r=0,t=0;t<e.length;t++){var n=this._index.getNode(e[t]);n&&(r+=n.pointCount)}return r},r.prototype._computeNodesForMinimumDensity=function(e){var r=this,t=this.view._stage.getCamera(),n=t.frustumPlanes,i=this._clippingBox,o=t.viewForward,d=f.vec3d.dot(o,t.eye),a=f.vec4d.set4(o[0],o[1],o[2],-d,W),s=t.perPixelRatio,u=e*e,l=this._nodeIdArray;return l.length=0,this._traverseVisible({frustumPlanes:n,clippingBox:i},{predicate:function(e,t,n){if(!n)return!1;if(0===t.childCount)return l.push(e),!1;var i=r._index.getRenderObb(e),o=r._computeAveragePixelArea(i,t.effectiveArea,t.pointCount,a,s);return u>=o?(l.push(e),!1):!0},pageMiss:function(e,t){l.push(e),r._indexQueue.indexOf(t)<0&&r._indexQueue.push(t)}}),l},r.prototype._computeAveragePixelArea=function(e,r,t,n,i){var o=1e-7,d=Math.max(o,h.minimumDistancePlane(e,n)),a=r/(d*d)/(4*i*i);return a/t},r.prototype.loadNode=function(e){var r=this,t=this._index.getNode(e),n=k(this.layer),i=null,o=null;return this._schedule().then(function(){var d=null!=t.resourceId?t.resourceId:e;return i=r.loadGeometry(d),n.attributeInfo&&(o=r.loadAttribute(d,n.attributeInfo)),w([i,o])}).then(function(e){var i=e[0],o=e[1],d=r.layer.store.defaultGeometrySchema,a=r.readGeometry(d,i),s=V(n,o,a,t.pointCount);return r._schedule().then(function(){return{positions:a,rgb:s}})}).then(function(t){var n=t.positions,i=t.rgb,o=f.vec3.create(r._index.getRenderCenter(e)),d=r._transformCoordinates(n,o),a={origin:d.origin,points:d.points,rgb:i};return a}).otherwise(function(e){return e instanceof N&&(i&&i.cancel(),o&&o.cancel()),a.reject(e)})},r.prototype.readGeometry=function(e,r){if(null==e.encoding||""===e.encoding){for(var t=_.createGeometryDataIndex(r,e,!1),n=_.createTypedView(r,t.vertexAttributes.position),i=t.header.fields,o=[i.offsetX,i.offsetY,i.offsetZ],d=[i.scaleX,i.scaleY,i.scaleZ],a=n.length/3,s=new Float64Array(3*a),u=0;a>u;u++)s[3*u]=n[3*u]*d[0]+o[0],s[3*u+1]=n[3*u+1]*d[1]+o[1],s[3*u+2]=n[3*u+2]*d[2]+o[2];return s}return"lepcc-xyz"===e.encoding?b.decodeXYZ(r).result:void 0},r.prototype.loadGeometry=function(e){var r=this.layer.parsedUrl.path+"/nodes/"+e+"/geometries/0";return this._requestBinary(r).then(function(e){return e.data})},r.prototype.loadAttribute=function(e,r){var t=this.layer.parsedUrl.path+"/nodes/"+e+"/attributes/"+r.key;return this._requestBinary(t).then(function(e){return e.data})},r.prototype._requestJSON=function(e){return u(e,{query:{f:"json",token:this.layer.token},responseType:"json"})},r.prototype._requestBinary=function(e){return u(e,{query:{token:this.layer.token},responseType:"array-buffer"})},r.prototype._removeFromRenderer=function(e){this._renderedNodes.has(e)&&(this._renderer.removeNode(""+e),this._renderedNodes["delete"](e))},r.prototype._addToRenderer=function(e,r){if(!this._renderedNodes.has(e)){this._renderedNodes.add(e);var t=this._index.getNode(e),n=this._index.getRenderObb(e),i=Math.sqrt(t.effectiveArea/t.pointCount),o=r.rgb;if(null==o){o=new Uint8Array(3*t.pointCount);for(var d=0;d<o.length;d++)o[d]=255}this._renderer.addNode({id:""+e,coordinates:r.points,origin:r.origin,splatSize:i,rgb:o,obb:n})}},r.prototype._transformCoordinates=function(e,r){var t=e.length/3,n=this.layer.spatialReference,i=this.view.renderCoordsHelper.spatialReference;if(!p.bufferToBuffer(e,n,0,e,i,0,t))throw Error("Can't reproject");for(var o=new Float32Array(3*t),d=0;t>d;d++)o[3*d]=e[3*d]-r[0],o[3*d+1]=e[3*d+1]-r[1],o[3*d+2]=e[3*d+2]-r[2];return{points:o,origin:r}},r.prototype.getStats=function(){var e=this;return{"Rendered Nodes":this._renderedNodes.size,"Rendered Points":R(this._renderedNodes).reduce(function(r,t){return r+e._index.getNode(t).pointCount},0),"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length}},r}(i.declared(l,c));return n([i.property()],L.prototype,"view",void 0),n([i.property()],L.prototype,"layer",void 0),n([i.property({readOnly:!0,dependsOn:["layer.renderer"]})],L.prototype,"pointScale",null),n([i.property({readOnly:!0,dependsOn:["layer.renderer"]})],L.prototype,"pointMinSize",null),n([i.property({readOnly:!0,dependsOn:["layer.renderer"]})],L.prototype,"useRealWorldSymbolSizes",null),n([i.property({readOnly:!0,dependsOn:["layer.renderer"]})],L.prototype,"pointSize",null),n([i.property({readOnly:!0,dependsOn:["layer.renderer"]})],L.prototype,"inverseDensity",null),n([i.property()],L.prototype,"maximumPointCount",void 0),n([i.property({readOnly:!0,dependsOn:["view.clippingArea"]})],L.prototype,"_clippingBox",null),n([i.property()],L.prototype,"updating",null),n([i.property()],L.prototype,"updatingPercentageValue",null),L=n([i.subclass("esri.views.3d.layers.PointCloudLayerView3D")],L)});