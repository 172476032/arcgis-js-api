// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../geometry","../../../Graphic","../../../core/Collection","../../../core/Handles","../../../core/Logger","../../../core/promiseUtils","../../../core/watchUtils","../../../core/accessorSupport/decorators","../../../geometry/support/contains","../../../renderers/support/renderingInfoUtils","./LayerView3D","./graphics/Graphics3DLayerViewCore","./i3s/I3SQueryEngine","./i3s/I3SUtil","./support/LayerViewUpdatingPercentage","../lib/glMatrix","../support/aaBoundingBox","../support/PreallocArray","../support/projectionUtils"],function(e,t,r,n,i,o,a,s,d,l,u,p,h,c,g,f,y,_,v,b,E,m,I){function x(e,t){return e.xmin-=t,e.ymin-=t,e.xmax+=t,e.ymax+=t,e.hasZ&&(e.zmin-=t,e.zmax+=t),e.hasM&&(e.mmin-=t,e.mmax+=t),e}var A=d.getLogger("esri.views.3d.layers.SceneLayerGraphicsView3D"),C=function(e){function t(t){var r=e.call(this)||this;return r._queryEngine=null,r.supportsHeightUnitConversion=!0,r._isUpdating=!1,r._definitionExpressionErrors=0,r._maxDefinitionExpressionErrors=20,r._nodesAddedToStage={},r.loadedGraphics=new a,r.supportsDraping=!0,r._overlayUpdating=null,r._controllerCreated=!1,r._handles=new s,r}return r(t,e),t.prototype.initialize=function(){var e=this;_.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode),this._handles.add([u.init(this.layer,"rangeInfos",function(t){return e._rangeInfosChanged(t)}),this.layer.watch("renderer",function(t,r){return e._rendererChange(t,r)}),this.layer.watch("objectIdFilter",function(){return e._objectIdFilterChange()}),this.watch("_controller.parsedDefinitionExpression",function(){return e._definitionExpressionChange()})]),this._layerViewCore=new f({owner:this,layer:this.layer,spatialIndexRequired:!1,labelingEnabled:!0,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,verticalScaleEnabled:this.supportsHeightUnitConversion,highlightsEnabled:!0,updateSuspendResumeExtent:function(){return e._updateSuspendResumeExtent()},updateClippingExtent:function(t){return e._updateClippingExtent(t)},getGraphicsInExtent:function(t,r,n){return e._getGraphicsInExtent(t,r,n)}}),this.addResolvingPromise(this._layerViewCore.initialize()),this.drawingOrder=this.view.getDrawingOrder(this.layer.uid),this._createController()},t.prototype.destroy=function(){this._layerViewCore&&(this._layerViewCore.destroy(),this._layerViewCore=null),this._controller&&(this._controller.destroy(),this._controller=null),this._elevationUpdateNodes=null,this._intersectingGraphicIds=null,this._nodesAddedToStage=null,this._handles&&(this._handles.destroy(),this._handles=null)},Object.defineProperty(t.prototype,"hasDraped",{get:function(){return this._layerViewCore.graphicsCore.hasDraped},enumerable:!0,configurable:!0}),t.prototype.whenGraphicAttributes=function(e,t){var r=this,n=function(){var t=r._findGraphicNodeAndIndex(e);return{node:t.node,indices:[t.index]}};return _.whenGraphicAttributes(this.layer,[e],this._getObjectIdField(),t,n,{ignoreUnavailableFields:!0,populateObjectId:!0}).then(function(e){return e[0]})},t.prototype.getGraphicsFromStageObject=function(e,t){if(!this.loadedGraphics)return l.reject();var r=e.getMetadata().graphicId,n=this.loadedGraphics.find(function(e){return e.uid===r}),i=this._getObjectIdField();return n&&n.attributes&&n.attributes[i]?l.resolve(n):l.reject()},t.prototype.whenGraphicBounds=function(e,t){return this._layerViewCore.graphicsCore.whenGraphicBounds(e,t)},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return!(!this._isUpdating&&this._controllerCreated)||!(!this._controller||!this._controller.updating)},t.prototype.getRenderingInfo=function(e){var t=c.getRenderingInfo(e,{renderer:this.layer.renderer});if(t&&t.color){var r=t.color;r[0]=r[0]/255,r[1]=r[1]/255,r[2]=r[2]/255}return t},t.prototype.getSymbolUpdateType=function(){return this._layerViewCore.graphicsCore.getSymbolUpdateType()},t.prototype._findGraphicNodeAndIndex=function(e){for(var t=e.attributes[this.layer.objectIdField],r=0,n=Object.keys(this._nodesAddedToStage);r<n.length;r++)for(var i=n[r],o=this._nodesAddedToStage[i].bundles,a=0;a<o.length;a++){var s=this._findGraphicIndex(o[a],t);if(s>=0)return{node:this._controller.nodeIndex[i],nodeId:i,bundleNr:a,index:s}}return null},t.prototype._forAllFeatures=function(e,t){for(var r=0,n=Object.keys(this._nodesAddedToStage);r<n.length;r++)for(var i=n[r],o=this._nodesAddedToStage[i],a=o.bundles,s=0;s<a.length;s++){for(var d=a[s],l=0;l<d.length;l++)for(var u=d[l].graphics,p=0;p<u.length;p++){var h=u[p],c=d[l].featureIds[p];h.visible&&e(c,l,h)}null!=t&&t({nodeId:i,bundleNr:s})}},t.prototype._getGraphicIndices=function(e,t,r){for(var n=this._nodesAddedToStage[e],i=n.bundles[t],o=this._getObjectIdField(),a=[],s=0,d=r;s<d.length;s++){var l=d[s],u=l.attributes[o],p=this._findGraphicIndex(i,u);p>=0&&a.push(p)}return a},t.prototype._findGraphicIndex=function(e,t){for(var r=0;r<e.length;r++)for(var n=0,i=e[r].featureIds;n<i.length;n++){var o=i[n];if(o===t)return r}return-1},t.prototype._getGraphicsInExtent=function(e,t,r){E[2]=-1/0,E[3]=1/0;var n=E.fromRect(S,e),i=t;null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new m(10));var o=this._elevationUpdateNodes;o.clear(),this._controller&&this._controller.updateElevationChanged(n,i,o);var a=o.length;this._intersectingGraphicIds||(this._intersectingGraphicIds=new m(10));var s=this._intersectingGraphicIds;s.clear();for(var d=0;d<a;d++){var l=o.data[d],u=this._nodesAddedToStage[l.id];if(null!=u)for(var p=u.bundles,h=0;h<p.length;h++)for(var c=p[h],g=0;g<c.length;g++)for(var f=c[g].graphics,y=0;y<f.length;y++)s.push(f[y].uid)}r(this._intersectingGraphicIds.data,this._intersectingGraphicIds.length)},t.prototype._evaluateUpdatingState=function(){var e=!1;if(this._layerViewCore.elevationAlignment){var t=0;t+=this._layerViewCore.elevationAlignment.numNodesUpdating(),t+=this._layerViewCore.graphicsCore.numNodesUpdating();var r=!this._controllerCreated||this._overlayUpdating||this._layerViewCore.graphicsCore.needsIdleUpdate();e=t>0||r}this._isUpdating!==e&&(this._isUpdating=e,this.notifyChange("updating"))},t.prototype._notifySuspendedChange=function(){},t.prototype._notifyDrapedDataChange=function(){this.notifyChange("hasDraped"),this.emit("draped-data-change")},t.prototype.highlight=function(e,t){return this._layerViewCore.highlight(e,t,this.layer.objectIdField)},t.prototype._createController=function(){var e=this,t={addBundle:function(t,r){return e._addBundle(t,r)},isBundleLoaded:function(t){return e._isBundleLoaded(t)},getMemoryUsage:function(){return e.view.resourceController.getUsedMemory()},removeNodeData:function(t){return e._removeNodeData(t)},getAddedNodeIDs:function(){return e._getAddedNodeIDs()}},r={traversalOptions:{errorMetricPreference:["distanceRangeFromDefaultCamera","screenSpaceRelative"]},getLoadedAttributes:function(t){return e._getLoadedAttributes(t)},getAttributeData:function(t){return e._getAttributeData(t)},setAttributeData:function(t,r,n){return e._setAttributeData(t,r,n)}};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:t,layerViewOptionalFunctions:r}).then(function(t){e._controller=t,t.watch("rootNodeVisible",function(){e.notifyChange("suspended")})}).always(function(){e._controllerCreated=!0,e._evaluateUpdatingState()})},t.prototype._addBundle=function(e,t){var r=t.allGeometryData,n=t.attributeDataInfo,a=[],s=this._controller.crsIndex,d=this.view.spatialReference,u=[0,0,0],p=this._getObjectIdField();e.memory=0,null==this._nodesAddedToStage[e.id]&&(this._nodesAddedToStage[e.id]={bundles:[],attributeData:n?n.attributeData:null,loadedAttributes:n?n.loadedAttributes:null}),this._nodesAddedToStage[e.id].bundles[0]=a;var c;if(this.layer.objectIdFilter){var g=this.layer.objectIdFilter.ids,f="include"===this.layer.objectIdFilter.method;c=function(e){return g.indexOf(e)>=0===f}}for(var y=this.layer.fullExtent&&x(this.layer.fullExtent.clone(),.5),_=[],v=0;v<r.length;v++){var b=r[v],E=b.featureDataPosition,m=E.length,C=b.geometries||[w[m]],S=b.featureIds;y&&!h.extentContainsCoords3D(y,E)&&A.error("Service Error: Coordinates outside of layer extent");for(var D=0;D<C.length;D++){var G=C[D],F=[],N=D<S.length?D:0,U=S[N],T={};if(null!=U){if(c&&!c(U))continue;T[p]=U}var j=G.params.type,V=void 0;if("Embedded"===G.type&&(V=G.params.vertexAttributes.position),"lines"===j){for(var O=[],R=0;R<V.length;R+=m)O.push([V[R]+e.mbs[0],V[R+1]+e.mbs[1]]);var q=new i.Polyline(s);q.addPath(O),F.push(new o(q,null,T)),e.memory+=16*V.length/1048576}else if("points"===j)for(var R=0;R<V.length;R+=m){for(var L=0;L<m;L++)u[L]=E[L]+V[R+L];var B=I.vectorToPoint(u,s,d);m<3&&(B.z=void 0),F.push(new o(B,null,T)),e.memory+=12*V.length/1048576}for(var M=0,P=F;M<P.length;M++){var k=P[M];k.layer=this.layer,k.sourceLayer=this.layer}_.push.apply(_,F),a.push({featureIds:b.featureIds,graphics:F})}}this.loadedGraphics.addMany(_);var Q=this._nodesAddedToStage[e.id];return this._setBundleAttributes(Q.bundles[0],Q.loadedAttributes,Q.attributeData),this._filterNode(Q),l.resolve()},t.prototype._isBundleLoaded=function(e){return null!=this._nodesAddedToStage[e.id]&&null!=this._nodesAddedToStage[e.id].bundles[0]},t.prototype._removeNodeData=function(e){var t=this._nodesAddedToStage[e.id];if(null!=t){var r=t.bundles,n=[];for(var i in r)for(var o in r[i])n.push.apply(n,r[i][o].graphics);this.loadedGraphics.removeMany(n),delete this._nodesAddedToStage[e.id]}},t.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodesAddedToStage)},t.prototype._getLoadedAttributes=function(e){var t=this._nodesAddedToStage[e.id];if(t)return t.loadedAttributes},t.prototype._getAttributeData=function(e){var t=this._nodesAddedToStage[e.id];if(t)return t.attributeData},t.prototype._setAttributeData=function(e,t,r){var n=this._nodesAddedToStage[e.id];n&&(n.loadedAttributes=t,n.attributeData=r,this._setNodeAttributes(n,t,r),this._filterNode(n),this._layerViewCore.labeling.layerLabelsEnabled()&&this._layerViewCore.labeling.updateLabelingInfo())},t.prototype._setNodeAttributes=function(e,t,r){var n=e.bundles;for(var i in n){var o=n[i];this._setBundleAttributes(o,t,r)}},t.prototype._setBundleAttributes=function(e,t,r){for(var n=0;n<e.length;n++)for(var i=e[n],o=0,a=i.graphics;o<a.length;o++){var s=a[o];if(s.attributes||(s.attributes={}),t)for(var d=0,l=t;d<l.length;d++){var u=l[d].name;r[u]&&(s.attributes[u]=_.getCachedAttributeValue(r[u],n))}}},t.prototype._updateSuspendResumeExtent=function(){if(this.layer.fullExtent){this._suspendResumeExtent||(this._suspendResumeExtent=b.vec4d.create());var e=this.layer.fullExtent;I.extentToBoundingRect(e,this._suspendResumeExtent,this.view.spatialReference)||(this._suspendResumeExtent=null)}else this._suspendResumeExtent=null;return this._suspendResumeExtent},t.prototype._updateClippingExtent=function(e){return this._controller&&this._controller.updateClippingArea(e),!1},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._rendererChange=function(e,t){var r=e?e.requiredFields:[],n=t?t.requiredFields:[];r.length===n.length&&r.every(function(e,t){return r[t]===n[t]})||this._reloadAllNodes()},t.prototype._rangeInfosChanged=function(e){null!=e&&e.length>0&&A.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")},t.prototype._objectIdFilterChange=function(){this._reloadAllNodes()},t.prototype._reloadAllNodes=function(){var e=this;Object.keys(this._nodesAddedToStage).forEach(function(t){e._removeNodeData({id:t})}),this._controller&&this._controller.restartNodeLoading()},t.prototype._definitionExpressionChange=function(){this._definitionExpressionErrors=0},t.prototype._evaluateClause=function(e,t){try{return!!e.calculateValue(t)}catch(e){return this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&A.error("Error while evaluating definitionExpression: "+e),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&A.error("Further errors are ignored"),!1}},t.prototype._filterNode=function(e){var t=this._controller.parsedDefinitionExpression;for(var r in e.bundles)for(var n=e.bundles[r],i=0,o=n;i<o.length;i++)for(var a=o[i],s=0,d=a.graphics;s<d.length;s++){var l=d[s];l.visible=null==t||this._evaluateClause(t,l)}},t.prototype.queryExtent=function(e){return this._ensureQueryEngine().queryExtent(e)},t.prototype.queryFeatureCount=function(e){return this._ensureQueryEngine().queryFeatureCount(e)},t.prototype.queryFeatures=function(e){var t=this;return this._ensureQueryEngine().queryFeatures(e).then(function(e){for(var r=0,n=e.features;r<n.length;r++){var i=n[r];i.layer=t.layer,i.sourceLayer=t.layer}return e})},t.prototype.queryObjectIds=function(e){return this._ensureQueryEngine().queryObjectIds(e)},t.prototype._ensureQueryEngine=function(){return this._queryEngine||(this._queryEngine=this._createQueryEngine()),this._queryEngine},t.prototype._createQueryEngine=function(){var e=this,t={id:0,index:0,graphic:null};return new y({forAll:function(r,n){function i(e,n,i){t.id=e,t.index=n,t.graphic=i,r(t)}e._forAllFeatures(i,n)},createGraphic:function(e){return e.graphic.clone()},requestFields:function(t,r,n){var i=function(){var n=e._getGraphicIndices(t.nodeId,t.bundleNr,r);return{node:e._controller.nodeIndex[t.nodeId],indices:n}};return _.whenGraphicAttributes(e.layer,r,e._getObjectIdField(),n,i,{ignoreUnavailableFields:!1})},createExtentBuilder:function(){var t=E.create(E.NEGATIVE_INFINITY),r=e.layer.spatialReference;return{add:function(e){return E.expand(t,e.graphic.geometry)},getExtent:function(){return E.toExtent(t,r)}}}},{enableObjectId:!0,enableOutFields:!!this.layer.objectIdField})},t.prototype.getUsedMemory=function(){var e=this,t=0;return Object.keys(this._nodesAddedToStage).forEach(function(r){t+=e._controller.nodeIndex[r].memory}),t},t.prototype.getUnloadedMemory=function(){return this._controller?this._controller.getUnloadedMemoryEstimate():0},t.prototype.removeCachedData=function(){var e=this;Object.keys(this._nodesAddedToStage).forEach(function(t){e._removeNodeData({id:t})})},t.prototype.getStats=function(){var e=this.inherited(arguments)||{};return e.nodecount=Object.keys(this._nodesAddedToStage).length,e.featurecount=this.loadedGraphics.length,e},n([p.property()],t.prototype,"loadedGraphics",void 0),n([p.property()],t.prototype,"layer",void 0),n([p.property()],t.prototype,"hasDraped",null),n([p.property()],t.prototype,"_controller",void 0),n([p.property({dependsOn:["_controller.updating"]})],t.prototype,"updating",void 0),n([p.property({aliasOf:"_controller.updatingPercentage"})],t.prototype,"updatingPercentageValue",void 0),t=n([p.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],t)}(p.declared(g,v)),w={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},S=E.create(E.POSITIVE_INFINITY);return C});