// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessorSupport/decorators","../../../core/Logger","./graphics/Graphics3DLayerViewCore","./support/LayerViewUpdatingPercentage","../../layers/LayerView","../../../Graphic","../../../geometry/Point","../../../geometry/Polygon","../../../geometry/Polyline","../../../renderers/support/renderingInfoUtils","../../../core/Collection","../../../core/HandleRegistry","../../../core/promiseUtils","../lib/glMatrix","./i3s/I3SUtil","./i3s/I3SBinaryReader","../support/PreallocArray","../support/projectionUtils","../support/aaBoundingBox"],function(e,t,r,n,i,o,a,d,s,l,u,p,h,c,g,f,y,_,v,b,m,A,w){function C(e,t){return e.xmin-=t,e.ymin-=t,e.xmax+=t,e.ymax+=t,e.hasZ&&(e.zmin-=t,e.zmax+=t),e.hasM&&(e.mmin-=t,e.mmax+=t),e}var S=o.getLogger("esri.layers.SceneService"),D=!1,I=!1,x=!1,V=function(e){function t(t){var r=e.call(this)||this;return r._isUpdating=!1,r._nodesAddedToStage={},r.loadedGraphics=new g,r.supportsDraping=!0,r._overlayUpdating=null,r._controllerCreated=!1,r._handles=new f,r}return r(t,e),t.prototype.initialize=function(){var e=this;v.checkSpatialReferences(this.layer,this.view.spatialReference,this.view.viewingMode),this._handles.add([this.layer.watch("renderer",function(t,r){return e._rendererChange(t,r)}),this.layer.watch("objectIdFilter",function(){return e._objectIdFilterChange()})]),this._layerViewCore=new a({owner:this,layer:this.layer,spatialIndexRequired:!1,labelingEnabled:!0,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,verticalScaleEnabled:!0,updateSuspendResumeExtent:function(){return e._updateSuspendResumeExtent()},updateClippingExtent:function(t){return e._updateClippingExtent(t)},elevationChanged:function(t,r,n){return e._elevationChanged(t,r,n)}}),this.addResolvingPromise(this._layerViewCore.initialize()),this.drawingOrder=this.view.getDrawingOrder(this.layer.uid),this._createController()},t.prototype.destroy=function(){this._layerViewCore&&(this._layerViewCore.destroy(),this._layerViewCore=null),this._controller&&(this._controller.destroy(),this._controller=null),this._elevationUpdateNodes=null,this._intersectingGraphicIds=null,this._nodesAddedToStage=null,this._nodeDebugVisualizer&&(this._nodeDebugVisualizer.dispose(),this._nodeDebugVisualizer=null),this._handles&&(this._handles.destroy(),this._handles=null)},Object.defineProperty(t.prototype,"hasDraped",{get:function(){return this._layerViewCore.graphicsCore.hasDraped},enumerable:!0,configurable:!0}),t.prototype.whenGraphicAttributes=function(e,t){var r=this,n=function(){var t=r._findGraphicNodeAndIndex(e.uid);return{node:t.node,indices:[t.index]}};return v.whenGraphicAttributes(this.layer,[e],this._getObjectIdField(),t,n).then(function(e){return e[0]})},t.prototype.getGraphicsFromStageObject=function(e,t){if(!this.loadedGraphics)return y.reject();var r=e.getMetadata().graphicId,n=this.loadedGraphics.find(function(e){return e.uid===r}),i=this._getObjectIdField();return n&&n.attributes&&n.attributes[i]?y.resolve(n):y.reject()},t.prototype.whenGraphicBounds=function(e){return this._layerViewCore.graphicsCore.whenGraphicBounds(e)},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return this._isUpdating?!0:!(!this._controller||!this._controller.updating)},t.prototype.getRenderingInfo=function(e){var t=c.getRenderingInfo(e,{renderer:this.layer.renderer});if(t&&t.color){var r=t.color;r[0]=r[0]/255,r[1]=r[1]/255,r[2]=r[2]/255}return t},t.prototype.getSymbolUpdateType=function(){return this._layerViewCore.graphicsCore.getSymbolUpdateType()},t.prototype._findGraphicNodeAndIndex=function(e){for(var t=0,r=Object.keys(this._nodesAddedToStage);t<r.length;t++)for(var n=r[t],i=this._nodesAddedToStage[n],o=i.bundles,a=0;a<o.length;a++)for(var d=o[a],s=0;s<d.length;s++)if(d[s].graphics.some(function(t){return t.uid===e}))return{node:this._controller.nodeIndex[n],nodeId:n,bundleNr:a,index:s};return null},t.prototype._elevationChanged=function(e,t,r){w[2]=-(1/0),w[3]=1/0;var n=w.fromRect(T,e),i=t;null==this._elevationUpdateNodes&&(this._elevationUpdateNodes=new m(10));var o=this._elevationUpdateNodes;o.clear(),this._controller&&this._controller.updateElevationChanged(n,i,o);var a=o.length;this._intersectingGraphicIds||(this._intersectingGraphicIds=new m(10));var d=this._intersectingGraphicIds;d.clear();for(var s=0;a>s;s++){var l=o.data[s],u=this._nodesAddedToStage[l.id];if(null!=u)for(var p=u.bundles,h=0;h<p.length;h++)for(var c=p[h],g=0;g<c.length;g++)for(var f=c[g].graphics,y=0;y<f.length;y++)d.push(f[y].uid)}r(this._intersectingGraphicIds.data,this._intersectingGraphicIds.length)},t.prototype._evaluateUpdatingState=function(){var e=0;e+=this._layerViewCore.elevationAlignment.numNodesUpdating(),e+=this._layerViewCore.graphicsCore.numNodesUpdating();var t=!1;t=t||!this._controllerCreated,t=t||this._overlayUpdating,t=t||this._layerViewCore.graphicsCore.needsIdleUpdate();var r=!1;r=r||e>0,r=r||t,this._isUpdating!==r&&(this._isUpdating=r,this.notifyChange("updating"))},t.prototype._notifySuspendedChange=function(){},t.prototype._notifyDrapedDataChange=function(){this.notifyChange("hasDraped"),this.emit("draped-data-change")},t.prototype._createController=function(){var e=this;I&&(this._nodeDebugVisualizer=v.makeNodeDebugVisualizer(this.view._stage,this.view.renderCoordsHelper,this.layer.id),window._nodeDebugVisualizer=this._nodeDebugVisualizer);var t={addBundle:this._addBundle.bind(this),isBundleAlreadyAddedToStage:function(t,r){return e._isBundleAlreadyAddedToStage(t,r)},isOverMemory:function(){return e._isOverMemory()},removeNodeData:function(t){return e._removeNodeData(t)},removeFeatures:function(t,r){return e._removeFeatures(t,r)},getAddedFeatures:function(t){return e._getAddedFeatures(t)},getAddedNodeIDs:function(){return e._getAddedNodeIDs()},areAllBundlesLoaded:function(t){return e._areAllBundlesLoaded(t)},wholeNodeSwitchEnabled:!0},r={traversalOptions:{initDepthFirst:!1,neighborhood:!1,perLevelTraversal:!0,allowPartialOverlaps:!1,errorMetricPreference:["distanceRangeFromDefaultCamera","screenSpaceRelative"],elevationInfo:this.layer.elevationInfo},getAllAddedFeatures:function(){return e._getAllAddedFeatures()},_nodeDebugVisualizer:this._nodeDebugVisualizer,getLoadedAttributes:function(t){return e._getLoadedAttributes(t)},setAttributeData:function(t,r,n){return e._setAttributeData(t,r,n)}};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:t,layerViewOptionalFunctions:r}).then(function(t){e._controller=t,t.watch("rootNodeVisible",function(){e.notifyChange("suspended")})}).always(function(){e._controllerCreated=!0,e.notifyChange("updating")})},t.prototype._getAllAddedFeatures=function(){var e={};return this.loadedGraphics.forEach(function(t){var r=t._features,n=t._nodeId;e[n]=r}),e},t.prototype._addBundle=function(e,t,r,n,i,o,a){if(D&&console.log("_bundleLoadedCallback "+e.id+" bundleNr "+a),I&&null!=this._nodeDebugVisualizer){var d="grey",s=["grey","red","blue","yellow","magenta"];d=s[e.level]||"grey",this._nodeDebugVisualizer.show(e,this._controller.crsIndex,d)}var c=this._controller.crsIndex,g=[],f=this._getObjectIdField();if(null==this._nodesAddedToStage[e.id]&&(this._nodesAddedToStage[e.id]={bundles:[],attributeData:r?r.attributeData:null,loadedAttributes:r?r.loadedAttributes:null}),this._nodesAddedToStage[e.id].bundles[a]=g,null==t)return void(null!=i&&i.done());var y;if(this.layer.objectIdFilter){var _=this.layer.objectIdFilter.ids,v="include"===this.layer.objectIdFilter.method;y=function(e){var t=_.indexOf(e)>=0;return t===v}}for(var m=this.layer.fullExtent&&C(this.layer.fullExtent.clone(),.5),A=[],w=0;w<t.length;w++)for(var V=t[w],T=V.featureDataPositions[0],E=0;E<V.geometries.length;E++){var N=[],F=E<V.features.length?E:0,G=V.features[F],O=G||x?{}:null;if(G&&G.id){if(y&&!y(G.id))continue;O[f]=G.id}x&&(O.DBG_NODE_ID=e.id);var R=V.geometries[E],U=R.params.type,j=void 0,B=void 0;if("ArrayBufferView"===R.type){var L=n[e.geometryData[a].hrefConcat],P=R.params.vertexAttributes.position;if(null==P)continue;var z=b.valueType2TypedArrayClassMap[P.valueType];j=new z(L,P.byteOffset,P.count*P.valuesPerElement),B=P.valuesPerElement}else"Embedded"===R.type&&(j=R.params.vertexAttributes.position,B=3);var M=void 0;if("lines"===U){for(var k=[],q=0;q<j.length;q+=B)k.push([j[q]+e.mbs[0],j[q+1]+e.mbs[1]]);var H=new h(c);H.addPath(k),M=H,N.push(new l(M,null,O))}else if("points"===U)for(var q=0;q<j.length;q+=B)M=new u({x:j[q]+T[0],y:j[q+1]+T[1],z:B>2?j[q+2]+T[2]:void 0,spatialReference:c}),m&&!m.contains(M)&&S.error("Service Error: Point coordinates outside of layer extent"),N.push(new l(M,null,O));else if("polygon"===U){var H=new p(c);M=H,H._outlineSegments=[];for(var J=0;J<R.params.rings.length;J++){for(var Y=R.params.rings[J],Z=Y.start,K=[],Q=[],W=[-1,-1],X=0;X<Y.segments.length;X+=2){var $=Y.segments[X+0],ee=Y.segments[X+1];0===$||1===$?(-1===W[0]&&(W[0]=Z-Y.start),W[1]=Z+ee-Y.start):-1!==W[0]&&(Q.push(W),W=[-1,-1]);for(var q=Z*B;(Z+ee)*B>q;q+=B)K.push([j[q]+e.mbs[0],j[q+1]+e.mbs[1]]);Z+=ee}-1!==W[0]&&Q.push(W),M._outlineSegments.push(Q),H.addRing(K),null!=Y.inner&&console.warn("inner rings not yet supported")}N.push(new l(M,null,O))}for(var te=0;te<N.length;te++){var re=N[te];re.layer=this.layer,D&&(re._features=V.features,re._nodeId=e.id)}A.push.apply(A,N),g.push({features:V.features,graphics:N})}this.loadedGraphics.addMany(A);var ne=this._nodesAddedToStage[e.id];this._setBundleAttributes(ne.bundles[a],ne.loadedAttributes,ne.attributeData),i.done()},t.prototype._areAllBundlesLoaded=function(e){var t=this._nodesAddedToStage[e.id];if(null==t)return!1;for(var r=0;r<e.featureData.length;r++)if(null==t.bundles[r])return!1;return!0},t.prototype._isBundleAlreadyAddedToStage=function(e,t){return this._nodesAddedToStage[e.id]&&null!=this._nodesAddedToStage[e.id].bundles[t]},t.prototype._isOverMemory=function(){return!1},t.prototype._removeFeatures=function(e,t){D&&console.log("_removeFeatures "+e.id+" features "+t);var r=this._nodesAddedToStage[e.id];if(null!=r){var n=r.bundles,i=[];for(var o in n)for(var a=0;a<n[o].length;a++){var d=n[o][a],s=!1;if(null!=d){for(var l in d.features)if(-1!==t.indexOf(d.features[l].id)){s=!0;break}s&&(i.push.apply(i,d.graphics),delete n[o][a])}}this.loadedGraphics.removeMany(i);for(var o=0;o<n.length;o++)for(var a=0;a<n[o].length;a++){var d=n[o][a];if(null!=d&&d.graphics.length>0)return}this._removeNodeData(e)}},t.prototype._removeNodeData=function(e){D&&console.log("_removeNodeData "+e.id);var t=this._nodesAddedToStage[e.id];if(null!=t){var r=t.bundles,n=[];for(var i in r)for(var o in r[i])n.push.apply(n,r[i][o].graphics);this.loadedGraphics.removeMany(n),delete this._nodesAddedToStage[e.id]}},t.prototype._getAddedFeatures=function(e){var t=this._nodesAddedToStage[e];if(null==t)return null;var r=t.bundles,n=[];for(var i in r)for(var o=0;o<r[i].length;o++){var a=r[i][o];n=n.concat(a.features)}return n},t.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodesAddedToStage)},t.prototype._getLoadedAttributes=function(e){var t=this._nodesAddedToStage[e.id];return t?t.loadedAttributes:void 0},t.prototype._setAttributeData=function(e,t,r){var n=this._nodesAddedToStage[e.id];n&&(n.loadedAttributes=t,n.attributeData=r,this._setNodeAttributes(n,t,r),this._layerViewCore.labeling.layerLabelsEnabled()&&this._layerViewCore.labeling.updateLabelingInfo())},t.prototype._setNodeAttributes=function(e,t,r){var n=e.bundles;for(var i in n){var o=n[i];this._setBundleAttributes(o,t,r)}},t.prototype._setBundleAttributes=function(e,t,r){for(var n=0;n<e.length;n++)for(var i=e[n],o=0;o<i.graphics.length;++o){var a=i.graphics[o];if(a.attributes||(a.attributes={}),t)for(var d=0,s=t;d<s.length;d++){var l=s[d],u=l.name;r[u]&&(a.attributes[u]=r[u][n])}}},t.prototype._updateSuspendResumeExtent=function(){if(this.layer.fullExtent){this._suspendResumeExtent||(this._suspendResumeExtent=_.vec4d.create());var e=this.layer.fullExtent;A.extentToBoundingRect(e,this._suspendResumeExtent,this.view.spatialReference)||(this._suspendResumeExtent=null)}else this._suspendResumeExtent=null;return this._suspendResumeExtent},t.prototype._updateClippingExtent=function(e){return this._controller&&this._controller.updateClippingArea(e),!1},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._rendererChange=function(e,t){var r=this,n=e?e.requiredFields:[],i=t?t.requiredFields:[];n.length===i.length&&n.every(function(e,t){return n[t]===i[t]})||Object.keys(this._nodesAddedToStage).forEach(function(e){r._removeNodeData({id:e})})},t.prototype._objectIdFilterChange=function(){var e=this;Object.keys(this._nodesAddedToStage).forEach(function(t){e._removeNodeData({id:t})}),this._controller&&this._controller.restartNodeLoading()},t.prototype.getStats=function(){var e=this.inherited(arguments)||{};return e.nodecount=Object.keys(this._nodesAddedToStage).length,e.featurecount=this.loadedGraphics.length,e},t}(i.declared(s,d));n([i.property()],V.prototype,"loadedGraphics",void 0),n([i.property()],V.prototype,"layer",void 0),n([i.property()],V.prototype,"view",void 0),n([i.property()],V.prototype,"hasDraped",null),n([i.property()],V.prototype,"_controller",void 0),n([i.property({dependsOn:["_controller.updating"]})],V.prototype,"updating",void 0),n([i.property({aliasOf:"_controller.updatingPercentage"})],V.prototype,"updatingPercentageValue",void 0),V=n([i.subclass("esri.views.3d.layers.SceneLayerGraphicsView3D")],V);var T=w.create(w.POSITIVE_INFINITY);return V});