// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../AnimationController","../../../webgl-engine/lib/Camera","../../../lib/glMatrix","../../utils/navigationUtils","../../../../navigation/Momentum","../../utils/navigationUtils","../../../camera/constraintUtils"],function(t,e,i,n,o,a,s,r,m,c){Object.defineProperty(e,"__esModule",{value:!0});var p=a.vec3d.create(),h=function(t){function e(e){var i=t.call(this)||this;return i.view=e,i.zoom={momentum:null,estimator:new r.ZoomMomentumEstimator(.05),enabled:!0},i.rotation={momentum:null,estimator:new r.RotationMomentumEstimator(.05,3,.05,.95),enabled:!0},i.pan={momentum:null,estimator:new r.ScreenspaceMomentumEstimator(.05,500,12,.82),enabled:!0},i.elapsedTimeSec=0,i._panAxisOrDirection=a.vec3d.create(),i._centerOnScreen=a.vec2d.create(),i._centerOnSphere=a.vec3d.create(),i._tmpSphereCenter=a.vec3d.create(),i._tmpScaleAxis=a.vec3d.create(),i.sphere={center:a.vec3d.create(),radius:0},i.tmpInteractionDirection=a.vec3d.create(),i._verticalCenter=a.vec3d.create(),i.beginCamera=new o,i.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new o,interactionDirection:null},i}return i(e,t),e.prototype.setParameters=function(t,e,i,n){this.sphere.radius=t,i&&n?(a.vec2d.set(i,this._centerOnScreen),a.vec3d.set(n,this._centerOnSphere)):(this.zoom.enabled=!1,this.rotation.enabled=!1),this._mode=e},e.prototype.setParametersVertical=function(t){a.vec3d.set(t,this._verticalCenter)},e.prototype.addPanValue=function(t,e,i,n){this.pan.estimator.add(e[0],e[1],i,.001*t),a.vec3d.set(n,this._panAxisOrDirection)},e.prototype.addRotationValue=function(t,e){this.rotation.estimator.add(e,.001*t)},e.prototype.addScaleValue=function(t,e){this.zoom.estimator.add(e,.001*t)},e.prototype.initiate=function(){return this.zoom.enabled&&(this.zoom.momentum=this.zoom.estimator.evaluateMomentum()),!this.zoom.momentum&&this.rotation.enabled&&(this.rotation.momentum=this.rotation.estimator.evaluateMomentum()),this.zoom.momentum||this.rotation.momentum||!this.pan.enabled||(this.pan.momentum=this.pan.estimator.evaluateMomentum()),null!=(this.zoom.momentum||this.rotation.momentum||this.pan.momentum)},e.prototype.onControllerStart=function(e){this.beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera.copyFrom(this.beginCamera),t.prototype.onControllerStart.call(this,e)},Object.defineProperty(e.prototype,"steppingFinished",{get:function(){return this.momentumFinished()},enumerable:!0,configurable:!0}),e.prototype.stepController=function(t,e){e.copyViewFrom(this.beginCamera),this.elapsedTimeSec+=t;var i=this._centerOnScreen,n=this._centerOnSphere;if(this.zoom.momentum){var o=this.zoom.momentum.valueDelta(0,this.elapsedTimeSec);if(this._mode===m.PanMode.Horizontal){s.applyZoomOnSphere(this.sphere,e,o),this.constraintOptions.selection=15,this.constraintOptions.interactionType=1,this.constraintOptions.interactionDirection=null,c.applyAll(this.view,e,this.constraintOptions),s.sphereOrSilhouettePointFromScreenPoint(this.sphere,e,i,this._tmpSphereCenter);var r=s.rotationAndAxisFromPoints(n,this._tmpSphereCenter,this._tmpScaleAxis);s.applyRotation(e,this.sphere.center,this._tmpScaleAxis,r),this.constraintOptions.interactionType=4,c.applyAll(this.view,e,this.constraintOptions)}else a.vec3d.set(e.eye,this.tmpInteractionDirection),s.applyZoomToPoint(e,this._verticalCenter,o,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=1,this.constraintOptions.interactionDirection=a.vec3d.direction(this.tmpInteractionDirection,e.eye),c.applyAll(this.view,e,this.constraintOptions)}if(this.pan.momentum){if(this._mode===m.PanMode.Horizontal){var h=s.rotationAndAxisFromPoints(this.pan.momentum.dataOldest,this.pan.momentum.dataNewest,this._panAxisOrDirection)/this.pan.momentum.dataTimeDelta,r=this.pan.momentum.valueFromInitialVelocity(h,this.elapsedTimeSec);s.applyRotation(e,this.sphere.center,this._panAxisOrDirection,r)}else{var h=a.vec3d.dist(this.pan.momentum.dataOldest,this.pan.momentum.dataNewest);h/=this.pan.momentum.dataTimeDelta;var l=this.pan.momentum.valueFromInitialVelocity(h,this.elapsedTimeSec);a.vec3d.normalize(this._panAxisOrDirection),a.vec3d.scale(this._panAxisOrDirection,l),a.vec3d.subtract(e.eye,this._panAxisOrDirection),a.vec3d.subtract(e.center,this._panAxisOrDirection),e.markViewDirty(),this.constraintOptions.interactionDirection=this._panAxisOrDirection}this.constraintOptions.interactionType=4,c.applyAll(this.view,e,this.constraintOptions),this.constraintOptions.interactionDirection=null}if(this.rotation.momentum){var u=this.rotation.momentum.valueDelta(0,this.elapsedTimeSec);s.applyRotation(e,p,n,u),this.constraintOptions.interactionType=2,this.constraintOptions.interactionDirection=null,c.applyAll(this.view,e,this.constraintOptions)}},e.prototype.momentumFinished=function(){return this.zoom.momentum&&this.zoom.momentum.isFinished(this.elapsedTimeSec)&&(this.zoom.momentum=null),this.rotation.momentum&&this.rotation.momentum.isFinished(this.elapsedTimeSec)&&(this.rotation.momentum=null),this.pan.momentum&&this.pan.momentum.isFinished(this.elapsedTimeSec)&&(this.pan.momentum=null),!this.zoom.momentum&&!this.rotation.momentum&&!this.pan.momentum},e}(n.AnimationController);e.MomentumController=h});