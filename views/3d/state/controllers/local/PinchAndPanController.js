// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/extendsHelper","../../../lib/glMatrix","../../../input/util","../../../webgl-engine/lib/Camera","../InteractiveController","./MomentumController","../../utils/navigationUtils","../../../camera/constraintUtils"],function(t,e,i,n,a,r,o,s,l,c){Object.defineProperty(e,"__esModule",{value:!0});var h;!function(t){t[t.Vertical=0]="Vertical",t[t.Horizontal=1]="Horizontal"}(h=e.PanMode||(e.PanMode={}));var m=n.vec3d.createFrom(0,0,1),p={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI},d=function(t){function e(e,i){var o=t.call(this)||this;return o.view=e,o.pickingHelper=i,o.rotationValueSmooth=new a.ExponentialFalloff(.05),o.scalingValueSmooth=new a.ExponentialFalloff(.05),o.planeHorizontal={normal:n.vec3d.create(),d:0},o.planeVertical={normal:n.vec3d.create(),d:0},o.beginCenterHorizontal=n.vec3d.create(),o.beginCenterVertical=n.vec3d.create(),o.tmpPoints=[],o.beginCenterScreen=n.vec2d.create(),o.tmpCentroid3d=n.vec3d.create(),o.tmpCentroid2d=n.vec2d.create(),o.tmp2d=n.vec2d.create(),o.constraintOptions={selection:15,interactionType:0,interactionFactor:0,interactionStartCamera:new r,interactionDirection:null},o.momentumController=new s.MomentumController(e),o}return i(e,t),e.prototype.begin=function(t,e,i){if(this.active){this.beginRadius=e.radius,this.rotationValueSmooth.reset(),this.scalingValueSmooth.reset(),l.navPointToScreenPoint(this.beginCamera,e.center,this.beginCenterScreen),this.planeHorizontal.d=0,n.vec3d.set(m,this.planeHorizontal.normal);var a=n.vec3d.create();this.pickingHelper.pickPointInScreen(this.beginCenterScreen,a)||this.pickingHelper.pickFreePointInScreen(this.beginCenterScreen,a);var r=n.vec3d.create();n.vec3d.negate(this.beginCamera.viewForward,r);var o=n.vec3d.create();n.vec3d.set(m,o);var s=n.vec3d.dot(r,o),c=0>s,d=Math.asin(c?-s:s);this.panMode=d>=p.ANGLE_THRESHOLD?h.Horizontal:h.Vertical,l.setPlaneD(a,this.planeHorizontal);var u=n.vec3d.dot(this.planeHorizontal.normal,this.beginCamera.eye)+this.planeHorizontal.d;0>u&&(n.vec3d.negate(this.planeHorizontal.normal),this.planeHorizontal.d*=-1),this.panMode===h.Vertical&&(n.vec3d.scale(o,s),n.vec3d.subtract(r,o,this.planeVertical.normal),n.vec3d.normalize(this.planeVertical.normal),l.setPlaneD(a,this.planeVertical),this.computePlanePoints(t,"currentEvent",this.planeVertical,this.beginCamera,this.tmpPoints),l.centroid(this.tmpPoints,this.beginCenterVertical)),this.computePlanePoints(t,"currentEvent",this.planeHorizontal,this.beginCamera,this.tmpPoints),l.centroid(this.tmpPoints,this.beginCenterHorizontal),this.constraintOptions.interactionStartCamera.copyFrom(this.beginCamera)}},e.prototype.update=function(t,e,i){if(this.active){this.currentCamera.copyFrom(this.beginCamera);var a=t.length,r=a>1,o=this.panMode===h.Horizontal?this.planeHorizontal:this.planeVertical,s=this.panMode===h.Horizontal?this.beginCenterHorizontal:this.beginCenterVertical;if(r){var m=this.beginRadius/e.radius,p=.001875*Math.min(Math.max(e.radius,40),120);this.scalingValueSmooth.gain=p,this.scalingValueSmooth.update(m),l.applyZoomToPoint(this.currentCamera,s,this.scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this.momentumController.addScaleValue(i,this.scalingValueSmooth.value,s),this.constraintOptions.interactionType=1,this.constraintOptions.interactionFactor=c.pixelDistanceToInteractionFactor(Math.abs(e.radius-this.beginRadius)),c.applyAll(this.view,this.currentCamera,this.constraintOptions)}if(this.computePlanePoints(t,"currentEvent",o,this.currentCamera,this.tmpPoints),l.centroid(this.tmpPoints,this.tmpCentroid3d),l.navPointToScreenPoint(this.currentCamera,e.center,this.tmpCentroid2d),l.applyPanPlanar(this.currentCamera,s,this.tmpCentroid3d,{estimator:this.momentumController,time:i,endScreenPoint:this.tmpCentroid2d}),this.constraintOptions.interactionType=4,this.constraintOptions.interactionFactor=c.pixelDistanceToInteractionFactor(this.beginCenterScreen,this.tmpCentroid2d),c.applyAll(this.view,this.currentCamera,this.constraintOptions),r){var d=this.planeHorizontal.normal,u=s;n.vec3d.set(this.planeHorizontal.normal,d);var v=e.angle,C=this.rotationValueSmooth.value,g=v-C;g=l.normalizeRotationDelta(g),v=C+g;var p=.00125*Math.min(Math.max(e.radius,40),120);this.rotationValueSmooth.gain=p,this.rotationValueSmooth.update(v);var P=this.rotationValueSmooth.value;this.momentumController.addRotationValue(i,u,d,P),l.applyRotation(this.currentCamera,u,d,P),this.constraintOptions.interactionType=2,this.constraintOptions.interactionFactor=c.pixelDistanceToInteractionFactor(Math.abs(e.radius*P)),c.applyAll(this.view,this.currentCamera,this.constraintOptions)}this.currentCamera.markViewDirty()}},e.prototype.end=function(){return this.finishController(),this.momentumController.initiate()?this.momentumController:null},e.prototype.computePlanePoints=function(t,e,i,a,r){r.length=t.length;for(var o=this.tmp2d,s=0;s<r.length;s++){var c=t[s];o[0]=c[e].x,o[1]=this.view.height-c[e].y,void 0===r[s]&&(r[s]=n.vec3d.create()),l.intersectPlaneFromScreenPoint(i,a,o,r[s])}return r},e}(o.InteractiveController);e.PinchAndPanController=d});