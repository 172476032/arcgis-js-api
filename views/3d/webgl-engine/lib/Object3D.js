// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","./IdGen","./Util","./gl-matrix","./ComponentUtils","./ModelContentType","./GeometryRecord"],function(t,e,r,o,i,n,a,s){var c=o.assert,l=i.mat4d,h=i.vec3d,m=o.VertexAttrConstants,p=function(){function t(e){void 0===e&&(e={}),this._bvObjectSpace=new u,this._bvWorldSpace=new u,this._bvDirty=!0,this._hasVolatileTransformation=!1,this.id=t._idGen.gen(e.idHint),this.name=e.name,this.castShadow=null!=e.castShadow?e.castShadow:!0,this.metadata=e.metadata,this.objectTransformation=l.identity(),this._initializeGeometryRecords(e.geometries,e.materials,e.transformations)}return t.prototype._initializeGeometryRecords=function(t,e,r){if(!Array.isArray(t))return this.geometryRecords=[],void(this.geometries=[]);c(e.length===t.length,"Object3D: materials don't match geometries"),c(r.length===t.length,"Object3D: transformations don't match geometries"),this.geometryRecords=new Array(t.length),this.geometries=t.slice();for(var o=0;o<t.length;o++){c(Array.isArray(e[o]),"Object3D: materials parameter must be array of array");var i={};this.geometryRecords[o]=new s(t[o],e[o].slice(),l.create(r[o]),i)}this._hasVolatileTransformation=!1},t.prototype.getId=function(){return this.id},Object.defineProperty(t.prototype,"parentLayer",{get:function(){return this._parentLayer},set:function(t){c(null==this._parentLayer||null==t,"Object3D can only be added to a single Layer"),this._parentLayer=t},enumerable:!0,configurable:!0}),t.prototype.getParentLayer=function(){return this.parentLayer},t.prototype.addParentLayer=function(t){this.parentLayer=t},t.prototype.removeParentLayer=function(t){this.parentLayer=null},t.prototype.getNumGeometryRecords=function(){return this.geometryRecords.length},t.prototype.getFirstGeometryIndex=function(t){var e=this.geometries.indexOf(t);return c(e>-1,"Object3D.getFirstGeometryIndex: geometry not found"),e},t.prototype.findGeometryRecords=function(t){for(var e=[],r=0;r<this.geometries.length;r++)this.geometries[r]===t&&e.push(this.geometryRecords[r]);return e},t.prototype.getGeometryRecord=function(t){return c(t>=0&&t<this.geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range"),this.geometryRecords[t]},t.prototype.getGeometryRecords=function(){return this.geometryRecords},t.prototype.addGeometry=function(t,e,r,o,i,n){c(Array.isArray(e),"Object3D.addGeometry: materials must be array"),this.geometries.push(t);var a=new s(t,e.slice(),l.create(r),o||{},i,n);return this.geometryRecords.push(a),this._hasVolatileTransformation=this.geometryRecords.some(function(t){return!!t.customTransformation}),this._notifyDirty("objGeometryAdded",a),this._invalidateBoundingVolume(),a},t.prototype.hasGeometry=function(t){return this.geometries.indexOf(t)>-1},t.prototype.removeGeometry=function(t){var e=this.geometryRecords.splice(t,1)[0];return this._hasVolatileTransformation=this.geometryRecords.some(function(t){return!!t.customTransformation}),this.geometries.splice(t,1),this._notifyDirty("objGeometryRemoved",e),this._invalidateBoundingVolume(),e},t.prototype.geometryVertexAttrsUpdated=function(t){this._notifyDirty("vertexAttrsUpdated",this.geometryRecords[t]),this._invalidateBoundingVolume()},t.prototype.geometryColorAttrsUpdated=function(t){this._notifyDirty("colorAttrsUpdated",this.geometryRecords[t])},t.prototype.isAllHidden=function(){for(var t=0,e=this.geometryRecords;t<e.length;t++){var r=e[t],o=r.instanceParameters.componentVisibilities,i=r.geometry.getData().componentOffsets;if(!n.isAllHidden(o,i))return!1}return!0},t.prototype.isAllVisible=function(){for(var t=0,e=this.geometryRecords;t<e.length;t++){var r=e[t],o=r.instanceParameters.componentVisibilities,i=r.geometry.getData().componentOffsets;if(!n.isAllVisible(o,i))return!1}return!0},t.prototype.setFacerangeColors=function(t,e){var r=this.geometryRecords;if(1!==r.length)return void console.warn("face range colors currently support only one geometry record");var o=r[0].geometry,i=o.data.vertexAttributes;if(null!=o.originalColors||!t.every(function(t){return null==t.color})){if(null==o.originalColors){o.originalColors=i[m.COLOR].data;var n=o.originalColors.constructor;i[m.COLOR].data=new n(o.originalColors)}var a=i[m.COLOR].data;if(null!=a){for(var s=0;s<t.length;s++){var c=t[s],l=null==c.faceRanges?0:4*c.faceRanges[0]*3,h=null==c.faceRanges?a.length:4*(c.faceRanges[1]+1)*3;if(null!=c.color)if("blend"===e)for(var p=c.color[0],u=c.color[1],d=c.color[2],y=c.color[3],g=l;h>g;g+=4)a[g+0]=o.originalColors[g+0]*p,a[g+1]=o.originalColors[g+1]*u,a[g+2]=o.originalColors[g+2]*d,a[g+3]=o.originalColors[g+3]*y;else for(var p=255*c.color[0],u=255*c.color[1],d=255*c.color[2],y=255*c.color[3],g=l;h>g;g+=4)a[g+0]=p,a[g+1]=u,a[g+2]=d,a[g+3]=y;else for(var g=l;h>g;g++)a[g]=o.originalColors[g]}this.geometryColorAttrsUpdated(0)}}},t.prototype.hasComponents=function(){for(var t=!1,e=0;e<this.geometries.length;e++){var r=this.geometries[e],o=r.getData();if(t=n.hasComponents(o.componentOffsets))break}return t},t.prototype.setComponentVisibility=function(t,e,r){var o=t.geometry,i=t.instanceParameters.componentVisibilities,a=o.getData().componentOffsets,s=n.updateVisibility(i,a,e,r);t.instanceParameters.componentVisibilities=s,this._notifyDirty("componentVisibilityChanged",t)},t.prototype.getComponentVisibility=function(t,e){var r=t.instanceParameters.componentVisibilities;return n.getVisibility(r,e)},t.prototype.hideAllComponents=function(){for(var t=0,e=this.geometryRecords;t<e.length;t++){var r=e[t],o=r.instanceParameters.componentVisibilities,i=n.hideAllComponents(o);r.instanceParameters.componentVisibilities=i}this._notifyDirty("componentVisibilityChanged")},t.prototype.unhideAllComponents=function(){for(var t=0,e=this.geometryRecords;t<e.length;t++){var r=e[t],o=r.instanceParameters.componentVisibilities,i=n.unhideAllComponents(o);r.instanceParameters.componentVisibilities=i}this._notifyDirty("componentVisibilityChanged")},t.prototype.getFaceRangeIndexFromTriangleNr=function(t){var e=this.metadata.faceRanges;if(null!=e)for(var r=0;r<e.length;r++)if(e[r][0]<=t&&e[r][1]>=t)return r},t.prototype.getFaceRangeFromTriangleNr=function(t){var e=this.getFaceRangeIndexFromTriangleNr(t),r=this.metadata.faceRanges;return e?[r[e]]:null},t.prototype.setGeometryTransformation=function(t,e){c(t>=0&&t<this.geometryRecords.length,"Object3d.setGeometryTransformation: index out of range");var r=this.geometryRecords[t],o=new s(r.geometry,r.materials,l.create(e),r.instanceParameters);this.geometryRecords[t]=o,this._notifyDirty("objGeometryReplaced",[r,o]),this._invalidateBoundingVolume()},t.prototype.getObjectTransformation=function(){return l.create(this.objectTransformation)},t.prototype.setObjectTransformation=function(t){l.set(t,this.objectTransformation),this._invalidateBoundingVolume(),this._notifyDirty("objTransformation")},t.prototype.getCombinedStaticTransformation=function(t,e){return e=e||l.create(),l.multiply(this.objectTransformation,t.getStaticTransformation(),e),e},t.prototype.getCombinedShaderTransformation=function(t,e){return e=e||l.create(),l.multiply(this.objectTransformation,t.getShaderTransformation(),e),e},t.prototype.hasVolativeTransformation=function(){return this._hasVolatileTransformation},t.prototype.getCastShadow=function(){return this.castShadow},t.prototype.setCastShadow=function(t){this.castShadow=t},t.prototype.getMetadata=function(){return this.metadata},t.prototype.getName=function(){return this.name},t.prototype.getBBMin=function(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.bbMin:this._bvWorldSpace.bbMin},t.prototype.getBBMax=function(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.bbMax:this._bvWorldSpace.bbMax},t.prototype.getCenter=function(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.center:this._bvWorldSpace.center},t.prototype.getBSRadius=function(t){return this._validateBoundingVolume(),t?this._bvObjectSpace.bsRadius:this._bvWorldSpace.bsRadius},t.prototype._validateBoundingVolume=function(){if(this._bvDirty||this._hasVolatileTransformation){this._bvObjectSpace.init(),this._bvWorldSpace.init();for(var t=h.create(),e=h.create(),r=0;r<this.geometryRecords.length;++r)for(var o=this.geometries[r],i=this.geometryRecords[r].getShaderTransformation(),n=o.getNumGroups(),a=0;n>a;++a){var s=o.getBoundingInfo(a);l.multiplyVec3(i,s.getBBMin(),t),l.multiplyVec3(i,s.getBBMax(),e);for(var c=0;3>c;++c)this._bvObjectSpace.bbMin[c]=Math.min(this._bvObjectSpace.bbMin[c],t[c],e[c]),this._bvObjectSpace.bbMax[c]=Math.max(this._bvObjectSpace.bbMax[c],t[c],e[c]);l.multiplyVec3(this.objectTransformation,t),l.multiplyVec3(this.objectTransformation,e);for(var c=0;3>c;++c)this._bvWorldSpace.bbMin[c]=Math.min(this._bvWorldSpace.bbMin[c],t[c],e[c]),this._bvWorldSpace.bbMax[c]=Math.max(this._bvWorldSpace.bbMax[c],t[c],e[c])}h.lerp(this._bvObjectSpace.bbMin,this._bvObjectSpace.bbMax,.5,this._bvObjectSpace.center),h.lerp(this._bvWorldSpace.bbMin,this._bvWorldSpace.bbMax,.5,this._bvWorldSpace.center);for(var m=t,p=e,u=this._getScaleFactor(this.objectTransformation),r=0;r<this.geometryRecords.length;++r)for(var o=this.geometries[r],i=this.geometryRecords[r].getShaderTransformation(),d=this._getScaleFactor(i),n=o.getNumGroups(),a=0;n>a;++a){var s=o.getBoundingInfo(a);l.multiplyVec3(i,s.getCenter(),m);var y=h.dist(m,this._bvObjectSpace.center),g=s.getBSRadius()*d;this._bvObjectSpace.bsRadius=Math.max(this._bvObjectSpace.bsRadius,y+g),l.multiplyVec3(this.objectTransformation,m,p);var b=h.dist(p,this._bvWorldSpace.center),f=g*u;this._bvWorldSpace.bsRadius=Math.max(this._bvWorldSpace.bsRadius,b+f)}this._bvDirty=!1}},t.prototype._getScaleFactor=function(t){var e=Math.sqrt(t[0]*t[0]+t[4]*t[4]+t[8]*t[8]),r=Math.sqrt(t[1]*t[1]+t[5]*t[5]+t[9]*t[9]),o=Math.sqrt(t[2]*t[2]+t[6]*t[6]+t[10]*t[10]);return Math.max(Math.max(e,r),o)},t.prototype._invalidateBoundingVolume=function(){this._bvDirty=!0,this._parentLayer&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace)},t.prototype._notifyDirty=function(t,e,r,o){if(this._parentLayer){r=r||a.OBJECT;var i=o||this;this._parentLayer.notifyDirty(t,e,r,i)}},t}();p._idGen=new r;var u=function(){function t(){this.bbMin=h.create(),this.bbMax=h.create(),this.center=h.create(),this.bsRadius=0}return t.prototype.init=function(){h.set3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,this.bbMin),h.set3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,this.bbMax),h.set3(0,0,0,this.center),this.bsRadius=0},t.prototype.getCenter=function(){return this.center},t.prototype.getBSRadius=function(){return this.bsRadius},t}();return p});