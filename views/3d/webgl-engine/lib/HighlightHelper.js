// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","dojo/text!../materials/internal/highlight.xml","../../support/debugFlags","./DefaultVertexAttributeLocations","./DefaultVertexBufferLayouts","./gl-matrix","./glUtil3D","./Util","../../../webgl/BufferObject","../../../webgl/FramebufferObject","../../../webgl/Program","../../../webgl/Util","../../../webgl/VertexArrayObject"],function(e,t,i,r,l,a,o,h,s,n,p,g,u,d){var c=o.vec4d;return function(){function e(e,t,i){this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0},this.quadVAO=null,this.blur0Fbo=null,this.blur1Fbo=null,this._rctx=i,this.viewportToRestore=c.create(),this.programRep=e,this.defaultOptions={color:new Float32Array([1,0,1,1]),haloOpacity:1,fillOpacity:.2,haloOpacityOccluded:.25,fillOpacityOccluded:.05}}return e.prototype._gridUpdateResources=function(e,t){var i=this._rctx,r=this._grid,o=!1;if(null===r.coverageMipmap&&(r.coverageMipmap=[e],o=!0),r.viewportWidth===e.width&&r.viewportHeight===e.height||(o=!0,r.viewportWidth=e.width,r.viewportHeight=e.height),r.coverageMipmap[0]=e,r.cellPixelSize!==t&&(r.cellPixelSize=t,o=!0),o){for(var h=1;h<r.coverageMipmap.length;h++)r.coverageMipmap[h].dispose();r.mipmapLevels=Math.ceil(Math.log(r.cellPixelSize)*Math.LOG2E),r.coverageMipmap.length=r.mipmapLevels+1;for(var h=0;h<r.mipmapLevels;h++){var s=r.coverageMipmap[h],g={target:3553,pixelFormat:6407,dataType:33635,samplingMode:9729,wrapMode:33071,width:Math.ceil(s.width/2),height:Math.ceil(s.height/2)},u={colorTarget:0,depthStencilTarget:0,width:Math.ceil(s.width/2),height:Math.ceil(s.height/2)},c=p.createWithAttachments(i,g,u);r.coverageMipmap[h+1]=c}}var b=Math.ceil(e.height/r.cellPixelSize),f=Math.ceil(e.width/r.cellPixelSize);if(!r.vao||r.verticalCellCount!==b||r.horizontalCellCount!==f){r.verticalCellCount=b,r.horizontalCellCount=f;for(var m=b+1,v=f+1,O=1/b,w=1/f,y=new Float32Array(24*m*v),x=0,T=0;T<m;T++)for(var A=0;A<v;A++)y[x+0]=(A-.5)*w*2-1,y[x+1]=(T-.5)*O*2-1,y[x+2]=A*w,y[x+3]=T*O,y[x+4]=(A+.5)*w*2-1,y[x+5]=(T-.5)*O*2-1,y[x+6]=A*w,y[x+7]=T*O,y[x+8]=(A-.5)*w*2-1,y[x+9]=(T+.5)*O*2-1,y[x+10]=A*w,y[x+11]=T*O,y[x+12]=(A-.5)*w*2-1,y[x+13]=(T+.5)*O*2-1,y[x+14]=A*w,y[x+15]=T*O,y[x+16]=(A+.5)*w*2-1,y[x+17]=(T-.5)*O*2-1,y[x+18]=A*w,y[x+19]=T*O,y[x+20]=(A+.5)*w*2-1,y[x+21]=(T+.5)*O*2-1,y[x+22]=A*w,y[x+23]=T*O,x+=24;r.vao&&r.vao.dispose(!0),r.vao=new d(i,l.Default3D,{geometry:a.Pos2Tex},{geometry:n.createVertex(i,35044,y)})}},e.prototype._gridComputeMipmap=function(){var e=this._rctx,t=this._grid,i=this.programRep.get("conservative-downsample");e.bindVAO(this.quadVAO);for(var r=0;r<t.mipmapLevels;r++){e.bindFramebuffer(t.coverageMipmap[r+1]),e.bindTexture(t.coverageMipmap[r].colorTexture,0);var l=t.coverageMipmap[r+1].width,a=t.coverageMipmap[r+1].height;e.bindProgram(i),i.setUniform1i("tex",0),i.setUniform2f("invFramebufferDim",1/l,1/a),e.setViewport(0,0,l,a),e.drawArrays(5,0,u.vertexCount(this.quadVAO,"geometry"))}},Object.defineProperty(e.prototype,"profilingCallback",{get:function(){return r.HIGHLIGHTS_PROFILE_TO_CONSOLE?function(e){return console.log(e)}:null},enumerable:!0,configurable:!0}),e.prototype.getIsSupported=function(){return!0},e.prototype.setEnableState=function(e){e?this.enable():this.disable()},e.prototype.getEnableState=function(){return null!==this.blur0Fbo},e.prototype.enable=function(){this.quadVAO=h.createQuadVAO(this._rctx);var e={colorTarget:0,depthStencilTarget:0,width:0,height:0},t={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0};this.blur0Fbo=p.createWithAttachments(this._rctx,t,e),this.blur1Fbo=p.createWithAttachments(this._rctx,t,e)},e.prototype.disable=function(){this.getEnableState()&&(this.quadVAO.dispose(!0),this.blur1Fbo.dispose(),this.blur0Fbo.dispose(),this.quadVAO=null,this.blur0Fbo=null,this.blur1Fbo=null)},e.prototype.getHighlightFBO=function(){return this.blur0Fbo},e.prototype.render=function(e,t,i){var l=!r.HIGHLIGHTS_GRID_OPTIMIZATION_DISABLED,a=r.HIGHLIGHTS_VISUALIZE_BLOCKS,o=this._rctx;s.assert(this.getEnableState()),c.set(e.fullViewport,this.viewportToRestore);var h=i.width,n=i.height,p=Math.ceil(h/1),g=Math.ceil(n/1);this.blur0Fbo.resize(p,g),this.blur1Fbo.resize(p,g),o.bindVAO(this.quadVAO),o.setDepthWriteEnabled(!1),o.setDepthTestEnabled(!1),o.setBlendingEnabled(!1);var d=null,b=null,f=null,m=null;if(l){var v=this._grid;this._gridUpdateResources(i,32),this._gridComputeMipmap(),f=v.vao,m=4,d=this.programRep.get("highlight-blur-grid-5"),o.bindProgram(d),o.bindTexture(v.coverageMipmap[v.mipmapLevels].colorTexture,1),d.setUniform1i("coverageTex",1)}else f=this.quadVAO,m=5,d=this.programRep.get("highlight-blur-5"),o.bindProgram(d);if(o.bindVAO(f),o.bindFramebuffer(this.blur0Fbo),o.setViewport(0,0,p,g),o.setClearColor(0,0,0,0),o.clear(o.gl.COLOR_BUFFER_BIT),d.setUniform1i("tex",0),o.bindTexture(i.colorTexture,0),d.setUniform2f("blurSize",1/p,0),o.drawArrays(m,0,u.vertexCount(f,"geometry")),o.bindFramebuffer(this.blur1Fbo),o.clear(o.gl.COLOR_BUFFER_BIT),o.bindTexture(this.blur0Fbo.colorTexture,0),d.setUniform2f("blurSize",0,1/g),o.drawArrays(m,0,u.vertexCount(f,"geometry")),o.bindFramebuffer(t),o.setBlendingEnabled(!0),o.setBlendFunctionSeparate(770,771,1,771),o.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),l){b=this.programRep.get(a?"highlight-apply-grid-debug":"highlight-apply-grid"),o.bindProgram(b),b.setUniform1i("coverageTex",2);var O=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture;o.bindTexture(O,2)}else b=this.programRep.get("highlight-apply"),o.bindProgram(b);b.setUniform1i("tex",0),o.bindTexture(this.blur1Fbo.colorTexture,0),b.setUniform1i("origin",1),o.bindTexture(i.colorTexture,1),b.setUniform4fv("color",this.defaultOptions.color),b.setUniform1f("outlineSize",8.6),b.setUniform1f("blurSize",.4),b.setUniform4f("opacities",this.defaultOptions.haloOpacity,this.defaultOptions.haloOpacityOccluded,this.defaultOptions.fillOpacity,this.defaultOptions.fillOpacityOccluded),o.drawArrays(m,0,u.vertexCount(f,"geometry")),o.bindVAO(null),o.setDepthWriteEnabled(!0),o.setDepthTestEnabled(!0),o.setBlendingEnabled(!1)},e.prototype.setDefaultOptions=function(e){this.defaultOptions=e},e.loadShaders=function(e,t,r){e._parse(i);for(var a=0,o=["3","5","7","9"];a<o.length;a++){var h=o[a];t.add("highlight-blur-"+h,new g(r,e.vsHighlightBlurFastGaussian,e.fsHighlightBlurFastGaussian,l.Default3D,{GAUSSIAN_SAMPLES:h})),t.add("highlight-blur-grid-"+h,new g(r,e.vsHighlightBlurFastGaussian,e.fsHighlightBlurFastGaussian,l.Default3D,{GAUSSIAN_SAMPLES:h,GRID_OPTIMIZATION:"true"}))}t.add("highlight-apply",new g(r,e.vsHighlightApply,e.fsHighlightApply,l.Default3D)),t.add("highlight-apply-grid",new g(r,e.vsHighlightApply,e.fsHighlightApply,l.Default3D,["GRID_OPTIMIZATION"])),t.add("highlight-apply-grid-debug",new g(r,e.vsHighlightApply,e.fsHighlightApply,l.Default3D,["GRID_OPTIMIZATION","GRID_DEBUG"])),t.add("conservative-downsample",new g(r,e.vsConservativeDownsample,e.fsConservativeDownsample,l.Default3D))},e}()});