// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","./gl-matrix"],function(t,e,r){function n(t,e){if(!t){var r=new Error("dummy");throw r.stack&&console.log(r.stack),new xt(e)}}function a(t,e){t||(console.log("Verify failed: "+e),console.log(new Error("dummy").stack))}function o(t){void 0===t&&(t=Float32Array);var e=new t(20);return e[0]=-1,e[1]=-1,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=-1,e[7]=0,e[8]=1,e[9]=0,e[10]=-1,e[11]=1,e[12]=0,e[13]=0,e[14]=1,e[15]=1,e[16]=1,e[17]=0,e[18]=1,e[19]=1,e}function c(t){return 0===(t&t-1)}function i(t,e,r){return t+(e-t)*r}function u(t,e,r){return e>t?e:t>r?r:t}function v(t,e){return void 0===t?e:t}function f(t){t=Math.floor(t);var e=(t>>16&255)/255,r=(t>>8&255)/255,n=(255&t)/255;return[e,r,n]}function d(t){var e=u(Math.round(255*t[0]),0,255),r=u(Math.round(255*t[1]),0,255),n=u(Math.round(255*t[2]),0,255);return"0x"+((e<<16)+(r<<8)+n).toString(16)}function s(t){var e=t.toString(16);return"00000000".substr(0,8-e.length)+e}function h(t){return t/180*Math.PI}function M(t){return 180*t/Math.PI}function l(t,e){var r=1.5*Math.PI-t,n=.5*Math.PI-e,a=Math.cos(r)*Math.sin(n),o=Math.cos(n),c=Math.sin(r)*Math.sin(n);return[a,o,c]}function m(t,e,n,a){var o=r.vec3d.dot(n,e);if(0===o)return!1;var c=-(r.vec3d.dot(n,t)+n[3])/o;return r.vec3d.add(t,r.vec3d.scale(e,c,a),a),!0}function g(t,e,n,a,o){n=n||Tt;var c=r.vec3d.subtract(t,n,ft),i=r.vec3d.dot(e,e),u=2*r.vec3d.dot(e,c),v=r.vec3d.dot(c,c)-a*a,f=u*u-4*i*v;if(0>f)return!1;var d=Math.sqrt(f),s=(-u-d)/(2*i),h=(-u+d)/(2*i);return(0>s||s>h&&h>0)&&(s=h),s>0?(r.vec3d.add(t,r.vec3d.scale(e,s,yt),o),!0):!1}function p(t,e,n,a,o,c,i,u,v){void 0===v&&(v=r.vec3d.create());var f=1e-5,d=a[i]-n[c],s=a[i+1]-n[c+1],h=a[i+2]-n[c+2],M=o[u]-n[c],l=o[u+1]-n[c+1],m=o[u+2]-n[c+2],g=e[1]*m-l*e[2],p=e[2]*M-m*e[0],E=e[0]*l-M*e[1],w=d*g+s*p+h*E;if(w>-f&&f>w)return!1;var b=1/w,I=t[0]-n[c],y=t[1]-n[c+1],T=t[2]-n[c+2];if(v[1]=b*(I*g+y*p+T*E),v[1]<0||v[1]>1)return!1;var x=y*h-s*T,C=T*d-h*I,R=I*s-d*y;return v[2]=b*(e[0]*x+e[1]*C+e[2]*R),v[2]<0||v[1]+v[2]>1?!1:(v[0]=b*(M*x+l*C+m*R),!0)}function E(t,e,r,n){var a,o=(r[0]-t[0])/e[0],c=(n[0]-t[0])/e[0];o>c&&(a=o,o=c,c=a);var i=(r[1]-t[1])/e[1],u=(n[1]-t[1])/e[1];if(i>u&&(a=i,i=u,u=a),o>u||i>c)return!1;i>o&&(o=i),c>u&&(c=u);var v=(r[2]-t[2])/e[2],f=(n[2]-t[2])/e[2];return v>f&&(a=v,v=f,f=a),o>f||v>c?!1:(c>f&&(c=f),0>c?!1:!0)}function w(t,e,n,a,o,c){void 0===c&&(c=r.vec2d.create());var i=(a[o]-n[o])*(e[0]-t[0])-(a[0]-n[0])*(e[o]-t[o]),u=(a[0]-n[0])*(t[o]-n[o])-(a[o]-n[o])*(t[0]-n[0]);if(0===i)return!1;var v=u/i;return c[0]=t[0]+v*(e[0]-t[0]),c[1]=t[o]+v*(e[o]-t[o]),!0}function b(t,e,n){r.mat4d.multiply(e,t,ct),r.mat4d.inverse(ct);for(var a=0;8>a;++a)r.mat4d.multiplyVec4(ct,it[a],ut),r.vec3d.set3(ut[0]/ut[3],ut[1]/ut[3],ut[2]/ut[3],n[a])}function I(t,e,r,n){void 0===n&&(n=r,r=vt),b(t,e,r),y(r[4],r[0],r[3],n[0]),y(r[1],r[5],r[6],n[1]),y(r[4],r[5],r[1],n[2]),y(r[3],r[2],r[6],n[3]),y(r[0],r[1],r[2],n[4]),y(r[5],r[4],r[7],n[5])}function y(t,e,n,a){r.vec3d.subtract(t,e,ft),r.vec3d.subtract(n,e,dt),r.vec3d.cross(dt,ft,a),r.vec3d.normalize(a),a[3]=-r.vec3d.dot(a,t)}function T(t,e,a,o,c){c||(c=t),ut[0]=t[0],ut[1]=t[1],ut[2]=t[2],ut[3]=1,r.mat4d.multiplyVec4(e,ut),c.length>2&&(c[2]=-ut[2]),r.mat4d.multiplyVec4(a,ut),n(0!==ut[3]),c[0]=ut[0]/ut[3],c[1]=ut[1]/ut[3],c[2]=ut[2]/ut[3],c[0]=(.5*c[0]+.5)*o[2]+o[0],c[1]=(.5*c[1]+.5)*o[3]+o[1]}function x(t){return Math.atan((1-e.ECCENTRICITY_SQUARED)*Math.tan(t))}function C(t,r,n,a){var o=6378137,c=o/Math.sqrt(1-e.ECCENTRICITY_SQUARED*Math.pow(Math.sin(t),2)),i=Math.cos(t);a[0]=(c+n)*Math.cos(r)*i,a[1]=(c*(1-e.ECCENTRICITY_SQUARED)+n)*Math.sin(t),a[2]=-(c+n)*Math.sin(r)*i}function R(t,e){var n=r.vec3d.length(t);e[0]=Math.asin(u(t[1]/n,-1,1));var a=Math.cos(e[0]);e[1]=(t[2]<0?1:-1)*Math.acos(u(t[0]/(a*n),-1,1)),e[0]=M(e[0]),e[1]=M(e[1]),e[2]=n}function S(t,r){var n=6378137,a=t[0],o=-t[2],c=t[1],i=Math.sqrt(Math.pow(n,2)*(1-e.ECCENTRICITY_SQUARED)),u=Math.sqrt((Math.pow(n,2)-Math.pow(i,2))/Math.pow(i,2)),v=Math.sqrt(Math.pow(a,2)+Math.pow(o,2)),f=Math.atan2(n*c,i*v),d=Math.atan2(o,a),s=Math.atan2(c+Math.pow(u,2)*i*Math.pow(Math.sin(f),3),v-e.ECCENTRICITY_SQUARED*n*Math.pow(Math.cos(f),3)),h=n/Math.sqrt(1-e.ECCENTRICITY_SQUARED*Math.pow(Math.sin(s),2)),M=v/Math.cos(s)-h+e.EARTH_RADIUS;r[0]=s,r[1]=d,r[2]=M}function D(t,e,n){var a=h(t[0]),o=h(t[1]);return C(a,o,e,st),r.mat4d.translate(n,st),r.mat4d.rotateY(n,.5*Math.PI+o),r.mat4d.rotateX(n,.5*Math.PI-a),n}function O(t,e){var r=t[e],n=t[e+1];return r+(n<<8)}function A(t,e){var r=t[e],n=t[e+1],a=t[e+2],o=t[e+3];return r+(n<<8)+(a<<16)+(o<<24)}function N(t,e,r){void 0!==e[t]&&(r[t]=e[t])}function U(t,e){var r={};if(void 0!==e)for(var n=0,a=t;n<a.length;n++){var o=a[n];r[e(o)]=o}else for(var c=0,i=t;c<i.length;c++){var o=i[c];r[o]=o}return r}function P(t){var e=[];for(var r in t)e.push(t[r]);return e}function F(t,e,r){if(void 0===r&&(r={}),r!==t)for(var n in t)r[n]=t[n];if(r!==e)for(var a in e)r[a]=e[a];return r}function L(t,e){var r={};for(var n in t)void 0===e[n]&&(r[n]=t[n]);return r}function q(t,e){var r={};for(var n in t)void 0!==e[n]&&(r[n]=t[n]);return r}function _(t){for(var e in t)return e}function j(t){return t[_(t)]}function V(t){for(var e in t)return!1;return!0}function Y(t,e){if(t.length!==e.length)return!1;for(var r=0,n=t.length;n>r;++r)if(t[r]!==e[r])return!1;return!0}function Q(t,e){var r=t.indexOf(e);return-1!==r?(t[r]=t[t.length-1],t.pop(),e):null}function k(t,e,r,a,o){var c=4*e;n(t.length===c*r,"buffer length must match image resolution");var i=document.createElement("canvas");i.width=e,i.height=r;for(var u=i.getContext("2d"),v=u.getImageData(0,0,e,r),f=v.data,d=0;r>d;++d)for(var s=d*c,h=(r-1-d)*c,M=0;c>M;++M)f[s++]=t[h++];return u.putImageData(v,0,0),i.toDataURL(a,o)}function G(t){return Math.round(100*t)/100}function z(t,e){return Math.log(t)/Math.log(e)}function B(t,e){t[12]=e[0],t[13]=e[1],t[14]=e[2]}function H(t,e,r,n){t[12]=e,t[13]=r,t[14]=n}function X(t,e){return void 0===e&&(e=r.vec3d.create()),e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function W(t,e){return t=r.mat4d.identity(t),B(t,e),t}function K(t,e,r){return 2*Math.atan(r*Math.tan(.5*t)/e)}function Z(t,e,r){return 2*Math.atan(e*Math.tan(.5*t)/r)}function J(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/e)}function $(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/r)}function tt(t,e,r){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}function et(t,e,r){return 2*Math.atan(r*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}function rt(t){--t;for(var e=1;32>e;e<<=1)t|=t>>e;return t+1}function nt(t){return Math.pow(10,Math.ceil(Math.LOG10E*Math.log(t)))}function at(t,e,n,a){var o,c,i,v,f,d,s,h,M,l=1e-4,m=ht,g=Mt;if(m[0]=t[0]-n[0],m[1]=t[1]-n[1],m[2]=t[2]-n[2],g[0]=a[0]-n[0],g[1]=a[1]-n[1],g[2]=a[2]-n[2],Math.abs(g[0])<l&&Math.abs(g[1])<l&&Math.abs(g[2])<l)return[!1];var p=lt;if(p[0]=e[0]-t[0],p[1]=e[1]-t[1],p[2]=e[2]-t[2],Math.abs(p[0])<l&&Math.abs(p[1])<l&&Math.abs(p[2])<l)return[!1];if(i=m[0]*g[0]+m[1]*g[1]+m[2]*g[2],v=g[0]*p[0]+g[1]*p[1]+g[2]*p[2],f=m[0]*p[0]+m[1]*p[1]+m[2]*p[2],d=g[0]*g[0]+g[1]*g[1]+g[2]*g[2],s=p[0]*p[0]+p[1]*p[1]+p[2]*p[2],M=s*d-v*v,Math.abs(M)<l)return[!1];h=i*v-f*d,o=u(h/M,0,1),c=u((i+v*o)/d,0,1);var E=mt,w=gt;E[0]=t[0]+o*p[0],E[1]=t[1]+o*p[1],E[2]=t[2]+o*p[2],w[0]=n[0]+c*g[0],w[1]=n[1]+c*g[1],w[2]=n[2]+c*g[2];var b=r.vec3d.dist(E,w);return[!0,b,E,w]}function ot(t,e,n){var a=bt,o=It,c=yt,i=wt,v=pt,f=Et;a[0]=e[0]-t[0],a[1]=e[1]-t[1],a[2]=0,o[0]=n[0]-t[0],o[1]=n[1]-t[1],o[2]=0,c[0]=n[0],c[1]=n[1],c[2]=0;var d=r.vec3d.dot(o,a),s=r.vec3d.length(a),h=s*s,M=u(d/h,0,1);i[0]=a[0]*M,i[1]=a[1]*M,v[0]=t[0]+i[0],v[1]=t[1]+i[1],r.vec3d.subtract(c,v,f);var l=r.vec3d.length(f),m=r.vec3d.length(o),g=r.vec3d.length(a),p=r.vec3d.length(i);return(p>m||p>g)&&(l=Number.MAX_VALUE),l}Object.defineProperty(e,"__esModule",{value:!0});var ct=r.mat4d.create(),it=[r.vec4d.createFrom(-1,-1,-1,1),r.vec4d.createFrom(1,-1,-1,1),r.vec4d.createFrom(1,1,-1,1),r.vec4d.createFrom(-1,1,-1,1),r.vec4d.createFrom(-1,-1,1,1),r.vec4d.createFrom(1,-1,1,1),r.vec4d.createFrom(1,1,1,1),r.vec4d.createFrom(-1,1,1,1)],ut=r.vec4d.create(),vt=[r.vec3d.create(),r.vec3d.create(),r.vec3d.create(),r.vec3d.create(),r.vec3d.create(),r.vec3d.create(),r.vec3d.create(),r.vec3d.create()],ft=r.vec3d.create(),dt=r.vec3d.create(),st=r.vec3d.create(),ht=r.vec3d.create(),Mt=r.vec3d.create(),lt=r.vec3d.create(),mt=r.vec3d.create(),gt=r.vec3d.create(),pt=r.vec3d.create(),Et=r.vec3d.create(),wt=r.vec3d.create(),bt=r.vec3d.create(),It=r.vec3d.create(),yt=r.vec3d.create(),Tt=r.vec3d.createFrom(0,0,0),xt=function(){function t(t){this.message=t}return t.prototype.toString=function(){return"AssertException: "+this.message},t}();e.AssertException=xt,e.EARTH_RADIUS=6378137,e.METER2FEET=3.28084,e.ECCENTRICITY_SQUARED=.0066943799901414,e.VertexAttrConstants={POSITION:"position",NORMAL:"normal",UV0:"uv0",AUXPOS1:"auxpos1",AUXPOS2:"auxpos2",COLOR:"color",SYMBOLCOLOR:"symbolColor",SIZE:"size",REGION:"region"},e.assert=n,e.verify=a,e.createQuadVertexUvBuffer=o,e.isPowerOfTwo=c,e.lerp=i,e.clamp=u,e.fallbackIfUndefined=v,e.hex2rgb=f,e.rgb2hex=d,e.dec2hex=s,e.deg2rad=h,e.rad2deg=M,e.azimuthElevationAngle2Direction=l,e.rayPlane=m,e.raySphere=g,e.rayTriangle3D=p,e.rayBoxTest=E,e.rayRay2D=w,e.matrix2frustum=b,e.matrix2frustumPlanes=I,e.point2plane=y,e.project=T,e.geodeticToGeocentricLatidude=x,e.latLon2positionWGS84Ellipsoid=C,e.pos2latLon=R,e.pos2latLonWGS84Ellipsoid=S,e.computeGlobeTransformation=D,e.readUInt16=O,e.readUInt32=A,e.setIfDefined=N,e.array2object=U,e.object2array=P,e.mergeObjects=F,e.subtractObjects=L,e.intersectObjects=q,e.getFirstObjectKey=_,e.getFirstObjectValue=j,e.objectEmpty=V,e.arraysEqual=Y,e.arrayRemove=Q,e.byteBuffer2base64image=k,e.cround=G,e.logWithBase=z,e.setMatrixTranslation=B,e.setMatrixTranslation3=H,e.getMatrixTranslation=X,e.createTranslationMatrix=W,e.fovx2fovy=K,e.fovy2fovx=Z,e.fovx2fovd=J,e.fovy2fovd=$,e.fovd2fovx=tt,e.fovd2fovy=et,e.nextHighestPowerOfTwo=rt,e.nextHighestPowerOfTen=nt,e.lineSegmentLineSegmentDistance3D=at,e.pointLineSegmentDistance2D=ot;var Ct=function(){var t=window.performance||{};if(t){if(t.now)return function(){return t.now()};if(t.webkitNow)return function(){return t.webkitNow()};if(t.mozNow)return function(){return t.mozNow()};if(t.msNow)return function(){return t.msNow()};if(t.oNow)return function(){return t.oNow()}}var e;return e=t.timing&&t.timing.navigationStart?t.timing.navigationStart:Date.now(),function(){return Date.now()-e}}();e.performance={now:Ct}});