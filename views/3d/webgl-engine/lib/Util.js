// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["./gl-matrix","../../../../core/now"],function(t,r){function a(t){this.message=t}for(var n=t.vec2d,e=t.vec3d,o=t.vec4d,i=t.mat4d,u=i.create(),c=[o.createFrom(-1,-1,-1,1),o.createFrom(1,-1,-1,1),o.createFrom(1,1,-1,1),o.createFrom(-1,1,-1,1),o.createFrom(-1,-1,1,1),o.createFrom(1,-1,1,1),o.createFrom(1,1,1,1),o.createFrom(-1,1,1,1)],f=o.create(),s=new Array(8),h=0;8>h;++h)s[h]=e.create();var l=e.create(),v=e.create(),M=e.create(),d=e.create(),p=e.create(),g=e.create(),m=e.create(),E=e.create(),y=e.create(),I=e.create(),T=e.create(),b=e.create(),x=e.create(),C=e.create();a.prototype.toString=function(){return"AssertException: "+this.message};var R={EARTH_RADIUS:6378137,METER2FEET:3.28084,ECCENTRICITY_SQUARED:.0066943799901414,AssertException:a,VertexAttrConstants:{POSITION:"position",NORMAL:"normal",UV0:"uv0",AUXPOS1:"auxpos1",AUXPOS2:"auxpos2",COLOR:"color",SIZE:"size",REGION:"region"},assert:function(t,r){if(!t){var n=new Error("dummy");throw n.stack&&console.log(n.stack),new a(r)}},verify:function(t,r){t||(console.log("Verify failed: "+r),console.log(new Error("dummy").stack))},createQuadVertexUvBuffer:function(t){t=t||Float32Array;var r=new t(20);return r[0]=-1,r[1]=-1,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=-1,r[7]=0,r[8]=1,r[9]=0,r[10]=-1,r[11]=1,r[12]=0,r[13]=0,r[14]=1,r[15]=1,r[16]=1,r[17]=0,r[18]=1,r[19]=1,r},isPowerOfTwo:function(t){return 0===(t&t-1)},lerp:function(t,r,a){return t+(r-t)*a},clamp:function(t,r,a){return r>t?r:t>a?a:t},fallbackIfUndefined:function(t,r){return void 0===t?r:t},hex2rgb:function(t){t=Math.floor(t);var r=(t>>16&255)/255,a=(t>>8&255)/255,n=(255&t)/255;return[r,a,n]},rgb2hex:function(t){var r=R.clamp(Math.round(255*t[0]),0,255),a=R.clamp(Math.round(255*t[1]),0,255),n=R.clamp(Math.round(255*t[2]),0,255);return"0x"+((r<<16)+(a<<8)+n).toString(16)},dec2hex:function(t){var r=t.toString(16);return"00000000".substr(0,8-r.length)+r},deg2rad:function(t){return t/180*Math.PI},rad2deg:function(t){return 180*t/Math.PI},azimuthElevationAngle2Direction:function(t,r){var a=1.5*Math.PI-t,n=.5*Math.PI-r,e=Math.cos(a)*Math.sin(n),o=Math.cos(n),i=Math.sin(a)*Math.sin(n);return[e,o,i]},rayPlane:function(t,r,a,n){var o=e.dot(a,r);if(0===o)return!1;var i=-(e.dot(a,t)+a[3])/o;return e.add(t,e.scale(r,i,n),n),!0},raySphereClosestPositive:function(t,r,a,n){var o=e.dot(r,r),i=2*e.dot(r,t),u=e.dot(t,t)-a*a,c=i*i-4*o*u;if(0>c)return!1;var f=Math.sqrt(c),s=(-i-f)/(2*o),h=(-i+f)/(2*o);return(0>s||s>h&&h>0)&&(s=h),s>0?(e.add(t,e.scale(r,s,n),n),!0):!1},rayTriangle3D:function(t,r,a,n,o,i,u,c,f){var s=1e-5;f||(f=e.create());var h=n[u]-a[i],l=n[u+1]-a[i+1],v=n[u+2]-a[i+2],M=o[c]-a[i],d=o[c+1]-a[i+1],p=o[c+2]-a[i+2],g=r[1]*p-d*r[2],m=r[2]*M-p*r[0],E=r[0]*d-M*r[1],y=h*g+l*m+v*E;if(y>-s&&s>y)return!1;var I=1/y,T=t[0]-a[i],b=t[1]-a[i+1],x=t[2]-a[i+2];if(f[1]=I*(T*g+b*m+x*E),f[1]<0||f[1]>1)return!1;var C=b*v-l*x,R=x*h-v*T,w=T*l-h*b;return f[2]=I*(r[0]*C+r[1]*R+r[2]*w),f[2]<0||f[1]+f[2]>1?!1:(f[0]=I*(M*C+d*R+p*w),!0)},rayBoxTest:function(t,r,a,n){var e,o=(a[0]-t[0])/r[0],i=(n[0]-t[0])/r[0];o>i&&(e=o,o=i,i=e);var u=(a[1]-t[1])/r[1],c=(n[1]-t[1])/r[1];if(u>c&&(e=u,u=c,c=e),o>c||u>i)return!1;u>o&&(o=u),i>c&&(i=c);var f=(a[2]-t[2])/r[2],s=(n[2]-t[2])/r[2];return f>s&&(e=f,f=s,s=e),o>s||f>i?!1:(i>s&&(i=s),0>i?!1:!0)},rayRay2D:function(t,r,a,e,o,i){i||(i=n.create());var u=(e[o]-a[o])*(r[0]-t[0])-(e[0]-a[0])*(r[o]-t[o]),c=(e[0]-a[0])*(t[o]-a[o])-(e[o]-a[o])*(t[0]-a[0]);if(0===u)return!1;var f=c/u;return i[0]=t[0]+f*(r[0]-t[0]),i[1]=t[o]+f*(r[o]-t[o]),!0},matrix2frustum:function(t,r,a){i.multiply(r,t,u),i.inverse(u);for(var n=0;8>n;++n)i.multiplyVec4(u,c[n],f),e.set3(f[0]/f[3],f[1]/f[3],f[2]/f[3],a[n])},matrix2frustumPlanes:function(t,r,a,n){void 0===n&&(n=a,a=s),R.matrix2frustum(t,r,a),R.point2plane(a[4],a[0],a[3],n[0]),R.point2plane(a[1],a[5],a[6],n[1]),R.point2plane(a[4],a[5],a[1],n[2]),R.point2plane(a[3],a[2],a[6],n[3]),R.point2plane(a[0],a[1],a[2],n[4]),R.point2plane(a[5],a[4],a[7],n[5])},point2plane:function(t,r,a,n){e.subtract(t,r,l),e.subtract(a,r,v),e.cross(v,l,n),e.normalize(n),n[3]=-e.dot(n,t)},project:function(t,r,a,n,e){e||(e=t),f[0]=t[0],f[1]=t[1],f[2]=t[2],f[3]=1,i.multiplyVec4(r,f),e.length>2&&(e[2]=-f[2]),i.multiplyVec4(a,f),R.assert(0!==f[3]),e[0]=f[0]/f[3],e[1]=f[1]/f[3],e[2]=f[2]/f[3],e[0]=(.5*e[0]+.5)*n[2]+n[0],e[1]=(.5*e[1]+.5)*n[3]+n[1]},geodeticToGeocentricLatidude:function(t){return Math.atan((1-R.ECCENTRICITY_SQUARED)*Math.tan(t))},latLon2positionWGS84Ellipsoid:function(t,r,a,n){var e=6378137,o=e/Math.sqrt(1-R.ECCENTRICITY_SQUARED*Math.pow(Math.sin(t),2)),i=Math.cos(t);n[0]=(o+a)*Math.cos(r)*i,n[1]=(o*(1-R.ECCENTRICITY_SQUARED)+a)*Math.sin(t),n[2]=-(o+a)*Math.sin(r)*i},pos2latLon:function(t,r){var a=e.length(t);r[0]=Math.asin(R.clamp(t[1]/a,-1,1));var n=Math.cos(r[0]);r[1]=(t[2]<0?1:-1)*Math.acos(R.clamp(t[0]/(n*a),-1,1)),r[0]=R.rad2deg(r[0]),r[1]=R.rad2deg(r[1]),r[2]=a},pos2latLonWGS84Ellipsoid:function(t,r){var a=6378137,n=t[0],e=-t[2],o=t[1],i=Math.sqrt(Math.pow(a,2)*(1-R.ECCENTRICITY_SQUARED)),u=Math.sqrt((Math.pow(a,2)-Math.pow(i,2))/Math.pow(i,2)),c=Math.sqrt(Math.pow(n,2)+Math.pow(e,2)),f=Math.atan2(a*o,i*c),s=Math.atan2(e,n),h=Math.atan2(o+Math.pow(u,2)*i*Math.pow(Math.sin(f),3),c-R.ECCENTRICITY_SQUARED*a*Math.pow(Math.cos(f),3)),l=a/Math.sqrt(1-R.ECCENTRICITY_SQUARED*Math.pow(Math.sin(h),2)),v=c/Math.cos(h)-l+R.EARTH_RADIUS;r[0]=h,r[1]=s,r[2]=v},computeGlobeTransformation:function(t,r,a){var n=R.deg2rad(t[0]),e=R.deg2rad(t[1]);return R.latLon2position(n,e,M,r),i.translate(a,M),i.rotateY(a,.5*Math.PI+e),i.rotateX(a,.5*Math.PI-n),a},readUInt16:function(t,r){var a=t[r],n=t[r+1];return a+(n<<8)},readUInt32:function(t,r){var a=t[r],n=t[r+1],e=t[r+2],o=t[r+3];return a+(n<<8)+(e<<16)+(o<<24)},setIfDefined:function(t,r,a){void 0!==r[t]&&(a[t]=r[t])},array2object:function(t,r){var a,n,e={};if(void 0!==r)for(a=0,n=t.length;n>a;++a)e[r(t[a])]=t[a];else for(a=0,n=t.length;n>a;++a)e[t[a]]=t[a];return e},object2array:function(t){var r=[];for(var a in t)r.push(t[a]);return r},mergeObjects:function(t,r,a){void 0===a&&(a={});var n;if(a!==t)for(n in t)a[n]=t[n];if(a!==r)for(n in r)a[n]=r[n];return a},subtractObjects:function(t,r){var a={};for(var n in t)void 0===r[n]&&(a[n]=t[n]);return a},intersectObjects:function(t,r){var a={};for(var n in t)void 0!==r[n]&&(a[n]=t[n]);return a},getFirstObjectKey:function(t){for(var r in t)return r},getFirstObjectValue:function(t){return t[R.getFirstObjectKey(t)]},objectEmpty:function(t){for(var r in t)return!1;return!0},arraysEqual:function(t,r){if(t.length!==r.length)return!1;for(var a=0,n=t.length;n>a;++a)if(t[a]!==r[a])return!1;return!0},arrayRemove:function(t,r){var a=t.indexOf(r);return-1!==a?(t[a]=t[t.length-1],t.pop(),r):null},byteBuffer2base64image:function(t,r,a,n,e){var o=4*r;R.assert(t.length===o*a,"buffer length must match image resolution");var i=document.createElement("canvas");i.width=r,i.height=a;for(var u=i.getContext("2d"),c=u.getImageData(0,0,r,a),f=c.data,s=0;a>s;++s)for(var h=s*o,l=(a-1-s)*o,v=0;o>v;++v)f[h++]=t[l++];return u.putImageData(c,0,0),i.toDataURL(n,e)},cround:function(t){return Math.round(100*t)/100},logWithBase:function(t,r){return Math.log(t)/Math.log(r)},setMatrixTranslation:function(t,r){t[12]=r[0],t[13]=r[1],t[14]=r[2]},setMatrixTranslation3:function(t,r,a,n){t[12]=r,t[13]=a,t[14]=n},getMatrixTranslation:function(t,r){return r=r||e.create(),r[0]=t[12],r[1]=t[13],r[2]=t[14],r},createTranslationMatrix:function(t,r){return t=i.identity(t),R.setMatrixTranslation(t,r),t},fovx2fovy:function(t,r,a){return 2*Math.atan(a*Math.tan(.5*t)/r)},fovy2fovx:function(t,r,a){return 2*Math.atan(r*Math.tan(.5*t)/a)},fovx2fovd:function(t,r,a){return 2*Math.atan(Math.sqrt(r*r+a*a)*Math.tan(.5*t)/r)},fovy2fovd:function(t,r,a){return 2*Math.atan(Math.sqrt(r*r+a*a)*Math.tan(.5*t)/a)},fovd2fovx:function(t,r,a){return 2*Math.atan(r*Math.tan(.5*t)/Math.sqrt(r*r+a*a))},fovd2fovy:function(t,r,a){return 2*Math.atan(a*Math.tan(.5*t)/Math.sqrt(r*r+a*a))},nextHighestPowerOfTwo:function(t){--t;for(var r=1;32>r;r<<=1)t|=t>>r;return t+1},linelineDistance3D:function(t,r,a,n){var o,i,u,c,f,s,h,l,v,M=1e-4,y=d,I=p;if(y[0]=t[0]-a[0],y[1]=t[1]-a[1],y[2]=t[2]-a[2],I[0]=n[0]-a[0],I[1]=n[1]-a[1],I[2]=n[2]-a[2],Math.abs(I.x)<M&&Math.abs(I.y)<M&&Math.abs(I.z)<M)return[!1];var T=g;if(T[0]=r[0]-t[0],T[1]=r[1]-t[1],T[2]=r[2]-t[2],Math.abs(T.x)<M&&Math.abs(T.y)<M&&Math.abs(T.z)<M)return[!1];if(u=y[0]*I[0]+y[1]*I[1]+y[2]*I[2],c=I[0]*T[0]+I[1]*T[1]+I[2]*T[2],f=y[0]*T[0]+y[1]*T[1]+y[2]*T[2],s=I[0]*I[0]+I[1]*I[1]+I[2]*I[2],h=T[0]*T[0]+T[1]*T[1]+T[2]*T[2],v=h*s-c*c,Math.abs(v)<M)return[!1];l=u*c-f*s,o=l/v,i=(u+c*o)/s;var b=m,x=E;b[0]=t[0]+o*T[0],b[1]=t[1]+o*T[1],b[2]=t[2]+o*T[2],x[0]=a[0]+i*I[0],x[1]=a[1]+i*I[1],x[2]=a[2]+i*I[2];var C=e.dist(b,x);return[!0,C,b,x]},projectVectorVector2D:function(t,r,a){var n=b,o=x,i=C,u=T,c=y,f=I;n[0]=r[0]-t[0],n[1]=r[1]-t[1],n[2]=0,o[0]=a[0]-t[0],o[1]=a[1]-t[1],o[2]=0,i[0]=a[0],i[1]=a[1],i[2]=0;var s=e.dot(o,n),h=e.length(n),l=h*h,v=s/l;u[0]=n[0]*v,u[1]=n[1]*v,c[0]=t[0]+u[0],c[1]=t[1]+u[1],e.subtract(i,c,f);var M=e.length(f),d=e.length(o),p=e.length(n),g=e.length(u);return(g>d||g>p)&&(M=Number.MAX_VALUE),M}};return R.performance={now:r},R});