// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../support/debugFlags","./Camera","./ComponentUtils","./DefaultVertexBufferLayouts","./gl-matrix","./glUtil3D","./HighlightUtils","./Renderer","./RenderPass","./Util","../lighting/Lightsources","../materials/internal/TexOnlyGLMaterial","../../../webgl/FramebufferObject","../../../webgl/Texture","../../../webgl/Util"],function(e,t,r,i,n,s,a,o,h,d,u,l,g,p,c,_,f){var m=a.vec3d,x=a.vec4d,y=a.mat4d,v=function(){function e(e,t,r,i,n,s){var a=this;this._acquiredTextures={},this._clearColor=x.createFrom(0,0,0,0),this._id2origin={},this._uniqueIdx=0,this._rctx=e,this._canvas=t,this._programRep=r,this._textureRep=n,this._modelDirtySet=s,this._renderer=new d(r,i,n,this._rctx,!0),this._renderer.onHasHighlightsChanged=function(e){a.onHasHighlightsChanged&&a.onHasHighlightsChanged(e)},this._renderer.setLighting({lights:[new g.AmbientLight(m.createFrom(1,1,1))],groundLightingFactor:1,globalFactor:0})}return e.prototype.dispose=function(){for(var e in this._acquiredTextures)this._acquiredTextures[e].fbo.dispose(),this._textureRep.release(e);this._acquiredTextures=null,this._renderer.dispose(),this._renderer=null},e.prototype.addRenderGeometries=function(e){var t=this;e.forEach(function(e){null==e.origin&&(e.origin=t.getOrigin(e.center,e.bsRadius)),e.idx=t._uniqueIdx++}),this._renderer.modify(e,[])},e.prototype.removeRenderGeometries=function(e){this._renderer.modify([],e)},e.prototype.updateRenderGeometries=function(e,t){var r=e.map(function(e){return{renderGeometry:e,updateType:t}});this._renderer.modify([],[],r,{})},e.prototype.updateRenderOrder=function(e){Object.keys(e).length>0&&this._renderer.modifyRenderOrder(e)},e.prototype.setBackgroundColor=function(e){this._clearColor=e},e.prototype.addRenderGeometryHighlight=function(e,t){var r=e.instanceParameters,i=h.generateHighlightId();return r.componentHighlights=n.addHighlight(r.componentHighlights,null,t,i),this.updateRenderGeometries([e],32),i},e.prototype.removeRenderGeometryHighlight=function(e,t){var r=e.instanceParameters;r.componentHighlights=n.removeHighlight(r.componentHighlights,t),this.updateRenderGeometries([e],32)},e.prototype.isEmpty=function(){return this._renderer.isEmpty()},e.prototype.processDirtyMaterials=function(){var e=this._modelDirtySet.getDirtyMaterials();e&&this._renderer.modify([],[],[],e),this._modelDirtySet.clearDirtyMaterials()},Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._renderer.hasHighlights},enumerable:!0,configurable:!0}),e.prototype.draw=function(e,t){return this.drawPass(u.MATERIAL,e,t)},e.prototype.drawHighlights=function(e,t){return this.drawPass(u.MATERIAL_HIGHLIGHT,e,t)},e.prototype.drawPass=function(e,t,i){if(this.isEmpty()&&!r.OVERLAY_DRAW_TEST_TEXTURE)return!1;if(this.processDirtyMaterials(),e===u.MATERIAL_HIGHLIGHT&&!this.hasHighlights)return!1;if(!i.views.some(function(e){return e.extent[0]!==e.extent[2]&&e.extent[1]!==e.extent[3]}))return!1;var n,s=t.id,a=this._rctx,o=a.gl;if(this._acquiredTextures[s])n=this._acquiredTextures[s].fbo;else{var h=this._textureRep.aquire(s).getGLTexture();n=c.createWithAttachments(this._rctx,h,{colorTarget:0,depthStencilTarget:0});var d=Object.keys(this._acquiredTextures).length;this._acquiredTextures[s]={texture:t,fbo:n,idx:d}}var l=i.width,g=i.height;n.width===l&&n.height===g||(n.resize(l,g),n.colorTexture.setSamplingMode(9729)),w.near=1,w.far=1e4,a.bindFramebuffer(n),a.setDepthTestEnabled(!1),a.setBlendFunctionSeparate(770,771,1,771),a.setClearColor.apply(a,this._clearColor),a.clear(o.COLOR_BUFFER_BIT),this._renderer.setPixelRatio(i.pixelRatio||1);for(var p=0;p<i.views.length;p++){var _=i.views[p];w.viewport=_.viewport,y.ortho(0,_.extent[2]-_.extent[0],0,_.extent[3]-_.extent[1],w.near,w.far,w.projectionMatrix),y.identity(w.viewMatrix),y.translate(w.viewMatrix,[-_.extent[0],-_.extent[1],0]),w.setGLViewport(this._rctx),r.OVERLAY_DRAW_TEST_TEXTURE&&this._drawTestTexture(l,g,T[this._acquiredTextures[s].idx%T.length]),this._renderer.renderGeometryPass(e,w)}return a.setDepthTestEnabled(!0),a.setBlendFunctionSeparate(770,771,1,771),a.bindFramebuffer(null),a.setViewport(0,0,this._canvas.width,this._canvas.height),!0},e.prototype._drawTestTexture=function(e,t,r){var i=this._rctx,n=i.gl;if(!this._testPatternMat){for(var a=new Uint8Array(e*t*4),h=0,d=0;d<t;d++)for(var u=0;u<e;u++){var l=Math.floor(u/10),g=Math.floor(d/10);l<2||g<2||10*l>e-20||10*g>t-20?(a[h++]=255,a[h++]=255,a[h++]=255,a[h++]=255):(a[h++]=255,a[h++]=255,a[h++]=255,a[h++]=1&l&&1&g?1&u^1&d?0:255:1&l^1&g?0:128)}var c=new _(i,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},a);this._testPatternMat=new p(this._programRep,c,[1,1,1,1],!0,n.ALWAYS),this._testPatternBindParams={proj:y.identity(),view:y.identity(),nearFar:[-1,1],origin:[0,0,0],viewInvTransp:null,viewport:null,lightingData:null,fovY:0},this._quadVAO=o.createQuadVAO(i,s.Pos3Tex)}this._testPatternMat.setColor([r[0],r[1],r[2],1]),this._testPatternMat.bind(i,this._testPatternBindParams),this._testPatternMat.bindView(i,this._testPatternBindParams),i.bindVAO(this._quadVAO),i.drawArrays(5,0,f.vertexCount(this._quadVAO,"geometry")),this._testPatternMat.release(i)},e.prototype.getOrigin=function(e,t){var r=0,i=10*t/1e4;i>1&&(r=Math.ceil(l.logWithBase(i,2)));var n=1e4*Math.pow(2,r),s=Math.round(e[0]/n),a=Math.round(e[1]/n),o=Math.round(e[2]/n),h=r+"_"+s+"_"+a+"_"+o,d=this._id2origin[h];return null==d&&(d={vec3:m.createFrom(s*n,a*n,o*n),id:h},this._id2origin[h]=d),d},e}(),T=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],w=new i;return v});