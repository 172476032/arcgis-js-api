// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["./GeometryData","./BufferVectorMath","./Util","./gl-matrix"],function(r,e,a,t){function n(r,e,a,t,n){return Math.abs(c.dot(e,r))>n?!1:(c.cross(r,e,a),c.normalize(a),c.cross(a,r,t),c.normalize(t),!0)}function o(r,e,a,t,o,i,l){return n(r,e,o,i,l)||n(r,a,o,i,l)||n(r,t,o,i,l)}function i(){var e,a,t=.5,n=[[-t,-t,t],[t,-t,t],[t,t,t],[-t,t,t],[-t,-t,-t],[t,-t,-t],[t,t,-t],[-t,t,-t]],o=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],i=[0,0,1,0,1,1,0,1],l=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],s=new Array(36);for(e=0;6>e;e++)for(a=0;6>a;a++)s[6*e+a]=e;var c=new Array(36);for(e=0;6>e;e++)c[6*e+0]=0,c[6*e+1]=1,c[6*e+2]=2,c[6*e+3]=2,c[6*e+4]=3,c[6*e+5]=0;return function(e){var a;Array.isArray(e)||(e=[e,e,e]);var t=new Float32Array(24);for(a=0;8>a;a++)t[3*a]=n[a][0]*e[0],t[3*a+1]=n[a][1]*e[1],t[3*a+2]=n[a][2]*e[2];var v={};v[A.POSITION]=new Uint32Array(l),v[A.NORMAL]=new Uint32Array(s),v[A.UV0]=new Uint32Array(c);var h={};return h[A.POSITION]={size:3,data:t},h[A.NORMAL]={size:3,data:new Float32Array(o)},h[A.UV0]={size:2,data:new Float32Array(i)},new r(h,v)}}function l(){var e=.5,a=[[-e,0,-e],[e,0,-e],[e,0,e],[-e,0,e],[0,-e,0],[0,e,0]],t=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],n=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],o=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];return function(e){var i;Array.isArray(e)||(e=[e,e,e]);var l=new Float32Array(18);for(i=0;6>i;i++)l[3*i]=a[i][0]*e[0],l[3*i+1]=a[i][1]*e[1],l[3*i+2]=a[i][2]*e[2];var s={};s[A.POSITION]=new Uint32Array(n),s[A.NORMAL]=new Uint32Array(o);var c={};return c[A.POSITION]={size:3,data:l},c[A.NORMAL]={size:3,data:new Float32Array(t)},new r(c,s)}}function s(){var e=.5,a=0,t=c.createFrom(-e,a,-e),n=c.createFrom(e,a,-e),o=c.createFrom(0,a,e),i=c.createFrom(0,a+e,0),l=c.create(),s=c.create(),v=c.create(),h=c.create(),y=c.create();c.subtract(t,i,l),c.subtract(t,n,s),c.cross(l,s,v),c.normalize(v,v),c.subtract(n,i,l),c.subtract(n,o,s),c.cross(l,s,h),c.normalize(h,h),c.subtract(o,i,l),c.subtract(o,t,s),c.cross(l,s,y),c.normalize(y,y);var f=[t,n,o,i],d=[0,-1,0,v[0],v[1],v[2],h[0],h[1],h[2],y[0],y[1],y[2]],O=[0,1,2,3,1,0,3,2,1,3,0,2],u=[0,0,0,1,1,1,2,2,2,3,3,3];return function(e){var a;Array.isArray(e)||(e=[e,e,e]);var t=new Float32Array(12);for(a=0;4>a;a++)t[3*a]=f[a][0]*e[0],t[3*a+1]=f[a][1]*e[1],t[3*a+2]=f[a][2]*e[2];var n={};n[A.POSITION]=new Uint32Array(O),n[A.NORMAL]=new Uint32Array(u);var o={};return o[A.POSITION]={size:3,data:t},o[A.NORMAL]={size:3,data:new Float32Array(d)},new r(o,n)}}var c=t.vec3,v=t.vec3d,A=a.VertexAttrConstants,h=e.Vec3Compact,y=.99619469809,f=v.create(),d=v.create(),O={createSphereGeometry:function(e,t,n,o,i,l,s){e=e||50,o=void 0!==o?o:-Math.PI,i=void 0!==i?i:2*Math.PI,l=void 0!==l?l:.5*-Math.PI,s=void 0!==s?s:Math.PI;var v,h,y=Math.max(3,Math.floor(t)||8),f=Math.max(2,Math.floor(n)||6),d=(y+1)*(f+1),O=new Float32Array(3*d),u=new Float32Array(3*d),w=new Float32Array(2*d),g=[],m=c.create(),I=0;for(h=0;f>=h;h++){var F=[],M=h/f,z=l+M*s,N=Math.cos(z);for(v=0;y>=v;v++){var U=v/y,P=o+U*i,S=Math.cos(P)*N*e,T=Math.sin(z)*e,R=-Math.sin(P)*N*e;O[3*I]=S,O[3*I+1]=T,O[3*I+2]=R,c.set3(S,T,R,m),c.normalize(m),u[3*I]=m[0],u[3*I+1]=m[1],u[3*I+2]=m[2],w[2*I]=U,w[2*I+1]=M,F.push(I),++I}g.push(F)}var L=new Uint32Array(2*y*(f-1)*3);for(I=0,h=0;f>h;h++)for(v=0;y>v;v++){var p=g[h][v],V=g[h][v+1],G=g[h+1][v+1],b=g[h+1][v];0===h?(L[I++]=p,L[I++]=G,L[I++]=b):h===f-1?(L[I++]=p,L[I++]=V,L[I++]=G):(L[I++]=p,L[I++]=V,L[I++]=G,L[I++]=G,L[I++]=b,L[I++]=p)}a.assert(I===L.length);var x={};x[A.POSITION]=L,x[A.NORMAL]=L,x[A.UV0]=L;var C={};return C[A.POSITION]={size:3,data:O},C[A.NORMAL]={size:3,data:u},C[A.UV0]={size:2,data:w},new r(C,x)},createPolySphereGeometry:function(e,a,t){function n(r,a){r>a&&(r=a+(a=r,0));var t=r.toString()+"."+a.toString();if(v[t])return v[t];var n=i.length;return i.length+=3,h.add(i,3*r,i,3*a,i,n),h.scale(i,n,e/h.length(i,n)),n/=3,v[t]=n,n}var o,i,l,s=e;if(t)i=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],l=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{var c=s*(1+Math.sqrt(5))/2;i=[-s,c,0,s,c,0,-s,-c,0,s,-c,0,0,-s,c,0,s,c,0,-s,-c,0,s,-c,c,0,-s,c,0,s,-c,0,-s,-c,0,s],l=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(o=0;o<i.length;o+=3)h.scale(i,o,e/h.length(i,o));var v={};for(o=0;a>o;o++){for(var y=l.length,f=new Uint32Array(4*y),d=0;y>d;d+=3){var O=l[d],u=l[d+1],w=l[d+2],g=n(O,u),m=n(u,w),I=n(w,O),F=4*d;f[F]=O,f[F+1]=g,f[F+2]=I,f[F+3]=u,f[F+4]=m,f[F+5]=g,f[F+6]=w,f[F+7]=I,f[F+8]=m,f[F+9]=g,f[F+10]=m,f[F+11]=I}l=f,v={}}var M=new Float32Array(i);for(o=0;M>o;o+=3)h.normalize(M,o);i=new Float32Array(i);var z={};z[A.POSITION]=l,z[A.NORMAL]=l;var N={};return N[A.POSITION]={size:3,data:i},N[A.NORMAL]={size:3,data:M},new r(N,z)},createPointGeometry:function(e,a,t,n,o,i,l){var s=new Float32Array(3);s[0]=a?a[0]:0,s[1]=a?a[1]:0,s[2]=a?a[2]:0;var c=new Float32Array(3);if(c[0]=e?e[0]:0,c[1]=e?e[1]:0,c[2]=e?e[2]:1,null==i){var v=new Float32Array(2);v[0]=0,v[1]=0}else{v=new Float32Array(i.length);for(var h=0;h<i.length;h++)v[h]=i[h]}var y=new Uint8Array(4);y[0]=t?255*t[0]:255,y[1]=t?255*t[1]:255,y[2]=t?255*t[2]:255,y[3]=t&&t.length>3?255*t[3]:255;var f=new Float32Array(2);if(f[0]=null!=n&&2==n.length?n[0]:1,f[1]=null!=n&&2==n.length?n[1]:1,null!=o){var d=new Float32Array(4);d[0]=o[0],d[1]=o[1],d[2]=o[2],d[3]=o[3]}if(null!=l){var O=new Float32Array(4);O[0]=l[0],O[1]=l[1],O[2]=l[2],O[3]=l[3]}var u=new Uint32Array(1);u[0]=0;var w={};w[A.POSITION]=u,w[A.NORMAL]=u,w[A.UV0]=u,w[A.COLOR]=u,w[A.SIZE]=u,null!=o&&(w[A.AUXPOS1]=u),null!=l&&(w[A.AUXPOS2]=u);var g={};return g[A.POSITION]={size:3,data:s},g[A.NORMAL]={size:3,data:c},g[A.UV0]={size:v.length,data:v},g[A.COLOR]={size:4,data:y},g[A.SIZE]={size:2,data:f},null!=o&&(g[A.AUXPOS1]={size:4,data:d}),null!=l&&(g[A.AUXPOS2]={size:4,data:O}),new r(g,w,r.DefaultOffsets,"point")},createPointArrayGeometry:function(e,a){for(var t=new Float32Array(3*e.length),n=new Float32Array(a?3*e.length:3),o=new Uint32Array(e.length),i=new Uint32Array(e.length),l=0;l<e.length;l++)t[3*l]=e[l][0],t[3*l+1]=e[l][1],t[3*l+2]=e[l][2],a&&(n[3*l]=a[l][0],n[3*l+1]=a[l][1],n[3*l+2]=a[l][2]),o[l]=l,i[l]=0;a||(n[0]=0,n[1]=1,n[2]=0);var s=new Float32Array(2);s[0]=0,s[1]=0;var c={};c[A.POSITION]=o,c[A.NORMAL]=a?o:i,c[A.UV0]=i;var v={};return v[A.POSITION]={size:3,data:t},v[A.NORMAL]={size:3,data:n},v[A.UV0]={size:2,data:s},new r(v,c,r.DefaultOffsets,"point")},createTriangleGeometry:function(){var e=new Float32Array(9);e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=100,e[6]=100,e[7]=0,e[8]=0;var a=new Uint32Array(3);a[0]=0,a[1]=1,a[2]=2;var t=new Float32Array(3);t[0]=0,t[1]=1,t[2]=0;var n=new Uint32Array(3);n[0]=0,n[1]=0,n[2]=0;var o=new Float32Array(2);o[0]=0,o[1]=0;var i=new Uint32Array(3);i[0]=0,i[1]=0,i[2]=0;var l={};l[A.POSITION]=a,l[A.NORMAL]=n,l[A.UV0]=i;var s={};return s[A.POSITION]={size:3,data:e},s[A.NORMAL]={size:3,data:t},s[A.UV0]={size:2,data:o},new r(s,l)},createSquareGeometry:function(e){var a,t,n=new Float32Array(12);if(e)for(a=0;4>a;a++)for(t=0;3>t;t++)n[3*a+t]=e[a][t];else n[0]=-1,n[1]=-1,n[2]=0,n[3]=1,n[4]=-1,n[5]=0,n[6]=1,n[7]=1,n[8]=0,n[9]=-1,n[10]=1,n[11]=0;var o=new Uint32Array(6);o[0]=0,o[1]=1,o[2]=2,o[3]=2,o[4]=3,o[5]=0;var i=new Float32Array(3);i[0]=0,i[1]=0,i[2]=1;var l=new Uint32Array(6);for(a=0;6>a;a++)l[a]=0;var s=new Float32Array(8);s[0]=0,s[1]=0,s[2]=1,s[3]=0,s[4]=1,s[5]=1,s[6]=0,s[7]=1;var c=new Uint8Array(4);c[0]=255,c[1]=255,c[2]=255,c[3]=255;var v={};v[A.POSITION]=o,v[A.NORMAL]=l,v[A.UV0]=o,v[A.COLOR]=l;var h={};return h[A.POSITION]={size:3,data:n},h[A.NORMAL]={size:3,data:i},h[A.UV0]={size:2,data:s},h[A.COLOR]={size:4,data:c},new r(h,v)},createBoxGeometry:i(),createDiamondGeometry:l(),createTetrahedronGeometry:s(),createConeGeometry:function(e,a,t,n){var o,i=0,l=a,s=e,v=c.createFrom(0,i,0),h=c.createFrom(0,i+s,0),y=c.createFrom(0,-1,0),f=c.createFrom(0,1,0);n&&(i=s,h=c.createFrom(0,0,0),v=c.createFrom(0,i,0),y=c.createFrom(0,1,0),f=c.createFrom(0,-1,0));var d=[h,v],O=[y,f],u=t+2,w=0,g=Math.sqrt(s*s+l*l);if(n)for(o=t-1;o>=0;o--)w=o*(2*Math.PI/t),m=c.createFrom(Math.cos(w)*l,i,Math.sin(w)*l),d.push(m),I=c.createFrom(s*Math.cos(w)/g,-l/g,s*Math.sin(w)/g),O.push(I);else for(o=0;t>o;o++){w=o*(2*Math.PI/t);var m=c.createFrom(Math.cos(w)*l,i,Math.sin(w)*l);d.push(m);var I=c.createFrom(s*Math.cos(w)/g,l/g,s*Math.sin(w)/g);O.push(I)}var F=new Uint32Array(2*(t+2)*3),M=new Uint32Array(2*(t+2)*3),z=0,N=0;for(o=3;o<d.length;o++)F[z++]=1,F[z++]=o-1,F[z++]=o,M[N++]=0,M[N++]=0,M[N++]=0;for(F[z++]=d.length-1,F[z++]=2,F[z++]=1,M[N++]=0,M[N++]=0,M[N++]=0,o=3;o<d.length;o++)F[z++]=o,F[z++]=o-1,F[z++]=0,M[N++]=o,M[N++]=o-1,M[N++]=1;F[z++]=0,F[z++]=2,F[z++]=d.length-1,M[N++]=1,M[N++]=2,M[N++]=O.length-1;var U=1;Array.isArray(U)||(U=[U,U,U]);var P=new Float32Array(3*u);for(o=0;u>o;o++)P[3*o]=d[o][0]*U[0],P[3*o+1]=d[o][1]*U[1],P[3*o+2]=d[o][2]*U[2];var S=new Float32Array(3*u);for(o=0;u>o;o++)S[3*o]=O[o][0],S[3*o+1]=O[o][1],S[3*o+2]=O[o][2];var T={};T[A.POSITION]=F,T[A.NORMAL]=M;var R={};return R[A.POSITION]={size:3,data:P},R[A.NORMAL]={size:3,data:S},new r(R,T)},createCylinderGeometry:function(e,a,t,n,o,i){n||(n=c.createFrom(1,0,0)),o||(o=c.createFrom(0,0,0));var l=void 0===i?!0:i,s=c.create();c.normalize(n,s);var v=c.create();c.scale(s,Math.abs(e),v);var h=c.create();c.scale(v,-.5,h),c.add(h,o);var y=c.createFrom(0,1,0);Math.abs(1-c.dot(s,y)<.2)&&c.set3(0,0,1,y);var f=c.create();c.cross(s,y,f),c.normalize(f),c.cross(f,s,y);var d=2*t+(l?2:0),O=t+(l?2:0),u=new Float32Array(3*d),w=new Float32Array(3*O),g=new Float32Array(2*d),m=new Uint32Array(3*t*(l?4:2)),I=new Uint32Array(3*t*(l?4:2));l&&(u[3*(d-2)+0]=h[0],u[3*(d-2)+1]=h[1],u[3*(d-2)+2]=h[2],g[2*(d-2)]=0,g[2*(d-2)+1]=0,u[3*(d-1)+0]=u[3*(d-2)+0]+v[0],u[3*(d-1)+1]=u[3*(d-2)+1]+v[1],u[3*(d-1)+2]=u[3*(d-2)+2]+v[2],g[2*(d-1)]=1,g[2*(d-1)+1]=1,w[3*(O-2)+0]=-s[0],w[3*(O-2)+1]=-s[1],w[3*(O-2)+2]=-s[2],w[3*(O-1)+0]=s[0],w[3*(O-1)+1]=s[1],w[3*(O-1)+2]=s[2]);var F,M,z,N=function(r,e,a){m[r]=e,I[r]=a},U=0,P=c.create(),S=c.create();for(F=0;t>F;F++)z=F*(2*Math.PI/t),c.scale(y,Math.sin(z),P),c.scale(f,Math.cos(z),S),c.add(P,S),w[3*F+0]=P[0],w[3*F+1]=P[1],w[3*F+2]=P[2],c.scale(P,a),c.add(P,h),u[3*F+0]=P[0],u[3*F+1]=P[1],u[3*F+2]=P[2],g[2*F+0]=F/t,g[2*F+1]=0,u[3*(F+t)+0]=u[3*F+0]+v[0],u[3*(F+t)+1]=u[3*F+1]+v[1],u[3*(F+t)+2]=u[3*F+2]+v[2],g[2*(F+t)+0]=F/t,g[2*F+1]=1,M=(F+1)%t,N(U++,F,F),N(U++,F+t,F),N(U++,M,M),N(U++,M,M),N(U++,F+t,F),N(U++,M+t,M);if(l){for(F=0;t>F;F++)M=(F+1)%t,N(U++,d-2,O-2),N(U++,F,O-2),N(U++,M,O-2);for(F=0;t>F;F++)M=(F+1)%t,N(U++,F+t,O-1),N(U++,d-1,O-1),N(U++,M+t,O-1)}var T={};T[A.POSITION]=m,T[A.NORMAL]=I,T[A.UV0]=m;var R={};return R[A.POSITION]={size:3,data:u},R[A.NORMAL]={size:3,data:w},R[A.UV0]={size:2,data:g},new r(R,T)},createTubeGeometry:function(r,e,t,n,o){t=t||10,n=null!=n?n:!0,a.assert(r.length>1);for(var i=[[0,0,0]],l=[],s=[],c=0;t>c;c++){l.push([0,-c-1,-((c+1)%t)-1]);var v=c/t*2*Math.PI;s.push([Math.cos(v)*e,Math.sin(v)*e])}return O.createPathExtrusionGeometry(s,r,i,l,n,o)},createSquareTubeGeometry:function(r,e,t){t=t||!0,a.assert(r.length>1);var n=[],o=[[-1,-2,-3],[-3,-4,-1]],i=Math.SQRT2*e,l=[[i,i],[-i,i],[-i,-i],[i,-i]],s=[[0,1],[-1,0],[0,-1],[1,0]];return O.createPathExtrusionGeometry(l,r,n,o,t,s)},createPathExtrusionGeometry:function(e,a,t,n,i,l,s){var v,h=e.length,f=new Float32Array(a.length*h*3+(6*t.length||0)),d=new Float32Array(a.length*h+(2*t.length||0)),O=new Float32Array(a.length*h*3+(t?6:0)),u=0,w=0,g=0,m=(a.length-1)*h*6+3*n.length*2,I=new Uint32Array(m),F=new Uint32Array(m),M=0,z=0,N=c.create(),U=c.create(),P=c.create(),S=c.create(),T=c.create(),R=c.create(),L=c.create(),p=c.create(),V=c.create(),G=c.create(),b=c.create(),x=c.create();for(c.set3(0,1,0,x),c.subtract(a[1],a[0],U),c.normalize(U),i?(c.add(a[0],l,b),c.normalize(b,P)):c.set3(0,0,1,P),o(U,P,x,x,R,P,y),c.set(P,S),v=0;v<t.length;v++)c.scale(R,t[v][0],V),c.scale(P,t[v][2],b),c.add(V,b),c.add(V,a[0]),f[u++]=V[0],f[u++]=V[1],f[u++]=V[2],d[g++]=0;for(O[w++]=-U[0],O[w++]=-U[1],O[w++]=-U[2],v=0;v<n.length;v++)I[M++]=n[v][0]>0?n[v][0]:-n[v][0]-1+t.length,I[M++]=n[v][1]>0?n[v][1]:-n[v][1]-1+t.length,I[M++]=n[v][2]>0?n[v][2]:-n[v][2]-1+t.length,F[z++]=0,F[z++]=0,F[z++]=0;for(var C,D=t.length,E=t.length-1,q=0;q<a.length;q++){C=!1,q>0&&(i?(c.add(a[q],l,b),c.normalize(b,P)):c.set3(0,0,1,P),c.set(U,N),c.set(N,b),q<a.length-1?(c.subtract(a[q+1],a[q],U),c.normalize(U),c.add(b,U)):C=!0,o(b,P,S,x,R,P,y),c.set(P,S)),s&&(o(U,P,S,x,p,L,y),c.set(L,T));for(var X=0;h>X;X++)if(c.scale(R,e[X][0],V),c.scale(P,e[X][1],b),c.add(V,b),s?(c.scale(p,s[X][0],G),c.scale(L,s[X][1],b),c.add(G,b),c.normalize(G),c.scale(G,-1)):c.normalize(V,G),O[w++]=G[0],O[w++]=G[1],O[w++]=G[2],c.add(V,a[q]),f[u++]=V[0],f[u++]=V[1],f[u++]=V[2],d[g++]=e[X][1],!C){var K=(X+1)%h;if(I[M++]=D+X,I[M++]=D+h+X,I[M++]=D+K,I[M++]=D+K,I[M++]=D+h+X,I[M++]=D+h+K,s){var B;for(B=0;6>B;B++)F[z++]=D-E+X}else for(B=0;6>B;B++)F[z++]=I[M-6+B]-E}D+=h}for(C=a[a.length-1],v=0;v<t.length;v++)c.scale(R,t[v][0],V),c.scale(P,t[v][1],b),c.add(V,b),c.add(V,C),f[u++]=V[0],f[u++]=V[1],f[u++]=V[2],d[g++]=0;var Z=w/3;O[w++]=U[0],O[w++]=U[1],O[w++]=U[2];var Q=D-h;for(v=0;v<n.length;v++)I[M++]=n[v][0]>=0?D+n[v][0]:-n[v][0]-1+Q,I[M++]=n[v][2]>=0?D+n[v][2]:-n[v][2]-1+Q,I[M++]=n[v][1]>=0?D+n[v][1]:-n[v][1]-1+Q,F[z++]=Z,F[z++]=Z,F[z++]=Z;var j={};j[A.POSITION]=I,j[A.NORMAL]=F;var k={};return k[A.POSITION]={size:3,data:f},k.zOffset={size:1,data:d},k[A.NORMAL]={size:3,data:O},new r(k,j)},createPolylineGeometry:function(e){a.assert(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),a.assert(3===e[0].length,"createPolylineGeometry(): malformed vertex");for(var t=new Float32Array(3*e.length),n=new Uint32Array(2*(e.length-1)),o=0,i=0,l=0;l<e.length;l++){for(var s=0;3>s;s++)t[o++]=e[l][s];l>0&&(n[i++]=l-1,n[i++]=l)}var c={},v={};return c[A.POSITION]=n,v[A.POSITION]={size:3,data:t},new r(v,c,r.DefaultOffsets,"line")},addVertexColors:function(e,a,t){var n,o,i,l;if(t){var s={},c=e.getVertexAttr();for(l in c)s[l]=c[l];var v=e.getFaces();for(n=new Array(v.length),i=0;i<v.length;i++){o={};for(l in v[i].indices)o[l]=v[i].indices[l];n[i]={type:v[i].type,indices:o,positionKey:v[i].positionKey}}e=new r(n,s)}var h=a||[1,1,1,1],y=new Uint8Array(4);y[0]=255*h[0],y[1]=255*h[1],y[2]=255*h[2],y[3]=255*(h.length>3?h[3]:1);var f=e.getVertexAttr();for(f[A.COLOR]={size:4,data:y},n=e.getFaces(),i=0;i<n.length;i++){var d=n[i],O=d.indices[d.positionKey].length;o=new Uint32Array(O),d.indices[A.COLOR]=o}return e},addNormals:function(r){for(var a=r.getVertexAttr(),t=r.getFaces(),n=e.Vec3Compact.subtract,o=t.map(function(r){return r.indices.position.length/3}).reduce(function(r,e){return r+e}),i=new Float32Array(3*o),l=a.position.data,s=0,c=0;c<t.length;c++){for(var A=t[c].indices.position,h=new Uint32Array(A.length),y=0;y<A.length;y+=3){n(l,3*A[y],l,3*A[y+2],d,0),n(l,3*A[y],l,3*A[y+1],f,0),v.cross(f,d),v.normalize(f);var O=s/3;i[s++]=f[0],i[s++]=f[1],i[s++]=f[2],h[y]=O,h[y+1]=O,h[y+2]=O}t[c].indices.normal=h}a.normal={size:3,data:i}},cgToGIS:function(r){var e,a,t=r.getVertexAttr(),n=t.position.data,o=t.normal.data;if(o)for(e=0;e<o.length;e+=3)a=o[e+1],o[e+1]=-o[e+2],o[e+2]=a;if(n)for(e=0;e<n.length;e+=3)a=n[e+1],n[e+1]=-n[e+2],n[e+2]=a}};return O});