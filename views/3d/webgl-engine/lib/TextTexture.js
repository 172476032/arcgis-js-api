// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","./Texture","./Util","../../../webgl/Texture","../../../webgl/enums"],function(t,e,i,r,h,n){function o(){var t=document.createElement("canvas");return t.width=_,t.height=_,t}function s(t,e){return"center"===t?.5*e:"right"===t?e:0}function a(t){var e=t.slice(0,3).map(function(t){return Math.floor(255*t)}).toString();return"rgb("+e+")"}function l(t){var e=t.slice(0,3).map(function(t){return Math.floor(255*t)}).toString();return"rgba("+e+","+t[3]+")"}function d(){return g}for(var _=512,u=2048,p=function(){function t(t,e,i,h){void 0===h&&(h=!0),this._idHint=i,this._text=t,this._textLines=t.split(/\r?\n/),this._params=e;var n=this._params.halo.size;this._haloSize=Math.round(n),this._fillStyle=l(this._params.color),this._haloStyle=a(this._params.halo.color),this._textWidth=this._computeTextWidth(),this._lineHeight=this._computeLineHeight(),this._textHeight=this._computeTextHeight(),h?this._scaleFactor=Math.min(1,Math.min(u/this._textWidth,u/this._textHeight)):this._scaleFactor=1,this._renderedWidth=Math.round(this._textWidth*this._scaleFactor),this._renderedHeight=Math.round(this._textHeight*this._scaleFactor),h&&r.assert(this._renderedWidth<=u&&this._renderedHeight<=u),this._width=r.nextHighestPowerOfTwo(this._renderedWidth),this._height=r.nextHighestPowerOfTwo(this._renderedHeight)}return t.prototype.getId=function(){return null==this._id&&(this._id=i.idGen.gen(this._idHint)),this._id},t.prototype.getParams=function(){return this._params},t.prototype.getText=function(){return this._text},t.prototype.deferredLoading=function(){return!1},t.prototype.getWidth=function(){return this._width},t.prototype.getHeight=function(){return this._height},t.prototype.getTextWidth=function(){return this._textWidth},t.prototype.getTextHeight=function(){return this._textHeight},t.prototype.getRenderedWidth=function(){return this._renderedWidth},t.prototype.getRenderedHeight=function(){return this._renderedHeight},t.prototype.initializeThroughRender=function(t,e){var i=this._getTextCanvas();i.width=this._width,i.height=this._height;var r=i.getContext("2d");r.save(),e.samplingMode=9987,e.wrapMode=33071,e.flipped=!0,e.preMultiplyAlpha=!0,e.hasMipmap=!0,this.renderText(this._renderedWidth,this._renderedHeight,r,0,this._height-this._renderedHeight);var n=new h(t,e,i);return r.restore(),n},t.prototype.getTexcoordScale=function(){return[this._renderedWidth/this._width,this._renderedHeight/this._height]},t.prototype.setUnloadFunc=function(t){this._unloadFunc=t},t.prototype.unload=function(){this._unloadFunc&&(this._unloadFunc(this._id),this._unloadFunc=null)},t.prototype.renderText=function(t,e,i,r,h){void 0===r&&(r=0),void 0===h&&(h=0);var n=this._lineHeight*this._scaleFactor,o=this._haloSize,a=s(i.textAlign,t)+o,l=o;i.save();var u=o>0,p=3>o;if(u){var g=l,c=this._getHaloCanvas();c.width=Math.max(_,this._renderedWidth),c.height=Math.max(_,this._renderedHeight);var f=c.getContext("2d");if(f.clearRect(0,0,c.width,c.height),this._setFontProperties(f,this._params.size*this._scaleFactor),f.fillStyle=this._haloStyle,f.strokeStyle=this._haloStyle,f.lineJoin=p?"miter":"round",p)for(var x=0,v=this._textLines;x<v.length;x++){for(var m=v[x],y=0,H=d();y<H.length;y++){var w=H[y],T=w[0],M=w[1];f.fillText(m,a+o*T,l+o*M)}g+=n}else for(var S=0,W=this._textLines;S<W.length;S++){for(var m=W[S],C=2*o,F=5,b=.1,z=0;F>z;z++){var L=1-(F-1)*b,P=L+z*b;f.lineWidth=P*C,f.strokeText(m,a,g)}g+=n}i.globalAlpha=this._params.halo.color[3],i.drawImage(c,r,h),c.width=_,c.height=_,i.globalAlpha=1}this._setFontProperties(i,this._params.size*this._scaleFactor);for(var g=h+l,A=0,D=this._textLines;A<D.length;A++){var m=D[A];i.globalCompositeOperation="destination-out",i.fillStyle="rgb(0, 0, 0)",i.fillText(m,r+a,g),i.globalCompositeOperation="source-over",i.fillStyle=this._fillStyle,i.fillText(m,r+a,g),g+=n}i.restore()},t.preferredAtlasSize=function(){return _},t.prototype._getTextCanvas=function(){return null==t._textCanvas2D&&(t._textCanvas2D=o()),t._textCanvas2D},t.prototype._getHaloCanvas=function(){return null==t._haloCanvas2D&&(t._haloCanvas2D=o()),t._haloCanvas2D},t.prototype._setFontProperties=function(t,e){var i=this._params.font,r=i.style+" "+i.weight+" "+e+"px "+i.family;t.font=r,t.textAlign="left",t.textBaseline="top"},t.prototype._computeTextWidth=function(){var t=this._getTextCanvas(),e=t.getContext("2d");this._setFontProperties(e,this._params.size);for(var i=0,r=0,h=this._textLines;r<h.length;r++){var n=h[r],o=e.measureText(n).width;o>i&&(i=o)}var s=this._params.font;return("italic"===s.style||"oblique"===s.style||"string"==typeof s.weight&&("bold"===s.weight||"bolder"===s.weight)||"number"==typeof s.weight&&s.weight>600)&&(i+=.3*e.measureText("A").width),i+=2*this._haloSize,i=Math.round(i)},t.prototype._computeLineHeight=function(){var t=1.275*this._params.size;return Math.floor(t+2*this._haloSize)},t.prototype._computeTextHeight=function(){return this._computeLineHeight()*this._textLines.length},t}(),g=[],c=16,f=0;360>f;f+=360/c)g.push([Math.cos(Math.PI*f/180),Math.sin(Math.PI*f/180)]);return p});