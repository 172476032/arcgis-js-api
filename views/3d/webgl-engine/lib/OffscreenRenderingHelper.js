// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","dojo/text!../materials/internal/offscreen.xml","./DefaultVertexAttributeLocations","./glUtil3D","./Util","../../../webgl/FramebufferObject","../../../webgl/Program","../../../webgl/Texture","../../../webgl/Util"],function(e,t,r,i,a,n,h,s,o,u){var f={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},l={target:3553,pixelFormat:6408,dataType:32819,samplingMode:9729,wrapMode:33071,width:0,height:0},d=function(){function e(e,t){this._hudVisibilityTexture=null,this._intermediateTexture=null,this._enabled=!1,this.width=0,this.height=0,this._programRep=e,this._rctx=t,this.width=null,this.height=null}return e.prototype.enable=function(){if(!this.getEnableState()){var e=this._rctx;this._enabled=!0;var t=e.capabilities.depthTexture?4:3;this.framebuffer=h.createWithAttachments(e,f,{colorTarget:0,depthStencilTarget:t}),this.quadVAO=a.createQuadVAO(e)}},e.prototype.disable=function(){this.getEnableState()&&(this._enabled=!1,this.framebuffer.dispose(),this.quadVAO.dispose(!0),this.framebuffer=null,this.quadVAO=null,this._depthStencilTextureCached=null)},e.prototype.setEnableState=function(e){e?this.enable():this.disable()},e.prototype.getEnableState=function(){return this._enabled},e.prototype.getColorTexture=function(){return this.framebuffer.colorTexture},e.prototype.getDepthTexture=function(){return e.supportsDepthTexture(this._rctx)?this.framebuffer.depthStencilTexture||this._depthStencilTextureCached:null},e.prototype.getHUDVisibilityTexture=function(){return this._hudVisibilityTexture},e.supportsDepthTexture=function(e){return e.capabilities.depthTexture},e.prototype.initializeFrame=function(e){n.assert(this.getEnableState());var t=this._rctx,r=t.gl,i=e.fullViewport;this.width=i[2],this.height=i[3],this.framebuffer.resize(this.width,this.height),t.bindFramebuffer(this.framebuffer),t.setClearStencil(0),t.setClearColor(0,0,0,1),t.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT)},e.prototype.renderSeparateColor=function(e,t,r){void 0===r&&(r=p);var i=this._rctx,a=i.gl;e.resize(this.width,this.height);var n=this.framebuffer.detachColorTexture();this.framebuffer.attachColorTexture(e),i.bindFramebuffer(this.framebuffer);var h=Math.max(1e-13,r[3]);i.setClearColor(r[0],r[1],r[2],h),i.clear(a.COLOR_BUFFER_BIT),t(),a.flush(),this.framebuffer.detachColorTexture(),this.framebuffer.attachColorTexture(n)},e.prototype.renderSeparateAndComposite=function(e,t,r){void 0===t&&(t=p),void 0===r&&(r=c),this._intermediateTexture||(this._intermediateTexture=new o(this._rctx,f)),this.renderSeparateColor(this._intermediateTexture,e),this.composite(this._intermediateTexture,this.framebuffer,r)},e.prototype.renderHUDVisibility=function(e){this._hudVisibilityTexture||(this._hudVisibilityTexture=new o(this._rctx,l)),this.renderSeparateColor(this._hudVisibilityTexture,e,b)},e.prototype.bindFramebuffer=function(){this._rctx.bindFramebuffer(this.framebuffer)},e.prototype.getFramebuffer=function(){return this.framebuffer},e.prototype.detachDepthTextureFromBuffer=function(){this._depthStencilTextureCached=this.framebuffer.depthStencilTexture,this.framebuffer.detachDepthStencilTexture()},e.prototype.restoreDepthTextureToBuffer=function(){this.framebuffer.attachDepthStencilTexture(this._depthStencilTextureCached),this._depthStencilTextureCached=null},e.prototype.composite=function(e,t,r){void 0===e&&(e=this.framebuffer.colorTexture),void 0===t&&(t=null),void 0===r&&(r=c);var i=this._rctx,a=this._programRep.get("offscreenProgram");switch(i.bindFramebuffer(t),i.setDepthTestEnabled(!1),i.bindProgram(a),a.setUniform1i("tex",1),i.bindTexture(e,1),r){case"none":i.setBlendingEnabled(!1);break;case"alpha":i.setBlendingEnabled(!0),i.setBlendFunction(770,771);break;case"premultiplied-alpha":i.setBlendingEnabled(!0),i.setBlendFunction(1,771)}i.bindVAO(this.quadVAO),i.drawArrays(5,0,u.vertexCount(this.quadVAO,"geometry")),i.setDepthTestEnabled(!0),i.setBlendingEnabled(!1)},e.loadShaders=function(e,t,a){e._parse(r);var n=new s(a,e.vsOffscreenRenderer,e.fsOffscreenRenderer,i.Default3D);t.add("offscreenProgram",n)},e}(),p=[0,0,0,0],c="none",b=[0,0,0,1];return d});