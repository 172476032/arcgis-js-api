// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/assignHelper","../../../../../core/tsSupport/extendsHelper","dojo/text!./RibbonEdgeRenderer.xml","../../../lib/glMatrix","../../../support/mathUtils","../ShaderVariations","../Util","./EdgeRenderer","./ribbonEdgeBufferWriters"],function(e,t,i,r,s,n,o,a,g,h,d){Object.defineProperty(t,"__esModule",{value:!0});var u=function(e){function t(r,s,o,a){var g=e.call(this,r,s,t.getKey(o))||this;g.tmpViewToWorldNormalMatrix=n.mat3d.create();var h=a.strokesTexture.variants;g.settings=i({},l,t.materialSettings(o),a);var u=i({},g.settings,{variants:h});return g.edgeBufferWriters={default:{writer:new d.RibbonDefaultEdgeBufferWriter(u),glLayout:d.RibbonDefaultEdgeBufferWriter.glLayout},silhouette:{writer:new d.RibbonSilhouetteBufferWriter(u),glLayout:d.RibbonSilhouetteBufferWriter.glLayout}},g.createPrograms(),g}return r(t,e),t.prototype.begin=function(e){},t.prototype.bindEdges=function(e,t){this.bind(this.programs.edge,e,t)},t.prototype.bindSilhouettes=function(e,t){this.bind(this.programs.silhouette,e,t)},t.prototype.bind=function(e,t,i){this.rctx.bindProgram(e),e.setUniformMatrix4fv("uProj",t.proj),e.setUniform2f("uDepthBias",this.depthBiasXY,this.depthBiasZ),e.setUniform2f("uPixelToNDC",2/t.viewport[2],2/t.viewport[3]),e.setUniform2f("uNDCToPixel",t.viewport[2]/2,t.viewport[3]/2),e.setUniform1f("uDistanceFalloffFactor",i.distanceFalloffFactor),e.setUniform2f("uViewportDimInv",1/t.viewport[2],1/t.viewport[3])},t.prototype.renderEdges=function(e,t,i){this.render(this.programs.edge,e,e.edgeVAO,t,i)},t.prototype.renderSilhouettes=function(e,t,i){this.render(this.programs.silhouette,e,e.silhouetteVAO,t,i)},t.prototype.numberOfPrimitives=function(e){return e.edgeLoD.lengths.length+(e.silhouetteLoD?e.silhouetteLoD.lengths.length:0)},t.prototype.render=function(e,t,i,r,s){if(i){this.setUniforms(e,t,r);var n=this.rctx;n.bindVAO(i),n.capabilities.instancing.drawArraysInstanced(6,0,4,s)}},t.prototype.setUniforms=function(e,t,i){t.componentBuffer.textureBuffer.bind(e,h.componentColorBindParameters),e.setUniformMatrix4fv("uView",i.view),e.setUniformMatrix4fv("uModel",t.modelTransform);var r=i.viewInvTransp,s=n.mat4d.toMat3(r,this.tmpViewToWorldNormalMatrix);if(e.setUniform3f("uCameraPosition",r[3],r[7],r[11]),e.setUniformMatrix3fv("uViewToWorldNormalMatrix",s),!this.settings.uber){var o=t.material.size;e.setUniform1i("uLineWidth",Math.round(o));var a=t.material.extensionLength;e.setUniform1i("uExtensionLength",Math.round(g.clamp(a,0,255)))}(this.settings.uber||"sketch"===t.material.type)&&this.setSketchUniforms(e),e.setUniform1f("uWorldLineRadiusPerDistance",Math.tan(i.fovY/2)/(i.viewport[3]/2)),e.setUniform3fv("uLocalOrigin",t.origin.vec3),this.shadowsEnabled&&i.shadowMappingEnabled&&i.shadowMap.bindView(e,t.origin.vec3)},t.prototype.setSketchUniforms=function(e){var t=this.settings.strokesTexture,i=t.texture;this.rctx.bindTexture(i,0),e.setUniform1i("uStrokesTexture",0),e.setUniform2f("uStrokesTextureScale",1/i.descriptor.width,1/i.descriptor.height),e.setUniform1f("uStrokesLog2Resolution",o.log2(t.resolution)),e.setUniform1f("uStrokesNormalizationScale",t.normalizationScale),e.setUniform1f("uStrokesAmplitude",t.amplitude),e.setUniform1f("uStrokeVariants",t.variants)},Object.defineProperty(t.prototype,"shadowsEnabled",{get:function(){var e="smooth"===this.settings.lighting||"flat"===this.settings.lighting;return this.settings.receiveShadows&&(this.settings.uber||e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ssaoEnabled",{get:function(){var e="smooth"===this.settings.lighting||"flat"===this.settings.lighting;return this.settings.receiveSSAO&&(this.settings.uber||e)},enumerable:!0,configurable:!0}),t.prototype.end=function(e){},t.prototype.getDefines=function(e){return[e.silhouette,this.settings.antialiasing&&!!this.rctx.capabilities.blendMinMax,this.shadowsEnabled,this.ssaoEnabled,"smooth"===this.settings.lighting&&!this.settings.uber,"flat"===this.settings.lighting&&!this.settings.uber,"emissive"===this.settings.lighting&&!this.settings.uber,"sketch"===this.settings.lighting&&!this.settings.uber,this.settings.pressure,this.settings.uber]},t.prototype.createPrograms=function(){this.addProgram("edge",this.programRepository.getShaderVariationsProgram(f,this.getDefines({silhouette:!1}),void 0,void 0,h.attributeLocations)),this.addProgram("silhouette",this.programRepository.getShaderVariationsProgram(f,this.getDefines({silhouette:!0}),void 0,void 0,h.attributeLocations))},t.materialSettings=function(e){return e?"solid"===e.type?{lighting:"emissive"}:"sketch"===e.type?{lighting:"sketch"}:{lighting:"smooth"}:{}},t.loadShaders=function(e,t,i){if(e.fsRibbonEdge||e._parse(s),!t.getShaderVariations(f)){var r=new a("ribbonEdge",["vsRibbonEdge","fsRibbonEdge"],null,t,e,i);r.addDefine("Silhouette","SILHOUETTE"),r.addDefine("AntiAliasing","ANTIALIASING"),r.addDefine("ReceiveShadows","RECEIVE_SHADOWS"),r.addDefine("AmbientOcclusion","RECEIVE_SSAO"),r.addDefine("SmoothLighting","SMOOTH_LIGHTING"),r.addDefine("FlatLighting","FLAT_LIGHTING"),r.addDefine("EmissiveLighting","EMISSIVE_LIGHTING"),r.addDefine("Sketch","SKETCH"),r.addDefine("Pressure","PRESSURE"),r.addDefine("Uber","UBER"),t.addShaderVariations(f,r)}},t.getKey=function(e,t){if(!e)return"ribbon-uber";var r=i({},l,this.materialSettings(e),t);return"ribbon-s:"+e.size+"-e:"+e.extensionLength+"-aa:"+r.antialiasing+"-sh:"+r.receiveShadows+"-l:"+r.lighting},t}(h.EdgeRenderer);t.RibbonEdgeRenderer=u;var f="ribbon-edge-shader-variations",l={antialiasing:!0,lighting:"smooth",receiveShadows:!0,receiveSSAO:!0,uber:!0,pressure:!0,strokesTexture:null};t.default=u});