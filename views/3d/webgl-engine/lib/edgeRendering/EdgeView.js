// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../../core/tsSupport/assignHelper","../../../../../core/arrayUtils","../../../lib/glMatrix","../../../support/meshProcessing","../../../support/buffer/BufferView","../../../support/buffer/InterleavedLayout","../../../support/buffer/typedArrayUtil","../localOriginHelper","../LocalOriginManager","../PreinterleavedGeometryData","../RegularGridLocalOriginFactory","../Util","../TextureBackedBuffer/BufferManager","./EdgeRenderer","./RibbonEdgeRenderer","./strokes"],function(e,t,r,n,o,i,s,a,d,c,f,u,g,l,p,h,m,v){Object.defineProperty(t,"__esModule",{value:!0});var y=function(){function e(e,t){this.rctx=e,this.programRepository=t,this.debugSettings={antialiasing:!0,receiveShadows:!0},this.profilingCallback=null,this.gpuMemoryUsage=0,this.geometries=new Map,this.renderers=new Map,this.localOrigins=new f.LocalOriginManager(new g(1e4)),this.tmpModelPosition=o.vec3d.create(),this.tmpCameraPosition=o.vec3d.create(),this.componentColorManager=new p.BufferManager(this.rctx)}return e.isSupported=function(e){return!!e.capabilities.instancing},e.prototype.computeModelTransformWithLocalOrigin=function(e,t,r){if(e.getCombinedStaticTransformation(t,r),t.origin)this.localOrigins.register(t.origin);else{var n=o.vec3d.set3(r[12],r[13],r[14],this.tmpModelPosition);t.origin=this.localOrigins.aquire(n)}return c.applyToModelMatrix(t.origin.vec3,r),r},e.prototype.selectIndexData=function(e,t){if(t){for(var r=d.slice(t),n=0;n<r.length;n++)r[n]=e[r[n]];return r}return e},e.prototype.assignPerComponentAttributes=function(e,t,r,n){for(var o=[],i=this.componentColorManager.getBuffer(t.length),s=!1,a=null,d=null,c=null,f=0;f<t.length;f++){var u=t[f],g=u.color,l=255*g[0],p=255*g[1],h=255*g[2],m=255*g[3],v=i.aquireIndex();o.push({index:v,material:u}),i.textureBuffer.setData(v,l,p,h,m);var y=r[f],b=r[f+1];null!=a&&a!==u.size&&(s=!0),null!=c&&c!==u.extensionLength&&(s=!0),null!=d&&d!==u.type&&(s=!0),a=u.size,d=u.type,c=u.extensionLength;var x=void 0;switch(d){case"solid":x=0;break;case"sketch":x=1}if(n)for(var I=y;I<b;I++){var B=n[I];e.colorIndexBuffer.set(B,v),e.lineWidthBuffer.set(B,a),e.extensionsBuffer.set(B,c),e.typeBuffer.set(B,x)}else for(var I=y;I<b;I++)e.colorIndexBuffer.set(I,v),e.lineWidthBuffer.set(I,a),e.extensionsBuffer.set(I,c),e.typeBuffer.set(I,x)}return{components:o,componentColorBuffer:i,requiresUberRenderer:s}},e.prototype.extractEdgeInformation=function(e,t){var r=i.deduplicate(e.buffer,e.stride/4),n=this.selectIndexData(r.indices,t);return{faces:n,neighbors:i.computeNeighbors(n,r.uniqueCount),vertices:b.createView(r.buffer)}},e.prototype.addGeometryNonPreinterleaved=function(e,t,r,n,i){var s=r.getAttribute("position"),a=this.computeModelTransformWithLocalOrigin(e,n,o.mat4d.create()),d=n.origin,c={position:s,indices:r.getIndices("position"),modelTransform:a,origin:d},f=this.addNonPreinterleaved(e,c,i);this.geometries.set(t,f)},e.prototype.addNonPreinterleaved=function(e,t,r){for(var n=t.position,o=n.data.length/n.strideIdx,i=new s.BufferViewVec3f64(new Float64Array(3*o).buffer),a=0;a<o;a++)i.set(a,0,n.data[n.offsetIdx+a*n.strideIdx+0]),i.set(a,1,n.data[n.offsetIdx+a*n.strideIdx+1]),i.set(a,2,n.data[n.offsetIdx+a*n.strideIdx+2]);for(var d=b.createBuffer(i.count),a=0;a<i.count;a++)d.position.set(a,0,i.get(a,0)),d.position.set(a,1,i.get(a,1)),d.position.set(a,2,i.get(a,2));var c={colorIndexBuffer:d.componentIndex,lineWidthBuffer:d.lineWidth,typeBuffer:d.type,extensionsBuffer:d.extensions},f=this.assignPerComponentAttributes(c,[r],[0,d.componentIndex.count]),u=f.components,g=f.componentColorBuffer,l=this.extractEdgeInformation(d,t.indices),p=t.modelTransform,h=t.origin,m={modelTransform:p,origin:h,componentBuffer:g},v=this.getRendererInfo(r),y=v.renderer,x=y.createInstance(m,l,r),I={renderInstance:x,object:e,visible:!0,components:u,componentColorBuffer:g,distanceToCamera:0};return this.gpuMemoryUsage+=x.gpuMemoryUsage,v.objects.add(I),{objectData:I,renderer:y}},e.prototype.addGeometryPreinterleaved=function(e,t,r,n,i){var a=r.getAttribute("position");if(!(a&&a.data instanceof Float32Array))return void console.warn("Geometry has no float32 `position` attribute, skipping it.");for(var d=this.computeModelTransformWithLocalOrigin(e,n,o.mat4d.create()),c=n.origin,f=r.getIndices("position"),u=new s.BufferViewVec3f(a.data.buffer,4*a.offsetIdx,4*a.strideIdx),g=b.createBuffer(u.count),l=0;l<u.count;l++)g.position.set(l,0,u.get(l,0)),g.position.set(l,1,u.get(l,1)),g.position.set(l,2,u.get(l,2));var p={colorIndexBuffer:g.componentIndex,lineWidthBuffer:g.lineWidth,extensionsBuffer:g.extensions,typeBuffer:g.type},h=this.assignPerComponentAttributes(p,i,r.componentOffsets,f),m=h.components,v=h.componentColorBuffer,y=h.requiresUberRenderer,x=this.extractEdgeInformation(g,f),I={modelTransform:d,origin:c,componentBuffer:v},B=y?null:i[0],C=this.getRendererInfo(B),M=C.renderer,w=M.createInstance(I,x,B),E={renderInstance:w,object:e,visible:!e.isHidden(n),components:m,componentColorBuffer:v,distanceToCamera:0};this.gpuMemoryUsage+=w.gpuMemoryUsage,this.geometries.set(t,{renderer:M,objectData:E}),C.objects.add(E)},e.prototype.addObject=function(e,t,r){if(r&&r.mergeGeometries&&e.geometries.length>1)this.addObjectMergedGeometries(e,t);else for(var n=0;n<e.geometries.length;n++){var o=e.geometries[n],i=e.geometryRecords[n],s=i.materials[0];s.supportsEdges&&(o.data instanceof u?this.addGeometryPreinterleaved(e,o,o.data,i,t):this.addGeometryNonPreinterleaved(e,o,o.data,i,t[0]))}},e.prototype.addObjectMergedGeometries=function(e,t){for(var r=new Map,n=0,i=null,s=null,a=null,d=0;d<e.geometries.length;d++){var c=e.geometries[d],f=e.geometryRecords[d],g=f.materials[0];if(g.supportsEdges){if(c.data instanceof u)return console.error("Cannot merge geometries with pre interleaved geometry data"),this.addObject(e,t);if(s){if(!l.arraysEqual(s,f.transformation))return console.error("Cannot merge geometries with differing geometry transforms"),this.addObject(e,t)}else s=f.transformation;if(!a&&f.origin)a=f;else if(a&&f.origin&&a.origin.id!==f.origin.id)return console.error("Cannot merge geometries with differing origins"),this.addObject(e,t);var p=c.data.getIndices("position");n+=p?p.length:0,(p&&null==i||i===Uint16Array)&&(i=p instanceof Uint16Array?Uint16Array:Uint32Array)}}for(var h=n?new i(n):null,m=[],v=0,d=0;d<e.geometries.length;d++){var c=e.geometries[d],y=e.geometryRecords[d],g=y.materials[0];if(g.supportsEdges){var b=c.data.getAttribute("position"),p=c.data.getIndices("position"),x=r.get(b.data);if(null==x){x=m.length/3;for(var I=b.offsetIdx;I<b.data.length;I+=b.strideIdx)m.push(b.data[I+0]),m.push(b.data[I+1]),m.push(b.data[I+2]);r.set(b.data,x)}if(p)for(var B=0;B<p.length;B++)h[v++]=x+p[B]}}for(var C=a||e.geometryRecords[0],M=this.computeModelTransformWithLocalOrigin(e,C,o.mat4d.create()),w=C.origin,d=0;d<e.geometryRecords.length;d++)e.geometryRecords[d].origin=w;var E={position:{data:m,offsetIdx:0,strideIdx:3},indices:h,modelTransform:M,origin:w},j=this.addNonPreinterleaved(e,E,t[0]);this.geometries.set(e.geometries[0],j)},e.prototype.hasObject=function(e){return this.geometries.has(e.geometries[0])},e.prototype.updateComponentColor=function(e,t,r){for(var n=0;n<e.geometries.length;n++){var o=e.geometries[n],i=this.geometries.get(o);if(!i)return;var s=i.objectData,a=s.components[t].index;s.componentColorBuffer.textureBuffer.setData(a,255*r[0],255*r[1],255*r[2],255*r[3])}},e.prototype.updateComponentOpacity=function(e,t,r){for(var n=0;n<e.geometries.length;n++){var o=e.geometries[n],i=this.geometries.get(o);if(!i)return;var s=i.objectData,a=s.components[t];s.componentColorBuffer.textureBuffer.setDataElement(a.index,3,255*r)}},e.prototype.updateObjectVisibility=function(e,t){for(var r=0;r<e.geometries.length;r++){var n=e.geometries[r],o=this.geometries.get(n);if(!o)return;o.objectData.visible=t}},e.prototype.getComponentMaterial=function(e,t){var r=this.geometries.get(e.geometries[0]);if(r){return r.objectData.components[t].material}},e.prototype.removeObject=function(e){for(var t=0;t<e.geometries.length;t++){var r=e.geometries[t],n=this.geometries.get(r);n&&(this.removeGeometry(n),this.geometries.delete(r))}},e.prototype.removeGeometry=function(e){var t=e.objectData,r=this.renderers.get(e.renderer.key);r.objects.delete(e.objectData),this.localOrigins.release(t.renderInstance.origin),e.renderer.disposeInstance(t.renderInstance),this.gpuMemoryUsage-=t.renderInstance.gpuMemoryUsage;for(var n=0,o=t.components;n<o.length;n++){var i=o[n];t.componentColorBuffer.releaseIndex(i.index)}0===r.objects.size&&(this.renderers.delete(r.renderer.key),e.renderer.dispose())},e.prototype.removeAll=function(){var e=this;this.geometries.forEach(function(t){e.removeGeometry(t)}),this.geometries.clear()},e.prototype.createSolidEdgeMaterial=function(e){return r({},x,e,{type:"solid"})},e.prototype.createSketchEdgeMaterial=function(e){return r({},I,e,{type:"sketch"})},e.prototype.estimateLengthAtDistance=function(e,t,r){return t*(r/e.fullWidth)*2*Math.tan(.5*e.fovX)},e.prototype.render=function(e,t){var r=this;this.localOrigins.updateViewMatrices(t.view),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures();var n=t.view,o=0;this.geometries.forEach(function(e){o+=e.objectData.renderInstance.averageEdgeLength});var i=o/this.geometries.size,s={distanceFalloffFactor:40*i,minimumEdgeLength:this.estimateLengthAtDistance(e,1,3.5)},a=this.rctx.capabilities.blendMinMax;a?(this.rctx.setDepthWriteEnabled(!1),this.rctx.setBlendingEnabled(!0),this.rctx.setBlendEquationSeparate(32774,a.MAX),this.rctx.setBlendFunctionSeparate(1,0,1,1)):(this.rctx.setDepthWriteEnabled(!0),this.rctx.setBlendingEnabled(!1)),this.rctx.setDepthTestEnabled(!0),this.rctx.setDepthFunction(515),this.updateObjectCameraDistances(t),this.renderers.forEach(function(e){var n=e.renderer,o=e.objects;n.begin(t),r.renderEdges(n,o,t,s),r.renderSilhouettes(n,o,t,s),n.end(t)}),this.rctx.setDepthWriteEnabled(!0),this.rctx.setDepthFunction(513),this.rctx.setBlendEquationSeparate(32774,32774),this.rctx.setBlendFunctionSeparate(1,0,1,1),t.view=n},Object.defineProperty(e.prototype,"compositingMode",{get:function(){return"alpha"},enumerable:!0,configurable:!0}),e.prototype.updateObjectCameraDistances=function(e){var t=this,r=e.viewInvTransp;o.vec3d.set3(r[3],r[7],r[11],this.tmpCameraPosition),this.renderers.forEach(function(e){e.renderer;e.objects.forEach(function(e){e.distanceToCamera=o.vec3d.dist(e.object.getCenter(),t.tmpCameraPosition)})})},e.prototype.findLowerBoundIndex=function(e,t){var r=n.binaryIndexOf(e,t,!0);return-1===r?t<e[0]?0:e.length:r},e.prototype.computeEdgeCount=function(e,t,r){var n=e.length,o=t*r.minimumEdgeLength;return n-this.findLowerBoundIndex(e,o)},e.prototype.renderEdges=function(e,t,r,n){var o=this;e.bindEdges(r,n),t.forEach(function(t){if(t.visible){var i=o.computeEdgeCount(t.renderInstance.edgeLoD.lengths,t.distanceToCamera,n);r.view=o.localOrigins.getViewMatrix(t.renderInstance.origin),e.renderEdges(t.renderInstance,r,i)}})},e.prototype.renderSilhouettes=function(e,t,r,n){var o=this;e.bindSilhouettes(r,n),t.forEach(function(t){if(t.visible){var i=o.computeEdgeCount(t.renderInstance.silhouetteLoD.lengths,t.distanceToCamera,n);r.view=o.localOrigins.getViewMatrix(t.renderInstance.origin),e.renderSilhouettes(t.renderInstance,r,i)}})},e.prototype.rendererClassCreator=function(e){var t=this.debugSettings,n=t.antialiasing,o=t.receiveShadows;this.strokesTexture||(this.strokesTexture=v.generateStrokesTexture(this.rctx));var i={antialiasing:n,receiveShadows:o,strokesTexture:this.strokesTexture};return e?{create:function(e,t,n){return new m.default(e,t,n,r({},i,{uber:!1}))},key:m.default.getKey(e)}:{create:function(e,t,n){return new m.default(e,t,null,r({},i,{uber:!0}))},key:m.default.getKey(e)}},e.prototype.getRendererInfo=function(e){var t=this.rendererClassCreator(e),r=this.renderers.get(t.key);if(r)return r;var n=t.create(this.rctx,this.programRepository,e),o=new Set,i={renderer:n,objects:o};return this.renderers.set(t.key,i),i},e.loadShaders=function(e,t,r){h.default.loadShaders(e,t,r),m.default.loadShaders(e,t,r)},e.prototype.getGpuMemoryUsage=function(){return this.gpuMemoryUsage/1048576},e}();t.EdgeView=y;var b=a.newLayout().vec3f("position").u16("componentIndex").u8("lineWidth").u8("type").i8("extensions").vec2u8("_padding",{glPadding:!0}).u8("_padding2",{glPadding:!0}),x={color:o.vec4d.createFrom(0,0,0,.2),size:1,extensionLength:0},I={color:o.vec4d.createFrom(0,0,0,.2),size:1,extensionLength:0}});