// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","./IntervalUtilities","./ModelDirtyTypesTs","./Float32ArrayList","./InstanceBufferData","../lighting/SceneLighting","./LinearDepthTextureHelper","./NormalTextureHelper","./HighlightTextureHelper","./RenderPass","./RenderSlot","./RenderContext","./ExternalRendererContainer","./StencilRenderingHelper","./Util","./gl-matrix","./ComponentUtils","../../../webgl/Texture","../../../webgl/VertexArrayObject","../../../webgl/BufferObject","../../../webgl/Util","./FxaaRenderPass","./SmaaRenderPass","../../../webgl/enums","./DefaultVertexAttributeLocations","../../../webgl/Profiling","../materials/HUDMaterial"],function(e,t,r,a,i,n,s,o,l,d,h,g,f,u,p,m,_,c,v,y,x,R,b,I,D,A,O,P){function T(e){var t=e.instanceParameters.componentVisibilities,r=e.componentOffsets,a=c.generateVisibleIndexRanges(t,r);return a}function C(e){var t=e.instanceParameters.componentVisibilities,r=e.instanceParameters.componentHighlights,a=e.componentOffsets,i=c.generateHighlightedIndexRanges(t,r,a);return i}function H(e,t,r){var a=e.origin.vec3;V(X,-a[0],-a[1],-a[2]),F.multiply(X,e.transformation,t),F.inverse(t,r),F.transpose(r)}function M(e,t,r){for(var a in e){var i=e[a];t(a,i);for(var n in i.origin2data){var s=i.origin2data[n];r(n,s)}}}function S(e){return w(e.data)>=1}function w(e){return e.preinterleaved===!1?B(e.indices).length:e.indexCount}var E,N=m.assert,L=m.objectEmpty,B=m.getFirstObjectValue,V=m.setMatrixTranslation3,G=_.vec2d,F=_.mat4d,U=m.VertexAttrConstants,z=F.identity(),q=1535,k=!1,j=function(){function e(e,t,r,a,i){this._lighting=new s.SceneLighting,this._mat2DataMerged={},this._mat2DataInstanced={},this._mat2DataPreinterleaved={},this._renderOrder=[],this._externalRenderers=new u,this._renderContext=new f,this._isRendering=!1,this._highlights=[],this._pixelRatio=1,this._threshold=q,this._needsRender=!0,this._fallbackDepthStencilTexture=null,this._stats=new Q,this.ssaoEnabled=!1,this.renderOptions={antialiasing:"smaa",earlyOcclusionPixelDraw:!1},this._programRep=e,this._materialRep=t,this._orderedRendering=i,this._rctx=a,this._fxaaPass=new b(a),this._smaaPass=new I(a),this._renderContext.lightingData=this._lighting.getOld(),a.setDepthTestEnabled(!0),a.setFaceCullingEnabled(!0),a.setBlendingEnabled(!1),a.setBlendFunctionSeparate(770,771,1,771),this._bindParameters={view:null,proj:null,viewInvTransp:null,nearFar:null,lightingData:null,viewport:null,framebufferTex:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,instanceParameters:null,depthFBO:null,normalFBO:null,extensions:{angleInstancedArrays:a.extensions.angleInstancedArrays}},this._linearDepthTextureHelper=new o(a),this._normalTextureHelper=new l(a),this._highlightTextureHelper=new d(a),this._stencilRenderingHelper=new p(a),this._initializeFramebufferTexture()}return e.prototype._initializeFramebufferTexture=function(){var e=this._rctx.gl,t=this._rctx.contextAttributes,r=t.alpha?e.RGBA:e.RGB,a=new v(this._rctx,{target:3553,pixelFormat:r,dataType:5121,samplingMode:9728,wrapMode:33071,width:4,height:4});this._framebuffer={format:r,texture:a}},e.prototype.dispose=function(){var e=this,t=function(t){e._releaseMaterials(t)},r=function(e,t){if(t.type===E.Preinterleaved)for(var r in t.instances)t.instances[r].vao.dispose(!0);else t.vao.dispose(!0)};M(this._mat2DataMerged,t,r),M(this._mat2DataInstanced,t,r),M(this._mat2DataPreinterleaved,t,r),this._mat2DataMerged=null,this._mat2DataInstanced=null,this._mat2DataPreinterleaved=null,this._framebuffer.texture.dispose(),this._framebuffer.texture=null,this._linearDepthTextureHelper.getEnableState()&&this._linearDepthTextureHelper.disable(),this._normalTextureHelper.getEnableState()&&this._normalTextureHelper.disable(),this._highlightTextureHelper.getEnableState()&&this._highlightTextureHelper.setEnableState(!1),this._stencilRenderingHelper.getEnableState()&&this._stencilRenderingHelper.setEnableState(!1),this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null)},e.prototype.setLighting=function(e){this._lighting.set(e)},e.prototype.setPixelRatio=function(e){this._pixelRatio=e,this._needsRender=!0},e.prototype.getPixelRatio=function(){return this._pixelRatio},e.prototype.addExternalRenderer=function(e,t){return this._externalRenderers.addRenderer(e,t),!0},e.prototype.removeExternalRenderer=function(e){return this._externalRenderers.removeRenderer(e),!0},e.prototype.getExternalRenderers=function(){return this._externalRenderers},e.prototype.resetNeedsRender=function(){this._needsRender=!1,this._externalRenderers.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._externalRenderers.needsRender()},e.prototype.getCombinedStats=function(){var e=this;this._stats.VBOallocatedSize=0,this._stats.VBOoptimalSize=0,this._stats.VBOusedSize=0;var t=function(){},r=function(t,r){if(r.type===E.Preinterleaved)for(var a in r.instances){var i=r.instances[a].buffer;e._stats.VBOallocatedSize+=i.length,e._stats.VBOusedSize+=i.length,e._stats.VBOoptimalSize+=i.length}else e._stats.VBOallocatedSize+=r.buffer.getArray().length,e._stats.VBOusedSize+=r.buffer.getSize(),e._stats.VBOoptimalSize+=r.optimalCount};return M(this._mat2DataMerged,t,r),M(this._mat2DataInstanced,t,r),M(this._mat2DataPreinterleaved,t,r),this._stats.VBOallocatedSize*=4/1024,this._stats.VBOusedSize*=4/1024,this._stats.VBOoptimalSize*=4/1024,this._stats},e.prototype._addHighlight=function(e){var t=this._getInstance(e);return null===t?void console.error("No instance found for RenderGeometry {name: '"+e.name+"', uniqueName: '"+e.uniqueName+"'}"):(this._highlights.push(t),this._orderedRendering&&this._sortHighlightsByRenderOrder(),this._needsRender=!0,void(this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights)))},e.prototype._removeHighlight=function(e){var t=this._highlights.length;this._highlights=this._highlights.filter(function(t){return t.uniqueName!==e.uniqueName}),t!==this._highlights.length&&(this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights),this._needsRender=!0)},Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._highlights.length>0},enumerable:!0,configurable:!0}),e.prototype._renderHUDVisibility=function(e){var t=this,r=P.shouldRenderVisibilityDuringRenderPass(e.pass),a=e.offscreenRenderingHelper&&e.offscreenRenderingHelper.getEnableState();r&&a&&e.offscreenRenderingHelper.renderHUDVisibility(function(){t._renderInternalSlot(g.OCCLUSION_PIXELS,e)})},e.prototype.renderGeometrySlots=function(e){this._externalRenderers.render(g.INTERNAL_MATERIAL,e),this._renderInternalSlot(g.STENCIL_MATERIAL,e),this._externalRenderers.render(g.OPAQUE_TERRAIN,e),this._renderInternalSlot(g.OPAQUE_MATERIAL,e),this._externalRenderers.render(g.OPAQUE_EXTERNAL,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep),this._renderInternalSlot(g.TRANSPARENT_MATERIAL,e),this.renderOptions.earlyOcclusionPixelDraw&&(this._renderHUDVisibility(e),this._renderInternalSlot(g.LINE_CALLOUTS,this._renderContext)),this._externalRenderers.render(g.TRANSPARENT_EXTERNAL,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep),this._externalRenderers.render(g.TRANSPARENT_TERRAIN,e)},e.prototype._renderHighlights=function(e,t,r){var a=!!r&&r.getEnableState(),i=a&&(this.hasHighlights||this._externalRenderers.needsHighlight());if(this._highlightTextureHelper.setEnableState(i),i){var n=null;r.profilingCallback&&(n=O.startMeasurement(this._renderContext.rctx)),this._highlightTextureHelper.setupFBOs(e),this._highlightTextureHelper.prepareHighlightPass(),this.renderGeometryPass(h.MATERIAL_HIGHLIGHT,e,null,null);var s=this._rctx.gl;this._rctx.clear(s.DEPTH_BUFFER_BIT),this._renderInternalSlot(g.LINE_CALLOUTS_HUD_DEPTH,this._renderContext),this._renderInternalSlot(g.HUDMATERIAL1,this._renderContext),this._renderInternalSlot(g.HUDMATERIAL2,this._renderContext),this._highlightTextureHelper.finish(t);var o=this._highlightTextureHelper.getHighlightFBO();r.render(e,t,o),null!==n&&r.profilingCallback&&n.stop(function(e){r.profilingCallback&&r.profilingCallback(e)})}},e.prototype._needsRenderOccluded=function(e){for(var t in this._mat2DataInstanced){var r=this._mat2DataInstanced[t],a=r[0];if(a&&a.isRenderOccluded()&&a.beginSlot(e)&&a.isVisible())return!0}return!1},e.prototype._renderOccluded=function(e,t,r){if(t&&r&&r.getEnableState()){var a=this._needsRenderOccluded(g.OPAQUE_MATERIAL)||this._needsRenderOccluded(g.TRANSPARENT_MATERIAL);if(a!==t.getEnableState()&&t.setEnableState(a),a){var i=this._renderContext;t.setupFBOs(e),t.prepareColorPass(),i.pass=h.MATERIAL,i.renderOccludedOnly=!0,this._renderInternalSlot(g.OPAQUE_MATERIAL,i),this._renderInternalSlot(g.TRANSPARENT_MATERIAL,i),i.renderOccludedOnly=!1,t.finish(r.getFramebuffer()),t.apply()}}},e.prototype._renderUnordered=function(e,t,r,a){var i=this._rctx;this._isRendering=!0,this._stats.reset(),this._updateGlobalUniforms(e.projectionMatrix),this._renderContext.pass=h.MATERIAL,this._renderContext.camera=e,this._renderContext.shadowMap=t,this._renderContext.ssaoHelper=a.ssao,this._renderContext.offscreenRenderingHelper=a.offscreenRendering,this._renderContext.stencilRenderingHelper=this._stencilRenderingHelper,this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO(),this._renderContext.normals=this._normalTextureHelper.getNormalFBO(),this._renderContext.highlight=this._highlightTextureHelper.getHighlightFBO(),this._renderContext.options=this.renderOptions,this._renderContext.rctx=this._rctx,this._renderContext.lightingData=this._lighting.getOld(),a.offscreenRendering.setEnableState(!0),a.offscreenRendering.initializeFrame(e),this._externalRenderers.render(g.BACKGROUND,this._renderContext),this.renderGeometrySlots(this._renderContext),this._externalRenderers.render(g.POSTPROCESSING_ATMOSPHERE,this._renderContext),this._externalRenderers.render(g.POSTPROCESSING_EXTERNAL,this._renderContext),this.renderOptions.earlyOcclusionPixelDraw||(this._renderHUDVisibility(this._renderContext),this._renderInternalSlot(g.LINE_CALLOUTS,this._renderContext)),this._renderOccluded(e,a.renderOccluded,a.offscreenRendering);var n=this.renderOptions.antialiasing;if("smaa"===n&&this._smaaPass.ensureEnabled())this._fxaaPass.disable(),this._smaaPass.render({colorTexture:a.offscreenRendering.getColorTexture()},null);else if("fxaa"===n&&this._fxaaPass.enable())this._smaaPass.disable(),this._fxaaPass.render({colorTexture:a.offscreenRendering.getColorTexture()},null);else{var s=e.viewport,o=F.ortho(s[0],s[2],s[1],s[3],-1,1);a.offscreenRendering.drawQuad(o),this._fxaaPass.disable(),this._smaaPass.disable()}if(i.bindFramebuffer(null),this._renderContext.framebufferTex=a.offscreenRendering.getColorTexture(),this._renderInternalSlot(g.LINE_CALLOUTS_HUD_DEPTH,this._renderContext),this._renderInternalSlot(g.HUDMATERIAL1,this._renderContext),this._renderInternalSlot(g.HUDMATERIAL2,this._renderContext),this._renderHighlights(e,r,a.highlight),k){var l=this._stats,d=l.drawCallsInstanced+l.drawCallsMerged+l.drawCallsPreinterleaved;window.FPSCounterDebugString="dc: "+d+" instanced: "+l.drawCallsInstanced+" merged: "+l.drawCallsMerged+" preinterleaved: "+l.drawCallsPreinterleaved}this._isRendering=!1},e.prototype._renderGeometryPassOrderedHighlight=function(e){this._renderInternalHighlights(this._highlights)},e.prototype._renderGeometryPassOrderedMaterial=function(e){for(var t=null,r=0;r<this._renderOrder.length;r++){var a=this._renderOrder[r][1];if(a.instanced){var i=a.instanced||a.merged,n=i[e.pass];n&&n.isVisible()&&(this._renderInternalInstanced(i,n,this._bindParameters,1/0),t=null)}if(a.merged){var i=a.merged,n=i[e.pass];if(n&&n.isVisible()){var s=n.getProgram();s!==t&&(s.setUniformMatrix4fv("model",z),s.hasUniform("modelNormal")&&s.setUniformMatrix4fv("modelNormal",z)),t=s,this._renderInternalMerged(i,n,this._bindParameters,1/0)}}}},e.prototype._renderGeometryPassOrdered=function(e){var t=e.camera;this._bindParameters.view=t.viewMatrix,this._bindParameters.proj=t.projectionMatrix,this._bindParameters.viewInvTransp=t.viewInverseTransposeMatrix,W[0]=t.near,W[1]=t.far,this._bindParameters.nearFar=W,this._bindParameters.lightingData=this._lighting.getOld(),this._bindParameters.viewport=t.fullViewport,this._bindParameters.framebufferTex=this._framebuffer.texture,this._bindParameters.pixelRatio=this._pixelRatio,this._bindParameters.instanceParameters=void 0,this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO(),this._bindParameters.normalFBO=this._normalTextureHelper.getNormalFBO(),e.isHighlightPass?this._renderGeometryPassOrderedHighlight(e):this._renderGeometryPassOrderedMaterial(e)},e.prototype._renderOrdered=function(e,t){this._stats.reset(),this.renderGeometryPass(e,t)},e.prototype.render=function(e,t,r){this._orderedRendering?this._renderOrdered(h.MATERIAL,e):this._renderUnordered(e,r.shadowMap,t,r)},e.prototype.renderAuxiliaryBuffers=function(e,t,r){var a=r.ssao,i=r.shadowMap,n=this.ssaoEnabled||this._externalRenderers.needsLinearDepth();this._linearDepthTextureHelper.setEnableState(n),n&&(this._linearDepthTextureHelper.setupFBOs(e),this._linearDepthTextureHelper.prepareDepthPass(),this.renderGeometryPass(h.MATERIAL_DEPTH,e,i,a),this._linearDepthTextureHelper.finish(t)),this._normalTextureHelper.setEnableState(this.ssaoEnabled),this.ssaoEnabled&&(this._normalTextureHelper.setupFBOs(e),this._normalTextureHelper.prepareNormalPass(),this.renderGeometryPass(h.MATERIAL_NORMAL,e,i,a),this._normalTextureHelper.finish(t)),this.ssaoEnabled&&a.computeSSAO(e,t,this._linearDepthTextureHelper.getDepthFBO(),this._normalTextureHelper.getNormalFBO()),a.bindAll(this._programRep)},e.prototype.renderGeometryPass=function(e,t,r,a){this._isRendering=!0,this._updateGlobalUniforms(t.projectionMatrix),this._renderContext.pass=e,this._renderContext.camera=t,this._renderContext.shadowMap=r,this._renderContext.ssaoHelper=a,this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO(),this._renderContext.normals=this._normalTextureHelper.getNormalFBO(),this._renderContext.rctx=this._rctx,this._orderedRendering?this._renderGeometryPassOrdered(this._renderContext):this._renderGeometryPassUnordered(this._renderContext),this._isRendering=!1},e.prototype._renderGeometryPassUnordered=function(e){this.renderGeometrySlots(e)},e.prototype._renderInternalHighlights=function(e,t){void 0===t&&(t=null);for(var r=0;r<e.length;++r){var a=e[r],i=a.matData[h.MATERIAL_HIGHLIGHT];i&&(null===t||i.beginSlot(t))&&i.isVisible()&&this._renderInternalHighlight(a,this._bindParameters,h.MATERIAL_HIGHLIGHT)}},e.prototype._renderInternalSlotOccluded=function(e,t){for(var r in this._mat2DataInstanced){var a=this._mat2DataInstanced[r],i=a[t.pass];i&&i.isRenderOccluded()&&i.beginSlot(e)&&i.isVisible()&&this._renderInternalInstanced(a,i,this._bindParameters,e)}},e.prototype._renderInternalSlotMaterial=function(e,t){for(var r in this._mat2DataInstanced){var a=this._mat2DataInstanced[r],i=a[t.pass];i&&i.beginSlot(e)&&i.isVisible()&&this._renderInternalInstanced(a,i,this._bindParameters,e)}for(var n=this._programRep.getProgramsUsingUniform("model"),s=this._programRep.getProgramsUsingUniform("modelNormal"),o=0;o<n.length;o++){var l=n[o];l.setUniformMatrix4fv("model",z),s.indexOf(l)>-1&&l.setUniformMatrix4fv("modelNormal",z)}for(var r in this._mat2DataMerged){var a=this._mat2DataMerged[r],i=a[t.pass];i&&i.beginSlot(e)&&i.isVisible()&&this._renderInternalMerged(a,i,this._bindParameters,e)}for(var r in this._mat2DataPreinterleaved){var a=this._mat2DataPreinterleaved[r],i=a[t.pass];i&&i.beginSlot(e)&&i.isVisible()&&this._renderInternalPreinterleaved(a,i,this._bindParameters,e)}e===g.STENCIL_MATERIAL&&this._stencilRenderingHelper.finish()},e.prototype._renderInternalSlotHighlights=function(e,t){this._renderInternalHighlights(this._highlights,e)},e.prototype._renderInternalSlot=function(e,t){this._bindParameters.view=t.camera.viewMatrix,this._bindParameters.proj=t.camera.projectionMatrix,this._bindParameters.viewInvTransp=t.camera.viewInverseTransposeMatrix,this._bindParameters.cameraAboveGround=t.camera.aboveGround,this._bindParameters.fovY=t.camera.fovY,this._bindParameters.poiDistance=t.camera.distance,W[0]=t.camera.near,W[1]=t.camera.far;var r=this._renderContext.offscreenRenderingHelper;this._bindParameters.nearFar=W,this._bindParameters.lightingData=this._lighting.getOld(),this._bindParameters.viewport=t.camera.fullViewport,this._bindParameters.framebufferTex=r?r.getColorTexture():null,this._bindParameters.shadowMap=t.shadowMap,this._bindParameters.shadowMappingEnabled=!!t.shadowMap&&t.shadowMap.getEnableState(),this._bindParameters.ssaoEnabled=!!t.ssaoHelper&&t.ssaoHelper.getEnableState(),this._bindParameters.pixelRatio=this._pixelRatio,this._bindParameters.instanceParameters=void 0,this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO(),this._bindParameters.hudVisibilityTexture=r?r.getHUDVisibilityTexture():null,t.isHighlightPass?this._renderInternalSlotHighlights(e,t):t.renderOccludedOnly?this._renderInternalSlotOccluded(e,t):this._renderInternalSlotMaterial(e,t)},e.prototype._renderInternalInstanced=function(e,t,r,a){var i=this._rctx,n=i.gl,s=!1,o=t.getDrawMode(i),l=this._bindParameters.extensions.angleInstancedArrays;for(var d in e.origin2data){var h=e.origin2data[d];r.origin=h.origin,a===g.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());var f=!1;if(t.instanced)for(var u in h.perGeometryDataInfo){var p=h.perGeometryDataInfo[u];s||(t.bind(i,r),s=!0),i.bindVAO(p.vao);var m=t.getProgram();R.assertCompatibleVertexAttributeLocations(p.vao,m),f||(t.bindView(i,r),f=!0);var _=p.to-p.from,c=p.refCount;o===n.TRIANGLES&&(this._stats.trianglesRendered+=c*_/3),l.drawArraysInstancedANGLE(o,p.from,_,c),this._stats.drawCallsAngleInstanced++,this._stats.instancesDrawnAngle+=c}else{var v=h.instances;for(var y in v){var x=v[y],b=x.displayedIndexRange;b&&0===b.length||(s||(t.bind(i,r),s=!0),f||(i.bindVAO(h.vao),t.bindView(i,r),f=!0),t.bindInstance(i,x),this._stats.drawCallsInstanced++,o===n.TRIANGLES&&(this._stats.trianglesRendered+=(x.to-x.from)/3),b?this._drawArraysFaceRange(b,x.from,o):i.drawArrays(o,x.from,x.to-x.from))}}}i.bindVAO(null),s&&t.release(i,r)},e.prototype._renderInternalHighlight=function(e,t,r){var a=this._rctx,i=a.gl,n=e.matData[r],s=n.getDrawMode(a),o=e.instance,l=o.highlightedIndexRange,d=this._renderContext.offscreenRenderingHelper,h=(d?d.getDepthTexture():null)||this._getFallbackDepthTexture(),g=n.getProgram(),f=this._bindParameters.extensions.angleInstancedArrays;if(t.origin=e.originData.origin,n.instanced&&e.type===E.Instanced){var u=e.instancedVAO;n.bind(a,t),a.bindVAO(u),R.assertCompatibleVertexAttributeLocations(u,g),n.bindView(a,t);for(var p=0;p<l.length;p++){var m=l[p],_=m.range?m.range[0]+o.from:o.from,c=m.range?m.range[1]-m.range[0]+1:o.to-o.from;a.bindTexture(h,5),g.setUniform1i("depthTex",5),g.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),f.drawArraysInstancedANGLE(s,_,c,1),s===i.TRIANGLES&&(this._stats.trianglesRendered+=1*c/3),this._stats.drawCallsHighlight++}}else if(e.type===E.Instanced&&n.instanced)console.error("_renderInternalHighlight: incompatible instance type");else{switch(n.bind(a,t),n.bindView(a,t),e.type){case E.Merged:var v=e.originData;a.bindVAO(v.vao),g.setUniformMatrix4fv("model",z);break;case E.Instanced:var v=e.originData;a.bindVAO(v.vao),n.bindInstance(a,o);break;case E.Preinterleaved:var v=e.originData,u=v.instances[e.uniqueName].vao;a.bindVAO(u),n.bindInstance(a,o)}for(var p=0;p<l.length;p++){var m=l[p],_=m.range?m.range[0]+o.from:o.from,c=m.range?m.range[1]-m.range[0]+1:o.to-o.from;a.bindTexture(h,5),n.getProgram().setUniform1i("depthTex",5),g.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),a.drawArrays(s,_,c),s===i.TRIANGLES&&(this._stats.trianglesRendered+=c/3),this._stats.drawCallsHighlight++}}a.bindVAO(null),n.release(a,t)},e.prototype._drawArraysFaceRange=function(e,t,r){for(var a=this._rctx,i=0;i<e.length;i++){var n=e[i];a.drawArrays(r,n[0]+t,n[1]-n[0]+1)}this._stats.drawCallsFragmented+=e.length-1},e.prototype._renderInternalMerged=function(e,t,r,a){var i=this._rctx,n=i.gl,s=!1;for(var o in e.origin2data){var l=e.origin2data[o];if(r.origin=l.origin,a===g.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass()),!l.displayedIndexRange||0!==l.displayedIndexRange.length){s||(t.bind(i,r),s=!0);var d=t.getProgram();i.bindVAO(l.vao),R.assertCompatibleVertexAttributeLocations(l.vao,d),t.bindView(i,r),this._stats.drawCallsMerged++;var h=t.getDrawMode(i);h===n.TRIANGLES&&(this._stats.trianglesRendered+=l.vao.vertexBuffers.geometry.size/3),l.displayedIndexRange?this._drawArraysFaceRange(l.displayedIndexRange,0,h):i.drawArrays(h,0,R.vertexCount(l.vao,"geometry"))}}s&&t.release(i,r)},e.prototype._renderInternalPreinterleaved=function(e,t,r,a){var i=this._rctx,n=i.gl,s=!1,o=t.getDrawMode(i);for(var l in e.origin2data){var d=e.origin2data[l];r.origin=d.origin;var h=!1;a===g.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());for(var f in d.instances){var u=d.instances[f],p=u.instance,m=u.vao,_=p.displayedIndexRange;if(!_||0!==_.length){s||(t.bind(i,r),s=!0);var c=t.getProgram();R.assertCompatibleVertexAttributeLocations(m,c),i.bindVAO(m),h||(t.bindView(i,r),h=!0),t.bindInstance(i,p),this._stats.drawCallsPreinterleaved++,o===n.TRIANGLES&&(this._stats.trianglesRendered+=(p.to-p.from)/3),_?this._drawArraysFaceRange(_,p.from,o):i.drawArrays(o,p.from,p.to-p.from)}}}i.bindVAO(null),s&&t.release(i,r)},e.prototype._updateGlobalUniforms=function(e){for(var t=this._programRep.getProgramsUsingUniform("proj"),r=0;r<t.length;r++)t[r].setUniformMatrix4fv("proj",e);if(this._lighting){t=this._programRep.getProgramsUsingUniform("lightingMainDirection");for(var r=0;r<t.length;r++)this._lighting.setUniforms(t[r]);t=this._programRep.getProgramsUsingUniform("lightDirection");for(var r=0;r<t.length;r++)this._lighting.setUniforms(t[r])}},e.prototype.print=function(){var e=Object.keys(this._mat2DataMerged).length,t=Object.keys(this._mat2DataInstanced).length,r=Object.keys(this._mat2DataPreinterleaved).length;console.log("number of materials (merged/instanced/preinterleaved): "+e+"/"+t+"/"+r);var a=0;M(this._mat2DataMerged,function(){},function(e,t){a+=Object.keys(t.instances).length});var i=0;M(this._mat2DataInstanced,function(){},function(e,t){i+=Object.keys(t.instances).length});var n=0;M(this._mat2DataPreinterleaved,function(){},function(e,t){n+=Object.keys(t.instances).length}),console.log("number of instances (merged/instanced/preinterleaved): "+a+"/"+i+"/"+n)},e.prototype.isEmpty=function(){for(var e in this._mat2DataInstanced){var t=this._mat2DataInstanced[e];for(var r in t.origin2data)if(!L(t.origin2data[r].instances))return!1}for(var e in this._mat2DataMerged){var t=this._mat2DataMerged[e];for(var r in t.origin2data)if(!L(t.origin2data[r].instances))return!1}for(var e in this._mat2DataPreinterleaved){var t=this._mat2DataPreinterleaved[e];for(var r in t.origin2data)if(!L(t.origin2data[r].instances))return!1}return!0},e.prototype.modify=function(e,t,r,a){this._isRendering&&console.warn("Renderer.modify called while rendering");var i=[],n=[],s=[];this._classifyRenderGeometry(e,i,n,s);var o=[],l=[],d=[];this._classifyRenderGeometry(t,o,l,d);var h={};r&&this._performUpdates(r,h);var g=[];this._modifyMerged(i,o,g,h),this._modifyInstanced(n,l,g),this._modifyPreinterleaved(s,d,g),this._updateMergedFaceranges(h),this._releaseMaterials(g);var f=this._highlights.length;t&&t.length>0&&f>0&&(this._highlights=this._highlights.filter(function(e){return!t.some(function(t){return t.uniqueName===e.uniqueName})}),f!==this._highlights.length&&this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights)),this._updateHighlightVAOs(),this._modifyMaterials(a),this._needsRender=!0},e.prototype._classifyRenderGeometry=function(e,t,r,a){for(var i=0,n=e;i<n.length;i++){var s=n[i];if(S(s))switch(this._getType(s)){case E.Merged:t.push(s);break;case E.Instanced:r.push(s);break;case E.Preinterleaved:a.push(s)}}},e.prototype._performUpdates=function(e,t){for(var r=0,a=e;r<a.length;r++){var i=a[r],n=i.updateType,s=i.renderGeometry,o=this._getType(s)===E.Merged;if(S(s)){if(2&n&&this._updateFaceranges(s,t),32&n){var l=this._getInstance(s);l&&this._updateHighlightFaceranges(s,l.instance)}4&n||o&&16&n?this._updateVertexAttributes(s,!o):!o&&16&n?this._updateInstanceTransformation(s):8&n&&this._updateColorAttributes(s)}}},e.prototype._updateFaceranges=function(e,t){var r,a=e.material,i=a.getId(),n=e.origin.id,s=this._getType(e);if(s===E.Preinterleaved){var o=this._getOriginData(s,i,n);r=o.instances[e.uniqueName].instance}else{var o=this._getOriginData(s,i,n);r=o.instances[e.uniqueName],r&&s===E.Merged&&(t[this._modifiedMergedFacerangesKey(i,n)]=o)}r&&(r.displayedIndexRange=T(e),this._updateHighlightFaceranges(e,r))},e.prototype._updateHighlightFaceranges=function(e,t){if(t){var r=t.highlightedIndexRange,a=C(e);t.highlightedIndexRange=a,a&&!r?this._addHighlight(e):!a&&r&&this._removeHighlight(e)}},e.prototype._updateMergedFaceranges=function(e){for(var t in e){var a=e[t];a.displayedIndexRange=[];var i=a.instances,n=!0;for(var s in i){var o=i[s];o.displayedIndexRange?(a.displayedIndexRange.push.apply(a.displayedIndexRange,r.offsetIntervals(o.displayedIndexRange,o.from)),n=!1):a.displayedIndexRange.push([o.from,o.to-1])}n?a.displayedIndexRange=null:a.displayedIndexRange=r.mergeIntervals(a.displayedIndexRange)}},e.prototype._updateVertexAttributes=function(e,t){var r,a,i,n=e.material,s=n.getId(),o=e.origin.id,l=R.getStride(n.getVertexBufferLayout())/4,d=this._getType(e);if(d===E.Preinterleaved){var h=this._getOriginData(d,s,o),g=h.instances[e.uniqueName];r=g.instance,a=g.buffer,i=g.vao}else{var h=this._getOriginData(d,s,o);r=h.instances[e.uniqueName],a=h.buffer.getArray(),i=h.vao;var f=void 0,u=void 0;t||(H(e,Y,J),f=Y,u=J),n.fillInterleaved(e.data,f,u,e.instanceParameters,a,r.from*l)}N(r.from+n.getOutputAmount(w(e.data))/l===r.to,"material VBO layout has changed"),i.vertexBuffers.geometry.setSubData(a,r.from*l*4,r.from*l*4,r.to*l*4)},e.prototype._updateInstanceTransformation=function(e){var t=this._getType(e),r=e.material.getId(),a=e.origin.id;if(t===E.Preinterleaved){var i=this._getOriginData(t,r,a),n=i.instances[e.uniqueName].instance;H(e,n.transformation,n.transformationNormal)}else{var i=this._getOriginData(t,r,a),n=i.instances[e.uniqueName],s=i.perGeometryDataInfo[e.data.id],o=s.instanceBufferData;if(H(e,n.transformation,n.transformationNormal),o){var l=o.getSlot(e.idx);o.fill(l,0,n.transformation),o.fill(l,16,n.transformationNormal);var d=o.getOffset(l),h=4*d,g=R.getStride(s.vao.layout.instance);s.vao.vertexBuffers.instance.setSubData(o.getArray(),h,h,h+g)}}},e.prototype._updateColorAttributes=function(e){var t,r,a,i=e.material,n=i.getId(),s=e.origin.id,o=R.getStride(i.getVertexBufferLayout())/4,l=this._getType(e);if(l===E.Preinterleaved){var d=this._getOriginData(l,n,s),h=d.instances[e.uniqueName];t=h.instance,r=h.buffer,a=h.vao}else{var d=this._getOriginData(l,n,s);t=d.instances[e.uniqueName],r=d.buffer.getArray(),a=d.vao;var g=(f={},f[U.COLOR]=!0,f[U.SYMBOLCOLOR]=!0,f);i.fillInterleaved(e.data,void 0,void 0,e.instanceParameters,r,t.from*o,g)}N(t.from+i.getOutputAmount(w(e.data))/o===t.to,"material VBO layout has changed"),a.vertexBuffers.geometry.setSubData(r,t.from*o*4,t.from*o*4,t.to*o*4);var f},e.prototype._modifyMerged=function(e,t,r,a){var n=this._rctx,s=E.Merged,o=this._compMat2delta(e,t,s),l=this._mat2DataMerged;for(var d in o){var h=o[d];for(var g in h){var f=h[g],u=f.optimalCount,p=f.material,m=p.getVertexBufferLayout(),_=R.getStride(m)/4,c=l[d];if(null==c){N(u>0);var v=p.getRenderPriority();c=this._initializeMatData(p),l[d]=c,this._orderedRendering&&this._insertIntoRenderOrder(c,v,"merged")}var b=c.origin2data[g];if(null==b&&(N(u>0),b={type:s,instances:{},vao:new y(n,A.Default3D,{geometry:m},{geometry:x.createVertex(n,35044)}),buffer:new i(u),optimalCount:0,origin:f.origin},c.origin2data[g]=b),u>0){var I=b.buffer.getSize(),D=b.buffer.getArray(),O=u<f.sparseCount/2,P=b.buffer.resize(O?u:f.sparseCount),C=f.toRemove;if(O||P){I=0;for(var H=b.buffer.getArray(),M=0;M<C.length;++M){var S=b.instances[C[M].uniqueName];b.optimalCount-=(S.to-S.from)*_,delete b.instances[C[M].uniqueName]}var L={};for(var B in b.instances){var S=b.instances[B];N(null==L[S.from]),L[S.from]=S}for(var G in L){var S=L[G],U=S.from*_,z=S.to*_;H.set(D.subarray(U,z),I),S.from=I/_,I+=z-U,S.to=I/_}N(I===b.optimalCount)}else for(var M=0;M<C.length;++M){var q=C[M].uniqueName;N(void 0!==b.instances[q]);var U=b.instances[q].from*_,z=b.instances[q].to*_;b.buffer.erase(U,z),delete b.instances[q],b.optimalCount-=z-U}V(X,-f.origin[0],-f.origin[1],-f.origin[2]);for(var k=f.toAdd,j=!1,M=0;M<k.length;++M){var Q=k[M],W=Q.data;F.multiply(X,Q.transformation,Y),F.inverse(Y,J),F.transpose(J);var Z=I;p.fillInterleaved(W,Y,J,Q.instanceParameters,b.buffer.getArray(),I);var $=p.getOutputAmount(w(W)),ee=Z+$;N(null==b.instances[Q.uniqueName]);var te=T(Q),S=new K(Q.name,Z/_,ee/_,te,void 0,void 0,Q.idx);b.instances[Q.uniqueName]=S,this._updateHighlightFaceranges(Q,S),te&&(j=!0),b.optimalCount+=$,I+=$}N(b.optimalCount===u);var re=new Float32Array(b.buffer.getArray().buffer,0,b.buffer.getSize());b.vao.vertexBuffers.geometry.setData(re),(j||b.displayedIndexRange)&&(a[this._modifiedMergedFacerangesKey(d,g)]=b)}else N(0===u),b.vao.dispose(!0),b.vao=null,delete c.origin2data[g],0===Object.keys(c.origin2data).length&&(r.push(d),delete l[d],this._orderedRendering&&this._removeFromRenderOrder(c,"merged"))}}},e.prototype._modifyInstanced=function(e,t,r){var a=this._rctx,s=E.Instanced,o=this._compMat2delta(e,t,s),l=this._mat2DataInstanced;for(var d in o){var g=o[d];for(var f in g){var u=g[f];if(0!==u.optimalCount){var p=u.material,m=l[d];if(null==m){var _=p.getRenderPriority();m=this._initializeMatData(p),l[d]=m,this._orderedRendering&&this._insertIntoRenderOrder(m,_,"instanced")}var c=p.getVertexBufferLayout(),v=m[h.MATERIAL].instanced?p.getInstanceBufferLayout():void 0,b=v&&R.findAttribute(v,"instanceColor"),I=v&&R.findAttribute(v,"instanceFeatureAttribute"),D=R.getStride(c)/4,O=m.origin2data[f];null==O&&(O={type:s,instances:{},vao:new y(a,A.Default3D,{geometry:c},{geometry:x.createVertex(a,35044)}),buffer:new i(u.optimalCount),optimalCount:0,perGeometryDataInfo:{},origin:u.origin},m.origin2data[f]=O);var P=O.buffer.getSize(),C=O.buffer.getArray(),H=u.optimalCount<u.sparseCount/2,M=O.buffer.resize(H?u.optimalCount:u.sparseCount);for(var S in u.perGeometryDelta){var L=O.perGeometryDataInfo[S];if(L&&L.instanceBufferData){var B=u.perGeometryDelta[S].removeCount;B>0&&L.instanceBufferData.prepareFree(B)}}var G=u.toRemove;if(H||M){for(var U=0;U<G.length;++U){var z=G[U];delete O.instances[z.uniqueName];var S=z.data.id,L=O.perGeometryDataInfo[S],q=L;0===--q.refCount&&null==u.dataId2refCount[S]?(O.optimalCount-=(q.to-q.from)*D,delete O.perGeometryDataInfo[S]):L.instanceBufferData&&L.instanceBufferData.free(z.idx)}P=0;var k=O.buffer.getArray(),j={};for(var Q in O.perGeometryDataInfo){var q=O.perGeometryDataInfo[Q];N(null==j[q.from]),j[q.from]=q}for(var W in j){var q=j[W],Y=q.from*D,J=q.to*D;k.set(C.subarray(Y,J),P),q.from=P/D,P+=J-Y,q.to=P/D}for(var Z in O.instances){var $=O.instances[Z];$.from=O.perGeometryDataInfo[$.dataId].from,$.to=O.perGeometryDataInfo[$.dataId].to}}else for(var U=0;U<G.length;++U){var z=G[U];delete O.instances[z.uniqueName];var S=z.data.id,L=O.perGeometryDataInfo[S];if(0===--L.refCount&&null==u.dataId2refCount[S]){var Y=L.from*D,J=L.to*D;O.buffer.erase(Y,J),O.optimalCount-=J-Y,delete O.perGeometryDataInfo[S]}else L.instanceBufferData&&L.instanceBufferData.free(z.idx)}V(X,-u.origin[0],-u.origin[1],-u.origin[2]);
for(var S in u.perGeometryDelta){var L=O.perGeometryDataInfo[S];if(L&&L.instanceBufferData){var ee=u.perGeometryDelta[S].addCount;ee>0&&L.instanceBufferData.prepareAllocate(ee)}}for(var te=u.toAdd,U=0;U<te.length;++U){var z=te[U],re=z.data,S=re.id,L=O.perGeometryDataInfo[S];if(null==L){p.fillInterleaved(re,void 0,void 0,void 0,O.buffer.getArray(),P);var ae=p.getOutputAmount(w(re)),Y=P/D;P+=ae;var J=P/D;if(O.optimalCount+=ae,L={refCount:1,from:Y,to:J,vao:null,instanceBufferData:null},v){var ie=R.getStride(v)/4;L.vao=new y(a,A.Default3D,{geometry:c,instance:v},{geometry:O.vao.vertexBuffers.geometry,instance:x.createVertex(a,35044)}),L.instanceBufferData=new n(ie,u.perGeometryDelta[S].addCount)}O.perGeometryDataInfo[S]=L}else++L.refCount;N(L.from*D<=O.buffer.getSize()&&L.to*D<=O.buffer.getSize());var ne=F.create();F.multiply(X,z.transformation,ne);var se=T(z),$=new K(z.name,L.from,L.to,se,ne,z.instanceParameters,z.idx,S);O.instances[z.uniqueName]=$,this._updateHighlightFaceranges(z,$);var oe=L.instanceBufferData;if(oe){var le=oe.allocate(z.idx);oe.fill(le,0,$.transformation),oe.fill(le,16,$.transformationNormal),b&&oe.fill(le,b.offset/4,z.instanceParameters.color),I&&oe.fill(le,I.offset/4,z.instanceParameters.featureAttribute)}}N(O.optimalCount===u.optimalCount);var de=new Float32Array(O.buffer.getArray().buffer,0,O.buffer.getSize());O.vao.vertexBuffers.geometry.setData(de);for(var S in O.perGeometryDataInfo){var he=O.perGeometryDataInfo[S];if(he.vao){var ge=he.vao.vertexBuffers.instance;if(ge){var fe=u.perGeometryDelta[S];if(fe.addCount+fe.removeCount>0){var ue=he.instanceBufferData.compact();ge.setData(ue)}}}}}else{var pe=l[d];pe.origin2data[f].vao.dispose(!0),delete pe.origin2data[f],0===Object.keys(pe.origin2data).length&&(r.push(d),delete l[d],this._orderedRendering&&this._removeFromRenderOrder(pe,"instanced"))}}}},e.prototype._modifyPreinterleaved=function(e,t,r){for(var a=this._rctx,i=E.Preinterleaved,n=this._mat2DataPreinterleaved,s=0,o=e;s<o.length;s++){var l=o[s],d=l.material,h=d.getId(),g=l.origin.id,f=l.origin.vec3,u=n[h];null==u&&(u=this._initializeMatData(d),n[h]=u);var p=u.origin2data[g];null==p&&(p={type:i,origin:f,count:0,instances:{}},u.origin2data[g]=p),V(X,-f[0],-f[1],-f[2]);var m=F.create();F.multiply(X,l.transformation,m);var _=T(l),c=l.data;if(c.preinterleaved){var v=0,R=c.indexCount,b=c.id,I=new K(l.name,v,R,_,m,l.instanceParameters,l.idx,b),D=d.getVertexBufferLayout(),O=new y(a,A.Default3D,{geometry:D},{geometry:x.createVertex(a,35044)});O.vertexBuffers.geometry.setData(c.vertexData),p.count+=1,p.instances[l.uniqueName]={instance:I,vao:O,buffer:c.vertexData},this._updateHighlightFaceranges(l,I)}else N(!1,"Non-interleaved render geometry processed as pre-interleaved")}for(var P=0,C=t;P<C.length;P++){var l=C[P],f=l.origin,d=l.material,h=d.getId(),g=f.id,H=l.uniqueName,u=n[h],M=u.origin2data[g];M.instances[H].vao.dispose(),delete M.instances[H],M.count-=1,0===M.count&&delete u.origin2data[g],0===Object.keys(u.origin2data).length&&(r.push(h),delete n[h])}},e.prototype._compMat2delta=function(e,t,r){var a={};return this._updateMat2delta(e,!0,r,a),this._updateMat2delta(t,!1,r,a),a},e.prototype._updateMat2delta=function(e,t,r,a){for(var i=r===E.Instanced,n=0,s=e;n<s.length;n++){var o=s[n],l=o.origin,d=o.material,h=d.getId(),g=i?this._mat2DataInstanced[h]:this._mat2DataMerged[h],f=g&&g.origin2data[l.id],u=a[h];null==u&&(u={},a[h]=u);var p=u[l.id];if(null==p){if(p={optimalCount:null==f?0:f.optimalCount,sparseCount:null==f?0:f.buffer.getSize(),material:d,toAdd:[],toRemove:[],perGeometryDelta:null,origin:l.vec3},i){var m={};if(void 0!==f)for(var _ in f.perGeometryDataInfo)m[_]=f.perGeometryDataInfo[_].refCount;p.dataId2refCount=m,p.perGeometryDelta={}}u[l.id]=p}var c=d.getOutputAmount(w(o.data));if(i){var v=o.data.id,y=p.perGeometryDelta[v];y||(y={addCount:0,removeCount:0},p.perGeometryDelta[v]=y),t?(y.addCount++,null==p.dataId2refCount[v]&&(p.dataId2refCount[v]=0),1===++p.dataId2refCount[v]&&(p.optimalCount+=c,p.sparseCount+=c),p.toAdd.push(o)):(y.removeCount++,0===--p.dataId2refCount[v]&&(delete p.dataId2refCount[v],p.optimalCount-=c),p.toRemove.push(o))}else t?(p.optimalCount+=c,p.sparseCount+=c,p.toAdd.push(o)):(p.optimalCount-=c,p.toRemove.push(o))}},e.prototype._getType=function(e){if(e.data.preinterleaved)return E.Preinterleaved;var t=!1,r=w(e.data);return t=t||e.material.canBeMerged===!1,t=t||e.material.instanced,t=t||e.material.isBackdrop,t=t||e.material.isRenderOccluded()===!0,e.singleUse||(t=t||r>this._threshold),t?E.Instanced:E.Merged},e.prototype._getTargetMat2Data=function(e){switch(e){case E.Merged:return this._mat2DataMerged;case E.Instanced:return this._mat2DataInstanced;case E.Preinterleaved:return this._mat2DataPreinterleaved}},e.prototype._getOriginData=function(e,t,r){var a=this._getTargetMat2Data(e);return a[t].origin2data[r]},e.prototype._modifiedMergedFacerangesKey=function(e,t){return e+"_"+t},e.prototype._insertIntoRenderOrder=function(e,t,r){for(var a=e[h.MATERIAL].getMaterialId(),i=this._renderOrder.length,n=0;i>n&&this._renderOrder[n][0]>=t;){var s=this._renderOrder[n][1];if(s.id===a)return N(!s[r],"matData for type already exists"),void(s[r]=e);n++}var o={id:a,instanced:null,merged:null};o[r]=e,this._renderOrder.splice(n,0,[t,o])},e.prototype._removeFromRenderOrder=function(e,t){for(var r=e[h.MATERIAL].getMaterialId(),a=0;this._renderOrder[a][1].id!==r;)a++;var i=this._renderOrder[a][1];i[t]=null,i.instanced||i.merged||this._renderOrder.splice(a,1)},e.prototype._sortHighlightsByRenderOrder=function(){this._highlights.sort(function(e,t){var r=e.matData[h.MATERIAL].getRenderPriority(),a=t.matData[h.MATERIAL].getRenderPriority();return r>a?-1:a>r?1:0})},e.prototype._updateRenderOrder=function(e,t){for(var r=t.length,a=0;r>a&&t[a][1].id!==e;)a++;if(r>a){var i=t[a][1],n=i.merged||i.instanced,s=n[h.MATERIAL].getRenderPriority(),o=t[a][0];if(s!==t[a][0]){t[a][0]=s;var l=s>o?-1:1;for(a+=l;a>-1&&r>a&&l*t[a][0]>l*s;){var d=t[a];t[a]=t[a-l],t[a-l]=d,a+=l}}}},e.prototype._modifyMaterials=function(e){for(var t in e)this._materialRep.updateMaterialParameters(t)},e.prototype.modifyRenderOrder=function(e){if(this._orderedRendering){for(var t in e)this._updateRenderOrder(t,this._renderOrder);this._sortHighlightsByRenderOrder(),this._needsRender=!0}},e.prototype._initializeMatData=function(e){var t={origin2data:{}};return t[h.MATERIAL]=this._materialRep.aquire(e),t[h.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(e),t[h.MATERIAL_NORMAL]=this._materialRep.aquireNormal(e),t[h.MATERIAL_DEPTH]=this._materialRep.aquireDepth(e),t[h.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(e),t},e.prototype._releaseMaterials=function(e){if(Array.isArray(e))for(var t=e,r=0;r<t.length;r++)this._materialRep.release(t[r]),this._materialRep.releaseDepthShadowMap(t[r]),this._materialRep.releaseNormal(t[r]),this._materialRep.releaseDepth(t[r]),this._materialRep.releaseHighlight(t[r]);else this._materialRep.release(e),this._materialRep.releaseDepthShadowMap(e),this._materialRep.releaseNormal(e),this._materialRep.releaseDepth(e),this._materialRep.releaseHighlight(e)},e.prototype._getInstance=function(e){var t=e.material,r=e.uniqueName,a=t.getId(),i=this._getType(e),n=this._getTargetMat2Data(i),s=e.origin.id,o=n[a];if(!o)return null;var l=o.origin2data[s];if(!l)return null;var d;return d=l.type===E.Preinterleaved?l.instances[r].instance:l.instances[r],d?{type:i,uniqueName:r,instance:d,matData:o,originData:l,instancedVAO:null,instancedVAOBaseInstance:null}:null},e.prototype._createBaseInstanceVAO=function(e){var t=this._rctx,r=e.instance,a=e.originData;if(e.type===E.Instanced&&a.perGeometryDataInfo){var i=a.perGeometryDataInfo[r.dataId],n=i.instanceBufferData;if(n){var s=i.vao,o=n.getSlot(r.idx);if(e.instancedVAOBaseInstance!==o){var l=R.setBaseInstanceOffset(s.layout,o);e.instancedVAO=new y(t,s.locations,l,s.vertexBuffers,s.indexBuffer),e.instancedVAOBaseInstance=o}}}},e.prototype._updateHighlightVAOs=function(){for(var e=0;e<this._highlights.length;++e){var t=this._highlights[e];this._createBaseInstanceVAO(t)}},e.prototype._getFallbackDepthTexture=function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new v(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255]))),this._fallbackDepthStencilTexture},e}(),Q=function(){function e(){this.reset()}return e.prototype.reset=function(){this.trianglesRendered=0,this.drawCallsInstanced=0,this.drawCallsAngleInstanced=0,this.drawCallsMerged=0,this.drawCallsPreinterleaved=0,this.drawCallsFragmented=0,this.drawCallsHighlight=0,this.instancesDrawnAngle=0,this.VBOallocatedSize=0,this.VBOoptimalSize=0,this.VBOusedSize=0},e}(),K=function(){function e(e,t,r,a,i,n,s,o){this.name=e,this.from=t,this.to=r,this.displayedIndexRange=a,this.transformation=i,this.instanceParameters=n,this.idx=s,this.dataId=o,null!=i&&(this.transformationNormal=F.create(),F.set(i,this.transformationNormal),F.inverse(this.transformationNormal,this.transformationNormal),F.transpose(this.transformationNormal,this.transformationNormal))}return e}();!function(e){e[e.Merged=0]="Merged",e[e.Instanced=1]="Instanced",e[e.Preinterleaved=2]="Preinterleaved"}(E||(E={}));var W=G.create(),X=F.identity(),Y=F.create(),J=F.create();return j});