// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","./ComponentUtils","./DefaultVertexAttributeLocations","./ExternalRendererContainer","./Float32ArrayList","./FxaaRenderPass","./gl-matrix","./HighlightTextureHelper","./InstanceBufferData","./IntervalUtilities","./LinearDepthTextureHelper","./NormalTextureHelper","./RenderContext","./RenderPass","./RenderSlot","./SmaaRenderPass","./StencilRenderingHelper","./Util","./edgeRendering/EdgeView","../lighting/SceneLighting","../materials/HUDMaterial","../../../webgl/BufferObject","../../../webgl/Profiling","../../../webgl/Texture","../../../webgl/Util","../../../webgl/VertexArrayObject"],function(e,t,r,a,i,n,s,o,d,l,h,g,f,p,u,m,_,c,v,y,x,R,b,I,D,A,P){function O(e){if(e.instanceParameters.hidden)return[];var t=e.instanceParameters.componentVisibilities,a=e.componentOffsets;return r.generateVisibleIndexRanges(t,a)}function T(e){if(e.instanceParameters.hidden)return[];var t=e.instanceParameters.componentVisibilities,a=e.instanceParameters.componentHighlights,i=e.componentOffsets;return r.generateHighlightedIndexRanges(t,a,i)}function C(e,t,r){var a=e.origin.vec3;N(Q,-a[0],-a[1],-a[2]),G.multiply(Q,e.transformation,t),G.inverse(t,r),G.transpose(r)}function H(e,t,r){for(var a in e){var i=e[a];t(a,i);for(var n in i.origin2data){r(n,i.origin2data[n])}}}function S(e){return M(e.data)>=1}function M(e){return!1===e.preinterleaved?B(e.indices).length:e.indexCount}var w,E=v.assert,V=v.objectEmpty,B=v.getFirstObjectValue,N=v.setMatrixTranslation3,L=o.vec2d,G=o.mat4d,F=G.identity(),U=1535,z=function(){function e(e,t,r,a,n){this._lighting=new x.SceneLighting,this._mat2DataMerged={},this._mat2DataInstanced={},this._mat2DataPreinterleaved={},this._renderOrder=[],this._externalRenderers=new i,this._renderContext=new p,this._isRendering=!1,this._highlights=[],this._pixelRatio=1,this._threshold=U,this._needsRender=!0,this._fallbackDepthStencilTexture=null,this._stats=new q,this._edgeView=void 0,this.ssaoEnabled=!1,this.renderOptions={antialiasing:"smaa",earlyOcclusionPixelDraw:!1},this._programRep=e,this._materialRep=t,this._orderedRendering=n,this._rctx=a,this._fxaaPass=new s(a),this._smaaPass=new _(a),this._renderContext.lightingData=this._lighting.getOld(),a.setDepthTestEnabled(!0),a.setFaceCullingEnabled(!0),a.setBlendingEnabled(!1),a.setBlendFunctionSeparate(770,771,1,771),this._bindParameters={view:null,proj:null,viewInvTransp:null,fovY:0,nearFar:null,lightingData:null,viewport:null,framebufferTex:null,shadowMappingEnabled:!1,ssaoEnabled:!1,origin:null,pixelRatio:null,instanceParameters:null,depthFBO:null,normalFBO:null},this._linearDepthTextureHelper=new g(a),this._normalTextureHelper=new f(a),this._highlightTextureHelper=new d(a),this._stencilRenderingHelper=new c(a),this._initializeFramebufferTexture()}return e.prototype._initializeFramebufferTexture=function(){var e=this._rctx.gl,t=this._rctx.contextAttributes,r=t.alpha?e.RGBA:e.RGB,a=new D(this._rctx,{target:3553,pixelFormat:r,dataType:5121,samplingMode:9728,wrapMode:33071,width:4,height:4});this._framebuffer={format:r,texture:a}},e.prototype.dispose=function(){var e=this,t=function(t){e._releaseMaterials(t)},r=function(e,t){if(t.type===w.Preinterleaved)for(var r in t.instances)t.instances[r].vao.dispose(!0);else t.vao.dispose(!0)};H(this._mat2DataMerged,t,r),H(this._mat2DataInstanced,t,r),H(this._mat2DataPreinterleaved,t,r),this._mat2DataMerged=null,this._mat2DataInstanced=null,this._mat2DataPreinterleaved=null,this._framebuffer.texture.dispose(),this._framebuffer.texture=null,this._linearDepthTextureHelper.getEnableState()&&this._linearDepthTextureHelper.disable(),this._normalTextureHelper.getEnableState()&&this._normalTextureHelper.disable(),this._highlightTextureHelper.getEnableState()&&this._highlightTextureHelper.setEnableState(!1),this._stencilRenderingHelper.getEnableState()&&this._stencilRenderingHelper.setEnableState(!1),this._fallbackDepthStencilTexture&&(this._fallbackDepthStencilTexture.dispose(),this._fallbackDepthStencilTexture=null)},Object.defineProperty(e.prototype,"isLoadingResources",{get:function(){return"smaa"===this.renderOptions.antialiasing&&this._smaaPass.isLoadingResources},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"edgeView",{get:function(){return void 0===this._edgeView&&(this._edgeView=y.EdgeView.isSupported(this._rctx)?new y.EdgeView(this._rctx,this._programRep):null),this._edgeView},enumerable:!0,configurable:!0}),e.prototype.setLighting=function(e){this._lighting.set(e)},e.prototype.setPixelRatio=function(e){this._pixelRatio=e,this._needsRender=!0},e.prototype.getPixelRatio=function(){return this._pixelRatio},e.prototype.addExternalRenderer=function(e,t){return this._externalRenderers.addRenderer(e,t),!0},e.prototype.removeExternalRenderer=function(e){return this._externalRenderers.removeRenderer(e),!0},e.prototype.getExternalRenderers=function(){return this._externalRenderers},e.prototype.resetNeedsRender=function(){this._needsRender=!1,this._externalRenderers.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._externalRenderers.needsRender()},e.prototype.getCombinedStats=function(){var e=this;this._stats.VBOallocatedSize=0,this._stats.VBOoptimalSize=0,this._stats.VBOusedSize=0;var t=function(){},r=function(t,r){if(r.type===w.Preinterleaved)for(var a in r.instances){var i=r.instances[a].vao.size;e._stats.VBOallocatedSize+=i/4,e._stats.VBOusedSize+=i/4,e._stats.VBOoptimalSize+=i/4}else e._stats.VBOallocatedSize+=r.buffer.getArray().length,e._stats.VBOusedSize+=r.buffer.getSize(),e._stats.VBOoptimalSize+=r.optimalCount};return H(this._mat2DataMerged,t,r),H(this._mat2DataInstanced,t,r),H(this._mat2DataPreinterleaved,t,r),this._stats.VBOallocatedSize*=4/1024,this._stats.VBOusedSize*=4/1024,this._stats.VBOoptimalSize*=4/1024,this._stats},e.prototype._addHighlight=function(e){var t=this._getInstance(e);if(null===t)return void console.error("No instance found for RenderGeometry {name: '"+e.name+"', uniqueName: '"+e.uniqueName+"'}");this._highlights.push(t),this._orderedRendering&&this._sortHighlightsByRenderOrder(),this._needsRender=!0,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights)},e.prototype._removeHighlight=function(e){var t=this._highlights.length;this._highlights=this._highlights.filter(function(t){return t.uniqueName!==e.uniqueName}),t!==this._highlights.length&&(this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights),this._needsRender=!0)},Object.defineProperty(e.prototype,"hasHighlights",{get:function(){return this._highlights.length>0},enumerable:!0,configurable:!0}),e.prototype._renderHUDVisibility=function(e){var t=this,r=R.shouldRenderVisibilityDuringRenderPass(e.pass),a=e.offscreenRenderingHelper&&e.offscreenRenderingHelper.getEnableState();r&&a&&e.offscreenRenderingHelper.renderHUDVisibility(function(){t._renderInternalSlot(m.OCCLUSION_PIXELS,e)})},e.prototype.renderGeometrySlotsPt1=function(e){this._externalRenderers.render(m.INTERNAL_MATERIAL,e),this._renderInternalSlot(m.STENCIL_MATERIAL,e),this._externalRenderers.render(m.OPAQUE_TERRAIN,e),this._renderInternalSlot(m.OPAQUE_MATERIAL,e),this._externalRenderers.render(m.OPAQUE_EXTERNAL,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep),this._externalRenderers.render(m.POSTPROCESSING_ATMOSPHERE_OPAQUE,this._renderContext),this._renderInternalSlot(m.TRANSPARENT_MATERIAL,e),this.renderOptions.earlyOcclusionPixelDraw&&(this._renderHUDVisibility(e),this._renderInternalSlot(m.LINE_CALLOUTS,this._renderContext)),this._externalRenderers.render(m.TRANSPARENT_EXTERNAL,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep)},e.prototype.renderGeometrySlotsPt2=function(e){this._externalRenderers.render(m.TRANSPARENT_TERRAIN,e)},e.prototype.renderGeometrySlots=function(e){this.renderGeometrySlotsPt1(e),this.renderGeometrySlotsPt2(e)},e.prototype._renderHighlights=function(e,t,r){var a=!!r&&r.getEnableState(),i=a&&(this.hasHighlights||this._externalRenderers.needsHighlight());if(this._highlightTextureHelper.setEnableState(i),i){var n=null;r.profilingCallback&&(n=I.startMeasurement(this._renderContext.rctx)),this._highlightTextureHelper.setupFBOs(e),this._highlightTextureHelper.prepareHighlightPass(),this.renderGeometryPass(u.MATERIAL_HIGHLIGHT,e,null,null);var s=this._rctx.gl;this._rctx.clear(s.DEPTH_BUFFER_BIT),this._renderInternalSlot(m.LINE_CALLOUTS_HUD_DEPTH,this._renderContext),this._renderInternalSlot(m.HUDMATERIAL1,this._renderContext),this._renderInternalSlot(m.HUDMATERIAL2,this._renderContext),this._highlightTextureHelper.finish(t);var o=this._highlightTextureHelper.getHighlightFBO();r.render(e,t,o),null!==n&&r.profilingCallback&&n.stop(function(e){r.profilingCallback&&r.profilingCallback(e)})}},e.prototype._needsRenderOccluded=function(e){for(var t in this._mat2DataInstanced){var r=this._mat2DataInstanced[t],a=r[0];if(a&&a.renderOccluded&&a.beginSlot(e)&&a.isVisible())return!0}return!1},e.prototype._renderOccluded=function(e,t,r){if(t&&r&&r.getEnableState()){var a=this._needsRenderOccluded(m.OPAQUE_MATERIAL)||this._needsRenderOccluded(m.TRANSPARENT_MATERIAL);if(a!==t.getEnableState()&&t.setEnableState(a),a){var i=this._renderContext;t.setupFBOs(e),t.prepareColorPass(),i.pass=u.MATERIAL,i.renderOccludedOnly=!0,this._renderInternalSlot(m.OPAQUE_MATERIAL,i),this._renderInternalSlot(m.TRANSPARENT_MATERIAL,i),i.renderOccludedOnly=!1,t.finish(r.getFramebuffer()),t.apply()}}},e.prototype._renderUnordered=function(e,t,r,a){var i=this,n=this._rctx;if(this._isRendering=!0,this._stats.reset(),this._updateGlobalUniforms(e.projectionMatrix),this._renderContext.pass=u.MATERIAL,this._renderContext.camera=e,this._renderContext.shadowMap=t,this._renderContext.ssaoHelper=a.ssao,this._renderContext.offscreenRenderingHelper=a.offscreenRendering,this._renderContext.stencilRenderingHelper=this._stencilRenderingHelper,this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO(),this._renderContext.normals=this._normalTextureHelper.getNormalFBO(),this._renderContext.highlight=this._highlightTextureHelper.getHighlightFBO(),this._renderContext.options=this.renderOptions,this._renderContext.rctx=this._rctx,this._renderContext.lightingData=this._lighting.getOld(),a.offscreenRendering.setEnableState(!0),a.offscreenRendering.initializeFrame(e),this._externalRenderers.render(m.BACKGROUND,this._renderContext),this.renderGeometrySlotsPt1(this._renderContext),this._edgeView){var s=null;this._edgeView.profilingCallback&&(s=I.startMeasurement(this._renderContext.rctx)),a.offscreenRendering.renderSeparateAndComposite(function(){i._edgeView.render(e,i._bindParameters)},void 0,this._edgeView.compositingMode),s&&s.stop(function(e){i._edgeView&&i._edgeView.profilingCallback&&i._edgeView.profilingCallback(e)})}this.renderGeometrySlotsPt2(this._renderContext),this._externalRenderers.render(m.POSTPROCESSING_ATMOSPHERE_TRANSPARENT,this._renderContext),this._externalRenderers.render(m.POSTPROCESSING_EXTERNAL,this._renderContext),this.renderOptions.earlyOcclusionPixelDraw||(this._renderHUDVisibility(this._renderContext),this._renderInternalSlot(m.LINE_CALLOUTS,this._renderContext)),this._renderOccluded(e,a.renderOccluded,a.offscreenRendering);var o=this.renderOptions.antialiasing;"smaa"===o&&this._smaaPass.loadResources(function(){i._needsRender=!0}),"smaa"===o&&this._smaaPass.enable()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:a.offscreenRendering.getColorTexture()},null)):"fxaa"===o&&this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:a.offscreenRendering.getColorTexture()},null)):(a.offscreenRendering.composite(),this._fxaaPass.disable(),this._smaaPass.disable()),n.bindFramebuffer(null),this._renderContext.framebufferTex=a.offscreenRendering.getColorTexture(),this._renderInternalSlot(m.LINE_CALLOUTS_HUD_DEPTH,this._renderContext),this._renderInternalSlot(m.HUDMATERIAL1,this._renderContext),this._renderInternalSlot(m.HUDMATERIAL2,this._renderContext),this._renderHighlights(e,r,a.highlight);this._isRendering=!1},e.prototype._renderGeometryPassOrderedHighlight=function(e){this._renderInternalHighlights(this._highlights)},e.prototype._renderGeometryPassOrderedMaterial=function(e){for(var t=null,r=0;r<this._renderOrder.length;r++){var a=this._renderOrder[r][1];if(a.instanced){var i=a.instanced||a.merged,n=i[e.pass];n&&n.isVisible()&&(this._renderInternalInstanced(i,n,this._bindParameters,1/0),t=null)}if(a.merged){var i=a.merged,n=i[e.pass];if(n&&n.isVisible()){var s=n.getProgram();s!==t&&(s.setUniformMatrix4fv("model",F),s.hasUniform("modelNormal")&&s.setUniformMatrix4fv("modelNormal",F)),t=s,this._renderInternalMerged(i,n,this._bindParameters,1/0)}}}},e.prototype._renderGeometryPassOrdered=function(e){var t=e.camera;this._bindParameters.view=t.viewMatrix,this._bindParameters.proj=t.projectionMatrix,this._bindParameters.viewInvTransp=t.viewInverseTransposeMatrix,j[0]=t.near,j[1]=t.far,this._bindParameters.nearFar=j,this._bindParameters.lightingData=this._lighting.getOld(),this._bindParameters.viewport=t.fullViewport,this._bindParameters.framebufferTex=this._framebuffer.texture,this._bindParameters.pixelRatio=this._pixelRatio,this._bindParameters.instanceParameters=void 0,this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO(),this._bindParameters.normalFBO=this._normalTextureHelper.getNormalFBO(),e.isHighlightPass?this._renderGeometryPassOrderedHighlight(e):this._renderGeometryPassOrderedMaterial(e)},e.prototype._renderOrdered=function(e,t){this._stats.reset(),this.renderGeometryPass(e,t)},e.prototype.render=function(e,t,r){this._orderedRendering?this._renderOrdered(u.MATERIAL,e):this._renderUnordered(e,r.shadowMap,t,r)},e.prototype.renderAuxiliaryBuffers=function(e,t,r){var a=r.ssao,i=r.shadowMap,n=this.ssaoEnabled||this._externalRenderers.needsLinearDepth();this._linearDepthTextureHelper.setEnableState(n),n&&(this._linearDepthTextureHelper.setupFBOs(e),this._linearDepthTextureHelper.prepareDepthPass(),this.renderGeometryPass(u.MATERIAL_DEPTH,e,i,a),this._linearDepthTextureHelper.finish(t)),this._normalTextureHelper.setEnableState(this.ssaoEnabled),this.ssaoEnabled&&(this._normalTextureHelper.setupFBOs(e),this._normalTextureHelper.prepareNormalPass(),this.renderGeometryPass(u.MATERIAL_NORMAL,e,i,a),this._normalTextureHelper.finish(t)),this.ssaoEnabled&&a.computeSSAO(e,t,this._linearDepthTextureHelper.getDepthFBO(),this._normalTextureHelper.getNormalFBO()),a.bindAll(this._programRep)},e.prototype.renderGeometryPass=function(e,t,r,a){this._isRendering=!0,this._updateGlobalUniforms(t.projectionMatrix),this._renderContext.pass=e,this._renderContext.camera=t,this._renderContext.shadowMap=r,this._renderContext.ssaoHelper=a,this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO(),this._renderContext.normals=this._normalTextureHelper.getNormalFBO(),this._renderContext.rctx=this._rctx,this._orderedRendering?this._renderGeometryPassOrdered(this._renderContext):this._renderGeometryPassUnordered(this._renderContext),this._isRendering=!1},e.prototype._renderGeometryPassUnordered=function(e){this.renderGeometrySlots(e)},e.prototype._renderInternalHighlights=function(e,t){void 0===t&&(t=null);for(var r=0;r<e.length;++r){var a=e[r],i=a.matData[u.MATERIAL_HIGHLIGHT];i&&(null===t||i.beginSlot(t))&&i.isVisible()&&this._renderInternalHighlight(a,this._bindParameters,u.MATERIAL_HIGHLIGHT)}},e.prototype._renderInternalSlotOccluded=function(e,t){for(var r in this._mat2DataInstanced){var a=this._mat2DataInstanced[r],i=a[t.pass];i&&i.renderOccluded&&i.beginSlot(e)&&i.isVisible()&&this._renderInternalInstanced(a,i,this._bindParameters,e)}},e.prototype._renderInternalSlotMaterial=function(e,t){for(var r in this._mat2DataInstanced){var a=this._mat2DataInstanced[r],i=a[t.pass];i&&i.beginSlot(e)&&i.isVisible()&&this._renderInternalInstanced(a,i,this._bindParameters,e)}for(var n=this._programRep.getProgramsUsingUniform("model"),s=this._programRep.getProgramsUsingUniform("modelNormal"),o=0;o<n.length;o++){var d=n[o];d.setUniformMatrix4fv("model",F),s.indexOf(d)>-1&&d.setUniformMatrix4fv("modelNormal",F)}for(var r in this._mat2DataMerged){var a=this._mat2DataMerged[r],i=a[t.pass];i&&i.beginSlot(e)&&i.isVisible()&&this._renderInternalMerged(a,i,this._bindParameters,e)}for(var r in this._mat2DataPreinterleaved){var a=this._mat2DataPreinterleaved[r],i=a[t.pass];i&&i.beginSlot(e)&&i.isVisible()&&this._renderInternalPreinterleaved(a,i,this._bindParameters,e)}e===m.STENCIL_MATERIAL&&this._stencilRenderingHelper.finish()},e.prototype._renderInternalSlotHighlights=function(e,t){this._renderInternalHighlights(this._highlights,e)},e.prototype._renderInternalSlot=function(e,t){this._bindParameters.view=t.camera.viewMatrix,this._bindParameters.proj=t.camera.projectionMatrix,this._bindParameters.viewInvTransp=t.camera.viewInverseTransposeMatrix,this._bindParameters.cameraAboveGround=t.camera.aboveGround,this._bindParameters.fovY=t.camera.fovY,this._bindParameters.poiDistance=t.camera.distance,j[0]=t.camera.near,j[1]=t.camera.far;var r=this._renderContext.offscreenRenderingHelper;this._bindParameters.nearFar=j,this._bindParameters.lightingData=this._lighting.getOld(),this._bindParameters.viewport=t.camera.fullViewport,this._bindParameters.framebufferTex=r?r.getColorTexture():null,this._bindParameters.shadowMap=t.shadowMap,this._bindParameters.shadowMappingEnabled=!!t.shadowMap&&t.shadowMap.getEnableState(),this._bindParameters.ssaoEnabled=!!t.ssaoHelper&&t.ssaoHelper.getEnableState(),this._bindParameters.pixelRatio=this._pixelRatio,this._bindParameters.instanceParameters=void 0,this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO(),this._bindParameters.hudVisibilityTexture=r?r.getHUDVisibilityTexture():null,t.isHighlightPass?this._renderInternalSlotHighlights(e,t):t.renderOccludedOnly?this._renderInternalSlotOccluded(e,t):this._renderInternalSlotMaterial(e,t)},e.prototype._renderInternalInstanced=function(e,t,r,a){var i=this._rctx,n=i.gl,s=!1,o=t.getDrawMode(i),d=i.capabilities.instancing;for(var l in e.origin2data){var h=e.origin2data[l];r.origin=h.origin,a===m.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());var g=!1;if(t.instanced)for(var f in h.perGeometryDataInfo){var p=h.perGeometryDataInfo[f];s||(t.bind(i,r),s=!0),i.bindVAO(p.vao);var u=t.getProgram();A.assertCompatibleVertexAttributeLocations(p.vao,u),g||(t.bindView(i,r),g=!0);var _=p.to-p.from,c=p.refCount;o===n.TRIANGLES&&(this._stats.trianglesRendered+=c*_/3),d.drawArraysInstanced(o,p.from,_,c),this._stats.drawCallsAngleInstanced++,this._stats.instancesDrawnAngle+=c}else{var v=h.instances;for(var y in v){var x=v[y],R=x.displayedIndexRange;R&&0===R.length||(s||(t.bind(i,r),s=!0),g||(i.bindVAO(h.vao),t.bindView(i,r),g=!0),t.bindInstance(i,x),this._stats.drawCallsInstanced++,o===n.TRIANGLES&&(this._stats.trianglesRendered+=(x.to-x.from)/3),R?this._drawArraysFaceRange(R,x.from,o):i.drawArrays(o,x.from,x.to-x.from))}}}i.bindVAO(null),s&&t.release(i,r)},e.prototype._renderInternalHighlight=function(e,t,r){var a=this._rctx,i=a.gl,n=e.matData[r],s=n.getDrawMode(a),o=e.instance,d=o.highlightedIndexRange,l=this._renderContext.offscreenRenderingHelper,h=(l?l.getDepthTexture():null)||this._getFallbackDepthTexture(),g=n.getProgram(),f=a.capabilities.instancing;if(t.origin=e.originData.origin,n.instanced&&e.type===w.Instanced){var p=e.instancedVAO;n.bind(a,t),a.bindVAO(p),A.assertCompatibleVertexAttributeLocations(p,g),n.bindView(a,t);for(var u=0;u<d.length;u++){var m=d[u],_=m.range?m.range[0]+o.from:o.from,c=m.range?m.range[1]-m.range[0]+1:o.to-o.from;a.bindTexture(h,5),g.setUniform1i("depthTex",5),g.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),f.drawArraysInstanced(s,_,c,1),s===i.TRIANGLES&&(this._stats.trianglesRendered+=1*c/3),this._stats.drawCallsHighlight++}}else if(e.type===w.Instanced&&n.instanced)console.error("_renderInternalHighlight: incompatible instance type");else{n.bind(a,t),n.bindView(a,t);var v=null;switch(e.type){case w.Merged:var y=e.originData;a.bindVAO(y.vao),g.setUniformMatrix4fv("model",F);break;case w.Instanced:var y=e.originData;a.bindVAO(y.vao),n.bindInstance(a,o);break;case w.Preinterleaved:var y=e.originData,p=y.instances[e.uniqueName].vao;a.bindVAO(p),n.bindInstance(a,o),v=p.indexBuffer&&p.indexBuffer.indexType}for(var u=0;u<d.length;u++){var m=d[u],_=m.range?m.range[0]+o.from:o.from,c=m.range?m.range[1]-m.range[0]+1:o.to-o.from;if(a.bindTexture(h,5),n.getProgram().setUniform1i("depthTex",5),g.setUniform4f("highlightViewportPixelSz",0,0,1/this._bindParameters.viewport[2],1/this._bindParameters.viewport[3]),v){var x=A.getBytesPerElement(v);a.drawElements(s,c,v,_*x)}else a.drawArrays(s,_,c);s===i.TRIANGLES&&(this._stats.trianglesRendered+=c/3),this._stats.drawCallsHighlight++}}a.bindVAO(null),n.release(a,t)},e.prototype._drawArraysFaceRange=function(e,t,r){for(var a=this._rctx,i=0,n=e;i<n.length;i++){var s=n[i];a.drawArrays(r,s[0]+t,s[1]-s[0]+1)}this._stats.drawCallsFragmented+=e.length-1},e.prototype._drawElementsFaceRange=function(e,t,r,a){for(var i=this._rctx,n=A.getBytesPerElement(a),s=0,o=e;s<o.length;s++){var d=o[s],l=d[1]-d[0]+1,h=d[0]+t;i.drawElements(r,l,a,h*n)}this._stats.drawCallsFragmented+=e.length-1},e.prototype._renderInternalMerged=function(e,t,r,a){var i=this._rctx,n=i.gl,s=!1;for(var o in e.origin2data){var d=e.origin2data[o];if(r.origin=d.origin,a===m.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass()),!d.displayedIndexRange||0!==d.displayedIndexRange.length){s||(t.bind(i,r),s=!0);var l=t.getProgram();i.bindVAO(d.vao),A.assertCompatibleVertexAttributeLocations(d.vao,l),t.bindView(i,r),this._stats.drawCallsMerged++;var h=t.getDrawMode(i);h===n.TRIANGLES&&(this._stats.trianglesRendered+=d.vao.vertexBuffers.geometry.size/3),d.displayedIndexRange?this._drawArraysFaceRange(d.displayedIndexRange,0,h):i.drawArrays(h,0,A.vertexCount(d.vao,"geometry"))}}s&&t.release(i,r)},e.prototype._renderInternalPreinterleaved=function(e,t,r,a){var i=this._rctx,n=i.gl,s=!1,o=t.getDrawMode(i);for(var d in e.origin2data){var l=e.origin2data[d];r.origin=l.origin;var h=!1;a===m.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());for(var g in l.instances){var f=l.instances[g],p=f.instance,u=f.vao,_=p.displayedIndexRange;if(!_||0!==_.length){s||(t.bind(i,r),s=!0);var c=t.getProgram();A.assertCompatibleVertexAttributeLocations(u,c),i.bindVAO(u),h||(t.bindView(i,r),h=!0),t.bindInstance(i,p),this._stats.drawCallsPreinterleaved++,o===n.TRIANGLES&&(this._stats.trianglesRendered+=(p.to-p.from)/3);var v=u.indexBuffer&&u.indexBuffer.indexType;if(_)v?this._drawElementsFaceRange(_,p.from,o,v):this._drawArraysFaceRange(_,p.from,o);else if(v){var y=A.getBytesPerElement(v);i.drawElements(o,p.to-p.from,v,p.from*y)}else i.drawArrays(o,p.from,p.to-p.from)}}}i.bindVAO(null),s&&t.release(i,r)},e.prototype._updateGlobalUniforms=function(e){for(var t=this._programRep.getProgramsUsingUniform("proj"),r=0;r<t.length;r++)t[r].setUniformMatrix4fv("proj",e);if(this._lighting){t=this._programRep.getProgramsUsingUniform("lightingMainDirection");for(var r=0;r<t.length;r++)this._lighting.setUniforms(t[r]);t=this._programRep.getProgramsUsingUniform("lightDirection");for(var r=0;r<t.length;r++)this._lighting.setUniforms(t[r])}},e.prototype.print=function(){var e=Object.keys(this._mat2DataMerged).length,t=Object.keys(this._mat2DataInstanced).length,r=Object.keys(this._mat2DataPreinterleaved).length;console.log("number of materials (merged/instanced/preinterleaved): "+e+"/"+t+"/"+r);var a=0;H(this._mat2DataMerged,function(){},function(e,t){a+=Object.keys(t.instances).length});var i=0;H(this._mat2DataInstanced,function(){},function(e,t){i+=Object.keys(t.instances).length});var n=0;H(this._mat2DataPreinterleaved,function(){},function(e,t){n+=Object.keys(t.instances).length}),console.log("number of instances (merged/instanced/preinterleaved): "+a+"/"+i+"/"+n)},e.prototype.isEmpty=function(){for(var e in this._mat2DataInstanced){var t=this._mat2DataInstanced[e];for(var r in t.origin2data)if(!V(t.origin2data[r].instances))return!1}for(var e in this._mat2DataMerged){var t=this._mat2DataMerged[e];for(var r in t.origin2data)if(!V(t.origin2data[r].instances))return!1}for(var e in this._mat2DataPreinterleaved){var t=this._mat2DataPreinterleaved[e];for(var r in t.origin2data)if(!V(t.origin2data[r].instances))return!1}return!0},e.prototype.modify=function(e,t,r,a){this._isRendering&&console.warn("Renderer.modify called while rendering");var i=[],n=[],s=[];this._classifyRenderGeometry(e,i,n,s);var o=[],d=[],l=[];this._classifyRenderGeometry(t,o,d,l);var h={};r&&this._performUpdates(r,h);var g=[];this._modifyMerged(i,o,g,h),this._modifyInstanced(n,d,g),this._modifyPreinterleaved(s,l,g),this._updateMergedFaceranges(h),this._releaseMaterials(g);var f=this._highlights.length;t&&t.length>0&&f>0&&(this._highlights=this._highlights.filter(function(e){return!t.some(function(t){return t.uniqueName===e.uniqueName})}),f!==this._highlights.length&&this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this.hasHighlights)),this._updateHighlightVAOs(),this._modifyMaterials(a),this._needsRender=!0},e.prototype._classifyRenderGeometry=function(e,t,r,a){for(var i=0,n=e;i<n.length;i++){var s=n[i];if(S(s))switch(this._getType(s)){case w.Merged:t.push(s);break;case w.Instanced:r.push(s);break;case w.Preinterleaved:a.push(s)}}},e.prototype._performUpdates=function(e,t){for(var r=0,a=e;r<a.length;r++){var i=a[r],n=i.updateType,s=i.renderGeometry,o=this._getType(s)===w.Merged;if(S(s)){if(2&n&&this._updateFaceranges(s,t),32&n){var d=this._getInstance(s);d&&this._updateHighlightFaceranges(s,d.instance)}4&n||o&&16&n?this._updateVertexAttributes(s,!o):!o&&16&n&&this._updateInstanceTransformation(s)}}},e.prototype._updateFaceranges=function(e,t){var r,a=e.material,i=a.id,n=e.origin.id,s=this._getType(e);if(s===w.Preinterleaved){var o=this._getOriginData(s,i,n);r=o.instances[e.uniqueName].instance}else{var o=this._getOriginData(s,i,n);r=o.instances[e.uniqueName],r&&s===w.Merged&&(t[this._modifiedMergedFacerangesKey(i,n)]=o)}r&&(r.displayedIndexRange=O(e),this._updateHighlightFaceranges(e,r))},e.prototype._updateHighlightFaceranges=function(e,t){if(t){var r=t.highlightedIndexRange,a=T(e);t.highlightedIndexRange=a,a&&!r?this._addHighlight(e):!a&&r&&this._removeHighlight(e)}},e.prototype._updateMergedFaceranges=function(e){for(var t in e){var r=e[t];r.displayedIndexRange=[];var a=r.instances,i=!0;for(var n in a){var s=a[n];s.displayedIndexRange?(r.displayedIndexRange.push.apply(r.displayedIndexRange,h.offsetIntervals(s.displayedIndexRange,s.from)),i=!1):r.displayedIndexRange.push([s.from,s.to-1])}r.displayedIndexRange=i?null:h.mergeIntervals(r.displayedIndexRange)}},e.prototype._updateVertexAttributes=function(e,t){var r=e.material,a=r.id,i=e.origin.id,n=A.getStride(r.getVertexBufferLayout())/4,s=this._getType(e);if(s===w.Preinterleaved)return void console.error("Updating Preinterleaved geometry not supported");var o,d,l=this._getOriginData(s,a,i),h=l.instances[e.uniqueName],g=l.buffer.getArray(),f=l.vao;t||(C(e,K,W),o=K,d=W),r.fillInterleaved(e.data,o,d,e.instanceParameters,g,h.from*n),E(h.from+r.getOutputAmount(M(e.data))/n===h.to,"material VBO layout has changed"),f.vertexBuffers.geometry.setSubData(g,h.from*n*4,h.from*n*4,h.to*n*4)},e.prototype._updateInstanceTransformation=function(e){var t=this._getType(e),r=e.material.id,a=e.origin.id;if(t===w.Preinterleaved){var i=this._getOriginData(t,r,a),n=i.instances[e.uniqueName].instance;C(e,n.transformation,n.transformationNormal)}else{var i=this._getOriginData(t,r,a),n=i.instances[e.uniqueName],s=i.perGeometryDataInfo[e.data.id],o=s.instanceBufferData;if(C(e,n.transformation,n.transformationNormal),o){var d=o.getSlot(e.idx);o.fill(d,0,n.transformation),o.fill(d,16,n.transformationNormal);var l=o.getOffset(d),h=4*l,g=A.getStride(s.vao.layout.instance);s.vao.vertexBuffers.instance.setSubData(o.getArray(),h,h,h+g)}}},e.prototype._modifyMerged=function(e,t,r,i){var s=this._rctx,o=w.Merged,d=this._compMat2delta(e,t,o),l=this._mat2DataMerged;for(var h in d){var g=d[h];for(var f in g){var p=g[f],u=p.optimalCount,m=p.material,_=m.getVertexBufferLayout(),c=A.getStride(_)/4,v=l[h];if(null==v){E(u>0);var y=m.renderPriority;v=this._initializeMatData(m),l[h]=v,this._orderedRendering&&this._insertIntoRenderOrder(v,y,"merged")}var x=v.origin2data[f];if(null==x&&(E(u>0),x={type:o,instances:{},vao:new P(s,a.Default3D,{geometry:_},{geometry:b.createVertex(s,35044)}),buffer:new n(u),optimalCount:0,origin:p.origin},v.origin2data[f]=x),u>0){var R=x.buffer.getSize(),I=x.buffer.getArray(),D=u<p.sparseCount/2,T=x.buffer.resize(D?u:p.sparseCount),C=p.toRemove;if(D||T){R=0;for(var H=x.buffer.getArray(),S=0;S<C.length;++S){var V=x.instances[C[S].uniqueName];x.optimalCount-=(V.to-V.from)*c,delete x.instances[C[S].uniqueName]}var B={};for(var L in x.instances){var V=x.instances[L];E(null==B[V.from]),B[V.from]=V}for(var F in B){var V=B[F],U=V.from*c,z=V.to*c;H.set(I.subarray(U,z),R),V.from=R/c,R+=z-U,V.to=R/c}E(R===x.optimalCount)}else for(var S=0;S<C.length;++S){var q=C[S].uniqueName;E(void 0!==x.instances[q]);var U=x.instances[q].from*c,z=x.instances[q].to*c;x.buffer.erase(U,z),delete x.instances[q],x.optimalCount-=z-U}N(Q,-p.origin[0],-p.origin[1],-p.origin[2]);for(var j=p.toAdd,X=!1,S=0;S<j.length;++S){var Y=j[S],J=Y.data;G.multiply(Q,Y.transformation,K),G.inverse(K,W),G.transpose(W);var Z=R;m.fillInterleaved(J,K,W,Y.instanceParameters,x.buffer.getArray(),R);var $=m.getOutputAmount(M(J)),ee=Z+$;E(null==x.instances[Y.uniqueName]);var te=O(Y),V=new k(Y.name,Z/c,ee/c,te,void 0,void 0,Y.idx);x.instances[Y.uniqueName]=V,this._updateHighlightFaceranges(Y,V),te&&(X=!0),x.optimalCount+=$,R+=$}E(x.optimalCount===u);var re=new Float32Array(x.buffer.getArray().buffer,0,x.buffer.getSize());x.vao.vertexBuffers.geometry.setData(re),(X||x.displayedIndexRange)&&(i[this._modifiedMergedFacerangesKey(h,f)]=x)}else E(0===u),x.vao.dispose(!0),x.vao=null,delete v.origin2data[f],0===Object.keys(v.origin2data).length&&(r.push(h),delete l[h],this._orderedRendering&&this._removeFromRenderOrder(v,"merged"))}}},e.prototype._modifyInstanced=function(e,t,r){var i=this._rctx,s=w.Instanced,o=this._compMat2delta(e,t,s),d=this._mat2DataInstanced;for(var h in o){var g=o[h];for(var f in g){var p=g[f];if(0!==p.optimalCount){var m=p.material,_=d[h];if(null==_){var c=m.renderPriority;_=this._initializeMatData(m),d[h]=_,this._orderedRendering&&this._insertIntoRenderOrder(_,c,"instanced")}var v=m.getVertexBufferLayout(),y=_[u.MATERIAL].instanced?m.getInstanceBufferLayout():void 0,x=y&&A.findAttribute(y,"instanceColor"),R=y&&A.findAttribute(y,"instanceFeatureAttribute"),I=A.getStride(v)/4,D=_.origin2data[f];null==D&&(D={type:s,instances:{},vao:new P(i,a.Default3D,{geometry:v},{geometry:b.createVertex(i,35044)}),buffer:new n(p.optimalCount),optimalCount:0,perGeometryDataInfo:{},origin:p.origin},_.origin2data[f]=D);var T=D.buffer.getSize(),C=D.buffer.getArray(),H=p.optimalCount<p.sparseCount/2,S=D.buffer.resize(H?p.optimalCount:p.sparseCount);for(var V in p.perGeometryDelta){var B=D.perGeometryDataInfo[V];if(B&&B.instanceBufferData){var L=p.perGeometryDelta[V].removeCount;L>0&&B.instanceBufferData.prepareFree(L)}}var F=p.toRemove;if(H||S){for(var U=0;U<F.length;++U){var z=F[U];delete D.instances[z.uniqueName];var V=z.data.id,B=D.perGeometryDataInfo[V],q=B;0==--q.refCount&&null==p.dataId2refCount[V]?(D.optimalCount-=(q.to-q.from)*I,delete D.perGeometryDataInfo[V]):B.instanceBufferData&&B.instanceBufferData.free(z.idx)}T=0;var j=D.buffer.getArray(),K={};for(var W in D.perGeometryDataInfo){var q=D.perGeometryDataInfo[W];E(null==K[q.from]),K[q.from]=q}for(var X in K){var q=K[X],Y=q.from*I,J=q.to*I;j.set(C.subarray(Y,J),T),q.from=T/I,T+=J-Y,
q.to=T/I}for(var Z in D.instances){var $=D.instances[Z];$.from=D.perGeometryDataInfo[$.dataId].from,$.to=D.perGeometryDataInfo[$.dataId].to}}else for(var U=0;U<F.length;++U){var z=F[U];delete D.instances[z.uniqueName];var V=z.data.id,B=D.perGeometryDataInfo[V];if(0==--B.refCount&&null==p.dataId2refCount[V]){var Y=B.from*I,J=B.to*I;D.buffer.erase(Y,J),D.optimalCount-=J-Y,delete D.perGeometryDataInfo[V]}else B.instanceBufferData&&B.instanceBufferData.free(z.idx)}N(Q,-p.origin[0],-p.origin[1],-p.origin[2]);for(var V in p.perGeometryDelta){var B=D.perGeometryDataInfo[V];if(B&&B.instanceBufferData){var ee=p.perGeometryDelta[V].addCount;ee>0&&B.instanceBufferData.prepareAllocate(ee)}}for(var te=p.toAdd,U=0;U<te.length;++U){var z=te[U],re=z.data,V=re.id,B=D.perGeometryDataInfo[V];if(null==B){m.fillInterleaved(re,void 0,void 0,void 0,D.buffer.getArray(),T);var ae=m.getOutputAmount(M(re)),Y=T/I;T+=ae;var J=T/I;if(D.optimalCount+=ae,B={refCount:1,from:Y,to:J,vao:null,instanceBufferData:null},y){var ie=A.getStride(y)/4;B.vao=new P(i,a.Default3D,{geometry:v,instance:y},{geometry:D.vao.vertexBuffers.geometry,instance:b.createVertex(i,35044)}),B.instanceBufferData=new l(ie,p.perGeometryDelta[V].addCount)}D.perGeometryDataInfo[V]=B}else++B.refCount;E(B.from*I<=D.buffer.getSize()&&B.to*I<=D.buffer.getSize());var ne=G.create();G.multiply(Q,z.transformation,ne);var se=O(z),$=new k(z.name,B.from,B.to,se,ne,z.instanceParameters,z.idx,V);D.instances[z.uniqueName]=$,this._updateHighlightFaceranges(z,$);var oe=B.instanceBufferData;if(oe){var de=oe.allocate(z.idx);oe.fill(de,0,$.transformation),oe.fill(de,16,$.transformationNormal),x&&oe.fill(de,x.offset/4,z.instanceParameters.color),R&&oe.fill(de,R.offset/4,z.instanceParameters.featureAttribute)}}E(D.optimalCount===p.optimalCount);var le=new Float32Array(D.buffer.getArray().buffer,0,D.buffer.getSize());D.vao.vertexBuffers.geometry.setData(le);for(var V in D.perGeometryDataInfo){var he=D.perGeometryDataInfo[V];if(he.vao){var ge=he.vao.vertexBuffers.instance;if(ge){var fe=p.perGeometryDelta[V];if(fe.addCount+fe.removeCount>0){var pe=he.instanceBufferData.compact();ge.setData(pe)}}}}}else{var ue=d[h];ue.origin2data[f].vao.dispose(!0),delete ue.origin2data[f],0===Object.keys(ue.origin2data).length&&(r.push(h),delete d[h],this._orderedRendering&&this._removeFromRenderOrder(ue,"instanced"))}}}},e.prototype._modifyPreinterleaved=function(e,t,r){for(var i=this._rctx,n=w.Preinterleaved,s=this._mat2DataPreinterleaved,o=0,d=e;o<d.length;o++){var l=d[o],h=l.material,g=h.id,f=l.origin.id,p=l.origin.vec3,u=s[g];null==u&&(u=this._initializeMatData(h),s[g]=u);var m=u.origin2data[f];null==m&&(m={type:n,origin:p,count:0,instances:{}},u.origin2data[f]=m),N(Q,-p[0],-p[1],-p[2]);var _=G.create();G.multiply(Q,l.transformation,_);var c=O(l),v=l.data;if(v.preinterleaved)if(null!=v.vertexData){var y=v.indexCount,x=v.id,R=new k(l.name,0,y,c,_,l.instanceParameters,l.idx,x),I=v.indexData?b.createIndex(i,35044,v.indexData):null,D=h.getVertexBufferLayout(),A=new P(i,a.Default3D,{geometry:D},{geometry:b.createVertex(i,35044)},I);A.vertexBuffers.geometry.setData(v.vertexData),v.vertexData=null,m.count+=1,m.instances[l.uniqueName]={instance:R,vao:A},this._updateHighlightFaceranges(l,R)}else E(!1,"Trying to re-add preinterleaved geometry data which is no longer available.");else E(!1,"Non-interleaved render geometry processed as pre-interleaved")}for(var T=0,C=t;T<C.length;T++){var l=C[T],p=l.origin,h=l.material,g=h.id,f=p.id,H=l.uniqueName,u=s[g],S=u.origin2data[f];S.instances[H].vao.dispose(),delete S.instances[H],S.count-=1,0===S.count&&delete u.origin2data[f],0===Object.keys(u.origin2data).length&&(r.push(g),delete s[g])}},e.prototype._compMat2delta=function(e,t,r){var a={};return this._updateMat2delta(e,!0,r,a),this._updateMat2delta(t,!1,r,a),a},e.prototype._updateMat2delta=function(e,t,r,a){for(var i=r===w.Instanced,n=0,s=e;n<s.length;n++){var o=s[n],d=o.origin,l=o.material,h=l.id,g=i?this._mat2DataInstanced[h]:this._mat2DataMerged[h],f=g&&g.origin2data[d.id],p=a[h];null==p&&(p={},a[h]=p);var u=p[d.id];if(null==u){if(u={optimalCount:null==f?0:f.optimalCount,sparseCount:null==f?0:f.buffer.getSize(),material:l,toAdd:[],toRemove:[],perGeometryDelta:null,origin:d.vec3},i){var m={};if(void 0!==f)for(var _ in f.perGeometryDataInfo)m[_]=f.perGeometryDataInfo[_].refCount;u.dataId2refCount=m,u.perGeometryDelta={}}p[d.id]=u}var c=l.getOutputAmount(M(o.data));if(i){var v=o.data.id,y=u.perGeometryDelta[v];y||(y={addCount:0,removeCount:0},u.perGeometryDelta[v]=y),t?(y.addCount++,null==u.dataId2refCount[v]&&(u.dataId2refCount[v]=0),1==++u.dataId2refCount[v]&&(u.optimalCount+=c,u.sparseCount+=c),u.toAdd.push(o)):(y.removeCount++,0==--u.dataId2refCount[v]&&(delete u.dataId2refCount[v],u.optimalCount-=c),u.toRemove.push(o))}else t?(u.optimalCount+=c,u.sparseCount+=c,u.toAdd.push(o)):(u.optimalCount-=c,u.toRemove.push(o))}},e.prototype._getType=function(e){if(e.data.preinterleaved)return w.Preinterleaved;var t=!1,r=M(e.data);return t=t||!1===e.material.canBeMerged,t=t||e.material.instanced,t=t||!0===e.material.renderOccluded,e.singleUse||(t=t||r>this._threshold),t?w.Instanced:w.Merged},e.prototype._getTargetMat2Data=function(e){switch(e){case w.Merged:return this._mat2DataMerged;case w.Instanced:return this._mat2DataInstanced;case w.Preinterleaved:return this._mat2DataPreinterleaved}},e.prototype._getOriginData=function(e,t,r){return this._getTargetMat2Data(e)[t].origin2data[r]},e.prototype._modifiedMergedFacerangesKey=function(e,t){return e+"_"+t},e.prototype._insertIntoRenderOrder=function(e,t,r){for(var a=e[u.MATERIAL].materialId,i=this._renderOrder.length,n=0;n<i&&this._renderOrder[n][0]>=t;){var s=this._renderOrder[n][1];if(s.id===a)return E(!s[r],"matData for type already exists"),void(s[r]=e);n++}var o={id:a,instanced:null,merged:null};o[r]=e,this._renderOrder.splice(n,0,[t,o])},e.prototype._removeFromRenderOrder=function(e,t){for(var r=e[u.MATERIAL].materialId,a=0;this._renderOrder[a][1].id!==r;)a++;var i=this._renderOrder[a][1];i[t]=null,i.instanced||i.merged||this._renderOrder.splice(a,1)},e.prototype._sortHighlightsByRenderOrder=function(){this._highlights.sort(function(e,t){var r=e.matData[u.MATERIAL].renderPriority,a=t.matData[u.MATERIAL].renderPriority;return r>a?-1:a>r?1:0})},e.prototype._updateRenderOrder=function(e,t){for(var r=t.length,a=0;a<r&&t[a][1].id!==e;)a++;if(a<r){var i=t[a][1],n=i.merged||i.instanced,s=n[u.MATERIAL].renderPriority,o=t[a][0];if(s!==t[a][0]){t[a][0]=s;var d=s>o?-1:1;for(a+=d;a>-1&&a<r&&d*t[a][0]>d*s;){var l=t[a];t[a]=t[a-d],t[a-d]=l,a+=d}}}},e.prototype._modifyMaterials=function(e){for(var t in e)this._materialRep.updateMaterialParameters(t)},e.prototype.modifyRenderOrder=function(e){if(this._orderedRendering){for(var t in e)this._updateRenderOrder(t,this._renderOrder);this._sortHighlightsByRenderOrder(),this._needsRender=!0}},e.prototype._initializeMatData=function(e){var t={origin2data:{}};return t[u.MATERIAL]=this._materialRep.aquire(e),t[u.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(e),t[u.MATERIAL_NORMAL]=this._materialRep.aquireNormal(e),t[u.MATERIAL_DEPTH]=this._materialRep.aquireDepth(e),t[u.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(e),t},e.prototype._releaseMaterials=function(e){if(Array.isArray(e))for(var t=e,r=0;r<t.length;r++)this._materialRep.release(t[r]),this._materialRep.releaseDepthShadowMap(t[r]),this._materialRep.releaseNormal(t[r]),this._materialRep.releaseDepth(t[r]),this._materialRep.releaseHighlight(t[r]);else this._materialRep.release(e),this._materialRep.releaseDepthShadowMap(e),this._materialRep.releaseNormal(e),this._materialRep.releaseDepth(e),this._materialRep.releaseHighlight(e)},e.prototype._getInstance=function(e){var t=e.material,r=e.uniqueName,a=t.id,i=this._getType(e),n=this._getTargetMat2Data(i),s=e.origin.id,o=n[a];if(!o)return null;var d=o.origin2data[s];if(!d)return null;var l;return l=d.type===w.Preinterleaved?d.instances[r].instance:d.instances[r],l?{type:i,uniqueName:r,instance:l,matData:o,originData:d,instancedVAO:null,instancedVAOBaseInstance:null}:null},e.prototype._createBaseInstanceVAO=function(e){var t=this._rctx,r=e.instance,a=e.originData;if(e.type===w.Instanced&&a.perGeometryDataInfo){var i=a.perGeometryDataInfo[r.dataId],n=i.instanceBufferData;if(n){var s=i.vao,o=n.getSlot(r.idx);if(e.instancedVAOBaseInstance!==o){var d=A.setBaseInstanceOffset(s.layout,o);e.instancedVAO=new P(t,s.locations,d,s.vertexBuffers,s.indexBuffer),e.instancedVAOBaseInstance=o}}}},e.prototype._updateHighlightVAOs=function(){for(var e=0;e<this._highlights.length;++e){var t=this._highlights[e];this._createBaseInstanceVAO(t)}},e.prototype._getFallbackDepthTexture=function(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=new D(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([255,255,255,255]))),this._fallbackDepthStencilTexture},e}(),q=function(){function e(){this.reset()}return e.prototype.reset=function(){this.trianglesRendered=0,this.drawCallsInstanced=0,this.drawCallsAngleInstanced=0,this.drawCallsMerged=0,this.drawCallsPreinterleaved=0,this.drawCallsFragmented=0,this.drawCallsHighlight=0,this.instancesDrawnAngle=0,this.VBOallocatedSize=0,this.VBOoptimalSize=0,this.VBOusedSize=0},e}(),k=function(){function e(e,t,r,a,i,n,s,o){this.name=e,this.from=t,this.to=r,this.displayedIndexRange=a,this.transformation=i,this.instanceParameters=n,this.idx=s,this.dataId=o,null!=i&&(this.transformationNormal=G.create(),G.set(i,this.transformationNormal),G.inverse(this.transformationNormal,this.transformationNormal),G.transpose(this.transformationNormal,this.transformationNormal))}return e}();!function(e){e[e.Merged=0]="Merged",e[e.Instanced=1]="Instanced",e[e.Preinterleaved=2]="Preinterleaved"}(w||(w={}));var j=L.create(),Q=G.identity(),K=G.create(),W=G.create();return z});