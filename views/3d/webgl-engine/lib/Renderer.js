// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","./IntervalUtilities","./ModelDirtyTypesTs","./Float32ArrayList","./InstanceBufferData","./Lighting","../materials/internal/SimpleGLMaterial","./LinearDepthTextureHelper","./NormalTextureHelper","./HighlightTextureHelper","./RenderPass","./RenderSlot","./RenderContext","./ExternalRendererContainer","./StencilRenderingHelper","./BitSet","./Util","./gl-matrix","./ComponentUtils","../../../webgl/Texture","../../../webgl/VertexArrayObject","../../../webgl/BufferObject","../../../webgl/Util","./FxaaRenderPass","./SmaaRenderPass","../../../webgl/enums","./DefaultVertexAttributeLocations"],function(e,t,r,a,i,n,s,o,d,l,h,f,m,p,g,u,_,c,v,x,R,y,I,b,A,C,M,T){function O(e){var t=e.instanceParameters.componentVisibilities,r=e.componentOffsets,a=x.generateVisibleIndexRanges(t,r);return a}var D=c.assert,S=c.array2object,P=c.objectEmpty,w=c.getFirstObjectValue,E=c.setMatrixTranslation3,H=v.vec2d,B=v.vec4d,L=v.mat4d,N=c.VertexAttrConstants,F=L.identity(),G=1535,V=!1,U=function(){function e(e,t,r,a,i){this._lighting=new s,this._mat2dataMerged={},this._mat2dataInstanced={},this._renderOrder=[],this._externalRenderers=new g,this._renderContext=new p,this._framesRendered=0,this._isRendering=!1,this._pixelRatio=1,this._threshold=G,this._needsRender=!0,this._stats=new z,this.ssaoEnabled=!1,this.renderOptions={antialiasing:"smaa",earlyOcclusionPixelDraw:!1},this._programRep=e,this._materialRep=t,this._textureRep=r,this._orderedRendering=i,this._rctx=a;var n=a.gl;this._fxaaPass=new A(a),this._smaaPass=new C(a),this._selectionMaterial=new o(e,B.createFrom(.1,.2,.9,.4),n.EQUAL),this._selectionMaterialLines=new o(e,B.createFrom(.1,.2,.9,.4),n.EQUAL,n.LINES),this._renderContext.lightingData=this._lighting.get(),a.setDepthTestEnabled(!0),a.setFaceCullingEnabled(!0),a.setBlendingEnabled(!1),a.setBlendFunctionSeparate(770,771,1,771),this._bindParameters={view:null,proj:null,viewInvTransp:null,nearFar:null,lightingData:null,viewport:null,framebufferTex:null,shadowMap:null,origin:null,pixelRatio:null,instanceParameters:null,depthFBO:null,normalFBO:null,extensions:{angleInstancedArrays:a.extensions.angleInstancedArrays}},this._linearDepthTextureHelper=new d(a),this._normalTextureHelper=new l(a),this._highlightTextureHelper=new h(a),this._stencilRenderingHelper=new u(a),this._initializeFramebufferTexture()}return e.prototype._initializeFramebufferTexture=function(){var e=this._rctx.gl,t=this._rctx.contextAttributes,r=t.alpha?e.RGBA:e.RGB,a=new R(this._rctx,{target:3553,pixelFormat:r,dataType:5121,samplingMode:9728,wrapMode:33071,width:4,height:4});this._framebuffer={format:r,texture:a,copied:!1}},e.prototype.dispose=function(){for(var e in this._mat2dataMerged){this._releaseMaterials(e);var t=this._mat2dataMerged[e];for(var r in t.origin2data)t.origin2data[r].vao.dispose(!0)}this._mat2dataMerged=null;for(var e in this._mat2dataInstanced){this._releaseMaterials(e);var t=this._mat2dataInstanced[e];for(var r in t.origin2data)t.origin2data[r].vao.dispose(!0)}this._mat2dataInstanced=null,this._framebuffer.texture.dispose(),this._framebuffer.texture=null,this._linearDepthTextureHelper.getEnableState()&&this._linearDepthTextureHelper.disable(),this._normalTextureHelper.getEnableState()&&this._normalTextureHelper.disable(),this._highlightTextureHelper.getEnableState()&&this._highlightTextureHelper.setEnableState(!1),this._stencilRenderingHelper.getEnableState()&&this._stencilRenderingHelper.setEnableState(!1)},e.prototype.setLightingData=function(e){this._lighting.set(e),this._needsRender=!0},e.prototype.getLightingData=function(){return this._lighting.get()},e.prototype.setPixelRatio=function(e){this._pixelRatio=e,this._needsRender=!0},e.prototype.getPixelRatio=function(){return this._pixelRatio},e.prototype.addExternalRenderer=function(e,t){return this._externalRenderers.addRenderer(e,t),!0},e.prototype.removeExternalRenderer=function(e){return this._externalRenderers.removeRenderer(e),!0},e.prototype.getExternalRenderers=function(){return this._externalRenderers},e.prototype.resetNeedsRender=function(){this._needsRender=!1,this._externalRenderers.resetNeedsRender()},e.prototype.needsRender=function(){return this._needsRender||this._externalRenderers.needsRender()},e.prototype.getCombinedStats=function(){this._stats.VBOallocatedSize=0,this._stats.VBOoptimalSize=0,this._stats.VBOusedSize=0;for(var e in this._mat2dataInstanced){var t=this._mat2dataInstanced[e];for(var r in t.origin2data){var a=t.origin2data[r];this._stats.VBOallocatedSize+=a.buffer.getArray().length,this._stats.VBOusedSize+=a.buffer.getSize(),this._stats.VBOoptimalSize+=a.optimalCount}}for(var e in this._mat2dataMerged){var t=this._mat2dataMerged[e];for(var r in t.origin2data){var a=t.origin2data[r];this._stats.VBOallocatedSize+=a.buffer.getArray().length,this._stats.VBOusedSize+=a.buffer.getSize(),this._stats.VBOoptimalSize+=a.optimalCount}}return this._stats.VBOallocatedSize*=4/1024,this._stats.VBOusedSize*=4/1024,this._stats.VBOoptimalSize*=4/1024,this._stats},e.prototype.setSelectionObject=function(e,t){e?(Array.isArray(e)?this._selectionIndices=this._name2indices(S(e)):this._selectionIndices=this._name2indices(S([e])),this._selectionFaceIndexRange=void 0,null!=t&&1===t.length&&(this._selectionFaceIndexRange=[[3*t[0][0],3*t[0][1]]])):(this._selectionIndices=void 0,this._selectionFaceIndexRange=void 0),this._needsRender=!0},e.prototype.renderGeometrySlots=function(e){this._externalRenderers.render(m.INTERNAL_MATERIAL,e),this._renderInternalSlot(m.STENCIL_MATERIAL,e),this._externalRenderers.render(m.OPAQUE_TERRAIN,e),this._renderInternalSlot(m.OPAQUE_MATERIAL,e),this._externalRenderers.render(m.OPAQUE_EXTERNAL,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep),this._renderInternalSlot(m.TRANSPARENT_MATERIAL,e),this.renderOptions.earlyOcclusionPixelDraw&&this._renderInternalSlot(m.OCCLUSION_PIXELS,this._renderContext),this._externalRenderers.render(m.TRANSPARENT_EXTERNAL,e),e.ssaoHelper&&e.ssaoHelper.bindAll(this._programRep),this._externalRenderers.render(m.TRANSPARENT_TERRAIN,e)},e.prototype._renderHighlights=function(e,t,r,a){var i=!!a&&a.getEnableState(),n=i&&void 0!==this._selectionIndices;if(this._highlightTextureHelper.setEnableState(n),n){this._highlightTextureHelper.setupFBOs(e),this._highlightTextureHelper.prepareHighlightPass(),this.renderGeometryPass(f.MATERIAL_HIGHLIGHT,e,t,this._selectionIndices,this._selectionFaceIndexRange);var s=this._rctx.gl;this._rctx.clear(s.DEPTH_BUFFER_BIT),this._renderInternalSlot(m.OVERLAY,this._renderContext),this._highlightTextureHelper.finish(r);var o=this._highlightTextureHelper.getHighlightFBO();a.render(e,r,o)}},e.prototype._renderUnordered=function(e,t,r,a,i,n,s){var o=this._rctx;switch(this._isRendering=!0,this._stats.reset(),this._framebuffer.copied=!1,this._updateGlobalUniforms(e.projectionMatrix),this._renderContext.pass=f.MATERIAL,this._renderContext.camera=e,this._renderContext.shadowMap=r,this._renderContext.ssaoHelper=a,this._renderContext.offscreenRenderingHelper=n,this._renderContext.stencilRenderingHelper=this._stencilRenderingHelper,this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO(),this._renderContext.normals=this._normalTextureHelper.getNormalFBO(),this._renderContext.highlight=this._highlightTextureHelper.getHighlightFBO(),this._renderContext.visibleContent=t,this._renderContext.filterContent=null,this._renderContext.filterFaceRange=null,this._renderContext.options=this.renderOptions,this._renderContext.rctx=this._rctx,n.setEnableState(!0),n.initializeFrame(e),this._externalRenderers.render(m.BACKGROUND,this._renderContext),this.renderGeometrySlots(this._renderContext),this._externalRenderers.render(m.POSTPROCESSING_ATMOSPHERE,this._renderContext),this.renderOptions.antialiasing){case"none":var d=e.viewport,l=L.ortho(d[0],d[2],d[1],d[3],-1,1);n.drawQuad(l),this._fxaaPass.disable(),this._smaaPass.disable();break;case"fxaa":this._smaaPass.disable(),this._fxaaPass.render({colorTexture:n.getColorTexture()},null);break;case"smaa":this._fxaaPass.disable(),this._smaaPass.render({colorTexture:n.getColorTexture()},null)}if(this.renderOptions.earlyOcclusionPixelDraw||(n.bindFramebuffer(),this._renderInternalSlot(m.OCCLUSION_PIXELS,this._renderContext)),o.bindFramebuffer(null),this._renderContext.framebufferTex=n.getColorTexture(),this._renderInternalSlot(m.OVERLAY,this._renderContext),this._renderHighlights(e,t,i,s),V){var h=this._stats;window.FPSCounterDebugString="dc: "+(h.drawCallsInstanced+h.drawCallsMerged)+" instanced: "+h.drawCallsInstanced+" merged: (dc: "+(h.drawCallsInstanced+h.drawCallsMerged)+" instanced: "+h.drawCallsInstanced+" merged: "+h.drawCallsMerged+")"}this._framesRendered++,this._isRendering=!1},e.prototype._renderOrdered=function(e,t){this._isRendering=!0,this._stats.reset(),this._framebuffer.copied=!1,this._updateGlobalUniforms(e.projectionMatrix),this._bindParameters.view=e.viewMatrix,this._bindParameters.proj=e.projectionMatrix,this._bindParameters.viewInvTransp=e.viewInverseTransposeMatrix,j[0]=e.near,j[1]=e.far,this._bindParameters.nearFar=j,this._bindParameters.lightingData=this._lighting.get(),this._bindParameters.viewport=e.fullViewport,this._bindParameters.framebufferTex=this._framebuffer.texture,this._bindParameters.pixelRatio=this._pixelRatio,this._bindParameters.instanceParameters=void 0,this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO(),this._bindParameters.normalFBO=this._normalTextureHelper.getNormalFBO();for(var r=null,a=0;a<this._renderOrder.length;a++){var i=this._renderOrder[a][1];if(i.instanced){var n=i.instanced,s=n[f.MATERIAL];!s||s.isVisible&&!s.isVisible()||(this._renderInternalInstanced(n,s,this._bindParameters,1/0,t,null,null,!1),r=null)}if(i.merged){var n=i.merged,s=n[f.MATERIAL];if(s&&(!s.isVisible||s.isVisible())){var o=s.getProgram();o!==r&&(o.setUniformMatrix4fv("model",F),o.hasUniform("modelNormal")&&o.setUniformMatrix4fv("modelNormal",F)),r=o,this._renderInternalMerged(n,s,this._bindParameters,1/0)}}}this._framesRendered++,this._isRendering=!1},e.prototype.render=function(e,t,r,a,i,n,s){this._orderedRendering?this._renderOrdered(e,t):this._renderUnordered(e,t,r,a,i,s,n)},e.prototype.renderAuxiliaryBuffers=function(e,t,r,a,i,n){var s=this.ssaoEnabled;this._linearDepthTextureHelper.setEnableState(s),s&&(this._linearDepthTextureHelper.setupFBOs(e),this._linearDepthTextureHelper.prepareDepthPass(),this.renderGeometryPass(f.MATERIAL_DEPTH,e,t,void 0,void 0,r,a),this._linearDepthTextureHelper.finish(i)),this._normalTextureHelper.setEnableState(this.ssaoEnabled),this.ssaoEnabled&&(this._normalTextureHelper.setupFBOs(e),this._normalTextureHelper.prepareNormalPass(),this.renderGeometryPass(f.MATERIAL_NORMAL,e,t,void 0,void 0,r,a),this._normalTextureHelper.finish(i)),this.ssaoEnabled&&a.computeSSAO(e,i,this._linearDepthTextureHelper.getDepthFBO(),this._normalTextureHelper.getNormalFBO()),a.bindAll(this._programRep)},e.prototype.renderGeometryPass=function(e,t,r,a,i,n,s){this._isRendering=!0,this._updateGlobalUniforms(t.projectionMatrix),this._renderContext.pass=e,this._renderContext.camera=t,this._renderContext.shadowMap=n,this._renderContext.ssaoHelper=s,this._renderContext.depth=this._linearDepthTextureHelper.getDepthFBO(),this._renderContext.normals=this._normalTextureHelper.getNormalFBO(),this._renderContext.visibleContent=r,this._renderContext.filterContent=a,this._renderContext.filterFaceRange=i,this._renderContext.rctx=this._rctx,this.renderGeometrySlots(this._renderContext),this._isRendering=!1},e.prototype.renderSelection=function(e){this._isRendering=!0;for(var t=0;t<m.MAX_SLOTS;++t)this._renderInternalSlot(t,e);this._isRendering=!1},e.prototype._renderInternalSlot=function(e,t){this._bindParameters.view=t.camera.viewMatrix,this._bindParameters.proj=t.camera.projectionMatrix,this._bindParameters.viewInvTransp=t.camera.viewInverseTransposeMatrix,this._bindParameters.cameraAboveGround=t.camera.aboveGround,j[0]=t.camera.near,j[1]=t.camera.far,this._bindParameters.nearFar=j,this._bindParameters.lightingData=this._lighting.get(),this._bindParameters.viewport=t.camera.fullViewport,this._bindParameters.framebufferTex=this._renderContext.offscreenRenderingHelper?this._renderContext.offscreenRenderingHelper.getColorTexture():this._framebuffer.texture,this._bindParameters.shadowMap=t.shadowMap,this._bindParameters.pixelRatio=this._pixelRatio,this._bindParameters.instanceParameters=void 0,this._bindParameters.depthFBO=this._linearDepthTextureHelper.getDepthFBO();for(var r in this._mat2dataInstanced){var a=this._mat2dataInstanced[r],i=a[t.pass];i&&i.beginSlot(e)&&(!i.isVisible||i.isVisible())&&this._renderInternalInstanced(a,i,this._bindParameters,e,t.visibleContent,t.filterContent,t.filterFaceRange,!1)}if(t.filterContent)for(var r in this._mat2dataMerged){var a=this._mat2dataMerged[r],i=a[t.pass];i&&i.beginSlot(e)&&(!i.isVisible||i.isVisible())&&this._renderInternalInstanced(a,i,this._bindParameters,e,null,t.filterContent,t.filterFaceRange,!0)}else{for(var n=this._programRep.getProgramsUsingUniform("model"),s=this._programRep.getProgramsUsingUniform("modelNormal"),o=0;o<n.length;o++){var d=n[o];d.setUniformMatrix4fv("model",F),s.indexOf(d)>-1&&d.setUniformMatrix4fv("modelNormal",F)}for(var r in this._mat2dataMerged){var a=this._mat2dataMerged[r],i=a[t.pass];i&&i.beginSlot(e)&&(!i.isVisible||i.isVisible())&&this._renderInternalMerged(a,i,this._bindParameters,e)}}this._stencilRenderingHelper.getEnableState()&&e===m.STENCIL_MATERIAL&&this._stencilRenderingHelper.prepareStencilDisabledPass()},e.prototype._renderInternalInstanced=function(e,t,r,a,i,n,s,o){var d=this._rctx,l=d.gl,h=!1,f=t.getDrawMode(d),p=this._bindParameters.extensions.angleInstancedArrays;for(var g in e.origin2data){var u=e.origin2data[g];r.origin=u.origin,a===m.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass());var _=!1;if(t.instanced)for(var c in u.perGeometryDataInfo){var v=u.perGeometryDataInfo[c];h||(t.bind(d,r),h=!0),d.bindVAO(v.vao);var x=t.getProgram();b.assertCompatibleVertexAttributeLocations(v.vao,x),_||(t.bindView(d,r),_=!0);var R=v.to-v.from,y=v.refCount;f===l.TRIANGLES&&(this._stats.trianglesRendered+=y*R/3),p.drawArraysInstancedANGLE(f,v.from,R,y),this._stats.drawCallsAngleInstanced++,this._stats.instancesDrawnAngle+=y}else{var I=u.instances;for(var A in I){var C=I[A],M=C.idx,T=C.displayedIndexRange;s&&(T=s),T&&0===T.length||i&&!i.get(M)||n&&!n.get(M)||(h||(t.bind(d,r),h=!0),_||(d.bindVAO(u.vao),t.bindView(d,r),_=!0),o||t.bindInstance(d,C),this._stats.drawCallsInstanced++,f===l.TRIANGLES&&(this._stats.trianglesRendered+=(C.to-C.from)/3),T?this._drawArraysFaceRange(T,C.from,f):d.drawArrays(f,C.from,C.to-C.from))}}}d.bindVAO(null),h&&t.release(d,r)},e.prototype._drawArraysFaceRange=function(e,t,r){for(var a=this._rctx,i=0;i<e.length;i++){var n=e[i];a.drawArrays(r,n[0]+t,n[1]-n[0]+1)}this._stats.drawCallsFragmented+=e.length-1},e.prototype._renderInternalMerged=function(e,t,r,a){var i=this._rctx,n=i.gl,s=!1;for(var o in e.origin2data){var d=e.origin2data[o];if(r.origin=d.origin,a===m.STENCIL_MATERIAL&&(this._stencilRenderingHelper.setEnableState(!0),this._stencilRenderingHelper.prepareStencilWritePass()),!d.displayedIndexRange||0!==d.displayedIndexRange.length){s||(t.bind(i,r),s=!0);var l=t.getProgram();i.bindVAO(d.vao),b.assertCompatibleVertexAttributeLocations(d.vao,l),t.bindView(i,r),this._stats.drawCallsMerged++;var h=t.getDrawMode(i);h===n.TRIANGLES&&(this._stats.trianglesRendered+=d.vao.vertexBuffers.geometry.size/3),d.displayedIndexRange?this._drawArraysFaceRange(d.displayedIndexRange,0,h):i.drawArrays(h,0,b.vertexCount(d.vao,"geometry"))}}s&&t.release(i,r)},e.prototype._updateGlobalUniforms=function(e){for(var t=this._programRep.getProgramsUsingUniform("proj"),r=0;r<t.length;r++)t[r].setUniformMatrix4fv("proj",e);if(this._lighting){t=this._programRep.getProgramsUsingUniform("lightDirection");for(var r=0;r<t.length;r++)this._lighting.setUniforms(t[r])}},e.prototype.print=function(){var e=Object.keys(this._mat2dataMerged).length,t=Object.keys(this._mat2dataInstanced).length;console.log("number of materials (merged/instanced): "+e+"/"+t);var r=0;for(var a in this._mat2dataMerged){var i=this._mat2dataMerged[a];for(var n in i.origin2data)r+=Object.keys(i.origin2data[n].instances).length}var s=0;for(var a in this._mat2dataInstanced){var i=this._mat2dataInstanced[a];for(var n in i.origin2data)s+=Object.keys(i.origin2data[n].instances).length}console.log("number of instances (merged/instanced): "+r+"/"+s)},e.prototype.isEmpty=function(){for(var e in this._mat2dataInstanced){var t=this._mat2dataInstanced[e];for(var r in t.origin2data)if(!P(t.origin2data[r].instances))return!1}for(var e in this._mat2dataMerged){var t=this._mat2dataMerged[e];for(var r in t.origin2data)if(!P(t.origin2data[r].instances))return!1}return!0},e.prototype.modify=function(e,t,r,a){this._isRendering&&console.warn("Renderer.modify called while rendering");var i=[],n=[];this._mergedOrInstanced(e,i,n);var s=[],o=[];this._mergedOrInstanced(t,s,o);var d={};r&&this._performUpdates(r,d);var l=[];this._modifyMerged(i,s,l,d),this._modifyInstanced(n,o,l),this._updateMergedFaceranges(d),this._releaseMaterials(l),this._modifyMaterials(a),this._needsRender=!0},e.prototype._isInstanced=function(e){var t=!1,r=w(e.data.faces.indices).length;return t=t||e.material.canBeMerged===!1,t=t||e.material.instanced,t=t||e.material.isBackdrop,e.singleUse?t:t=t||r>this._threshold},e.prototype._mergedOrInstanced=function(e,t,r){for(var a=0;a<e.length;++a){var i=w(e[a].data.faces.indices).length;if(!(1>i)){var n=this._isInstanced(e[a]);n?r.push(e[a]):t.push(e[a])}}},e.prototype._performUpdates=function(e,t){for(var r=0;r<e.length;r++){var a=e[r],i=a.renderGeometry,n=this._isInstanced(i),s=a.updateType;2&s&&this._updateFaceranges(i,n,t),4&s||!n&&16&s?this._updateVertexAttributes(i,n):n&&16&s?this._updateInstanceTransformation(i,n):8&s&&this._updateColorAttributes(i)}},e.prototype._updateFaceranges=function(e,t,r){var a=e.material,i=a.getId(),n=e.origin.id,s=t?this._mat2dataInstanced:this._mat2dataMerged,o=s[i],d=o.origin2data[n],l=d.instances[e.uniqueName];l&&(l.displayedIndexRange=O(e),t||(r[this._modifiedMergedFacerangesKey(i,n)]=d))},e.prototype._updateMergedFaceranges=function(e){for(var t in e){var a=e[t];a.displayedIndexRange=[];var i=a.instances,n=!0;for(var s in i){var o=i[s];o.displayedIndexRange?(a.displayedIndexRange.push.apply(a.displayedIndexRange,r.offsetIntervals(o.displayedIndexRange,o.from)),n=!1):a.displayedIndexRange.push([o.from,o.to-1])}n?a.displayedIndexRange=null:a.displayedIndexRange=r.mergeIntervals(a.displayedIndexRange)}},e.prototype._updateVertexAttributes=function(e,t){var r,a,i=e.material,n=i.getId(),s=e.origin.id,o=t?this._mat2dataInstanced:this._mat2dataMerged,d=o[n],l=d.origin2data[s],h=l.instances[e.uniqueName];if(!t){var f=e.origin.vec3;E(k,-f[0],-f[1],-f[2]),L.multiply(k,e.transformation,Q),L.inverse(Q,X),L.transpose(X),r=Q,a=X}var m=b.getStride(i.getVertexBufferLayout()),p=m/4;D(h.from+i.getOutputAmount(w(e.data.faces.indices).length)/p===h.to,"material VBO layout has changed"),i.fillInterleaved(e.data,r,a,e.instanceParameters,l.buffer.getArray(),h.from*p),l.vao.vertexBuffers.geometry.setSubData(l.buffer.getArray(),h.from*m,h.from*m,h.to*m)},e.prototype._updateInstanceTransformation=function(e,t){var r=e.origin.vec3,a=t?this._mat2dataInstanced:this._mat2dataMerged,i=a[e.material.getId()],n=i.origin2data[e.origin.id],s=n.instances[e.uniqueName];E(k,-r[0],-r[1],-r[2]),L.multiply(k,e.transformation,s.transformation),L.inverse(s.transformation,s.transformationNormal),L.transpose(s.transformationNormal,s.transformationNormal);var o=n.perGeometryDataInfo[e.data.id],d=o.instanceBufferData;if(d){var l=d.getSlot(e.idx);d.fill(l,0,s.transformation),d.fill(l,16,s.transformationNormal);var h=d.getOffset(l),f=4*h,m=b.getStride(o.vao.layout.instance);o.vao.vertexBuffers.instance.setSubData(d.getArray(),f,f,f+m)}},e.prototype._updateColorAttributes=function(e){var t=e.material,r=t.getId(),a=e.origin.id,i=this._isInstanced(e),n=i?this._mat2dataInstanced:this._mat2dataMerged,s=n[r],o=s.origin2data[a],d=o.instances[e.uniqueName],l={};l[N.COLOR]=!0;var h=b.getStride(t.getVertexBufferLayout())/4;D(d.from+t.getOutputAmount(w(e.data.faces.indices).length)/h===d.to,"material VBO layout has changed"),t.fillInterleaved(e.data,void 0,void 0,e.instanceParameters,o.buffer.getArray(),d.from*h,l),o.vao.vertexBuffers.geometry.setSubData(o.buffer.getArray(),d.from*h*4,d.from*h*4,d.to*h*4)},e.prototype._modifyMerged=function(e,t,r,a){var n=this._rctx,s=this._compMat2delta(e,t,!1);for(var o in s){var d=s[o];for(var l in d){var h=d[l],m=h.optimalCount,p=h.material,g=p.getVertexBufferLayout(),u=b.getStride(g)/4,_=this._mat2dataMerged[o];if(null==_){D(m>0);var c=p.getRenderPriority();_={origin2data:{}},_[f.MATERIAL]=this._materialRep.aquire(p),_[f.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(p),_[f.MATERIAL_NORMAL]=this._materialRep.aquireNormal(p),_[f.MATERIAL_DEPTH]=this._materialRep.aquireDepth(p),_[f.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(p),this._mat2dataMerged[o]=_,this._orderedRendering&&this._insertIntoRenderOrder(_,c,"merged")}var v=_.origin2data[l];if(null==v&&(D(m>0),v={instances:{},vao:new y(n,T.Default3D,{geometry:g},{geometry:I.createVertex(n,35044)}),buffer:new i(m),optimalCount:0,origin:h.origin},_.origin2data[l]=v),m>0){var x=v.buffer.getSize(),R=v.buffer.getArray(),A=m<h.sparseCount/2,C=v.buffer.resize(A?m:h.sparseCount),M=h.toRemove;if(A||C){x=0;for(var S=v.buffer.getArray(),P=!1,H=0;H<M.length;++H){var B=v.instances[M[H].uniqueName];v.optimalCount-=(B.to-B.from)*u,delete v.instances[M[H].uniqueName]}var N={};for(var F in v.instances){var B=v.instances[F];D(null==N[B.from]),N[B.from]=B}for(var G in N){var B=N[G],V=B.from*u,U=B.to*u;S.set(R.subarray(V,U),x),B.from=x/u,x+=U-V,B.to=x/u,B.displayedIndexRange&&(P=!0)}D(x===v.optimalCount)}else for(var H=0;H<M.length;++H){var z=M[H].uniqueName;D(void 0!==v.instances[z]);var V=v.instances[z].from*u,U=v.instances[z].to*u;v.buffer.erase(V,U),delete v.instances[z],v.optimalCount-=U-V}E(k,-h.origin[0],-h.origin[1],-h.origin[2]);for(var j=h.toAdd,K=!1,H=0;H<j.length;++H){var W=j[H],Y=W.data;L.multiply(k,W.transformation,Q),L.inverse(Q,X),L.transpose(X);var J=x;p.fillInterleaved(Y,Q,X,W.instanceParameters,v.buffer.getArray(),x);var Z=p.getOutputAmount(w(Y.faces.indices).length),$=J+Z;D(null==v.instances[W.uniqueName]);var ee=O(W),B=new q(W.name,J/u,$/u,ee,void 0,void 0,W.idx);ee&&(K=!0),v.instances[W.uniqueName]=B,v.optimalCount+=Z,x+=Z}D(v.optimalCount===m);var te=new Float32Array(v.buffer.getArray().buffer,0,v.buffer.getSize());v.vao.vertexBuffers.geometry.setData(te),(K||v.displayedIndexRange)&&(a[this._modifiedMergedFacerangesKey(o,l)]=v)}else D(0===m),v.vao.dispose(!0),v.vao=null,delete _.origin2data[l],0===Object.keys(_.origin2data).length&&(r.push(o),delete this._mat2dataMerged[o],this._orderedRendering&&this._removeFromRenderOrder(_,"merged"))}}},e.prototype._modifyInstanced=function(e,t,r){var a=this._compMat2delta(e,t,!0),s=this._rctx;for(var o in a){var d=a[o];for(var l in d){var h=d[l];if(0!==h.optimalCount){var m=h.material,p=this._mat2dataInstanced[o];if(null==p){var g=m.getRenderPriority();p={origin2data:{}},p[f.MATERIAL]=this._materialRep.aquire(m),p[f.MATERIAL_DEPTH_SHADOWMAP]=this._materialRep.aquireDepthShadowMap(m),p[f.MATERIAL_NORMAL]=this._materialRep.aquireNormal(m),p[f.MATERIAL_DEPTH]=this._materialRep.aquireDepth(m),p[f.MATERIAL_HIGHLIGHT]=this._materialRep.aquireHighlight(m),this._mat2dataInstanced[o]=p,this._orderedRendering&&this._insertIntoRenderOrder(p,g,"instanced")}var u=m.getVertexBufferLayout(),_=p[f.MATERIAL].instanced?m.getInstanceBufferLayout():void 0,c=_&&b.findAttribute(_,"instanceColor"),v=_&&b.findAttribute(_,"instanceFeatureAttribute"),x=b.getStride(u)/4,R=p.origin2data[l];null==R&&(R={instances:{},vao:new y(s,T.Default3D,{geometry:u},{geometry:I.createVertex(s,35044)}),buffer:new i(h.optimalCount),optimalCount:0,perGeometryDataInfo:{},origin:h.origin},p.origin2data[l]=R);var A=R.buffer.getSize(),C=R.buffer.getArray(),M=h.optimalCount<h.sparseCount/2,S=R.buffer.resize(M?h.optimalCount:h.sparseCount);for(var P in h.perGeometryDelta){var H=R.perGeometryDataInfo[P];if(H&&H.instanceBufferData){var B=h.perGeometryDelta[P].removeCount;B>0&&H.instanceBufferData.prepareFree(B)}}var N=h.toRemove;if(M||S){for(var F=0;F<N.length;++F){var G=N[F];delete R.instances[G.uniqueName];var P=G.data.id,H=R.perGeometryDataInfo[P],V=H;0===--V.refCount&&null==h.dataId2refCount[P]?(R.optimalCount-=(V.to-V.from)*x,delete R.perGeometryDataInfo[P]):H.instanceBufferData&&H.instanceBufferData.free(G.idx)}A=0;var U=R.buffer.getArray(),z={};for(var j in R.perGeometryDataInfo){var V=R.perGeometryDataInfo[j];D(null==z[V.from]),z[V.from]=V}for(var Q in z){var V=z[Q],X=V.from*x,K=V.to*x;U.set(C.subarray(X,K),A),V.from=A/x,A+=K-X,V.to=A/x}for(var W in R.instances){var Y=R.instances[W];Y.from=R.perGeometryDataInfo[Y.dataId].from,Y.to=R.perGeometryDataInfo[Y.dataId].to}}else for(var F=0;F<N.length;++F){var G=N[F];delete R.instances[G.uniqueName];var P=G.data.id,H=R.perGeometryDataInfo[P];if(0===--H.refCount&&null==h.dataId2refCount[P]){var X=H.from*x,K=H.to*x;R.buffer.erase(X,K),R.optimalCount-=K-X,delete R.perGeometryDataInfo[P]}else H.instanceBufferData&&H.instanceBufferData.free(G.idx)}E(k,-h.origin[0],-h.origin[1],-h.origin[2]);for(var P in h.perGeometryDelta){var H=R.perGeometryDataInfo[P];if(H&&H.instanceBufferData){var J=h.perGeometryDelta[P].addCount;J>0&&H.instanceBufferData.prepareAllocate(J)}}for(var Z=h.toAdd,F=0;F<Z.length;++F){var G=Z[F],$=G.data,P=$.id,H=R.perGeometryDataInfo[P];if(null==H){m.fillInterleaved($,void 0,void 0,void 0,R.buffer.getArray(),A);var ee=m.getOutputAmount(w($.faces.indices).length),X=A/x;A+=ee;var K=A/x;if(R.optimalCount+=ee,H={refCount:1,from:X,to:K,vao:null,instanceBufferData:null},_){var te=b.getStride(_)/4;H.vao=new y(s,T.Default3D,{geometry:u,instance:_},{geometry:R.vao.vertexBuffers.geometry,instance:I.createVertex(s,35044)}),H.instanceBufferData=new n(te,h.perGeometryDelta[P].addCount)}R.perGeometryDataInfo[P]=H}else++H.refCount;D(H.from*x<=R.buffer.getSize()&&H.to*x<=R.buffer.getSize());var re=L.create();L.multiply(k,G.transformation,re);var ae=O(G),Y=new q(G.name,H.from,H.to,ae,re,G.instanceParameters,G.idx,P),ie=H.instanceBufferData;if(ie){var ne=ie.allocate(G.idx);ie.fill(ne,0,Y.transformation),ie.fill(ne,16,Y.transformationNormal),c&&ie.fill(ne,c.offset/4,G.instanceParameters.color),v&&ie.fill(ne,v.offset/4,G.instanceParameters.featureAttribute)}R.instances[G.uniqueName]=Y}D(R.optimalCount===h.optimalCount);var se=new Float32Array(R.buffer.getArray().buffer,0,R.buffer.getSize());R.vao.vertexBuffers.geometry.setData(se);for(var P in R.perGeometryDataInfo){var oe=R.perGeometryDataInfo[P];if(oe.vao){var de=oe.vao.vertexBuffers.instance;if(de){var le=h.perGeometryDelta[P];if(le.addCount+le.removeCount>0){var he=oe.instanceBufferData.compact();de.setData(he)}}}}}else{var fe=this._mat2dataInstanced[o];fe.origin2data[l].vao.dispose(!0),delete fe.origin2data[l],0===Object.keys(fe.origin2data).length&&(r.push(o),delete this._mat2dataInstanced[o],this._orderedRendering&&this._removeFromRenderOrder(fe,"instanced"))}}}},e.prototype._compMat2delta=function(e,t,r){var a={};return this._updateMat2delta(e,!0,r,a),this._updateMat2delta(t,!1,r,a),a},e.prototype._updateMat2delta=function(e,t,r,a){for(var i=0;i<e.length;++i){var n=e[i],s=n.origin,o=n.material,d=o.getId(),l=r?this._mat2dataInstanced[d]:this._mat2dataMerged[d],h=l&&l.origin2data[s.id],f=a[d];null==f&&(f={},a[d]=f);var m=f[s.id];if(null==m){if(m={optimalCount:null==h?0:h.optimalCount,sparseCount:null==h?0:h.buffer.getSize(),material:o,toAdd:[],toRemove:[],perGeometryDelta:null,origin:s.vec3},r){var p={};if(void 0!==h)for(var g in h.perGeometryDataInfo)p[g]=h.perGeometryDataInfo[g].refCount;m.dataId2refCount=p,m.perGeometryDelta={}}f[s.id]=m}var u=o.getOutputAmount(w(n.data.faces.indices).length);if(r){var _=n.data.id,c=m.perGeometryDelta[_];c||(c={addCount:0,removeCount:0},m.perGeometryDelta[_]=c),t?(c.addCount++,null==m.dataId2refCount[_]&&(m.dataId2refCount[_]=0),1===++m.dataId2refCount[_]&&(m.optimalCount+=u,m.sparseCount+=u),m.toAdd.push(n)):(c.removeCount++,0===--m.dataId2refCount[_]&&(delete m.dataId2refCount[_],m.optimalCount-=u),m.toRemove.push(n))}else t?(m.optimalCount+=u,m.sparseCount+=u,m.toAdd.push(n)):(m.optimalCount-=u,m.toRemove.push(n))}},e.prototype._modifiedMergedFacerangesKey=function(e,t){return e+"_"+t},e.prototype._insertIntoRenderOrder=function(e,t,r){for(var a=e[f.MATERIAL].getMaterialId(),i=this._renderOrder.length,n=0;i>n&&this._renderOrder[n][0]>=t;){var s=this._renderOrder[n][1];if(s.id===a)return D(!s[r],"matData for type already exists"),void(s[r]=e);n++}var o={id:a,instanced:null,merged:null};o[r]=e,this._renderOrder.splice(n,0,[t,o])},e.prototype._removeFromRenderOrder=function(e,t){for(var r=e[f.MATERIAL].getMaterialId(),a=0;this._renderOrder[a][1].id!==r;)a++;var i=this._renderOrder[a][1];i[t]=null,i.instanced||i.merged||this._renderOrder.splice(a,1)},e.prototype._updateRenderOrder=function(e,t){for(var r=t.length,a=0;r>a&&t[a][1].id!==e;)a++;if(r>a){var i=t[a][1],n=i.merged||i.instanced,s=n[f.MATERIAL].getRenderPriority(),o=t[a][0];if(s!==t[a][0]){t[a][0]=s;var d=s>o?-1:1;for(a+=d;a>-1&&r>a&&d*t[a][0]>d*s;){var l=t[a];t[a]=t[a-d],t[a-d]=l,a+=d}}}},e.prototype._modifyMaterials=function(e){for(var t in e)this._materialRep.updateMaterialParameters(t)},e.prototype.modifyRenderOrder=function(e){if(this._orderedRendering){for(var t in e)this._updateRenderOrder(t,this._renderOrder);this._needsRender=!0}},e.prototype._releaseMaterials=function(e){if(Array.isArray(e))for(var t=e,r=0;r<t.length;r++)this._materialRep.release(t[r]),this._materialRep.releaseDepthShadowMap(t[r]),this._materialRep.releaseNormal(t[r]),this._materialRep.releaseDepth(t[r]),this._materialRep.releaseHighlight(t[r]);else this._materialRep.release(e),this._materialRep.releaseDepthShadowMap(e),this._materialRep.releaseNormal(e),this._materialRep.releaseDepth(e),this._materialRep.releaseHighlight(e)},e.prototype._name2indices=function(e){for(var t=new _,r=0;2>r;++r){var a=0===r?this._mat2dataMerged:this._mat2dataInstanced;for(var i in a){var n=a[i].origin2data;for(var s in n){var o=n[s].instances;for(var d in o){var l=o[d];void 0!==e[l.name]&&t.set(l.idx)}}}}return t},e}(),z=function(){function e(){this.reset()}return e.prototype.reset=function(){this.trianglesRendered=0,this.drawCallsInstanced=0,this.drawCallsAngleInstanced=0,this.drawCallsMerged=0,this.drawCallsFragmented=0,this.instancesDrawnAngle=0,this.VBOallocatedSize=0,this.VBOoptimalSize=0,this.VBOusedSize=0},e}(),q=function(){function e(e,t,r,a,i,n,s,o){this.name=e,this.from=t,this.to=r,this.displayedIndexRange=a,this.transformation=i,this.instanceParameters=n,this.idx=s,this.dataId=o,null!=i&&(this.transformationNormal=L.create(),L.set(i,this.transformationNormal),L.inverse(this.transformationNormal,this.transformationNormal),L.transpose(this.transformationNormal,this.transformationNormal))}return e}(),j=H.create(),k=L.identity(),Q=L.create(),X=L.create();return U});