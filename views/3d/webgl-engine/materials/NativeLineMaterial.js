// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/Logger","../lib/ComponentUtils","../lib/DefaultVertexBufferLayouts","../lib/gl-matrix","../lib/GLMaterial","../lib/Material","../lib/RenderSlot","../lib/Util","./internal/MaterialUtil","../../../webgl/Util"],function(e,t,r,n,o,a,i,c,s,p,l,d,u){var v=l.VertexAttrConstants,f=a.Pos3,g=u.getStride(f)/4,m={color:[1,1,1,1]},h=n.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial"),y=function(e){function t(t,r){var n=e.call(this,r)||this;return n.params=d.copyParameters(t,m),n.canBeMerged=!0,n}return r(t,e),t.prototype.setColor=function(e){this.params.color=e,this.notifyDirty("matChanged")},t.prototype.getColor=function(){return this.params.color},t.prototype.getParameterValues=function(){return{color:this.params.color}},t.prototype.getOutputAmount=function(e){return e*g},t.prototype.getInstanceBufferLayout=function(){},t.prototype.getVertexBufferLayout=function(){return f},t.prototype.fillInterleaved=function(e,t,r,n,o,a,i){var c=e.vertexAttr[v.POSITION].data;if(t){var s=c;c=T;for(var p=0;p<s.length;p+=3){var l=s[p],d=s[p+1],u=s[p+2];c[p]=t[0]*l+t[4]*d+t[8]*u+t[12],c[p+1]=t[1]*l+t[5]*d+t[9]*u+t[13],c[p+2]=t[2]*l+t[6]*d+t[10]*u+t[14]}}for(var f=e.indices[v.POSITION],g=a,p=0;p<f.length;p++){var m=3*f[p];o[g++]=c[m],o[g++]=c[m+1],o[g++]=c[m+2]}},t.prototype.intersect=function(e,t,r,n,a,c,s,p){if(n.isSelection&&!o.isAllHidden(t.componentVisibilities,e.data.componentOffsets)){if(!l.isTranslationMatrix(r))return void h.error("intersection assumes a translation-only matrix");var d=e.getData().getVertexAttr().position.data,u=n.camera,v=n.point;i.vec3d.set3(v[0]-2,v[1]+2,0,V[0]),i.vec3d.set3(v[0]+2,v[1]+2,0,V[1]),i.vec3d.set3(v[0]+2,v[1]-2,0,V[2]),i.vec3d.set3(v[0]-2,v[1]-2,0,V[3]);for(var f=0;f<4;f++)u.unprojectPoint(V[f],w[f]);l.point2plane(u.eye,w[0],w[1],N),l.point2plane(u.eye,w[1],w[2],O),l.point2plane(u.eye,w[2],w[3],_),l.point2plane(u.eye,w[3],w[0],C);for(var g=Number.MAX_VALUE,f=0;f<d.length-5;f+=3)if(A[0]=d[f]+r[12],A[1]=d[f+1]+r[13],A[2]=d[f+2]+r[14],S[0]=d[f+3]+r[12],S[1]=d[f+4]+r[13],S[2]=d[f+5]+r[14],!(l.planeDistance(A,N)<0&&l.planeDistance(S,N)<0||l.planeDistance(A,O)<0&&l.planeDistance(S,O)<0||l.planeDistance(A,_)<0&&l.planeDistance(S,_)<0||l.planeDistance(A,C)<0&&l.planeDistance(S,C)<0)){if(u.projectPoint(A,M),u.projectPoint(S,E),M[2]<0&&E[2]>0){i.vec3d.subtract(A,S,D);var m=u.frustumPlanes,y=-(i.vec3d.dot(m[4],A)+m[4][3]),b=y/i.vec3d.dot(D,m[4]);i.vec3d.scale(D,b,D),i.vec3d.add(A,D,A),u.projectPoint(A,M)}else if(M[2]>0&&E[2]<0){i.vec3d.subtract(S,A,D);var m=u.frustumPlanes,y=-(i.vec3d.dot(m[4],S)+m[4][3]),b=y/i.vec3d.dot(D,m[4]);i.vec3d.scale(D,b,D),i.vec3d.add(S,D,S),u.projectPoint(S,E)}else if(M[2]<0&&E[2]<0)continue;var P=l.pointLineSegmentDistanceSquared2D(M,E,v);P<g&&(g=P,i.vec3d.set(A,I),i.vec3d.set(S,x))}var T=n.p0,B=n.p1;if(g<4){var R=l.lineLineDistanceSquared3D(I,x,T,B,U),j=Number.MAX_VALUE;if(R.success){i.vec3d.subtract(R.pa,T,L);var H=i.vec3d.length(L);i.vec3d.scale(L,1/H),j=H/i.vec3d.dist(T,B)}s(j,L)}}},t.prototype.getGLMaterials=function(){return{color:b,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:P}},t.prototype.getAllTextureIds=function(){return[]},t}(s),b=function(e){function t(t,r,n){var o=e.call(this,t,r)||this;return o.program=r.get("simple"),o.updateParameters(),o}return r(t,e),t.prototype.updateParameters=function(){this.params=this.material.getParameterValues()},t.prototype.beginSlot=function(e){return e===p.OPAQUE_MATERIAL},t.prototype.getProgram=function(){return this.program},t.prototype.bind=function(e,t){var r=this.program,n=this.params;e.bindProgram(r),r.setUniform4fv("color",n.color),e.setBlendingEnabled(n.color[3]<1),e.setBlendFunctionSeparate(e.gl.SRC_ALPHA,e.gl.ONE_MINUS_SRC_ALPHA,e.gl.ONE,e.gl.ONE_MINUS_SRC_ALPHA),e.setDepthTestEnabled(!0)},t.prototype.release=function(e){this.params.color[3]<1&&e.setBlendingEnabled(!1)},t.prototype.bindView=function(e,t){d.bindView(t.origin,t.view,this.program)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(e){return e.gl.LINES},t}(c),P=function(e){function t(t,r,n){var o=e.call(this,t,r)||this;return o.program=r.get("highlight"),o}return r(t,e),t.prototype.updateParameters=function(){},t.prototype.beginSlot=function(e){return e===p.OPAQUE_MATERIAL},t.prototype.getProgram=function(){return this.program},t.prototype.bind=function(e,t){e.bindProgram(this.program),e.setDepthTestEnabled(!0)},t.prototype.release=function(e){},t.prototype.bindView=function(e,t){d.bindView(t.origin,t.view,this.program)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(e){return e.gl.LINES},t}(c),A=i.vec3d.create(),S=i.vec3d.create(),D=i.vec3d.create(),L=i.vec3d.create(),M=i.vec3d.create(),E=i.vec3d.create(),I=i.vec3d.create(),x=i.vec3d.create(),U={success:!1,dist2:0,pa:i.vec3d.create(),pb:i.vec3d.create()},V=[i.vec3d.create(),i.vec3d.create(),i.vec3d.create(),i.vec3d.create()],w=[i.vec3d.create(),i.vec3d.create(),i.vec3d.create(),i.vec3d.create()],N=i.vec4d.create(),O=i.vec4d.create(),_=i.vec4d.create(),C=i.vec4d.create(),T=[];return y});