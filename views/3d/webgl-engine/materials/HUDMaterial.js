// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/text!./HUDMaterial.xml","./internal/MaterialUtil","../lib/ShaderVariations","../lib/Util","../lib/gl-matrix","../lib/RenderSlot","../../../webgl/Program","../lib/DefaultVertexAttributeLocations","../../../webgl/Util"],function(e,t,i,r,o,n,a,s,l,f){function d(e,t,i){i[0]=e[0]*(t[2]-t[0])+t[0],i[1]=e[1]*(t[3]-t[1])+t[1]}var c=n.vec2d,v=n.vec3d,u=n.mat4d,S=o.assert,h=o.VertexAttrConstants,x={"bottom-left":[0,0],bottom:[.5,0],"bottom-right":[1,0],left:[0,.5],center:[.5,.5],right:[1,.5],"top-left":[0,1],top:[.5,1],"top-right":[1,1]},g=[253/255,231/255,229/255],m=function(e,t){i.basicMaterialConstructor(this,t),e=e||null,e.texCoordScale=e.texCoordScale||[1,1],e.occlusionTest=void 0!==e.occlusionTest?e.occlusionTest:!0,e.color=e.color||[1,1,1,1],e.screenMinMaxSize=e.screenMinMaxSize||[0,1e5],e.outlineColor=e.outlineColor||[1,1,1,1],e.outlineSize=e.outlineSize||0,e.textureIsSignedDistanceField=e.textureIsSignedDistanceField?1:0,e.distanceFieldBoundingBox=e.distanceFieldBoundingBox,e.vvSizeEnabled=e.vvSizeEnabled||!1,e.vvSizeMinSize=e.vvSizeMinSize||[1,1,1],e.vvSizeMaxSize=e.vvSizeMaxSize||[100,100,100],e.vvSizeOffset=e.vvSizeOffset||[0,0,0],e.vvSizeFactor=e.vvSizeFactor||[1,1,1],e.vvColorEnabled=e.vvColorEnabled||!1,e.vvColorValues=e.vvColorValues||[0,0,0,0,0,0,0,0],e.vvColorColors=e.vvColorColors||[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],e.screenOffset?e.screenOffset.forEach(function(t,i){e.screenOffset[i]=2*t}):e.screenOffset=[0,0],"string"==typeof e.anchorPos?(S(x[e.anchorPos],"HUDMaterial: invalid anchorPos specified"),e.anchorPos=x[e.anchorPos]):e.anchorPos||(e.anchorPos=x.center),null==e.shaderPolygonOffset&&(e.shaderPolygonOffset=1e-5);var r=[{name:"position",count:3,type:5126,offset:0,stride:76,normalized:!1},{name:"normal",count:3,type:5126,offset:12,stride:76,normalized:!1},{name:"uv0",count:2,type:5126,offset:24,stride:76,normalized:!1},{name:"color",count:4,type:5121,offset:32,stride:76,normalized:!1},{name:"size",count:2,type:5126,offset:36,stride:76,normalized:!1},{name:"auxpos1",count:4,type:5126,offset:44,stride:76,normalized:!1},{name:"auxpos2",count:4,type:5126,offset:60,stride:76,normalized:!1}],o=f.getStride(r),n=o/4;this.dispose=function(){},this.getParameterValues=function(){var t={color:e.color,texCoordScale:e.texCoordScale,polygonOffset:e.polygonOffset,anchorPos:e.anchorPos,screenOffset:e.screenOffset,screenMinMaxSize:e.screenMinMaxSize,shaderPolygonOffset:e.shaderPolygonOffset,textureIsSignedDistanceField:e.textureIsSignedDistanceField,outlineColor:e.outlineColor,outlineSize:e.outlineSize,distanceFieldBoundingBox:e.distanceFieldBoundingBox,vvSizeEnabled:e.vvSizeEnabled,vvSizeMinSize:e.vvSizeMinSize,vvSizeMaxSize:e.vvSizeMaxSize,vvSizeOffset:e.vvSizeOffset,vvSizeFactor:e.vvSizeFactor,vvColorEnabled:e.vvColorEnabled,vvColorValues:e.vvColorValues,vvColorColors:e.vvColorColors};return e.textureId&&(t.textureId=e.textureId),e.direction&&(t.direction=e.direction),t},this.setParameterValues=function(t){for(var i in t)"textureId"===i&&S(e.textureId,"Can only change texture of material that already has a texture"),"direction"===i&&S(e.direction,"Can only change direction of HUDMaterial which was initialized with a direction"),e[i]=t[i];this.notifyDirty("matChanged")},this.getParams=function(){return e},this.getOutputAmount=function(e){return e*n*6},this.getVertexBufferLayout=function(){return r},this.fillInterleaved=function(t,a,s,l,d,c){for(var v=4*c,u=i.fill,S=t.faces.indices[h.POSITION],x=t.vertexAttr[h.POSITION].data,g=c+f.findAttribute(r,h.POSITION).offset/4,m=0;m<S.length;++m){var z=3*S[m];u(x,z,d,g,a,3),g+=n,u(x,z,d,g,a,3),g+=n,u(x,z,d,g,a,3),g+=n,u(x,z,d,g,a,3),g+=n,u(x,z,d,g,a,3),g+=n,u(x,z,d,g,a,3),g+=n}var O=t.faces.indices[h.NORMAL],C=t.vertexAttr[h.NORMAL].data;for(g=c+f.findAttribute(r,h.NORMAL).offset/4,m=0;m<O.length;++m)z=3*O[m],u(C,z,d,g,s,3),g+=n,u(C,z,d,g,s,3),g+=n,u(C,z,d,g,s,3),g+=n,u(C,z,d,g,s,3),g+=n,u(C,z,d,g,s,3),g+=n,u(C,z,d,g,s,3),g+=n;g=c+f.findAttribute(r,h.UV0).offset/4;var P=t.vertexAttr[h.UV0].data;if(null==P||P.length<=3)var b=0,U=0,p=e.texCoordScale[0],D=e.texCoordScale[1];else b=t.vertexAttr[h.UV0].data[0],U=t.vertexAttr[h.UV0].data[1],p=t.vertexAttr[h.UV0].data[2],D=t.vertexAttr[h.UV0].data[3];for(p=Math.min(1.99999,p+1),D=Math.min(1.99999,D+1),m=0;m<S.length;++m)d[g]=b,d[g+1]=U,g+=n,d[g]=p,d[g+1]=U,g+=n,d[g]=p,d[g+1]=D,g+=n,d[g]=p,d[g+1]=D,g+=n,d[g]=b,d[g+1]=D,g+=n,d[g]=b,d[g+1]=U,g+=n;var M=t.faces.indices[h.COLOR],I=t.vertexAttr[h.COLOR].data;g=v+f.findAttribute(r,h.COLOR).offset;var y=new Uint8Array(d.buffer);for(m=0;m<M.length;++m)z=4*M[m],u(I,z,y,g,null,4),g+=o,u(I,z,y,g,null,4),g+=o,u(I,z,y,g,null,4),g+=o,u(I,z,y,g,null,4),g+=o,u(I,z,y,g,null,4),g+=o,u(I,z,y,g,null,4),g+=o;var T=t.faces.indices[h.SIZE],A=t.vertexAttr[h.SIZE].data;for(g=c+f.findAttribute(r,h.SIZE).offset/4,m=0;m<T.length;++m){var E=A[2*T[m]],F=A[2*T[m]+1];d[g]=E,d[g+1]=F,g+=n,d[g]=E,d[g+1]=F,g+=n,d[g]=E,d[g+1]=F,g+=n,d[g]=E,d[g+1]=F,g+=n,d[g]=E,d[g+1]=F,g+=n,d[g]=E,d[g+1]=F,g+=n}if(null!=t.faces.indices[h.AUXPOS1]&&null!=t.vertexAttr[h.AUXPOS1]){var V=t.faces.indices[h.AUXPOS1],w=t.vertexAttr[h.AUXPOS1].data;for(g=c+f.findAttribute(r,"auxpos1").offset/4,m=0;m<V.length;++m)z=4*V[m],u(w,z,d,g,null,4),g+=n,u(w,z,d,g,null,4),g+=n,u(w,z,d,g,null,4),g+=n,u(w,z,d,g,null,4),g+=n,u(w,z,d,g,null,4),g+=n,u(w,z,d,g,null,4),g+=n}if(null!=t.faces.indices[h.AUXPOS2]&&null!=t.vertexAttr[h.AUXPOS2]){var L=t.faces.indices[h.AUXPOS2],B=t.vertexAttr[h.AUXPOS2].data;for(g=c+f.findAttribute(r,"auxpos2").offset/4,m=0;m<L.length;++m)z=4*L[m],u(B,z,d,g,null,4),g+=n,u(B,z,d,g,null,4),g+=n,u(B,z,d,g,null,4),g+=n,u(B,z,d,g,null,4),g+=n,u(B,z,d,g,null,4),g+=n,u(B,z,d,g,null,4),g+=n}};var a=v.create(),s=v.create(),l=u.create();u.identity(l);var g=1,m=[0,0],C=[0,0];this.intersect=function(t,i,r,o,n,f,x,z){if(o.isSelection&&o.enableHUDSelection){var O=1,P=1;if(z){var b=z(l);O=b[0],P=b[5]}var U=t.getData().getVertexAttr()[h.POSITION],p=t.getData().getVertexAttr()[h.SIZE];S(U.size>=3);var D=o.point,M=o.camera;e.textureIsSignedDistanceField?d(e.anchorPos,e.distanceFieldBoundingBox,C):c.set(e.anchorPos,C);for(var I=0;I<U.data.length/U.size;I++){var y=I*U.size;v.set3(U.data[y],U.data[y+1],U.data[y+2],a),u.multiplyVec3(r,a,a);var T=I*p.size;if(m[0]=p.data[T]*O,m[1]=p.data[T+1]*P,M.projectPoint(a,s),s[0]>-1){var A=s[0],E=s[1],F=A-g-(C[0]>0?m[0]*C[0]:0),V=F+m[0]+2*g,w=E-g-(C[1]>0?m[1]*C[1]:0),L=w+m[1]+2*g;if(e.textureIsSignedDistanceField){var B=e.outlineSize/2,R=e.distanceFieldBoundingBox;F+=m[0]*R[0],w+=m[1]*R[1],V-=m[0]*(1-R[2]),L-=m[1]*(1-R[3]),F-=B,V+=B,w-=B,L+=B}if(D[0]>F&&D[0]<V&&D[1]>w&&D[1]<L){var _=o.p0,H=o.p1;s[0]=D[0],s[1]=D[1],M.unprojectPoint(s,a);var N=v.negate(o.getDirection(),v.create()),G=v.dist(_,a)/v.dist(_,H);x(G,N,-1,1,!0)}}}}},this.getGLMaterials=function(){return{color:z,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:O}},this.getAllTextureIds=function(){return[e.textureId]},this._textureDirty=!1,this.setTextureDirty=function(){this._textureDirty=!0}},z=function(t,r,o){function n(){return r.shaderVariators.HUDMaterial.getProgram([!!v.direction,!!v.worldScale,v.occlusionTest,v.textureIsSignedDistanceField,!!v.vvSizeEnabled,!!v.vvColorEnabled])}i.basicGLMaterialConstructor(this,t);var s=a.OCCLUSION_PIXELS,l=a.OVERLAY,f=0,v=e.clone(t.getParams()),u=r.get("hudOcclusionTestPixel"),S=n();i.singleTextureGLMaterialConstructor(this,o,v),this.beginSlot=function(e){return f=e,v.occlusionTest?e===s||e===l:e===l},this.getProgram=function(){return f===s&&v.occlusionTest?u:S},this.getAllPrograms=function(){return[u,S]},this.updateParameters=function(){var e=t.getParams();v.color=e.color,v.texCoordScale=e.texCoordScale,v.polygonOffset=e.polygonOffset,v.anchorPos=e.anchorPos,v.screenOffset=e.screenOffset,v.screenMinMaxSize=e.screenMinMaxSize,v.direction=e.direction,v.shaderPolygonOffset=e.shaderPolygonOffset,v.textureIsSignedDistanceField=e.textureIsSignedDistanceField,v.outlineColor=e.outlineColor,v.outlineSize=e.outlineSize,v.vvSizeEnabled=e.vvSizeEnabled,v.vvSizeMinSize=e.vvSizeMinSize,v.vvSizeMaxSize=e.vvSizeMaxSize,v.vvSizeOffset=e.vvSizeOffset,v.vvSizeFactor=e.vvSizeFactor,v.vvColorEnabled=e.vvColorEnabled,v.vvColorValues=e.vvColorValues,v.vvColorColors=e.vvColorColors,this.updateTexture(e.textureId),S=n()};var h=[0,0];this.bind=function(e,i){t._textureDirty&&(this.renderTexture(e),t._textureDirty=!1);var r=e.gl,o=i.cameraAboveGround?1:-1;if(f===s&&v.occlusionTest)e.bindProgram(u),u.setUniform1f("cameraGroundRelative",o),u.setUniform1f("polygonOffset",v.shaderPolygonOffset),u.setUniform4fv("viewport",i.viewport),u.setUniform4f("color",g[0],g[1],g[2],1),e.setDepthFunction(r.LEQUAL);else{if(e.bindProgram(S),S.setUniform1f("cameraGroundRelative",o),this.bindTexture(e,S),S.setUniform1i("framebufferTex",1),e.bindTexture(i.framebufferTex,1),e.setActiveTexture(0),S.setUniform3fv("markerColor",g),S.setUniform4fv("viewport",i.viewport),S.setUniform4fv("overrideColor",v.color),S.setUniform1f("pixelRatio",i.pixelRatio),S.setUniform1f("polygonOffset",v.shaderPolygonOffset),v.textureIsSignedDistanceField&&(S.setUniform4fv("outlineColor",v.outlineColor),S.setUniform1f("outlineSize",v.outlineSize)),v.vvSizeEnabled&&(S.setUniform3fv("vvSizeMinSize",v.vvSizeMinSize),S.setUniform3fv("vvSizeMaxSize",v.vvSizeMaxSize),S.setUniform3fv("vvSizeOffset",v.vvSizeOffset),S.setUniform3fv("vvSizeFactor",v.vvSizeFactor)),v.vvColorEnabled&&(S.setUniform1fv("vvColorValues",v.vvColorValues),S.setUniform4fv("vvColorColors",v.vvColorColors)),v.worldScale){var n=[-1,-1],a=v.screenMinMaxSize,l=i.proj,x=i.viewport[2]/i.pixelRatio;if(a)if(0!==l[11]){var m=2*Math.atan(1/l[0]),z=Math.tan(m/2)/x*2;n[0]=a[0]*z,n[1]=a[1]*z}else{var O=2/(l[0]*x);c.scale(a,O,n)}S.setUniform2fv("minMaxWorldSizeFactor",n)}v.direction&&S.setUniform3fv("direction",v.direction),S.setUniform2fv("texScale",v.texCoordScale),S.setUniform2fv("screenOffset",v.screenOffset),v.textureIsSignedDistanceField?(d(v.anchorPos,v.distanceFieldBoundingBox,h),S.setUniform2fv("anchorPos",h)):S.setUniform2fv("anchorPos",v.anchorPos),v.polygonOffset&&(e.setPolygonOffsetFillEnabled(!0),e.setPolygonOffset(0,-4)),e.setBlendingEnabled(!0)}},this.release=function(e){var t=e.gl;f===s&&v.occlusionTest?e.setDepthFunction(t.LESS):(e.setPolygonOffsetFillEnabled(!1),e.setBlendingEnabled(!1))},this.bindView=function(e,t){var r=t.origin;f===s&&v.occlusionTest?(i.bindView(r,t.view,u),i.bindCamPos(r,t.viewInvTransp,u)):(i.bindView(r,t.view,S),i.bindCamPos(r,t.viewInvTransp,S))},this.bindInstance=function(e,t){f===s&&v.occlusionTest?(u.setUniformMatrix4fv("model",t.transformation),u.setUniformMatrix4fv("modelNormal",t.transformationNormal)):S.setUniformMatrix4fv("model",t.transformation)},this.getDrawMode=function(e){var t=e.gl;return f===s&&v.occlusionTest?t.POINTS:t.TRIANGLES}},O=function(t,r,o){function n(){return r.shaderVariators.HUDMaterialHighlight.getProgram([!!s.direction,!!s.worldScale,s.occlusionTest,s.textureIsSignedDistanceField,!!s.vvSizeEnabled,!!s.vvColorEnabled])}i.basicGLMaterialConstructor(this,t);var s=e.clone(t.getParams()),l=r.get("hudOcclusionTestPixel"),f=n();i.singleTextureGLMaterialConstructor(this,o,s),this.beginSlot=function(e){return e===a.OVERLAY},this.getProgram=function(){return f},this.getAllPrograms=function(){return[l,f]},this.updateParameters=function(){var e=t.getParams();s.color=e.color,s.texCoordScale=e.texCoordScale,s.polygonOffset=e.polygonOffset,s.anchorPos=e.anchorPos,s.screenOffset=e.screenOffset,s.screenMinMaxSize=e.screenMinMaxSize,s.direction=e.direction,s.shaderPolygonOffset=e.shaderPolygonOffset,s.textureIsSignedDistanceField=e.textureIsSignedDistanceField,s.outlineColor=e.outlineColor,s.outlineSize=e.outlineSize,this.updateTexture(e.textureId),f=n()};var v=[0,0];this.bind=function(e,i){if(t._textureDirty&&(this.renderTexture(e),t._textureDirty=!1),e.bindProgram(f),this.bindTexture(e,f),f.setUniform1i("framebufferTex",1),e.bindTexture(i.framebufferTex,1),e.setActiveTexture(0),f.setUniform3fv("markerColor",g),f.setUniform4fv("viewport",i.viewport),f.setUniform4fv("overrideColor",s.color),f.setUniform1f("pixelRatio",i.pixelRatio),f.setUniform1f("polygonOffset",s.shaderPolygonOffset),s.textureIsSignedDistanceField&&(f.setUniform4fv("outlineColor",s.outlineColor),f.setUniform1f("outlineSize",s.outlineSize)),s.worldScale){var r=[-1,-1],o=s.screenMinMaxSize,n=i.proj,a=i.viewport[2]/i.pixelRatio;if(o)if(0!==n[11]){var l=2*Math.atan(1/n[0]),u=Math.tan(l/2)/a*2;r[0]=o[0]*u,r[1]=o[1]*u}else{var S=2/(n[0]*a);c.scale(o,S,r)}f.setUniform2fv("minMaxWorldSizeFactor",r)}s.direction&&f.setUniform3fv("direction",s.direction),f.setUniform2fv("texScale",s.texCoordScale),f.setUniform2fv("screenOffset",s.screenOffset),s.textureIsSignedDistanceField?(d(s.anchorPos,s.distanceFieldBoundingBox,v),f.setUniform2fv("anchorPos",v)):f.setUniform2fv("anchorPos",s.anchorPos),s.polygonOffset&&(e.setPolygonOffsetFillEnabled(!0),e.setPolygonOffset(0,-4)),e.setBlendingEnabled(!0)},this.release=function(e){e.setPolygonOffsetFillEnabled(!1),e.setBlendingEnabled(!1)},this.bindView=function(e,t){var r=t.origin;i.bindView(r,t.view,f),i.bindCamPos(r,t.viewInvTransp,f)},this.bindInstance=function(e,t){f.setUniformMatrix4fv("model",t.transformation)},this.getDrawMode=function(e){var t=e.gl;return t.TRIANGLES}};return m.loadShaders=function(e,i,o,n){e._parse(t);var a=n.parameters.maxVertexTextureImageUnits>0,f=new r("hud",["vertexShaderHUD","fragmentShaderHUD"],null,o,i,e,n);f.addBinaryShaderSnippetSuffix("Direction","Direction",[!0,!1]),f.addBinaryShaderSnippetSuffix("WorldScale","WorldScale",[!0,!1]),f.addDefine("OcclTest",a?"OCCL_TEST":"OCCL_PIXELSHADER"),f.addDefine("SDF","SIGNED_DISTANCE_FIELD"),f.addDefine("vvSize","VV_SIZE"),f.addDefine("vvColor","VV_COLOR"),o.shaderVariators.HUDMaterial=f;var d=new r("hudHighlight",["vertexShaderHUD","fragmentShaderHUDHighlight"],null,o,i,e,n);d.addBinaryShaderSnippetSuffix("Direction","Direction",[!0,!1]),d.addBinaryShaderSnippetSuffix("WorldScale","WorldScale",[!0,!1]),d.addDefine("OcclTest",a?"OCCL_TEST":"OCCL_PIXELSHADER"),d.addDefine("SDF","SIGNED_DISTANCE_FIELD"),d.addDefine("vvSize","VV_SIZE"),d.addDefine("vvColor","VV_COLOR"),o.shaderVariators.HUDMaterialHighlight=d;var c=new s(n,e.vertexShaderOcclusionTestPixel,e.fragmentShaderSimple,l.Default3D);o.add("hudOcclusionTestPixel",c)},m});