// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","dojo/text!./DefaultMaterial.xml","../../layers/graphics/graphicUtils","../../support/buffer/glUtil","../../support/buffer/InterleavedLayout","../lib/DefaultVertexAttributeLocations","../lib/gl-matrix","../lib/GLMaterialTexture","../lib/Material","../lib/RenderSlot","../lib/ShaderVariations","../lib/Util","./internal/MaterialUtil","../../../webgl/Program","../../../webgl/Util"],function(e,t,r,a,i,n,o,s,l,d,p,u,c,v,f,m,S){function g(e){return e.cullFace?"none"!==e.cullFace:!e.transparent}function h(e,t){var r=e.gl;g(t)?(e.setFaceCullingEnabled(!0),"front"===t.cullFace&&e.setCullFace(r.FRONT)):e.setFaceCullingEnabled(!1)}function b(e,t){var r=e.gl;g(t)?(e.setFaceCullingEnabled(!1),"front"===t.cullFace&&e.setCullFace(r.BACK)):e.setFaceCullingEnabled(!0)}function y(e,t){return e?u.TRANSPARENT_MATERIAL:t?u.STENCIL_MATERIAL:u.OPAQUE_MATERIAL}function x(e,t){var r=t.vvSizeEnabled;t.vvSizeEnabled?(e.setUniform3fv("vvSizeMinSize",t.vvSizeMinSize),e.setUniform3fv("vvSizeMaxSize",t.vvSizeMaxSize),e.setUniform3fv("vvSizeOffset",t.vvSizeOffset),e.setUniform3fv("vvSizeFactor",t.vvSizeFactor)):r&&e.setUniform3fv("vvSizeValue",t.vvSizeValue),r&&(e.setUniform3fv("vvSymbolAnchor",t.vvSymbolAnchor),i.computeObjectRotation(t.vvSymbolRotation[2],t.vvSymbolRotation[0],t.vvSymbolRotation[1],V.identity(G)),e.setUniformMatrix3fv("vvSymbolRotation",V.toMat3(G,H))),t.vvColorEnabled&&(e.setUniform1fv("vvColorValues",t.vvColorValues),e.setUniform4fv("vvColorColors",t.vvColorColors))}function O(e,t){e.vvSizeEnabled=t.vvSizeEnabled,e.vvSizeMinSize=t.vvSizeMinSize,e.vvSizeMaxSize=t.vvSizeMaxSize,e.vvSizeOffset=t.vvSizeOffset,e.vvSizeFactor=t.vvSizeFactor,e.vvSizeValue=t.vvSizeValue,e.vvSymbolAnchor=t.vvSymbolAnchor,e.vvSymbolRotation=t.vvSymbolRotation}var C,E=l.vec3d,P=l.vec4d,D=l.mat3d,V=l.mat4d,I=v.assert,z={DIFFUSE:0,COMPONENT_COLOR:1},N=function(e){function t(r,a){var i=e.call(this,a)||this;return i.supportsEdges=!0,i.params=f.copyParameters(r,w),i.instanced=!!r.instanced,i.vertexBufferLayout=t.getVertexBufferLayout(i.params),i.instanceBufferLayout=i.instanced?t.getInstanceBufferLayout(i.params):null,i}return r(t,e),t.prototype.isVisible=function(){var t=this.params;if(!e.prototype.isVisible.call(this)||0===t.layerOpacity)return!1;var r=C&&t.instanced,a=t.vertexColors,i=t.symbolColors,n=!!r&&r.indexOf("color")>-1,o=t.vvColorEnabled,s="replace"===t.colorMixMode,l=t.opacity>0,d=t.externalColor&&t.externalColor[3]>0;return a&&(n||o||i)?!!s||l:a?s?d:l:n||o||i?!!s||l:s?d:l},t.prototype.getParams=function(){return this.params},t.prototype.getParameterValues=function(){var e=this.params;return{textureId:e.textureId,ambient:e.ambient,diffuse:e.diffuse,specular:e.specular,externalColor:e.externalColor,colorMixMode:e.colorMixMode,opacity:e.opacity,layerOpacity:e.layerOpacity,transparent:e.transparent,polygonOffset:e.polygonOffset,atlasRegions:e.atlasRegions,flipV:e.flipV,doubleSided:e.doubleSided,doubleSidedType:e.doubleSidedType,cullFace:e.cullFace,writeStencil:e.writeStencil,receiveSSAO:e.receiveSSAO,castShadows:e.castShadows,verticalOffset:e.verticalOffset,screenSizePerspective:e.screenSizePerspective,vvSizeEnabled:e.vvSizeEnabled,vvSizeMinSize:e.vvSizeMinSize,vvSizeMaxSize:e.vvSizeMaxSize,vvSizeOffset:e.vvSizeOffset,vvSizeFactor:e.vvSizeFactor,vvSizeValue:e.vvSizeValue,vvColorEnabled:e.vvColorEnabled,vvColorValues:e.vvColorValues,vvColorColors:e.vvColorColors,compressedNormals:e.compressedNormals,groundNormalShading:e.groundNormalShading,vvSymbolAnchor:e.vvSymbolAnchor,vvSymbolRotation:e.vvSymbolRotation}},t.prototype.setParameterValues=function(e){var t=this.params;for(var r in e)"textureId"===r&&I(t.textureId,"Can only change texture of material that already has a texture"),"castShadows"===r&&I(e.castShadows===t.castShadows,"Can not change shadow casting behavior."),t[r]=e[r];this.notifyDirty("matChanged")},t.prototype.getOutputAmount=function(e){return e*(S.getStride(this.vertexBufferLayout)/4)},t.prototype.getVertexBufferLayout=function(){return this.vertexBufferLayout},t.prototype.getInstanceBufferLayout=function(){return this.instanceBufferLayout},t.prototype.fillInterleaved=function(e,t,r,a,i,n,o){f.fillInterleaved(e,t,r,a,this.vertexBufferLayout,i,n,o)},t.prototype.intersect=function(e,t,r,a,i,n,o,s){if(null!==this.params.verticalOffset){var l=a.camera;E.set3(r[12],r[13],r[14],K);var d=E.subtract(K,l.eye,Q),p=E.length(d),u=E.scale(d,1/p),c=null,v=null;switch(a.viewingMode){case"global":v=E.normalize(K,k);break;case"local":v=E.set(X,k)}this.params.screenSizePerspective&&(c=E.dot(v,u));var m=f.verticalOffsetAtDistance(l,p,this.params.verticalOffset,c,this.params.screenSizePerspective);E.scale(v,m),D.multiplyVec3(a.transformInverseRotation,v,q),i=E.subtract(i,q,Z),n=E.subtract(n,q,j)}f.intersectTriangleGeometry(e,t,r,a,i,n,o)},t.prototype.getGLMaterials=function(){return{color:T,depthShadowMap:this.params.castShadows?M:null,normal:R,depth:A,highlight:F}},t.prototype.getAllTextureIds=function(){var e=this.params,t=[];return e.textureId&&t.push(e.textureId),t},t.loadShaders=function(e,t,r){e._parse(a),C=null!==r.capabilities.instancing;var i=new c("phong",["vsPhong","fsPhong"],null,t,e,r);i.addNaryShaderSnippetSuffix([{value:"none",programNameSuffix:"",shaderSnippetSuffix:""},{value:"Textured"},{value:"AtlasTextured"}]),i.addDefine("Color","VERTEXCOLORS"),i.addDefine("symbolColor","SYMBOLVERTEXCOLORS"),i.addDefine("FlipV","FLIPV"),i.addDefine("DoubleSided","DOUBLESIDED"),i.addDefine("WindingOrderDoubleSided","WINDINGORDERDOUBLESIDED"),i.addDefine("Instanced","INSTANCED"),i.addDefine("InstColor","INSTANCEDCOLOR"),i.addDefine("ReceiveShadows","RECEIVE_SHADOWS"),i.addDefine("ReceiveSSAO","RECEIVE_SSAO"),i.addDefine("vvSize","VV_SIZE"),i.addDefine("vvColor","VV_COLOR"),i.addDefine("VerticalOffset","VERTICAL_OFFSET"),i.addDefine("screenSizePerspective","SCREEN_SIZE_PERSPECTIVE"),i.addDefine("groundNormalShading","GROUND_NORMAL_SHADING"),i.addDefine("compressedNormals","COMPRESSED_NORMALS"),i.addDefine("componentColor","COMPONENTCOLORS"),t.addShaderVariations(_,i);var n=new c("depth",["vsDepth","fsDepth"],null,t,e,r);n.addNaryShaderSnippetSuffix([{value:"none",programNameSuffix:"",shaderSnippetSuffix:""},{value:"Textured"},{value:"AtlasTextured"}]),n.addDefine("FlipV","FLIPV"),n.addDefine("Instanced","INSTANCED"),n.addDefine("ShadowMap","BIAS_SHADOWMAP"),n.addDefine("vvSize","VV_SIZE"),n.addDefine("VerticalOffset","VERTICAL_OFFSET"),n.addDefine("screenSizePerspective","SCREEN_SIZE_PERSPECTIVE"),t.addShaderVariations(L,n);var o=new c("normal",["vsNormal","fsNormal"],null,t,e,r);o.addNaryShaderSnippetSuffix([{value:"none",programNameSuffix:"",shaderSnippetSuffix:""},{value:"Textured"},{value:"AtlasTextured"}]),o.addDefine("FlipV","FLIPV"),o.addDefine("Instanced","INSTANCED"),o.addDefine("vvSize","VV_SIZE"),o.addDefine("VerticalOffset","VERTICAL_OFFSET"),o.addDefine("screenSizePerspective","SCREEN_SIZE_PERSPECTIVE"),o.addDefine("compressedNormals","COMPRESSED_NORMALS"),t.addShaderVariations(U,o);var l=new c("highlight",["vsHighlight","fsHighlight"],null,t,e,r);l.addNaryShaderSnippetSuffix([{value:"none",programNameSuffix:"",shaderSnippetSuffix:""},{value:"Textured"},{value:"AtlasTextured"}]),l.addDefine("FlipV","FLIPV"),l.addDefine("Instanced","INSTANCED"),l.addDefine("vvSize","VV_SIZE"),l.addDefine("VerticalOffset","VERTICAL_OFFSET"),l.addDefine("screenSizePerspective","SCREEN_SIZE_PERSPECTIVE"),t.addShaderVariations(B,l);var d=new m(r,e.vsDepth,e.fsDepth,s.Default3D,["BIAS_SHADOWMAP 1"]),p=new m(r,e.vsDepthTextured,e.fsDepthTextured,s.Default3D,["BIAS_SHADOWMAP 1"]),u=new m(r,e.vsDepth,e.fsDepth,s.Default3D),v=new m(r,e.vsDepthTextured,e.fsDepthTextured,s.Default3D),f=new m(r,e.vsNormal,e.fsNormal,s.Default3D),S=new m(r,e.vsNormalTextured,e.fsNormalTextured,s.Default3D),g=new m(r,e.vsHighlight,e.fsHighlight,s.Default3D),h=new m(r,e.vsHighlightTextured,e.fsHighlightTextured,s.Default3D);t.add("depthShadowMap",d),t.add("depthTexturedShadowMap",p),t.add("depth",u),t.add("depthTextured",v),t.add("normal",f),t.add("normalTextured",S),t.add("highlight",g),t.add("highlightTextured",h)},t.getVertexBufferLayout=function(e){var t=o.newLayout().vec3f("position");return e.groundNormalShading||(t=e.compressedNormals?t.vec2i16("normalCompressed",{glNormalized:!0}):t.vec3f("normal")),e.textureId&&(t=t.vec2f("uv0"),e.atlasRegions&&(t=t.vec4u16("region"))),e.vertexColors&&(t=t.vec4u8("color")),e.symbolColors&&(t=t.vec4u8("symbolColor")),e.componentIndices&&(t=t.u16("componentIndex").u16("_padding",{glPadding:!0})),n.glLayout(t)},t.getInstanceBufferLayout=function(e){var t=o.newLayout().mat4f("model").mat4f("modelNormal");return e.instanced&&e.instanced.indexOf("color")>-1&&(t=t.vec4f("instanceColor")),e.instanced&&e.instanced.indexOf("featureAttribute")>-1&&(t=t.vec4f("instanceFeatureAttribute")),n.glLayout(t,1)},t}(p),T=function(e){function t(t,r,a){var i=e.call(this,t,r,a,t.getParams().textureId)||this;i.programs=[[null,null],[null,null]],i.params=f.copyParameters(t.getParams()),i.slot=y(i.params.transparent,i.params.writeStencil);var n=i.params;i.texturing=n.textureId?n.atlasRegions?"AtlasTextured":"Textured":"none";var o=C&&n.instanced;return i.instanced=!!o,i.instancedColor=!!o&&o.indexOf("color")>-1,i.pseudoInstancedColor=!C&&n.instanced&&n.instanced.indexOf("color")>-1,i._loadPrograms(),i}return r(t,e),t.prototype._loadPrograms=function(){this.programs[0][0]=this._loadProgram(!1,!1),this.programs[1][0]=this._loadProgram(!0,!1),this.params.receiveSSAO?(this.programs[0][1]=this._loadProgram(!1,!0),this.programs[1][1]=this._loadProgram(!0,!0),this.allPrograms=this.programs[0].concat(this.programs[1])):(this.programs[0][1]=this.programs[0][0],this.programs[1][1]=this.programs[1][0],this.allPrograms=[this.programs[0][0],this.programs[1][0]])},t.prototype._loadProgram=function(e,t){var r=this.params;return this.programRep.getShaderVariationsProgram(_,[this.texturing,r.vertexColors,r.symbolColors,r.flipV,r.doubleSided&&"normal"===r.doubleSidedType,r.doubleSided&&"winding-order"===r.doubleSidedType,!!this.instanced,this.instancedColor,e,t,r.vvSizeEnabled,r.vvColorEnabled,null!==r.verticalOffset,null!==r.screenSizePerspective,r.groundNormalShading,r.compressedNormals,null!=r.componentColorBuffer])},t.prototype.beginSlot=function(e){return e===this.slot},t.prototype.getProgram=function(){return this.program||this.programs[0][0]},t.prototype.getPrograms=function(){return this.allPrograms},t.prototype.updateParameters=function(){var e=this.material.getParams(),t=this.params;t.ambient=e.ambient,t.diffuse=e.diffuse,t.specular=e.specular,t.externalColor=e.externalColor,t.colorMixMode=e.colorMixMode,t.opacity=e.opacity,t.layerOpacity=e.layerOpacity,t.polygonOffset=e.polygonOffset,t.flipV=e.flipV,t.doubleSided=e.doubleSided,t.doubleSidedType=e.doubleSidedType,t.cullFace=e.cullFace,t.receiveSSAO=e.receiveSSAO,t.castShadows=e.castShadows,t.verticalOffset=e.verticalOffset,t.screenSizePerspective=e.screenSizePerspective,O(t,e),t.vvColorEnabled=e.vvColorEnabled,t.vvColorValues=e.vvColorValues,t.vvColorColors=e.vvColorColors,t.transparent!==e.transparent&&(this.slot=y(e.transparent,e.writeStencil),t.transparent=e.transparent),t.compressedNormals=e.compressedNormals,t.groundNormalShading=e.groundNormalShading,this.updateTexture(e.textureId),e.atlasRegions&&(t.atlasRegions=e.atlasRegions),t.blendModeOneOne=e.blendModeOneOne,t.inverseWindingOrder=e.inverseWindingOrder,this._loadPrograms()},t.prototype.bind=function(e,t){var r=e.gl,a=this.params,i=this.program=this.programs[t.shadowMappingEnabled?1:0][t.ssaoEnabled?1:0];e.bindProgram(i),i.setUniform3fv("ambient",a.ambient),i.setUniform3fv("diffuse",a.diffuse),i.setUniform3fv("specular",a.specular),i.setUniform4fv("externalColor",a.externalColor),i.setUniform1i("colorMixMode",f.colorMixModes[a.colorMixMode]),i.setUniform1f("opacity",a.opacity),i.setUniform1f("layerOpacity",a.layerOpacity),f.bindVerticalOffset(a.verticalOffset,t,i),f.bindScreenSizePerspective(a.screenSizePerspective,i),x(i,a),this.bindTexture(e,i),"AtlasTextured"===this.texturing&&this.bindTextureSize(e,i),e.setBlendFunctionSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA),a.inverseWindingOrder&&e.setFrontFace(r.CW),a.transparent?(e.setBlendingEnabled(!0),a.blendModeOneOne?(e.setBlendFunction(r.ONE,r.ONE),e.setDepthWriteEnabled(!1)):e.setBlendFunctionSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA)):e.setBlendingEnabled(!1),a.polygonOffset&&(e.setPolygonOffsetFillEnabled(!0),e.setPolygonOffset(2,2)),h(e,a),e.setDepthTestEnabled(!0),a.componentIndices&&a.componentColorBuffer&&(a.componentColorBuffer.updateTexture(),a.componentColorBuffer.bind(i,{tex:"uComponentColorTex",invDim:"uComponentColorTexInvDim",unit:z.COMPONENT_COLOR}))},t.prototype.release=function(e,t){var r=e.gl;e.setPolygonOffsetFillEnabled(!1),b(e,this.params),e.setBlendingEnabled(!1),e.setBlendFunctionSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA),e.setDepthWriteEnabled(!0),e.setFrontFace(r.CCW)},t.prototype.bindView=function(e,t){var r=this.program=this.programs[t.shadowMappingEnabled?1:0][t.ssaoEnabled?1:0],a=t.origin;f.bindView(a,t.view,r),f.bindCamPos(a,t.viewInvTransp,r),t.shadowMappingEnabled&&t.shadowMap.bindView(r,a)},t.prototype.bindInstance=function(e,t){var r=this.program;if(r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal),t.instanceParameters&&this.pseudoInstancedColor){var a=t.instanceParameters.color;a&&(P.multiply(a,this.params.externalColor,W),r.setUniform4fv("externalColor",W))}},t.prototype.getDrawMode=function(e){return e.gl.TRIANGLES},t}(d),A=function(e){function t(t,r,a,i){void 0===i&&(i=!1);var n=e.call(this,t,r,a,t.getParams().textureId)||this;return n.params=f.copyParameters(t.getParams()),n.instanced=C&&!!n.params.instanced,n.texturing=S.hasAttribute(t.getVertexBufferLayout(),"uv0")?(n.params.atlasRegions,"Textured"):"none",n.program=r.getShaderVariationsProgram(L,[n.texturing,n.params.flipV,n.instanced,i,n.params.vvSizeEnabled,null!==n.params.verticalOffset,null!==n.params.screenSizePerspective]),n.slot=y(n.params.transparent,n.params.writeStencil),n}return r(t,e),t.prototype.beginSlot=function(e){return e===this.slot},t.prototype.getProgram=function(){return this.program},t.prototype.updateParameters=function(){var e=this.material.getParams(),t=this.params;t.cullFace=e.cullFace,t.inverseWindingOrder=e.inverseWindingOrder,t.flipV=e.flipV,O(t,e),this.updateTexture(e.textureId)},t.prototype.bind=function(e,t){var r=e.gl,a=this.program,i=this.params;e.bindProgram(a),a.setUniform2fv("nearFar",t.nearFar),i.inverseWindingOrder&&e.setFrontFace(r.CW),f.bindVerticalOffset(i.verticalOffset,t,a),f.bindScreenSizePerspective(i.screenSizePerspective,a),x(a,i),this.bindTexture(e,a),h(e,i),e.setDepthTestEnabled(!0)},t.prototype.release=function(e){var t=e.gl,r=this.params;b(e,r),r.inverseWindingOrder&&e.setFrontFace(t.CCW)},t.prototype.bindView=function(e,t){var r=this.program,a=this.params;f.bindView(t.origin,t.view,r),a.screenSizePerspective&&f.bindCamPos(t.origin,t.viewInvTransp,r)},t.prototype.bindInstance=function(e,t){this.program.setUniformMatrix4fv("model",t.transformation)},t.prototype.getDrawMode=function(e){return e.gl.TRIANGLES},t}(d),M=function(e){function t(t,r,a){return e.call(this,t,r,a,!0)||this}return r(t,e),t}(A),R=function(e){function t(t,r,a,i){void 0===i&&(i=!1);var n=e.call(this,t,r,a,t.getParams().textureId)||this;return n.params=f.copyParameters(t.getParams()),n.instanced=C&&!!n.params.instanced,n.texturing=S.hasAttribute(t.getVertexBufferLayout(),"uv0")?(n.params.atlasRegions,"Textured"):"none",n.program=r.getShaderVariationsProgram(U,[n.texturing,n.params.flipV,n.instanced,n.params.vvSizeEnabled,null!==n.params.verticalOffset,null!==n.params.screenSizePerspective,n.params.compressedNormals]),n.slot=y(n.params.transparent,n.params.writeStencil),n}return r(t,e),t.prototype.beginSlot=function(e){return e===this.slot},t.prototype.getProgram=function(){return this.program},t.prototype.updateParameters=function(){var e=this.material.getParams(),t=this.params;t.cullFace=e.cullFace,t.inverseWindingOrder=e.inverseWindingOrder,t.flipV=e.flipV,O(t,e),this.updateTexture(e.textureId)},t.prototype.bind=function(e,t){var r=e.gl,a=this.program,i=this.params;e.bindProgram(a),this.bindTexture(e,a),a.setUniformMatrix4fv("viewNormal",t.viewInvTransp),f.bindVerticalOffset(i.verticalOffset,t,a),f.bindScreenSizePerspective(i.screenSizePerspective,a),x(a,i),h(e,i),i.inverseWindingOrder&&e.setFrontFace(r.CW),e.setDepthTestEnabled(!0)},t.prototype.release=function(e){var t=e.gl,r=this.params;b(e,r),r.inverseWindingOrder&&e.setFrontFace(t.CCW)},t.prototype.bindView=function(e,t){var r=this.program,a=this.params;f.bindView(t.origin,t.view,r),a.screenSizePerspective&&f.bindCamPos(t.origin,t.viewInvTransp,r)},t.prototype.bindInstance=function(e,t){var r=this.program;r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},t.prototype.getDrawMode=function(e){return e.gl.TRIANGLES},t}(d),F=function(e){function t(t,r,a,i){void 0===i&&(i=!1);var n=e.call(this,t,r,a,t.getParams().textureId)||this;return n.params=f.copyParameters(t.getParams()),n.instanced=C&&!!n.params.instanced,n.texturing=S.hasAttribute(t.getVertexBufferLayout(),"uv0")?(n.params.atlasRegions,"Textured"):"none",n.program=r.getShaderVariationsProgram(B,[n.texturing,n.params.flipV,n.instanced,n.params.vvSizeEnabled,null!==n.params.verticalOffset,null!==n.params.screenSizePerspective]),n.slot=y(n.params.transparent,n.params.writeStencil),n}return r(t,e),t.prototype.beginSlot=function(e){return e===this.slot},t.prototype.getProgram=function(){return this.program},t.prototype.updateParameters=function(){var e=this.material.getParams(),t=this.params;t.cullFace=e.cullFace,t.inverseWindingOrder=e.inverseWindingOrder,t.flipV=e.flipV,O(t,e),this.updateTexture(e.textureId)},t.prototype.bind=function(e,t){var r=e.gl,a=this.program,i=this.params;e.bindProgram(a),this.bindTexture(e,a),f.bindVerticalOffset(i.verticalOffset,t,a),f.bindScreenSizePerspective(i.screenSizePerspective,a),x(a,i),h(e,i),i.inverseWindingOrder&&e.setFrontFace(r.CW),e.setDepthTestEnabled(!0)},t.prototype.release=function(e){var t=e.gl,r=this.params;b(e,r),r.inverseWindingOrder&&e.setFrontFace(t.CW)},t.prototype.bindView=function(e,t){var r=this.program,a=this.params;f.bindView(t.origin,t.view,r),a.screenSizePerspective&&f.bindCamPos(t.origin,t.viewInvTransp,r)},t.prototype.bindInstance=function(e,t){var r=this.program;r.setUniformMatrix4fv("model",t.transformation),r.setUniformMatrix4fv("modelNormal",t.transformationNormal)},t.prototype.getDrawMode=function(e){return e.gl.TRIANGLES},t}(d),w={textureId:void 0,ambient:[.2,.2,.2],diffuse:[.8,.8,.8],specular:[0,0,0],externalColor:[1,1,1,1],colorMixMode:"multiply",opacity:1,layerOpacity:1,blendModeOneOne:!1,inverseWindingOrder:!1,vertexColors:!1,symbolColors:!1,componentIndices:!1,componentColorBuffer:null,flipV:!1,doubleSided:!1,doubleSidedType:"normal",cullFace:void 0,instanced:void 0,compressedNormals:!1,groundNormalShading:!1,writeStencil:!1,receiveSSAO:!0,castShadows:!0,verticalOffset:null,screenSizePerspective:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvSizeValue:[1,1,1],vvColorEnabled:!1,vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],vvSymbolAnchor:[0,0,0],vvSymbolRotation:[0,0,0],transparent:!1,polygonOffset:!1,atlasRegions:!1},_="material",L="material-depth",U="material-normal",B="material-highlight",W=P.create(),H=D.create(),G=V.create(),Z=E.create(),j=E.create(),X=E.createFrom(0,0,1),k=E.create(),q=E.create(),K=E.create(),Q=E.create();return N});