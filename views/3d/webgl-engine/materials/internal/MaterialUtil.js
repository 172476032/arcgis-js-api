// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../../lib/IdGen","../../lib/gl-matrix","../../parts/Model","../../lib/ComponentUtils","../../lib/Util","../../../../webgl/Util"],function(e,t,i,r,n,a){var o=t.vec3d,f=t.mat4d,u=t.mat4,s=n.VertexAttrConstants,l={};l.__Material_idGen=new e,l.__GLMaterial_id=0,l.IDENTITY=f.identity();var c=function(e,t,i,r,n){var a=e[t],o=e[t+1],f=e[t+2];i[r]=n[0]*a+n[4]*o+n[8]*f+n[12],i[r+1]=n[1]*a+n[5]*o+n[9]*f+n[13],i[r+2]=n[2]*a+n[6]*o+n[10]*f+n[14]};l.fill=function(e,t,i,r,n,a){if(void 0===n||3!==a)for(var o=0;a>o;++o)i[r+o]=e[t+o];else c(e,t,i,r,n);return a};var d=function(e,t,i,r,n,a){for(var o=e.length,f=0;o>f;++f){var u=3*e[f],s=t[u],l=t[u+1],c=t[u+2];r[n]=i[0]*s+i[4]*l+i[8]*c+i[12],r[n+1]=i[1]*s+i[5]*l+i[9]*c+i[13],r[n+2]=i[2]*s+i[6]*l+i[10]*c+i[14],n+=a}},v=function(e,t,i,r,n,a){for(var o=e.length,f=0;o>f;++f){for(var u=i*e[f],s=0;i>s;++s)r[n+s]=t[u+s];n+=a}},g=function(e,t,i,r,n,a){r=new Uint8Array(r.buffer),n*=4,a*=4;for(var o=e.length,f=0;o>f;++f){var u,s=i*e[f];for(u=0;i>u;++u)r[n+u]=t[s+u];4>u&&(r[n+3]=255),n+=a}},x=function(e,t,i,r,n,a,o){n=new Uint8Array(n.buffer),a*=4,o*=4;for(var f=e.length,u=0;f>u;++u){var s,l=r*e[u];for(s=0;r>s;++s)n[a+s]=t[l+s]*i[s];4>s&&(n[a+3]=255*i[3]),a+=o}},b=function(e,t,i,r,n,a){r=new Uint16Array(r.buffer),n*=2,a*=2;for(var o=e.length,f=0;o>f;++f){var u,s=i*e[f];for(u=0;i>u;++u)r[n+u]=t[s+u];n+=a}};l.fillInterleaved=function(e,t,i,r,n,o,f,u){for(var l=a.getStride(n)/4,c=0;c<n.length;c++){var T=n[c],y=f+T.offset/4,h=T.name;if(null==u||null!=u[h]){var m;switch(h){case"uv0":m=e.vertexAttr[h],null!=m&&v(e.faces.indices[h],m.data,m.size,o,y,l);break;case"region":m=e.vertexAttr[h],b(e.faces.indices[h],m.data,m.size,o,y,l);break;case"color":m=e.vertexAttr[h],r&&r.color?x(e.faces.indices[h],m.data,r.color,m.size,o,y,l):g(e.faces.indices[h],m.data,m.size,o,y,l);break;default:m=e.vertexAttr[h];var I=h===s.POSITION?t:h===s.NORMAL?i:void 0;void 0!==I&&3===m.size?d(e.faces.indices[h],m.data,I,o,y,l):v(e.faces.indices[h],m.data,m.size,o,y,l)}}}},l.triangleVertexArrayToWireframeLines=function(e,t,i,r){for(var n=Math.floor(i/3),a=n-1;a>=0;a--){var o=t+3*a*r,f=t+3*a*2*r+5*r;this.fill(e,o,e,f,null,r),f-=r,this.fill(e,o+r,e,f,null,r),f-=r,this.fill(e,o+r,e,f,null,r),f-=r,this.fill(e,o+2*r,e,f,null,r),f-=r,this.fill(e,o+2*r,e,f,null,r),f-=r,this.fill(e,o,e,f,null,r)}};var T=o.create(),y=o.create(),h=o.create(),m=o.create(),I=function(e,t,i,n,a,f){var u=T,s=e.getCenter();o.project(s,i,n,u);var l=o.dist2(u,s),c=e.getBSRadius(),d=t.visibilities,v=t.offsets;if(c*c>l){var g=e.getPrimitiveIndices(),x=e.getIndices(),b=e.getPosition(),p=g?g.length:x.length/3;if(p>1e4){var M=e.getChildren();if(void 0!==M){for(var A=0;8>A;++A)void 0!==M[A]&&I(M[A],t,i,n,a,f);return}}for(var C=b.size,U=b.data,G=i[0],w=i[1],L=i[2],P=n[0],_=n[1],z=n[2],V=P-G,S=_-w,R=z-L,D=r.createVisibilityCache(),O=0;p>O;++O){var N=g?g[O]:O,k=3*N,q=r.lookupOffsetVisibility(d,v,k,D);if(q){var B=C*x[3*N],E=C*x[3*N+1],j=C*x[3*N+2],W=U[B],Y=U[B+1],F=U[B+2],H=U[E],J=U[E+1],K=U[E+2],Q=U[j],X=U[j+1],Z=U[j+2],$=H-W,ee=J-Y,te=K-F,ie=Q-W,re=X-Y,ne=Z-F,ae=S*ne-re*R,oe=R*ie-ne*V,fe=V*re-ie*S,ue=$*ae+ee*oe+te*fe;if(!(ue>-a&&a>ue)){var se=1/ue,le=G-W,ce=w-Y,de=L-F,ve=se*(le*ae+ce*oe+de*fe);if(!(0>ve||ve>1)){var ge=ce*te-ee*de,xe=de*$-te*le,be=le*ee-$*ce,Te=se*(V*ge+S*xe+R*be);if(!(0>Te||ve+Te>1)){var ye=se*(ie*ge+re*xe+ne*be);if(ye>=0){var he=y,me=h,Ie=m;o.set3(W,Y,F,he),o.set3(H,J,K,me),o.set3(Q,X,Z,Ie),o.subtract(me,he,me),o.subtract(Ie,he,Ie),o.normalize(o.cross(me,Ie,he)),f(ye,he,N)}}}}}}}};l.intersectTriangleGeometry=function(e,t,i,r,a,o,f){var u=0,s=e.getData(),l={offsets:s.componentOffsets,visibilities:t.componentVisibilities};n.assert("triangle"===s.primitiveType),I(e.getBoundingInfo(u),l,a,o,r.tolerance,f)},l.basicMaterialConstructor=function(e,t){var r=!0,a=0,o=l.__Material_idGen.gen(t);e.getId=function(){return o};var f;e.getParentStage=function(){return f},e.addParentStage=function(e){n.assert(void 0===f,"Material can only be added to a single Stage"),f=e},e.removeParentStage=function(e){f=void 0},e.setVisible=function(t){r!==t&&(r=t,e.notifyDirty("matChanged"))},e.isVisible=function(){return r},e.notifyDirty=function(t){f&&f.notifyDirty(i.ContentType.MATERIAL,e,t)},e.setRenderPriority=function(e){a=e,this.notifyDirty("matChanged")},e.getRenderPriority=function(){return a}};var p=l.aquireIfNotUndefined=function(e,t,i,r){return void 0!==e?i.aquire(e,t,r):void 0},M=l.releaseIfNotUndefined=function(e,t){void 0!==e&&t.release(e)},A=u.create();return l.bindView=function(e,t,i){u.translate(t,e,A),i.setUniformMatrix4fv("view",A)},l.bindCamPos=function(e,t,i){i.setUniform3f("camPos",t[3]-e[0],t[7]-e[1],t[11]-e[2])},l.basicGLMaterialConstructor=function(e,t){var i=l.__GLMaterial_id++;e.getId=function(){return i},e.getMaterialId=function(){return t.getId()},e.isVisible=function(){return t.isVisible()},e.getRenderPriority=function(){return t.getRenderPriority()}},l.singleTextureGLMaterialConstructor=function(e,t,i,r){var n=p(i.textureId,i.initTexture,t,r);e.updateTexture=function(e){i.textureId!==e&&(M(i.textureId,t),i.textureId=e,n=p(i.textureId,i.initTexture,t,r))},e.renderTexture=function(e){var r=t.getTexture(i.textureId);r&&r.dirty&&r.redraw&&r.redraw()},e.bindTexture=function(e,t){void 0!==n&&(t.setUniform1i("tex",0),e.bindTexture(n.getGLTexture()))},e.bindTextureSize=function(e,t){if(void 0!==n){var i=n.getGLTexture();t.setUniform2f("texSize",i.descriptor.width,i.descriptor.height)}},e.dispose=function(){M(i.textureId,t)}},l.multiTextureGLMaterialConstructor=function(e,t,i,r){for(var n=r.length,a=new Array(n),o=0;n>o;o++)a[o]=p(i[r[o][0]],i[r[o][1]],t);e.updateTextures=function(e){for(var o=0;n>o;o++){var f=i[r[o][0]],u=e[r[o][0]];f!==u&&(M(f,t),i[r[o][0]]=u,a[o]=p(u,i[r[o][1]],t))}},e.bindTextures=function(e,t){for(var i=0;n>i;i++)void 0!==a[i]&&(t.setUniform1i(r[i][2],i),e.bindTexture(a[i].getGLTexture(),i));e.setActiveTexture(0)},e.bindOneTexture=function(e,t,i){t.setUniform1i(r[i][2],i),e.bindTexture(a[i].getGLTexture(),i),e.setActiveTexture(0)},e.disposeTextures=function(){for(var e=0;n>e;e++)M(i[r[e][0]],t)}},l.externalColorMixModes={multiply:1,ignore:2,replace:3,tint:4},l});