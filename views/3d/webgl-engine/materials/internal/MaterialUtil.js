// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../lib/IdGen","../../lib/gl-matrix","../../lib/ComponentUtils","../../lib/Util","../../parts/Model","../../lib/screenSizePerspectiveUtils","../../../../webgl/Util","../../../support/aaBoundingBox"],function(e,t,r,n,i,a,o,u,f,c){function d(e,t,r,n,i){var a=e[t],o=e[t+1],u=e[t+2];r[n]=i[0]*a+i[4]*o+i[8]*u+i[12],r[n+1]=i[1]*a+i[5]*o+i[9]*u+i[13],r[n+2]=i[2]*a+i[6]*o+i[10]*u+i[14]}function s(e,t,r,n,i,a){if(void 0===i||3!==a)for(var o=0;a>o;++o)r[n+o]=e[t+o];else d(e,t,r,n,i);return a}function l(e,t,r,n,i,a){for(var o=e.length,u=0;o>u;++u){var f=3*e[u],c=t[f],d=t[f+1],s=t[f+2];n[i]=r[0]*c+r[4]*d+r[8]*s+r[12],n[i+1]=r[1]*c+r[5]*d+r[9]*s+r[13],n[i+2]=r[2]*c+r[6]*d+r[10]*s+r[14],i+=a}}function v(e,t,r,n,i,a){for(var o=e.length,u=0;o>u;++u){for(var f=r*e[u],c=0;r>c;++c)n[i+c]=t[f+c];i+=a}}function g(e,t,r,n,i,a){n=new Uint8Array(n.buffer),i*=4,a*=4;var o=e.length;if(4===r)for(var u=0;o>u;++u){var f=4*e[u];n[i]=t[f],n[i+1]=t[f+1],n[i+2]=t[f+2],n[i+3]=t[f+3],i+=a}else if(3===r)for(var u=0;o>u;++u){var f=3*e[u];n[i]=t[f],n[i+1]=t[f+1],n[i+2]=t[f+2],n[i+3]=255,i+=a}}function m(e,t,r,n,i,a,o){i=new Uint8Array(i.buffer),a*=4,o*=4;var u=e.length;if(4===n)for(var f=0;u>f;++f){var c=4*e[f];i[a]=t[c]*r[0],i[a+1]=t[c+1]*r[1],i[a+2]=t[c+2]*r[2],i[a+3]=t[c+3]*r[3],a+=o}else if(3===n)for(var d=255*r[3],f=0;u>f;++f){var c=3*e[f];i[a]=t[c]*r[0],i[a+1]=t[c+1]*r[1],i[a+2]=t[c+2]*r[2],i[a+3]=d,a+=o}}function x(e,t,r,n,i,a){n=new Uint16Array(n.buffer),i*=2,a*=2;for(var o=e.length,u=0;o>u;++u){for(var f=r*e[u],c=0;r>c;++c)n[i+c]=t[f+c];i+=a}}function h(e,t,r,n,i,a,o,u){for(var c=f.getStride(i)/4,d=0;d<i.length;d++){var s=i[d],h=o+s.offset/4,p=s.name,M=e.vertexAttr[p];if(null!=M&&(null==u||null!=u[p]))switch(p){case"uv0":v(e.indices[p],M.data,M.size,a,h,c);break;case"region":x(e.indices[p],M.data,M.size,a,h,c);break;case"color":n&&n.color?m(e.indices[p],M.data,n.color,M.size,a,h,c):g(e.indices[p],M.data,M.size,a,h,c);break;case"symbolColor":g(e.indices[p],M.data,M.size,a,h,c);break;default:var b=p===J.POSITION?t:p===J.NORMAL?r:void 0;void 0!==b&&3===M.size?l(e.indices[p],M.data,b,a,h,c):v(e.indices[p],M.data,M.size,a,h,c)}}}function p(e,t,r,n){for(var i=Math.floor(r/3),a=i-1;a>=0;a--){var o=t+3*a*n,u=t+3*a*2*n+5*n;s(e,o,e,u,null,n),u-=n,s(e,o+n,e,u,null,n),u-=n,s(e,o+n,e,u,null,n),u-=n,s(e,o+2*n,e,u,null,n),u-=n,s(e,o+2*n,e,u,null,n),u-=n,s(e,o,e,u,null,n)}}function M(e,t,r,n,o,u,f){a.assert("triangle"===e.data.primitiveType);var c=t.componentVisibilities,d=n.tolerance,s=e.getBoundingInfo();e.getComponentCount()>1?y(e,s,c,o,u,d,f):i.getVisibility(c,0)&&b(s,o,u,d,f)}function b(e,t,r,n,i){var a=L(t,r,K);if(c.setMin(F,e.getBBMin()),c.setMax(F,e.getBBMax()),P(F,t,a,n)){var o=e.getPrimitiveIndices(),u=e.getIndices(),f=e.getPosition(),d=o?o.length:u.length/3;if(d>1e4){var s=e.getChildren();if(void 0!==s){for(var l=0;8>l;++l)void 0!==s[l]&&b(s[l],t,r,n,i);return}}T(t,r,0,d,u,f,o,i)}}function y(e,t,r,n,a,o,u){var f=L(n,a,K);if(c.setMin(F,t.getBBMin()),c.setMax(F,t.getBBMax()),P(F,n,f,o))for(var d=e.data,s=e.getComponentCount(),l=d.getIndices(J.POSITION),v=d.getAttribute(J.POSITION),g=d.componentOffsets,m=0;s>m;m++)if(i.getVisibility(r,m)){var x=e.getComponentAABB(m,F);if(P(x,n,f,o)){var h=g[m]/3,p=g[m+1]/3;T(n,a,h,p,l,v,void 0,u)}}}function T(e,t,r,n,i,a,o,u){for(var f=a.data,c=a.offsetIdx,d=a.strideIdx,s=e[0],l=e[1],v=e[2],g=t[0],m=t[1],x=t[2],h=g-s,p=m-l,M=x-v,b=r;n>b;b++){var y=o?o[b]:b,T=c+d*i[3*y],L=c+d*i[3*y+1],P=c+d*i[3*y+2],A=f[T],C=f[T+1],O=f[T+2],S=f[L],U=f[L+1],w=f[L+2],z=f[P],V=f[P+1],_=f[P+2],B=S-A,G=U-C,W=w-O,D=z-A,R=V-C,N=_-O,k=p*N-R*M,E=M*D-N*h,q=h*R-D*p,Y=B*k+G*E+W*q,j=s-A,H=l-C,F=v-O,J=H*W-G*F,K=F*B-W*j,Z=j*G-B*H;if(Y>Q){var $=j*k+H*E+F*q;if(0>$||$>Y)continue;var ee=h*J+p*K+M*Z;if(0>ee||$+ee>Y)continue}else{if(!(-Q>Y))continue;var $=j*k+H*E+F*q;if($>0||Y>$)continue;var ee=h*J+p*K+M*Z;if(ee>0||Y>$+ee)continue}var te=(D*J+R*K+N*Z)/Y;if(te>=0){var re=I(B,G,W,D,R,N,X);u(te,re,y)}}}function I(e,t,r,i,a,o,u){return n.vec3d.set3(e,t,r,Z),n.vec3d.set3(i,a,o,$),n.vec3d.normalize(n.vec3d.cross(Z,$,u))}function L(e,t,r){return n.vec3d.set3(1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]),r)}function P(e,t,r,n){var i=(e[0]-n-t[0])*r[0],a=(e[3]+n-t[0])*r[0],o=Math.min(i,a),u=Math.max(i,a),f=(e[1]-n-t[1])*r[1],c=(e[4]+n-t[1])*r[1];if(o=Math.max(o,Math.min(f,c)),u=Math.min(u,Math.max(f,c)),o>u)return!1;var d=(e[2]-n-t[2])*r[2],s=(e[5]+n-t[2])*r[2];return o=Math.max(o,Math.min(d,s)),u=Math.min(u,Math.max(d,s)),u>=o}function A(e,t,r){return n.vec4d.set4(e[0]-t[0],e[1]-t[1],e[2]-t[2],1,r)}function C(e,t,r,i){return n.mat4d.translate(r,t,H),r=H,n.mat4d.multiplyVec4(r,e,i)}function O(e,t,r,i){return i[0]=e[0]+r[0],i[1]=e[1]+r[1],i[2]=e[2]+r[2],i[3]=e[3],n.mat4d.multiplyVec4(t,i)}function S(e,t){return n.vec4d.scale(e,1/Math.abs(e[3]),t)}function U(e,t,r,n,i){return u.scale(e,n,r,i)}function w(e,t,r,n,i){var o=r.screenLength||0;i&&(o=U(o,e,t,n,i));var u=o*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return a.clamp(u*t,r.minWorldLength||0,null!=r.maxWorldLength?r.maxWorldLength:1/0)}function z(e,r){var n=!0,i=!1,u=0,f=t.__Material_idGen.gen(r);e.getId=function(){return f};var c;e.getParentStage=function(){return c},e.addParentStage=function(e){a.assert(void 0===c,"Material can only be added to a single Stage"),c=e},e.removeParentStage=function(e){c=void 0},e.setVisible=function(t){n!==t&&(n=t,e.notifyDirty("matChanged"))},e.isVisible=function(){return n},e.setRenderOccluded=function(t){i!==t&&(i=t,e.notifyDirty("matChanged"))},e.isRenderOccluded=function(){return i},e.notifyDirty=function(t){c&&c.notifyDirty(o.ContentType.MATERIAL,e,t)},e.setRenderPriority=function(e){u=e,this.notifyDirty("matChanged")},e.getRenderPriority=function(){return u}}function V(e,t,r,n){return void 0!==e?r.aquire(e,t,n):void 0}function _(e,t){void 0!==e&&t.release(e)}function B(e,t,r){n.mat4d.translate(t,e,ee),r.setUniform3fv("localOrigin",e),r.setUniformMatrix4fv("view",ee)}function G(e,t,r){r.setUniform3f("camPos",t[3]-e[0],t[7]-e[1],t[11]-e[2])}function W(e,t,r){if(e){var n=D(e,t.fovY,t.viewport[3]);r.setUniform4f("verticalOffset",n.screenLength,n.perDistance,n.minWorldLength,n.maxWorldLength)}}function D(e,t,r,n){return void 0===n&&(n=te),n.screenLength=e.screenLength,n.perDistance=Math.tan(.5*t)/(.5*r),n.minWorldLength=e.minWorldLength,n.maxWorldLength=e.maxWorldLength,n}function R(e,t,r){if(void 0===r&&(r="screenSizePerspectiveAlignment"),e){var n=e.parameters,i=e.paddingPixelsOverride;t.setUniform4f(r,n.divisor,n.offset,n.minPixelSize,i)}}function N(e,r){var n=t.__GLMaterial_id++;e.getId=function(){return n},e.getMaterialId=function(){return r.getId()},e.isVisible=function(){return r.isVisible()},e.isRenderOccluded=function(){return r.isRenderOccluded()},e.getRenderPriority=function(){return r.getRenderPriority()}}function k(e,t,r,n){var i=V(r.textureId,r.initTexture,t,n);e.updateTexture=function(e){r.textureId!==e&&(_(r.textureId,t),r.textureId=e,i=V(r.textureId,r.initTexture,t,n))},e.renderTexture=function(e){var n=t.getTexture(r.textureId);n&&n.dirty&&n.redraw&&n.redraw()},e.bindTexture=function(e,t){void 0!==i&&(t.setUniform1i("tex",0),e.bindTexture(i.getGLTexture()))},e.bindTextureSize=function(e,t){if(void 0!==i){var r=i.getGLTexture();t.setUniform2f("texSize",r.descriptor.width,r.descriptor.height)}},e.dispose=function(){_(r.textureId,t)}}function E(e,t,r,n){for(var i=n.length,a=new Array(i),o=0;i>o;o++)a[o]=V(r[n[o][0]],r[n[o][1]],t);e.updateTextures=function(e){for(var o=0;i>o;o++){var u=r[n[o][0]],f=e[n[o][0]];u!==f&&(_(u,t),r[n[o][0]]=f,a[o]=V(f,r[n[o][1]],t))}},e.bindTextures=function(e,t){for(var r=0;i>r;r++)void 0!==a[r]&&(t.setUniform1i(n[r][2],r),e.bindTexture(a[r].getGLTexture(),r));e.setActiveTexture(0)},e.bindOneTexture=function(e,t,r){t.setUniform1i(n[r][2],r),e.bindTexture(a[r].getGLTexture(),r),e.setActiveTexture(0)},e.disposeTextures=function(){for(var e=0;i>e;e++)_(r[n[e][0]],t)}}function q(e,t){var r=t?q(t):{};for(var n in e){var i=e[n];i&&i.forEach&&(i=j(i)),null==i&&n in r||(r[n]=i)}return r}function Y(e,t){var r=!1;for(var n in t){var i=t[n];void 0!==i&&(r=!0,Array.isArray(i)?e[n]=i.slice():e[n]=i)}return r}function j(e){var t=[];return e.forEach(function(e){return t.push(e)}),t}Object.defineProperty(t,"__esModule",{value:!0});var H=n.mat4d.create(),F=c.create(),J=a.VertexAttrConstants;t.__Material_idGen=new r,t.__GLMaterial_id=0,t.IDENTITY=n.mat4d.identity(),t.fill=s,t.fillInterleaved=h,t.triangleVertexArrayToWireframeLines=p,t.intersectTriangleGeometry=M;var K=n.vec3d.create(),Q=Math.pow(2,-52),X=n.vec3d.create(),Z=n.vec3d.create(),$=n.vec3d.create();t.transformToWorld=A,t.transformToView=C,t.transformToProjection=O,t.transformToNDC=S,t.applyScreenSizePerspectiveScale=U,t.verticalOffsetAtDistance=w,t.basicMaterialConstructor=z,t.aquireIfNotUndefined=V,t.releaseIfNotUndefined=_;var ee=n.mat4.create();t.bindView=B,t.bindCamPos=G,t.bindVerticalOffset=W,t.bindScreenSizePerspective=R,t.basicGLMaterialConstructor=N,t.singleTextureGLMaterialConstructor=k,t.multiTextureGLMaterialConstructor=E,t.copyParameters=q,t.updateParameters=Y,t.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var te={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0}});