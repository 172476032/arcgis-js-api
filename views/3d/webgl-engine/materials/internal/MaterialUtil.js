// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../support/aaBoundingBox","../../lib/ComponentUtils","../../lib/gl-matrix","../../lib/screenSizePerspectiveUtils","../../lib/Util","../../../../webgl/Util"],function(e,t,r,n,i,a,o,f){function c(e,t,r,n,i){var a=e[t],o=e[t+1],f=e[t+2];r[n]=i[0]*a+i[4]*o+i[8]*f+i[12],r[n+1]=i[1]*a+i[5]*o+i[9]*f+i[13],r[n+2]=i[2]*a+i[6]*o+i[10]*f+i[14]}function l(e,t,r,n,i,a){if(void 0===i||3!==a)for(var o=0;o<a;++o)r[n+o]=e[t+o];else c(e,t,r,n,i);return a}function s(e,t,r,n,i){for(var a=0;a<i;++a)r[n+a]=e[t+a];return i}function v(e,t,r,n,i,a){for(var o=e.length,f=0;f<o;++f){var c=3*e[f],l=t[c],s=t[c+1],v=t[c+2];n[i]=r[0]*l+r[4]*s+r[8]*v+r[12],n[i+1]=r[1]*l+r[5]*s+r[9]*v+r[13],n[i+2]=r[2]*l+r[6]*s+r[10]*v+r[14],i+=a}}function u(e,t,r,n,i,a){for(var o=e.length,f=0;f<o;++f){for(var c=r*e[f],l=0;l<r;++l)n[i+l]=t[c+l];i+=a}}function d(e,t,r,n,i,a){var o=new Uint8Array(n);i*=4,a*=4;var f=e.length;if(4===r)for(var c=0;c<f;++c){var l=4*e[c];o[i]=t[l],o[i+1]=t[l+1],o[i+2]=t[l+2],o[i+3]=t[l+3],i+=a}else if(3===r)for(var c=0;c<f;++c){var l=3*e[c];o[i]=t[l],o[i+1]=t[l+1],o[i+2]=t[l+2],o[i+3]=255,i+=a}}function m(e,t,r,n,i,a,o){var f=new Uint8Array(i);a*=4,o*=4;var c=e.length;if(4===n)for(var l=0;l<c;++l){var s=4*e[l];f[a]=t[s]*r[0],f[a+1]=t[s+1]*r[1],f[a+2]=t[s+2]*r[2],f[a+3]=t[s+3]*r[3],a+=o}else if(3===n)for(var v=255*r[3],l=0;l<c;++l){var s=3*e[l];f[a]=t[s]*r[0],f[a+1]=t[s+1]*r[1],f[a+2]=t[s+2]*r[2],f[a+3]=v,a+=o}}function g(e,t,r,n,i,a){var o=new Uint16Array(n);i*=2,a*=2;for(var f=e.length,c=0;c<f;++c){for(var l=r*e[c],s=0;s<r;++s)o[i+s]=t[l+s];i+=a}}function h(e,t,r,n,i,a,o,c){for(var l=f.getStride(i)/4,s=0;s<i.length;s++){var h=i[s],p=o+h.offset/4,M=h.name,x=e.vertexAttr[M];if(null!=x&&(null==c||null!=c[M]))switch(M){case"uv0":u(e.indices[M],x.data,x.size,a,p,l);break;case"region":g(e.indices[M],x.data,x.size,a.buffer,p,l);break;case"color":n&&n.color?m(e.indices[M],x.data,n.color,x.size,a.buffer,p,l):d(e.indices[M],x.data,x.size,a.buffer,p,l);break;case"symbolColor":d(e.indices[M],x.data,x.size,a.buffer,p,l);break;default:var b=M===_.POSITION?t:M===_.NORMAL?r:void 0;void 0!==b&&3===x.size?v(e.indices[M],x.data,b,a,p,l):u(e.indices[M],x.data,x.size,a,p,l)}}}function p(e,t,r,n){for(var i=Math.floor(r/3),a=i-1;a>=0;a--){var o=t+3*a*n,f=t+3*a*2*n+5*n;l(e,o,e,f,null,n),f-=n,l(e,o+n,e,f,null,n),f-=n,l(e,o+n,e,f,null,n),f-=n,l(e,o+2*n,e,f,null,n),f-=n,l(e,o+2*n,e,f,null,n),f-=n,l(e,o,e,f,null,n)}}function M(e,t,r,i,a,f,c){o.assert("triangle"===e.data.primitiveType);var l=t.componentVisibilities,s=i.tolerance,v=e.getBoundingInfo();e.getComponentCount()>1?b(e,v,l,a,f,s,c):n.getVisibility(l,0)&&x(v,a,f,s,c)}function x(e,t,n,i,a){var o=I(t,n,G);if(r.setMin(j,e.getBBMin()),r.setMax(j,e.getBBMax()),P(j,t,o,i)){var f=e.getPrimitiveIndices(),c=e.getIndices(),l=e.getPosition(),s=f?f.length:c.length/3;if(s>1e4){var v=e.getChildren();if(void 0!==v){for(var u=0;u<8;++u)void 0!==v[u]&&x(v[u],t,n,i,a);return}}y(t,n,0,s,c,l,f,a)}}function b(e,t,i,a,o,f,c){var l=I(a,o,G);if(r.setMin(j,t.getBBMin()),r.setMax(j,t.getBBMax()),P(j,a,l,f))for(var s=e.data,v=e.getComponentCount(),u=s.getIndices(_.POSITION),d=s.getAttribute(_.POSITION),m=s.componentOffsets,g=0;g<v;g++)if(n.getVisibility(i,g)){var h=e.getComponentAABB(g,j);if(P(h,a,l,f)){var p=m[g]/3,M=m[g+1]/3;y(a,o,p,M,u,d,void 0,c)}}}function y(e,t,r,n,i,a,o,f){for(var c=a.data,l=a.offsetIdx,s=a.strideIdx,v=e[0],u=e[1],d=e[2],m=t[0],g=t[1],h=t[2],p=m-v,M=g-u,x=h-d,b=r;b<n;b++){var y=o?o[b]:b,I=l+s*i[3*y],P=l+s*i[3*y+1],A=l+s*i[3*y+2],O=c[I],U=c[I+1],z=c[I+2],B=c[P],W=c[P+1],C=c[P+2],S=c[A],T=c[A+1],w=c[A+2],V=B-O,N=W-U,D=C-z,k=S-O,q=T-U,E=w-z,Y=M*E-q*x,j=x*k-E*p,_=p*q-k*M,G=V*Y+N*j+D*_,F=v-O,J=u-U,K=d-z,Q=J*D-N*K,X=K*V-D*F,Z=F*N-V*J;if(G>H){var $=F*Y+J*j+K*_;if($<0||$>G)continue;var ee=p*Q+M*X+x*Z;if(ee<0||$+ee>G)continue}else{if(!(G<-H))continue;var $=F*Y+J*j+K*_;if($>0||$<G)continue;var ee=p*Q+M*X+x*Z;if(ee>0||$+ee<G)continue}var te=(k*Q+q*X+E*Z)/G;if(te>=0){f(te,L(V,N,D,k,q,E,R),y)}}}function L(e,t,r,n,a,o,f){return i.vec3d.set3(e,t,r,F),i.vec3d.set3(n,a,o,J),i.vec3d.normalize(i.vec3d.cross(F,J,f))}function I(e,t,r){return i.vec3d.set3(1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]),r)}function P(e,t,r,n){var i=(e[0]-n-t[0])*r[0],a=(e[3]+n-t[0])*r[0],o=Math.min(i,a),f=Math.max(i,a),c=(e[1]-n-t[1])*r[1],l=(e[4]+n-t[1])*r[1];if(o=Math.max(o,Math.min(c,l)),f=Math.min(f,Math.max(c,l)),o>f)return!1;var s=(e[2]-n-t[2])*r[2],v=(e[5]+n-t[2])*r[2];return o=Math.max(o,Math.min(s,v)),f=Math.min(f,Math.max(s,v)),o<=f}function A(e,t,r){return i.vec4d.set4(e[0]-t[0],e[1]-t[1],e[2]-t[2],1,r)}function O(e,t,r,n){return i.mat4d.translate(r,t,Y),r=Y,i.mat4d.multiplyVec4(r,e,n)}function U(e,t,r,n){return n[0]=e[0]+r[0],n[1]=e[1]+r[1],n[2]=e[2]+r[2],n[3]=e[3],i.mat4d.multiplyVec4(t,n)}function z(e,t){return i.vec4d.scale(e,1/Math.abs(e[3]),t)}function B(e,t,r,n,i){return a.scale(e,n,r,i)}function W(e,t,r,n,i){var a=r.screenLength||0;i&&(a=B(a,e,t,n,i));var f=a*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return o.clamp(f*t,r.minWorldLength||0,null!=r.maxWorldLength?r.maxWorldLength:1/0)}function C(e,t,r){if(void 0!==e)return t.aquire(e,r)}function S(e,t){void 0!==e&&t.release(e)}function T(e,t,r){i.mat4d.translate(t,e,K),r.setUniform3fv("localOrigin",e),r.setUniformMatrix4fv("view",K)}function w(e,t,r){r.setUniform3f("camPos",t[3]-e[0],t[7]-e[1],t[11]-e[2])}function V(e,t,r){if(e){var n=N(e,t.fovY,t.viewport[3]);r.setUniform4f("verticalOffset",n.screenLength,n.perDistance,n.minWorldLength,n.maxWorldLength)}}function N(e,t,r,n){return void 0===n&&(n=Q),n.screenLength=e.screenLength,n.perDistance=Math.tan(.5*t)/(.5*r),n.minWorldLength=e.minWorldLength,n.maxWorldLength=e.maxWorldLength,n}function D(e,t,r){if(void 0===r&&(r="screenSizePerspectiveAlignment"),e){var n=e.parameters,i=e.paddingPixelsOverride;t.setUniform4f(r,n.divisor,n.offset,n.minPixelSize,i)}}function k(e,t){var r=t?k(t):{};for(var n in e){var i=e[n];i&&i.forEach&&(i=E(i)),null==i&&n in r||(r[n]=i)}return r}function q(e,t){var r=!1;for(var n in t){var i=t[n];void 0!==i&&(r=!0,Array.isArray(i)?e[n]=i.slice():e[n]=i)}return r}function E(e){var t=[];return e.forEach(function(e){return t.push(e)}),t}Object.defineProperty(t,"__esModule",{value:!0});var Y=i.mat4d.create(),j=r.create(),_=o.VertexAttrConstants;t.IDENTITY=i.mat4d.identity(),t.fill=l,t.fillColor=s,t.fillInterleaved=h,t.triangleVertexArrayToWireframeLines=p,t.intersectTriangleGeometry=M;var G=i.vec3d.create(),H=Math.pow(2,-52),R=i.vec3d.create(),F=i.vec3d.create(),J=i.vec3d.create();t.transformToWorld=A,t.transformToView=O,t.transformToProjection=U,t.transformToNDC=z,t.applyScreenSizePerspectiveScale=B,t.verticalOffsetAtDistance=W,t.aquireIfNotUndefined=C,t.releaseIfNotUndefined=S;var K=i.mat4.create();t.bindView=T,t.bindCamPos=w,t.bindVerticalOffset=V,t.bindScreenSizePerspective=D,t.copyParameters=k,t.updateParameters=q,t.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var Q={screenLength:0,perDistance:0,minWorldLength:0,maxWorldLength:0}});