// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","dojo/has","../../../core/libs/gl-matrix/mat4","../../../core/libs/gl-matrix/vec4","../../../core/libs/gl-matrix/vec3","../../webgl/VertexArrayObject","../GeometryUtils","./rendererUtils","../../webgl/ShaderVariations","./vtShaderSnippets"],function(e,t,r,i,a,o,s,n,f,l,_){var u=1/65536,d=function(){function e(){this._attributeLocations={a_pos:0,a_vertexOffset:1,a_tex:2,a_levelInfo:3},this._attributeLocationsDD={a_pos:0,a_vertexOffset:1,a_tex:2,a_levelInfo:3,a_color:4,a_size:5},this._initialized=!1,this._viewProjMat=i.create(),this._offsetVector=o.create(),this._extrudeMat=i.create(),this._haloColor=a.create(),this._sdfColor=a.create(),this._scaleVec=o.create()}return e.prototype.dispose=function(){},e.prototype.render=function(e,t,a,o,s,l,_,d,h,c,m,x,v){var y=this;if(!r("esri-vector-tiles-avoid-text")){this._initialized||this._initialize(e);var p=24,g=8,D=p/g,V=d.getLayoutValue("text-size",a),b=n.degToByte(s),U=d.getLayoutValue("text-rotation-alignment",a);2===U&&(U=1===d.getLayoutValue("symbol-placement",a)?0:1);var z=0===U,A=d.getLayoutValue("text-keep-upright",a)&&z,M=3===o,O=.8*D/x,w=v*d.getPaintValue("text-opacity",a);this._glyphTextureSize||(this._glyphTextureSize=new Float32Array([h.width/4,h.height/4]));var C=_.tileTransform.transform,P=d.getPaintValue("text-translate",a);if(0!==P[0]||0!==P[1]){i.copy(this._viewProjMat,_.tileTransform.transform);var j=P[0],L=P[1],S=0,I=0,T=512,B=_.coordRange/T,E=(1<<_.key.level)/Math.pow(2,a)*B,F=d.getPaintValue("text-translate-anchor",a);if(1===F){var k=-n.C_DEG_TO_RAD*s,R=Math.sin(k),G=Math.cos(k);S=E*(j*G-L*R),I=E*(j*R+L*G)}else S=E*j,I=E*L;this._offsetVector[0]=S,this._offsetVector[1]=I,this._offsetVector[2]=0,i.translate(this._viewProjMat,this._viewProjMat,this._offsetVector),C=this._viewProjMat}z?i.copy(this._extrudeMat,c):i.copy(this._extrudeMat,m),this._scaleVec[0]=1/p,this._scaleVec[1]=1/p,this._scaleVec[2]=1,i.scale(this._extrudeMat,this._extrudeMat,this._scaleVec);var q=d.hasDataDrivenText,W=this._getSDFVAO(e,_,q);if(W){e.bindVAO(W);var H=this._shaderVariations.getProgram([q,M],void 0,void 0,q?this._attributeLocationsDD:this._attributeLocations);if(e.bindProgram(H),H.setUniformMatrix4fv("u_transformMatrix",C),H.setUniformMatrix4fv("u_extrudeMatrix",this._extrudeMat),H.setUniform2fv("u_normalized_origin",_.tileTransform.displayCoord),H.setUniform1f("u_depth",d.z+u),H.setUniform2fv("u_mosaicSize",this._glyphTextureSize),H.setUniform1f("u_mapRotation",b),H.setUniform1f("u_keepUpright",A?1:0),H.setUniform1f("u_level",10*a),H.setUniform1f("u_fadeSpeed",10*l.fadeSpeed),H.setUniform1f("u_minfadeLevel",10*l.minfadeLevel),H.setUniform1f("u_maxfadeLevel",10*l.maxfadeLevel),H.setUniform1f("u_fadeChange",10*(a+l.fadeChange)),H.setUniform1f("u_opacity",w),H.setUniform1i("u_texture",0),H.setUniform1f("u_size",V),H.setUniform1f("u_antialiasingWidth",O),M){var J=f.int32To4Bytes(t.layerID);H.setUniform4f("u_id",J[0],J[1],J[2],J[3])}t.glyphPerPageElementsMap.forEach(function(t,r){h.bind(e,9729,r,0);var i=d.getPaintValue("text-halo-color",a),o=d.getPaintValue("text-halo-width",a);if(i[3]>0&&o>0){var s=i[3]*w;y._haloColor[0]=s*i[0],y._haloColor[1]=s*i[1],y._haloColor[2]=s*i[2],y._haloColor[3]=s;var n=d.getPaintValue("text-halo-blur",a)*D,f=o*D;H.setUniform4fv("u_color",y._haloColor),H.setUniform1f("u_halo",1),H.setUniform1f("u_edgeDistance",f),H.setUniform1f("u_edgeBlur",n),e.drawElements(4,t[1],5125,12*t[0])}var l=d.getPaintValue("text-color",a);if(l[3]>0){var _=l[3]*w;y._sdfColor[0]=_*l[0],y._sdfColor[1]=_*l[1],y._sdfColor[2]=_*l[2],y._sdfColor[3]=_,H.setUniform4fv("u_color",y._sdfColor),H.setUniform1f("u_halo",0),H.setUniform1f("u_edgeDistance",0),H.setUniform1f("u_edgeBlur",0),e.drawElements(4,t[1],5125,12*t[0])}}),e.bindVAO()}}},e.prototype._initialize=function(e){if(this._initialized)return!0;var t=new l("text",["textVS","textFS"],[],_,e);return t.addDefine("DD","DD",[!0,!1],"DD"),t.addDefine("ID","ID",[!0,!0],"ID"),this._shaderVariations=t,this._vertexAttributes={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:16,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:16,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:16,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:16,normalized:!1,divisor:0}]},this._vertexAttributesDD={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:24,normalized:!1,divisor:0},{name:"a_vertexOffset",count:2,type:5122,offset:4,stride:24,normalized:!1,divisor:0},{name:"a_tex",count:4,type:5121,offset:8,stride:24,normalized:!1,divisor:0},{name:"a_levelInfo",count:4,type:5121,offset:12,stride:24,normalized:!1,divisor:0},{name:"a_color",count:4,type:5121,offset:16,stride:24,normalized:!0,divisor:0},{name:"a_size",count:1,type:5126,offset:20,stride:24,normalized:!1,divisor:0}]},this._initialized=!0,!0},e.prototype._getSDFVAO=function(e,t,r){if(r){if(t.textDDVertexArrayObject)return t.textDDVertexArrayObject;var i=t.textDDVertexBuffer,a=t.textIndexBuffer;return i&&a?(t.textDDVertexArrayObject=new s(e,this._attributeLocationsDD,this._vertexAttributesDD,{geometry:i},a),t.textDDVertexArrayObject):null}if(t.textVertexArrayObject)return t.textVertexArrayObject;var i=t.textVertexBuffer,a=t.textIndexBuffer;return i&&a?(t.textVertexArrayObject=new s(e,this._attributeLocations,this._vertexAttributes,{geometry:i},a),t.textVertexArrayObject):null},e}();return d});