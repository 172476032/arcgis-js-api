// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/extendsHelper","../../core/tsSupport/decorateHelper","../../core/ArrayPool","./Bucket","../2d/engine/webgl/Geometry","../../core/libs/earcut/earcut"],function(e,t,n,r,o,i,l,a){var u=function(e){function t(t,n,r,o,i,l){var a=e.call(this,t,n)||this;return a.polygonVertexBuffer=r,a.polygonIndexBuffer=o,a.polygonOutlineVertexBuffer=i,a.polygonOutlineIndexBuffer=l,a}return n(t,e),Object.defineProperty(t.prototype,"polygonIndexStart",{get:function(){return this._triangleElementsStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"polygonIndexCount",{get:function(){return this._triangleElementsNum},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"polygonOutlineIndexStart",{get:function(){return this._outlineElementsStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"polygonOutlineIndexCount",{get:function(){return this._outlineElementsNum},enumerable:!0,configurable:!0}),t.prototype.assignBufferInfo=function(e){var t=e;t._triangleElementsStart=this._triangleElementsStart,t._triangleElementsNum=this._triangleElementsNum;var n=e.layer.hasPaintProperty("fill-outline-color");n?(t._outlineElementsStart=this._outlineElementsStart,t._outlineElementsNum=this._outlineElementsNum):(t._outlineElementsStart=0,t._outlineElementsNum=0)},t.prototype.processFeatures=function(e,t){this._triangleElementsStart=this.polygonIndexBuffer.index,this._triangleElementsNum=0,this._outlineElementsStart=this.polygonOutlineIndexBuffer.index,this._outlineElementsNum=0,e&&e.setExtent(this.layerExtent);for(var n=this.layer.getPaintValue("fill-pattern",this.zoom),r=this.layer.getPaintValue("fill-antialias",this.zoom)&&void 0===n,o=0,i=this._features;o<i.length;o++){var l=i[o],a=l.getGeometry(e);this._processFeature(a,r)}},t.prototype._processFeature=function(e,n){if(e){var r=e.length;if(n)for(var o=0;r>o;o++)this._processOutline(e[o]);for(var i,l=128,o=0;r>o;o++){var a=t._area(e[o]);a>l?(void 0!==i&&this._processFill(e,i),i=[o]):-l>a&&void 0!==i&&i.push(o)}void 0!==i&&this._processFill(e,i)}},t.prototype._processOutline=function(e){var t,n,r,o=this.polygonOutlineVertexBuffer,i=this.polygonOutlineIndexBuffer,a=i.index,u=new l.Point(0,0),s=new l.Point(0,0),d=new l.Point(0,0),f=-1,y=-1,p=-1,g=-1,h=-1,x=0,c=e.length;if(!(2>c)){for(var m=e[x],_=e[c-1];c&&_.isEqual(m);)--c,_=e[c-1];if(!(2>c-x)){for(var v=x;c>v;++v){v===x?(t=e[c-1],n=e[x],r=e[x+1],u.assignSub(n,t),u.normalize(),u.rightPerpendicular()):(t=n,n=r,r=v!==c-1?e[v+1]:e[x],u.assign(s)),s.assignSub(r,n),s.normalize(),s.rightPerpendicular();var E=u.x*s.y-u.y*s.x;d.assignAdd(u,s),d.normalize();var b=-d.x*-u.x+-d.y*-u.y,S=Math.abs(0!==b?1/b:1);S>8&&(S=8),E>=0?(p=o.add(n.x,n.y,u.x,u.y,0,1),-1===g&&(g=p),f>=0&&y>=0&&p>=0&&i.add(f,y,p),y=o.add(n.x,n.y,S*-d.x,S*-d.y,0,-1),-1===h&&(h=y),f>=0&&y>=0&&p>=0&&i.add(f,y,p),f=y,y=p,p=o.add(n.x,n.y,d.x,d.y,0,1),f>=0&&y>=0&&p>=0&&i.add(f,y,p),y=o.add(n.x,n.y,s.x,s.y,0,1),f>=0&&y>=0&&p>=0&&i.add(f,y,p)):(p=o.add(n.x,n.y,S*d.x,S*d.y,0,1),-1===g&&(g=p),f>=0&&y>=0&&p>=0&&i.add(f,y,p),y=o.add(n.x,n.y,-u.x,-u.y,0,-1),-1===h&&(h=y),f>=0&&y>=0&&p>=0&&i.add(f,y,p),f=y,y=p,p=o.add(n.x,n.y,-d.x,-d.y,0,-1),f>=0&&y>=0&&p>=0&&i.add(f,y,p),f=o.add(n.x,n.y,-s.x,-s.y,0,-1),f>=0&&y>=0&&p>=0&&i.add(f,y,p))}f>=0&&y>=0&&g>=0&&i.add(f,y,g),f>=0&&g>=0&&h>=0&&i.add(f,h,g),this._outlineElementsNum+=3*(i.index-a)}}},t.prototype._processFill=function(e,t){var n,r=t.length;r>1&&(n=[]);for(var i=0,l=0,u=t;l<u.length;l++){var s=u[l];0!==i&&n.push(i),i+=e[s].length}for(var d=2*i,f=o.acquire(),y=0,p=t;y<p.length;y++)for(var s=p[y],g=e[s],h=g.length,x=0;h>x;++x)f.push(g[x].x),f.push(g[x].y);var c=a(f,n,2),m=c.length;if(m>0){for(var _=this.polygonVertexBuffer.index,v=0;d>v;)this.polygonVertexBuffer.add(f[v++],f[v++]);for(var E=0;m>E;)this.polygonIndexBuffer.add(_+c[E++],_+c[E++],_+c[E++]);this._triangleElementsNum+=m}o.release(f)},t._area=function(e){for(var t=0,n=e.length-1,r=0;n>r;r++)t+=(e[r].x-e[r+1].x)*(e[r].y+e[r+1].y);return t+=(e[n].x-e[0].x)*(e[n].y+e[0].y),.5*t},t}(i);return u});