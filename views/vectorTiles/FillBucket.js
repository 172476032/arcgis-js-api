// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/extendsHelper","../../core/tsSupport/decorateHelper","../../core/ArrayPool","./Bucket","../2d/engine/webgl/Geometry","../../core/libs/earcut/earcut"],function(e,t,r,i,n,o,a,l){var u=function(e){function t(t,r,i,n,o,a){var l=e.call(this,t,r)||this;if(t.hasDataDrivenFill!==i.isDataDriven())throw new Error("incompatible fill buffer");if(t.hasDataDrivenOutline!==o.isDataDriven())throw new Error("incompatible outline buffer");return l._fillVertexBuffer=i,l._fillIndexBuffer=n,l._outlineVertexBuffer=o,l._outlineIndexBuffer=a,l}return r(t,e),Object.defineProperty(t.prototype,"fillIndexStart",{get:function(){return this._fillIndexStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fillIndexCount",{get:function(){return this._fillIndexCount},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"outlineIndexStart",{get:function(){return this._outlineIndexStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"outlineIndexCount",{get:function(){return this._outlineIndexCount},enumerable:!0,configurable:!0}),t.prototype.assignBufferInfo=function(e){var t=e;t._fillIndexStart=this._fillIndexStart,t._fillIndexCount=this._fillIndexCount;var r=e.layer.getPaintProperty("fill-outline-color");r?(t._outlineIndexStart=this._outlineIndexStart,t._outlineIndexCount=this._outlineIndexCount):(t._outlineIndexStart=0,t._outlineIndexCount=0)},t.prototype.processFeatures=function(e,t){this._fillIndexStart=this._fillIndexBuffer.index,this._fillIndexCount=0,this._outlineIndexStart=this._outlineIndexBuffer.index,this._outlineIndexCount=0;var r=this.layer,i=this.zoom,n=r.hasDataDrivenFill,o=r.hasDataDrivenOutline;e&&e.setExtent(this.layerExtent);for(var a=r.getPaintValue("fill-pattern",i),l=r.getPaintValue("fill-antialias",i)&&void 0===a,u=0,f=this._features;u<f.length;u++){var d=f[u],s=void 0;n&&(s={color:a?[1,1,1,1]:r.getPaintValue("fill-color",i,d),opacity:r.getPaintValue("fill-opacity",i,d)});var x=void 0;o&&(x={color:a?[1,1,1,1]:r.getPaintValue("fill-outline-color",i,d),opacity:r.getPaintValue("fill-opacity",i,d)});var h=d.getGeometry(e);this._processFeature(h,l,s,x)}},t.prototype._processFeature=function(e,r,i,n){if(e){var o=e.length;if(r)for(var a=0;o>a;a++)this._processOutline(e[a],n);for(var l,u=128,a=0;o>a;a++){var f=t._area(e[a]);f>u?(void 0!==l&&this._processFill(e,l,i),l=[a]):-u>f&&void 0!==l&&l.push(a)}void 0!==l&&this._processFill(e,l,i)}},t.prototype._processOutline=function(e,t){var r,i,n,o=this._outlineVertexBuffer,l=this._outlineIndexBuffer,u=l.index,f=new a.Point(0,0),d=new a.Point(0,0),s=new a.Point(0,0),x=-1,h=-1,p=-1,y=-1,c=-1,_=!1,v=0,g=e.length;if(!(2>g)){for(var I=e[v],b=e[g-1];g&&b.isEqual(I);)--g,b=e[g-1];if(!(2>g-v)){for(var P=v;g>P;++P){P===v?(r=e[g-1],i=e[v],n=e[v+1],f.assignSub(i,r),f.normalize(),f.rightPerpendicular()):(r=i,i=n,n=P!==g-1?e[P+1]:e[v],f.assign(d));var C=this._isClipEdge(r,i);-1===y&&(_=C),d.assignSub(n,i),d.normalize(),d.rightPerpendicular();var S=f.x*d.y-f.y*d.x;s.assignAdd(f,d),s.normalize();var B=-s.x*-f.x+-s.y*-f.y,m=Math.abs(0!==B?1/B:1);m>8&&(m=8),S>=0?(p=o.add(i.x,i.y,f.x,f.y,0,1,t),-1===y&&(y=p),x>=0&&h>=0&&p>=0&&!C&&l.add(x,h,p),h=o.add(i.x,i.y,m*-s.x,m*-s.y,0,-1,t),-1===c&&(c=h),x>=0&&h>=0&&p>=0&&!C&&l.add(x,h,p),x=h,h=p,p=o.add(i.x,i.y,s.x,s.y,0,1,t),x>=0&&h>=0&&p>=0&&!C&&l.add(x,h,p),h=o.add(i.x,i.y,d.x,d.y,0,1,t),x>=0&&h>=0&&p>=0&&!C&&l.add(x,h,p)):(p=o.add(i.x,i.y,m*s.x,m*s.y,0,1,t),-1===y&&(y=p),x>=0&&h>=0&&p>=0&&!C&&l.add(x,h,p),h=o.add(i.x,i.y,-f.x,-f.y,0,-1,t),-1===c&&(c=h),x>=0&&h>=0&&p>=0&&!C&&l.add(x,h,p),x=h,h=p,p=o.add(i.x,i.y,-s.x,-s.y,0,-1,t),x>=0&&h>=0&&p>=0&&!C&&l.add(x,h,p),x=o.add(i.x,i.y,-d.x,-d.y,0,-1,t),x>=0&&h>=0&&p>=0&&!C&&l.add(x,h,p))}x>=0&&h>=0&&y>=0&&!_&&l.add(x,h,y),x>=0&&y>=0&&c>=0&&!_&&l.add(x,c,y),this._outlineIndexCount+=3*(l.index-u)}}},t.prototype._processFill=function(e,t,r){var i,o=t.length;o>1&&(i=[]);for(var a=0,u=0,f=t;u<f.length;u++){var d=f[u];0!==a&&i.push(a),a+=e[d].length}for(var s=2*a,x=n.acquire(),h=0,p=t;h<p.length;h++)for(var d=p[h],y=e[d],c=y.length,_=0;c>_;++_)x.push(y[_].x),x.push(y[_].y);var v=l(x,i,2),g=v.length;if(g>0){for(var I=this._fillVertexBuffer.index,b=0;s>b;)this._fillVertexBuffer.add(x[b++],x[b++],r);for(var P=0;g>P;)this._fillIndexBuffer.add(I+v[P++],I+v[P++],I+v[P++]);this._fillIndexCount+=g}n.release(x)},t.prototype._isClipEdge=function(e,t){return e.x===t.x?e.x<=-64||e.x>=4160:e.y===t.y?e.y<=-64||e.y>=4160:!1},t._area=function(e){for(var t=0,r=e.length-1,i=0;r>i;i++)t+=(e[i].x-e[i+1].x)*(e[i].y+e[i+1].y);return t+=(e[r].x-e[0].x)*(e[r].y+e[0].y),.5*t},t}(o);return u});