// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../2d/engine/webgl/Geometry","./GeometryUtils","./Conflict"],function(t,e,n,i,o){Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,i,o){void 0===n&&(n=0),void 0===i&&(i=-1),void 0===o&&(o=c),this.x=t,this.y=e,this.angle=n,this.segment=i,this.minzoom=o}return t}();e.Anchor=r;var a=function(){function t(t,e,n,i){this.glyph=t,this.x=e,this.y=n,this.glyphItem=i}return t}();e.ShapedGlyph=a;var l=function(){function t(t,e,n,o,r,a,l){void 0===r&&(r=!1),void 0===a&&(a=c),void 0===l&&(l=i.C_INFINITY),this.anchor=t,this.labelAngle=e,this.glyphAngle=n,this.page=o,this.upsideDown=r,this.minzoom=a,this.maxzoom=l}return t}(),h=function(){function t(t,e,n,i,o,r,a,l,h,s){this.tl=t,this.tr=e,this.bl=n,this.br=i,this.mosaicRect=o,this.labelAngle=r,this.anchor=a,this.minzoom=l,this.maxzoom=h,this.page=s}return t}();e.PlacedSymbol=h;var s=function(){function t(t,e){this.footprint=t,this.shapes=e}return t}();e.Placement=s;var c=.5,p=2,g=function(){function t(){this.mapAngle=0,this._conflictEngine=new o.ConflictEngine}return t.prototype.reset=function(){this._conflictEngine.reset()},t.prototype.setAngle=function(t){this.mapAngle=t,this._conflictEngine.setAngle(t)},t.prototype.getIconPlacement=function(t,e,r,a,l,p,g){var f=r.width/(r.sdfRatio*r.pixelRatio),m=r.height/(r.sdfRatio*r.pixelRatio),u=p.offset[0]-f/2,I=p.offset[1]-m/2,d=u+f,y=I+m,x=r.rect,_=r.sdf?17:2,w=_/r.sdfRatio,v=u-w,N=I-w,P=v+x.width/(r.pixelRatio*r.sdfRatio),A=N+x.height/(r.pixelRatio*r.sdfRatio),E=new n.Point(v,N),T=new n.Point(P,A),b=new n.Point(v,A),C=new n.Point(P,N),M=p.rotate*i.C_DEG_TO_RAD,z=1===p.rotationAlignment;if(t.segment>=0&&!z&&(M+=t.angle),0!==M){var F=Math.cos(M),R=Math.sin(M);E.rotate(F,R),T.rotate(F,R),b.rotate(F,R),C.rotate(F,R)}var G=8,Y=p.padding*G,B=new n.Point(t.x,t.y),O=new o.Footprint(this.mapAngle,Y,z);O.addBox(B,new o.Box(u,I,d,y),a,M,e,c,i.C_INFINITY);var D=new h(E,C,b,T,x,0,B,c,i.C_INFINITY,0),q=new s(O,[D]),S=c;return p.allowOverlap||(S=this._conflictEngine.getMinZoom(q.footprint,S,g,z)),O.minzoom=S,q},t.prototype.getTextPlacement=function(t,e,r,a,g,f,m,u){for(var I,d=new n.Point(t.x,t.y),y=m.rotate*i.C_DEG_TO_RAD,x=0===m.rotationAlignment,_=m.keepUpright,w=c,v=!x,N=v?0:t.angle,P=t.segment>=0&&x,A=8,E=m.padding*A,T=new o.Footprint(this.mapAngle,E,v),b=[],C=4,M=!P,z=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,R=z,G=F,Y=P?_:x&&_,B=0,O=a;B<O.length;B++){var D=O[B],q=D.glyphItem;if(q&&!q.rect.isEmpty){var S=q.rect,V=q.metrics,k=q.page;M&&(I&&I!==D.y&&(T.addBox(d,new o.Box(z,R,F,G),g,y,e,c,i.C_INFINITY),z=Number.POSITIVE_INFINITY,F=Number.NEGATIVE_INFINITY,R=z,G=F),I=D.y);var U=[];if(P){var Z=.5*q.metrics.width,j=(r.x+D.x+V.left-C+Z)*g;if(w=this._placeGlyph(t,w,j,f,t.segment,1,k,U),_&&(w=this._placeGlyph(t,w,j,f,t.segment,-1,k,U)),w>=p)break}else U.push(new l(d,N,N,k)),x&&_&&U.push(new l(d,N+i.C_PI,N+i.C_PI,k,!0));for(var H=D.x+r.x+V.left,J=D.y+r.y-V.top,K=H+V.width,L=J+V.height,Q=new n.Point(H-C,J-C),W=new n.Point(Q.x+S.width,Q.y+S.height),X=new n.Point(Q.x,W.y),$=new n.Point(W.x,Q.y),tt=0,et=U;tt<et.length;tt++){var nt=et[tt],it=Q.clone(),ot=X.clone(),rt=$.clone(),at=W.clone(),lt=J,ht=L,st=nt.glyphAngle+y;if(0!==st){var ct=Math.cos(st),pt=Math.sin(st);it.rotate(ct,pt),at.rotate(ct,pt),ot.rotate(ct,pt),rt.rotate(ct,pt)}b.push(new h(it,rt,ot,at,S,nt.labelAngle,nt.anchor,nt.minzoom,nt.maxzoom,nt.page)),(!Y||this._legible(nt.labelAngle))&&(M?(z>H&&(z=H),R>lt&&(R=lt),K>F&&(F=K),ht>G&&(G=ht)):nt.minzoom<p&&T.addBox(nt.anchor,new o.Box(H,lt,K,ht),g,st,e,nt.minzoom,nt.maxzoom))}}}if(w>=p)return null;M&&T.addBox(d,new o.Box(z,R,F,G),g,y,e,c,i.C_INFINITY);var gt=new s(T,b);return m.allowOverlap||(w=this._conflictEngine.getMinZoom(gt.footprint,w,u,v)),T.minzoom=w,gt},t.prototype.add=function(t){this._conflictEngine.add(t.footprint)},t.prototype._legible=function(t){var e=i.radToByte(t);return 65>e||e>=193},t.prototype._placeGlyph=function(t,e,o,r,a,h,s,c){var p=h,g=0>p?i.positiveMod(t.angle+i.C_PI,i.C_2PI):t.angle,f=this._legible(g),m=0;0>o&&(p*=-1,o*=-1,m=i.C_PI),p>0&&++a;var u=new n.Point(t.x,t.y),I=r[a],d=i.C_INFINITY;if(r.length<=a)return d;for(;;){var y=I.x-u.x,x=I.y-u.y,_=Math.sqrt(y*y+x*x),w=Math.max(o/_,e),v=y/_,N=x/_,P=i.positiveMod(Math.atan2(N,v)+m,i.C_2PI);if(c.push(new l(u,g,P,s,f,w,d)),e>=w)return w;u=I.clone();do{if(a+=p,r.length<=a||0>a)return w;I=r[a]}while(u.isEqual(I));var A=I.x-u.x,E=I.y-u.y,T=Math.sqrt(A*A+E*E);A*=_/T,E*=_/T,u.x-=A,u.y-=E,d=w}},t}();e.PlacementEngine=g});