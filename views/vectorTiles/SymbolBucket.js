// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/extendsHelper","../../core/tsSupport/decorateHelper","./Bucket","./Geometry","./style/StyleLayer","./Placement","./GeometryUtils","./TextShaping","dojox/string/BidiEngine"],function(e,t,r,a,i,n,o,s,m,h,l){function f(e,t){return e.iconMosaicItem&&t.iconMosaicItem?e.iconMosaicItem.page===t.iconMosaicItem.page?0:e.iconMosaicItem.page<t.iconMosaicItem.page?-1:1:e.iconMosaicItem&&!t.iconMosaicItem?1:!e.iconMosaicItem&&t.iconMosaicItem?-1:0}var u=function(){function e(){}return e}(),c=function(){function e(e,t,r,a){this.line=t,this.shaping=e,this.iconMosaicItem=r,this.anchor=a}return e}(),x=(function(){function e(){}return e}(),function(e){function t(t,r,a,i,n,o,s,m){var h=e.call(this,t,r)||this;return h._markerRatio=1,h._markerMap=new Map,h._markerVertexBuffer=a,h._markerIndexBuffer=i,h._textVertexBuffer=n,h._textIndexBuffer=o,h._placementEngine=s,h._workerTileHandler=m,h}return r(t,e),Object.defineProperty(t.prototype,"markerPageMap",{get:function(){return this._markerMap},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textIndexStart",{get:function(){return this._textTriangleElementsStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"textIndexCount",{get:function(){return this._textTriangleElementsNum},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"sdfMarker",{get:function(){return!1},enumerable:!0,configurable:!0}),t.prototype.copy=function(e,r,a,i,n){var o=new t(this.layer,this.zoom,e,r,a,i,n,this._workerTileHandler);return o.layerIndex=this.layerIndex,o.layerExtent=this.layerExtent,o._markerVertexStart=e.index,o._markerTriangleElementsStart=r.index,o._textVertexStart=a.index,o._textTriangleElementsStart=i.index,o._markerTriangleElementsNum=0,o._textTriangleElementsNum=0,o._symbolInstances=this._symbolInstances,o._glyphItems=this._glyphItems,o._textLayout=this._textLayout,o._markerLayout=this._markerLayout,o._isLinePlacement=this._isLinePlacement,o._avoidEdges=this._avoidEdges,o},t.prototype.getResources=function(e,r,a){var i=this.layer,n=this.zoom;e&&e.setExtent(this.layerExtent);for(var o=i.getLayoutValue("icon-image",n),s=i.getLayoutValue("text-field",n),m=i.getLayoutValue("text-font",n),h=i.getLayoutValue("text-transform",n),l=[],f=0,c=this._features;f<c.length;f++){var x=c[f],d=x.getGeometry(e);if(d&&0!==d.length){var y=void 0;o&&(y=this._replaceKeys(o,x.values),y&&r.add(y));var p=void 0,g=!1;if(s){switch(p=this._replaceKeys(s,x.values),h){case 2:p=p.toLowerCase();break;case 1:p=p.toUpperCase()}if(t._bidiEngine.hasBidiChar(p)){var _=t._bidiEngine.checkContextual(p),v=void 0;v="rtl"===_?"IDNNN":"ICNNN",p=t._bidiEngine.bidiTransform(p,v,"VLYSN"),g=!0}var I=p.length;if(I>0){var b=a[m];b||(b=a[m]=new Set);for(var k=0;I>k;k++){var E=p.charCodeAt(k);b.add(E)}}}if(y||p){var M=new u;M.sprite=y,M.label=p,M.rtl=g,M.geometry=d,l.push(M)}}}this._symbolFeatures=l},t.prototype.processFeatures=function(e,r){e&&e.setExtent(this.layerExtent);var a,i=this.layer,n=this.zoom,l=8,u=24,x=this._isLinePlacement=1===i.getLayoutValue("symbol-placement",n),d=this._avoidEdges=i.getLayoutValue("symbol-avoid-edges",n)&&!x,y=i.getLayoutValue("symbol-spacing",n)*l,p=i.getLayoutValue("icon-image",n),g=i.getLayoutValue("text-field",n),_=this._workerTileHandler;p&&(this._markerLayout=new o.IconLayout(i,n,x),a=_.getSpriteItems());var v,I;if(g){var b=this._textLayout=new o.TextLayout(i,n,x),k=void 0;b.font&&b.font.length&&(k=b.font[0]);var E=.5;switch(b.anchor){case 5:case 1:case 7:E=0;break;case 6:case 2:case 8:E=1}var M=.5;switch(b.anchor){case 5:case 3:case 6:M=0;break;case 7:case 4:case 8:M=1}var z=.5;switch(b.justify){case 0:z=0;break;case 2:z=1}var T=b.letterSpacing*u,N=x?0:b.maxWidth*u,S=b.lineHeight*u,L=[b.offset[0]*u,b.offset[1]*u];v=_.getGlyphItems(k),I=new h(v,N,S,T,L,E,M,z)}this._markerVertexStart=this._markerVertexBuffer.index,this._markerTriangleElementsStart=this._markerIndexBuffer.index,this._textVertexStart=this._textVertexBuffer.index,this._textTriangleElementsStart=this._textIndexBuffer.index,this._markerTriangleElementsNum=0,this._textTriangleElementsNum=0,this._markerMap.clear();var V=[];this._symbolInstances=V,this._glyphItems=v;var w=this._textLayout,P=1;w&&w.size&&(P=w.size/u);for(var B=4096,C=w?w.maxAngle*m.C_DEG_TO_RAD:0,A=w?w.size*l:0,F=0,Y=this._symbolFeatures;F<Y.length;F++){var j=Y[F],H=void 0;j.sprite&&(H=a[j.sprite]);var G=void 0,O=j.label,R=0;if(O&&(G=I.getShaping(O,j.rtl),G&&G.length>0)){for(var q=1e30,D=-1e30,K=0,U=G;K<U.length;K++){var W=U[K];q=Math.min(q,W.x),D=Math.max(D,W.x)}R=(D-q+2*u)*P*l}for(var J=0,Q=j.geometry;J<Q.length;J++){var X=Q[J],Z=void 0;if(x){if(G&&G.length>0&&w&&w.size){var $=w.size*l*(2+Math.min(2,4*Math.abs(w.offset[1])));t._smoothVertices(X,$)}Z=t._findAnchors(X,y,R)}else Z=[new s.Anchor(X[0].x,X[0].y)];for(var ee=0,te=Z;ee<te.length;ee++){var re=te[ee],ae=re.x<0||re.x>B||re.y<0||re.y>B;ae||x&&R>0&&0===w.rotationAlignment&&!t._honorsTextMaxAngle(X,re,R,C,A)||V.push(new c(G,X,H,re))}}}V.sort(f);for(var ie=0,ne=V;ie<ne.length;ie++){var oe=ne[ie];this._processFeature(oe,v,d)}},t.prototype.updateSymbols=function(){this._markerVertexStart=this._markerVertexBuffer.index,this._markerTriangleElementsStart=this._markerIndexBuffer.index,this._textVertexStart=this._textVertexBuffer.index,this._textTriangleElementsStart=this._textIndexBuffer.index,this._markerTriangleElementsNum=0,this._textTriangleElementsNum=0,this._markerMap.clear();for(var e=this._glyphItems,t=this._avoidEdges,r=this._symbolInstances,a=0,i=r;a<i.length;a++){var n=i[a];this._processFeature(n,e,t)}},t.prototype._replaceKeys=function(e,t){return e.replace(/{([^{}]+)}/g,function(e,r){return r in t?t[r]:""})},t.prototype._processFeature=function(e,t,r){var a=e.line,i=e.iconMosaicItem,o=e.shaping,s=e.anchor,h=8,l=this._markerLayout,f=l&&!!i,u=!0,c=1;if(f){var x=1/this._markerRatio,d=l.size/x;c=h*d,u=l.optional||!i}var y=this._textLayout,p=y&&o&&o.length>0,g=24,_=1,v=_,I=!0;p&&(_=y.size/g,v=h*_,I=y.optional||!o||0===o.length);var b,k=new n.Point(0,-17);if(f){if(b=this._placementEngine.getIconPlacement(s,i,c,a,l,r),b.footprint.minzoom===m.C_INFINITY&&!u)return;s.minzoom>b.footprint.minzoom&&(b.footprint.minzoom=s.minzoom)}var E;if(p&&(E=this._placementEngine.getTextPlacement(s,k,o,t,v,a,y,r))){if(E.footprint.minzoom===m.C_INFINITY&&!I)return;s.minzoom>E.footprint.minzoom&&(E.footprint.minzoom=s.minzoom)}if(!I&&!u||!u&&E&&E.footprint.minzoom!==m.C_INFINITY||!I&&b&&b.footprint.minzoom!==m.C_INFINITY){var M=Math.max(b.footprint.minzoom,E.footprint.minzoom);b.footprint.minzoom=M,E.footprint.minzoom=M}E&&E.footprint.minzoom!==m.C_INFINITY&&(y.ignorePlacement||this._placementEngine.add(E),this._addPlacedSymbols(E.shapes,E.footprint.minzoom,this.zoom,!1)),b&&b.footprint.minzoom!==m.C_INFINITY&&(l.ignorePlacement||this._placementEngine.add(b),this._addPlacedSymbols(b.shapes,b.footprint.minzoom,this.zoom,!0,i.page))},t.prototype._addPlacedSymbols=function(e,t,r,a,i){void 0===i&&(i=-1);for(var n=Math.max(r+m.log2(t),0),o=0,s=e;o<s.length;o++){var h=s[o],l=Math.max(r+m.log2(h.minzoom),n),f=Math.min(r+m.log2(h.maxzoom),25);if(!(l>=f)){var u=h.tl,c=h.tr,x=h.bl,d=h.br,y=h.mosaicRect,p=-h.labelAngle,g=h.anchor,_=a?this._markerVertexBuffer:this._textVertexBuffer,v=a?this._markerIndexBuffer:this._textIndexBuffer,I=_.index,b=y.x,k=y.y,E=b+y.width,M=k+y.height;_.add(g.x,g.y,u.x,u.y,b,k,p,l,f,n),_.add(g.x,g.y,c.x,c.y,E,k,p,l,f,n),_.add(g.x,g.y,x.x,x.y,b,M,p,l,f,n),_.add(g.x,g.y,d.x,d.y,E,M,p,l,f,n),v.add(I+0,I+1,I+2),v.add(I+1,I+2,I+3),a?(this._markerMap.has(i)?this._markerMap.get(i)[1]+=6:this._markerMap.set(i,[this._markerTriangleElementsStart+this._markerTriangleElementsNum/3,6]),this._markerTriangleElementsNum+=6):this._textTriangleElementsNum+=6}}},t._findAnchors=function(e,t,r){t+=r;for(var a=0,i=e.length-1,o=0;i>o;o++)a+=n.Point.distance(e[o],e[o+1]);var h=r||t;if(h*=.5,h>=a)return[];var l=h/a;t=a/Math.max(Math.round(a/t),1);for(var f=0,u=-t/2,c=[],x=e.length-1,o=0;x>o;o++){for(var d=e[o],y=e[o+1],p=y.x-d.x,g=y.y-d.y,_=Math.sqrt(p*p+g*g),v=void 0;f+_>u+t;){u+=t;var I=(u-f)/_,b=m.interpolate(d.x,y.x,I),k=m.interpolate(d.y,y.y,I);void 0===v&&(v=Math.atan2(g,p)),c.push(new s.Anchor(b,k,v,o,l))}f+=_}return c},t.deviation=function(e,t,r){var a=(t.x-e.x)*(r.x-t.x)+(t.y-e.y)*(r.y-t.y),i=(t.x-e.x)*(r.y-t.y)-(t.y-e.y)*(r.x-t.x);return Math.atan2(i,a)},t._honorsTextMaxAngle=function(e,t,r,a,i){for(var o=0,s=r/2,m=new n.Point(t.x,t.y),h=t.segment+1;o>-s;){if(--h,0>h)return!1;o-=n.Point.distance(e[h],m),m=e[h]}o+=n.Point.distance(e[h],e[h+1]);for(var l=[],f=0,u=e.length;s>o;){var c=e[h],x=h,d=void 0;do{if(++x,x===u)return!1;d=e[x]}while(d.isEqual(c));var y=x,p=void 0;do{if(++y,y===u)return!1;p=e[y]}while(p.isEqual(d));var g=this.deviation(c,d,p);for(l.push({deviation:g,distToAnchor:o}),f+=g;o-l[0].distToAnchor>i;)f-=l.shift().deviation;if(Math.abs(f)>a)return!1;o+=n.Point.distance(d,p),h=x}return!0},t._smoothVertices=function(e,t){var r=1e-6;if(!(0>=t)){var a=e.length;if(!(3>a)){var i=[],o=0;i.push(0);for(var s=1;a>s;s++)o+=n.Point.distance(e[s],e[s-1]),i.push(o);t=Math.min(t,.2*o);var m=[];m.push(e[0].x),m.push(e[0].y);var h=e[a-1].x,l=e[a-1].y,f=n.Point.sub(e[0],e[1]);f.normalize(),e[0].x+=t*f.x,e[0].y+=t*f.y,f.assignSub(e[a-1],e[a-2]),f.normalize(),e[a-1].x+=t*f.x,e[a-1].y+=t*f.y;for(var s=1;a>s;s++)i[s]+=t;i[a-1]+=t;for(var u=.5*t,s=1;a-1>s;s++){for(var c=0,x=0,d=0,y=s-1;y>=0&&!(i[y+1]<i[s]-u);y--){var p=u+i[y+1]-i[s],g=i[y+1]-i[y],_=i[s]-i[y]<u?1:p/g;if(Math.abs(_)<r)break;var v=_*_,I=_*p-.5*v*g,b=_*g/t,k=e[y+1],E=e[y].x-k.x,M=e[y].y-k.y;c+=b/I*(k.x*_*p+.5*v*(p*E-g*k.x)-v*_*g*E/3),x+=b/I*(k.y*_*p+.5*v*(p*M-g*k.y)-v*_*g*M/3),d+=b}for(var y=s+1;a>y&&!(i[y-1]>i[s]+u);y++){var p=u-i[y-1]+i[s],g=i[y]-i[y-1],_=i[y]-i[s]<u?1:p/g;if(Math.abs(_)<r)break;var v=_*_,I=_*p-.5*v*g,b=_*g/t,k=e[y-1],E=e[y].x-k.x,M=e[y].y-k.y;c+=b/I*(k.x*_*p+.5*v*(p*E-g*k.x)-v*_*g*E/3),x+=b/I*(k.y*_*p+.5*v*(p*M-g*k.y)-v*_*g*M/3),d+=b}m.push(c/d),m.push(x/d)}m.push(h),m.push(l);for(var s=0,y=0;a>s;s++)e[s].x=m[y++],e[s].y=m[y++]}}},t}(i));return x._bidiEngine=new l,x});