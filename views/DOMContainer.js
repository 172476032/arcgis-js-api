// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/_base/lang","dojo/on","dojo/dom","dojo/dom-construct","../core/Accessor","../core/Evented","../core/HandleRegistry","../core/Scheduler","../core/watchUtils","../widgets/Popup","./PopupManager","./overlay/ViewOverlay","./ui/DefaultUI","../core/accessorSupport/decorators"],function(e,t,r,i,o,n,s,a,p,d,u,l,h,c,y,f,v,_){function g(e){var t=e.ownerDocument||window.document,r=t.defaultView,i=e.getBoundingClientRect();return m[0]=i.left+r.pageXOffset,m[1]=i.top+r.pageYOffset,m}var m=[0,0],w=16,H=750,b=512,O=2,T=function(e){function t(){var t=e.call(this)||this;return t._domHandles=new u,t._freqInfo={freq:w,time:H},t._overlayRenderTaskHandle=null,t.height=0,t.position=null,t.resizing=!1,t.root=null,t.surface=null,t.suspended=!0,t.width=0,t.watch("cursor",function(e){var r=t.surface;r&&r.setAttribute("data-cursor",e)}),t.watch("interacting",function(e){var r=t.surface;r&&r.setAttribute("data-interacting",e.toString())}),t}return r(t,e),t.prototype.getDefaults=function(){return o.mixin(this.inherited(arguments),{popup:{},ui:{}})},t.prototype.destroy=function(){this.ui.destroy(),this.popup&&this.popup.destroy(),this.container=null,this._domHandles.destroy()},Object.defineProperty(t.prototype,"container",{set:function(e){var t=this,r=this._get("container");if(r!==e)if(this._stopMeasuring(),r&&(r.classList.remove("esri-view"),this.popupManager.destroy(),this._set("popupManager",null),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay.destroy(),this._set("overlay",null),a.destroy(this.root),this._set("root",null)),e){e.classList.add("esri-view");var i=document.createElement("div");i.className="esri-view-root",e.insertBefore(i,e.firstChild),this._set("root",i);var o=document.createElement("div");o.className="esri-view-surface",s.setSelectable(o,!1),i.appendChild(o),this._set("surface",o);var n=new f;i.appendChild(n.surface),this._set("overlay",n),n.watch("needsRender",function(e){e&&!t._overlayRenderTaskHandle?t._overlayRenderTaskHandle=l.addFrameTask({render:function(){t.overlay.render()}}):t._overlayRenderTaskHandle&&(t._overlayRenderTaskHandle.remove(),t._overlayRenderTaskHandle=null)}),this._forceReadyCycle(),this._set("container",e),this._startMeasuring();var p=new y({enabled:!0,view:this});this._set("popupManager",p)}else this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),this._set("container",null)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"popup",{set:function(e){var t=this._get("popup");e!==t&&(e||(e=new c({container:document.createElement("div")})),this._domHandles.remove("view-popup"),t&&t.destroy(),e&&(e.viewModel.view=this,this._domHandles.add([h.init(this,"root",function(t,r){var i=e.container;i||(e.container=document.createElement("div"));var o=i&&i.parentNode;s.isDescendant(o,r)&&o.removeChild(i),t&&!o&&a.place(e.container,t)})],"view-popup")),this._set("popup",e))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"size",{get:function(){return[this.width,this.height]},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ui",{set:function(e){var t=this._get("ui");e!==t&&(this._domHandles.remove("ui"),t&&t.destroy(),e&&(e.view=this,this._domHandles.add([h.init(this,"root",function(t){e.container=t?a.create("div",null,t):null})],"ui")),this._set("ui",e))},enumerable:!0,configurable:!0}),t.prototype.focus=function(){this.surface&&this.surface.focus()},t.prototype.pageToContainer=function(e,t,r){var i=this.position;return e-=i[0],t-=i[1],r?(r[0]=e,r[1]=t):r=[e,t],r},t.prototype.containerToPage=function(e,t,r){var i=this.position;return e+=i[0],t+=i[1],r?(r[0]=e,r[1]=t):r=[e,t],r},t.prototype._stopMeasuring=function(){this._domHandles.remove("measuring"),this._get("resizing")&&this._set("resizing",!1)},t.prototype._startMeasuring=function(){var e=this,t=this._freqInfo;t.freq=w,t.time=H,this._domHandles.add([n(window,"resize",function(){t.freq=w,t.time=H}),l.addFrameTask({prepare:function(t){var r=e._measure(),i=e._freqInfo;if(i.time+=t.deltaTime,r&&(i.freq=w,e._get("resizing")||e._set("resizing",!0)),!(i.time<i.freq)){i.time=0;var o=e._position();o||r?i.freq=w:i.freq=Math.min(H,i.freq*O),!r&&i.freq>=b&&e._get("resizing")&&e._set("resizing",!1)}}})],"measuring"),this._measure(),this._position()},t.prototype._measure=function(){var e=this.container,t=e?e.clientWidth:0,r=e?e.clientHeight:0;if(0===t||0===r||"hidden"===window.getComputedStyle(e).visibility)return this.suspended||this._set("suspended",!0),!1;var i=this.width,o=this.height;return t===i&&r===o?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",t),this._set("height",r),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:i,oldHeight:o,width:t,height:r}),!0)},t.prototype._position=function(){var e=this.container,t=this.position,r=g(e);return t&&r[0]===t[0]&&r[1]===t[1]?!1:(this._set("position",r.slice()),!0)},i([_.property({value:null,cast:function(e){return s.byId(e)}})],t.prototype,"container",null),i([_.property({readOnly:!0})],t.prototype,"height",void 0),i([_.property({type:c})],t.prototype,"popup",null),i([_.property({type:y})],t.prototype,"popupManager",void 0),i([_.property({type:f})],t.prototype,"overlay",void 0),i([_.property({readOnly:!0})],t.prototype,"position",void 0),i([_.property({readOnly:!0})],t.prototype,"resizing",void 0),i([_.property({readOnly:!0})],t.prototype,"root",void 0),i([_.property({value:null,dependsOn:["width","height"],readOnly:!0})],t.prototype,"size",null),i([_.property({readOnly:!0})],t.prototype,"surface",void 0),i([_.property({readOnly:!0})],t.prototype,"suspended",void 0),i([_.property({type:v})],t.prototype,"ui",null),i([_.property({readOnly:!0})],t.prototype,"width",void 0),t=i([_.subclass("esri.views.DOMContainer")],t)}(_.declared(p,d));return T});