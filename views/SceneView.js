// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","dojo/dom","dojo/when","../Camera","../geometry","../Graphic","../Viewpoint","../core/Error","../core/Handles","../core/Logger","../core/promiseUtils","../core/scheduling","../core/sniff","../core/watchUtils","../core/accessorSupport/decorators","../core/accessorSupport/watch","../geometry/HeightModelInfo","../geometry/support/scaleUtils","../geometry/support/webMercatorUtils","./BreakpointsOwner","./DOMContainer","./View","./ViewAnimation","./3d/constraints/Constraints","./3d/environment/SceneViewEnvironment","./3d/environment/SceneViewEnvironmentManager","./3d/input/SceneInputManager","./3d/layers/GraphicsView3D","./3d/layers/graphics/Deconflictor","./3d/lib/glMatrix","./3d/state/ViewState","./3d/state/ViewStateManager","./3d/support/CombinedElevationProvider","./3d/support/debugFlags","./3d/support/DisplayQualityProfile","./3d/support/HighlightOptions","./3d/support/MapCoordsHelper","./3d/support/projectionUtils","./3d/support/QualitySettings","./3d/support/RenderCoordsHelper","./3d/support/ResourceController","./3d/support/SharedSymbolResources","./3d/support/pointsOfInterest/PointsOfInterest","./3d/terrain/TerrainSurface","./3d/terrain/terrainUtils","./3d/webgl-engine/Stage","./3d/webgl-engine/lib/Selector","./support/screenshotUtils","./support/WebGLRequirements","./ui/3d/DefaultUI3D","../webscene/Environment"],function(e,t,i,r,n,a,o,s,p,l,d,c,u,h,g,y,f,v,m,_,w,b,S,M,R,O,V,x,H,C,P,E,T,L,U,I,A,G,F,j,D,k,z,W,q,B,N,Q,K,Z,J,X,Y,$){var ee=u.getLogger("esri.views.SceneView"),te=function(e){function t(t){var i=e.call(this)||this;return i._layerViewsUpdatingHandles={},i._clippingArea=null,i._internallyReady=!1,i._userClippingArea=null,i._initialDefaultSpatialReference=null,i._defaults={},i._externallySet={environment:!1},i._stageHandles=new c,i._graphicsView=null,i._surfaceReadyWatchHandle=null,i._updateUpdatingMonitorsHandle=null,i._mapLayersChangeHandle=null,i._updateDrawingOrderHandle=null,i._stageFrameTask=null,i.onViewExtentUpdateHandle=null,i.resourceController=new W(i),i.deconflictor=new E(i),i.renderSpatialReference=null,i.sharedSymbolResources=null,i.basemapTerrain=null,i.elevationProvider=null,i.camera=null,i.canvas=null,i.center=null,i.constraints=new V.default,i.extent=null,i.fullOpacity=1,i.map=null,i.screenSizePerspectiveEnabled=!0,i.state=null,i.scale=null,i.isHeightModelInfoRequired=!0,i.type="3d",i.ui=new Y,i.updating=!1,i.updatingPercentage=0,i.viewpoint=null,i.zoom=null,i.highlightOptions=new F,f.when(i,"ready",i._viewReadyHandler.bind(i)),i._evaluateUpdating=i._evaluateUpdating.bind(i),i.watch("map",function(e){e&&e.load&&e.load()}),i.inputManager=new C({view:i}),i.stateManager=new U.ViewStateManager({view:i}),i}return i(t,e),t.prototype.getDefaults=function(e){var t=this.inherited(arguments);return t.environment||e.environment||(this._defaults.environment=new x.default,t.environment=this._defaults.environment),t},t.prototype.initialize=function(){var e=this;this.environmentManager=new H.default({view:this}),this._updateUpdatingMonitorsHandle=this.allLayerViews.on("change",this._updateUpdatingMonitors.bind(this)),this._updateUpdatingMonitors({added:this.allLayerViews.toArray(),removed:[]}),f.whenNot(this,"ready",this._viewUnreadyHandler.bind(this)),this.resourceController.getMemoryEvents().on("updating-changed",function(){return e._evaluateUpdating()}),f.init(this.qualitySettings,"gpuMemoryLimit",function(t){e.resourceController&&e.resourceController.setMaxGpuMemory(t)}),f.init(A,"SCENEVIEW_LOCKING_LOG",function(t){e.defaultsFromMap.logDebugInformation=t})},t.prototype.destroy=function(){this.activeTool=null,m.dispatchTarget(this),this.environmentManager.destroy(),this._disposeGraphicsView(),this._updateUpdatingMonitorsHandle.remove(),this._updateUpdatingMonitorsHandle=null,this._stageHandles.remove(),this.inputManager&&(this.inputManager.destroy(),this._set("inputManager",null))},Object.defineProperty(t.prototype,"activeTool",{set:function(e){if(e&&!this.ready)return void ee.error("#activeTool=","cannot set active tool while view is not ready");var t=this._get("activeTool");e!==t&&(t&&t.deactivate(),this._set("activeTool",e),e&&e.activate())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"clippingArea",{get:function(){if("global"===this.viewingMode)return null;if(this._userClippingArea)return this._userClippingArea;var e=this.get("map.clippingEnabled"),t=this.get("map.clippingArea");return e&&t?t instanceof s.Extent?b.canProject(t.spatialReference,this.spatialReference)?(t=b.project(t,this.spatialReference),this._clippingArea&&t&&this._clippingArea.equals(t)?this._clippingArea:(this._clippingArea=t,t)):(ee.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(ee.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea):(this._clippingArea=null,null)},set:function(e){this.ready&&"global"===this.viewingMode&&e?ee.error("#clippingArea=","Clipping area is only supported in local viewingMode"):(this._userClippingArea=e,this.notifyChange("clippingArea"))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"dataExtent",{get:function(){var e=[],t=this.spatialReference||s.SpatialReference.WGS84,i=this.clippingArea;i&&(i=b.project(i,t));var r=function(r){if(r){var n=b.project(r,t);n&&(i&&(n=n.intersection(i)),n&&e.push(n))}},n=this._get("basemapTerrain");if(n&&n.spatialReference&&r(new s.Extent({xmin:n.extent[0],ymin:n.extent[1],zmin:0,xmax:n.extent[2],ymax:n.extent[3],zmax:0,spatialReference:n.spatialReference})),this.map&&this.map.allLayers.forEach(function(e){r(e.fullExtent)}),e.length>0){var a=e.reduce(function(e,t){return e.union(t)});return a.hasZ?(a.zmin=Math.min(0,a.zmin),a.zmax=Math.max(0,a.zmax)):(a.zmin=0,a.zmax=0),a}return new s.Extent({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:t})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"environment",{set:function(e){if(e!==this._defaults.environment&&(this._externallySet.environment=!0),!e)return void this._set("environment",new x.default);var t=e;t instanceof x.default?this._set("environment",e):t instanceof $?this.environment.lighting=e.lighting:e.declaredClass?this._set("environment",e):this._set("environment",new x.default(e))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"groundExtent",{get:function(){var e=this._get("basemapTerrain");if(e&&e.spatialReference){var t=e.extent;return new s.Extent({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e.spatialReference})}var i=this.spatialReference||s.SpatialReference.WGS84;return new s.Extent({spatialReference:i})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"initialExtentRequired",{get:function(){return!this.stateManager.hasInitialView},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"interacting",{get:function(){return!!this.state&&this.state.interacting},enumerable:!0,configurable:!0}),t.prototype._mapSetter=function(e){e!==this._get("map")&&(this._mapLayersChangeHandle&&(this._mapLayersChangeHandle.remove(),this._mapLayersChangeHandle=null),e&&(this._mapLayersChangeHandle=e.allLayers.on("change",this.notifyChange.bind(this,"dataExtent"))),this.inherited(arguments))},Object.defineProperty(t.prototype,"qualityProfile",{get:function(){return this._get("qualityProfile")||G.getDefaultProfile()},set:function(e){G.isValidProfile(e)&&(G.apply(e,this.qualitySettings),this._set("qualityProfile",e))},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"resolution",{get:function(){return null!=this.spatialReference?w.getResolutionForScale(this.scale,this.spatialReference):0},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"heightModelInfo",{get:function(){var e=this.getDefaultHeightModelInfo();return null!=e?_.deriveUnitFromSR(e,this.spatialReference):null},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"viewingMode",{get:function(){var e=this.get("map.initialViewProperties.viewingMode"),t=this.spatialReference;return e||(e=!t||t.isWebMercator||t.isWGS84?"global":"local"),e},set:function(e){if(this._internallyReady)ee.error("#viewingMode","viewingMode cannot be set once view is ready");else{["local","global"].indexOf(e)>=0?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode")}},enumerable:!0,configurable:!0}),t.prototype.on=function(e,t,i){var r=this.inputManager.viewEvents.register(e,t,i);return r||this.inherited(arguments)},t.prototype.hasEventListener=function(e){return this.inherited(arguments)||this.inputManager&&this.inputManager.viewEvents.hasHandler(e)},t.prototype.toMap=function(e,t,i){if(!this.ready)return ee.error("#toMap()","Scene view cannot be used before it is ready"),null;var r,n;"number"==typeof e?(r=e,n=t):(r=e.x,n=e.y,i=t);var a=[r,this.height-n],o=this._stage.pick(a).getMinResult();return this._computeMapPointFromIntersectionResult(o,i)},t.prototype.toScreen=function(e,t,i,r){if(!this.ready)return ee.error("#toScreen()","Scene view cannot be used before it is ready"),null;if("number"==typeof e){var n="number"==typeof i?i:0;"object"==typeof i&&(r=i),D.vectorToVector([e,t,n],this.spatialReference,ie,this.renderSpatialReference)}else D.pointToVector(e,ie,this.renderSpatialReference),r=t;return this.engineToScreen(ie,r)},t.prototype.pixelSizeAt=function(e,t){if(!this.ready)return ee.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if("number"==typeof e){var i=this._stage.pick([e,this.height-t]).getMinResult();if(!i.getIntersectionPoint(ie))return 0}else if(e instanceof s.Point)D.pointToVector(e,ie,this.renderSpatialReference);else{var i=this._stage.pick([e.x,this.height-e.y]).getMinResult();if(!i.getIntersectionPoint(ie))return 0}return this.state.camera.computePixelSizeAt(ie)},t.prototype.hitTest=function(e,t){if(!this.ready)return ee.error("#hitTest()","Scene view cannot be used before it is ready"),null;var i,r;"number"==typeof e?(i=e,r=t):(i=e.x,r=e.y);var n,o=[i,this.height-r],p=this._stage.pick(o,null,!0),l=p.getMinResult(),d=this._computeMapPointFromIntersectionResult(l);switch(l.targetType){case"None":n=null;break;case"StageObject":n=this._getGraphicFromStageObject(l.target,l.triangleNr);break;case"StagePoint":n=a(this._getGraphicFromStagePoint(l.target))}return a(n).catch(function(){return null}).then(function(e){var t=[];(e||d)&&t.push({mapPoint:d,graphic:e});var n={screenPoint:new s.ScreenPoint({x:i,y:r}),results:t};return A.SCENEVIEW_HITTEST_RETURN_SELECTOR&&(n.selector=p),n})},t.prototype.goTo=function(e,t){return this.stateManager.goTo(e,t)},t.prototype.takeScreenshot=function(e){var t=this;return this.ready?(e=J.adjustScreenshotSettings(e,this),h.create(function(i){t._stage.requestScreenCapture(e,function(e){g.schedule(function(){i(e)})})})):void ee.error("#takeScreenshot()","Scene view cannot be used before it is ready")},t.prototype.destroyLayerViews=function(){for(var e in this._layerViewsUpdatingHandles)this._layerViewsUpdatingHandles[e].remove();this._layerViewsUpdatingHandles={},this.stateManager.deinit(),this._disposeSurface(),this.inherited(arguments),this._stage&&(this._stage.dispose(),this._stage=null,this._stageHandles.remove()),this._set("canvas",null),this.deconflictor.destroy(),this.deconflictor=null,this.resourceController.destroy(),this.resourceController=null},t.prototype.getDefaultSpatialReference=function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null},t.prototype.validate=function(){var e=X.check();return y("safari")&&y("safari")<9&&(e=new d("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:y("safari")})),e?(ee.warn("#validate()",e.message),h.reject(e)):h.resolve()},t.prototype.isSpatialReferenceSupported=function(e,t,i){var r=e.isGeographic,n=e.isWebMercator,a=e.isWGS84,o="local"===this.viewingMode,s=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(s){if(o&&r)return i&&i("Layer "+t.id+" is ignored because it is GCS and viewing mode is local"),!1;if(!o&&!n&&!a)return i&&i("Layer "+t.id+" is ignored because its spatial reference is not supported in global viewing mode"),!1}else if(r&&!a)return i&&i("Layer "+t.id+" is ignored because its spatial reference is geographic but not WGS84"),!1;if(t)if(Q.isTiledLayer(t)){var p=void 0;if(s){var l=Q.getTiledLayerInfo(t,e,this.viewingMode);p=null!=l.tileInfo}else{var l=Q.getTiledLayerInfo(t,e,"global");null==l.tileInfo&&(l=Q.getTiledLayerInfo(t,e,"local")),p=null!=l.tileInfo}if(!p)return i&&i("Layer "+t.id+" is ignored because it is tiled but\n            its tiling scheme is not supported or compatible with the viewing mode"),!1}else if((a||n)&&!o)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=e),s||this._internallyReady||(this.viewingMode="global",i&&i("Viewing mode locked to global due to reprojectable layer "+t.id)),i&&i("Layer "+t.id+" is ignored because it supports server-side reprojection"),!1;return!0},t.prototype.engineToScreen=function(e,t){var i=T.vec3d.create();this.state.camera.projectPoint(e,i);var r=i[0],n=this.height-i[1],a=i[2];return t?(t.x=r,t.y=n,t.z=a,t):new s.ScreenPoint({x:r,y:n,z:a})},t.prototype.flushDisplayModifications=function(){this._stage.processDirty()},t.prototype.getDrawingOrder=function(e){return this.allLayerViews.findIndex(function(t){return t.layer&&t.layer.uid===e})},t.prototype.getViewForGraphic=function(e){return e.layer?this.allLayerViews.find(function(t){return t.layer===e.layer}):this._graphicsView},t.prototype.whenViewForGraphic=function(e){return e.layer?this.whenLayerView(e.layer):h.resolve(this._graphicsView)},t.prototype._computeMapPointFromIntersectionResult=function(e,t){if(e.getIntersectionPoint(ie)){t=this._computeMapPointFromVec3d(ie,t);var i=this._get("basemapTerrain");if("terrain"===e.intersector&&i){var r=i.getElevation(t);null!==r&&(t.z=r)}return t}return null},t.prototype._computeMapPointFromVec3d=function(e,t){var i=this.spatialReference||s.SpatialReference.WGS84;return D.vectorToVector(e,this.renderSpatialReference,e,i)||(i=s.SpatialReference.WGS84,D.vectorToVector(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new s.Point(e,i),t},t.prototype._getGraphicFromStageObject=function(e,t){var i=e.getMetadata();if(null!=i&&null!=i.layerUid){if(i.layerUid===this._graphicsView.mockLayerId)return this._graphicsView.getGraphicsFromStageObject(e,t);var r=this.map.findLayerByUid(i.layerUid);if(r)return this.whenLayerView(r).then(function(i){if(i&&null!=i.getGraphicsFromStageObject&&!i.suspended)return i.getGraphicsFromStageObject(e,t)})}return null},t.prototype._getGraphicFromStagePoint=function(e){var t=this._computeMapPointFromVec3d(e.point),i=new p(t),r=e.metadata.layerUid;return null!=r&&i.set("layer",this.map.findLayerByUid(r)),i},t.prototype._viewingModeToManifold=function(e){switch(e){case"global":return"spherical";case"local":return"planar"}},t.prototype._initBasemapTerrain=function(e){this._disposeBasemapTerrain(),this._set("basemapTerrain",new N(this,this._viewingModeToManifold(e))),this._set("elevationProvider",new I({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)},t.prototype._initGlobe=function(e){this._initCoordinateSystem(),this._initState(),this._stage.setViewParams({backgroundColor:[0,0,0,0],maxFarNearRatio:0,frustumCullingEnabled:!1}),this._initBasemapTerrain(e),this._set("pointsOfInterest",new B.default({view:this})),this._initStateManager()},t.prototype._initCoordinateSystem=function(){if(this.spatialReference){var e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new j.default(this.map,e));var t="global"===this.viewingMode,i=t?D.SphericalECEFSpatialReference:e;i!==this.renderSpatialReference&&(this.renderSpatialReference=i,this._set("renderCoordsHelper",z.createRenderCoordsHelper(t?"global":"local",i)),this._stage&&this._stage.setIntersectTolerance(Z.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null),this.renderSpatialReference=null},t.prototype._evaluateUpdating=function(){var e=0,t=0,i=!1;this.allLayerViews.forEach(function(r){if(r.updating){i=!0;var n=r.updatingPercentage;null!=n&&(++t,e+=n)}}),(this._graphicsView&&this._graphicsView.updating||this.resourceController&&this.resourceController.isUpdating())&&(i=!0),i!==this.updating&&this._set("updating",i),0!==t?e/=t:e=i?100:0,this.updatingPercentage!==e&&this._set("updatingPercentage",e)},t.prototype._updateUpdatingMonitors=function(e){for(var t=0;t<e.removed.length;t++){var i=e.removed[t],r=this._layerViewsUpdatingHandles[i.uid];r&&(delete this._layerViewsUpdatingHandles[i.uid],i.destroyed||r.remove())}for(var t=0;t<e.added.length;t++){var i=e.added[t];if(!i.destroyed){var r=i.watch(["updating","updatingPercentage"],this._evaluateUpdating);this._layerViewsUpdatingHandles[i.uid]=r}}this._evaluateUpdating()},t.prototype._pickRay=function(e,t,i,r,n,a,o){return this._stage?this._stage.pickRay(e,t,i,r,n,a,o):null},t.prototype._pickRayWithBeginPoint=function(e,t,i,r,n){this._stage&&this._stage.pickRayWithBeginPoint(e,t,i,r,n)},t.prototype._disposeSurface=function(){var e=function(e){return e&&e.remove(),null};this._stageFrameTask=e(this._stageFrameTask),this._updateDrawingOrderHandle=e(this._updateDrawingOrderHandle),this.onViewExtentUpdateHandle=e(this.onViewExtentUpdateHandle),this._mapLayersChangeHandle=e(this._mapLayersChangeHandle),this.pointsOfInterest&&(this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null)),this._disposeBasemapTerrain(),this.environmentManager&&this.environmentManager.disposeRendering()},t.prototype._disposeBasemapTerrain=function(){var e=this._get("basemapTerrain");e&&(e.destroy(),this._set("basemapTerrain",null))},t.prototype._initStage=function(){var e=this,t={};t.renderContext=this.renderContext,t.deactivatedWebGLExtensions=this.deactivatedWebGLExtensions,t.viewingMode=this.viewingMode,this.renderCanvas&&(t.canvas=this.renderCanvas),this._stage=new K(this.viewingMode,n.byId(this.surface),t),this._stageHandles.add(f.init(this.qualitySettings,"antialiasingEnabled",function(){e._stage.setRenderParams({antialiasingEnabled:e.qualitySettings.antialiasingEnabled})}));var i=function(){e._stage.setRenderParams({defaultHighlightOptions:F.toEngineOptions(e.highlightOptions)})};this._stageHandles.add(this.watch(["highlightOptions","highlightOptions.color","highlightOptions.haloOpacity","highlightOptions.fillOpacity"],i)),i(),this.renderCoordsHelper&&this._stage.setIntersectTolerance(Z.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.getCanvas()),this._stageFrameTask=g.addFrameTask(this._stage.getFrameTask())},t.prototype._initSurface=function(){this._initStage(),this._initGlobe(this.viewingMode),this.sharedSymbolResources=new q.default({stage:this._stage,viewingMode:this.viewingMode,resourceController:this.resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})},t.prototype._initGraphicsView=function(){var e=this;this._surfaceReadyWatchHandle=f.whenTrueOnce(this,"basemapTerrain.ready",function(){e._graphicsView=new P({view:e,graphics:e.graphics}),e._surfaceReadyWatchHandle=null,e._layerViewsUpdatingHandles[e._graphicsView.mockLayerId]=f.init(e._graphicsView,"updating",e._evaluateUpdating)})},t.prototype._disposeGraphicsView=function(){if(this._surfaceReadyWatchHandle&&(this._surfaceReadyWatchHandle.remove(),this._surfaceReadyWatchHandle=null),this._graphicsView){var e=this._graphicsView.mockLayerId;this._layerViewsUpdatingHandles[e].remove(),delete this._layerViewsUpdatingHandles[e],this._graphicsView.destroy(),this._graphicsView=null}},t.prototype._initState=function(){this._set("state",new L.default({viewingMode:this.viewingMode,spatialReference:this.spatialReference}))},t.prototype._initStateManager=function(){this.stateManager.init()},t.prototype._viewReadyHandler=function(e,t){if(!t){if("global"===this.viewingMode&&(this._clippingArea=null),this._internallyReady=!0,this._initSurface(),this._initGraphicsView(),!this._externallySet.environment){var i=this.get("map.initialViewProperties.environment");i&&(this.environment=i)}this._updateDrawingOrderHandle=this.allLayerViews.on("change",this._updateDrawingOrder.bind(this)),this._updateDrawingOrder(),this.environmentManager.updateReadyChange(!0)}},t.prototype._viewUnreadyHandler=function(e,t){t&&(this.activeTool&&(this.activeTool.deactivate(),this._set("activeTool",null)),this._initialDefaultSpatialReference=null,this.environmentManager.updateReadyChange(!1),this._disposeGraphicsView(),this._internallyReady=!1,this.stateManager.deinit(),this._disposeSurface(),this.state.destroy(),this._set("state",null),this.sharedSymbolResources&&(this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null),this._stage&&(this._stage.dispose(),this._stage=null,this._stageHandles.remove()),this._set("canvas",null))},t.prototype._updateDrawingOrder=function(){var e=this.allLayerViews.length-1;this.allLayerViews.forEach(function(t,i){null!=t.drawingOrder&&(t.drawingOrder=e-i)})},r([v.property({value:null})],t.prototype,"activeTool",null),r([v.property({type:O,readOnly:!0,aliasOf:"state.animation"})],t.prototype,"animation",void 0),r([v.property({readOnly:!0})],t.prototype,"basemapTerrain",void 0),r([v.property({readOnly:!0})],t.prototype,"elevationProvider",void 0),r([v.property({type:o,aliasOf:"stateManager.camera"})],t.prototype,"camera",void 0),r([v.property({readOnly:!0})],t.prototype,"canvas",void 0),r([v.property({type:s.Point,aliasOf:"stateManager.center"})],t.prototype,"center",void 0),r([v.property({type:s.Extent,dependsOn:["map.clippingArea","map.clippingEnabled","viewingMode"]})],t.prototype,"clippingArea",null),r([v.property({type:V.default})],t.prototype,"constraints",void 0),r([v.property({type:s.Extent,dependsOn:["basemapTerrain.extent","clippingArea","map"],readOnly:!0})],t.prototype,"dataExtent",null),r([v.property({value:null})],t.prototype,"environment",null),r([v.property()],t.prototype,"environmentManager",void 0),r([v.property({type:s.Extent,aliasOf:"stateManager.extent"})],t.prototype,"extent",void 0),r([v.property({type:s.ScreenPoint,readOnly:!0,aliasOf:"stateManager.screenCenter"})],t.prototype,"screenCenter",void 0),r([v.property({aliasOf:"stateManager.frustum"})],t.prototype,"frustum",void 0),r([v.property({type:Number,readOnly:!0})],t.prototype,"fullOpacity",void 0),r([v.property({type:s.Extent,dependsOn:["basemapTerrain.extent"],readOnly:!0})],t.prototype,"groundExtent",null),r([v.property({type:Boolean,dependsOn:["stateManager.hasInitialView"]})],t.prototype,"initialExtentRequired",null),r([v.property({type:Boolean,dependsOn:["state.interacting"],readOnly:!0})],t.prototype,"interacting",null),r([v.property()],t.prototype,"map",void 0),r([v.property({readOnly:!0})],t.prototype,"mapCoordsHelper",void 0),r([v.property({aliasOf:"stateManager.padding"})],t.prototype,"padding",void 0),r([v.property({type:B.default,readOnly:!0})],t.prototype,"pointsOfInterest",void 0),r([v.property({type:Boolean})],t.prototype,"screenSizePerspectiveEnabled",void 0),r([v.property({constructOnly:!0})],t.prototype,"deactivatedWebGLExtensions",void 0),r([v.property({constructOnly:!0})],t.prototype,"renderCanvas",void 0),r([v.property({readOnly:!0})],t.prototype,"state",void 0),r([v.property({readOnly:!0})],t.prototype,"inputManager",void 0),r([v.property({readOnly:!0})],t.prototype,"stateManager",void 0),r([v.property()],t.prototype,"qualityProfile",null),r([v.property({type:k,get:function(){var e=this._get("qualitySettings");return e||(e=new k,G.apply(this.qualityProfile,e)),e}})],t.prototype,"qualitySettings",void 0),r([v.property({dependsOn:["viewingMode"]})],t.prototype,"ready",void 0),r([v.property({readOnly:!0})],t.prototype,"renderCoordsHelper",void 0),r([v.property({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],t.prototype,"resolution",null),r([v.property({type:Number,aliasOf:"stateManager.scale"})],t.prototype,"scale",void 0),r([v.property()],t.prototype,"heightModelInfo",null),r([v.property({dependsOn:["map.initialViewProperties.spatialReference","defaultsFromMap.isSpatialReferenceDone"]})],t.prototype,"spatialReference",void 0),r([v.property({type:Boolean})],t.prototype,"isHeightModelInfoRequired",void 0),r([v.property()],t.prototype,"type",void 0),r([v.property({type:Y})],t.prototype,"ui",void 0),r([v.property({type:Boolean,readOnly:!0})],t.prototype,"updating",void 0),r([v.property({type:Number,readOnly:!0})],t.prototype,"updatingPercentage",void 0),r([v.property({type:String,dependsOn:["map.initialViewProperties.viewingMode","spatialReference"]})],t.prototype,"viewingMode",null),r([v.property({type:l,aliasOf:"stateManager.viewpoint"})],t.prototype,"viewpoint",void 0),r([v.property({type:Number,aliasOf:"stateManager.zoom"})],t.prototype,"zoom",void 0),r([v.property({type:F})],t.prototype,"highlightOptions",void 0),t=r([v.subclass("esri.views.SceneView")],t)}(v.declared(M,R,S)),ie=T.vec3d.create();return te});