// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["../core/accessorSupport/watch","dojo/_base/lang","dojo/_base/kernel","dojo/dom","dojo/Deferred","dojo/when","./View","./BreakpointsOwner","./DOMContainer","./ViewAnimation","./animation/easing","../geometry/HeightModelInfo","../geometry/SpatialReference","../geometry/support/scaleUtils","../geometry/support/webMercatorUtils","../Camera","../Graphic","../geometry/Point","../geometry/Extent","../geometry/ScreenPoint","../Viewpoint","../core/Scheduler","../core/sniff","../core/watchUtils","../core/promiseUtils","../core/Error","../core/Logger","../core/HandleRegistry","../webscene/Environment","./support/screenshotUtils","./support/WebGLRequirements","./3d/environment/SceneViewEnvironment","./3d/environment/SceneViewEnvironmentManager","./3d/constraints/SceneViewConstraints","./3d/input/SceneInputManager","./3d/lib/glMatrix","./3d/support/cameraUtils","./3d/support/viewpointUtils","./3d/support/projectionUtils","./3d/webgl-engine/Stage","./3d/webgl-engine/lib/Selector","./3d/support/CombinedElevationProvider","./3d/support/HighlightOptions","./3d/support/RenderCoordsHelper","./3d/support/MapCoordsHelper","./3d/support/ResourceController","./3d/support/DisplayQualityProfile","./3d/support/QualitySettings","./3d/support/SharedSymbolResources","./3d/support/pointsOfInterest/PointsOfInterest","./3d/support/debugFlags","./3d/terrain/TerrainSurface","./3d/terrain/terrainUtils","./3d/layers/graphics/Deconflictor","./3d/layers/GraphicsView3D","./3d/navigation/spherical/NavigationSpherical","./3d/navigation/planar/NavigationPlanar","./3d/support/Frustum","./ui/3d/DefaultUI3D"],function(e,t,i,n,a,r,s,o,l,h,c,d,u,p,g,f,m,v,_,y,w,S,R,C,b,x,T,M,V,O,H,P,I,E,A,z,U,D,G,F,L,k,W,q,N,j,B,Q,Z,J,K,X,Y,$,ee,te,ie,ne,ae){function re(e,t){return function(){return this._internallyReady?t.apply(this,arguments):this._get(e)}}function se(e,t){return function(i){return this._internallyReady?t.apply(this,arguments):(this._initialProps[e]=i,this._set(e,i),ge[e]&&this.notifyChange("initialExtentRequired"),void 0)}}Z=Z["default"];var oe=T.getLogger("esri.views.SceneView"),le=z.vec3d,he=le.create(),ce=new v(0,0,0),de=new f(new v(0,0,0)),ue={point:ce,retval:null},pe={heading:0,tilt:0},ge={camera:["viewpoint"],viewpoint:["extent"],extent:["center","scale"],scale:["zoom"],center:[],zoom:[]},fe=Object.keys(ge);J=J["default"];var me=l.createSubclass([s,o],{declaredClass:"esri.views.SceneView",properties:{animation:{type:h,value:null},basemapTerrain:{readOnly:!0,value:null},elevationProvider:{readOnly:!0,value:null},camera:{copy:function(e,t){e.position.x=t.position.x,e.position.y=t.position.y,e.position.z=t.position.z,e.position.spatialReference=t.position.spatialReference,e.heading=t.heading,e.tilt=t.tilt},type:f},canvas:{readOnly:!0,value:null},center:{copy:function(e,t){return e?(e.x=t.x,e.y=t.y,e.z=t.z,e.spatialReference=t.spatialReference,e):t.clone()},dependsOn:["pointsOfInterest.centerOnContent.location"],type:v},clippingArea:{type:_,dependsOn:["map.clippingArea","map.clippingEnabled","viewingMode"],get:function(){if("global"===this.viewingMode)return null;if(this._userClippingArea)return this._userClippingArea;var e=this.get("map.clippingEnabled"),t=this.get("map.clippingArea");return e&&t?t instanceof _?g.canProject(t.spatialReference,this.spatialReference)?(t=g.project(t,this.spatialReference),this._clippingArea&&t&&this._clippingArea.equals(t)?this._clippingArea:(this._clippingArea=t,t)):(oe.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(oe.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea):(this._clippingArea=null,null)},set:function(e){this.ready&&"global"===this.viewingMode&&e?oe.error("#clippingArea=","Clipping area is only supported in local viewingMode"):(this._userClippingArea=e,this.notifyChange("clippingArea"))}},constraints:{type:E,value:null},dataExtent:{dependsOn:["basemapTerrain.extent","clippingArea","map"],readOnly:!0,get:function(){function e(e){if(e){var a=g.project(e,i);a&&(n&&(a=a.intersection(n)),a&&t.push(a))}}var t=[],i=this.spatialReference||u.WGS84,n=this.clippingArea;n&&(n=g.project(n,i));var a=this._get("basemapTerrain");if(a&&a.spatialReference&&e(new _({xmin:a.extent[0],ymin:a.extent[1],zmin:0,xmax:a.extent[2],ymax:a.extent[3],zmax:0,spatialReference:a.spatialReference})),this.map&&this.map.allLayers.forEach(function(t){e(t.fullExtent)}),t.length>0){var r=t.reduce(function(e,t){return e.union(t)});return r.hasZ?(r.zmin=Math.min(0,r.zmin),r.zmax=Math.max(0,r.zmax)):(r.zmin=0,r.zmax=0),r}return new _({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:i})}},environment:{value:null,set:function(e){return e!==this._defaults.environment&&(this._externallySet.environment=!0),e?void(e instanceof P?this._set("environment",e):e instanceof V?this.environment.lighting=e.lighting:e.declaredClass?this._set("environment",e):this._set("environment",new P(e))):void this._set("environment",new P)}},environmentManager:{},extent:{copy:function(e,t){e.xmin=t.xmin,e.ymin=t.ymin,e.zmin=t.zmin,e.xmax=t.xmax,e.ymax=t.ymax,e.zmax=t.zmax,e.spatialReference=t.spatialReference},type:_},fullOpacity:1,groundExtent:{dependsOn:["basemapTerrain.extent"],readOnly:!0,get:function(){var e=this._get("basemapTerrain");if(e&&e.spatialReference){var t=e.extent;return new _({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e.spatialReference})}var i=this.spatialReference||u.WGS84;return new _({spatialReference:i})}},initialExtentRequired:{dependsOn:["map.initialViewProperties.viewpoint"],get:function(){if(this.get("map.initialViewProperties.viewpoint"))return!1;for(var e=0;e<fe.length;e++)if(this._initialProps&&void 0!==this._initialProps[fe[e]])return!1;return!0}},interacting:{dependsOn:["navigation.interacting"],get:function(){return!(!this.navigation||!this.navigation.interacting)}},map:{value:null},mapCoordsHelper:{},pointsOfInterest:J,screenSizePerspectiveEnabled:!0,navigation:{readOnly:!0,value:null},inputManager:{},qualityProfile:{set:function(e){B.isValidProfile(e)&&(B.apply(e,this),this._set("qualityProfile",e))}},qualitySettings:{type:Q},ready:{dependsOn:["viewingMode"]},renderCoordsHelper:{},resolution:{dependsOn:["scale","spatialReference"],readOnly:!0,get:function(){return null!=this.spatialReference?p.getResolutionForScale(this.scale,this.spatialReference):0}},scale:{dependsOn:["pointsOfInterest.centerOnContent.distance"]},spatialReference:{dependsOn:["map.initialViewProperties.spatialReference","defaultsFromMap.isSpatialReferenceDone"]},isHeightModelInfoRequired:!0,type:"3d",ui:{type:ae},updating:{},updatingPercentage:0,viewingMode:{dependsOn:["map.initialViewProperties.viewingMode","spatialReference"],get:function(){var e=this.get("map.initialViewProperties.viewingMode"),t=this.spatialReference;return e||(e=!t||t.isWebMercator||t.isWGS84?"global":"local"),e},set:function(e){if(this._internallyReady)oe.error("#viewingMode","viewingMode cannot be set once view is ready");else{var t=["local","global"];t.indexOf(e)>=0?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode")}}},viewpoint:{copy:function(e,t){e.rotation=t.rotation,e.scale=t.scale,e.targetGeometry=t.targetGeometry,e.camera=t.camera},dependsOn:["camera"],type:w},zoom:{dependsOn:["scale"]},highlightOptions:{type:W}},getDefaults:function(e){var t=this.inherited(arguments);return t.constraints||e.constraints||(this._defaults.constraints=new E,t.constraints=this._defaults.constraints),t.environment||e.environment||(this._defaults.environment=new P,t.environment=this._defaults.environment),t.qualitySettings=new Q,t.qualityProfile=B.getDefaultProfile(),t.highlightOptions=new W,t},constructor:function(){C.when(this,"ready",this._viewReadyHandler.bind(this)),this._internallyReady=!1,this._initialProps={},this._userClippingArea=null,this._gotoTask=null,this._initialDefaultSpatialReference=null,this._initCoordinateSystem(),this._frustum=new ne,this._animationStateWatcher=null,this._constraints=null,this._clippingArea=null,this.inputManager=new A({view:this}),this._defaults={},this._externallySet={},this.resourceController=new j(this),this.deconflictor=new $(this),this._evaluateUpdating=this._evaluateUpdating.bind(this),this._layerViewsUpdatingHandles={},this._navigationHandles=new M,this._stageHandles=new M,this._navigationPauseNotifications=!1,this._navigationHandles.add([C.on(this,"navigation","currentViewChanged",this._navigationCurrentViewChanged.bind(this),null,null,!0),C.on(this,"navigation","currentViewReachedTarget",this._navigationCurrentViewReachedTarget.bind(this),null,null,!0),C.on(this,"navigation","targetViewChanged",function(e){this._navigationPauseNotifications||this._navigationTargetViewChanged(e)}.bind(this),null,null,!0),C.on(this,"navigation","animationStarted",function(e){this._navigationPauseNotifications||this._navigationAnimationStarted(e)}.bind(this),null,null,!0)]),this.watch("map",function(e){e&&e.load&&e.load()})},initialize:function(){this.environmentManager=new I({view:this}),this._updateUpdatingMonitorsHandle=this.allLayerViews.on("change",this._updateUpdatingMonitors.bind(this)),this._updateUpdatingMonitors({added:this.allLayerViews.toArray(),removed:[],moved:[]}),C.whenNot(this,"ready",this._viewUnreadyHandler.bind(this)),C.init(this.qualitySettings,"gpuMemoryLimit",function(e){this.resourceController&&this.resourceController.setMaxGpuMemory(e)}.bind(this))},destroy:function(){e.dispatchTarget(this),this.environmentManager.destroy(),this._disposeGraphicsView(),this._updateUpdatingMonitorsHandle.remove(),this._updateUpdatingMonitorsHandle=null,this._navigationHandles.remove(),this._navigationHandles=null,this._stageHandles.remove(),this.inputManager&&(this.inputManager.destroy(),this.inputManager=null)},destroyLayerViews:function(){for(var e in this._layerViewsUpdatingHandles)this._layerViewsUpdatingHandles[e].remove();this._layerViewsUpdatingHandles={},this._disposeSurface(),this.inherited(arguments),this._stage&&(this._stage.dispose(),this._stage=null,this._stageHandles.remove()),this._setCanvas(null),this.deconflictor.destroy(),this.deconflictor=null,this.resourceController.destroy(),this.resourceController=null},on:function(e,t,i){var n=this.inputManager.viewEvents.register(e,t,i);return n?n:this.inherited(arguments)},toMap:function(e,t,i){if(!this._internallyReady)return oe.error("#toMap()","Scene view cannot be used before it is ready"),null;var n=this._normalizePointArgs(e,t,void 0,i),a=[n.point.x,this.height-n.point.y],r=this._stage.pick(a).getMinResult();return this._computeMapPointFromIntersectionResult(r,n.retval)},toScreen:function(e,t,i,n){if(!this._internallyReady)return oe.error("#toScreen()","Scene view cannot be used before it is ready"),null;var a=this._normalizePointArgs(e,t,i,n);return G.pointToVector(a.point,he,this.renderSpatialReference),this.engineToScreen(he,a.retval)},pixelSizeAt:function(e,t,i){if(!this._internallyReady)return oe.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if("esri.geometry.ScreenPoint"===e.declaredClass){var n=this._stage.pick([e.x,this.height-e.y]).getMinResult();if(!n.getIntersectionPoint(he))return 0}else{var a=this._normalizePointArgs(e,t,i,void 0);G.pointToVector(a.point,he,this.renderSpatialReference)}var r=this.navigation.currentCamera;return r.computePixelSizeAt(he)},hitTest:function(e,t){if(!this._internallyReady)return oe.error("#hitTest()","Scene view cannot be used before it is ready"),null;var i,n=this._normalizePointArgs(e,t,void 0,void 0),a=[n.point.x,this.height-n.point.y],s=this._stage.pick(a,null,!0),o=s.getMinResult(),l=this._computeMapPointFromIntersectionResult(o);switch(o.targetType){case"None":i=null;break;case"StageObject":i=this._getGraphicFromStageObject(o.target,o.triangleNr);break;case"StagePoint":i=this._getGraphicFromStagePoint(o.target)}return r(i).otherwise(function(){return null}).then(function(e){var t=[];(e||l)&&t.push({mapPoint:l,graphic:e});var i={screenPoint:a,results:t};return K.SCENEVIEW_HITTEST_RETURN_SELECTOR&&(i.selector=s),i})},goTo:function(e,i){if(!this._internallyReady)return void oe.error("#goTo()","Scene view cannot be used before it is ready");i=t.mixin({animate:!0},i);var n=D.create(this,e,i);return this._gotoTask={},i.animate?this._gotoAnimated(n,i):this._gotoImmediate(n,i)},animateTo:function(e,t){return i.deprecated(this.declaredClass+".animateTo is deprecated. Use .goTo instead.","","4.0"),this.goTo(e,t)},takeScreenshot:function(e){if(!this._internallyReady)return void oe.error("#takeScreenshot()","Scene view cannot be used before it is ready");e=O.adjustScreenshotSettings(e,this);var t=new a;return this._stage.requestScreenCapture(e,function(e){S.schedule(function(){t.resolve(e)})}),t.promise},engineToScreen:function(e,t){var i=le.create();this._stage.getCamera().projectPoint(e,i);var n=i[0],a=this.height-i[1],r=i[2];return t?(t.x=n,t.y=a,t.z=r,t):new y({x:n,y:a,z:r})},getDefaultSpatialReference:function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null},validate:function(){var e=H.check();return R("safari")&&R("safari")<9&&(e=new x("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:R("safari")})),e?(oe.warn("#validate()",e.message),b.reject(e)):b.resolve()},isSpatialReferenceSupported:function(e,t){var i=e.isGeographic,n=e.isWebMercator,a=e.isWGS84,r="local"===this.viewingMode,s=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(s){if(r&&i)return!1;if(!r&&!n&&!a)return!1}else if(i&&!a)return!1;if(t)if(Y.isTiledLayer(t)){var o;if(s){var l=Y.getTiledLayerInfo(t,e,this.viewingMode);o=null!=l.tileInfo}else{var l=Y.getTiledLayerInfo(t,e,"global");null==l.tileInfo&&(l=Y.getTiledLayerInfo(t,e,"local")),o=null!=l.tileInfo}if(!o)return!1}else if((a||n)&&!r)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=e),s||this.ready||(this.viewingMode="global"),!1;return!0},has:function(e){return this._stage.has(e)},flushDisplayModifications:function(){this._stage.processDirty()},getFrustum:function(){return this._frustum.dirty&&this._frustum.update(this.navigation.currentCamera),this._frustum},getDrawingOrder:function(e){return this.allLayerViews.findIndex(function(t){return t.layer&&t.layer.uid===e})},getViewForGraphic:function(e){return e.layer?this.allLayerViews.find(function(t){return t.layer===e.layer}):this._graphicsView},whenViewForGraphic:function(e){return e.layer?this.whenLayerView(e.layer):b.resolve(this._graphicsView)},renderSpatialReference:null,_graphicsView:null,_surfaceReadyWatchHandle:null,_stageHandles:null,_navigationHandles:null,_gotoImmediate:function(e,t){var i=this._gotoTask;return e.then(function(e){i===this._gotoTask&&(this.viewpoint=e)}.bind(this))},_gotoAnimated:function(e,t){!this.animation||"running"!==this.animation.state&&"waiting-for-target"!==this.animation.state?this.animation=new h({target:e}):this.animation.target=e;var i=this.animation;return i.state="waiting-for-target",e.then(function(n){if(i.target===e&&this.animation===i){i.target=n,i.state="running";var a=D.toCamera(this,n);if(!a)throw oe.error("#goTo()","Invalid target specified for animateTo"),new x("goto:invalid-camera","Invalid camera in conversion from viewpoint");if(this._cameraAlmostEquals(this.camera,a))return void i.finish();var r=U.externalToInternal(this,a);if(r.almostEquals(this.navigation.currentCamera,5e-4/this.renderCoordsHelper.unitInMeters))return void i.finish();this._navigationPauseNotifications=!0,this._setInternalCamera(r,this._animateOptions(t)),i.state===h.State.STOPPED&&i.stop(),this._navigationPauseNotifications=!1}}.bind(this)).otherwise(function(){i.target===e&&this.animation===i&&(this.animation=null,i.finish())}),i},_animateOptions:function(e){var t={animate:!0};return e&&null!=e.speedFactor&&(t.speedFactor=e.speedFactor),e&&null!=e.duration&&(t.duration=e.duration/1e3),e&&null!=e.minDuration&&(t.minDuration=e.minDuration/1e3),e&&null!=e.maxDuration&&(t.maxDuration=e.maxDuration/1e3),e&&null!=e.easing&&("string"==typeof e.easing?t.easing=c.named[e.easing]:t.easing=e.easing),t},_trackCanvasSize:function(){this.on("resize",function(e){if(this.canvas){this.canvas.width=e.width,this.canvas.height=e.height;var t=this._stage.getCamera();t.width=e.width,t.height=e.height,this._stage.setCamera(t),this.navigation&&(this.navigation.windowSize=[e.width,e.height])}}.bind(this)),this.canvas.width=this.width,this.canvas.height=this.height},_computeMapPointFromIntersectionResult:function(e,t){if(e.getIntersectionPoint(he)){t=this._computeMapPointFromVec3d(he,t);var i=this._get("basemapTerrain");if("terrain"===e.intersector&&i){var n=i.getElevation(t);null!==n&&(t.z=n)}return t}return null},_computeMapPointFromVec3d:function(e,t){var i=this.spatialReference||u.WGS84;return G.vectorToVector(e,this.renderSpatialReference,e,i)||(i=u.WGS84,G.vectorToVector(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new v(e,i),t},_getGraphicFromStageObject:function(e,t){var i=e.getMetadata();if(null!=i&&null!=i.layerUid){if(i.layerUid===this._graphicsView.mockLayerId)return this._graphicsView.getGraphicsFromStageObject(e,t);var n=this.map.findLayerByUid(i.layerUid);if(n)return this.whenLayerView(n).then(function(i){return i&&null!=i.getGraphicsFromStageObject&&!i.suspended?i.getGraphicsFromStageObject(e,t):void 0})}return null},_getGraphicFromStagePoint:function(e){var t=this._computeMapPointFromVec3d(e.point),i=new m(t),n=e.metadata.layerUid;return null!=n&&(i.layer=this.map.findLayerByUid(n)),i},_viewingModeToManifold:function(e){return{local:"planar",global:"spherical"}[e]},_initBasemapTerrain:function(e){this._disposeBasemapTerrain(),this._set("basemapTerrain",new X(this,this._viewingModeToManifold(e))),this._set("elevationProvider",new k({view:this})),this.elevationProvider.register("ground",this.basemapTerrain),this.navigation.elevationProvider=this.basemapTerrain},_initGlobe:function(e){this._initCoordinateSystem(),this._initNavigation(e),this._stage.setViewParams({backgroundColor:[0,0,0,0],maxFarNearRatio:0,frustumCullingEnabled:!1}),this._initBasemapTerrain(e),this._navigationCurrentViewChanged({camera:this.navigation.currentCamera})},_initCoordinateSystem:function(){if(this.spatialReference){var e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||(this.mapCoordsHelper=new N(this.map,e));var t=this.renderCoordsHelper?this.renderCoordsHelper.unitInMeters:1,i="global"===this.viewingMode,n=i?G.SphericalRenderSpatialReference:e;if(n!==this.renderSpatialReference){this.renderSpatialReference=n;var a=i?q.Spherical:q.Planar;if(this.renderCoordsHelper=new a(n),this._stage&&this._stage.setIntersectTolerance(L.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._constraints){var r=t/this.renderCoordsHelper.unitInMeters;this._constraints.scale(r)}}}else this.mapCoordsHelper=null,this.renderCoordsHelper=null,this.renderSpatialReference=null},_paddingEqualsArray:function(e){var t=this.padding;return t?t.top===e[0]&&t.right===e[1]&&t.bottom===e[2]&&t.left===e[3]:!0},_navigationCurrentViewChanged:function(e){this._frustum.dirty=!0;var t=e.camera,i=t.padding,n=this._get("basemapTerrain"),a=n.spatialReference;if(a){var r=this.renderCoordsHelper.fromRenderCoords(t.eye,a),s=n.getElevation(r)||0,o=r.z,l=o>=s;t.aboveGround=l}if(!this._paddingEqualsArray(i)){var h=this._padding,c={top:i[0],right:i[1],bottom:i[2],left:i[3]};this._internallyReady?(this._padding=c,this.notifyChange("padding",h,c)):this.padding=c}this._stage.setCamera(t),this.notifyChange("extent");var d=this.camera,u=U.internalToExternal(this,t,de);d&&this._cameraAlmostEquals(d,u)||this.notifyChange("camera")},_cameraAlmostEquals:function(e,t){return Math.abs(e.tilt-t.tilt)<1e-5&&Math.abs(e.heading-t.heading)<1e-5&&Math.abs(e.fov-t.fov)<1e-5&&e.position.equals(t.position)},_navigationAnimationStarted:function(e){var t=D.fromInternalCamera(this,this.navigation.targetCamera);this.animation?this.animation.target=t:this.animation=new h({target:t})},_navigationTargetViewChanged:function(e){if(this.animation&&"waiting-for-target"!==this.animation.state){var t=e.camera,i=this.spatialReference||u.WGS84,n=U.internalToExternal(this,t),a=new w({camera:n,targetGeometry:G.vectorToPoint(t.center,i,this.renderSpatialReference),scale:U.computeScale(this,t),rotation:D.headingToRotation(n.heading)});this.animation.target=a}},_navigationCurrentViewReachedTarget:function(e){if((e.interruptedAnimation||e.finishedAnimation)&&(this._gotoTask=null),this.animation&&(e.interruptedAnimation||e.finishedAnimation)){this._animationStateWatcher&&(this._animationStateWatcher.remove(),this._animationStateWatcher=null);var t=this.animation;this.animation=null,e.finishedAnimation?t.finish():t.stop(),this.notifyChange("animation")}},_setInternalCamera:function(e,t){return e&&(this.navigation.setCamera(e,t),this._externallySet.camera=!0),!!e},_setCamera:function(e,t){return this._setInternalCamera(U.externalToInternal(this,e),t)},_evaluateUpdating:function(){var e=0,t=0,i=!1;this.allLayerViews.forEach(function(n){if(n.updating){i=!0;var a=n.updatingPercentage;null!=a&&(++t,e+=a)}}),this._graphicsView&&this._graphicsView.updating&&(i=!0),i!==this.updating&&(this.updating=i),0!==t?e/=t:e=i?100:0,this.updatingPercentage!==e&&(this.updatingPercentage=e)},_updateUpdatingMonitors:function(e){for(var t=0;t<e.removed.length;t++){var i=e.removed[t],n=this._layerViewsUpdatingHandles[i.uid];n&&(delete this._layerViewsUpdatingHandles[i.uid],i.destroyed||n.remove())}for(t=0;t<e.added.length;t++)i=e.added[t],i.destroyed||(n=i.watch(["updating","updatingPercentage"],this._evaluateUpdating),this._layerViewsUpdatingHandles[i.uid]=n);this._evaluateUpdating()},_spatialReferenceSetter:function(e){this.inherited(arguments),this._initCoordinateSystem()},_setInitialView:function(e){if(e&&!this._externallySet.camera){var t=null;if(e instanceof w&&!e.camera&&e.targetGeometry instanceof _&&(t=D.rotationToHeading(e.rotation),e=e.targetGeometry),e instanceof w)this.viewpoint=e;else if(e instanceof f)this.camera=e;else{var i=this._getDesiredHeadingTilt();null!=t&&(i.heading=t),D.create(this,{target:e,heading:i.heading,tilt:i.tilt}).then(function(e){this.navigation._dataExtentChanged(),this.viewpoint=e}.bind(this))}}},_pickRay:function(e,t,i,n,a,r,s){return this._stage?this._stage.pickRay(e,t,i,n,a,r,s):null},_pickRayWithBeginPoint:function(e,t,i,n,a){return this._stage?this._stage.pickRayWithBeginPoint(e,t,i,n,a):null},_removeHandles:function(e){for(var t=0;t<e.length;t++){var i=e[t];this[i]&&(this[i].remove(),this[i]=null)}},_setCanvas:function(e){e!==this._get("canvas")&&this._set("canvas",e)},_disposeSurface:function(){this._removeHandles(["_stageFrameTask","_updateDrawingOrderHandle","onViewExtentUpdateHandle","_mapLayersChangeHandle"]),this.pointsOfInterest&&(this.pointsOfInterest.destroy(),this.pointsOfInterest=null),this._disposeBasemapTerrain(),this._setNavigation(null),this.environmentManager&&this.environmentManager.disposeRendering()},_disposeBasemapTerrain:function(){var e=this._get("basemapTerrain");e&&(e.destroy(),this._set("basemapTerrain",null))},_disposeNavigation:function(){var e=this._get("navigation");e&&(e.destroy(),e.elevationProvider=null,this._set("navigation",null))},_setNavigation:function(e){this._get("navigation")!==e&&(this._disposeNavigation(),e&&(e.windowSize=[this.width,this.height],e.userConstraints=this.constraints),this._set("navigation",e))},_initNavigation:function(e){e=e||this.viewingMode;var t={view:this};"global"===e?this._setNavigation(new te(t)):this._setNavigation(new ie(t))},_initSurface:function(){var e={};e.deactivatedWebGLExtensions=this.deactivatedWebGLExtensions,e.viewingMode=this.viewingMode,this.renderCanvas&&(e.canvas=this.renderCanvas),this._stage=new F(this.viewingMode,n.byId(this.surface),e),this._stage.selectionState=!1,this._stageHandles.add(C.init(this.qualitySettings,"antialiasingEnabled",function(){this._stage.setRenderParams({antialiasingEnabled:this.qualitySettings.antialiasingEnabled})}.bind(this))),this._stageHandles.add(C.watch(this,this.highlightOptions.keys().map(function(e){return"highlightOptions."+e}),function(){this._stage.setRenderParams({defaultHighlightOptions:W.toEngineOptions(this.highlightOptions)})}.bind(this))),this._stageHandles.add(C.init(this,"highlightOptions",function(){this._stage.setRenderParams({defaultHighlightOptions:W.toEngineOptions(this.highlightOptions)})}.bind(this))),this.renderCoordsHelper&&this._stage.setIntersectTolerance(L.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._setCanvas(this._stage.getCanvas()),this._stageFrameTask=S.addFrameTask(this._stage.getFrameTask()),this._trackCanvasSize(),this._initGlobe(this.viewingMode),this.pointsOfInterest=new J({view:this}),C.init(this.pointsOfInterest.centerOnContent,"location",function(){this.notifyChange("center")}.bind(this),!0),C.init(this.pointsOfInterest.centerOnContent,["distance","location"],function(){this.notifyChange("scale")}.bind(this),!0),this.pointsOfInterest.events.on("camera-parameters-changed",function(){this.notifyChange("scale")}.bind(this)),this.sharedSymbolResources=new Z({stage:this._stage,viewingMode:this.viewingMode,resourceController:this.resourceController,pointsOfInterest:this.pointsOfInterest})},_initGraphicsView:function(){this._surfaceReadyWatchHandle=C.whenTrueOnce(this,"basemapTerrain.ready",function(){this._graphicsView=new ee({view:this,graphics:this.graphics}),this._surfaceReadyWatchHandle=null,this._layerViewsUpdatingHandles[this._graphicsView.mockLayerId]=C.init(this._graphicsView,"updating",this._evaluateUpdating)}.bind(this))},_disposeGraphicsView:function(){if(this._surfaceReadyWatchHandle&&(this._surfaceReadyWatchHandle.remove(),this._surfaceReadyWatchHandle=null),this._graphicsView){var e=this._graphicsView.mockLayerId;this._layerViewsUpdatingHandles[e].remove(),delete this._layerViewsUpdatingHandles[e],this._graphicsView.destroy(),this._graphicsView=null}},_normalizePointArgs:function(e,t,i,n,a){a=a||ue;var r=a.point;return r.spatialReference=void 0,"object"==typeof e?(r.x=e.x,r.y=e.y,r.z=e.z,e.spatialReference&&(r.spatialReference=e.spatialReference),a.retval=t):(r.x=e,r.y=t,"number"!=typeof i&&void 0!==i?(r.z=void 0,a.retval=i):(r.z=i,a.retval=n)),r.spatialReference||(r.spatialReference=this.spatialReference||u.WGS84),a},_separateInitialProperties:function(){var e,t={},i={},n={},a=function(e){var t=ge[e];if(t)for(var i=0;i<t.length;i++)n[t[i]]=!0,a(t[i])};for(e in this._initialProps){var r=ge[e],s=this._initialProps[e];r?(a(e),t[e]=s):i[e]=s}for(e in n)delete t[e];return{view:t,other:i}},_viewReadyHandler:function(e,t){if(!t){"global"===this.viewingMode&&(this._clippingArea=null),this._internallyReady=!0,this._initSurface(),this._initGraphicsView();var i,n=this._separateInitialProperties();for(i in n.other)this.set(i,n.other[i]);for(i in n.view)this.set(i,n.view[i]);var a=this.get("map.initialViewProperties.viewpoint"),r=this.get("initialExtent");if(a?this._setInitialView(a):r&&r.spatialReference.equals(this.spatialReference)?this._setInitialView(r):"local"===this.viewingMode&&C.whenOnce(this.basemapTerrain,"ready",function(){this._setInitialView(this.groundExtent)}.bind(this)),!this._externallySet.environment){var s=this.get("map.initialViewProperties.environment");s&&(this.environment=s)}this._initialProps={},this.notifyChange("initialExtentRequired"),this._updateDrawingOrderHandle=this.allLayerViews.on("change",this._updateDrawingOrder.bind(this)),this._updateDrawingOrder({added:this.allLayerViews.toArray(),removed:[],moved:[]}),this.environmentManager.updateReadyChange(!0)}},_viewUnreadyHandler:function(e,t){t&&(this._initialDefaultSpatialReference=null,this.environmentManager.updateReadyChange(!1),this._disposeGraphicsView(),this._internallyReady=!1,this._disposeSurface(),this.sharedSymbolResources&&(this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null),this._stage&&(this._stage.dispose(),this._stage=null,this._stageHandles.remove()),this._setCanvas(null))},_getDesiredHeadingTilt:function(){if(this._externallySet.camera){var e=this.camera;pe.heading=e.heading,pe.tilt=e.tilt}else pe.heading=0,pe.tilt=.5;return pe},_cameraSetter:se("camera",function(e){this._setCamera(e,{animate:!1})||oe.error("#camera=","Invalid camera",e)}),_cameraGetter:re("camera",function(e){return U.internalToExternal(this,this.navigation.currentCamera,e)}),_externalExtent:function(){return this._cachedExtentDirty&&(U.toExtent(this,null,null,this._cachedExtent,de),this._cachedExtentDirty=!1),this._cachedExtent},_extentGetter:re("extent",function(e){return U.toExtent(this,null,null,e,de)}),_extentSetter:se("extent",function(e){var t=U.fromExtent(this,e,this._getDesiredHeadingTilt(),de);t?this.camera=t:this._isIncompatibleSpatialReference(e.spatialReference)?oe.error("#extent=","Extent has an incompatible spatial reference (extent: "+e.spatialReference.wkid+", view: "+this.spatialReference.wkid+")",e):oe.error("#extent=","Invalid extent",e)}),_heightModelInfoGetter:function(){var e=this.getDefaultHeightModelInfo();return null!=e?d.deriveUnitFromSR(e,this.spatialReference):null},_isIncompatibleSpatialReference:function(e){return e&&!e.equals(this.spatialReference)&&!g.canProject(e,this.spatialReference)},_scaleGetter:re("scale",function(){if(null!=this.navigation){var e=this.pointsOfInterest.centerOnContent;return U.distanceToScale(this,e.distance,e.location.latitude)}return 0}),_scaleSetter:se("scale",function(e){var t=this._getDesiredHeadingTilt(),i=this.pointsOfInterest.centerOnContent;i.forceUpdate();var n=i.renderLocation,a=i.location.latitude,r=U.scaleToDistance(this,e,a),s=U.eyeHeadingTiltForCenterPointAtDistance(this,t.heading,t.tilt,n,r);this._externallySet.camera=!0,this.navigation.setCameraFromEyeCenterAndUp(s.eye,s.center,s.up,{animate:!1}),i.forceUpdate()}),_zoomGetter:re("zoom",function(){return U.scaleToZoom(this,this.scale)}),_zoomSetter:se("zoom",function(e){this.scale=U.zoomToScale(this,e)}),_centerGetter:re("center",function(e){return this.pointsOfInterest.centerOnContent.location}),_centerSetter:se("center",function(e){if(this._isIncompatibleSpatialReference(e&&e.spatialReference))return void oe.error("#center=","Center has an incompatible spatial reference (center: "+e.spatialReference.wkid+", view: "+this.spatialReference.wkid+")",e);var t=this.pointsOfInterest.centerOnContent;t.forceUpdate();var i=this._getDesiredHeadingTilt(),n=U.eyeHeadingTiltForCenterPointAtDistance(this,i.heading,i.tilt,e,t.distance);n||oe.error("#center=","Invalid center",e),this._externallySet.camera=!0,this.navigation.setCameraFromEyeCenterAndUp(n.eye,n.center,n.up,{animate:!1}),t.forceUpdate()}),_viewpointGetter:re("viewpoint",function(){return D.fromCamera(this,this.camera)}),_viewpointSetter:se("viewpoint",function(e){var t=D.toCamera(this,e);t?this._setCamera(t,{animate:!1}):oe.error("#viewpoint=","Invalid viewpoint",e)}),_screenCenterGetter:function(){var e=this.padding;return new y((this.size[0]-(e.left+e.right))/2+e.left,(this.size[1]-(e.top+e.bottom))/2+e.top)},_updateDrawingOrder:function(){var e=this.allLayerViews.length-1;this.allLayerViews.forEach(function(t,i){null!=t.drawingOrder&&(t.drawingOrder=e-i)},this)},_paddingSetter:se("padding",function(e){this._set("padding",{top:e&&e.top||0,right:e&&e.right||0,bottom:e&&e.bottom||0,left:e&&e.left||0}),this.navigation&&(this.navigation.padding=this._get("padding"))}),_constraintsSetter:se("constraints",function(e){this._set("constraints",e),e===this._defaults.constraints&&(this._defaults.constraints=null,e.scale(1/this.renderCoordsHelper.unitInMeters)),this.navigation.userConstraints=e}),_animationSetter:function(e){if(e!==this._get("animation")){
if(!this._internallyReady)return void oe.error("#animation=","Scene view cannot be used before it is ready");this._animationStateWatcher&&(this._animationStateWatcher.remove(),this._animationStateWatcher=null),this._set("animation",e),e&&(this._animationStateWatcher=e.watch("state",function(e){(e===h.State.FINISHED||e===h.State.STOPPED)&&(this.animation=null,e===h.State.FINISHED?this.navigation.setCurrentToTarget():this.navigation.setCamera(this.navigation.currentCamera,{animate:!1}))}.bind(this)))}},_mapSetter:function(e){e!==this._get("map")&&(this.navigation&&this.navigation._dataExtentChanged(),this._mapLayersChangeHandle&&this._mapLayersChangeHandle.remove(),e&&(this._mapLayersChangeHandle=e.allLayers.on("change",this.notifyChange.bind(this,"dataExtent"))),delete this._externallySet.camera,this.inherited(arguments))}});return me});