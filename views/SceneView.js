// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["../core/accessorSupport/watch","dojo/_base/kernel","dojo/dom","dojo/Deferred","dojo/when","./View","./BreakpointsOwner","./DOMContainer","./ViewAnimation","../geometry/HeightModelInfo","../geometry/SpatialReference","../geometry/support/scaleUtils","../geometry/support/webMercatorUtils","../Camera","../Graphic","../geometry/Point","../geometry/Extent","../geometry/ScreenPoint","../Viewpoint","../core/Scheduler","../core/sniff","../core/watchUtils","../core/promiseUtils","../core/Error","../core/Logger","../core/HandleRegistry","../webscene/Environment","./support/screenshotUtils","./support/WebGLRequirements","./3d/state/ViewState","./3d/state/ViewStateManager","./3d/environment/SceneViewEnvironment","./3d/environment/SceneViewEnvironmentManager","./3d/constraints/Constraints","./3d/input/SceneInputManager","./3d/lib/glMatrix","./3d/support/projectionUtils","./3d/webgl-engine/Stage","./3d/webgl-engine/lib/Selector","./3d/support/CombinedElevationProvider","./3d/support/HighlightOptions","./3d/support/RenderCoordsHelper","./3d/support/MapCoordsHelper","./3d/support/ResourceController","./3d/support/DisplayQualityProfile","./3d/support/QualitySettings","./3d/support/SharedSymbolResources","./3d/support/pointsOfInterest/PointsOfInterest","./3d/support/debugFlags","./3d/terrain/TerrainSurface","./3d/terrain/terrainUtils","./3d/layers/graphics/Deconflictor","./3d/layers/GraphicsView3D","./ui/3d/DefaultUI3D"],function(e,t,i,n,a,r,s,o,l,h,d,p,c,u,g,f,v,_,m,y,w,M,R,S,b,V,O,H,T,C,x,P,E,U,I,A,L,D,G,z,F,k,W,j,q,N,B,Q,Z,J,K,X,Y,$){B=B["default"],x=x["default"],U=U["default"];var ee=b.getLogger("esri.views.SceneView"),C=C.ViewState,te=A.vec3d,ie=te.create(),ne=new f(0,0,0),ae={point:ne,retval:null};Q=Q["default"];var re=o.createSubclass([r,s],{declaredClass:"esri.views.SceneView",properties:{activeTool:{value:null,set:function(e){if(e&&!this.ready)return void ee.error("#activeTool=","cannot set active tool while view is not ready");var t=this._get("activeTool");e!==t&&(t&&t.deactivate(this.inputManager._inputManager),this._set("activeTool",e),e&&e.activate(this.inputManager._inputManager))}},animation:{type:l,readOnly:!0,aliasOf:"state.animation"},basemapTerrain:{readOnly:!0,value:null},elevationProvider:{readOnly:!0,value:null},camera:{type:u,aliasOf:"stateManager.camera"},canvas:{readOnly:!0,value:null},center:{type:f,aliasOf:"stateManager.center"},clippingArea:{type:v,dependsOn:["map.clippingArea","map.clippingEnabled","viewingMode"],get:function(){if("global"===this.viewingMode)return null;if(this._userClippingArea)return this._userClippingArea;var e=this.get("map.clippingEnabled"),t=this.get("map.clippingArea");return e&&t?t instanceof v?c.canProject(t.spatialReference,this.spatialReference)?(t=c.project(t,this.spatialReference),this._clippingArea&&t&&this._clippingArea.equals(t)?this._clippingArea:(this._clippingArea=t,t)):(ee.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(ee.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea):(this._clippingArea=null,null)},set:function(e){this.ready&&"global"===this.viewingMode&&e?ee.error("#clippingArea=","Clipping area is only supported in local viewingMode"):(this._userClippingArea=e,this.notifyChange("clippingArea"))}},constraints:{type:U,value:null},dataExtent:{dependsOn:["basemapTerrain.extent","clippingArea","map"],readOnly:!0,get:function(){function e(e){if(e){var a=c.project(e,i);a&&(n&&(a=a.intersection(n)),a&&t.push(a))}}var t=[],i=this.spatialReference||d.WGS84,n=this.clippingArea;n&&(n=c.project(n,i));var a=this._get("basemapTerrain");if(a&&a.spatialReference&&e(new v({xmin:a.extent[0],ymin:a.extent[1],zmin:0,xmax:a.extent[2],ymax:a.extent[3],zmax:0,spatialReference:a.spatialReference})),this.map&&this.map.allLayers.forEach(function(t){e(t.fullExtent)}),t.length>0){var r=t.reduce(function(e,t){return e.union(t)});return r.hasZ?(r.zmin=Math.min(0,r.zmin),r.zmax=Math.max(0,r.zmax)):(r.zmin=0,r.zmax=0),r}return new v({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:i})}},environment:{value:null,set:function(e){return e!==this._defaults.environment&&(this._externallySet.environment=!0),e?void(e instanceof P?this._set("environment",e):e instanceof O?this.environment.lighting=e.lighting:e.declaredClass?this._set("environment",e):this._set("environment",new P(e))):void this._set("environment",new P)}},environmentManager:{},extent:{type:v,aliasOf:"stateManager.extent"},frustum:{aliasOf:"stateManager.frustum"},fullOpacity:1,groundExtent:{dependsOn:["basemapTerrain.extent"],readOnly:!0,get:function(){var e=this._get("basemapTerrain");if(e&&e.spatialReference){var t=e.extent;return new v({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e.spatialReference})}var i=this.spatialReference||d.WGS84;return new v({spatialReference:i})}},initialExtentRequired:{dependsOn:["stateManager.hasInitialView"],get:function(){return!this.stateManager.hasInitialView}},interacting:{dependsOn:["state.interacting"],readOnly:!0,get:function(){return!!this.state&&this.state.interacting}},map:{value:null},mapCoordsHelper:{},padding:{aliasOf:"stateManager.padding"},pointsOfInterest:Q,screenSizePerspectiveEnabled:!0,state:{readOnly:!0,value:null},stateManager:{readOnly:!0},inputManager:{},qualityProfile:{set:function(e){q.isValidProfile(e)&&(q.apply(e,this),this._set("qualityProfile",e))}},qualitySettings:{type:N},ready:{dependsOn:["viewingMode"]},renderCoordsHelper:{},resolution:{dependsOn:["scale","spatialReference"],readOnly:!0,get:function(){return null!=this.spatialReference?p.getResolutionForScale(this.scale,this.spatialReference):0}},scale:{aliasOf:"stateManager.scale"},spatialReference:{dependsOn:["map.initialViewProperties.spatialReference","defaultsFromMap.isSpatialReferenceDone"]},spatialReferenceWarningDelay:1e3,isHeightModelInfoRequired:!0,type:"3d",ui:{type:$},updating:{},updatingPercentage:0,viewingMode:{dependsOn:["map.initialViewProperties.viewingMode","spatialReference"],get:function(){var e=this.get("map.initialViewProperties.viewingMode"),t=this.spatialReference;return e||(e=!t||t.isWebMercator||t.isWGS84?"global":"local"),e},set:function(e){if(this._internallyReady)ee.error("#viewingMode","viewingMode cannot be set once view is ready");else{var t=["local","global"];t.indexOf(e)>=0?this._override("viewingMode",e):void 0===e&&this._clearOverride("viewingMode")}}},viewpoint:{type:m,aliasOf:"stateManager.viewpoint"},zoom:{aliasOf:"stateManager.zoom"},highlightOptions:{type:F}},getDefaults:function(e){var t=this.inherited(arguments);return t.constraints||e.constraints||(t.constraints=new U),t.environment||e.environment||(this._defaults.environment=new P,t.environment=this._defaults.environment),t.qualitySettings=new N,t.qualityProfile=q.getDefaultProfile(),t.highlightOptions=new F,t},constructor:function(){M.when(this,"ready",this._viewReadyHandler.bind(this)),this._internallyReady=!1,this._initialProps={},this._userClippingArea=null,this._gotoTask=null,this._initialDefaultSpatialReference=null,this.inputManager=new I({view:this}),this.stateManager=new x({view:this}),this._constraints=null,this._clippingArea=null,this._defaults={},this._externallySet={},this.resourceController=new j(this),this.deconflictor=new X(this),this._evaluateUpdating=this._evaluateUpdating.bind(this),this._layerViewsUpdatingHandles={},this._stageHandles=new V,this.watch("map",function(e){e&&e.load&&e.load()})},initialize:function(){this.environmentManager=new E({view:this}),this._updateUpdatingMonitorsHandle=this.allLayerViews.on("change",this._updateUpdatingMonitors.bind(this)),this._updateUpdatingMonitors({added:this.allLayerViews.toArray(),removed:[],moved:[]}),M.whenNot(this,"ready",this._viewUnreadyHandler.bind(this));var e;M.init(this.defaultsFromMap,"isSpatialReferenceDone",function(t){var i=!!(this.map&&this.map.allLayers.length>0);t&&!this.spatialReference&&i||!e?t&&!this.spatialReference&&i&&!e&&(e=R.after(this.spatialReferenceWarningDelay),e.then(function(){ee.warn("#spatialReference","no spatial reference could be derived from the currently added map layers")})):(e.cancel(),e=null)}.bind(this)),M.init(this.qualitySettings,"gpuMemoryLimit",function(e){this.resourceController&&this.resourceController.setMaxGpuMemory(e)}.bind(this))},destroy:function(){this.activeTool=null,e.dispatchTarget(this),this.environmentManager.destroy(),this._disposeGraphicsView(),this._updateUpdatingMonitorsHandle.remove(),this._updateUpdatingMonitorsHandle=null,this._stageHandles.remove(),this.inputManager&&(this.inputManager.destroy(),this.inputManager=null)},destroyLayerViews:function(){for(var e in this._layerViewsUpdatingHandles)this._layerViewsUpdatingHandles[e].remove();this._layerViewsUpdatingHandles={},this.stateManager.deinit(),this._disposeSurface(),this.inherited(arguments),this._stage&&(this._stage.dispose(),this._stage=null,this._stageHandles.remove()),this._setCanvas(null),this.deconflictor.destroy(),this.deconflictor=null,this.resourceController.destroy(),this.resourceController=null},on:function(e,t,i){var n=this.inputManager.viewEvents.register(e,t,i);return n?n:this.inherited(arguments)},toMap:function(e,t,i){if(!this.ready)return ee.error("#toMap()","Scene view cannot be used before it is ready"),null;var n=this._normalizePointArgs(e,t,void 0,i),a=[n.point.x,this.height-n.point.y],r=this._stage.pick(a).getMinResult();return this._computeMapPointFromIntersectionResult(r,n.retval)},toScreen:function(e,t,i,n){if(!this.ready)return ee.error("#toScreen()","Scene view cannot be used before it is ready"),null;var a=this._normalizePointArgs(e,t,i,n);return L.pointToVector(a.point,ie,this.renderSpatialReference),this.engineToScreen(ie,a.retval)},pixelSizeAt:function(e,t,i){if(!this.ready)return ee.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if("esri.geometry.ScreenPoint"===e.declaredClass){var n=this._stage.pick([e.x,this.height-e.y]).getMinResult();if(!n.getIntersectionPoint(ie))return 0}else{var a=this._normalizePointArgs(e,t,i,void 0);L.pointToVector(a.point,ie,this.renderSpatialReference)}var r=this.state.camera;return r.computePixelSizeAt(ie)},hitTest:function(e,t){if(!this.ready)return ee.error("#hitTest()","Scene view cannot be used before it is ready"),null;var i,n=this._normalizePointArgs(e,t,void 0,void 0),r=[n.point.x,this.height-n.point.y],s=this._stage.pick(r,null,!0),o=s.getMinResult(),l=this._computeMapPointFromIntersectionResult(o);switch(o.targetType){case"None":i=null;break;case"StageObject":i=this._getGraphicFromStageObject(o.target,o.triangleNr);break;case"StagePoint":i=this._getGraphicFromStagePoint(o.target)}return a(i).otherwise(function(){return null}).then(function(e){var t=[];(e||l)&&t.push({mapPoint:l,graphic:e});var i={screenPoint:r,results:t};return Z.SCENEVIEW_HITTEST_RETURN_SELECTOR&&(i.selector=s),i})},goTo:function(e,t){return this.stateManager.goTo(e,t)},animateTo:function(e,i){return t.deprecated(this.declaredClass+".animateTo is deprecated. Use .goTo instead.","","4.0"),this.goTo(e,i)},takeScreenshot:function(e){if(!this.ready)return void ee.error("#takeScreenshot()","Scene view cannot be used before it is ready");e=H.adjustScreenshotSettings(e,this);var t=new n;return this._stage.requestScreenCapture(e,function(e){y.schedule(function(){t.resolve(e)})}),t.promise},engineToScreen:function(e,t){var i=te.create();this.state.camera.projectPoint(e,i);var n=i[0],a=this.height-i[1],r=i[2];return t?(t.x=n,t.y=a,t.z=r,t):new _({x:n,y:a,z:r})},getDefaultSpatialReference:function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isSpatialReferenceDone")&&this._initialDefaultSpatialReference||null},validate:function(){var e=T.check();return w("safari")&&w("safari")<9&&(e=new S("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:w("safari")})),e?(ee.warn("#validate()",e.message),R.reject(e)):R.resolve()},isSpatialReferenceSupported:function(e,t){var i=e.isGeographic,n=e.isWebMercator,a=e.isWGS84,r="local"===this.viewingMode,s=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(s){if(r&&i)return!1;if(!r&&!n&&!a)return!1}else if(i&&!a)return!1;if(t)if(K.isTiledLayer(t)){var o;if(s){var l=K.getTiledLayerInfo(t,e,this.viewingMode);o=null!=l.tileInfo}else{var l=K.getTiledLayerInfo(t,e,"global");null==l.tileInfo&&(l=K.getTiledLayerInfo(t,e,"local")),o=null!=l.tileInfo}if(!o)return!1}else if((a||n)&&!r)return null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=e),s||this._internallyReady||(this.viewingMode="global"),!1;return!0},has:function(e){return this._stage.has(e)},flushDisplayModifications:function(){this._stage.processDirty()},getDrawingOrder:function(e){return this.allLayerViews.findIndex(function(t){return t.layer&&t.layer.uid===e})},getViewForGraphic:function(e){return e.layer?this.allLayerViews.find(function(t){return t.layer===e.layer}):this._graphicsView},whenViewForGraphic:function(e){return e.layer?this.whenLayerView(e.layer):R.resolve(this._graphicsView)},renderSpatialReference:null,_graphicsView:null,_surfaceReadyWatchHandle:null,_stageHandles:null,_computeMapPointFromIntersectionResult:function(e,t){if(e.getIntersectionPoint(ie)){t=this._computeMapPointFromVec3d(ie,t);var i=this._get("basemapTerrain");if("terrain"===e.intersector&&i){var n=i.getElevation(t);null!==n&&(t.z=n)}return t}return null},_computeMapPointFromVec3d:function(e,t){var i=this.spatialReference||d.WGS84;return L.vectorToVector(e,this.renderSpatialReference,e,i)||(i=d.WGS84,L.vectorToVector(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new f(e,i),t},_getGraphicFromStageObject:function(e,t){var i=e.getMetadata();if(null!=i&&null!=i.layerUid){if(i.layerUid===this._graphicsView.mockLayerId)return this._graphicsView.getGraphicsFromStageObject(e,t);var n=this.map.findLayerByUid(i.layerUid);if(n)return this.whenLayerView(n).then(function(i){return i&&null!=i.getGraphicsFromStageObject&&!i.suspended?i.getGraphicsFromStageObject(e,t):void 0})}return null},_getGraphicFromStagePoint:function(e){var t=this._computeMapPointFromVec3d(e.point),i=new g(t),n=e.metadata.layerUid;return null!=n&&(i.layer=this.map.findLayerByUid(n)),i},_viewingModeToManifold:function(e){return{local:"planar",global:"spherical"}[e]},_initBasemapTerrain:function(e){this._disposeBasemapTerrain(),this._set("basemapTerrain",new J(this,this._viewingModeToManifold(e))),this._set("elevationProvider",new z({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)},_initGlobe:function(e){this._initCoordinateSystem(),this._initState(),this._stage.setViewParams({backgroundColor:[0,0,0,0],maxFarNearRatio:0,frustumCullingEnabled:!1}),this._initBasemapTerrain(e),this.pointsOfInterest=new Q({view:this}),this._initStateManager()},_initCoordinateSystem:function(){if(this.spatialReference){var e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||(this.mapCoordsHelper=new W(this.map,e));var t=this.renderCoordsHelper?this.renderCoordsHelper.unitInMeters:1,i="global"===this.viewingMode,n=i?L.SphericalECEFSpatialReference:e;if(n!==this.renderSpatialReference&&(this.renderSpatialReference=n,this.renderCoordsHelper=k.createRenderCoordsHelper(i?"global":"local",n),this._stage&&this._stage.setIntersectTolerance(G.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._constraints)){var a=t/this.renderCoordsHelper.unitInMeters;this._constraints.scale(a)}}else this.mapCoordsHelper=null,this.renderCoordsHelper=null,this.renderSpatialReference=null},_cameraAlmostEquals:function(e,t){return Math.abs(e.tilt-t.tilt)<1e-5&&Math.abs(e.heading-t.heading)<1e-5&&Math.abs(e.fov-t.fov)<1e-5&&e.position.equals(t.position)},_evaluateUpdating:function(){var e=0,t=0,i=!1;this.allLayerViews.forEach(function(n){if(n.updating){i=!0;var a=n.updatingPercentage;null!=a&&(++t,e+=a)}}),this._graphicsView&&this._graphicsView.updating&&(i=!0),i!==this.updating&&(this.updating=i),0!==t?e/=t:e=i?100:0,this.updatingPercentage!==e&&(this.updatingPercentage=e)},_updateUpdatingMonitors:function(e){for(var t=0;t<e.removed.length;t++){var i=e.removed[t],n=this._layerViewsUpdatingHandles[i.uid];n&&(delete this._layerViewsUpdatingHandles[i.uid],i.destroyed||n.remove())}for(t=0;t<e.added.length;t++)i=e.added[t],i.destroyed||(n=i.watch(["updating","updatingPercentage"],this._evaluateUpdating),this._layerViewsUpdatingHandles[i.uid]=n);this._evaluateUpdating()},_pickRay:function(e,t,i,n,a,r,s){return this._stage?this._stage.pickRay(e,t,i,n,a,r,s):null},_pickRayWithBeginPoint:function(e,t,i,n,a){return this._stage?this._stage.pickRayWithBeginPoint(e,t,i,n,a):null},_removeHandles:function(e){for(var t=0;t<e.length;t++){var i=e[t];this[i]&&(this[i].remove(),this[i]=null)}},_setCanvas:function(e){e!==this._get("canvas")&&this._set("canvas",e)},_disposeSurface:function(){this._removeHandles(["_stageFrameTask","_updateDrawingOrderHandle","onViewExtentUpdateHandle","_mapLayersChangeHandle"]),this.pointsOfInterest&&(this.pointsOfInterest.destroy(),this.pointsOfInterest=null),this._disposeBasemapTerrain(),this._setNavigation(null),this.environmentManager&&this.environmentManager.disposeRendering()},_disposeBasemapTerrain:function(){var e=this._get("basemapTerrain");e&&(e.destroy(),this._set("basemapTerrain",null))},_disposeNavigation:function(){var e=this._get("navigation");e&&(e.destroy(),this._set("navigation",null))},_setNavigation:function(e){this._get("navigation")!==e&&(this._disposeNavigation(),this._set("navigation",e))},_initStage:function(){var e={};e.deactivatedWebGLExtensions=this.deactivatedWebGLExtensions,e.viewingMode=this.viewingMode,this.renderCanvas&&(e.canvas=this.renderCanvas),this._stage=new D(this.viewingMode,i.byId(this.surface),e),this._stage.selectionState=!1,this._stageHandles.add(M.init(this.qualitySettings,"antialiasingEnabled",function(){this._stage.setRenderParams({antialiasingEnabled:this.qualitySettings.antialiasingEnabled})}.bind(this))),this._stageHandles.add(M.watch(this,this.highlightOptions.keys().map(function(e){return"highlightOptions."+e}),function(){this._stage.setRenderParams({defaultHighlightOptions:F.toEngineOptions(this.highlightOptions)})}.bind(this))),this._stageHandles.add(M.init(this,"highlightOptions",function(){this._stage.setRenderParams({defaultHighlightOptions:F.toEngineOptions(this.highlightOptions)})}.bind(this))),this.renderCoordsHelper&&this._stage.setIntersectTolerance(G.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._setCanvas(this._stage.getCanvas()),this._stageFrameTask=y.addFrameTask(this._stage.getFrameTask())},_initSurface:function(){this._initStage(),this._initGlobe(this.viewingMode),this.sharedSymbolResources=new B({stage:this._stage,viewingMode:this.viewingMode,resourceController:this.resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})},_initGraphicsView:function(){this._surfaceReadyWatchHandle=M.whenTrueOnce(this,"basemapTerrain.ready",function(){this._graphicsView=new Y({view:this,graphics:this.graphics}),this._surfaceReadyWatchHandle=null,this._layerViewsUpdatingHandles[this._graphicsView.mockLayerId]=M.init(this._graphicsView,"updating",this._evaluateUpdating)}.bind(this))},_disposeGraphicsView:function(){if(this._surfaceReadyWatchHandle&&(this._surfaceReadyWatchHandle.remove(),this._surfaceReadyWatchHandle=null),this._graphicsView){var e=this._graphicsView.mockLayerId;this._layerViewsUpdatingHandles[e].remove(),delete this._layerViewsUpdatingHandles[e],this._graphicsView.destroy(),this._graphicsView=null}},_normalizePointArgs:function(e,t,i,n,a){a=a||ae;var r=a.point;return r.spatialReference=void 0,"object"==typeof e?(r.x=e.x,r.y=e.y,r.z=e.z,e.spatialReference&&(r.spatialReference=e.spatialReference),a.retval=t):(r.x=e,r.y=t,"number"!=typeof i&&void 0!==i?(r.z=void 0,a.retval=i):(r.z=i,a.retval=n)),r.spatialReference||(r.spatialReference=this.spatialReference||d.WGS84),a},_initState:function(){this._set("state",new C({viewingMode:this.viewingMode,spatialReference:this.spatialReference}))},_initStateManager:function(){this.stateManager.init()},_viewReadyHandler:function(e,t){if(!t){if("global"===this.viewingMode&&(this._clippingArea=null),this._internallyReady=!0,this._initSurface(),this._initGraphicsView(),!this._externallySet.environment){var i=this.get("map.initialViewProperties.environment");i&&(this.environment=i)}this._updateDrawingOrderHandle=this.allLayerViews.on("change",this._updateDrawingOrder.bind(this)),this._updateDrawingOrder({added:this.allLayerViews.toArray(),removed:[],moved:[]}),this.environmentManager.updateReadyChange(!0)}},_viewUnreadyHandler:function(e,t){t&&(this.activeTool&&(this.activeTool.deactivate(this.inputManager._inputManager),this._set("activeTool",null)),this._initialDefaultSpatialReference=null,this.environmentManager.updateReadyChange(!1),this._disposeGraphicsView(),this._internallyReady=!1,this.stateManager.deinit(),this._disposeSurface(),this.state.destroy(),this._set("state",null),this.sharedSymbolResources&&(this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null),this._stage&&(this._stage.dispose(),this._stage=null,this._stageHandles.remove()),this._setCanvas(null))},_heightModelInfoGetter:function(){var e=this.getDefaultHeightModelInfo();return null!=e?h.deriveUnitFromSR(e,this.spatialReference):null},_isIncompatibleSpatialReference:function(e){return e&&!e.equals(this.spatialReference)&&!c.canProject(e,this.spatialReference)},_updateDrawingOrder:function(){var e=this.allLayerViews.length-1;this.allLayerViews.forEach(function(t,i){null!=t.drawingOrder&&(t.drawingOrder=e-i)},this)},_mapSetter:function(e){e!==this._get("map")&&(this._mapLayersChangeHandle&&(this._mapLayersChangeHandle.remove(),this._mapLayersChangeHandle=null),e&&(this._mapLayersChangeHandle=e.allLayers.on("change",this.notifyChange.bind(this,"dataExtent"))),this.inherited(arguments))}});return re});