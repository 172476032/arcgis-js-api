// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","dojo/_base/lang","../../libs/gl-matrix/mat2d","../../libs/gl-matrix/mat2dExtras","../../../../core/screenUtils","../../../../geometry/Polygon","../../../../symbols/SimpleMarkerSymbol","../../../../symbols/support/gfxUtils","../../../../Color"],function(t,e,r,n,i,a,l,o,s,c){function u(t){return"simple-marker"===t.type}function p(t){return"picture-marker"===t.type}function f(t){return"simple-line"===t.type}function h(t){return"picture-fill"===t.type}function y(t){return"text"===t.type}function g(t){return"extent"===t.type}function d(t){return"polygon"===t.type}function S(t){return"polyline"===t.type}function v(t,e){return e.toRgba?(t[0]=e.r,t[1]=e.g,t[2]=e.b,t[3]=e.a):(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]),t}function x(t,e,r){return null!=r&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=r),t}function m(t,e,r){var n=e[0]/e[1];return t[0]=t[1]=1,isNaN(r)||(n>1?(t[0]=r/e[0],t[1]=r/n/e[1]):(t[1]=r/e[1],t[0]=r*n/e[0])),t}function b(t,e,r,l,c,f,h){var g,d,S=c.symbol,v=t.toScreenPoint(R,r,h[0]),x=[v.x,v.y],b=v.x,T=v.y,A=c.heading,M=c.size&&c.size[0];n.identity(C),"number"==typeof M&&(d=isFinite(M)&&M);var _=d&&isFinite(d)&&!isNaN(d);d=_?a.pt2px(d):NaN,f&&i.rotategAt(C,C,f,x),A&&i.rotategAt(C,C,A,x);var Y,P=a.pt2px(S.xoffset),F=a.pt2px(S.yoffset);(0!==P||0!==F)&&(Y=[P,-F]);var z=null;0!==S.angle&&(z=n.create(),i.rotategAt(z,z,S.angle,x));var O;if(u(S)){var G=S.style,I=Math.round;d=_?d:a.pt2px(S.size);var U=void 0;switch(G){case o.STYLE_SQUARE:case o.STYLE_CROSS:case o.STYLE_X:case o.STYLE_DIAMOND:U=isNaN(d)?16:.5*d,g=k(e,l,L(G,b,T,I(b-U),I(b+U),I(T-U),I(T+U)));break;case o.STYLE_PATH:var B=k(e,l,S.path);g=B;var D=B.getBoundingBox(),V=m(n.create(),[D.width,D.height],d);(1!==V[0]||1!==V[3])&&i.scaleAt(C,C,V,x),O=[-(D.x+.5*D.width)+b,-(D.y+.5*D.height)+T];break;default:U=isNaN(d)?16:.5*d,g=E(e,l,{cx:b,cy:T,r:U})}}else if(p(S)){var j=null,X=null,q=a.pt2px(S.width),Q=a.pt2px(S.height);_?(X=d,j=X*(q/Q)):(j=q,X=Q),Y&&(null!=Y[0]&&(Y[0]=j*(Y[0]/q)),null!=Y[1]&&(Y[1]=X*(Y[1]/Q))),g=w(e,l,{x:b-.5*j,y:T-.5*X,width:j,height:X,src:S.url});var Z=g.getNode();Z&&(null!=c.opacity?Z.setAttribute("opacity",c.opacity.toString()):Z.setAttribute("opacity","1"))}else if(y(S)){var H=S.font&&S.font.clone();H&&(H.size=_?d:a.pt2px(H.size)),g=N(e,l,{type:"text",text:S.text,x:b,y:T,align:s.getSVGAlign(S),decoration:S.decoration||H&&H.decoration,rotated:S.rotated,kerning:S.kerning}),H&&g.setFont(H);var Z=g.getNode(),W=s.getSVGBaseline(S),J=s.getSVGBaselineShift(S);Z&&(Z.setAttribute("dominant-baseline",W),J&&Z.setAttribute("baseline-shift",J))}return Y&&n.translate(C,C,Y),z&&n.multiply(C,C,z),O&&n.translate(C,C,O),g.setTransform(C),g}function T(t,e,r,n,i,a,l){var o=i.symbol,s=r.points,c=n||e.createGroup(),u=[0];c.children[0]&&_(o,c.children[0])&&c.clear();for(var p=0,f=s.length,h=0;f>h;h++)for(var y=s[h],g=l.length,d=0;g>d;d++)u[0]=l[d],c.add(b(t,c,{x:y[0],y:y[1]},c.children[p++],i,a,u));var S=c.children.length;if(s.length*l.length<S)for(var v=s.length*l.length,h=S-1;h>=v;h--)c.children[h].removeShape();return c}function A(t,e,r,n,i){var a=[];if(g(r)&&(r=l.fromExtent(r)),S(r)||d(r)){for(var o=i.length,s=0;o>s;s++)a=a.concat(t.toScreenPath(r,i[s]));n=k(e,n,a)}return n}function M(t,e,r){return e?e.setShape(r):t.createRect(r)}function w(t,e,r){return e?e.setShape(r):t.createImage(r)}function E(t,e,r){return e?e.setShape(r):t.createCircle(r)}function k(t,e,r){var n=Array.isArray(r)?r.join(" "):r;return e?e.setShape(n):t.createPath(n)}function N(t,e,r){return e?e.setShape(r):t.createText(r)}function _(t,e){var r=e&&e.shape&&e.shape.type,n=t&&t.type,i=t&&t.style;return n&&(i=z[n]||i),O[i]&&(i="path"),!(!r||!i||r===i)}function L(t,e,r,n,i,a,l,s){switch(t){case o.STYLE_SQUARE:return["M",n+","+a,i+","+a,i+","+l,n+","+l,"Z"];case o.STYLE_CROSS:return["M",e+","+a,e+","+l,"M",n+","+r,i+","+r];case o.STYLE_X:return["M",n+","+a,i+","+l,"M",n+","+l,i+","+a];case o.STYLE_DIAMOND:return["M",e+","+a,i+","+r,e+","+l,n+","+r,"Z"];case o.STYLE_TARGET:return["M",n+","+a,i+","+a,i+","+l,n+","+l,n+","+a,"M",n-s+","+r,n+","+r,"M",e+","+(a-s),e+","+a,"M",i+s+","+r,i+","+r,"M",e+","+(l+s),e+","+l]}}function Y(t,e){var n=e.symbol;if(!p(n)){var i=s.getFill(n);if(u(n)){var a=n.style,l=s.getStroke(n),c=l&&l.color,f=a===o.STYLE_X||a===o.STYLE_CROSS,h=e.opacity,g=e.color||v([0,0,0,0],f?c:i);g&&null!=h&&(g=x([0,0,0,0],g,h)),g&&(f?g!==c&&(l=l?r.mixin({},l):{},l.color=g):g!==i&&(i=g)),t.setFill(i).setStroke(l)}else if(y(n)){var h=e.opacity,g=e.color||v([0,0,0,0],i);g&&null!=h&&(g=x([0,0,0,0],g,h)),g&&g!==i&&(i=g),t.setFill(i)}}}function P(t,e){for(var r=t.children,n=r.length,i=0;n>i;i++)Y(t.children[i],e)}function F(t,e){var n,i=e.symbol,l=e.size,o=e.color,u=e.opacity,p=s.getStroke(i),y=s.getFill(i),g=!1;f(i)?(g=!0,n="none"!==i.style):n=i.outline&&"none"!==i.outline.style;var d,S,m;l&&(m=isFinite(l[0])&&l[0]),null!=l&&(m=a.pt2px(m));var b=h(i);!o&&null==u||b||(g?(d=o||p&&p.color&&v([0,0,0,0],p.color),d&&null!=u&&(d=x(d,d,u))):y&&(S=o||v([0,0,0,0],y),S&&null!=u&&(S=x(S,S,u)))),!n||null==l&&!d?t.setStroke(p):t.setStroke(r.mixin({},p,null!=m?{width:m}:null,d&&{color:d}));var T=y,A=o&&new c(o)||i.color;T&&"pattern"===T.type&&A&&!b?s.getPatternUrlWithColor(T.src,A.toCss(!0)).then(function(e){T.src=e,t.setFill(T)}):t.setFill(S||y),t.rawNode.setAttribute("vector-effect","non-scaling-stroke")}Object.defineProperty(e,"__esModule",{value:!0}),e.getScalingVector=m;var R={x:0,y:0},C=n.create();e.drawPoint=b,e.drawMarkers=T,e.drawShape=A,e.drawRect=M,e.drawImage=w,e.drawCircle=E,e.drawPath=k,e.drawText=N;var z={"picture-marker":"image","picture-fill":"path","simple-fill":"path","simple-line":"path",text:"text"},O={square:1,cross:1,x:1,diamond:1,target:1};e.isShapeInvalid=_,e.smsToPath=L,e.stylePoint=Y,e.styleMarkers=P,e.styleShape=F});