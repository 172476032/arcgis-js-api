// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","dojo/_base/lang","dojox/gfx/matrix","../../../../core/screenUtils","../../../../geometry/Polygon","../../../../symbols/SimpleMarkerSymbol","../../../../symbols/support/gfxUtils"],function(e,t,r,n,i,a,o,l){function s(e){return"simple-marker-symbol"===e.type}function c(e){return"picture-marker-symbol"===e.type}function u(e){return"simple-line-symbol"===e.type}function p(e){return"picture-fill-symbol"===e.type}function h(e){return"text-symbol"===e.type}function y(e){return"extent"===e.type}function f(e){return"polygon"===e.type}function g(e){return"polyline"===e.type}function d(e,t){return t.toRgba?(e[0]=t.r,e[1]=t.g,e[2]=t.b,e[3]=t.a):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]),e}function m(e,t,r){return null!=r&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=r),e}function x(e,t){var r=e.width/e.height,n=1,i=1;return isNaN(t)||(r>1?(n=t/e.width,i=t/r/e.height):(i=t/e.height,n=t*r/e.width)),{xx:n,yy:i}}function S(e,t,r,a,u,p,y){var f,g,d=u.symbol,m=e.toScreenPoint(F,r,y[0]),S=m.x,v=m.y,b=[],T=u.rotationAngle,E=u.size&&u.size[0];"number"==typeof E&&(g=isFinite(E)&&E);var _=g&&isFinite(g)&&!isNaN(g);g=_?i.pt2px(g):NaN,p&&b.push(n.rotategAt(p,m)),T&&b.push(n.rotategAt(T,m));var L=i.pt2px(d.xoffset),Y=i.pt2px(d.yoffset);if((0!==L||0!==Y)&&b.push(n.translate(L,-Y)),0!==d.angle&&b.push(n.rotategAt(d.angle,m)),s(d)){var P=d.style,R=Math.round;g=_?g:i.pt2px(d.size);var z=void 0;switch(P){case o.STYLE_SQUARE:case o.STYLE_CROSS:case o.STYLE_X:case o.STYLE_DIAMOND:z=isNaN(g)?16:.5*g,f=A(t,a,N(P,S,v,R(S-z),R(S+z),R(v-z),R(v+z)));break;case o.STYLE_PATH:f=A(t,a,d.path);var D=f.getBoundingBox(),C=x(D,g);(1!==C.xx||1!==C.yy)&&b.push(n.scaleAt(C.xx,C.yy,m.x,m.y)),b.push(n.translate(-(D.x+.5*D.width)+S,-(D.y+.5*D.height)+v));break;default:z=isNaN(g)?16:.5*g,f=M(t,a,{cx:S,cy:v,r:z})}}else if(c(d)){var G=_?g:i.pt2px(d.width),I=_?g:i.pt2px(d.height),O=d.source,B=null;O&&O.imageData&&(B="data:"+(O.contentType||"image")+";base64,"+O.imageData),f=w(t,a,{x:S-.5*G,y:v-.5*I,width:G,height:I,src:B||d.url})}else if(h(d)){var U=d.font&&d.font.clone();U&&(U.size=_?g:i.pt2px(U.size)),f=k(t,a,{type:"text",text:d.text,x:S,y:v,align:l.getSVGAlign(d),decoration:d.decoration||U&&U.decoration,rotated:d.rotated,kerning:d.kerning}),U&&f.setFont(U);var j=f.getNode(),V=l.getSVGBaseline(d),X=l.getSVGBaselineShift(d);j&&(j.setAttribute("dominant-baseline",V),X&&j.setAttribute("baseline-shift",X))}return f.setTransform(n.multiply(b)),f}function v(e,t,r,n,i,a,o){var l=i.symbol,s=r.points,c=n||t.createGroup(),u=[0];c.children[0]&&E(l,c.children[0])&&c.clear();for(var p=0,h=s.length,y=0;h>y;y++)for(var f=s[y],g=o.length,d=0;g>d;d++)u[0]=o[d],c.add(S(e,c,{x:f[0],y:f[1]},c.children[p++],i,a,u));var m=c.children.length;if(s.length*o.length<m)for(var x=s.length*o.length,y=m-1;y>=x;y--)c.children[y].removeShape();return c}function b(e,t,r,n,i){var o=[];if(y(r)&&(r=a.fromExtent(r)),g(r)||f(r)){for(var l=i.length,s=0;l>s;s++)o=o.concat(e.toScreenPath(r,i[s]));n=A(t,n,o)}return n}function T(e,t,r){return t?t.setShape(r):e.createRect(r)}function w(e,t,r){return t?t.setShape(r):e.createImage(r)}function M(e,t,r){return t?t.setShape(r):e.createCircle(r)}function A(e,t,r){var n=Array.isArray(r)?r.join(" "):r;return t?t.setShape(n):e.createPath(n)}function k(e,t,r){return t?t.setShape(r):e.createText(r)}function E(e,t){var r=t&&t.shape&&t.shape.type,n=e&&e.type,i=e&&e.style;return n&&(i=P[n]||i),R[i]&&(i="path"),!(!r||!i||r===i)}function N(e,t,r,n,i,a,l,s){switch(e){case o.STYLE_SQUARE:return["M",n+","+a,i+","+a,i+","+l,n+","+l,"Z"];case o.STYLE_CROSS:return["M",t+","+a,t+","+l,"M",n+","+r,i+","+r];case o.STYLE_X:return["M",n+","+a,i+","+l,"M",n+","+l,i+","+a];case o.STYLE_DIAMOND:return["M",t+","+a,i+","+r,t+","+l,n+","+r,"Z"];case o.STYLE_TARGET:return["M",n+","+a,i+","+a,i+","+l,n+","+l,n+","+a,"M",n-s+","+r,n+","+r,"M",t+","+(a-s),t+","+a,"M",i+s+","+r,i+","+r,"M",t+","+(l+s),t+","+l]}}function _(e,t){var n=t.symbol;if(!c(n)){var i=l.getFill(n);if(s(n)){var a=n.style,u=l.getStroke(n),p=u&&u.color,y=a===o.STYLE_X||a===o.STYLE_CROSS,f=t.opacity,g=t.color||d([0,0,0,0],y?p:i);g&&null!=f&&(g=m([0,0,0,0],g,f)),g&&(y?g!==p&&(u=u?r.mixin({},u):{},u.color=g):g!==i&&(i=g)),e.setFill(i).setStroke(u)}else if(h(n)){var f=t.opacity,g=t.color||d([0,0,0,0],i);g&&null!=f&&(g=m([0,0,0,0],g,f)),g&&g!==i&&(i=g),e.setFill(i)}}}function L(e,t){for(var r=e.children,n=r.length,i=0;n>i;i++)_(e.children[i],t)}function Y(e,t){var n,a=t.symbol,o=t.size,s=t.color,c=t.opacity,h=l.getStroke(a),y=l.getFill(a),f=!1;u(a)?(f=!0,n="none"!==a.style):n=a.outline&&"none"!==a.outline.style;var g,x,S;o&&(S=isFinite(o[0])&&o[0]),null!=o&&(S=i.pt2px(S)),!s&&null==c||p(a)||(f?(g=s||h&&h.color&&d([0,0,0,0],h.color),g&&null!=c&&(g=m(g,g,c))):y&&(x=s||d([0,0,0,0],y),x&&null!=c&&(x=m(x,x,c)))),!n||null==o&&!g?e.setStroke(h):e.setStroke(r.mixin({},h,null!=S?{width:S}:null,g&&{color:g})),e.setFill(x||y),e.rawNode.setAttribute("vector-effect","non-scaling-stroke")}t.getScaleMatrix=x;var F={x:0,y:0};t.drawPoint=S,t.drawMarkers=v,t.drawShape=b,t.drawRect=T,t.drawImage=w,t.drawCircle=M,t.drawPath=A,t.drawText=k;var P={"picture-marker-symbol":"image","picture-fill-symbol":"path","simple-fill-symbol":"path","simple-line-symbol":"path","text-symbol":"text"},R={square:1,cross:1,x:1,diamond:1,target:1};t.isShapeInvalid=E,t.smsToPath=N,t.stylePoint=_,t.styleMarkers=L,t.styleShape=Y});