// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../../../core/ArrayPool","../../../../core/screenUtils","../../../../core/libs/earcut/earcut","./Utils","./visualVariablesUtils","./MeshData","./enums","./lineMeshUtil"],function(e,t,o,u,s,r,i,h,a,p){function n(e,t,o,s,a,p,n){var l,c,v,y,g,m,M,w,x,S=h.pool.acquire(),V=0,N=0,z=t.heatmapInfo;if(z){var I=Math.round(t.heatmapInfo.radius);l=0,c=0,v=I,y=I,g=[1,1,1,1],m=[0,0,0,0],M=I,w=I,x=0}else{var P=s.spriteMosaicItem;l=Math.round(P.rect.x/4),c=Math.round(P.rect.y/4),v=l+Math.round(P.rect.width/4),y=c+Math.round(P.rect.height/4),V=0|n.xoffset,N=0|n.yoffset,g=r.isPictureSymbol(n)?[255,255,255,255]:r.copyAndPremultiply(n.color),M=Math.round(u.pt2px(n.width||n.size)),w=Math.round(u.pt2px(n.height||n.size)),n.outline?(m=null!=n.outline.color?r.copyAndPremultiply(n.outline.color):[255,255,255,255],x=null!=n.outline.width?Math.round(u.pt2px(n.outline.width)):0):(m=[0,0,0,0],x=0)}var T=p.centroid||p.geometry,b=T.x,A=T.y,C=64,L=[];V*=a,N*=a;var O=r.i1616to32(b+V,A+N),R=r.i8888to32(g[0],g[1],g[2],g[3]),U=r.i8888to32(m[0],m[1],m[2],m[3]),G=r.i8888to32(M,w,x,0),F=r.numTo32(e),q=0,H=0,W=0,D=0,E=0,_=o.vvColor||o.vvOpacity||o.vvRotation||o.vvSizeMinMaxValue||o.vvSizeScaleStops||o.vvSizeFieldStops||o.vvSizeUnitValue;if(_){var j=t.vvFields,K=j.rotation?t.getValue(p,j.rotation):0,k=j.opacity?t.getValue(p,j.opacity):0,B=j.color?t.getValue(p,j.color):0,J=j.size&&!o.vvSizeScaleStops?t.getValue(p,j.size):0;o.vvSizeUnitValue&&(J=i.getVisualVariableSizeValueRepresentationRatio(J,t.vvRanges.size.unitValue.valueRepresentation)),isNaN(J)&&(J=1),isNaN(K)&&(K=1),isNaN(k)&&(k=1),isNaN(B)&&(B=1),f[0]=J,q=d[0],f[0]=k,H=d[0],f[0]=K,W=d[0],f[0]=B,D=d[0]}return z&&(f[0]=t.heatmapInfo.getIntensity(p),E=d[0]),L.push(O),L.push(r.i8888to32(-.5*C,-.5*C,l,c)),L.push(F),L.push(R),L.push(U),L.push(G),_?(L.push(q),L.push(D),L.push(H),L.push(W)):z&&L.push(E),L.push(O),L.push(r.i8888to32(.5*C,-.5*C,v,c)),L.push(F),L.push(R),L.push(U),L.push(G),_?(L.push(q),L.push(D),L.push(H),L.push(W)):z&&L.push(E),L.push(O),L.push(r.i8888to32(-.5*C,.5*C,l,y)),L.push(F),L.push(R),L.push(U),L.push(G),_?(L.push(q),L.push(D),L.push(H),L.push(W)):z&&L.push(E),L.push(O),L.push(r.i8888to32(.5*C,.5*C,v,y)),L.push(F),L.push(R),L.push(U),L.push(G),_?(L.push(q),L.push(D),L.push(H),L.push(W)):z&&L.push(E),_?S.update({geometry:L},4,[0,1,2,1,3,2]):S.update({geometry:L},4,[0,1,2,1,3,2]),S}function l(e,t,u,i,a,p){var n=h.pool.acquire(),l=null!=i?i.spriteMosaicItem:null,c=a.geometry,v=r.isPictureSymbol(p),y=!v&&p.color?r.copyAndPremultiply(p.color):[255,255,255,255],g=r.numTo32(e),m=u.vvColor||u.vvOpacity,M=0,w=0;if(m){var x=t.vvFields,S=x.opacity?t.getValue(a,x.opacity):0,V=x.color?t.getValue(a,x.color):0;isNaN(S)&&(S=1),isNaN(V)&&(V=1),f[0]=S,M=d[0],f[0]=V,w=d[0]}var N=r.i8888to32(y[0],y[1],y[2],y[3]),z=[0,0],I=[0,0];if(l){var P=1,T=l.rect.x,b=l.rect.y,A=l.width,C=l.height;z[0]=T+P,z[1]=b+P,I[0]=T+P+A,I[1]=b+P+C}for(var L=v&&p.width&&p.height?[r.nextHighestPowerOfTwo(p.width),r.nextHighestPowerOfTwo(p.height),0,0]:[r.nextHighestPowerOfTwo(I[0]-z[0]),r.nextHighestPowerOfTwo(I[1]-z[1]),0,0],O=r.i8888to32(L[0],L[1],L[2],L[3]),R=0,U=0,G=c.rings;U<G.length;U++){var F=G[U];R+=F.length}for(var q,H=o.acquire(),W=[],D=0,E=0,_=c.rings;E<_.length;E++){var F=_[E],j=D,K=0,k=F.length,B=F[0][0],J=F[0][1];H.push(B),H.push(J),D++,D++;for(var Q=1;k>Q;++Q){var X=F[Q][0],Y=F[Q][1];K-=X*(J+J+Y),B+=X,J+=Y,H.push(B),H.push(J),D++,D++}K>0?(q&&W.push(q),q={holeIndices:[],offset:j,coordCount:2*k}):0>K?q&&(q.holeIndices.push((j-q.offset)/2),q.coordCount+=2*k):(D=j,H.splice(j))}q&&W.push(q);for(var Z=[],$=[],ee=0,te=0,oe=W;te<oe.length;te++){var ue=oe[te],se=H.slice(ue.offset,ue.offset+ue.coordCount),re=s(se,ue.holeIndices,2),ie=re.length;if(ie>0){for(var he=0;he<ue.coordCount;)Z.push(r.i1616to32(se[he++],se[he++])),Z.push(g),Z.push(N),Z.push(r.i1616to32(z[0],z[1])),Z.push(r.i1616to32(I[0],I[1])),Z.push(O),m&&(Z.push(w),Z.push(M));for(var ae=0;ie>ae;)$.push(re[ae++]+ee),$.push(re[ae++]+ee),$.push(re[ae++]+ee);ee+=ue.coordCount/2}}return o.release(H),n.update({geometry:Z},ee,$),n}function c(e,t,o,u,s,r,i,h){return null}function v(e,t,o,u,s,r,i,h,c){switch(s){case a.WGLGeometryType.MARKER:return n(e,t,o,u,i,h,c);case a.WGLGeometryType.FILL:return l(e,t,o,u,h,c);case a.WGLGeometryType.LINE:return p.createLineMeshData(e,t,o,u,r,i,h,c)}return null}Object.defineProperty(t,"__esModule",{value:!0});var f=new Float32Array(1),d=new Uint32Array(f.buffer);t.createTextMesh=c,t.createMesh=v});