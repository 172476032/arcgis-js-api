// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/ArrayPool","../../../../core/screenUtils","../../../../core/libs/earcut/earcut","./Utils","./visualVariablesUtils","./MeshData","./enums","./lineMeshUtil"],function(e,t,o,u,s,i,r,h,p,a){function n(e,t,o,s,p,a,n){var l,c,v,y,g,m,M,w,x,S=h.pool.acquire(),V=0,N=0,z=t.heatmapInfo;if(z){var I=Math.round(t.heatmapInfo.radius);l=0,c=0,v=I,y=I,g=[1,1,1,1],m=[0,0,0,0],M=I,w=I,x=0}else{var P=s.spriteMosaicItem;l=Math.round(P.rect.x/4),c=Math.round(P.rect.y/4),v=l+Math.round(P.rect.width/4),y=c+Math.round(P.rect.height/4),V=0|n.xoffset,N=0|n.yoffset,g=i.isPictureSymbol(n)?[255,255,255,255]:i.copyAndPremultiply(n.color),M=Math.round(u.pt2px(n.width||n.size)),w=Math.round(u.pt2px(n.height||n.size)),n.outline?(m=null!=n.outline.color?i.copyAndPremultiply(n.outline.color):[255,255,255,255],x=null!=n.outline.width?Math.round(u.pt2px(n.outline.width)):0):(m=[0,0,0,0],x=0)}var T=a.centroid||a.geometry,b=T.x,A=T.y,C=64,L=[];V*=p,N*=p;var O=i.i1616to32(b+V,A+N),R=i.i8888to32(g[0],g[1],g[2],g[3]),U=i.i8888to32(m[0],m[1],m[2],m[3]),G=i.i8888to32(M,w,x,0),F=i.numTo32(e),q=0,H=0,W=0,D=0,E=0,_=o.vvColor||o.vvOpacity||o.vvRotation||o.vvSizeMinMaxValue||o.vvSizeScaleStops||o.vvSizeFieldStops||o.vvSizeUnitValue;if(_){var j=t.vvFields,K=j.rotation?t.getValue(a,j.rotation):0,k=j.opacity?t.getValue(a,j.opacity):0,B=j.color?t.getValue(a,j.color):0,J=j.size&&!o.vvSizeScaleStops?t.getValue(a,j.size):0;o.vvSizeUnitValue&&(J=r.getVisualVariableSizeValueRepresentationRatio(J,t.vvRanges.size.unitValue.valueRepresentation)),isNaN(J)&&(J=1),isNaN(K)&&(K=1),isNaN(k)&&(k=1),isNaN(B)&&(B=1),f[0]=J,q=d[0],f[0]=k,H=d[0],f[0]=K,W=d[0],f[0]=B,D=d[0]}return z&&(f[0]=t.heatmapInfo.getIntensity(a),E=d[0]),L.push(O),L.push(i.i8888to32(-.5*C,-.5*C,l,c)),L.push(F),L.push(R),L.push(U),L.push(G),_?(L.push(q),L.push(D),L.push(H),L.push(W)):z&&L.push(E),L.push(O),L.push(i.i8888to32(.5*C,-.5*C,v,c)),L.push(F),L.push(R),L.push(U),L.push(G),_?(L.push(q),L.push(D),L.push(H),L.push(W)):z&&L.push(E),L.push(O),L.push(i.i8888to32(-.5*C,.5*C,l,y)),L.push(F),L.push(R),L.push(U),L.push(G),_?(L.push(q),L.push(D),L.push(H),L.push(W)):z&&L.push(E),L.push(O),L.push(i.i8888to32(.5*C,.5*C,v,y)),L.push(F),L.push(R),L.push(U),L.push(G),_?(L.push(q),L.push(D),L.push(H),L.push(W)):z&&L.push(E),S.update({geometry:L},4,[0,1,2,1,3,2]),S}function l(e,t,u,r,p,a){var n=h.pool.acquire(),l=null!=r?r.spriteMosaicItem:null,c=p.geometry,v=i.isPictureSymbol(a),y=!v&&a.color?i.copyAndPremultiply(a.color):[255,255,255,255],g=i.numTo32(e),m=u.vvColor||u.vvOpacity,M=0,w=0;if(m){var x=t.vvFields,S=x.opacity?t.getValue(p,x.opacity):0,V=x.color?t.getValue(p,x.color):0;isNaN(S)&&(S=1),isNaN(V)&&(V=1),f[0]=S,M=d[0],f[0]=V,w=d[0]}var N=i.i8888to32(y[0],y[1],y[2],y[3]),z=[0,0],I=[0,0];if(l){var P=1,T=l.rect.x,b=l.rect.y,A=l.width,C=l.height;z[0]=T+P,z[1]=b+P,I[0]=T+P+A,I[1]=b+P+C}for(var L,O=v&&a.width&&a.height?[i.nextHighestPowerOfTwo(a.width),i.nextHighestPowerOfTwo(a.height),0,0]:[i.nextHighestPowerOfTwo(I[0]-z[0]),i.nextHighestPowerOfTwo(I[1]-z[1]),0,0],R=i.i8888to32(O[0],O[1],O[2],O[3]),U=o.acquire(),G=[],F=0,q=0,H=c.rings;q<H.length;q++){var W=H[q],D=F,E=0,_=W.length,j=W[0][0],K=W[0][1];U.push(j),U.push(K),F++,F++;for(var k=1;_>k;++k){var B=W[k][0],J=W[k][1];E-=B*(K+K+J),j+=B,K+=J,U.push(j),U.push(K),F++,F++}E>0?(L&&G.push(L),L={holeIndices:[],offset:D,coordCount:2*_}):0>E?L&&(L.holeIndices.push((D-L.offset)/2),L.coordCount+=2*_):(F=D,U.splice(D))}L&&G.push(L);for(var Q=[],X=[],Y=0,Z=0,$=G;Z<$.length;Z++){var ee=$[Z],te=U.slice(ee.offset,ee.offset+ee.coordCount),oe=s(te,ee.holeIndices,2),ue=oe.length;if(ue>0){for(var se=0;se<ee.coordCount;)Q.push(i.i1616to32(te[se++],te[se++])),Q.push(g),Q.push(N),Q.push(i.i1616to32(z[0],z[1])),Q.push(i.i1616to32(I[0],I[1])),Q.push(R),m&&(Q.push(w),Q.push(M));for(var ie=0;ue>ie;)X.push(oe[ie++]+Y),X.push(oe[ie++]+Y),X.push(oe[ie++]+Y);Y+=ee.coordCount/2}}return o.release(U),n.update({geometry:Q},Y,X),n}function c(e,t,o,u,s,i,r){return null}function v(e,t,o,u,s,i,r,h,c,v){switch(s){case p.WGLGeometryType.MARKER:return n(e,t,o,u,r,c,v);case p.WGLGeometryType.FILL:return l(e,t,o,u,c,v);case p.WGLGeometryType.LINE:return a.createLineMeshData(e,t,o,u,i,r,h,c,v)}return null}Object.defineProperty(t,"__esModule",{value:!0});var f=new Float32Array(1),d=new Uint32Array(f.buffer);t.createTextMesh=c,t.createMesh=v});