// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/ObjectPool","./enums","./MaterialInfo","./Utils"],function(e,o,t,r,n,i){var l=function(){function e(){this.symbolLevels=[]}return e.prototype.release=function(){this.symbolLevels.forEach(function(e){m.pool.release(e)}),this.symbolLevels.length=0},Object.defineProperty(e.prototype,"empty",{get:function(){return!this.symbolLevels||0===this.symbolLevels.length},enumerable:!0,configurable:!0}),e.prototype.addToList=function(e){var o=this;e.forEach(function(e){o._addToList(e)})},e.prototype.removeFromList=function(e){var o=this;e.forEach(function(e){o._removeFromList(e)})},e.prototype._addToList=function(e){var o=e.symbolLevel,t=e.zOrder,r=this._getDisplayList(o,t,e.geometryType),n=r.length>0?r[r.length-1]:null;if(null!==n&&i.isSameMaterialInfo(n.materialInfo,e.materialInfo)&&n.indexFrom+n.indexCount===e.indexFrom)n.indexCount+=e.indexCount;else{var l=s.pool.acquire();l.indexFrom=e.indexFrom,l.indexCount=e.indexCount,l.materialInfo=e.materialInfo,l.geometryType=e.geometryType,r.push(l)}},e.prototype._removeFromList=function(e){for(var o=e.symbolLevel,t=e.zOrder,r=this._getDisplayList(o,t,e.geometryType),i=r.length,l=void 0,a=0;i>a;++a){var f=r[a];e.indexFrom+e.indexCount>f.indexFrom&&e.indexFrom<f.indexFrom+f.indexCount&&(l=a)}if(void 0!==l){var f=r[l];if(e.indexFrom<f.indexFrom)f.indexCount-=e.indexCount,f.indexFrom+=e.indexCount;else if(e.indexFrom+e.indexCount>f.indexFrom+f.indexCount)f.indexCount-=e.indexCount;else{var m=f.indexFrom,u=e.indexFrom-f.indexFrom,y=e.indexCount,h=f.indexFrom+f.indexCount-(e.indexFrom+e.indexCount);f.indexCount=u;var p=s.pool.acquire();p.geometryType=f.geometryType,p.materialInfo=n.pool.acquire(),p.materialInfo.copy(f.materialInfo),p.indexFrom=m+u+y,p.indexCount=h,r.splice(l+1,0,p)}}},e.prototype._getDisplayList=function(e,o,t){for(var n,i=this.symbolLevels.length,l=0;i>l;l++)if(this.symbolLevels[l].symbolLevel===e){n=this.symbolLevels[l];break}n||(n=m.pool.acquire(),n.symbolLevel=e,this.symbolLevels.push(n));for(var s,u=n.zLevels.length,y=0;u>y;y++)if(n.zLevels[y].zLevel===o){s=n.zLevels[y];break}s||(s=f.pool.acquire(),s.geometryDPInfo=a.pool.acquire(),s.zLevel=o,n.zLevels.push(s));var h;switch(t){case r.WGLGeometryType.FILL:s.geometryDPInfo.fill||(s.geometryDPInfo.fill=[]),h=s.geometryDPInfo.fill;break;case r.WGLGeometryType.LINE:s.geometryDPInfo.line||(s.geometryDPInfo.line=[]),h=s.geometryDPInfo.line;break;case r.WGLGeometryType.MARKER:s.geometryDPInfo.marker||(s.geometryDPInfo.marker=[]),h=s.geometryDPInfo.marker;break;case r.WGLGeometryType.TEXT:s.geometryDPInfo.text||(s.geometryDPInfo.text=[]),h=s.geometryDPInfo.text;break;default:console.error("Trying to add a record with geometry type '"+t+"'.")}return h},e.serialize=function(e,o,t){var r=0;o&&(o[t+r]=e.symbolLevels.length),++r;for(var n=0,i=e.symbolLevels;n<i.length;n++){var l=i[n];o&&(o[t+r]=l.symbolLevel),++r,o&&(o[t+r]=l.zLevels.length),++r;for(var s=0,a=l.zLevels;s<a.length;s++){var f=a[s];o&&(o[t+r]=f.zLevel),++r;var m=f.geometryDPInfo;r+=this._serializeDisplayListInfo(m.fill,o,t+r),r+=this._serializeDisplayListInfo(m.line,o,t+r),r+=this._serializeDisplayListInfo(m.marker,o,t+r),r+=this._serializeDisplayListInfo(m.text,o,t+r)}}return r},e.deserialize=function(e,o,t){var n=0,i=o[t+n];++n;for(var l=0;i>l;++l){var s=m.pool.acquire();s.symbolLevel=o[t+n],++n,e.symbolLevels.push(s);var a=o[t+n];++n;for(var u=0;a>u;++u){var y=f.pool.acquire();y.zLevel=o[t+n],++n,s.zLevels.push(y);var h=[];n+=this._deserializeDisplayListInfo(h,r.WGLGeometryType.FILL,o,t+n),h.length>0?y.geometryDPInfo.fill=h:y.geometryDPInfo.fill=null;var p=[];n+=this._deserializeDisplayListInfo(p,r.WGLGeometryType.LINE,o,t+n),p.length>0?y.geometryDPInfo.line=p:y.geometryDPInfo.line=null;var v=[];n+=this._deserializeDisplayListInfo(v,r.WGLGeometryType.MARKER,o,t+n),v.length>0?y.geometryDPInfo.marker=v:y.geometryDPInfo.marker=null;var d=[];n+=this._deserializeDisplayListInfo(d,r.WGLGeometryType.TEXT,o,t+n),d.length>0?y.geometryDPInfo.text=d:y.geometryDPInfo.text=null}}return n},e._serializeDisplayListInfo=function(e,o,t){var r=0;if(e){r+=i.serializeInteger(e.length,o,t+r);for(var l=0,s=e;l<s.length;l++){var a=s[l];r+=n.serialize(a.materialInfo,o,t+r),r+=i.serializeInteger(a.indexFrom,o,t+r),r+=i.serializeInteger(a.indexCount,o,t+r)}}else o&&(o[t+r]=0),++r;return r},e._deserializeDisplayListInfo=function(e,o,t,r){var l={n:void 0},a=0;a+=i.deserializeInteger(l,t,r+a);var f=l.n;e.length=f;for(var m=0;f>m;++m){var u=s.pool.acquire();u.geometryType=o;var y={materialInfo:null};a+=n.deserialize(y,t,r+a),u.materialInfo=y.materialInfo,a+=i.deserializeInteger(l,t,r+a),u.indexFrom=l.n,a+=i.deserializeInteger(l,t,r+a),u.indexCount=l.n,e[m]=u}return a},e.pool=new t(e),e}(),s=function(){function e(){this.materialInfo=null,this.indexFrom=0,this.indexCount=0}return e.prototype.release=function(){this.geometryType=r.WGLGeometryType.UNKNOWN,this.materialInfo=null,this.indexFrom=0,this.indexCount=0},e.pool=new t(e),e}(),a=function(){function e(){this.fill=null,this.line=null,this.marker=null,this.text=null}return e.prototype.release=function(){this.fill&&(this.fill.forEach(function(e){return s.pool.release(e)}),this.fill.length=0),this.line&&(this.line.forEach(function(e){return s.pool.release(e)}),this.line.length=0),this.marker&&(this.marker.forEach(function(e){return s.pool.release(e)}),this.marker.length=0),this.text&&(this.text.forEach(function(e){return s.pool.release(e)}),this.text.length=0)},e.pool=new t(e),e}(),f=function(){function e(){}return e.prototype.acquire=function(){this.geometryDPInfo=a.pool.acquire()},e.prototype.release=function(){this.zLevel=null,a.pool.release(this.geometryDPInfo),this.geometryDPInfo=null},e.pool=new t(e),e}(),m=function(){function e(){this.zLevels=[]}return e.prototype.release=function(){this.symbolLevel=null,this.zLevels.forEach(function(e){return f.pool.release(e)}),this.zLevels.length=0},e.pool=new t(e),e}();return l});