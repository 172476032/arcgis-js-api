// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../../webgl/BufferObject","../../../../../webgl/VertexArrayObject","../../../../../webgl/Texture","../../../../../webgl/enums","../../../../../webgl/ShaderVariations","../../shaders/hlShaderSnippets"],function(e,i,t,o,r,s,n,h){var a=256,u=[void 0,void 0,void 0,1],l=[3,4],d=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],g=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],c=function(){function e(){this._width=void 0,this._height=void 0,this._highlightOptions={fillColor:[.2,.6,.9,.75],outlineColor:[.2,.6,.9,.9],outlinePosition:0,outlineWidth:3.4,innerHaloWidth:2,outerHaloWidth:3.3},this._resources=null}return e.prototype._initialize=function(e,i,s){this._width=i,this._height=s;var d=new t(e,34962,35044,new Int8Array([-128,-128,0,0,127,-128,255,0,-128,127,0,255,127,127,255,255]).buffer),g=new o(e,{a_position:0,a_texcoord:1},{geometry:[{name:"a_position",count:2,type:5120,offset:0,stride:4,normalized:!0},{name:"a_texcoord",count:2,type:5121,offset:2,stride:4,normalized:!0}]},{geometry:d}),c=new n("hl",["texturedVS","highlightFS"],[],h,e,{a_position:0,a_texcoord:1}),f=c.getProgram([]),_=new n("hl",["texturedVS","blurFS"],[],h,e,{a_position:0,a_texcoord:1}),m=_.getProgram([]);f.setUniform1i("u_texture",l[0]),f.setUniform1i("u_shade",l[1]),f.setUniform4fv("u_sigmas",u),m.setUniform1i("u_texture",l[0]),m.setUniform4fv("u_sigmas",u);var p=new r(e,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:a,height:1,samplingMode:9728});this._resources={quadGeometry:d,quadVAO:g,highlightProgram:f,blurProgram:m,shadeTex:p}},e.prototype.setHighlightOptions=function(e){function i(e,i,t){c[0]=(1-t)*e[0]+t*i[0],c[1]=(1-t)*e[1]+t*i[1],c[2]=(1-t)*e[2]+t*i[2],c[3]=(1-t)*e[3]+t*i[3]}if(this._highlightOptions=e,this._resources){var t=e.outlinePosition-e.outlineWidth/2-e.outerHaloWidth,o=e.outlinePosition-e.outlineWidth/2,r=e.outlinePosition+e.outlineWidth/2,s=e.outlinePosition+e.outlineWidth/2+e.innerHaloWidth,n=Math.sqrt(Math.PI/2)*u[3],h=Math.abs(t)>n?Math.round(10*(Math.abs(t)-n))/10:0,l=Math.abs(s)>n?Math.round(10*(Math.abs(s)-n))/10:0;h&&!l?console.warn("The outer rim of the highlight is "+h+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!h&&l?console.warn("The inner rim of the highlight is "+l+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):h&&l&&console.warn("The highlight is "+Math.max(h,l)+"px away from the edge of the feature; consider reducing some width values.");for(var d,g=new Uint8Array(4*a),c=[void 0,void 0,void 0,void 0],f=0;a>f;++f)d=t+f/(a-1)*(s-t),t>d?(g[4*f+0]=0,g[4*f+1]=0,g[4*f+2]=0,g[4*f+3]=0):o>d?i([0,0,0,0],e.outlineColor,(d-t)/(o-t)):r>d?(c[0]=e.outlineColor[0],c[1]=e.outlineColor[1],c[2]=e.outlineColor[2],c[3]=e.outlineColor[3]):s>d?i(e.outlineColor,e.fillColor,(d-r)/(s-r)):(g[4*f+0]=e.fillColor[0],g[4*f+1]=e.fillColor[1],g[4*f+2]=e.fillColor[2],g[4*f+3]=e.fillColor[3]),g[4*f+0]=255*c[0]*c[3],g[4*f+1]=255*c[1]*c[3],g[4*f+2]=255*c[2]*c[3],g[4*f+3]=255*c[3];this._resources.highlightProgram.setUniform2fv("u_minMaxDistance",[t,s]),this._resources.shadeTex.updateData(0,0,0,a,1,g)}},e.prototype.setup=function(e,i,t){this._resources?(this._width=i,this._height=t):(this._initialize(e,i,t),this.setHighlightOptions(this._highlightOptions))},e.prototype._teardown=function(){this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources.shadeTex.dispose(),this._resources=null},e.prototype.dispose=function(){this._resources&&this._teardown()},e.prototype.preBlur=function(e,i){e.bindTexture(i,l[0]),e.bindProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",d),e.bindVAO(this._resources.quadVAO),e.drawArrays(5,0,4),e.bindVAO()},e.prototype.finalBlur=function(e,i){e.bindTexture(i,l[0]),e.bindProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",g),e.bindVAO(this._resources.quadVAO),e.drawArrays(5,0,4),e.bindVAO()},e.prototype.renderHighlight=function(e,i){e.bindTexture(i,l[0]),e.bindTexture(this._resources.shadeTex,l[1]),e.bindProgram(this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.drawArrays(5,0,4),e.bindVAO()},e}();return c});