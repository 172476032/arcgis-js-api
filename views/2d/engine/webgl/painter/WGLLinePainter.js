// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../../../webgl/VertexArrayObject","../Utils"],function(e,t,i,o){var r=function(){function e(){this._lineAttributeLocations={a_pos:0,a_id:1,a_color:2,a_offsetAndNormal:3,a_accumulatedDistanceAndHalfWidth:4,a_tlbr:5,a_segmentDirection:6},this._lineAttributeLocationsVV={a_pos:0,a_id:1,a_color:2,a_offsetAndNormal:3,a_accumulatedDistanceAndHalfWidth:4,a_tlbr:5,a_segmentDirection:6,a_vv:7},this._lineVertexAttributeLayout={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:32,normalized:!1,divisor:0},{name:"a_id",count:4,type:5121,offset:4,stride:32,normalized:!0,divisor:0},{name:"a_color",count:4,type:5121,offset:8,stride:32,normalized:!0,divisor:0},{name:"a_offsetAndNormal",count:4,type:5120,offset:12,stride:32,normalized:!1,divisor:0},{name:"a_accumulatedDistanceAndHalfWidth",count:2,type:5123,offset:16,stride:32,normalized:!1,divisor:0},{name:"a_tlbr",count:4,type:5123,offset:20,stride:32,normalized:!1,divisor:0},{name:"a_segmentDirection",count:4,type:5120,offset:28,stride:32,normalized:!1,divisor:0}]},this._lineVertexAttributeLayoutVV={geometry:[{name:"a_pos",count:2,type:5122,offset:0,stride:44,normalized:!1,divisor:0},{name:"a_id",count:4,type:5121,offset:4,stride:44,normalized:!0,divisor:0},{name:"a_color",count:4,type:5121,offset:8,stride:44,normalized:!0,divisor:0},{name:"a_offsetAndNormal",count:4,type:5120,offset:12,stride:44,normalized:!1,divisor:0},{name:"a_accumulatedDistanceAndHalfWidth",count:2,type:5123,offset:16,stride:44,normalized:!1,divisor:0},{name:"a_tlbr",count:4,type:5123,offset:20,stride:44,normalized:!1,divisor:0},{name:"a_segmentDirection",count:4,type:5120,offset:28,stride:44,normalized:!1,divisor:0},{name:"a_vv",count:3,type:5126,offset:32,stride:44,normalized:!1,divisor:0}]},this._spritesTextureSize=new Float32Array(2)}return e.prototype.draw=function(e,t,i,r,a,n,s,l,v,f,u,d){var m=t.materialKeyInfo,_=m.vvSizeMinMaxValue||m.vvSizeScaleStops||m.vvSizeFieldStops||m.vvSizeUnitValue||m.vvColor||m.vvOpacity,c=_?this._lineAttributeLocationsVV:this._lineAttributeLocations,p=f.getProgram(t.materialKey,a,c);if(p){e.bindProgram(p);var y=this._getVAO(e,i,_);e.bindVAO(y);var z=1/s,S=0;if(t.texBindingInfo.length>0){var V=t.texBindingInfo[0],g=V.pageId,x=u.sprites;this._spritesTextureSize[0]=x.getWidth(g),this._spritesTextureSize[1]=x.getHeight(g),u.bindSpritePage(e,g,V.unit),p.setUniform1i(V.semantic,V.unit),p.setUniform2fv("u_mosaicSize",this._spritesTextureSize);var A=Math.pow(2,n-i.key.level)/s;p.setUniform1f("u_zoomFactor",A),p.setUniform1f("u_tileCoordRatio",o.C_TILE_SIZE/i.coordRange)}p.setUniformMatrix4fv("u_transformMatrix",i.tileTransform.transform),p.setUniformMatrix4fv("u_extrudeMatrix",d),p.setUniform2fv("u_normalized_origin",i.tileTransform.displayCoord),p.setUniform1f("u_opacity",1),p.setUniform1f("u_blur",S+z),p.setUniform1f("u_antialiasing",z),m.vvSizeMinMaxValue&&p.setUniform4fv("u_vvSizeMinMaxValue",r.vvSizeMinMaxValue),m.vvSizeScaleStops&&p.setUniform1f("u_vvSizeScaleStopsValue",r.vvSizeScaleStopsValue),m.vvSizeFieldStops&&(p.setUniform1fv("u_vvSizeFieldStopsValues",r.vvSizeFieldStopsValues),p.setUniform1fv("u_vvSizeFieldStopsSizes",r.vvSizeFieldStopsSizes)),m.vvSizeUnitValue&&p.setUniform1f("u_vvSizeUnitValueWorldToPixelsRatio",r.vvSizeUnitValueToPixelsRatio),m.vvColor&&(p.setUniform1fv("u_vvColorValues",r.vvColorValues),p.setUniform4fv("u_vvColors",r.vvColors)),m.vvOpacity&&(p.setUniform1fv("u_vvOpacityValues",r.vvOpacityValues),p.setUniform1fv("u_vvOpacities",r.vvOpacities)),e.setFaceCullingEnabled(!0),e.setFrontFace(2305),e.setCullFace(1029),e.drawElements(4,v,5125,4*l),e.setFaceCullingEnabled(!1),e.bindVAO(null)}},e.prototype._getVAO=function(e,t,r){if(t.lineGeometry.vao)return t.lineGeometry.vao;var a=t.lineGeometry.vertexBufferMap[o.C_VBO_GEOMETRY],n=t.lineGeometry.indexBuffer;return a&&n?(r?t.lineGeometry.vao=new i(e,this._lineAttributeLocationsVV,this._lineVertexAttributeLayoutVV,{geometry:a},n):t.lineGeometry.vao=new i(e,this._lineAttributeLocations,this._lineVertexAttributeLayout,{geometry:a},n),t.lineGeometry.vao):null},e}();return r});