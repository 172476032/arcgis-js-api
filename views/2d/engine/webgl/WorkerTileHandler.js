// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/executeAsync","../../../../core/promiseUtils","../../../../core/promiseUtils","../../../../core/Error","../../../../core/MapPool","../../../../core/SetPool","../../../../geometry/SpatialReference","../../../../geometry/support/spatialReferenceUtils","../../../../geometry/Extent","../../../../tasks/QueryTask","../../../../tasks/support/Query","../../../../renderers/support/jsonUtils","../../../../layers/support/TileInfo","../../../../layers/support/FeatureProcessing","../../tiling/TileInfoView","../../tiling/TileKey","../../layers/features/feat-store/FeatureTileStore","./displayObjectUtils","./rendererInfoUtils","./TileData","./Utils"],function(e,t,r,i,n,o,a,s,u,l,f,c,d,h,y,p,_,g,m,v,S,I,b){function T(e,t){b.isMarkerSymbol(e)||b.isLineSymbol(e)?t.add(e):b.isFillSymbol(e)&&(t.add(e),e.outline&&"none"!==e.outline.style&&t.add(e.outline))}function x(e,t,r){r.has(e)||r.set(e,new Set);for(var i=r.get(e),n=t.length,o=0;n>o;o++){var a=t.charCodeAt(o);i.add(a)}}var F=function(){function e(){this._symbolToMosaicItemMap=new Map}return e.prototype.configure=function(e){if(!e.renderer)return i.reject("renderer is not initialized!");this._symbolToMosaicItemMap.clear();var t=h.fromJSON(e.renderer),r=null!=e.spatialReference?u.fromJSON(e.spatialReference):null;return this._tileInfo=this._tileInfo=y.create({spatialReference:r,size:512}),this._tileInfoView=new _(this._tileInfo),this._rendererInfo=S.createRendererInfo(t,r),this._url=e.url,this._geometryType=e.geometryType,this._queryJSON=e.query,this._objectIdField=e.objectIdField,this._tilecoordRange=e.tileCoordRange,this._tileCoordRatio=e.tileCoordRatio,this._returnCentroid=e.returnCentroid,this._quantizationFactor=e.quantizationFactor,this._pixelRatio=e.pixelRatio,this._outFields=e.outFields,this._processing=p.fromWorker(e.processing),this._processingInMainThread=!1,this._queryInMainThread=e.queryInMainThread,this._featureStore=new m["default"](e.objectIdField,e.geometryType),i.resolve({data:{status:"success"}})},e.prototype.unregisterTile=function(e){return this._featureStore["delete"](e.key),i.resolve({data:{},buffers:[]})},e.prototype.registerTile=function(e,t){var r=this;return this._getFeatureSet(g.from(e.key),t).then(function(n){if(r._featureStore.set(e.key,n),!n||!n.features||0===n.features.length)return i.resolve({data:null,buffers:[]});var o=null!=r._rendererInfo.heatmapInfo;return o?i.resolve({data:null,buffers:[]}):r._getMosaicItems(n,r._symbolToMosaicItemMap,t).then(function(e){return r._createTileData(e)})})},e.prototype.getFeatures=function(e){for(var t=[],r=0,n=e.featureIds;r<n.length;r++){var o=n[r],a=this._featureStore.getFeature(o);t.push(a)}return i.resolve({data:{features:t},buffers:[]})},e.prototype._createTileData=function(e){var t={},i=e.features,n=e.geometryType,o=this,a=o._objectIdField,s=o._rendererInfo,u=o._tilecoordRange,l=o._tileCoordRatio,f=o._pixelRatio,c=o._symbolToMosaicItemMap,d=new Array(i.length),h=0;return r(function(){return d[h]=v.getDisplayObject(i[h],a,s,n,u,l,f,c,t),h++,h===i.length},250).then(function(){return I.create(d,t).serialize()})},e.prototype._getFeatureSet=function(e,t){var r=this,i=new c(this._url),n=this._getResolutionParams(e),o=this._tileInfoView.getTileBounds([0,0,0,0],e),a="esriGeometryPoint"===this._geometryType||this._returnCentroid,u=a?20:0,f=u*n.tolerance;o[0]-=f,o[1]-=f,o[2]+=f,o[3]+=f;var d=null,h=this._rendererInfo.renderer.visualVariables;h&&h.some(function(e){return"size"===e.type&&e.field&&!e.normalizationField?(d=[e.field+" DESC"],!0):void 0});var y={hashes:new Set,drill:[],featureSet:{features:[],geometryType:this._geometryType,transform:{originPosition:"upperLeft",scale:[n.tolerance,n.tolerance],translate:[n.extent.xmin,n.extent.ymax]}}},p=s.acquire();return this._drillQuery(y,p,i,t,o,n).then(function(e){if(d){var t=d[0].split(" "),r=t[0];"DESC"===t[1]&&e.featureSet.features.sort(function(e,t){return t.attributes[r]-e.attributes[r]})}return e.featureSet}).then(function(e){var t=r._tileInfo.size[0],i=e.features,o=r._tileInfo.spatialReference;if(!a||!o.isWrappable)return e;var f=l.getInfo(o),c=Math.round((f.valid[1]-f.valid[0])/n.tolerance);if(c===t){for(var d=[],h=0,y=i;h<y.length;h++){var _=y[h],g=_.geometry,m=_.attributes;if(g.x<u){var v={geometry:__assign({},g),attributes:m};v.geometry.x+=c,d.push(v)}else if(g.x>t-u){var v={geometry:__assign({},g),attributes:m};v.geometry.x-=c,d.push(v)}}i.push.apply(i,d)}else for(var S=0,I=i;S<I.length;S++){var g=I[S].geometry;g.x<-u?g.x+=c:g.x>t+u&&(g.x-=c)}return s.release(p),e})},e.prototype._drillQuery=function(e,t,r,i,o,a,s,u){var l=this;void 0===s&&(s=null),void 0===u&&(u=0);var f=e.featureSet,c=e.drill;return c.push(o),this._query(r,i,o,a,s).then(function(c){if(c.exceededTransferLimit){if(5>u&&c.exceededTransferLimit){u++;var d=(o[2]-o[0])/2,h=(o[3]-o[1])/2,y=[o[0],o[1]+h,o[2]-d,o[3]],p=[o[0]+d,o[1]+h,o[2],o[3]],_=[o[0],o[1],o[2]-d,o[3]-h],g=[o[0]+d,o[1],o[2],o[3]-h];return n.all([l._drillQuery(e,t,r,i,y,a,s,u),l._drillQuery(e,t,r,i,p,a,s,u),l._drillQuery(e,t,r,i,_,a,s,u),l._drillQuery(e,t,r,i,g,a,s,u)]).then(function(t){return e})}}else{var m=void 0,v=void 0,S=void 0,I=l._objectIdField,b=f.features,T=c.features,x=b.length,F=T.length;b.length=x+F;var M=0;for(m=0;F>m;++m)v=T[m],S=v.attributes[I],t.has(S)||(b[x+M]=v,t.add(S),M++);b.length-=F-M}return e})},e.prototype._query=function(e,t,r,n,a){var s=this,u=this._tileInfo.spatialReference,l=d.fromJSON(this._queryJSON);l.outFields=this._outFields,l.geometry=new f(r[0],r[1],r[2],r[3],u),l.outSpatialReference=u,l.quantizationParameters=n,l.maxAllowableOffset="esriGeometryPolyline"===this._geometryType?n.tolerance:null,l.resultType="tile",l.returnExceededLimitFeatures=!1,l.returnGeometry=!this._returnCentroid||this._rendererInfo.renderer.backgroundFillSymbol,l.returnJSON=!0,l.returnCentroid=this._returnCentroid,l.orderByFields=a;var c=this._queryInMainThread?t.invoke("queryFeatures",{query:l.toJSON()}).then(function(e){return JSON.parse(e.featureSet)}):e.rawExecute(l).then(function(e){return e.data});return c.then(function(e){var r=s._processing;if(!r)return e;if(s._processingInMainThread)return t.invoke("executeProcessing",{query:l.toJSON(),featureSet:JSON.stringify(e)}).then(function(e){return JSON.parse(e.featureSet)});try{var n=r.process(e,l,r.options);return n?n:i.reject(new o("FeatureLayer","invalid processing.process() method, returns nothing"))}catch(a){return s._processingInMainThread=!0,t.invoke("executeProcessing",{query:l.toJSON(),featureSet:JSON.stringify(e)}).then(function(e){return JSON.parse(e.featureSet)})}})},e.prototype._getResolutionParams=function(e){this._tileInfo.updateTileInfo(e);var t=this._tileInfo.lodAt(e.level),r=this._quantizationFactor*t.resolution;return{mode:"view",originPosition:"upperLeft",tolerance:r,extent:new f(e.extent[0],e.extent[1],e.extent[2],e.extent[3],this._tileInfo.spatialReference)}},e.prototype._getMosaicItems=function(e,t,r){var n=this,o=e.features,u=s.acquire(),l=a.acquire(),f=this._rendererInfo;f.renderer.backgroundFillSymbol&&T(f.renderer.backgroundFillSymbol,u);for(var c,d=0;d<o.length;d++){c=o[d];var h=f.getSymbol(c);h&&(b.isTextSymbol(h)?x(h,h.text,l):T(h,u))}if(0===u.size&&0===l.size)return s.release(u),a.release(l),i.resolve();var y=a.acquire(),p=[],_=0;return u.forEach(function(e){n._symbolToMosaicItemMap.has(e)||(y.set(_,e),p.push({symbol:e.toJSON(),id:_}),_++)}),p.length>0?r.invoke("getMaterialItems",{items:p}).then(function(r){return r.items.forEach(function(e){var r=y.get(e.id);t.set(r,e.mosaicItem)}),a.release(y),i.resolve(e)}):(s.release(u),a.release(l),i.resolve(e))},e}();return F});