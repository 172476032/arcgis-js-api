// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix/vec3","../../../../core/libs/gl-matrix/mat4","../../../../core/promiseUtils","../../../../geometry/Point","../Container","./GeometryUtils","./WGLRendererInfo","./TextureManager","./Utils"],function(t,e,i,o,r,n,a,s,l,h,p,c){var d=function(t){function e(e,i,n){var a=t.call(this)||this;return a._displayWidth=0,a._displayHeight=0,a._pointToCallbacks=new Map,a._highlightIDs=new Set,a._highlightOptionsUpToDate=!1,a.textureManager=new p,a._tileCoordRange=i,a._tileCoordRatio=i/e,a._parentLayerView=n,a._oneOverTileRatio=1/a._tileCoordRatio,a._tileCoordinateScale=o.create(),a._orientationVec=o.create(),a._displayScale=o.create(),a._orientationVec.set([0,0,1]),a._defaultTransform=r.create(),a}return i(e,t),Object.defineProperty(e.prototype,"highlightOptions",{get:function(){return this._highlightOptions},set:function(t){this._highlightOptions=t,this._highlightOptionsUpToDate=!1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"displayWidth",{get:function(){return this._displayWidth},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"displayHeight",{get:function(){return this._displayHeight},enumerable:!0,configurable:!0}),e.prototype.initialize=function(t){this._tileInfoView=t,this.wglRendererInfo=new h(this)},e.prototype.updateHeatmapParameters=function(t){this.wglRendererInfo.updateHeatmapParameters(t),this.requestRender()},e.prototype.hitTest=function(t,e){var i=this,o=[t,e];return n.create(function(t,e){i._pointToCallbacks.set(o,{resolve:t,reject:e}),i.requestRender()},function(){i._pointToCallbacks.has(o)&&i._pointToCallbacks["delete"](o)})},e.prototype.setHighlight=function(t){this._highlightIDs.clear(),this.addHighlight(t)},e.prototype.addHighlight=function(t){var e=this;t.forEach(function(t){e._highlightIDs.add(t)}),this._buildHLList()},e.prototype.removeHighlight=function(t){var e=this;t.forEach(function(t){e._highlightIDs["delete"](t)}),this._buildHLList()},e.prototype.addChild=function(e){var i=t.prototype.addChild.call(this,e);return this._buildHLList(),i},e.prototype.removeChild=function(e){var i=t.prototype.removeChild.call(this,e);return this._buildHLList(),i},e.prototype.prepareChildrenRenderParameters=function(t){return t},e.prototype.renderChildren=function(t){var e=this;this.wglRendererInfo.updateVisualVariables(this._parentLayerView.visualVariablesInfo.vvRanges,t.state);var i=this.parent.glPainter;this.sortChildren(function(t,e){return t.key.level-e.key.level});var o=this._tileInfoView.getClosestInfoForScale(t.state.scale).level;this.wglRendererInfo.heatmapParameters?i.drawHeatmap(t.context,this,o,t.devicePixelRatio):i.draw(t.context,this,o,t.devicePixelRatio,t.stationary),this._highlightIDs.size>0&&i.highlight(t.context,this,o,t.devicePixelRatio),0!==this._pointToCallbacks.size&&(this._pointToCallbacks.forEach(function(i,o){i.resolve(e._hitTest(t,o[0],o[1]))}),this._pointToCallbacks.clear())},e.prototype.attachChild=function(t,e){return t.attach(e)},e.prototype.detachChild=function(t,e){t.detach(e)},e.prototype.renderChild=function(t,e){t.doRender(e)},e.prototype.beforeRenderChildren=function(t,e){this._updateTilesTransform(t.state,this._tileInfoView.getClosestInfoForScale(t.state.scale).level),this._updateHighlightOptions()},e.prototype._hitTest=function(t,e,i){var o=this.parent.glPainter,r=this._tileInfoView.getClosestInfoForScale(t.state.scale).level,n=[0,0];t.state.toMap(n,[e,i]);var s=t.state.clone(),l=s.viewpoint.clone();return l.targetGeometry=new a(n[0],n[1],t.state.spatialReference),s.viewpoint=l,s.size=[c.C_HITTEST_SEARCH_SIZE,c.C_HITTEST_SEARCH_SIZE],this._updateTilesTransform(s,r),o.update(s,t.devicePixelRatio),o.hitTest({context:t.context,budget:t.budget,state:s,devicePixelRatio:t.devicePixelRatio,stationary:t.stationary},e,i,this,r)},e.prototype._updateTilesTransform=function(t,e){var i=1/t.width,o=1/t.height,r=[0,0];this._calculateRelativeViewProjMat(this._tileInfoView.tileInfo.lods[e].resolution,t.resolution,t.rotation,this._tileInfoView.tileInfo.size[0],this._tileCoordRange,t.width,t.height,this._defaultTransform);for(var n=0,a=this.children;n<a.length;n++){var s=a[n];t.toScreen(r,s.coords),r[1]=t.height-r[1],s.tileTransform.displayCoord[0]=2*r[0]*i-1,s.tileTransform.displayCoord[1]=2*r[1]*o-1,s.key.level===e?s.tileTransform.transform.set(this._defaultTransform):this._calculateRelativeViewProjMat(this._tileInfoView.tileInfo.lods[s.key.level].resolution,t.resolution,t.rotation,this._tileInfoView.tileInfo.size[0],s.coordRange,t.width,t.height,s.tileTransform.transform)}},e.prototype._calculateRelativeViewProjMat=function(t,e,i,o,n,a,s,h){var p=t/e,c=this._oneOverTileRatio*p;this._tileCoordinateScale.set([c,c,1]),(a!==this._displayWidth||s!==this._displayHeight)&&(this._displayScale.set([2/a,-2/s,1]),this._displayWidth=a,this._displayHeight=s),r.identity(h),r.scale(h,h,this._tileCoordinateScale),r.rotate(h,h,-i*l.C_DEG_TO_RAD,this._orientationVec),r.scale(h,h,this._displayScale),r.transpose(h,h)},e.prototype._updateHighlightOptions=function(){this._highlightOptionsUpToDate||this._setHighlightOptions(this._highlightOptions)&&(this._highlightOptionsUpToDate=!0)},e.prototype._setHighlightOptions=function(t){if(!this.parent)return!1;var e=this.parent.glPainter;if(!e)return!1;var i=t.color.toRgba();i[0]/=255,i[1]/=255,i[2]/=255;var o=i.slice(),r=2,n=.3,a=.3,s=0;return i[3]*=t.fillOpacity,o[3]*=t.haloOpacity,e.setHighlightOptions({fillColor:i,outlineColor:o,outlineWidth:r,outerHaloWidth:n,innerHaloWidth:a,outlinePosition:s}),!0},e.prototype._buildHLList=function(){var t=this;this.children.forEach(function(e){e.buildHLList(t._highlightIDs)}),this.requestRender()},e}(s);return d});