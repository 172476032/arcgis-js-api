// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/screenUtils","./color","./enums","./Geometry","./MaterialInfoUtils","./MeshData","./number","./SymbolProperties","./TextShaping","./visualVariablesUtils","./WGLDisplayRecord"],function(t,e,o,i,a,s,p,r,h,u,n,l,y){function c(t,e,c,d,m,w){g.length=0,v.length=0;var S=e.symbol,P=m.get(S);if(!P.glyphMosaicItems||0===P.glyphMosaicItems.length)return g;var z=P.glyphMosaicItems,T=S.text,V=24*w.offsetX,I=24*w.offsetY,U=w.hAnchor,b=w.vAnchor,N=new n([z],240,24,0,[V,I],U,b,.5),R=N.getShaping(T,!1);if(!R||0===R.length)return g;var G=e.vv,D=h.numTo32(c),A=R[0].glyphMosaicItem,L=p.createTextMaterialInfo(A,G),W=L.materialKeyInfo,X=0,C=0,E=0,F=0,O=W.vvColor||W.vvOpacity||W.vvRotation||W.vvSizeMinMaxValue||W.vvSizeScaleStops||W.vvSizeFieldStops||W.vvSizeUnitValue;if(O){var _=d.vvFields,j=_.rotation?d.getValue(t,_.rotation):0,q=_.opacity?d.getValue(t,_.opacity):0,K=_.color?d.getValue(t,_.color):0,Y=_.size&&!W.vvSizeScaleStops?d.getValue(t,_.size):0;W.vvSizeUnitValue&&(Y=l.getVisualVariableSizeValueRepresentationRatio(Y,d.vvRanges.size.unitValue.valueRepresentation)),isNaN(Y)&&(Y=1),isNaN(j)&&(j=1),isNaN(q)&&(q=1),isNaN(K)&&(K=1),X=h.toUint32(Y),C=h.toUint32(q),E=h.toUint32(j),F=h.toUint32(K)}var k,B,H,J,Q=[X,F,C,E],Z=t.centroid||t.geometry,$=Z.x,tt=Z.y,et=i.copyAndPremultiply(S.color),ot=i.copyAndPremultiply(S.haloColor),it=h.i8888to32(et[0],et[1],et[2],et[3]),at=h.i8888to32(ot[0],ot[1],ot[2],ot[3]),st=[o.pt2px(S.xoffset),o.pt2px(S.yoffset)];$+=st[0],tt+=st[1];var pt,rt=S.font.size,ht=f*(null!=S.haloSize?o.pt2px(o.toPt(S.haloSize)):0),ut={x:0,y:-17};if(ht>0){var nt=h.i1616to32(2*$+1,2*tt);for(pt=0;pt<R.length;pt++){var lt=R[pt],yt=[],ct=[],vt=lt.glyphMosaicItem;k=Math.round(vt.rect.x/4),B=Math.round(vt.rect.y/4),H=k+Math.round(vt.rect.width/4),J=B+Math.round(vt.rect.height/4);var gt=lt.x+ut.x+vt.metrics.left,xt=lt.y+ut.y-vt.metrics.top,ft=new s.Point(gt-4,xt-4),Mt=new s.Point(ft.x+vt.rect.width,ft.y+vt.rect.height),dt=new s.Point(ft.x,Mt.y),mt=new s.Point(Mt.x,ft.y);if(0!==w.angle){var wt=Math.cos(w.angle),St=Math.sin(w.angle);ft.rotate(wt,St),Mt.rotate(wt,St),dt.rotate(wt,St),mt.rotate(wt,St)}var Pt=p.createTextMaterialInfo(vt,G),zt=new r;yt.push(nt),yt.push(D),yt.push(at),yt.push(h.i1616to32(x*ft.x,x*ft.y)),yt.push(h.i8888to32(k,B,rt,ht)),O&&yt.push.apply(yt,Q),yt.push(nt),yt.push(D),yt.push(at),yt.push(h.i1616to32(x*mt.x,x*mt.y)),yt.push(h.i8888to32(H,B,rt,ht)),O&&yt.push.apply(yt,Q),yt.push(nt),yt.push(D),yt.push(at),yt.push(h.i1616to32(x*dt.x,x*dt.y)),yt.push(h.i8888to32(k,J,rt,ht)),O&&yt.push.apply(yt,Q),yt.push(nt),yt.push(D),yt.push(at),yt.push(h.i1616to32(x*Mt.x,x*Mt.y)),yt.push(h.i8888to32(H,J,rt,ht)),O&&yt.push.apply(yt,Q),ct.push(M),zt.update({geometry:yt,visibility:ct},4,[0,1,2,1,3,2]);var Tt=new y;Tt.setData(c,a.WGLGeometryType.TEXT,zt,Pt,0,0),g.push(Tt)}}var Vt=h.i1616to32(2*$,2*tt);for(pt=0;pt<R.length;pt++){var lt=R[pt],yt=[],ct=[],It=lt.glyphMosaicItem;k=Math.round(It.rect.x/4),B=Math.round(It.rect.y/4),H=k+Math.round(It.rect.width/4),J=B+Math.round(It.rect.height/4);var gt=lt.x+ut.x+It.metrics.left,xt=lt.y+ut.y-It.metrics.top,ft=new s.Point(gt-4,xt-4),Mt=new s.Point(ft.x+It.rect.width,ft.y+It.rect.height),dt=new s.Point(ft.x,Mt.y),mt=new s.Point(Mt.x,ft.y);if(0!==w.angle){var wt=Math.cos(w.angle),St=Math.sin(w.angle);ft.rotate(wt,St),Mt.rotate(wt,St),dt.rotate(wt,St),mt.rotate(wt,St)}var Ut=p.createTextMaterialInfo(It,G),zt=new r;yt.push(Vt),yt.push(D),yt.push(it),yt.push(h.i1616to32(x*ft.x,x*ft.y)),yt.push(h.i8888to32(k,B,rt,ht)),O&&yt.push.apply(yt,Q),yt.push(Vt),yt.push(D),yt.push(it),yt.push(h.i1616to32(x*mt.x,x*mt.y)),yt.push(h.i8888to32(H,B,rt,ht)),O&&yt.push.apply(yt,Q),yt.push(Vt),yt.push(D),yt.push(it),yt.push(h.i1616to32(x*dt.x,x*dt.y)),yt.push(h.i8888to32(k,J,rt,ht)),O&&yt.push.apply(yt,Q),yt.push(Vt),yt.push(D),yt.push(it),yt.push(h.i1616to32(x*Mt.x,x*Mt.y)),yt.push(h.i8888to32(H,J,rt,ht)),O&&yt.push.apply(yt,Q),ct.push(M),zt.update({geometry:yt,visibility:ct},4,[0,1,2,1,3,2]);var Tt=new y;Tt.setData(c,a.WGLGeometryType.TEXT,zt,Ut,0,0),g.push(Tt)}return u.TextProperties.pool.release(w),g}Object.defineProperty(e,"__esModule",{value:!0});var v=[],g=[],x=32,f=10,M=h.i8888to32(255,255,255,255);e.createTextDisplayRecords=c});