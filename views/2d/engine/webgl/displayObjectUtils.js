// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/screenUtils","./enums","./Utils","./MeshData","./visualVariablesUtils","./MeshUtils","./MaterialInfoUtils","./enums","./WGLDisplayObject","./WGLDisplayRecord"],function(e,t,r,i,a,s,o,l,u,p,h,n){function y(e,t,i,o,l,h){d.length=0,b.length=0;var y=t.symbol,v=h.get(y),c=y.text,f=c.length;if(0===f||!v||!v.glyphMosaicItems)return d;for(var m=0;f>m;m++){var g=c.charCodeAt(m);b.push(g)}var T=0;b.forEach(function(e){var t=v.glyphMosaicItems[e];T+=t.metrics.advance});var L,M,W,O,E=-Math.round(T/2),S=t.vv,I=a.numTo32(i),F=e.centroid||e.geometry,x=F.x,N=F.y,R=a.copyAndPremultiply(y.color),z=a.copyAndPremultiply(y.haloColor),k=a.i8888to32(R[0],R[1],R[2],R[3]),A=a.i8888to32(z[0],z[1],z[2],z[3]),P=[r.pt2px(y.xoffset)*o,r.pt2px(y.yoffset)*o];x+=P[0],N+=P[1];var q=y.font.size,C=V*(null!=y.haloSize?r.pt2px(r.toPt(y.haloSize)):0);if(C>0){var w=a.i1616to32(2*x+1,2*N);b.forEach(function(e){var t=[],r=[],o=v.glyphMosaicItems[e];L=Math.round(o.rect.x/4),M=Math.round(o.rect.y/4),W=L+Math.round(o.rect.width/4),O=M+Math.round(o.rect.height/4);var l=u.createTextMaterialInfo(o,S),h=s.pool.acquire(),y=E,c=o.metrics.height;t.push(w),t.push(I),t.push(A),t.push(a.i1616to32(G*y,G*c)),t.push(a.i8888to32(L,M,q,C)),r.push(1);var f=y+o.metrics.width,m=c;t.push(w),t.push(I),t.push(A),t.push(a.i1616to32(G*f,G*m)),t.push(a.i8888to32(W,M,q,C)),r.push(1);var g=y,b=0;t.push(w),t.push(I),t.push(A),t.push(a.i1616to32(G*g,G*b)),t.push(a.i8888to32(L,O,q,C)),r.push(1);var V=f,T=b;t.push(w),t.push(I),t.push(A),t.push(a.i1616to32(G*V,G*T)),t.push(a.i8888to32(W,O,q,C)),r.push(1),h.update({geometry:t,visibility:r},4,[0,1,2,1,3,2]);var F=n.pool.acquire(i,p.WGLGeometryType.TEXT,h,l,0,0);d.push(F),E+=o.metrics.advance})}E=-Math.round(T/2);var U=a.i1616to32(2*x,2*N);return b.forEach(function(e){var t=[],r=[],o=v.glyphMosaicItems[e];L=Math.round(o.rect.x/4),M=Math.round(o.rect.y/4),W=L+Math.round(o.rect.width/4),O=M+Math.round(o.rect.height/4);var l=u.createTextMaterialInfo(o,S),h=s.pool.acquire(),y=E,c=o.metrics.height;t.push(U),t.push(I),t.push(k),t.push(a.i1616to32(G*y,G*c)),t.push(a.i8888to32(L,M,q,C)),r.push(1);var f=y+o.metrics.width,m=c;t.push(U),t.push(I),t.push(k),t.push(a.i1616to32(G*f,G*m)),t.push(a.i8888to32(W,M,q,C)),r.push(1);var g=y,b=0;t.push(U),t.push(I),t.push(k),t.push(a.i1616to32(G*g,G*b)),t.push(a.i8888to32(L,O,q,C)),r.push(1);var V=f,T=b;t.push(U),t.push(I),t.push(k),t.push(a.i1616to32(G*V,G*T)),t.push(a.i8888to32(W,O,q,C)),r.push(1),h.update({geometry:t,visibility:r},4,[0,1,2,1,3,2]);var F=n.pool.acquire(i,p.WGLGeometryType.TEXT,h,l,0,0);d.push(F),E+=o.metrics.advance}),d}function v(e,t){if(!e)return i.WGLVVFlag.NONE;var r=0;return e.forEach(function(e){var a=e.type;"size"===a&&"outline"!==e.target?r|=o.getTypeOfSizeVisualVariable(e):"color"===a?r|=i.WGLVVFlag.COLOR:"opacity"===a?r|=i.WGLVVFlag.OPACITY:t&&"rotation"===a&&(r|=i.WGLVVFlag.ROTATION)}),r}function c(e){if(e.backgroundFillSymbol){var t=e.backgroundFillSymbol;if(g.push({symbol:t,vv:i.WGLVVFlag.NONE}),t.outline&&"none"!==t.outline.style){var r=i.WGLVVFlag.NONE;if(e.visualVariables)for(var a=0,s=e.visualVariables;a<s.length;a++){var l=s[a];if("size"===l.type&&"outline"===l.target){r|=o.getTypeOfSizeVisualVariable(l);break}}g.push({symbol:t.outline,vv:r})}}}function f(e,t,r){g.length=0;var s=r.renderer,l=r.getSymbol(e);if(!l)return g;var u=a.isMarkerSymbol(l)||a.isTextSymbol(l);if("esriGeometryPoint"===t||"esriGeometryPolyline"===t)return g.push({symbol:l,vv:v(s.visualVariables,u)}),g;if(u)c(s),g.push({symbol:l,vv:v(s.visualVariables,!0)});else if(a.isFillSymbol(l)){var p=i.WGLVVFlag.NONE;if(s.visualVariables)for(var h=0,n=s.visualVariables;h<n.length;h++){var y=n[h],f=y.type;"color"===f?p|=i.WGLVVFlag.COLOR:"opacity"===f&&(p|=i.WGLVVFlag.OPACITY)}if(g.push({symbol:l,vv:p}),l.outline&&"none"!==l.outline.style){var m=i.WGLVVFlag.NONE;if(s.visualVariables)for(var b=0,d=s.visualVariables;b<d.length;b++){var y=d[b];if("size"===y.type&&"outline"===y.target){m|=o.getTypeOfSizeVisualVariable(y);break}}g.push({symbol:l.outline,vv:m})}}else a.isLineSymbol(l)&&g.push({symbol:l,vv:v(s.visualVariables,u)});return g}function m(e,t,r,i,s,o,v,c,m){for(var g=e.attributes[t],b=h.pool.acquire(g),d=f(e,i,r),G=0,V=d;G<V.length;G++){var T=V[G],L=T.symbol,M=a.getSymbolGeometryType(L),W=0!==T.vv;switch(M){case p.WGLGeometryType.MARKER:m.icon||(m.icon=a.getStrides(p.WGLGeometryType.MARKER,W,!1));break;case p.WGLGeometryType.LINE:m.line||(m.line=a.getStrides(p.WGLGeometryType.LINE,W));break;case p.WGLGeometryType.FILL:m.fill||(m.fill=a.getStrides(p.WGLGeometryType.FILL,W));break;case p.WGLGeometryType.TEXT:m.text||(m.text=a.getStrides(p.WGLGeometryType.TEXT,W))}if(M===p.WGLGeometryType.TEXT)for(var O=y(e,T,g,o,r,c),E=0,S=O;E<S.length;E++){var I=S[E];b.displayRecords.push(I)}else{var F=c.get(L),x=u.createMaterialInfo(r,F,M,T.vv),N=l.createMesh(g,r,x.materialKeyInfo,F,M,s,o,v,e,L),R=n.pool.acquire(g,M,N,x,0,0);b.displayRecords.push(R)}}return b}Object.defineProperty(t,"__esModule",{value:!0});var g=[],b=[],d=[],G=32,V=10;t.getDisplayObject=m});