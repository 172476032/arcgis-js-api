// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/ObjectPool","../../../../core/libs/gl-matrix/vec2","../../../../core/libs/gl-matrix/mat4","../../tiling/TileKey","../DisplayObject","./WGLDisplayRecord","./WGLGeometry","./enums","./Utils","./WGLDisplayList"],function(e,t,i,s,r,l,o,a,y,h,p,n,c){var d=function(e){function t(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];var s=e.call(this)||this;return s.displayList=null,s.hlDisplayList=null,s.displayObjectRegistry=new Map,s.iconDisplayRecords=null,s.textDisplayRecords=null,s.lineDisplayRecords=null,s.fillDisplayRecords=null,s.iconGeometry=null,s.textGeometry=null,s.lineGeometry=null,s.fillGeometry=null,s.coords=[0,0],s.bounds=[0,0,0,0],s.tileTransform={transform:Float32Array[16],displayCoord:Float32Array[2]},s._hasVisualVariables=!1,t.length>0&&(o=s.acquire).call.apply(o,[s].concat(t)),s.tileTransform.transform=l.create(),s.tileTransform.displayCoord=r.create(),s;var o}return i(t,e),t.prototype.acquire=function(e,t,i,s,r){this.key=o.pool.acquire(e),this.coords[0]=t[0],this.coords[1]=t[3],this.bounds=t,this.coordRange=i,this.width=s,this.height=r},t.prototype.release=function(){this.clear(),o.pool.release(this.key),this.key=null},Object.defineProperty(t.prototype,"canDisplay",{get:function(){return!!this.attached&&!!this.displayList},enumerable:!0,configurable:!0}),t.prototype.setData=function(e,t,i){if(e&&e.tileDisplayData){this._hasVisualVariables=t,this.displayList&&e.tileDisplayData.displayList!==this.displayList&&c.pool.release(this.displayList),this.displayList=e.tileDisplayData.displayList,this.fillDisplayRecords=e.tileDisplayData.displayRecords[p.WGLGeometryType.FILL],this.lineDisplayRecords=e.tileDisplayData.displayRecords[p.WGLGeometryType.LINE],this.iconDisplayRecords=e.tileDisplayData.displayRecords[p.WGLGeometryType.MARKER],this.textDisplayRecords=e.tileDisplayData.displayRecords[p.WGLGeometryType.TEXT],this.displayObjectRegistry=e.tileDisplayData.displayObjectRegistry;var s=35044;this.fillDisplayRecords&&this.fillDisplayRecords.length>0&&(this.fillGeometry=new h,this.fillGeometry.initializeWithBuffers(this._hasVisualVariables?n.C_FILL_VERTEX_DEF_VV:n.C_FILL_VERTEX_DEF,e.tileBufferData.geometries[p.WGLGeometryType.FILL],s)),this.lineDisplayRecords&&this.lineDisplayRecords.length>0&&(this.lineGeometry=new h,this.lineGeometry.initializeWithBuffers(this._hasVisualVariables?n.C_LINE_VERTEX_DEF_VV:n.C_LINE_VERTEX_DEF,e.tileBufferData.geometries[p.WGLGeometryType.LINE],s)),this.iconDisplayRecords&&this.iconDisplayRecords.length>0&&(this.iconGeometry=new h,this.iconGeometry.initializeWithBuffers(this._hasVisualVariables?n.C_ICON_VERTEX_DEF_VV:n.C_ICON_VERTEX_DEF,e.tileBufferData.geometries[p.WGLGeometryType.MARKER],s)),this.textDisplayRecords&&this.textDisplayRecords.length>0&&(this.textGeometry=new h,this.textGeometry.initializeWithBuffers(this._hasVisualVariables?n.C_TEXT_VERTEX_DEF_VV:n.C_TEXT_VERTEX_DEF,e.tileBufferData.geometries[p.WGLGeometryType.TEXT],s))}},t.prototype.appendData=function(e){},t.prototype.updateObjects=function(e){for(var t=(e.remove||[]).slice(),i=e.update||[],s=[],r=[],l=[],o=[],a=[],y=0,d=i;y<d.length;y++){var m=d[y];this.displayObjectRegistry.get(m.id)&&t.push(m.id)}for(var u=0,D=t;u<D.length;u++){var R=D[u],m=this.displayObjectRegistry.get(R);if(m){for(var f=0,G=m.displayRecords;f<G.length;f++){var L=G[f];switch(s.push(L),L.geometryType){case p.WGLGeometryType.FILL:r.push(L);break;case p.WGLGeometryType.LINE:l.push(L);break;case p.WGLGeometryType.MARKER:o.push(L);break;case p.WGLGeometryType.TEXT:a.push(L)}}this.displayObjectRegistry["delete"](R)}}this.displayList||(this.displayList=c.pool.acquire());var T=this.displayList;T&&T.removeFromList(s),this._removeRecords(this.fillGeometry,this.fillDisplayRecords,r),this._removeRecords(this.lineGeometry,this.lineDisplayRecords,l),this._removeRecords(this.iconGeometry,this.iconDisplayRecords,o),this._removeRecords(this.textGeometry,this.textDisplayRecords,a);for(var _=[],E=0,g=i;E<g.length;E++){for(var m=g[E],v=0,x=m.displayRecords;v<x.length;v++){var L=x[v];switch(_.push(L),L.geometryType){case p.WGLGeometryType.FILL:this.fillDisplayRecords=this.fillDisplayRecords||[],this.fillDisplayRecords.push(L);break;case p.WGLGeometryType.LINE:this.lineDisplayRecords=this.lineDisplayRecords||[],this.lineDisplayRecords.push(L);break;case p.WGLGeometryType.MARKER:this.iconDisplayRecords=this.iconDisplayRecords||[],this.iconDisplayRecords.push(L);break;case p.WGLGeometryType.TEXT:this.textDisplayRecords=this.textDisplayRecords||[],this.textDisplayRecords.push(L)}}this.displayObjectRegistry.set(m.id,m)}var V=!1;if(this.fillGeometry||(this.fillGeometry=new h),this.lineGeometry||(this.lineGeometry=new h),this.iconGeometry||(this.iconGeometry=new h),V=V||this._updateRecords(this.iconGeometry,this.iconDisplayRecords,this._hasVisualVariables?n.C_ICON_VERTEX_DEF_VV:n.C_ICON_VERTEX_DEF),this.textGeometry||(this.textGeometry=new h),V){this.displayList&&c.pool.release(this.displayList);var b=c.pool.acquire();b.addToList(this.fillDisplayRecords),b.addToList(this.lineDisplayRecords),b.addToList(this.iconDisplayRecords),b.addToList(this.textDisplayRecords),this.displayList=b}else{var F=this.displayList;if(F)F.addToList(_);else{var W=c.pool.acquire();W.addToList(_),this.displayList=W}}},t.prototype._updateRecords=function(e,t,i){var s=35044;return e.update(t)===p.WGLGeometryTransactionStatus.FAILED_OUT_OF_MEMORY?(e.initializeWithRecords(i,t,s),this.attached=!1,!0):(e.invalidateIndexBuffer(),e.invalidateVertexBuffers(),!1)},t.prototype._removeRecords=function(e,t,i){if(e){this.iconGeometry.remove(i);for(var s=t.length,r=t.length,l=0;s>l;++l){var o=void 0;for(o=0;r>o&&t[l]!==i[o];++o);o<i.length&&(t.splice(l,1),l--)}}},t.prototype.clear=function(){this.iconGeometry&&(this.iconGeometry.clear(),this.iconGeometry=null),this.textGeometry&&(this.textGeometry.clear(),this.textGeometry=null),this.lineGeometry&&(this.lineGeometry.clear(),this.lineGeometry=null),this.fillGeometry&&(this.fillGeometry.clear(),this.fillGeometry=null),this.displayObjectRegistry.clear(),this.displayList&&(c.pool.release(this.displayList),this.displayList=null),this.hlDisplayList&&(c.pool.release(this.hlDisplayList),this.hlDisplayList=null),this.iconDisplayRecords&&(this.iconDisplayRecords.length=0),this.textDisplayRecords&&(this.textDisplayRecords.length=0),this.lineDisplayRecords&&(this.lineDisplayRecords.length=0),this.fillDisplayRecords&&(this.fillDisplayRecords.length=0)},t.prototype.dispose=function(){this.release()},t.prototype.attach=function(e){var t=!0;return this.fillGeometry&&(this.fillGeometry.attached||(t=t&&this.fillGeometry.attach(e))),this.lineGeometry&&(this.lineGeometry.attached||(t=t&&this.lineGeometry.attach(e))),this.iconGeometry&&(this.iconGeometry.attached||(t=t&&this.iconGeometry.attach(e))),this.textGeometry&&(this.textGeometry.attached||(t=t&&this.textGeometry.attach(e))),t},t.prototype.detach=function(e){},t.prototype.doRender=function(e){},t.prototype.buildHLList=function(e){var t=this;this.hlDisplayList&&c.pool.release(this.hlDisplayList),this.hlDisplayList=c.pool.acquire(),e.forEach(function(e){var i=t.displayObjectRegistry.get(e);if(i){var s=i.displayRecords.map(function(e){var t=y.pool.acquire();return t.id=e.id,t.geometryType=e.geometryType,t.vertexFrom=e.vertexFrom,t.vertexCount=e.vertexCount,t.indexFrom=e.indexFrom,t.indexCount=e.indexCount,t.materialInfo=e.materialInfo,t.meshData=null,t.sortKey=0,t.symbolLevel=0,t.zOrder=0,t}),r=function(e,t){return e.sortKey-t.sortKey};s.sort(r),t.hlDisplayList.addToList(s);for(var l=0,o=s;l<o.length;l++){var a=o[l];y.pool.release(a)}}})},t.pool=new s(t),t}(a);return d});