// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/libs/gl-matrix/mat4","../../../../core/libs/gl-matrix/vec2","../DisplayObject","./DisplayRecordStore","./enums","./WGLBuffers","./WGLDisplayList","./WGLDisplayObject","./WGLDisplayRecord","../../tiling/TileKey"],function(t,e,i,a,s,r,o,l,n,d,u,y,f){function p(t,e){return t.sortKey-e.sortKey}var h=new Set;return function(t){function e(e,i){var r=t.call(this)||this;return r.tileStatus=l.TileStatus.INITIALIZED,r._data=null,r.hlDisplayList=null,r._wglBuffers=null,r.coords=[0,0],r.bounds=[0,0,0,0],r.tileTransform={transform:Float32Array[16],displayCoord:Float32Array[2]},r._hasVisualVariables=!1,r.tileTransform.transform=a.create(),r.tileTransform.displayCoord=s.create(),r.key=f.pool.acquire(e),r.coords[0]=i[0],r.coords[1]=i[3],r.bounds=i,r}return i(e,t),Object.defineProperty(e.prototype,"iconGeometry",{get:function(){return this.getGeometry(l.WGLGeometryType.MARKER)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textGeometry",{get:function(){return this.getGeometry(l.WGLGeometryType.TEXT)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fillGeometry",{get:function(){return this.getGeometry(l.WGLGeometryType.FILL)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"lineGeometry",{get:function(){return this.getGeometry(l.WGLGeometryType.LINE)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"canDisplay",{get:function(){return!!this.attached&&!!this._data},enumerable:!0,configurable:!0}),e.prototype.getGeometry=function(t){return this._wglBuffers&&this._wglBuffers.has(t)?this._wglBuffers.get(t):null},e.prototype.getDisplayList=function(t){switch(t){case l.WGLDrawPhase.HIGHLIGHT:return this.hlDisplayList;default:return this._data&&this._data.tileDisplayData.displayList}},Object.defineProperty(e.prototype,"data",{get:function(){return this._data},enumerable:!0,configurable:!0}),e.prototype.setData=function(t,e,i){return i?(this.clear(),void(this.tileStatus=l.TileStatus.INVALID)):t&&t.tileDisplayData?(this._dispRecStore=o.default.fromTileData(t),this._hasVisualVariables=e,this._geometryTypes=[l.WGLGeometryType.FILL,l.WGLGeometryType.LINE,l.WGLGeometryType.MARKER,l.WGLGeometryType.TEXT],this._data=t,void(this.tileStatus===l.TileStatus.READY||this.tileStatus===l.TileStatus.NO_DATA||this.tileStatus===l.TileStatus.INVALID?this.tileStatus=l.TileStatus.MODIFIED:this.tileStatus=l.TileStatus.READY)):(this.clear(),void(this.tileStatus=l.TileStatus.NO_DATA))},e.prototype.patchData=function(t){this._data&&(this.tileStatus=l.TileStatus.MODIFIED,this._patchData(t)||(this._data.reshuffle(),this._dispRecStore=o.default.fromTileData(this._data)),this.requestRender())},e.prototype.commitChanges=function(t){this._data&&this.tileStatus===l.TileStatus.MODIFIED&&(this._wglBuffers&&(35048!==this._wglBuffers.usage&&(this._wglBuffers.dispose(),this._wglBuffers=new n.default(35048)),this._wglBuffers.ensureBuffers(t.context,this._geometryTypes,this._hasVisualVariables),this._wglBuffers.upload(this._data.tileBufferData,this._geometryTypes,["geometry","visibility"],!0)),this.tileStatus=l.TileStatus.READY)},e.prototype.setVisibility=function(t){if(this._data){h.clear();for(var e=0,i=t;e<i.length;e++){var a=i[e],s=this._data.tileDisplayData.displayObjectRegistry.get(a.id);if(s)for(var r=0,o=s.displayRecords;r<o.length;r++){var l=o[r];h.add(l.geometryType);var n=this._data.tileBufferData.geometries[l.geometryType];if(n.vertexBuffer.visibility)for(var d=n.vertexBuffer.visibility,u=0;u<l.vertexCount;++u){var y=l.vertexFrom+u;d.data[y*d.stride/4]=a.visibility?4294967295:0}}}if(this._wglBuffers){var f=[],p=function(t){f.push(t)};h.forEach(p),this._wglBuffers.upload(this._data.tileBufferData,f,["visibility"],!1),this.requestRender()}}},e.prototype.clear=function(){this._data=null,this._wglBuffers&&(this._wglBuffers.dispose(),this._wglBuffers=null),this.hlDisplayList&&(this.hlDisplayList=null)},e.prototype.dispose=function(){this.clear()},e.prototype.attach=function(t){return!(!this.attached&&this.tileStatus!==l.TileStatus.INVALID)||this.tileStatus!==l.TileStatus.INITIALIZED&&(this._wglBuffers||(this._wglBuffers=new n.default(35044)),this._data&&(this._wglBuffers.ensureBuffers(t.context,this._geometryTypes,this._hasVisualVariables),this._wglBuffers.upload(this._data.tileBufferData,this._geometryTypes,["geometry","visibility"],!0)),!0)},e.prototype.detach=function(e){t.prototype.detach.call(this,e)},e.prototype.doRender=function(t){var e=this;this.commitChanges(t),t.context.setStencilTestEnabled(!0),t.context.setStencilFunction(514,this.stencilRef,255),t.painter.getBrushes(t.drawPhase).forEach(function(i){return i.draw(t,e)})},e.prototype.buildHLList=function(t){var e=this;this.hlDisplayList=new d;var i=function(t){e._addToHLDisplayList(e.hlDisplayList,t)};t.forEach(i)},e.prototype._addToHLDisplayList=function(t,e){if(this._data){var i=this._data.tileDisplayData.displayObjectRegistry.get(e);if(i){for(var a=[],s=0,r=i.displayRecords;s<r.length;s++){var o=r[s],l=new y;l.id=o.id,l.geometryType=o.geometryType,l.vertexFrom=o.vertexFrom,l.vertexCount=o.vertexCount,l.indexFrom=o.indexFrom,l.indexCount=o.indexCount,l.materialInfo=o.materialInfo,l.meshData=null,l.symbolLevel=0,l.zOrder=0,a.push(l)}a.sort(p),t.addToList(a)}}},e.prototype._patchData=function(t){for(var e=!0,i=0,a=t.remove||[];i<a.length;i++){var s=a[i],r=this._data.tileDisplayData.displayObjectRegistry.get(s);if(r){this._data.tileDisplayData.displayList.removeFromList(r.displayRecords),h.clear();for(var o=0,l=r.displayRecords;o<l.length;o++){var n=l[o];h.add(n.geometryType),this._dispRecStore.delete(n)}this._data.tileDisplayData.displayObjectRegistry.delete(s)}}var d=[],f=function(t){d.push(t)};t.addOrUpdate.tileDisplayData.displayObjectRegistry.forEach(f);for(var p=0,c=d;p<c.length;p++){var g=c[p],r=this._data.tileDisplayData.displayObjectRegistry.get(g.id);if(r){for(var m=0;m<r.displayRecords.length;++m){var D=r.displayRecords[m],_=g.displayRecords[m];(m>=g.displayRecords.length||D.geometryType!==_.geometryType||D.symbolLevel!==_.symbolLevel||D.zOrder!==_.zOrder||D.materialInfo.materialKey!==_.materialInfo.materialKey)&&(this._dispRecStore.delete(r.displayRecords[m]),m<g.displayRecords.length&&(r.displayRecords[m]=void 0))}r.displayRecords.length=g.displayRecords.length}else r=new u(g.id),this._data.tileDisplayData.displayObjectRegistry.set(g.id,r);for(var m=0;m<g.displayRecords.length;++m){var _=g.displayRecords[m],D=r.displayRecords[m],v=_.geometryType,T=t.addOrUpdate.tileBufferData.geometries[v].vertexBuffer,b=t.addOrUpdate.tileBufferData.geometries[v].indexBuffer;if(_.readMeshDataFromBuffers(T,b),D)D.meshData=_.meshData,D.materialInfo=_.materialInfo;else{D=new y;for(var L in _)D[L]=_[L];D.vertexFrom=void 0,D.indexFrom=void 0,r.displayRecords[m]=D}e=e&&this._dispRecStore.commit(D)}}return e},e}(r)});