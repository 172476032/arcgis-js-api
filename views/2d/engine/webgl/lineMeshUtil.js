// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","./Utils","./visualVariablesUtils","./LineTess","./MeshData","./TileClipper"],function(e,i,t,r,o,a,n){function s(e,i,n,s,u,v,f,x){var h=null!=s?s.spriteMosaicItem:null,y=f.geometry,b=t.isPictureSymbol(x),E=!b&&x.color?t.copyAndPremultiply(x.color):[255,255,255,1],R=t.numTo32(e),N="round",P="round",I=window.devicePixelRatio||1,J=1/I,_=x.width>0?.5*(x.width+J):0,U=null!=h,D=n.vvColor||n.vvOpacity||n.vvSizeMinMaxValue||n.vvSizeScaleStops||n.vvSizeFieldStops||n.vvSizeUnitValue,F=0,L=0,O=0;if(D){var q=i.vvFields,k=q.opacity?i.getValue(f,q.opacity):0,j=q.color?i.getValue(f,q.color):0,G=q.size&&!n.vvSizeScaleStops?i.getValue(f,q.size):0;n.vvSizeUnitValue&&(G=r.getVisualVariableSizeValueRepresentationRatio(G,i.vvRanges.size.unitValue.valueRepresentation)),isNaN(G)&&(G=1),isNaN(k)&&(k=1),isNaN(j)&&(j=1),M[0]=G,O=z[0],M[0]=k,F=z[0],M[0]=j,L=z[0]}var W=t.i8888to32(E[0],E[1],E[2],E[3]),Y=[0,0],Z=[0,0];if(h){var B=1,H=h.rect.x,K=h.rect.y,Q=h.width,X=h.height;Y[0]=H+B,Y[1]=K+B,Z[0]=H+B+Q,Z[1]=K+B+X}for(var $=y.rings||y.paths,ee=8*v,ie=-ee,te=u+ee,re=[],oe=$.length,ae=0,ne=!1;oe>ae;){var se=$[ae],le=[];A.reset(2);var ue=se[0][0],ve=se[0][1];if(ne)A.moveTo(ue,ve);else{if(ie>ue||ue>te||ie>ve||ve>te){ne=!0;continue}le.push({x:ue,y:ve})}for(var ce=!1,pe=se.length,de=1;pe>de;++de)if(ue+=se[de][0],ve+=se[de][1],ne)A.lineTo(ue,ve);else{if(ie>ue||ue>te||ie>ve||ve>te){ce=!0;break}le.push({x:ue,y:ve})}if(ce)ne=!0;else{if(ne){var fe=A.resultWithStarts();if(fe)for(var xe=0,he=fe;xe<he.length;xe++){var ye=he[xe];re.push(ye)}}else re.push({line:le,start:0});ae++,ne=!1}}for(var be=0,me=[],ge=[],Se=0,Me=re;Se<Me.length;Se++){var ze=Me[Se],le=ze.line,Ce=ze.start;if(!(le.length<2)){var Te=le.length,Ve=le[0],Ee=le[Te-1],we=Ee.x-Ve.x,Re=Ee.y-Ve.y,Ae=w*w>we*we+Re*Re,Ne=Ce,Pe=void 0,Ie=void 0,Je=D?{size:O,color:L,opacity:F}:null;for(Ie=0;Te>Ie;++Ie){var _e=le[Ie],Ue=Pe===C[Ie%2]?C[(Ie+1)%2]:C[Ie%2];if(Te-1>Ie||!Ae||U?(l(Ue,Ie,le,Te,Ae,N,P),be+=c(_e.x,_e.y,Ne,W,Y,Z,R,_,be,Je,Ue,me),!Ue.capCenter||Ae&&Ie===Te-1||d(Ue,ge),Ae&&0===Ie&&!U&&o.copyExtrudeVectors(T,Ue)):o.copyExtrudeVectors(Ue,T),Pe&&p(Pe,Ue,ge),Te-1>Ie){var De=le[Ie+1],Fe=[De.x-_e.x,De.y-_e.y],Le=o.length(Fe),Oe=[Fe[0]/Le,Fe[1]/Le],qe=Ne+Le;if(g&&qe>m){var ke=(m-Ne)/(qe-Ne),je=_e.x+(De.x-_e.x)*ke,Ge=_e.y+(De.y-_e.y)*ke,We=Pe;S.buttCap(We,Oe,Oe),be+=c(je,Ge,m,W,Y,Z,e,_,be,Je,We,me),S.bridge(V,Ue,We),p(Ue,We,ge),S.buttCap(We,Oe,Oe),be+=c(je,Ge,0,W,Y,Z,e,_,be,Je,We,me),Ne=qe-Ne}else Ne=qe,Pe=Ue}}}}var Ye=new a;return Ye.update({geometry:me},be,ge),Ye}function l(e,i,t,r,a,n,s){var l=t[i],c=[void 0,void 0],p=[void 0,void 0];if(i>0&&r-1>i){var d=t[(i+r-1)%r],f=t[(i+1)%r];o.normalize(c,[l.x-d.x,l.y-d.y]),o.normalize(p,[f.x-l.x,f.y-l.y])}else if(0===i){var f=t[(i+1)%r];if(o.normalize(p,[f.x-l.x,f.y-l.y]),a){var x=t[r-2];o.normalize(c,[l.x-x.x,l.y-x.y])}else c=p}else{if(i!==r-1)return void console.error("Vertex index 'i' out of range.");var d=t[(i+r-1)%r];if(o.normalize(c,[l.x-d.x,l.y-d.y]),a){var h=t[1];o.normalize(p,[h.x-l.x,h.y-l.y])}else p=c}a||0!==i?a||i!==r-1?v(e,c,p,s):u(e,c,p,o.CapPosition.END,n):u(e,c,p,o.CapPosition.START,n)}function u(e,i,t,r,a){"butt"===a?S.buttCap(e,i,t):"round"===a?S.roundCap(e,i,t,r,o.getNumberOfSlices(Math.PI),r===o.CapPosition.START?-1:1):"square"===a?S.squareCap(e,i,t,r):(S.buttCap(e,i,t),console.error("Unknown cap type!"))}function v(e,i,t,r){var a=o.getRads(i,t);if(a>Math.PI-f)S.rectJoin(e,i,t);else if("miter"===r||x>a)f>a?S.fastMiterJoin(e,i,t):a<o.MITER_SAFE_RADS?S.miterJoin(e,i,t):S.bevelJoin(e,i,t,o.SYSTEM_MAG_LIMIT);else if("bevel"===r)S.bevelJoin(e,i,t,1);else if("round"===r){var n=o.getNumberOfSlices(a),s=y>a;s?2>n||h>a?S.bevelJoin(e,i,t,1):S.roundJoin(e,i,t,n):S.unitRoundJoin(e,i,t,n)}}function c(e,i,r,o,a,n,s,l,u,v,c,p){var d,f=0;for(d=0;d<c.vectors.count;++d){var x=c.vectors.items[d].vector[0],h=c.vectors.items[d].vector[1],y=c.vectors.items[d].texCoords[0],b=c.vectors.items[d].texCoords[1],m=c.vectors.items[d].direction[0],g=c.vectors.items[d].direction[1],S=u+f;++f,p.push(t.i1616to32(e,i)),p.push(s),p.push(o),p.push(t.i8888to32(Math.round(R*x),Math.round(R*h),Math.round(R*y),Math.round(R*b))),p.push(t.i1616to32(r,R*l)),p.push(t.i1616to32(a[0],a[1])),p.push(t.i1616to32(n[0],n[1])),p.push(t.i8888to32(Math.round(R*m),Math.round(R*g),0,0)),v&&(p.push(v.size),p.push(v.color),p.push(v.opacity)),c.vectors.items[d].base={index:S,point:[e,i]}}return f}function p(e,i,t){S.bridge(V,e,i);var r;for(r=0;r<V.count;++r){var o=V.items[r];t.push(o.v1.base.index,o.v2.base.index,o.v3.base.index)}}function d(e,i){S.pie(E,e);var t;for(t=0;t<E.count;++t){var r=E.items[t];i.push(r.v1.base.index,r.v2.base.index,r.v3.base.index)}}Object.defineProperty(i,"__esModule",{value:!0});var f=.05,x=.1,h=.5,y=2.3,b=20,m=65535,g=!0,S=new o.Tessellator({distanceAlongCorrection:!0}),M=new Float32Array(1),z=new Uint32Array(M.buffer),C=[o.allocExtrudeVectors(),o.allocExtrudeVectors()],T=o.allocExtrudeVectors(),V=o.allocTriangles(b),E=o.allocTriangles(b),w=.001,R=31,A=new n.TileClipper(0,0,0,1,8);A.setExtent(t.C_TILE_SIZE),i.createLineMeshData=s});