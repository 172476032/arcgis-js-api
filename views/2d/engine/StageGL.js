// COPYRIGHT Â© 2018 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../../../core/promiseUtils","./Container","./webgl/BitBlitRenderer","./webgl/WGLPainter","./webgl/shaders/glShaderSnippets","../libs/gl-matrix/common","../libs/gl-matrix/mat2d","../libs/gl-matrix/vec2","../../support/screenshotUtils","../../webgl/BufferObject","../../webgl/context-util","../../webgl/FramebufferObject","../../webgl/Program","../../webgl/RenderingContext","../../webgl/VertexArrayObject"],function(t,e,i,r,n,a,h,o,s,l,d,p,c,g,_,u,f,m){function w(t){return{state:t.state,pixelRatio:t.pixelRatio,stationary:t.stationary}}var x={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"};return function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._clipData=new Float32Array(8),e._upperLeft=d.create(),e._upperRight=d.create(),e._lowerLeft=d.create(),e._lowerRight=d.create(),e._mat2=l.create(),e._clipRendererInitialized=!1,e._contextVersion=null,e}return i(e,t),Object.defineProperty(e.prototype,"glPainter",{get:function(){return this._painter},enumerable:!0,configurable:!0}),e.prototype.createElement=function(){var t=document.createElement("canvas");return t.setAttribute("class","esri-display-object"),t},e.prototype.setElement=function(t){this.element=t},e.prototype.useContextVersion=function(t){this._renderingContext||(this._contextVersion=t)},e.prototype.attach=function(e){if(this.attached)return!0;this._resizeCanvas(e);var i={alpha:!0,antialias:!1,depth:!0,stencil:!0},r=g.createContextOrErrorHTML(this.element,i,this._contextVersion);return this._renderingContext=new f(r),this._contextVersion=this._renderingContext.contextVersion,this.attached=!0,this._cachedRenderParams=w(e),this._painter||(this._painter=new h.default,this._painter.initialize(this._renderingContext)),t.prototype.attach.call(this,e)},e.prototype.detach=function(e){t.prototype.detach.call(this,e),this._renderingContext&&(this._renderingContext.dispose(),this._renderingContext=null),this._cachedRenderParams=null},e.prototype.beforeRenderChildren=function(t,e){var i=t.state,r=this._painter;if(r){var n=this._renderingContext;n.enforceState(),r.update(i,t.pixelRatio);if(!(i.spatialReference&&(i.spatialReference._isWrappable?i.spatialReference._isWrappable():i.spatialReference.isWrappable)))return void(this._clipFrame=!1);var a=i.width,h=i.height,o=i.rotation;a=Math.round(a*t.pixelRatio),h=Math.round(h*t.pixelRatio);var p=s.toRadian(o),c=Math.abs(Math.cos(p)),g=Math.abs(Math.sin(p)),u=Math.round(a*c+h*g),f=Math.round(i.worldScreenWidth);if(u<=f)return void(this._clipFrame=!1);this._clipFBO&&this._clipFBO.width===a&&this._clipFBO.height===h||(this._clipFBO=new _(n,{colorTarget:0,depthStencilTarget:3,width:a,height:h}));var m=.5*a,w=.5*h,x=1/a,C=1/h,b=a*g+h*c,v=.5*f*t.pixelRatio,R=.5*b,y=this._upperLeft,F=this._upperRight,B=this._lowerLeft,M=this._lowerRight;d.set(y,-v,-R),d.set(F,v,-R),d.set(B,-v,R),d.set(M,v,R),l.identity(this._mat2),l.translate(this._mat2,this._mat2,[m,w]),0!==o&&l.rotate(this._mat2,this._mat2,p),d.transformMat2d(y,y,this._mat2),d.transformMat2d(F,F,this._mat2),d.transformMat2d(B,B,this._mat2),d.transformMat2d(M,M,this._mat2);var E=this._clipData;E.set([2*B[0]*x-1,2*(h-B[1])*C-1,2*M[0]*x-1,2*(h-M[1])*C-1,2*y[0]*x-1,2*(h-y[1])*C-1,2*F[0]*x-1,2*(h-F[1])*C-1]),this._clipRendererInitialized||this._initializeClipRenderer(n),this._clipVBO.setData(E),this._boundFBO=n.getBoundFramebufferObject(),n.bindFramebuffer(this._clipFBO),n.setDepthWriteEnabled(!0),n.setStencilWriteMask(255),n.setClearColor(0,0,0,0),n.setClearDepth(1),n.setClearStencil(0),n.clear(n.gl.COLOR_BUFFER_BIT|n.gl.DEPTH_BUFFER_BIT|n.gl.STENCIL_BUFFER_BIT),n.setDepthWriteEnabled(!1),this._clipFrame=!0}},e.prototype.afterRenderChildren=function(t,e){if(this._clipFrame&&this._clipRendererInitialized){var i=this._renderingContext;i.bindFramebuffer(this._boundFBO),this._boundFBO=null,i.bindVAO(this._clipVAO),i.bindProgram(this._clipStencilProgram),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setStencilTestEnabled(!0),i.setBlendingEnabled(!1),i.setColorMask(!1,!1,!1,!1),i.setStencilOp(7680,7680,7681),i.setStencilWriteMask(255),i.setStencilFunction(519,1,255),i.drawElements(4,6,5123,0),i.bindVAO(),i.setColorMask(!0,!0,!0,!0),i.setBlendingEnabled(!0),i.setStencilFunction(514,1,255),this._blitRenderer.render(i,this._clipFBO.colorTexture,9728,1),i.setStencilTestEnabled(!1)}},e.prototype.doRender=function(e){var i=this.element.style;if(!this.visible)return void(i.display="none");i.display="block",i.opacity=""+this.opacity,this._resizeCanvas(e),t.prototype.doRender.call(this,e),this._cachedRenderParams=w(e)},e.prototype.takeScreenshot=function(t){void 0===t&&(t={});var e=t.pixelRatio||1;this._cachedRenderParams.pixelRatio=e;var i=Math.round(e*this._cachedRenderParams.state.width),n=Math.round(e*this._cachedRenderParams.state.height),a={x:0,y:0,width:i,height:n},h={x:0,y:0,width:i,height:n},o=t.area;if(o&&(a.x=Math.round(e*o.x),a.y=Math.round(e*o.y),a.width=Math.round(e*o.width),a.height=Math.round(e*o.height)),void 0!==t.width&&void 0!==t.height){var s=t.width/t.height;if(a.height*s<a.width){var l=a.height*s;a.x+=Math.floor((a.width-l)/2),a.width=Math.floor(l)}else{var d=a.width/s;a.y+=Math.floor((a.height-d)/2),a.height=Math.floor(d)}h.width=t.width,h.height=t.height}else h.width=a.width,h.height=a.height;var c=document.createElement("canvas");c.width=h.width,c.height=h.height;var g=c.getContext("2d"),u=new Uint8Array(a.width*a.height*4),f=this._renderingContext,m=_.create(f,{colorTarget:1,depthStencilTarget:3,width:i,height:n});f.bindFramebuffer(m),f.setViewport(0,0,i,n);var w=this._cachedRenderParams,C=this._renderingContext.gl;if(this._renderingContext.setClearColor(0,0,0,0),this._renderingContext.setClearDepth(1),this._renderingContext.setClearStencil(0),this._renderingContext.clear(C.COLOR_BUFFER_BIT|C.DEPTH_BUFFER_BIT|C.STENCIL_BUFFER_BIT),w.context=this._renderingContext,this.beforeRenderChildren(w,w),void 0!==t.rotation&&null!==t.rotation){var b=w.state,v=b.clone();v.viewpoint.rotation=t.rotation,w.state=v,this.renderChildren(w),w.state=b}else this.renderChildren(w);this.afterRenderChildren(w,w),m.readPixels(a.x,n-(a.y+a.height),a.width,a.height,6408,5121,u),f.bindFramebuffer();var R=g.getImageData(h.x,h.y,h.width,h.height);if(0!==a.x||0!==a.y||a.width!==i||a.height!==n||0!==h.x||0!==h.y||h.width!==i||h.height!==n)p.resampleHermite(u,a.width,a.height,R.data,h.width,h.height,!0);else{for(var y=a.height-1,F=0,B=4*a.width,M=void 0,E=void 0,O=void 0,S=void 0,T=void 0,I=void 0,P=void 0;F<y;){for(I=F*B,P=y*B,M=0;M<B;M+=4)E=u[I+M],O=u[I+M+1],S=u[I+M+2],T=u[I+M+3],u[I+M]=u[P+M],u[I+M+1]=u[P+M+1],u[I+M+2]=u[P+M+2],u[I+M+3]=u[P+M+3],u[P+M]=E,u[P+M+1]=O,u[P+M+2]=S,u[P+M+3]=T;F++,y--}for(var D=R.data,V=u.length,L=0;L<V;L++)D[L]=u[L]}for(var U=R.data,W=U.length,L=0;L<W;L+=4){var T=U[L+3];if(T>0){var z=T/255,E=Math.floor(U[L+0]/z),O=Math.floor(U[L+1]/z),S=Math.floor(U[L+2]/z);U[L+0]=E<=255?E:255,U[L+1]=O<=255?O:255,U[L+2]=S<=255?S:255}}g.putImageData(R,h.x,h.y);var j=x[t.format?t.format.toLowerCase():"png"],A=1;void 0!==t.quality&&(A=t.quality/100);var k=c.toDataURL(j,A);return r.resolve({dataURL:k,x:h.x,y:h.y,width:h.width,height:h.height})},e.prototype.prepareChildrenRenderParameters=function(t){if(!this.attached||!this._renderingContext)return null;var e=w(t),i=this._renderingContext,r=i.gl;return i.setDepthWriteEnabled(!0),i.setStencilWriteMask(255),i.setClearColor(0,0,0,0),i.setClearDepth(1),i.setClearStencil(0),i.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT),i.setViewport(0,0,this.element.width,this.element.height),i.setDepthWriteEnabled(!1),e.context=i,e.painter=this._painter,e},e.prototype.attachChild=function(t,e){return t.attach(e)},e.prototype.detachChild=function(t,e){return t.detach(e)},e.prototype.renderChild=function(t,e){return t.processRender(e)},e.prototype._resizeCanvas=function(t){var e=this.element,i=e.style,r=t.state,n=t.pixelRatio,a=Math.round(r.width*n),h=Math.round(r.height*n);e.width===a&&e.height===h||(e.width=a,e.height=h),i.width=r.width+"px",i.height=r.height+"px"},e.prototype._initializeClipRenderer=function(t){if(this._clipRendererInitialized)return!0;this._blitRenderer=new a;var e={a_pos:0},i=new u(t,o.stencilVS,o.stencilFS,e);if(!i)return!1;var r=c.createVertex(t,35040,32),n=new Uint16Array([0,1,2,2,1,3]),h=c.createIndex(t,35044,n),s={geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},l=new m(t,e,s,{geometry:r},h);return this._clipStencilProgram=i,this._clipVBO=r,this._clipVAO=l,this._clipRendererInitialized=!0,!0},e}(n)});