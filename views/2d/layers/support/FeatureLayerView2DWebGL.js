// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/assignHelper","../../../../core/accessorSupport/decorators","../../../../core/HandleRegistry","../../../../core/promiseUtils","../../../../core/Logger","../../../../Graphic","../../../../layers/support/TileInfo","../../../../renderers/support/diffUtils","../../engine/StageGL","../../engine/webgl/rendererInfoUtils","../../engine/webgl/visualVariablesUtils","../../engine/webgl/TileHandler","../../engine/webgl/WGLTile","../../engine/webgl/WGLFeatureView","../../tiling/TileQueue","../../tiling/TileInfoView","../../tiling/TileStrategy","../LayerView2D"],function(e,t,i,r,n,s,a,o,l,u,h,f,c,d,p,g,_,y,w,v,V,m){function b(e){for(var t in e.diff){var i=e.diff[t];if("collection"===i.type){if(0!==i.changed.length||0!==i.added.length||0!==i.removed.length)return!0}else if("visualVariables"!==t&&"authoringInfo"!==t)return!0}return!1}var R=1,F=512,q=F/R,I=q/F,H=l.getLogger("esri.views.2d.layers.FeatureLayerView2D"),T=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._tileRequests=new Map,t._hasVV=!1,t._handles=new a,t._wglFeatureView=new y(F,q,t),t.container=new c,t}return i(t,e),t.prototype.initialize=function(){this._tileHandler=new g(this,this._wglFeatureView,F,q,I,R),this.addResolvingPromise(this._tileHandler.start())},t.prototype.destroy=function(){this._tileHandler.stop(),this._tileHandler=null},Object.defineProperty(t.prototype,"numFeatures",{get:function(){var e=0;return this.attached?this._tileStrategy.tiles.forEach(function(t){e+=t.iconDisplayRecords?t.iconDisplayRecords.length:0}):0,e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visualVariablesInfo",{get:function(){return this._visualVariablesInfo},enumerable:!0,configurable:!0}),t.prototype.highlight=function(e){var t=this._wglFeatureView;return t.addHighlight(e),{remove:function(){t.removeHighlight(e)}}},t.prototype.hitTest=function(e,t){var i=this;return this.suspended?o.resolve(null):this._wglFeatureView.hitTest(e,t).then(function(e){return 0===e.length?null:i._tileHandler.getFeatures(e).then(function(e){if(0===e.features.length)return null;var t=e.features[0],r=u.fromJSON(t);return r.layer=i.layer,r.geometry.spatialReference=i.view.spatialReference,r})})},t.prototype.update=function(e){this._configurationPromise||this._fetchQueue&&(this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume(),this.notifyChange("numFeatures"),this.notifyChange("updating"))},t.prototype.attach=function(){var e=this,t=this._tileInfo=h.create({spatialReference:this.view.spatialReference,size:512});this._tileInfoView=new v(t),this._wglFeatureView.highlightOptions=this.view.highlightOptions,this._wglFeatureView.initialize(this._tileInfoView),this._configure(this.layer.renderer),this._normalizedRenderer=d.getNormalizedRenderer(this.layer.renderer,this.view.spatialReference),this._visualVariablesInfo=p.convertVisualVariables(this._normalizedRenderer.visualVariables),this._handles.add(this.layer.watch("renderer",function(t){return e._rendererChangeHhandler(t)})),this._handles.add(this.layer.watch("definitionExpression, processing, outFields",function(t,i,r){"outFields"!==r?e.refresh():t.sort().join()!==i.sort().join()&&e.refresh()}))},t.prototype.detach=function(){this.container.removeChild(this._wglFeatureView),this._tileHandler.stop(),this._tileStrategy.destroy(),this._tileStrategy=null,this._handles.removeAll()},t.prototype.moveStart=function(){this.requestUpdate()},t.prototype.viewChange=function(){this.requestUpdate()},t.prototype.moveEnd=function(){this.requestUpdate()},t.prototype.isUpdating=function(){return this._fetchQueue&&0!==this._fetchQueue.length},t.prototype.refresh=function(){var e=this;this._configure(this.layer.renderer).then(function(){e._fetchQueue.resume(),e._wglFeatureView.requestRender(),e.requestUpdate()})},t.prototype.acquireTile=function(e){var t=this,i=this._tileInfoView.getTileBounds([0,0,0,0],e),r=_.pool.acquire(e,i,q,F,F),n=this._fetchQueue.push(r.key).then(function(e){e&&r.setData(e,t._hasVV,!1),t._wglFeatureView.addChild(r),r.once("attach",function(){t.notifyChange("updating"),t.requestUpdate()}),t.notifyChange("updating")}).otherwise(function(e){"cancel"!==e.dojoType&&H.error("query-error",e)});return this._tileRequests.set(r.key.id,n),this.notifyChange("updating"),r},t.prototype.releaseTile=function(e){var t=this,i=e.key.id,r=this._tileRequests.get(i);r&&(r.isFulfilled()||r.cancel(),this._tileRequests["delete"](i),this._wglFeatureView.removeChild(e),this.requestUpdate(),e.once("detach",function(){t._tileHandler.removeTile(e.key),_.pool.release(e)}),this.notifyChange("updating"))},t.prototype._configure=function(e){var t=this;return this._configurationPromise&&(this._configurationPromise.cancel(),this._configurationPromise=null),this._fetchQueue&&(this._fetchQueue.pause(),this._fetchQueue.clear(),this._tileStrategy.clear()),this._configurationPromise=this._tileHandler.configure(this.layer.renderer,this.layer.processing).then(function(){t._fetchQueue||(t._fetchQueue=new w({tileInfoView:t._tileInfoView,concurrency:50,process:function(e){return t._tileHandler.registerTile(e)}}),t._tileStrategy=new V({cachePolicy:"purge",acquireTile:function(e){return t.acquireTile(e)},releaseTile:function(e){return t.releaseTile(e)},tileInfoView:t._tileInfoView}),t.container.addChild(t._wglFeatureView)),t.requestUpdate()}).always(function(){t._configurationPromise=null}),this._configurationPromise},t.prototype._applyRendererDiff=function(e,t){if(b(e))return!1;if(e.diff.visualVariables){var i=t.vvFields,r=t.vvRanges,n=f.diff(this._visualVariablesInfo.vvFields,i);if(this._visualVariablesInfo.vvRanges=r,n)return!1;this._wglFeatureView.requestRender()}return!0},t.prototype._rendererChangeHhandler=function(e){var t=d.getNormalizedRenderer(e,this.view.spatialReference),i=this._normalizedRenderer,r=f.diff(i,t);if(r)if("complete"===r.type)this._normalizedRenderer=t,this._visualVariablesInfo=p.convertVisualVariables(t.visualVariables),this.refresh();else if("partial"===r.type){var n=p.convertVisualVariables(t.visualVariables);this._applyRendererDiff(r,n)||(this._normalizedRenderer=t,this._visualVariablesInfo=n,this.refresh())}},r([s.property()],t.prototype,"numFeatures",null),t=r([s.subclass("esri.views.2d.layers.FeatureLayerView2DWebGL")],t)}(s.declared(m));return T});