// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","../../../../core/tsSupport/extendsHelper","../../../../core/tsSupport/decorateHelper","../../../../core/tsSupport/assignHelper","dojo/promise/all","../../../../core/accessorSupport/decorators","../../../../core/Error","../../../../core/HandleRegistry","../../../../core/Logger","../../../../core/promiseUtils","../../../../Graphic","../../../../geometry/Extent","../../../../tasks/QueryTask","../../../../layers/support/TileInfo","../../../../renderers/support/diffUtils","../../engine/StageGL","../../engine/webgl/rendererInfoUtils","../../engine/webgl/WGLTileHandler","../../engine/webgl/WGLTile","../../engine/webgl/WGLFeatureView","../../tiling/TileQueue","../../tiling/TileInfoView","../../tiling/TileStrategy","../LayerView2D","./GraphicsManager2"],function(e,t,r,i,n,a,s,o,u,l,h,d,f,c,p,g,y,_,v,w,m,I,b,V,F,R){function T(e){for(var t in e.diff){var r=e.diff[t];if("collection"===r.type){if(0!==r.changed.length||0!==r.added.length||0!==r.removed.length)return!0}else if("visualVariables"!==t&&"authoringInfo"!==t)return!0}return!1}var S=l.getLogger("esri.views.2d.layers.FeatureLayerView2DWebGL"),q=1,C=512,Q=C/q,x=Q/C,L=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._wglFeatureView=new m(C,Q,t),t._tileRequests=new Map,t._hasVV=!1,t._handles=new u,t.container=new y,t._toAdd=[],t._toRemove=[],t}return r(t,e),Object.defineProperty(t.prototype,"numFeatures",{get:function(){var e=0;return this.attached?this._tileStrategy.tiles.forEach(function(t){e+=t.iconDisplayRecords?t.iconDisplayRecords.length:0}):0,e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"rendererInfo",{get:function(){return this._rendererInfo},enumerable:!0,configurable:!0}),t.prototype.highlight=function(e){var t=this._wglFeatureView;return t.addHighlight(e),{remove:function(){t.removeHighlight(e)}}},t.prototype.hitTest=function(e,t){var r=this;return this.suspended?h.resolve(null):this._wglFeatureView.hitTest(e,t).then(function(e){if(0===e.length)return null;var t=e[0],i=r._graphicsManager.findGraphic(t);return new d(n({layer:r.layer},i))})},t.prototype.update=function(e){if(this._fetchQueue){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume(),this.notifyChange("numFeatures");for(var t=0,r=this._toRemove;t<r.length;t++){var i=r[t];this._graphicsManager.removeMany(i.featureIds)}this._toRemove.length=0;for(var n=0,a=this._toAdd;n<a.length;n++){var s=a[n];this._graphicsManager.add(s.features,s.intent),this._graphicsManager.removeIntent(s.intent)}this._toAdd.length=0,this.notifyChange("updating")}},t.prototype.attach=function(){this._initialize()},t.prototype.detach=function(){this.container.removeChild(this._wglFeatureView),this._tileStrategy.destroy(),this._tileStrategy=null,this._graphicsManager.destroy(),this._graphicsManager=null,this._handles.removeAll()},t.prototype.moveStart=function(){this.requestUpdate()},t.prototype.viewChange=function(){this.requestUpdate()},t.prototype.moveEnd=function(){this.requestUpdate()},t.prototype.isUpdating=function(){return 0!==this._fetchQueue.length},t.prototype.acquireTile=function(e){var t=this,r=this._tileInfoView.getTileBounds([0,0,0,0],e),i=w.pool.acquire(e,r,Q,C,C),n=this._fetchQueue.push(i.key).then(function(r){var i=r.features.map(function(e){return{attributes:e.attributes}||{attributes:{}}}),n=t._graphicsManager.createIntentToAdd();return t._toAdd.push({features:i,intent:n}),v.getTileData(e,r,t.layer.objectIdField,t._rendererInfo,Q,x,t.container.glPainter.textureManager).then(function(e){return{tileData:e,intent:n}})}).then(function(e){var r=e.tileData,n=e.intent;r&&(i.setData(r,t._hasVV,!1),i.intent=n),t._wglFeatureView.addChild(i),i.once("attach",function(){t.notifyChange("updating"),t.requestUpdate()}),t.notifyChange("updating")}).otherwise(function(e){if(e&&"cancel"===e.dojoType)return h.reject(e);var t=new o("featurelayerview2dwebgl:tile-request-failed","Failed to query for features",{error:e});return S.error(t),h.reject(t)});return this._tileRequests.set(i.key.id,n),this.notifyChange("updating"),i},t.prototype.releaseTile=function(e){var t=[];e.displayObjectRegistry.forEach(function(e,r){t.push(r)}),this._toRemove.push({featureIds:t});var r=e.key.id,i=this._tileRequests.get(r);i&&(i.isFulfilled()||i.cancel(),this._tileRequests["delete"](r),this._wglFeatureView.removeChild(e),this.requestUpdate(),e.once("detach",function(){return w.pool.release(e)}),this.notifyChange("updating"))},t.prototype._initialize=function(){var e=this,t=this._tileInfo=p.create({spatialReference:this.view.spatialReference,size:512});this._tileInfoView=new b(t),this._fetchQueue=new I({tileInfoView:this._tileInfoView,process:function(t){return e._getFeatureSet(t)}}),this._wglFeatureView.highlightOptions=this.view.highlightOptions,this._wglFeatureView.initialize(this._tileInfoView),this.container.addChild(this._wglFeatureView),this._tileStrategy=new V({cachePolicy:"purge",acquireTile:function(t){return e.acquireTile(t)},releaseTile:function(t){return e.releaseTile(t)},tileInfoView:this._tileInfoView}),this._rendererInfo=this._createRendererInfo(this.layer.renderer),this._returnCentroid=this._getReturnCentroid(this.layer.renderer),this._handles.add(this.layer.watch("renderer",function(t){return e._rendererChange(t)})),this._graphics=new Set;var r={add:function(t){e._graphics.add(t)},remove:function(t){e._graphics["delete"](t)},removeAll:function(){e._graphics.clear()}};this._graphicsManager=new R({graphics:r,objectIdField:this.layer.objectIdField}),this.requestUpdate()},t.prototype._getFeatureSet=function(e){var t={hashes:new Set,drill:[],featureSet:{features:[],geometryType:""}},r=new c(this.layer.parsedUrl.path),i=this._getResolutionParams(e),n=this._tileInfoView.getTileBounds([0,0,0,0],e),a=("point"===this.layer.geometryType||this._returnCentroid?20:0)*i.tolerance;n[0]-=a,n[1]-=a,n[2]+=a,n[3]+=a;var s=null;return this.layer.renderer.visualVariables&&this.layer.renderer.visualVariables.some(function(e){return"size"===e.type&&e.field&&!e.normalizationField?(s=[e.field+" DESC"],!0):void 0}),this._drillQuery(t,r,n,i).then(function(e){if(s){var t=s[0].split(" "),r=t[0];"DESC"===t[1]&&e.featureSet.features.sort(function(e,t){return t.attributes[r]-e.attributes[r]})}return e.featureSet})},t.prototype._drillQuery=function(e,t,r,i,n,s){var o=this;void 0===n&&(n=null),void 0===s&&(s=0);var u=e.featureSet,l=e.drill;return l.push(r),this._query(t,r,i,n).then(function(l){if(l.exceededTransferLimit){if(5>s&&l.exceededTransferLimit){s++;var h=(r[2]-r[0])/2,d=(r[3]-r[1])/2,f=[r[0],r[1]+d,r[2]-h,r[3]],c=[r[0]+h,r[1]+d,r[2],r[3]],p=[r[0],r[1],r[2]-h,r[3]-d],g=[r[0]+h,r[1],r[2],r[3]-d];return a([o._drillQuery(e,t,f,i,n,s),o._drillQuery(e,t,c,i,n,s),o._drillQuery(e,t,p,i,n,s),o._drillQuery(e,t,g,i,n,s)]).then(function(t){return e})}}else u.features=u.features.concat(l.features),u.geometryType=l.geometryType;return e})},t.prototype._query=function(e,t,r,i){var n=this.view.spatialReference,a=this.layer.createQuery();return a.outFields=this.layer.outFields,a.geometry=new f(t[0],t[1],t[2],t[3],n),a.outSpatialReference=n,a.quantizationParameters=r,a.maxAllowableOffset="polyline"===this.layer.geometryType?r.tolerance:null,a.resultType="tile",a.returnExceededLimitFeatures=!1,a.returnGeometry=!this._returnCentroid||this.layer.renderer.backgroundFillSymbol,a.returnJSON=!0,a.returnCentroid=this._returnCentroid,a.orderByFields=i,e.execute(a)},t.prototype._getResolutionParams=function(e){this._tileInfo.updateTileInfo(e);var t=this._tileInfo.lodAt(e.level),r=q*t.resolution;return{mode:"view",originPosition:"upperLeft",tolerance:r,extent:new f(e.extent[0],e.extent[1],e.extent[2],e.extent[3],this.view.spatialReference)}},t.prototype._recreateTiles=function(e){this._fetchQueue.pause(),this._rendererInfo=e,this._tileStrategy.clear(),this._fetchQueue.resume(),this._wglFeatureView.requestRender()},t.prototype._createRendererInfo=function(e){var t=_.createRendererInfo(e,this.view.spatialReference),r=t.vvFields;return this._hasVV=null!=r&&(null!=r.size||null!=r.rotation||null!=r.color||null!=r.opacity),"heatmap"===t.renderer.type&&this._wglFeatureView.updateHeatmapParameters(t.renderer),t},t.prototype._applyRendererDiff=function(e,t,r,i){if(T(e))return!1;if(e.diff.visualVariables){var n=i.vvFields,a=g.diff(this._rendererInfo.vvFields,n);if(this._rendererInfo.vvRanges=i.vvRanges,a)return!1;this._wglFeatureView.requestRender()}return!0},t.prototype._rendererChange=function(e){this._returnCentroid=this._getReturnCentroid(e);var t=_.createRendererInfo(e,this.view.spatialReference),r=t.renderer,i=this._rendererInfo.renderer,n=g.diff(i,r);n&&("complete"===n.type?this._recreateTiles(t):"partial"===n.type&&(this._applyRendererDiff(n,r,i,t)||this._recreateTiles(t)))},t.prototype._getReturnCentroid=function(e){function t(e){if(!e)return!1;var t=e.type;return"simple-marker"===t||"picture-marker"===t||"text"===t}if("polygon"!==this.layer.geometryType)return!1;switch(e.type){case"simple":return t(e.symbol);case"unique-value":return t(e.defaultSymbol)||e.uniqueValueInfos.some(function(e){return t(e.symbol)});case"class-breaks":return t(e.defaultSymbol)||e.classBreakInfos.some(function(e){return t(e.symbol)});default:return!0}},i([s.property()],t.prototype,"numFeatures",null),t=i([s.subclass("esri.views.2d.layers.FeatureLayerView2DWebGL")],t)}(s.declared(F));return L});