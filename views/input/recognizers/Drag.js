// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/extendsHelper","../InputHandler","./support"],function(t,e,i,r,n){Object.defineProperty(e,"__esModule",{value:!0});var a=function(t){function e(){var e=t.call(this,!1)||this;return e._startStateModifiers=new Set,e._activePointers=[],e._activePointerMap=new Map,e._isDragging=!1,e._drag=e.registerOutgoing("drag"),e.registerIncoming("pointer-drag",e._handlePointerDrag.bind(e)),e.registerIncoming("pointer-down",e._handlePointerDown.bind(e)),e.registerIncoming("pointer-up",e._handlePointerUpAndPointerLost.bind(e)),e.registerIncoming("pointer-capture-lost",e._handlePointerUpAndPointerLost.bind(e)),e}return i(e,t),e.prototype._createPayload=function(t,e){return{action:t,pointers:this._activePointers.map(function(t){return t.data}),startState:this._startState,previousState:this._previousState,currentState:e}},e.prototype._fitCircleLSQ=function(){var t=this._activePointers.map(function(t){return t.data.currentEvent});return n.fitCircleLSQ(t)},e.prototype._createDragState=function(t){for(var e=this._fitCircleLSQ(),i=0,r=0,n=this._activePointers;r<n.length;r++){for(var a=n[r],s=this._pointerAngle(a,e),o=s-a.lastAngle;o>Math.PI;)o-=2*Math.PI;for(;o<-Math.PI;)o+=2*Math.PI;s=a.lastAngle+o,a.lastAngle=s;var p=s-a.initialAngle;i+=p}return i/=this._activePointers.length,{angle:i,radius:e.radius,center:e.center,timestamp:t}},e.prototype._updateMultiPointer=function(t,e){var i=t.startEvent["native"].pointerId,r=this._activePointerMap.get(i),n=!r;if(n){r={data:null,initialAngle:0,lastAngle:0},this._activePointers.push(r),this._activePointerMap.set(i,r),r.data={startEvent:t.startEvent,previousEvent:t.previousEvent,currentEvent:t.currentEvent};var a=this._fitCircleLSQ();r.initialAngle=this._pointerAngle(r,a),r.lastAngle=r.initialAngle}else r.data={startEvent:r.data.startEvent,previousEvent:t.previousEvent,currentEvent:t.currentEvent};return n&&this._isDragging&&this._updateInitialAngles(e),r},e.prototype._pointerAngle=function(t,e){var i=t.data.currentEvent,r=i.x-e.center.x,n=i.y-e.center.y;return Math.atan2(n,r)},e.prototype._updateInitialAngles=function(t){for(var e=this._createDragState(t),i=0,r=this._activePointers;i<r.length;i++){var n=r[i];n.initialAngle=this._pointerAngle(n,e)}},e.prototype._emitStart=function(t){this._updateInitialAngles(t.timestamp);var e=this._createDragState(t.timestamp);this._startState=e,this._previousState=this._startState,this._startStateModifiers=t.modifiers,this._isDragging=!0;for(var i=0,r=this._activePointers;i<r.length;i++){var n=r[i];n.data={previousEvent:n.data.currentEvent,startEvent:n.data.currentEvent,currentEvent:n.data.currentEvent}}this._drag.emit(this._createPayload("start",e),t.timestamp)},e.prototype._emitUpdate=function(t){var e=this._createDragState(t.timestamp);this._drag.emit(this._createPayload("update",e),void 0,this._startStateModifiers),this._previousState=e},e.prototype._emitEnd=function(t){var e=this._createDragState(t);this._drag.emit(this._createPayload("end",e),void 0,this._startStateModifiers),this._previousState=null,this._startState=null,this._isDragging=!1},e.prototype._handlePointerDown=function(t){var e=t.data;this._isDragging&&this._emitEnd(t.timestamp),this._updateMultiPointer({startEvent:e,previousEvent:e,currentEvent:e},t.timestamp)},e.prototype._removeMultiPointer=function(t,e){var i=this,r=t["native"].pointerId,n=this._activePointerMap.get(r);if(n){var a=function(){i._activePointerMap["delete"](r);var t=i._activePointers.indexOf(n);i._activePointers.splice(t,1),i._isDragging&&i._updateInitialAngles(e)};this._isDragging?(this._updateMultiPointer({startEvent:n.data.startEvent,previousEvent:n.data.currentEvent,currentEvent:t},e),this._emitEnd(e),a()):a()}},e.prototype._handlePointerUpAndPointerLost=function(t){this._removeMultiPointer(t.data,t.timestamp)},e.prototype._handlePointerDrag=function(t){var e=t.data;switch(e.action){case"start":this._isDragging||this._emitStart(t);break;case"update":this._isDragging||this._emitStart(t),this._updateMultiPointer(e,t.timestamp),this._emitUpdate(t);break;case"end":}},e}(r.InputHandler);e.Drag=a});