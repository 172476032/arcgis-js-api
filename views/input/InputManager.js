// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","../../core/tsSupport/declareExtendsHelper","../../core/tsSupport/decorateHelper","../../core/accessorSupport/decorators","../../core/Accessor","./keys","./recognizers","../../core/Logger","./handlers/LatestPointerType"],function(e,t,r,n,i,o,s,a,d,l){var p=d.getLogger("esri.views.input"),h=function(e){function t(t,r){var n=e.call(this)||this;return n._pointerCaptures=new Map,n._nameToGroup={},n._handlers=[],n._currentPropagation=null,n._sourceEvents=new Set,n._keyModifiers=new Set,n._activeKeyModifiers=new Set,n.primaryKey=s.primaryKey,n.latestPointerType="mouse",n._installRecognizers(),n}return r(t,e),t.prototype.normalizeCtorArgs=function(e,t){return this._browserEvents=e,this._browserEvents.onEventReceived=this._onEventReceived.bind(this),this._recognizers=t,this._recognizers||(this._recognizers=a.defaults.map(function(e){return new e})),{}},t.prototype.destroy=function(){for(var e=Object.keys(this._nameToGroup),t=0,r=e;t<r.length;t++){var n=r[t];this.uninstallHandlers(n)}},t.prototype.installHandlers=function(e,t){var r=this;if(this._nameToGroup[e])return void p.error("There is already an InputHandler group registered under the name `"+e+"`");if(0===t.length)return void p.error("Can't register a group of zero handlers");var n={name:e,handlers:t.map(function(e,t){return{handler:e,active:!0,removed:!1,priorityIndex:0,eventCallback:null,uninstallCallback:null}})};this._nameToGroup[e]=n;for(var i=function(e){var t=n.handlers[e];o._handlers.push(t),t.handler.onInstall({updateDependencies:function(){r.updateDependencies()},emit:function(e,n,i){r._emitInputEvent(t.priorityIndex,e,n,i)},setPointerCapture:function(e,i){r._setPointerCapture(n,t,e,i)},setEventCallback:function(e){t.eventCallback=e},setUninstallCallback:function(e){t.uninstallCallback=e}})},o=this,s=n.handlers.length-1;s>=0;s--)i(s);this.updateDependencies()},t.prototype.uninstallHandlers=function(e){var t=this._nameToGroup[e];return t?(t.handlers.forEach(function(e){e.removed=!0,e.uninstallCallback()}),delete this._nameToGroup[e],void(this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers())):void p.error("There is no InputHandler group registered under the name `"+e+"`")},t.prototype.hasHandlers=function(e){return void 0!==this._nameToGroup[e]},t.prototype.updateDependencies=function(){var e=new Set,t=new Set;this._handlersPriority=[];for(var r=this._handlers.length-1;r>=0;r--){var n=this._handlers[r];n.priorityIndex=r,this._handlersPriority.push(n)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(var r=this._handlersPriority.length-1;r>=0;r--){var i=this._handlersPriority[r];i.priorityIndex=r;var o=i.handler.hasSideEffects;if(!o)for(var a=0,d=i.handler.outgoingEventTypes;a<d.length;a++){var l=d[a];if(e.has(l)){o=!0;break}}if(o)for(var p=0,h=i.handler.incomingEventMatches;p<h.length;p++){var u=h[p];e.add(u.eventType);for(var c=0,v=u.keyModifiers;c<v.length;c++){var f=v[c];s.isSystemModifier(f)||t.add(f)}}i.active=o}this._sourceEvents=e,this._keyModifiers=t,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this._browserEvents&&(this._browserEvents.activeEvents=this._sourceEvents)},t.prototype._setLatestPointerType=function(e){this._set("latestPointerType",e)},t.prototype._onEventReceived=function(e,t){if("pointer-capture-lost"===e){var r=t;this._pointerCaptures["delete"](r["native"].pointerId)}this._updateKeyModifiers(e,t),this._emitInputEventFromSource(e,t)},t.prototype._updateKeyModifiers=function(e,t){var r=this;if(t){var n=!1,i=function(){if(!n){var e=new Set;r._activeKeyModifiers.forEach(function(t){e.add(t)}),r._activeKeyModifiers=e,n=!0}},o=function(e,t){t&&!r._activeKeyModifiers.has(e)?(i(),r._activeKeyModifiers.add(e)):!t&&r._activeKeyModifiers.has(e)&&(i(),r._activeKeyModifiers["delete"](e))};if("key-down"===e||"key-up"===e){var s=t,a=s.key;this._keyModifiers.has(a)&&o(a,"key-down"===e)}var d=t["native"];o("Alt",!(!d||!d.altKey)),o("Ctrl",!(!d||!d.ctrlKey)),o("Shift",!(!d||!d.shiftKey)),o("Meta",!(!d||!d.metaKey)),o("Primary",this._activeKeyModifiers.has(this.primaryKey))}},t.prototype._installRecognizers=function(){var e=this;this._latestPointerTypeHandler=new l.LatestPointerType(function(t){return e._setLatestPointerType(t)}),this._recognizers.length>0&&this.installHandlers("default",this._recognizers),this.installHandlers("input-manager-logic",[this._latestPointerTypeHandler])},t.prototype._setPointerCapture=function(e,t,r,n){var i=e.name+"-"+t.priorityIndex,o=this._pointerCaptures.get(r.pointerId)||new Set;this._pointerCaptures.set(r.pointerId,o),n?(o.add(i),1===o.size&&this._browserEvents&&this._browserEvents.setPointerCapture(r,!0)):(o["delete"](i),0===o.size&&(this._pointerCaptures["delete"](r.pointerId),this._browserEvents&&this._browserEvents.setPointerCapture(r,!1)))},t.prototype._garbageCollectRemovedHandlers=function(){this._handlers=this._handlers.filter(function(e){return!e.removed}),this.updateDependencies()},t.prototype._emitInputEventFromSource=function(e,t){this._emitInputEvent(0,e,t)},t.prototype._emitInputEvent=function(e,t,r,n){var i=new u(t,r,n||this._activeKeyModifiers);return this._currentPropagation?void this._currentPropagation.addedEvents.push(i):void this._doNewPropagation(e,i)},t.prototype._doNewPropagation=function(e,t){this._currentPropagation={events:[t],addedEvents:[],currentHandler:this._handlersPriority[e],needsHandlerGarbageCollect:!1};for(var r=this._currentPropagation;r.currentHandler;){if(r.currentHandler.removed)r.needsHandlerGarbageCollect=!0;else{var n=r.events,i=[];r.addedEvents=[];for(var o=0;o<n.length;o++){var s=n[o];r.currentHandler.active&&r.currentHandler.eventCallback(s),s.shouldStopPropagation()||i.push(s)}r.events=i.concat(r.addedEvents)}r.currentHandler=this._handlersPriority[r.currentHandler.priorityIndex+1]}r.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this._currentPropagation=null},t.prototype._compareHandlerPriority=function(e,t){if(e.handler.hasSideEffects!==t.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;for(var r=0,n=e.handler.incomingEventMatches;r<n.length;r++)for(var i=n[r],o=function(e){if(i.eventType!==e.eventType)return"continue";var t=i.keyModifiers.filter(function(t){return-1!==e.keyModifiers.indexOf(t)}),r=t.length===i.keyModifiers.length,n=t.length===e.keyModifiers.length;return r!==n?{value:i.keyModifiers.length>e.keyModifiers.length?-1:1}:void 0},s=0,a=t.handler.incomingEventMatches;s<a.length;s++){var d=a[s],l=o(d);if("object"==typeof l)return l.value}return e.priorityIndex>t.priorityIndex?-1:1},t.prototype._sortHandlersPriority=function(e){for(var t=[],r=0,n=e;r<n.length;r++){for(var i=n[r],o=0;o<t.length&&this._compareHandlerPriority(i,t[o])>=0;)o++;t.splice(o,0,i)}return t},t}(i.declared(o));n([i.property({readOnly:!0})],h.prototype,"latestPointerType",void 0),h=n([i.subclass("esri.views.input.InputManager")],h),t.InputManager=h;var u=function(){function e(e,t,r){this.type=e,this.data=t,this.modifiers=r,this._stopPropagation=!1,this.timestamp=Date.now()}return e.prototype.stopPropagation=function(){this._stopPropagation=!0},e.prototype.shouldStopPropagation=function(){return this._stopPropagation},e}()});