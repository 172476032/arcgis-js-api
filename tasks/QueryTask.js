// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../core/tsSupport/declareExtendsHelper","../core/tsSupport/decorateHelper","../core/tsSupport/paramHelper","../core/accessorSupport/decorators","dojo/_base/lang","../request","./Task","./support/FeatureSet","./support/Query","../geometry","../geometry/support/jsonUtils","../geometry/support/normalizeUtils"],function(e,r,t,o,n,s,i,a,u,l,c,p,y,d){var m="Layer does not support extent calculation.",f=function(e){function r(r){var t=e.call(this,r)||this;return t.gdbVersion=null,t.source=null,t}return t(r,e),u=r,r.queryToQueryStringParameters=function(e){var r=e.geometry,t=e.toJSON();if(r&&(t.geometry=JSON.stringify(r),t.geometryType=y.getJsonType(r),t.inSR=r.spatialReference.wkid||JSON.stringify(r.spatialReference)),t.groupByFieldsForStatistics&&(t.groupByFieldsForStatistics=t.groupByFieldsForStatistics.join(",")),t.objectIds&&(t.objectIds=t.objectIds.join(",")),t.orderByFields&&(t.orderByFields=t.orderByFields.join(",")),t.outFields&&(t.outFields=t.outFields.join(",")),t.outSR?t.outSR=t.outSR.wkid||JSON.stringify(t.outSR):r&&(t.returnGeometry||t.returnCentroid)&&(t.outSR=t.inSR),t.returnGeometry&&delete t.returnGeometry,t.outStatistics&&(t.outStatistics=JSON.stringify(t.outStatistics)),t.pixelSize&&(t.pixelSize=JSON.stringify(t.pixelSize)),t.quantizationParameters&&(t.quantizationParameters=JSON.stringify(t.quantizationParameters)),t.timeExtent){var o=t.timeExtent;t.time=[null!=o.startTime?o.startTime:"null",null!=o.endTime?o.endTime:"null"],delete t.timeExtent}return t},r.prototype.execute=function(e,r){var t=this;return this.rawExecute(e,r).then(function(e){return t._handleExecuteResponse(e)})},r.prototype.rawExecute=function(e,r){var t=this,o=e.geometry?[e.geometry]:[];return d.normalizeCentralMeridian(o).then(function(o){var n=t._encode(i.mixin({},t.parsedUrl.query,{f:"json"},t._normalizeQuery(e,o&&o[0])));if(t.source){var s={source:t.source.toJSON()};n.layer=JSON.stringify(s)}t.gdbVersion&&(n.gdbVersion=t.gdbVersion);var u={query:n,callbackParamName:"callback"};return(t.requestOptions||r)&&(u=i.mixin({},t.requestOptions,r,u)),a(t.parsedUrl.path+"/query",u)})},r.prototype.executeRelationshipQuery=function(e,r){var t=this._encode(i.mixin({},this.parsedUrl.query,{f:"json"},e.toJSON()));this.gdbVersion&&(t.gdbVersion=this.gdbVersion);var o={query:t,callbackParamName:"callback"};return(this.requestOptions||r)&&(o=i.mixin({},this.requestOptions,r,o)),a(this.parsedUrl.path+"/queryRelatedRecords",o).then(this._handleExecuteRelationshipQueryResponse)},r.prototype.executeForIds=function(e,r){var t=this,o=e.geometry?[e.geometry]:[];return d.normalizeCentralMeridian(o).then(function(o){var n=t._encode(i.mixin({},t.parsedUrl.query,{f:"json",returnIdsOnly:!0},t._normalizeQuery(e,o&&o[0])));if(t.source){var s={source:t.source.toJSON()};n.layer=JSON.stringify(s)}t.gdbVersion&&(n.gdbVersion=t.gdbVersion);var u={query:n,callbackParamName:"callback"};return(t.requestOptions||r)&&(u=i.mixin({},t.requestOptions,r,u)),a(t.parsedUrl.path+"/query",u)}).then(this._handleExecuteForIdsResponse)},r.prototype.executeForCount=function(e,r){var t=this,o=e.geometry?[e.geometry]:[];return d.normalizeCentralMeridian(o).then(function(o){var n=t._encode(i.mixin({},t.parsedUrl.query,{f:"json",returnIdsOnly:!0,returnCountOnly:!0},t._normalizeQuery(e,o&&o[0])));if(t.source){var s={source:t.source.toJSON()};n.layer=JSON.stringify(s)}t.gdbVersion&&(n.gdbVersion=t.gdbVersion);var u={query:n,callbackParamName:"callback"};return(t.requestOptions||r)&&(u=i.mixin({},t.requestOptions,r,u)),a(t.parsedUrl.path+"/query",u)}).then(this._handleExecuteForCountResponse)},r.prototype.executeForExtent=function(e,r){var t=this,o=e.geometry?[e.geometry]:[];return d.normalizeCentralMeridian(o).then(function(o){var n=t._encode(i.mixin({},t.parsedUrl.query,{f:"json",returnExtentOnly:!0,returnCountOnly:!0},t._normalizeQuery(e,o&&o[0])));if(t.source){var s={source:t.source.toJSON()};n.layer=JSON.stringify(s)}t.gdbVersion&&(n.gdbVersion=t.gdbVersion);var u={query:n,callbackParamName:"callback"};return(t.requestOptions||r)&&(u=i.mixin({},t.requestOptions,r,u)),a(t.parsedUrl.path+"/query",u)}).then(this._handleExecuteForExtentResponse)},r.prototype._handleExecuteResponse=function(e){return l.fromJSON(e.data)},r.prototype._handleExecuteRelationshipQueryResponse=function(e){var r=e.data,t=r.geometryType,o=r.spatialReference,n={};return r.relatedRecordGroups.forEach(function(e){var r={geometryType:t,spatialReference:o,features:e.relatedRecords},s=l.fromJSON(r);if(null!=e.objectId)n[e.objectId]=s;else for(var i in e)e.hasOwnProperty(i)&&"relatedRecords"!==i&&(n[e[i]]=s)}),n},r.prototype._handleExecuteForIdsResponse=function(e){return e.data.objectIds},r.prototype._handleExecuteForCountResponse=function(e){var r,t=e.data,o=t.features,n=t.objectIds;if(n)r=n.length;else{if(o)throw new Error("Unable to perform query. Please check your parameters.");r=t.count}return r},r.prototype._handleExecuteForExtentResponse=function(e){var r=e.data;if(r.hasOwnProperty("extent"))r.extent=p.Extent.fromJSON(r.extent);else{if(r.features)throw new Error(m);if(r.hasOwnProperty("count"))throw new Error(m)}return r},r.prototype._normalizeQuery=function(e,r){return r&&(e=e.clone(),e.geometry=r),u.queryToQueryStringParameters(e)},o([s.property()],r.prototype,"gdbVersion",void 0),o([s.property()],r.prototype,"source",void 0),o([n(0,s.cast(c))],r.prototype,"execute",null),o([n(0,s.cast(c))],r.prototype,"rawExecute",null),o([n(0,s.cast(c))],r.prototype,"executeForIds",null),o([n(0,s.cast(c))],r.prototype,"executeForCount",null),o([n(0,s.cast(c))],r.prototype,"executeForExtent",null),r=u=o([s.subclass("esri.tasks.QueryTask")],r);var u}(s.declared(u));return f});