// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["../core/kebabDictionary","../core/urlUtils","../geometry/Polygon","../geometry/support/scaleUtils","dojo/_base/lang","dojo/dom-construct","dojox/gfx/canvas","./Geoprocessor","./support/PrintTemplate","./support/printTaskUtils","./Task"],function(e,t,r,a,i,s,n,l,o,u,c){function y(e){return!(!e||!e.path)}var d={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},p=e({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),m=e({MAP_ONLY:"map-only","A3 Landscape":"a3-landscape","A3 Portrait":"a3-portrait","A4 Landscape":"a4-landscape","A4 Portrait":"a4-portrait","Letter ANSI A Landscape":"letter-ansi-a-landscape","Letter ANSI A Portrait":"letter-ansi-a-portrait","Tabloid ANSI B Landscape":"tabloid-ansi-b-landscape","Tabloid ANSI B Portrait":"tabloid-ansi-b-portrait"}),f=c.createSubclass({declaredClass:"esri.tasks.PrintTask",constructor:function(){this._handleExecuteResponse=this._handleExecuteResponse.bind(this)},_legendLayers:[],_legendLayerNameMap:{},properties:{_geoprocessor:{dependsOn:["url","updateDelay"],get:function(){return new l(this.url,{updateDelay:this.updateDelay})}},mode:{value:"sync"},url:{value:null,type:String},updateDelay:{value:1e3,type:Number}},execute:function(e,t){var r=this._setPrintParams(e),a="async"===this.mode?"submitJob":"execute";return this._geoprocessor[a](r,t).then(this._handleExecuteResponse)},_createOperationalLayers:function(e,r){var a,s,n,l,o=e.map,u=[],c=o.allLayers.items,y=/^https?:\/\/basemaps(dev)?\.arcgis\.com(\/b2)?\/arcgis\/rest\/services\/World_Basemap\/VectorTileServer/i,d="http://services.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer";for(a=0;a<c.length;a++)if(s=c[a],s.loaded&&s.visible)switch(l={id:s.id,title:this._legendLayerNameMap[s.id]||s.title,opacity:s.opacity,minScale:s.minScale||0,maxScale:s.maxScale||0,url:s.url&&t.normalize(s.url),token:s.token},n=s.declaredClass){case"esri.layers.ImageryLayer":var p={bandIds:s.bandIds,compressionQuality:s.compressionQuality,format:s.format,interpolation:s.interpolation};s.mosaicRule&&(p.mosaicRule=s.mosaicRule.toJSON()),s.renderingRule&&(p.renderingRule=s.renderingRule.toJSON()),u.push(i.mixin(l,p)),this._legendLayers&&this._legendLayers.push({id:s.id});break;case"esri.layers.OpenStreetMapLayer":i.mixin(l,{type:"OpenStreetMap"}),u.push(l);break;case"esri.layers.GraphicsLayer":i.mixin(l,this._createFeatureCollectionJSON(s)),u.push(l),this._legendLayers&&this._legendLayers.push({id:s.id});break;case"esri.layers.VectorTileLayer":case"esri.layers.mixins.ScaleRangeLayer":y.test(s.serviceUrl)&&(l.url=d,u.push(l));break;case"esri.layers.MapImageLayer":var m={id:s.id,subLayerIds:[]},f=[],h=e.scale,g=function(e){var t=0===h,r=0===e.minScale||h<=e.minScale,a=0===e.maxScale||h>=e.maxScale;e.visible&&(t||r&&a)&&(e.sublayers?e.sublayers.forEach(g):(f.unshift(e.toJSON({})),m.subLayerIds.push(e.id)))};s.sublayers&&s.sublayers.forEach(g),i.mixin(l,{layers:f}),u.push(l),this._legendLayers.push(m);break;case"esri.layers.WebTileLayer":var b=s.urlTemplate.replace(/\$\{/g,"{");i.mixin(l,{type:"WebTiledLayer",urlTemplate:b,credits:s.copyright}),s.subDomains&&s.subDomains.length>0&&(l.subDomains=s.subDomains),u.push(l);break;case"esri.layers.FeatureLayer":case"esri.layers.CSVLayer":case"esri.layers.StreamLayer":var S;e.whenLayerView(s).then(function(e){return e.queryGraphics&&e.queryGraphics()||e.featuresView.graphics}).then(function(e){S=e.map(function(e){return e.geometry.hasZ=!1,e})}),i.mixin(l,this._createFeatureCollectionJSON(s,S)),u.push(l),this._legendLayers&&this._legendLayers.push({id:s.id});break;default:u.push(l)}return u},_createFeatureCollectionJSON:function(e,t){var a=e,s=u.createPolygonLayer(),n=u.createPolylineLayer(),l=u.createPointLayer(),o=u.createMultipointLayer(),c=u.createPointLayer();if(c.layerDefinition.name="textLayer",delete c.layerDefinition.drawingInfo,"esri.layers.FeatureLayer"===a.declaredClass||"esri.layers.StreamLayer"===a.declaredClass?s.layerDefinition.name=n.layerDefinition.name=l.layerDefinition.name=o.layerDefinition.name=this._legendLayerNameMap[a.id]||a.get("arcgisProps.title")||a.title:"esri.layers.GraphicsLayer"===a.declaredClass&&(t=a.graphics.items),a.renderer&&!i.isFunction(a.get("renderer.attributeField"))){var y=a.renderer.toJSON();s.layerDefinition.drawingInfo.renderer=y,n.layerDefinition.drawingInfo.renderer=y,l.layerDefinition.drawingInfo.renderer=y,o.layerDefinition.drawingInfo.renderer=y}else delete s.layerDefinition.drawingInfo,delete n.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo,delete o.layerDefinition.drawingInfo;var d=a.fields;!a.renderer||d||i.isFunction(a.get("renderer.attributeField"))||("classBreaks"===a.renderer.type?(d=[{name:a.renderer.attributeField,type:"esriFieldTypeDouble"}],a.renderer.normalizationField&&d.push({name:a.renderer.normalizationField,type:"esriFieldTypeDouble"})):"uniqueValue"===a.renderer.type&&(d=[{name:a.renderer.attributeField,type:"esriFieldTypeString"}],a.renderer.attributeField2&&d.push({name:a.renderer.attributeField2,type:"esriFieldTypeString"}),a.renderer.attributeField3&&d.push({name:a.renderer.attributeField3,type:"esriFieldTypeString"}))),d&&(s.layerDefinition.fields=d,n.layerDefinition.fields=d,l.layerDefinition.fields=d,o.layerDefinition.fields=d);for(var p,m=t&&t.length,f=0;m>f;f++){var h=t[f]||t.getItemAt(f);if(h.visible!==!1&&h.geometry&&(p=h.toJSON(),p.geometry&&p.geometry.z&&delete p.geometry.z,!p.symbol||!p.symbol.outline||"esriCLS"!==p.symbol.outline.type)){if(p.symbol&&p.symbol.outline&&p.symbol.outline.color&&p.symbol.outline.color[3]&&(p.symbol.outline.color[3]=255),a.renderer&&!p.symbol&&(i.isFunction(a.renderer.attributeField)||a.renderer.hasVisualVariables())){var g=a.renderer,b=g.getSymbol(h);if(!b)continue;p.symbol=b.toJSON(),g.hasVisualVariables()&&u.applyVisualVariables(p.symbol,{renderer:g,graphic:h,symbol:b})}p.symbol&&(p.symbol.path?p.symbol=this._convertSvgToPictureMarkerSymbolJson(p.symbol):p.symbol.text&&delete p.attributes),"polygon"===h.geometry.type?s.featureSet.features.push(p):"polyline"===h.geometry.type?n.featureSet.features.push(p):"point"===h.geometry.type?p.symbol&&p.symbol.text?c.featureSet.features.push(p):l.featureSet.features.push(p):"multipoint"===h.geometry.type?o.featureSet.features.push(p):"extent"===h.geometry.type&&(p.geometry=r.fromExtent(h.geometry).toJSON(),s.featureSet.features.push(p))}}var S=[s,n,o,l,c].filter(function(e){return e.featureSet.features.length>0});return S.forEach(function(e){e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&this._convertSvgRenderer(e.layerDefinition.drawingInfo.renderer)},this),{id:a.id,opacity:a.opacity,minScale:a.minScale||0,maxScale:a.maxScale||0,featureCollection:{layers:S}}},_convertSvgToPictureMarkerSymbolJson:function(e){this._canvasParent||(this._canvasParent=s.create("div"),this._canvasSurface=n.createSurface(this._canvasParent,200,200));var t=this._canvasSurface.createObject(n.Path,e.path).setFill(e.color).setStroke(e.outline);"pendingRender"in this._canvasSurface&&this._canvasSurface._render(!0);var r=this._canvasSurface.rawNode.getContext("2d"),a=t.getBoundingBox(),i=Math.ceil(a.width+a.x),l=Math.ceil(a.height+a.y),o=r.getImageData(a.x,a.y,i,l);r.canvas.width=i,r.canvas.height=l,r.putImageData(o,0,0);var u=r.canvas.toDataURL("image/png"),c=22;return{type:"esriPMS",imageData:u.substr(c),angle:-e.angle,contentType:"image/png",height:e.size?e.size:l-a.y,width:e.size?e.size:i-a.x,xoffset:e.xoffset,yoffset:e.yoffset}},_convertSvgRenderer:function(e){var t=e.type;if("simple"===t&&y(e.symbol))return void(e.symbol=this._convertSvgToPictureMarkerSymbolJson(e.symbol));if("uniqueValue"===t||"classBreaks"===t){var r="uniqueValue"===t?"uniqueValueInfos":"classBreakInfos",a=e[r];y(e.defaultSymbol)&&(e.defaultSymbol=this._convertSvgToPictureMarkerSymbolJson(e.defaultSymbol)),a&&a.forEach(function(e){y(e)&&(e.symbol=this._convertSvgToPictureMarkerSymbolJson(e.symbol))},this)}},_getPrintDefinition:function(e,t){var r=e.view,i=e.extent||r.extent,s=r.map,n=r.spatialReference;n&&n.isWrappable&&(i=i.clone()._normalize(!0),n=i.spatialReference);var l={mapOptions:{showAttribution:t.attributionVisible,extent:i&&i.toJSON(),spatialReference:n&&n.toJSON()},operationalLayers:this._createOperationalLayers(r,t)};return t.preserveScale&&(l.mapOptions.scale=t.outScale||a.getScale(s)),s.timeExtent&&(l.mapOptions.time=[s.timeExtent.startTime.getTime(),s.timeExtent.endTime.getTime()]),l},_handleExecuteResponse:function(e){return"sync"===this.mode?e.results&&e.results[0]&&e.results[0].value:this._geoprocessor.getResultData(e.jobId,"Output_File").then(function(e){return e.value})},_setPrintParams:function(e){var t=e.template||new o;null==t.showLabels&&(t.showLabels=!0);var r,a=t.exportOptions;if(a){var s=a.width,n=a.height,l=a.dpi;r={outputSize:[s,n],dpi:l}}var u,c=t.layoutOptions;if(c){var y,f;"Miles"===c.scalebarUnit||"Kilometers"===c.scalebarUnit?(y="Kilometers",f="Miles"):("Meters"===c.scalebarUnit||"Feet"===c.scalebarUnit)&&(y="Meters",f="Feet"),u={titleText:c.titleText,authorText:c.authorText,copyrightText:c.copyrightText,customTextElements:c.customTextElements,scaleBarOptions:{metricUnit:p.toJSON(y),metricLabel:d[y],nonMetricUnit:p.toJSON(f),nonMetricLabel:d[f]}}}var h=null;c&&c.legendLayers&&(h=c.legendLayers.map(function(e){this._legendLayerNameMap[e.layerId]=e.title;var t={id:e.layerId};return e.subLayerIds&&(t.subLayerIds=e.subLayerIds),t},this));var g=this._getPrintDefinition(e,t);e.outSpatialReference&&(g.mapOptions.spatialReference=e.outSpatialReference.toJSON()),i.mixin(g,{exportOptions:r,layoutOptions:u}),i.mixin(g.layoutOptions,{legendOptions:{operationalLayers:null!=h?h:this._legendLayers}});var b=JSON.stringify(g),S={Web_Map_as_JSON:b,Format:t.format,Layout_Template:m.toJSON(t.layout)};return e.extraParameters&&i.mixin(S,e.extraParameters),S}});return f});