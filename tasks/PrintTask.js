// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.21/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/_base/array","dojo/_base/json","dojo/_base/Deferred","dojo/has","../kernel","../lang","../layerUtils","../deferredUtils","../Color","../urlUtils","./Task","../geometry/Polygon","../renderers/SimpleRenderer","../symbols/FillSymbol","./Geoprocessor","./PrintTemplate","dojo/dom-attr","dojo/dom-construct","dojox/gfx/_base","dojox/gfx/canvas","dojox/json/query","dojo/has!extend-esri?./PrintParameters","dojo/has!extend-esri?./LegendLayer"],function(e,r,t,i,a,n,l,s,o,d,y,u,c,m,f,p,g,h,b,v,S,x,_){var L=e(c,{declaredClass:"esri.tasks.PrintTask",constructor:function(e,t){this.url=e,this.printGp=new g(this.url),this._handler=r.hitch(this,this._handler),t&&t.async&&(this.async=t.async),this._colorEvaluator=_("$..color")},_vtlExtent:null,_handler:function(e,t,i,a,n){try{var l;this.async?"esriJobSucceeded"===e.jobStatus&&this.printGp.getResultData(e.jobId,"Output_File",r.hitch(this,function(e){l=e.value,this._successHandler([l],"onComplete",i,n)})):(l=e[0].value,this._successHandler([l],"onComplete",i,n))}catch(s){this._errorHandler(s,a,n)}},execute:function(e,n,l){var o=this._handler,y=this._errorHandler,u=e.template||new h;u.hasOwnProperty("showLabels")||(u.showLabels=!0);var c,m=u.exportOptions;if(m){var f=m.width,p=m.height,g=m.dpi;c={outputSize:[f,p],dpi:g}}var b,v=u.layoutOptions,S=[];if(v){this.legendAll=!1,v.legendLayers?t.forEach(v.legendLayers,function(e){var r={};r.id=e.layerId,e.subLayerIds&&(r.subLayerIds=e.subLayerIds),S.push(r)}):this.legendAll=!0;var x,_;"Miles"===v.scalebarUnit||"Kilometers"===v.scalebarUnit?(x="esriKilometers",_="esriMiles"):("Meters"===v.scalebarUnit||"Feet"===v.scalebarUnit)&&(x="esriMeters",_="esriFeet");var L={esriMiles:"mi",esriKilometers:"km",esriFeet:"ft",esriMeters:"m"};b={titleText:v.titleText,authorText:v.authorText,copyrightText:v.copyrightText,customTextElements:v.customTextElements,scaleBarOptions:{metricUnit:x,metricLabel:L[x],nonMetricUnit:_,nonMetricLabel:L[_]},legendOptions:{operationalLayers:S}}}var I=e.map,D=this._getPrintDefinition(I,u);if(e.outSpatialReference&&(D.mapOptions.spatialReference=e.outSpatialReference.toJson()),e.template&&s.isDefined(e.template.showAttribution)&&(D.mapOptions.showAttribution=e.template.showAttribution),r.mixin(D,{exportOptions:c,layoutOptions:b}),this.allLayerslegend&&r.mixin(D.layoutOptions,{legendOptions:{operationalLayers:this.allLayerslegend}}),D.operationalLayers){var T,w,F,R,O=D.operationalLayers,k=function(e){return s.fixJson(r.mixin(e,{type:"esriSLS",cap:void 0,join:void 0,meterLimit:void 0}))};for(T=0;T<O.length;T++)if(O[T].featureCollection&&O[T].featureCollection.layers)for(w=0;w<O[T].featureCollection.layers.length;w++){var C=O[T].featureCollection.layers[w];if(C.layerDefinition&&C.layerDefinition.drawingInfo&&C.layerDefinition.drawingInfo.renderer&&C.layerDefinition.drawingInfo.renderer.symbol&&(R=C.layerDefinition.drawingInfo.renderer,"esriCLS"===R.symbol.type?R.symbol=k(R.symbol):R.symbol.outline&&"esriCLS"===R.symbol.outline.type&&(R.symbol.outline=k(R.symbol.outline))),C.featureSet&&C.featureSet.features)for(F=0;F<C.featureSet.features.length;F++)R=C.featureSet.features[F],R.symbol&&("esriCLS"===R.symbol.type?R.symbol=k(R.symbol):R.symbol.outline&&"esriCLS"===R.symbol.outline.type&&(R.symbol.outline=k(R.symbol.outline)))}}var E=i.toJson(s.fixJson(D)),P=u.format,M=u.layout,V={Web_Map_as_JSON:E,Format:P,Layout_Template:M};e.extraParameters&&(V=r.mixin(V,e.extraParameters));var j=new a(d._dfdCanceller),J=function(e,r){o(e,r,n,l,j)},A=function(e){y(e,l,j)};return this.async?j._pendingDfd=this.printGp.submitJob(V,J,null,A):j._pendingDfd=this.printGp.execute(V,J,A),j},onComplete:function(){},_createMultipointLayer:function(){return{layerDefinition:{name:"multipointLayer",geometryType:"esriGeometryMultipoint",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryMultipoint",features:[]}}},_createPolygonLayer:function(){return{layerDefinition:{name:"polygonLayer",geometryType:"esriGeometryPolygon",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPolygon",features:[]}}},_createPointLayer:function(){return{layerDefinition:{name:"pointLayer",geometryType:"esriGeometryPoint",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPoint",features:[]}}},_createPolylineLayer:function(){return{layerDefinition:{name:"polylineLayer",geometryType:"esriGeometryPolyline",drawingInfo:{renderer:null}},featureSet:{geometryType:"esriGeometryPolyline",features:[]}}},_convertSvgSymbol:function(e){if(!(n("ie")<=8||!e.path&&"image/svg+xml"!==e.contentType)){var r,t=x.createSurface(v.create("div"),1024,1024);r="image/svg+xml"===e.contentType?t.createObject(x.Image,{src:"data:image/svg+xml;base64,"+e.imageData,width:S.pt2px(e.width),height:S.pt2px(e.height),x:0,y:0}):t.createObject(x.Path,e.path).setFill(e.color).setStroke(e.outline),"pendingRender"in t&&t._render(!0);var i=t.rawNode.getContext("2d"),a=Math.ceil(r.getBoundingBox().width),l=Math.ceil(r.getBoundingBox().height),s=i.getImageData(r.getBoundingBox().x,r.getBoundingBox().y,a,l);i.canvas.width=a,i.canvas.height=l,i.putImageData(s,0,0);var o=i.canvas.toDataURL("image/png"),d={type:"esriPMS",imageData:o.substr(22,o.length),angle:e.angle,contentType:"image/png",height:e.size?e.size:S.px2pt(l),width:e.size?e.size*(a/l):S.px2pt(a),xoffset:e.xoffset,yoffset:e.yoffset};return t.destroy(),d}},_convertSvgRenderer:function(e){"simple"===e.type&&e.symbol&&(e.symbol.path||"image/svg+xml"===e.symbol.contentType)?e.symbol=this._convertSvgSymbol(e.symbol):"uniqueValue"===e.type?(e.defaultSymbol&&(e.defaultSymbol.path||"image/svg+xml"===e.defaultSymbol.contentType)&&(e.defaultSymbol=this._convertSvgSymbol(e.defaultSymbol)),e.uniqueValueInfos&&t.forEach(e.uniqueValueInfos,function(e){(e.symbol.path||"image/svg+xml"===e.symbol.contentType)&&(e.symbol=this._convertSvgSymbol(e.symbol))},this)):"classBreaks"===e.type&&(e.defaultSymbol&&(e.defaultSymbol.path||"image/svg+xml"===e.defaultSymbol.contentType)&&(e.defaultSymbol=this._convertSvgSymbol(e.defaultSymbol)),e.classBreakInfos&&t.forEach(e.classBreakInfos,function(e){(e.symbol.path||"image/svg+xml"===e.symbol.contentType)&&(e.symbol=this._convertSvgSymbol(e.symbol))},this))},_createFeatureCollection:function(e,i,a){var n=this._createPolygonLayer(),l=this._createPolylineLayer(),s=this._createPointLayer(),o=this._createMultipointLayer(),d=this._createPointLayer();d.layerDefinition.name="textLayer",delete d.layerDefinition.drawingInfo,("esri.layers.FeatureLayer"===e.declaredClass||"esri.layers.StreamLayer"===e.declaredClass)&&(n.layerDefinition.name=l.layerDefinition.name=s.layerDefinition.name=o.layerDefinition.name=r.getObject("arcgisProps.title",!1,e)||e.name||e.id);var y=e.renderer&&"esri.renderer.SimpleRenderer"===e.renderer.declaredClass;if(!e.renderer||e.renderer._compiledFunc||r.isFunction(e.renderer.attributeField))delete n.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo,delete s.layerDefinition.drawingInfo,delete o.layerDefinition.drawingInfo;else{var u=e.renderer.toJson({useLegacyRotationProperties:!0});if("temporal"===u.type){var c={latestObservationRenderer:u.latestObservationRenderer,trackLinesRenderer:u.trackRenderer,observationAger:u.observationAger,renderer:u.observationRenderer},f={};e._trackIdField&&(f.trackIdField=e._trackIdField),e._startTimeField&&(f.startTimeField=e._startTimeField),e._endTimeField&&(f.endTimeField=e._endTimeField),n.layerDefinition.drawingInfo=c,n.layerDefinition.timeInfo=f,l.layerDefinition.drawingInfo=c,l.layerDefinition.timeInfo=f,s.layerDefinition.drawingInfo=c,s.layerDefinition.timeInfo=f,o.layerDefinition.drawingInfo=c,o.layerDefinition.timeInfo=f}else n.layerDefinition.drawingInfo.renderer=u,l.layerDefinition.drawingInfo.renderer=u,s.layerDefinition.drawingInfo.renderer=u,o.layerDefinition.drawingInfo.renderer=u}var p=e.fields;p||!e.renderer||e.renderer._compiledFunc||r.isFunction(e.renderer.attributeField)||("esri.renderer.ClassBreaksRenderer"===e.renderer.declaredClass?(p=[{name:e.renderer.attributeField,type:"esriFieldTypeDouble"}],e.renderer.normalizationField&&p.push({name:e.renderer.normalizationField,type:"esriFieldTypeDouble"})):"esri.renderer.UniqueValueRenderer"===e.renderer.declaredClass&&(p=[{name:e.renderer.attributeField,type:"esriFieldTypeString"}],e.renderer.attributeField2&&p.push({name:e.renderer.attributeField2,type:"esriFieldTypeString"}),e.renderer.attributeField3&&p.push({name:e.renderer.attributeField3,type:"esriFieldTypeString"}))),p&&(n.layerDefinition.fields=p,l.layerDefinition.fields=p,s.layerDefinition.fields=p,o.layerDefinition.fields=p);var g,h,b=e.graphics.length;for(h=0;b>h;h++){var v=e.graphics[h];if(v.visible!==!1&&v.geometry){if(g=v.toJson(),g.symbol&&g.symbol.outline&&g.symbol.outline.color&&g.symbol.outline.color[3]&&(g.symbol.outline.color[3]=255),e.renderer&&!g.symbol&&(r.isFunction(e.renderer.attributeField)||e.renderer._compiledFunc||this._isFeatureCollectionRequired(e.renderer)||"esri.renderer.DotDensityRenderer"===e.renderer.declaredClass||a)){a=a||e.renderer;var S=null;try{S=a.getSymbol(v)}catch(x){}if(!S)continue;g.symbol=S.toJson(),this._isFeatureCollectionRequired(a)&&this._applyVisualVariables(g.symbol,{renderer:a,graphic:v,symbol:S,mapResolution:i&&i.getResolutionInMeters(),mapScale:i&&i.getScale()})}switch(g.symbol&&(g.symbol.path||"image/svg+xml"===g.symbol.contentType?g.symbol=this._convertSvgSymbol(g.symbol):g.symbol.text&&delete g.attributes),v.geometry.type){case"polygon":n.featureSet.features.push(g);break;case"polyline":l.featureSet.features.push(g);break;case"point":g.symbol&&g.symbol.text?d.featureSet.features.push(g):s.featureSet.features.push(g);break;case"multipoint":o.featureSet.features.push(g);break;case"extent":g.geometry=m.fromExtent(v.geometry).toJson(),n.featureSet.features.push(g)}}}var _=[];if(n.featureSet.features.length>0&&_.push(n),l.featureSet.features.length>0&&_.push(l),o.featureSet.features.length>0&&_.push(o),s.featureSet.features.length>0&&_.push(s),d.featureSet.features.length>0&&_.push(d),!_.length)return null;t.forEach(_,function(e){var r=t.every(e.featureSet.features,function(e){return e.symbol});(y||r)&&(t.forEach(e.featureSet.features,function(e){delete e.attributes}),delete e.layerDefinition.fields),r&&delete e.layerDefinition.drawingInfo}),t.forEach(_,function(e){e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&this._convertSvgRenderer(e.layerDefinition.drawingInfo.renderer)},this);var L={layers:_},I={id:e.id,opacity:e.opacity,minScale:e.minScale||0,maxScale:e.maxScale||0,featureCollection:L};return I},_getPrintDefinition:function(e,t){var i=this._createOperationalLayers(e,t),a={operationalLayers:i},n=this._vtlExtent||e.extent,l=e.spatialReference;this._vtlExtent=null,e.spatialReference._isWrappable()&&(n=n._normalize(!0),l=n.spatialReference);var s={mapOptions:{showAttribution:e.showAttribution,extent:n.toJson(),spatialReference:l.toJson()}};t.preserveScale&&r.mixin(s.mapOptions,{scale:t.outScale||e.getScale()}),e.timeExtent&&r.mixin(s.mapOptions,{time:[e.timeExtent.startTime.getTime(),e.timeExtent.endTime.getTime()]});var o={};return r.mixin(o,s,a),o},_createOperationalLayers:function(e,a){var n,l,s,d,y=[];this.legendAll?this.allLayerslegend=[]:this.allLayerslegend=null,this._vtlExtent=null;var c=t.map(e.layerIds,e.getLayer,e);for(e._mapImageLyr&&c.push(e._mapImageLyr),n=0;n<c.length;n++)if(l=c[n],l.loaded&&l.visible)switch(s=l.declaredClass,d={id:l.id,title:r.getObject("arcgisProps.title",!1,l)||l.id,opacity:l.opacity,minScale:l.minScale||0,maxScale:l.maxScale||0},d=r.mixin(d,this._getUrlAndToken(l)),l.getNode()&&b.get(l.getNode(),"data-reference")&&(d._isRefLayer=!0),s){case"esri.layers.ArcGISDynamicMapServiceLayer":var m=[],p=!!l._params.layers;if(l._params.dynamicLayers){var g=i.fromJson(l._params.dynamicLayers);t.forEach(g,function(e){m.push({id:e.id,name:e.name,layerDefinition:e}),delete e.id,delete e.name,delete e.maxScale,delete e.minScale}),0===m.length&&(d.visibleLayers=[-1])}else if(l.supportsDynamicLayers){if(p||l.layerDefinitions||l.layerTimeOptions){var h=l.createDynamicLayerInfosFromLayerInfos(),v=null;p&&(v=l.visibleLayers),v=o._getVisibleLayers(h,v);var S=o._getLayersForScale(a.outScale||e.getScale(),h);t.forEach(h,function(e){if(!e.subLayerIds){var r=e.id;if(t.indexOf(v,r)>-1&&t.indexOf(S,r)>-1){var i={source:e.source.toJson()};l.layerDefinitions&&l.layerDefinitions[r]&&(i.definitionExpression=l.layerDefinitions[r]),l.layerTimeOptions&&l.layerTimeOptions[r]&&(i.layerTimeOptions=l.layerTimeOptions[r].toJson()),m.push({id:r,layerDefinition:i})}}}),0===m.length&&(d.visibleLayers=[-1])}}else t.forEach(l.layerInfos,function(e){var r={id:e.id,layerDefinition:{}};l.layerDefinitions&&l.layerDefinitions[e.id]&&(r.layerDefinition.definitionExpression=l.layerDefinitions[e.id]),l.layerTimeOptions&&l.layerTimeOptions[e.id]&&(r.layerDefinition.layerTimeOptions=l.layerTimeOptions[e.id].toJson()),(r.layerDefinition.definitionExpression||r.layerDefinition.layerTimeOptions)&&m.push(r)}),p&&(d.visibleLayers=l.visibleLayers);m.length&&(d.layers=m),y.push(d),this.allLayerslegend&&this.allLayerslegend.push({id:l.id,subLayerIds:l.visibleLayers});break;case"esri.layers.ArcGISImageServiceLayer":if(d=r.mixin(d,{url:l.url,bandIds:l.bandIds,compressionQuality:l.compressionQuality,format:l.format,interpolation:l.interpolation}),l.mosaicRule&&r.mixin(d,{mosaicRule:l.mosaicRule.toJson()}),l.renderingRule||l.renderer){var x=l.getExportImageRenderingRule();x&&r.mixin(d,{renderingRule:x.toJson()})}y.push(d),this.allLayerslegend&&this.allLayerslegend.push({id:l.id});break;case"esri.layers.WMSLayer":d=r.mixin(d,{url:l.url,title:l.title,type:"wms",version:l.version,transparentBackground:l.imageTransparency,visibleLayers:l.visibleLayers}),y.push(d),this.allLayerslegend&&this.allLayerslegend.push({id:l.id,subLayerIds:l.visibleLayers});break;case"esri.virtualearth.VETiledLayer":var _=l.mapStyle;"roadOnDemand"===_?_="Road":"aerialWithLabels"===_&&(_="Hybrid"),d=r.mixin(d,{visibility:l.visible,type:"BingMaps"+_,culture:l.culture,key:l.bingMapsKey}),y.push(d);break;case"esri.layers.OpenStreetMapLayer":d=r.mixin(d,{credits:l.copyright,type:"OpenStreetMap",url:u.getAbsoluteUrl(l.tileServers[0])}),y.push(d);break;case"esri.layers.WMTSLayer":d=r.mixin(d,{url:l.url,type:"wmts",layer:l._identifier,style:l._style,format:l.format,tileMatrixSet:l._tileMatrixSetId}),y.push(d);break;case"esri.layers.MapImageLayer":var L=l.getImages();t.forEach(L,function(e,r){e.href&&(d={id:l.id+"_image"+r,type:"image",title:l.id,minScale:l.minScale||0,maxScale:l.maxScale||0,opacity:l.opacity*e.opacity,extent:e.extent.toJson()},"data:image/png;base64,"===e.href.substr(0,22)?d.imageData=e.href.substr(22):d.url=e.href,y.push(d))});break;case"esri.layers.VectorTileLayer":d.type="image",d.url&&delete d.url;var I=this._vtlExtent||e.extent.offset(0,0),D=a.exportOptions&&a.exportOptions.dpi||96,T={format:"png",pixelRatio:D/96};if("MAP_ONLY"===a.layout&&a.preserveScale&&(!a.outScale||a.outScale===e.getScale())&&96===D&&a.exportOptions&&(a.exportOptions.width%2!==e.width%2||a.exportOptions.height%2!==e.height%2)&&(T.area={x:0,y:0,width:e.width,height:e.height},a.exportOptions.width%2!==e.width%2&&(T.area.width-=1),a.exportOptions.height%2!==e.height%2&&(T.area.height-=1),!this._vtlExtent)){var w=e.toMap({x:T.area.width,y:T.area.height});I.update(I.xmin,w.y,w.x,I.ymax,I.spatialReference),this._vtlExtent=I}d.extent=I._normalize(!0).toJson();var F=l.takeScreenshot(T);F.isResolved()?F.then(function(e){"data:image/png;base64,"===e.dataURL.substr(0,22)&&(d.imageData=e.dataURL.substr(22))}):console.error("PrintTask: VectorTileLayer.takeScreenshot() returned an unresolved Promise"),d.imageData&&y.push(d);break;case"esri.layers.WebTiledLayer":var R=l.url.replace(/\$\{/g,"{");d=r.mixin(d,{type:"WebTiledLayer",urlTemplate:R,credits:l.copyright}),l.subDomains&&l.subDomains.length>0&&(d.subDomains=l.subDomains),l._wmtsInfo&&(d.wmtsInfo=l._wmtsInfo),delete d.url,y.push(d);break;default:(l.getTileUrl||l.getImageUrl)&&(d=r.mixin(d,{url:l.url}),y.push(d))}for(n=0;n<e.graphicsLayerIds.length;n++)if(l=e.getLayer(e.graphicsLayerIds[n]),l.loaded&&l.visible){s=l.declaredClass;var O;switch(s){case"esri.layers.FeatureLayer":case"esri.layers.LabelLayer":case"esri.layers.CSVLayer":case"esri.layers.StreamLayer":if("esri.layers.LabelLayer"===s&&!a.showLabels||l.renderer&&"esri.renderer.HeatmapRenderer"===l.renderer.declaredClass)continue;if(O=null,l.url&&l.renderer&&("esri.renderer.ScaleDependentRenderer"===l.renderer.declaredClass?"scale"===l.renderer.rangeType?O=l.renderer.getRendererInfoByScale(e.getScale())&&l.renderer.getRendererInfoByScale(e.getScale()).renderer:"zoom"===l.renderer.rangeType&&(O=l.renderer.getRendererInfoByZoom(e.getZoom())&&l.renderer.getRendererInfoByZoom(e.getZoom()).renderer):O=l.renderer),O&&("esri.renderer.SimpleRenderer"===O.declaredClass||"esri.renderer.TemporalRenderer"===O.declaredClass||r.isString(O.attributeField)&&l._getField(O.attributeField,!0))&&!O._compiledFunc&&!this._isFeatureCollectionRequired(O)&&"esri.renderer.DotDensityRenderer"!==O.declaredClass&&"esri.layers.CSVLayer"!==l.declaredClass&&"esri.layers.StreamLayer"!==l.declaredClass){if(d={id:l.id,title:r.getObject("arcgisProps.title",!1,l)||l.id,opacity:l.opacity,minScale:l.minScale||0,maxScale:l.maxScale||0,layerDefinition:{drawingInfo:{renderer:O.toJson({useLegacyRotationProperties:!0})}}},d=r.mixin(d,this._getUrlAndToken(l)),"esri.renderer.TemporalRenderer"===O.declaredClass){var k=d.layerDefinition.drawingInfo;k.latestObservationRenderer=k.renderer.latestObservationRenderer,k.trackLinesRenderer=k.renderer.trackRenderer,k.observationAger=k.renderer.observationAger,k.renderer=k.renderer.observationRenderer,l._trackIdField&&(d.layerDefinition.timeInfo={trackIdField:l._trackIdField})}if(this._convertSvgRenderer(d.layerDefinition.drawingInfo.renderer),l.opacity<1||"esri.renderer.TemporalRenderer"===O.declaredClass||this._updateLayerOpacity(d)){if(l._params.source){var C=l._params.source.toJson();r.mixin(d.layerDefinition,{source:C})}if(l.getDefinitionExpression()&&r.mixin(d.layerDefinition,{definitionExpression:l.getDefinitionExpression()}),2!==l.mode){if(l.getSelectedFeatures().length>0){var E=t.map(l.getSelectedFeatures(),function(e){return e.attributes[l.objectIdField]});E.length>0&&l.getSelectionSymbol()&&r.mixin(d,{selectionObjectIds:E,selectionSymbol:l.getSelectionSymbol().toJson()})}}else{var P=t.map(l.getSelectedFeatures(),function(e){return e.attributes[l.objectIdField]});if(0===P.length||!l._params.drawMode)break;r.mixin(d.layerDefinition,{objectIds:P});var M=null;l.getSelectionSymbol()&&(M=new f(l.getSelectionSymbol())),r.mixin(d.layerDefinition.drawingInfo,{renderer:M&&M.toJson()})}}else d=this._createFeatureCollection(l,e)}else d=O&&(O._compiledFunc||this._isFeatureCollectionRequired(O)||"esri.renderer.DotDensityRenderer"===O.declaredClass)?this._createFeatureCollection(l,e,O):this._createFeatureCollection(l,e);if(!d)continue;y.push(d),this.allLayerslegend&&this.allLayerslegend.push({id:l.id});break;case"esri.layers.GraphicsLayer":case"esri.layers.WFSLayer":if(d=this._createFeatureCollection(l,e),!d)continue;y.push(d),this.allLayerslegend&&this.allLayerslegend.push({id:l.id})}}return e.graphics&&e.graphics.graphics.length>0&&(d=this._createFeatureCollection(e.graphics,e),d&&y.push(d)),e._labels&&a.showLabels&&(d=this._createFeatureCollection(e._labels,e),d&&y.push(d)),t.forEach(y,function(e,r,t){e._isRefLayer&&(delete e._isRefLayer,t.splice(r,1),t.push(e))}),y},_getUrlAndToken:function(e){return{token:e._getToken(),url:e._url?e._url.path:null}},_updateLayerOpacity:function(e){var i=this._colorEvaluator(e);i=t.filter(i,function(e){return r.isArray(e)&&4===e.length});var a=!0;if(i.length){var n,l=i[0][3];for(n=1;n<i.length;n++)if(l!==i[n][3]){a=!1;break}if(a)for(e.opacity=l/255,n=0;n<i.length;n++)i[n][3]=255}return a},_isFeatureCollectionRequired:function(e){var t=!1,i=this._getVariable(e,"rotationInfo",!1);if(i){var a=i.field;t=a&&r.isFunction(a)||i.valueExpression}return e.hasVisualVariables("sizeInfo")||e.hasVisualVariables("colorInfo")||e.hasVisualVariables("opacityInfo")||t},_getVariable:function(e,r,t){var i,a;return e&&(i=e.getVisualVariablesForType(r,t),a=i&&i[0]),a},_applyVisualVariables:function(e,r){var t=r.renderer,i=r.graphic,a=r.symbol,n=r.mapResolution,l=r.mapScale,s=a.type;if("textsymbol"!==s&&"shieldlabelsymbol"!==s){var o=this._getVariable(t,"sizeInfo",!1),d=this._getVariable(t,"colorInfo",!1),u=this._getVariable(t,"opacityInfo",!1),c=this._getVariable(t,"rotationInfo",!1);if(a instanceof p&&(o=this._getVariable(t,"sizeInfo","outline")||o),o){var m=t.getSize(i,{sizeInfo:o,shape:"simplemarkersymbol"===s?a.style:null,resolution:n,scale:l});null!=m&&("simplemarkersymbol"===s?e.size=S.px2pt(m):"picturemarkersymbol"===s?(e.width=S.px2pt(m),e.height=S.px2pt(m)):"simplelinesymbol"===s?e.width=S.px2pt(m):e.outline&&(e.outline.width=S.px2pt(m)))}if(d){var f=t.getColor(i,{colorInfo:d});f&&("simplemarkersymbol"===s||"simplelinesymbol"===s||"simplefillsymbol"===s)&&(e.color=y.toJsonColor(f))}if(u){var g=t.getOpacity(i,{opacityInfo:u});null!=g&&e.color&&(e.color[3]=Math.round(255*g))}if(c){var h=t.getRotationAngle(i,{rotationInfo:c});h&&(e.angle=-h)}}}});return n("extend-esri")&&r.setObject("tasks.PrintTask",L,l),L});