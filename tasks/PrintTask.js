// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["../core/kebabDictionary","../core/urlUtils","../core/promiseUtils","../geometry/Polygon","../request","dojo/_base/lang","dojo/dom-construct","dojox/gfx/canvas","./Geoprocessor","./support/PrintTemplate","./support/printTaskUtils","./Task"],function(e,t,r,a,i,s,n,l,o,u,y,c){function p(e){return!(!e||!e.path)}var d={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},m=e({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),h=e({MAP_ONLY:"map-only","A3 Landscape":"a3-landscape","A3 Portrait":"a3-portrait","A4 Landscape":"a4-landscape","A4 Portrait":"a4-portrait","Letter ANSI A Landscape":"letter-ansi-a-landscape","Letter ANSI A Portrait":"letter-ansi-a-portrait","Tabloid ANSI B Landscape":"tabloid-ansi-b-landscape","Tabloid ANSI B Portrait":"tabloid-ansi-b-portrait"}),f=e({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"}),g=c.createSubclass({declaredClass:"esri.tasks.PrintTask",constructor:function(){this._handleExecuteResponse=this._handleExecuteResponse.bind(this)},_vtlExtent:null,_legendLayers:[],_legendLayerNameMap:{},_gpServerUrl:null,_is11xService:!1,_data:null,properties:{mode:{readonly:!0,value:"sync"},_geoprocessor:{dependsOn:["url","updateDelay"],get:function(){return new o(this.url,{updateDelay:this.updateDelay})}},url:{value:null,type:String},updateDelay:{value:1e3,type:Number}},execute:function(e,t){var a=this.url.replace(/\/Export.*/,"");return r.resolve().then(function(){return this._gpServerUrl===a?{data:this._data}:(this._gpServerUrl=a,i(a,{query:{f:"json"}}))}.bind(this)).then(function(r){this._data=r.data,this._is11xService=!!this._data.cimVersion;var a=this._setPrintParams(e);this.mode===this._data.executionType?this._data.executionType:f.fromJSON(this._data.executionType);var i="async"===this.mode?"submitJob":"execute";return this._geoprocessor[i](a,t).then(this._handleExecuteResponse)}.bind(this))},_createOperationalLayers:function(e,r){var a,i,n,l,o=e.map,u=[],y=o.allLayers.filter(function(e){return e.parent&&"group"===e.parent.type&&!e.parent.visible?!1:!0}).items;for(a=0;a<y.length;a++)if(i=y[a],i.loaded&&i.visible)switch(l={id:i.id,title:this._legendLayerNameMap[i.id]||i.title,opacity:i.opacity,minScale:i.minScale||0,maxScale:i.maxScale||0,url:i.url&&t.normalize(i.url),token:i.token},n=i.declaredClass){case"esri.layers.ImageryLayer":var c={bandIds:i.bandIds,compressionQuality:i.compressionQuality,format:i.format,interpolation:i.interpolation};i.mosaicRule&&(c.mosaicRule=i.mosaicRule.toJSON()),i.renderingRule&&(c.renderingRule=i.renderingRule.toJSON()),u.push(s.mixin(l,c)),this._legendLayers&&this._legendLayers.push({id:i.id});break;case"esri.layers.OpenStreetMapLayer":s.mixin(l,{type:"OpenStreetMap"}),u.push(l);break;case"esri.layers.GraphicsLayer":s.mixin(l,this._createFeatureCollectionJSON(i)),u.push(l),this._legendLayers&&this._legendLayers.push({id:i.id});break;case"esri.layers.VectorTileLayer":if(this._is11xService){l={id:i.id,tiyle:i.title,type:"VectorTileLayer",layerType:"VectorTileLayer",styleUrl:i.url&&t.normalize(i.url),opacity:i.opacity,visibility:i.visible},u.push(l);break}l.type="image",l.url&&delete l.url;var p=r.exportOptions&&r.exportOptions.dpi||96,d=r.exportOptions&&r.exportOptions.width%2===e.width%2,m=r.exportOptions&&r.exportOptions.height%2===e.height%2,h={format:"png",pixelRatio:p/96,rotation:0},f=this._vtlExtent||e.extent.clone();if("MAP_ONLY"===r.layout&&r.preserveScale&&(!r.outScale||r.outScale===e.scale)&&96===p&&(!d||!m)&&(h.area={x:0,y:0,width:e.width,height:e.height},d||(h.area.width+=1),m||(h.area.height+=1),!this._vtlExtent)){var g=e.toMap({x:h.area.width,y:h.area.height});f.ymin=g.y,f.xmax=g.x,this._vtlExtent=f}l.extent=f.clone()._normalize(!0).toJSON();var b=e.whenLayerView(i);b.isResolved()&&b.then(function(t){var r=t.takeScreenshot(h,e);r.isResolved()?r.then(function(e){"data:image/png;base64,"===e.dataURL.substr(0,22)&&(l.imageData=e.dataURL.substr(22))}):console.error("PrintTask: VectorTileLayer.takeScreenshot() returned an unresolved Promise"),l.imageData&&u.push(l)});break;case"esri.layers.MapImageLayer":var v={id:i.id,subLayerIds:[]},S=[],x=e.scale,_=function(e){var t=0===x,r=0===e.minScale||x<=e.minScale,a=0===e.maxScale||x>=e.maxScale;if(e.visible&&(t||r&&a))if(e.sublayers)e.sublayers.forEach(_);else{var i=e.toExportImageJSON().drawingInfo,s=e.toJSON();s.layerDefinition.drawingInfo=i,S.unshift(s),v.subLayerIds.push(e.id)}};i.sublayers&&i.sublayers.forEach(_),s.mixin(l,{layers:S,visibleLayers:v.subLayerIds}),u.push(l),this._legendLayers.push(v);break;case"esri.layers.KMLLayer":if(this._is11xService){var l={};i.write(l,{origin:"web-map"}),l.showLabels=r.showLabels,u.push(l)}else e.whenLayerView(i).then(function(e){e.allVisibleMapImages.forEach(function(e,t){var r={id:i.id+"_image"+t,type:"image",title:i.id,minScale:i.minScale||0,maxScale:i.maxScale||0,opacity:i.opacity,extent:e.extent.toJSON()};"data:image/png;base64,"===e.href.substr(0,22)?r.imageData=e.href.substr(22):r.url=e.href,u.push(r)});var t=e.allVisiblePoints.concat(e.allVisiblePolylines).concat(e.allVisiblePolygons),r={id:i.id};s.mixin(r,this._createFeatureCollectionJSON(null,t)),u.push(r)}.bind(this));break;case"esri.layers.WMSLayer":var S=[],_=function(e){e.visible&&(e.sublayers?e.sublayers.forEach(_):e.name&&S.unshift(e.name))};i.sublayers&&i.sublayers.forEach(_),s.mixin(l,{type:"wms",transparentBackground:i.imageTransparency,visibleLayers:S,version:i.version}),u.push(l);break;case"esri.layers.WMTSLayer":var L=i.activeLayer;s.mixin(l,{type:"wmts",layer:L.id,style:L.styleId,format:L.imageFormat,tileMatrixSet:L.tileMatrixSetId}),u.push(l);break;case"esri.layers.WebTileLayer":var w=i.urlTemplate.replace(/\$\{/g,"{");s.mixin(l,{type:"WebTiledLayer",urlTemplate:w,credits:i.copyright}),i.subDomains&&i.subDomains.length>0&&(l.subDomains=i.subDomains),u.push(l);break;case"esri.layers.CSVLayer":if(this._is11xService){var l={};i.write(l,{origin:"web-map"}),u.push(l);break}case"esri.layers.StreamLayer":case"esri.layers.FeatureLayer":var O=i.renderer,D=O&&!O.hasVisualVariables()&&!i.featureReduction&&!O.valueExpression&&"esri.layers.CSVLayer"!==n,T="esri.layers.FeatureLayer"===n&&i.source&&i.source.length||"esri.layers.StreamLayer"===n;if(!this._is11xService&&!D||T){var I;e.whenLayerView(i).then(function(e){return e.queryGraphics&&e.queryGraphics()||e.featuresView.graphics}).then(function(e){I=e.map(function(e){return e.geometry.hasZ=!1,e})}),s.mixin(l,this._createFeatureCollectionJSON(i,I))}else{var l={};i.write(l,{origin:"web-map"}),l.layerDefinition&&l.layerDefinition.drawingInfo&&l.layerDefinition.drawingInfo.renderer&&this._convertSvgRenderer(l.layerDefinition.drawingInfo.renderer)}if(O.visualVariables&&O.visualVariables[0]&&O.visualVariables[0].maxSize&&"number"!=typeof O.visualVariables[0].maxSize&&O.visualVariables[0].minSize&&"number"!=typeof O.visualVariables[0].minSize){var M=O.getSizeRangeAtScale(O.visualVariables[0],e.scale);l.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=M.minSize,l.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=M.maxSize}u.push(l),this._legendLayers&&this._legendLayers.push({id:i.id});break;case"esri.layers.MapNotesLayer":var P=[];i.featureCollections.map(function(e){var t=e.source.toArray(),r=this._createFeatureCollectionJSON(e,t).featureCollection;P=P.concat(r.layers)}.bind(this)),s.mixin(l,{featureCollection:{layers:P}}),u.push(l);break;default:u.push(l)}if(e.graphics&&e.graphics.length){var l=this._createFeatureCollectionJSON({},e.graphics);l&&u.push(l)}return u},_createFeatureCollectionJSON:function(e,t){var r=e,i=y.createPolygonLayer(),n=y.createPolylineLayer(),l=y.createPointLayer(),o=y.createMultipointLayer(),u=y.createPointLayer();if(u.layerDefinition.name="textLayer",delete u.layerDefinition.drawingInfo,r&&("esri.layers.FeatureLayer"===r.declaredClass||"esri.layers.StreamLayer"===r.declaredClass?i.layerDefinition.name=n.layerDefinition.name=l.layerDefinition.name=o.layerDefinition.name=this._legendLayerNameMap[r.id]||r.get("arcgisProps.title")||r.title:"esri.layers.GraphicsLayer"===r.declaredClass&&(t=r.graphics.items)),r&&r.renderer&&!s.isFunction(r.get("renderer.field"))){var c=r.renderer.toJSON();i.layerDefinition.drawingInfo.renderer=c,n.layerDefinition.drawingInfo.renderer=c,l.layerDefinition.drawingInfo.renderer=c,o.layerDefinition.drawingInfo.renderer=c}else delete i.layerDefinition.drawingInfo,delete n.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo,delete o.layerDefinition.drawingInfo;var p=r&&r.fields,d=r&&r.renderer,m=[];d&&!s.isFunction(r.get("renderer.field"))&&("class-breaks"===d.type?(p||(p=[{name:d.field,type:"esriFieldTypeDouble"}],d.normalizationField&&p.push({name:d.normalizationField,type:"esriFieldTypeDouble"})),d.field&&m.push(d.field),d.normalizationField&&m.push(d.normalizationField)):"unique-value"===d.type&&(p||(p=[{name:d.field,type:"esriFieldTypeString"}],d.field2&&p.push({name:d.field2,type:"esriFieldTypeString"}),d.field3&&p.push({name:d.field3,type:"esriFieldTypeString"})),d.field&&m.push(d.field),d.field2&&m.push(d.field2),d.field3&&m.push(d.field3))),p&&(i.layerDefinition.fields=p,n.layerDefinition.fields=p,l.layerDefinition.fields=p,o.layerDefinition.fields=p);for(var h,f=t&&t.length,g=0;f>g;g++){var b=t[g]||t.getItemAt(g);if(b.visible!==!1&&b.geometry&&(h=b.toJSON(),h.hasOwnProperty("popupTemplate")&&delete h.popupTemplate,h.geometry&&h.geometry.z&&delete h.geometry.z,!h.symbol||!h.symbol.outline||"esriCLS"!==h.symbol.outline.type||this._is11xService)){if(h.symbol&&h.symbol.outline&&h.symbol.outline.color&&h.symbol.outline.color[3]&&!this._is11xService&&(h.symbol.outline.color[3]=255),r&&r.renderer&&!h.symbol&&(s.isFunction(r.renderer.field)||r.renderer.compiledFunc||r.renderer.hasVisualVariables()||r.renderer)){var d=r.renderer,v=d.getSymbol(b);if(!v)continue;h.symbol=v.toJSON(),d.hasVisualVariables()&&y.applyVisualVariables(h.symbol,{renderer:d,graphic:b,symbol:v})}if(h.symbol&&(h.symbol.angle||delete h.symbol.angle,h.symbol.path?h.symbol=this._convertSvgToPictureMarkerSymbolJson(h.symbol):h.symbol.text&&delete h.attributes),r&&r.renderer&&"simple"===r.renderer.type)delete h.attributes;else if(m.length){var S={};m.forEach(function(e){h.attributes&&h.attributes.hasOwnProperty(e)&&(S[e]=h.attributes[e])}),h.attributes=S}"polygon"===b.geometry.type?i.featureSet.features.push(h):"polyline"===b.geometry.type?n.featureSet.features.push(h):"point"===b.geometry.type?h.symbol&&h.symbol.text?u.featureSet.features.push(h):l.featureSet.features.push(h):"multipoint"===b.geometry.type?o.featureSet.features.push(h):"extent"===b.geometry.type&&(h.geometry=a.fromExtent(b.geometry).toJSON(),i.featureSet.features.push(h))}}var x=[i,n,o,l,u].filter(function(e){return e.featureSet.features.length>0});return x.forEach(function(e){var t=e.featureSet.features.every(function(e){return e.symbol});t&&(e.featureSet.features.forEach(function(e){delete e.attributes}),delete e.layerDefinition.drawingInfo),e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer&&this._convertSvgRenderer(e.layerDefinition.drawingInfo.renderer)},this),{featureCollection:{layers:x}}},_convertSvgToPictureMarkerSymbolJson:function(e){this._canvasParent||(this._canvasParent=n.create("div"),this._canvasSurface=l.createSurface(this._canvasParent,200,200));var t=this._canvasSurface.createObject(l.Path,e.path).setFill(e.color).setStroke(e.outline);"pendingRender"in this._canvasSurface&&this._canvasSurface._render(!0);var r=this._canvasSurface.rawNode.getContext("2d"),a=t.getBoundingBox(),i=Math.ceil(a.width+a.x),s=Math.ceil(a.height+a.y),o=r.getImageData(a.x,a.y,i,s);r.canvas.width=i,r.canvas.height=s,r.putImageData(o,0,0);var u=r.canvas.toDataURL("image/png"),y=22;return{type:"esriPMS",imageData:u.substr(y),angle:-e.angle,contentType:"image/png",height:e.size?e.size:s-a.y,width:e.size?e.size:i-a.x,xoffset:e.xoffset,yoffset:e.yoffset}},_convertSvgRenderer:function(e){var t=e.type;if("simple"===t&&p(e.symbol))return void(e.symbol=this._convertSvgToPictureMarkerSymbolJson(e.symbol));if("unique-value"===t||"class-breaks"===t){var r="unique-value"===t?"uniqueValueInfos":"classBreakInfos",a=e[r];p(e.defaultSymbol)&&(e.defaultSymbol=this._convertSvgToPictureMarkerSymbolJson(e.defaultSymbol)),a&&a.forEach(function(e){p(e)&&(e.symbol=this._convertSvgToPictureMarkerSymbolJson(e.symbol))},this)}},_getPrintDefinition:function(e,t){var r=e.view,a=r.map,i=r.spatialReference,s={operationalLayers:this._createOperationalLayers(r,t)},n=this._vtlExtent||e.extent||r.extent;return i&&i.isWrappable&&(n=n.clone()._normalize(!0),i=n.spatialReference),s.mapOptions={extent:n&&n.toJSON(),spatialReference:i&&i.toJSON(),showAttribution:t.attributionVisible},this._vtlExtent=null,r.rotation&&(s.mapOptions.rotation=-r.rotation),t.preserveScale&&(s.mapOptions.scale=t.outScale||r.scale),a.timeExtent&&(s.mapOptions.time=[a.timeExtent.startTime.getTime(),a.timeExtent.endTime.getTime()]),s},_handleExecuteResponse:function(e){return"sync"===this.mode?e.results&&e.results[0]&&e.results[0].value:this._geoprocessor.getResultData(e.jobId,"Output_File").then(function(e){return e.value})},_setPrintParams:function(e){var t=e.template||new u;null==t.showLabels&&(t.showLabels=!0);var r,a=t.exportOptions;if(a){var i=a.dpi;r={dpi:i};var n=h.toJSON(t.layout);if("map_only"===n.toLowerCase()||""===n){var l=a.width,o=a.height;r.outputSize=[l,o]}}var y,c=t.layoutOptions;if(c){var p,f;"Miles"===c.scalebarUnit||"Kilometers"===c.scalebarUnit?(p="Kilometers",f="Miles"):("Meters"===c.scalebarUnit||"Feet"===c.scalebarUnit)&&(p="Meters",f="Feet"),y={titleText:c.titleText,authorText:c.authorText,copyrightText:c.copyrightText,customTextElements:c.customTextElements,scaleBarOptions:{metricUnit:m.toJSON(p),metricLabel:d[p],nonMetricUnit:m.toJSON(f),nonMetricLabel:d[f]}}}var g=null;c&&c.legendLayers&&(g=c.legendLayers.map(function(e){this._legendLayerNameMap[e.layerId]=e.title;var t={id:e.layerId};return e.subLayerIds&&(t.subLayerIds=e.subLayerIds),t},this));var b=this._getPrintDefinition(e,t);e.outSpatialReference&&(b.mapOptions.spatialReference=e.outSpatialReference.toJSON()),s.mixin(b,{exportOptions:r,layoutOptions:y}),s.mixin(b.layoutOptions,{legendOptions:{operationalLayers:null!=g?g:this._legendLayers}});var v=JSON.stringify(b),S={Web_Map_as_JSON:v,Format:t.format,Layout_Template:n};return e.extraParameters&&s.mixin(S,e.extraParameters),S}});return g});