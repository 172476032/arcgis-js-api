// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","../../core/Error","../../core/Logger","../../core/promiseUtils","../../config","../../tasks/GeometryService","../Polygon","../Polyline","../SpatialReference","./webMercatorUtils","./spatialReferenceUtils"],function(e,r,n,t,i,a,o,f,u,s,l,c){function p(e){return"polygon"===e.type}function h(e){return"polygon"===e[0].type}function g(e){return"polyline"===e[0].type}function v(e){return p(e)?e.rings:e.paths}function m(e,r){return Math.ceil((e-r)/(2*r))}function x(e,r){for(var n=v(e),t=0;t<n.length;t++)for(var i=n[t],a=0;a<i.length;a++){var o=e.getPoint(t,a);e.setPoint(t,a,o.clone().offset(r,0))}return e}function y(e){for(var r=[],n=0,t=0,i=0;i<e.length;i++){for(var a=e[i],o=null,f=0;f<a.length;f++)o=a[f],r.push(o),0===f?(n=o[0],t=n):(n=Math.min(n,o[0]),t=Math.max(t,o[0]));o&&r.push([(n+t)/2,0])}return r}function d(e,r){if(!(e instanceof u||e instanceof f)){var t="straightLineDensify: the input geometry is neither polyline nor polygon";throw U.error(t),new n(t)}for(var i=v(e),a=[],o=0,s=i;o<s.length;o++){var l=s[o],c=[];a.push(c),c.push([l[0][0],l[0][1]]);for(var h=0;h<l.length-1;h++){var g=l[h][0],m=l[h][1],x=l[h+1][0],y=l[h+1][1],d=Math.sqrt((x-g)*(x-g)+(y-m)*(y-m)),w=(y-m)/d,M=(x-g)/d,R=d/r;if(R>1){for(var b=1;R-1>=b;b++){var P=b*r,k=M*P+g,z=w*P+m;c.push([k,z])}var E=(d+Math.floor(R-1)*r)/2,L=M*E+g,T=w*E+m;c.push([L,T])}c.push([x,y])}}return p(e)?new f({rings:a,spatialReference:e.spatialReference}):new u({paths:a,spatialReference:e.spatialReference})}function w(e,r,n){var t=1e6;if(r){var i=d(e,t);e=l.webMercatorToGeographic(i,!0)}return n&&(e=x(e,n)),e}function M(e,r,n){if(Array.isArray(e)){var t=e[0];if(t>r){var i=m(t,r);e[0]=t+i*(-2*r)}else if(n>t){var i=m(t,n);e[0]=t+i*(-2*n)}}else{var t=e.x;if(t>r){var i=m(t,r);e=e.clone().offset(i*(-2*r),0)}else if(n>t){var i=m(t,n);e=e.clone().offset(i*(-2*n),0)}}return e}function R(e,r){var n=-1;return r.cutIndexes.forEach(function(t,i){var a=r.geometries[i],o=v(a);if(o.forEach(function(e,r){e.some(function(n){if(n[0]<180)return!0;for(var t=0,i=0;i<e.length;i++){var o=e[i][0];t=o>t?o:t}t=Number(t.toFixed(9));for(var f=m(t,180),u=-360*f,s=0;s<e.length;s++){var l=a.getPoint(r,s);a.setPoint(r,s,l.clone().offset(u,0))}return!0})}),t===n){if(h(e))for(var f=0,u=v(a);f<u.length;f++){var s=u[f];e[t]=e[t].addRing(s)}else if(g(e))for(var l=0,c=v(a);l<c.length;l++){var p=c[l];e[t]=e[t].addPath(p)}}else n=t,e[t]=a}),e}function b(){return z||(z=new o({url:a.geometryServiceUrl})),z}function P(e,r){r||(r=b());for(var n,t,a,o,p,h,g,v,y=0,d=[],P=e.map(function(e){if(!e)return e;if(n||(n=e.spatialReference,t=c.getInfo(n),a=n.isWebMercator,o=a?20037508.342788905:180,p=a?-20037508.342788905:-180,h=a?102100:4326,g=new u({paths:[[[o,p],[o,o]]],spatialReference:new s({wkid:h})}),v=new u({paths:[[[p,p],[p,o]]],spatialReference:new s({wkid:h})})),!t)return e;if("point"===e.type)return M(e.clone(),o,p);if("multipoint"===e.type){var r=e.clone();return r.points=r.points.map(function(e){return M(e,o,p)}),r}if("extent"===e.type){var i=e.clone(),l=i._normalize(!1,!1,t);return l.rings?new f(l):l}if(e.extent){var i=e.extent,R=m(i.xmin,p),b=R*(2*o),P=0===b?e.clone():x(e.clone(),b);return i.offset(b,0),i.intersects(g)&&i.xmax!==o?(y=i.xmax>y?i.xmax:y,P=w(P,a),d.push(P),"cut"):i.intersects(v)&&i.xmin!==p?(y=i.xmax*(2*o)>y?i.xmax*(2*o):y,P=w(P,a,360),d.push(P),"cut"):P}return e.clone()}),k=m(y,o),U=-90,z=k,E=new u;k>0;){var L=-180+360*k;E.addPath([[L,U],[L,-1*U]]),U=-1*U,k--}return d.length>0&&z>0?r.cut(d,E).then(function(e){return R(d,e)}).then(function(n){var t=[],i=P.map(function(r,i){if("cut"!==r)return r;var o=n.shift(),f=e[i];return"polygon"===f.type&&f.rings&&f.rings.length>1&&o.rings.length>=f.rings.length?(t.push(o),"simplify"):a?l.geographicToWebMercator(o):o});return t.length?r.simplify(t).then(function(e){return i.map(function(r){return"simplify"!==r?r:a?l.geographicToWebMercator(e.shift()):e.shift()})}):P}):i.resolve(P.map(function(e){if("cut"!==e)return e;var r=d.shift();return a===!0?l.geographicToWebMercator(r):r}))}function k(e){if(!e)return null;var r=e.extent;if(!r)return null;var n=e.spatialReference&&c.getInfo(e.spatialReference);if(!n)return r;var t=n.valid,i=t[0],a=t[1],o=2*a,f=r.width,u=r.xmin,s=r.xmax;if(v=[s,u],u=v[0],s=v[1],"extent"===e.type||0===f||a>=f||f>o||i>u||s>a)return r;var l;switch(e.type){case"polygon":if(!(e.rings.length>1))return r;l=y(e.rings);break;case"polyline":if(!(e.paths.length>1))return r;l=y(e.paths);break;case"multipoint":l=e.points}for(var p=r.clone(),h=0;h<l.length;h++){var g=l[h][0];0>g?(g+=a,s=Math.max(g,s)):(g-=a,u=Math.min(g,u))}return p.xmin=u,p.xmax=s,p.width<f?(p.xmin-=a,p.xmax-=a,p):r;var v}Object.defineProperty(r,"__esModule",{value:!0});var U=t.getLogger("esri.geometry.support.normalizeUtils");r.straightLineDensify=d;var z;r.normalizeCentralMeridian=P,r.getDenormalizedExtent=k});