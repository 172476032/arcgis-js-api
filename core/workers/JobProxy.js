// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.6/esri/copyright.txt for details.

define(["require","exports","dojo/_base/kernel","dojo/_base/lang","dojo/Deferred","../../kernel","../../config","../../request","../Logger","../Error","../sniff","../urlUtils","./WorkerFallbackImpl"],function(e,t,o,r,n,i,s,a,c,d,u,g,f){function l(){if(!u("esri-workers"))return p(new f);if(!y){var e=void 0;try{e=new Worker(v)}catch(t){m.warn("Failed to create Worker. Fallback to execute module in main thread",event),e=new f}return p(e)}return b||(b=a(v,{responseType:"text"})),b.then(function(e){return new Worker(URL.createObjectURL(new Blob([e.data],{type:"text/javascript"})))}).otherwise(function(e){return m.warn("Failed to create Worker. Fallback to execute module in main thread",e),new f}).then(function(e){return p(e)})}function p(e){function t(n){if(n&&n.data&&n.data.type){var i=n.data.type;"<worker-loaded>"===i?h(e):"<worker-configured>"===i&&(e.removeEventListener("message",t),e.removeEventListener("error",o),r.resolve(e))}}function o(r){r.preventDefault(),e.removeEventListener("message",t),e.removeEventListener("error",o),m.warn("Failed to create Worker. Fallback to execute module in main thread",r),e=new f,e.addEventListener("message",t),e.addEventListener("error",o)}var r=new n;return e.addEventListener("message",t),e.addEventListener("error",o),r.promise}function h(e){var t;if(null!=s["default"]){var n=r.mixin({},s);delete n["default"],t=JSON.parse(JSON.stringify(n))}else t=JSON.parse(JSON.stringify(s));var i={async:!0,baseUrl:k,locale:o.locale,has:{},paths:{}};r.mixin(i,s.workers.loaderConfig),i.has=r.mixin({"esri-cors":1,"dojo-test-sniff":0,"config-deferredInstrumentation":0,"host-webworker":1,"events-keypress-typed":0},i.has),i.paths=r.mixin({esri:"../esri",dojo:"../dojo",dojox:"../dojox",dstore:"../dstore",moment:"../moment"},i.paths),e.postMessage({type:"<configure>",configure:{esriConfig:t,dojoConfig:i,loaderUrl:w}})}var m=c.getLogger("esri.core.workers.JobProxy"),v=g.normalize(e.toUrl("./worker.js")),w=g.makeAbsolute(e.toUrl("dojo/dojo.js")),k=g.makeAbsolute("../",w)+"/",y=!g.hasSameOrigin(v,location.href),b=null,J=function(){function e(e,t,o){this.connections=e,this.index=t,this.worker=o,this.msgCount=0,this.outgoingJobs=new Map,this.incomingJobs=new Map,this.incomingStaticJobs=new Map,this.worker.addEventListener("message",this.message.bind(this)),this.worker.addEventListener("error",function(e){e.preventDefault(),m.error(e)})}return e.create=function(t,o){return l().then(function(r){return new e(t,o,r)})},e.prototype.terminate=function(){this.worker.terminate()},e.prototype.openConnection=function(e,t){return this.invoke("<open-connection>",{path:e},void 0,t)},e.prototype.closeConnection=function(e){this.invoke("<close-connection>",void 0,void 0,e)},e.prototype.hasOutgoingJobs=function(){return this.outgoingJobs.size>0},e.prototype.invoke=function(e,t,o,r){var i=this,s=++this.msgCount,a=new n(function(e){i.worker.postMessage({type:"<cancel>",id:s,connection:r,data:{reason:e}}),i.outgoingJobs.has(s)&&i.outgoingJobs["delete"](s)});return this.outgoingJobs.set(s,a),this.worker.postMessage({type:e,id:s,connection:r,data:t},o),a.promise},e.prototype.message=function(e){var t=this;if(e&&e.data){var o=e.data.type;if(o){var r=e.data,n=e.data.id;if("<response>"===o&&n){var s=this.outgoingJobs.get(n);if(!s)return;this.outgoingJobs["delete"](n),r.error?s.reject(d.fromJSON(JSON.parse(r.error))):s.resolve(r.data)}else if("<cancel>"===o&&n){var a=this.incomingJobs.get(n);if(a&&a.cancel(r.data.reason),r.staticMsg){var c=this.incomingStaticJobs.get(n);c&&c.cancel(r.data.reason)}}else if("<static-message>"===o){var u=r.staticMsg,g=i.workerMessages[u];if(!g||"function"!=typeof g)return void this.worker.postMessage({type:"<static-message>",staticMsg:u,id:n,error:u+" message type is not available on the kernel!"});var f=g.call(this,r.data);this.incomingStaticJobs.set(n,f),f.then(function(e){t.worker.postMessage({type:"<static-message>",staticMsg:u,id:n,data:e.data},e.buffers)}).otherwise(function(e){e||(e={message:"Error encountered at method"+u}),e.dojoType&&"cancel"===e.dojoType||t.worker.postMessage({type:"<static-message>",staticMsg:u,id:n,error:JSON.stringify(e)})}).always(function(){t.incomingStaticJobs["delete"](n)})}else{var l=r.connection,p=this.connections.get(l);if(!p)return;var h=p.client;if(!h)return;var m=h[o];if("function"==typeof m){var v=m.call(h,r.data);this.incomingJobs.set(n,v),v.then(function(e){t.worker.postMessage({type:"<response>",id:n,connection:l,error:e.error&&JSON.stringify(e.error),data:e.data},e.buffers)}).otherwise(function(e){e||(e={message:"Error encountered at method"+o}),e.dojoType&&"cancel"===e.dojoType||t.worker.postMessage({type:"<response>",id:n,connection:l,error:JSON.stringify(e)})}).always(function(){t.incomingJobs["delete"](n)})}}}}},e}();return J});