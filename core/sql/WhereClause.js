// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.2/esri/copyright.txt for details.

define(["require","exports","./WhereGrammar","dojo/Deferred","dojo/promise/all","../../moment","../../geometry/geometryEngineAsync"],function(e,r,t,a,n,s,l){function o(e){return e===!0?!0:!1}function i(e){return null!==e?!(e===!0):null}function u(e,r){return null!=e&&null!=r?e===!0&&r===!0:e===!1||r===!1?!1:null}function c(e,r){return null!=e&&null!=r?e===!0||r===!0:e===!0||r===!0?!0:null}function h(e,r){if(null==e)return null;for(var t=!1,a=0,n=r;a<n.length;a++){var s=n[a];if(null==s)t=null;else if(e===s){t=!0;break}}return t}function f(e,r,t){if(null==e)return null;for(var a=r,n=t,s="",l="-[]/{}()*+?.\\^$|",o=0,i=0;i<a.length;i++){var u=a.charAt(i);switch(o){case 0:u===n?o=1:s+=l.indexOf(u)>=0?"\\"+u:"%"===u?".*":"_"===u?".":u;break;case 1:s+=l.indexOf(u)>=0?"\\"+u:u,o=0}}var c=new RegExp("^"+s+"$");return c.test(e)}function d(e){return e instanceof Date?e.valueOf():e}function v(e,r,t){if(null==r||null==t)return null;var a=d(r),n=d(t);switch(e){case"<>":return a!==n;case"=":return a===n;case">":return a>n;case"<":return n>a;case">=":return a>=n;case"<=":return n>=a}}function p(e,r,t){return"undefined"==typeof t||0===+t?Math[e](r):(r=+r,t=+t,isNaN(r)||"number"!=typeof t||t%1!==0?NaN:(r=r.toString().split("e"),r=Math[e](+(r[0]+"e"+(r[1]?+r[1]-t:-t))),r=r.toString().split("e"),+(r[0]+"e"+(r[1]?+r[1]+t:t))))}var N;!function(e){function r(e){return function(r){e.reject(r)}}function t(e,r){return function(){for(var t=[],a=0;a<arguments.length;a++)t[a]=arguments[a];try{e.apply(null,t)}catch(n){r.reject(n)}}}function a(e){if(void 0===e)return null;if("number"==typeof e)return e;switch(e.toLowerCase()){case"meters":case"meter":return 109404;case"miles":case"mile":return 109413;case"kilometers":case"kilometer":case"km":return 109414}return null}function n(e){if(void 0===e)return null;if("number"==typeof e)return e;if("number"==typeof e)return e;switch(e.toLowerCase()){case"meters":case"meter":return 9001;case"miles":case"mile":return 9035;case"kilometers":case"kilometer":case"km":return 9036}return null}var s;!function(e){e[e.Standardised=0]="Standardised",e[e.SqlServer=1]="SqlServer",e[e.Oracle=2]="Oracle",e[e.Postgres=3]="Postgres",e[e.PGDB=4]="PGDB",e[e.FILEGDB=5]="FILEGDB",e[e.NotEvaluated=6]="NotEvaluated"}(s=e.FeatureServiceDatabaseType||(e.FeatureServiceDatabaseType={})),e.errback=r,e.callback=t,e.convertSquareUnitsToCode=a,e.convertLinearUnitsToCode=n}(N||(N={}));var g=["extract","abs","ceiling","floor","log","log10","power","round","truncate","char_length","concat","lower","substring","upper"],T=function(){function e(){this.parseTree=null,this.parameters=null,this.child1=null,this.child2=null}return e.create=function(r){var a=new e;try{a.parseTree=t.parse(r)}catch(n){throw new Error("Invalid Expression: "+r)}return a},e.assemble=function(r,t){var a=new e;return a.child1=r,a.child2=t,a},e.prototype.isStandardized=function(){var e=this.getFunctions();return e.every(function(e){return g.indexOf(e.toLowerCase())>=0})},e.prototype.findVariables=function(){var e=[];return this.findAllVariables(this.parseTree,e),this.dedup(e)},e.prototype.setVariablesDictionary=function(e){this.parameters=e},e.prototype.toWhereClause=function(e){return null!==this.child1?"(("+this.child1.toWhereClause(e)+") AND ("+this.child2.toWhereClause(e)+"))":this.evaluateNodeToWhereClause(this.parseTree,e)},e.prototype.reformulateWithoutField=function(r,t){return e.create(this._reformulateInner(r,t))},e.prototype._reformulateInner=function(e,r){return null!==this.child1?"(("+this.child1._reformulateInner(e,r)+") AND ("+this.child2._reformulateInner(e,r)+"))":this.evaluateNodeToWhereClause(this.parseTree,N.FeatureServiceDatabaseType.Standardised,e,r)},e.prototype.statisticFunction=function(){if(null!==this.child1)return null;if("call-function"===this.parseTree.type){if(0===this.parseTree.parameters.length)return{name:this.parseTree.name,expr:null};if(this.parseTree.parameters.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");var r=new e;return r.parseTree=this.parseTree.parameters[0],{name:this.parseTree.name,expr:r}}return null},e.prototype.testFeature=function(e){return null!==this.child1?this.child1.testFeature(e)&&this.child2.testFeature(e):this.evaluateNode(this.parseTree,e)},e.prototype.testFeatureDeferred=function(e){var r=this,t=new a;return null!==this.child1?this.child1.testFeatureDeferred(e).then(N.callback(function(a){a===!1?t.resolve(!1):r.child2.testFeatureDeferred(e).then(N.callback(function(e){t.resolve(e)},t),N.errback(t))},t),N.errback(t)):this.evaluateNodeDeferred(this.parseTree,e).then(N.callback(function(e){t.resolve(e)},t),N.errback(t)),t.promise},e.prototype.calculateValue=function(e){return null!==this.child1?this.child1.calculateValue(e)&&this.child2.calculateValue(e):this.evaluateNode(this.parseTree,e)},e.prototype.calculateValueDeferred=function(e){var r=this,t=new a;return null!==this.child1?this.child1.calculateValueDeferred(e).then(N.callback(function(a){a===!1?t.resolve(!1):r.child2.calculateValueDeferred(e).then(N.callback(function(e){t.resolve(e)},t),N.errback(t))},t),N.errback(t)):this.evaluateNodeDeferred(this.parseTree,e).then(N.callback(function(e){t.resolve(e)},t),N.errback(t)),t.promise},e.prototype.scanForField=function(e){return null!==this.child1?this.child1.scanForField(e)||this.child2.scanForField(e):this.findField(this.parseTree,e)},e.prototype.getFunctions=function(){var e=[];return e=null!==this.child1?this.child1.getFunctions().concat(this.child2.getFunctions()):this.findFunctions(this.parseTree),this.dedup(e)},e.prototype.getFields=function(){var e=[];return e=null!==this.child1?this.child1.getFields().concat(this.child2.getFields()):this.findFields(this.parseTree),this.dedup(e)},e.prototype.dedup=function(e){for(var r=[],t={},a=0,n=e;a<n.length;a++){var s=n[a],l=s.toLowerCase();void 0===t[l]&&(r.push(s),t[l]=1)}return r},e.prototype.featureValue=function(e,r,t){var a=e.attributes[r];if(void 0!==a)return a;for(var n in e.attributes)if(r.toLowerCase()===n.toLowerCase())return t.value=n,e.attributes[n];return null},e.prototype.isSingleField=function(){return"FieldLiteral"===this.parseTree.type?!0:!1},e.prototype.findField=function(e,r){if(null===e||void 0===e)return!1;switch(e.type){case"when_clause":return this.findField(e.operand,r)||this.findField(e.value,r);case"case_expression":for(var t=0,a=e.clauses;t<a.length;t++){var n=a[t];if(this.findField(n,r))return!0}return"simple"===e.format&&this.findField(e.operand,r)?!0:null!==e["else"]&&this.findField(e["else"],r)?!0:!1;case"param":return!1;case"expr_list":for(var s=0,l=e.value;s<l.length;s++){var n=l[s];if(this.findField(n,r))return!0}return!1;case"unary_expr":return this.findField(e.expr,r);case"binary_expr":return this.findField(e.left,r)||this.findField(e.right,r);case"null":case"bool":case"date":case"timestamp":case"string":case"number":return!1;case"column_ref":return r.toLowerCase()===e.column.toLowerCase();case"function":return this.findField(e.args,r)}return!1},e.prototype.findFunctions=function(e){if(null===e||void 0===e)return[];switch(e.type){case"when_clause":return this.findFunctions(e.operand).concat(this.findFunctions(e.value));case"case_expression":for(var r=[],t=0,a=e.clauses;t<a.length;t++){var n=a[t];r=r.concat(this.findFunctions(n))}return"simple"===e.format&&(r=r.concat(this.findFunctions(e.operand))),null!==e["else"]&&(r=r.concat(this.findFunctions(e["else"]))),r;case"param":return[];case"expr_list":for(var s=[],l=0,o=e.value;l<o.length;l++){var n=o[l];s=s.concat(this.findFunctions(n))}return s;case"unary_expr":return this.findFunctions(e.expr);case"binary_expr":return this.findFunctions(e.left).concat(this.findFunctions(e.right));case"null":case"bool":case"date":case"timestamp":case"string":case"number":return[];case"column_ref":return[];case"function":return this.findFunctions(e.args).concat([e.name.toLowerCase().trim()])}return[]},e.prototype.findFields=function(e){var r=[];if(null===e||void 0===e)return r;switch(e.type){case"when_clause":return this.findFields(e.operand).concat(this.findFields(e.value));case"case_expression":for(var t=0,a=e.clauses;t<a.length;t++){var n=a[t];r=r.concat(this.findFields(n))}return"simple"===e.format&&(r=r.concat(this.findFields(e.operand))),null!==e["else"]&&(r=r.concat(this.findFields(e["else"]))),r;case"param":return[];case"expr_list":for(var s=0,l=e.value;s<l.length;s++){var n=l[s];r=r.concat(this.findFields(n))}return r;case"unary_expr":return this.findFields(e.expr);case"binary_expr":return this.findFields(e.left).concat(this.findFields(e.right));case"null":case"bool":case"date":case"timestamp":case"string":case"number":return[];case"column_ref":return[e.column];case"function":return this.findFields(e.args)}return[]},e.prototype.findAllVariables=function(e,r){if(null!==e&&void 0!==e)switch(e.type){case"when_clause":return this.findAllVariables(e.operand,r),void this.findAllVariables(e.value,r);case"case_expression":for(var t=0,a=e.clauses;t<a.length;t++){var n=a[t];this.findAllVariables(n,r)}"simple"===e.format&&this.findAllVariables(e.operand,r),null!==e["else"]&&this.findAllVariables(e["else"],r);break;case"param":r.push(e.value.toLowerCase());case"expr_list":for(var s=0,l=e.value;s<l.length;s++){var n=l[s];this.findAllVariables(n,r)}return;case"unary_expr":this.findAllVariables(e.expr,r);case"binary_expr":return this.findAllVariables(e.left,r),void this.findAllVariables(e.right,r);case"null":case"bool":case"date":case"timestamp":case"string":case"number":return;case"column_ref":return;case"function":return void this.findAllVariables(e.args,r)}},e.prototype.evaluateNode=function(e,r){var t,a,n,s;switch(e.type){case"case_expression":if("simple"===e.format){for(var l=d(this.evaluateNode(e.operand,r)),p=0;p<e.clauses.length;p++)if(s=l===d(this.evaluateNode(e.clauses[p].operand,r)))return this.evaluateNode(e.clauses[p].value,r);if(null!==e["else"])return this.evaluateNode(e["else"],r)}else{for(var p=0;p<e.clauses.length;p++)if(s=o(this.evaluateNode(e.clauses[p].operand,r)))return this.evaluateNode(e.clauses[p].value,r);if(null!==e["else"])return this.evaluateNode(e["else"],r)}return null;case"param":return this.parameters[e.value.toLowerCase()];case"expr_list":a=[];for(var N=0,g=e.value;N<g.length;N++){var T=g[N];a.push(this.evaluateNode(T,r))}return a;case"unary_expr":return i(this.evaluateNode(e.expr,r));case"binary_expr":switch(e.operator){case"AND":return u(this.evaluateNode(e.left,r),this.evaluateNode(e.right,r));case"OR":return c(this.evaluateNode(e.left,r),this.evaluateNode(e.right,r));case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null===this.evaluateNode(e.left,r);case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return null!==this.evaluateNode(e.left,r);case"IN":return t=[],"expr_list"===e.right.type?t=this.evaluateNode(e.right,r):(t=this.evaluateNode(e.right,r),t instanceof Array||(t=[t])),h(this.evaluateNode(e.left,r),t);case"NOT IN":return t=[],"expr_list"===e.right.type?t=this.evaluateNode(e.right,r):(t=[this.evaluateNode(e.right,r)],t instanceof Array||(t=[t])),i(h(this.evaluateNode(e.left,r),t));case"BETWEEN":var m=this.evaluateNode(e.left,r);return n=this.evaluateNode(e.right,r),null==m||null==n[0]||null==n[1]?null:m>=n[0]&&m<=n[1];case"NOTBETWEEN":var E=this.evaluateNode(e.left,r);return n=this.evaluateNode(e.right,r),null==E||null==n[0]||null==n[1]?null:E<n[0]||E>n[1];case"LIKE":return f(this.evaluateNode(e.left,r),this.evaluateNode(e.right,r),e.escape);case"NOT LIKE":return i(f(this.evaluateNode(e.left,r),this.evaluateNode(e.right,r),e.escape));case"<>":case"<":case">":case">=":case"<=":case"=":return v(e.operator,this.evaluateNode(e.left,r),this.evaluateNode(e.right,r));case"*":return this.evaluateNode(e.left,r)*this.evaluateNode(e.right,r);case"-":return this.evaluateNode(e.left,r)-this.evaluateNode(e.right,r);case"+":return this.evaluateNode(e.left,r)+this.evaluateNode(e.right,r);case"/":return this.evaluateNode(e.left,r)/this.evaluateNode(e.right,r)}throw new Error("Not Supported Operator "+e.operator);case"null":case"bool":case"string":case"number":return e.value;case"date":return this.parseDate(e.value);case"timestamp":return this.parseTimestamp(e.value);case"column_ref":if("CURRENT_DATE"===e.column.toUpperCase()){var T=new Date;return T.setHours(0,0,0,0),T}if("CURRENT_TIMESTAMP"===e.column.toUpperCase()){var w=new Date;return w}return this.featureValue(r,e.column,e);case"function":var b=this.evaluateNode(e.args,r);return this.executeFunction(e.name,b)}throw new Error("Unsupported sql syntax "+e.type)},e.prototype.executeFunction=function(e,r){switch(e.toLowerCase().trim()){case"extract":if(2!==r.length)throw new Error("Invalid Parameter for call to Extract");if(null==r[1])return null;var t=r[1];if(!(t instanceof Date))throw new Error("Invalid Parameter for call to Extract");switch(r[0].toUpperCase()){case"SECOND":return t.getSeconds();case"MINUTE":return t.getMinutes();case"HOUR":return t.getHours();case"DAY":return t.getDate();case"MONTH":return t.getMonth()+1;case"YEAR":return t.getFullYear();default:throw new Error("Invalid Parameter for call to Extract")}case"substring":if(2===r.length)return null===r[0]||null===r[1]?null:r[0].toString().substring(r[1]-1);if(3===r.length)return null===r[0]||null===r[1]||null===r[2]?null:r[2]<=0?"":r[0].toString().substring(r[1]-1,r[1]+r[2]-1);throw new Error("Invalid Parameter for call to SUBSTRING");case"abs":if(1!==r.length)throw new Error("Invalid Parameter for call to ABS");return null===r[0]?null:Math.abs(r[0]);case"ceiling":case"ceil":if(1!==r.length)throw new Error("Invalid Parameter for call to Ceil");return null===r[0]?null:Math.ceil(r[0]);case"floor":if(1!==r.length)throw new Error("Invalid Parameter for call to Floor");return null===r[0]?null:Math.floor(r[0]);case"log":if(1!==r.length)throw new Error("Invalid Parameter for call to Log");return null===r[0]?null:Math.log(r[0]);case"log10":if(1!==r.length)throw new Error("Invalid Parameter for call to Log10");return null===r[0]?null:Math.log(r[0])/Math.LN10;case"power":if(2!==r.length)throw new Error("Invalid Parameter for call to POWER");return null===r[0]?null:Math.pow(r[0],r[1]);case"round":return 2===r.length?p("round",r[0],-1*r[1]):null===r[0]?null:Math.round(r[0]);case"truncate":if(r.length<1||r.length>2)throw new Error("Invalid Parameter for TRUNCATE function");return null===r[0]?null:1===r.length?parseInt(r[0].toFixed(0),10):parseFloat(r[0].toFixed(r[1]));case"char_length":case"len":if(1!==r.length)throw new Error("Invalid Parameter for CHAR_LENGTH function");return"string"==typeof r[0]||r[0]instanceof String?r[0].length:0;case"concat":if(r.length<1)throw new Error("Invalid Parameter for CONCAT function");for(var a="",n=0;n<r.length;n++)null!==r[n]&&(a+=r[n].toString());return a;case"lower":case"lcase":if(1!==r.length)throw new Error("Invalid Parameter for Lower function");return null===r[0]?null:r[0].toString().toLowerCase();case"upper":case"ucase":if(1!==r.length)throw new Error("Invalid Parameter for Upper function");return null===r[0]?null:r[0].toString().toUpperCase()}throw new Error("Function Not Recognised")},e.prototype._makeDateString=function(e,r){var t=s(e),a=0===t.minute()&&0===t.hour()&&0===t.second()&&0===t.millisecond();switch(r){case N.FeatureServiceDatabaseType.FILEGDB:case N.FeatureServiceDatabaseType.Standardised:return a?"date '"+t.format("YYYY-MM-DD")+"'":"date '"+t.format("YYYY-MM-DD HH:mm:ss")+"'";case N.FeatureServiceDatabaseType.Oracle:return a?"TO_DATE('"+t.format("YYYY-MM-DD")+"','YYYY-MM-DD')":"TO_DATE('"+t.format("YYYY-MM-DD HH:mm:ss")+"','YYYY-MM-DD HH24:MI:SS')";case N.FeatureServiceDatabaseType.SqlServer:return"'"+t.format(a?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";case N.FeatureServiceDatabaseType.PGDB:return"#"+t.format(a?"MM-DD-YYYY":"MM-DD-YYYY HH:mm:ss")+"#";case N.FeatureServiceDatabaseType.Postgres:return"TIMESTAMP '"+t.format(a?"YYYY-MM-DD":"YYYY-MM-DD HH:mm:ss")+"'";default:return"date '"+t.format("YYYY-MM-DD HH:mm:ss")+"'"}},e.prototype._makeToday=function(e,r){switch(r){case N.FeatureServiceDatabaseType.FILEGDB:case N.FeatureServiceDatabaseType.Standardised:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";case N.FeatureServiceDatabaseType.Oracle:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";case N.FeatureServiceDatabaseType.SqlServer:return e?"CAST(GETDATE() AS DATE)":"GETDATE()";case N.FeatureServiceDatabaseType.PGDB:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";case N.FeatureServiceDatabaseType.Postgres:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP";default:return e?"CURRENT_DATE":"CURRENT_TIMESTAMP"}},e.prototype.evaluateNodeToWhereClause=function(e,r,t,a){void 0===t&&(t=null),void 0===a&&(a=null);var n,s,l,o;switch(e.type){case"case_expression":var i=" CASE ";"simple"===e.format&&(i+=this.evaluateNodeToWhereClause(e.operand,r,t,a));for(var u=0;u<e.clauses.length;u++)i+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[u].operand,r,t,a)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[u].value,r,t,a);return null!==e["else"]&&(i+=" ELSE "+this.evaluateNodeToWhereClause(e["else"],r,t,a)),i+=" END ";case"param":var c=this.parameters[e.value.toLowerCase()];if("string"==typeof c){var h=this.parameters[e.value.toLowerCase()];return"'"+h.toString()+"'"}if(c instanceof Date)return this._makeDateString(c,r);if(c instanceof Array){for(var f=[],u=0;u<c.length;u++)"string"==typeof c[u]?f.push("'"+c[u].toString()+"'"):c[u]instanceof Date?f.push(this._makeDateString(c[u],r)):f.push(c[u].toString());return f}return c.toString();case"expr_list":s=[];for(var d=0,v=e.value;d<v.length;d++){var p=v[d];s.push(this.evaluateNodeToWhereClause(p,r,t,a))}return s;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,r,t,a)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" AND "+this.evaluateNodeToWhereClause(e.right,r,t,a)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" OR "+this.evaluateNodeToWhereClause(e.right,r,t,a)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" IS NOT NULL )";case"IN":return n=[],"expr_list"===e.right.type?(n=this.evaluateNodeToWhereClause(e.right,r,t,a)," ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" IN ("+n.join(",")+")) "):(o=this.evaluateNodeToWhereClause(e.right,r,t,a),o instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" IN ("+o.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" IN ("+o+")) ");case"NOT IN":return n=[],"expr_list"===e.right.type?(n=this.evaluateNodeToWhereClause(e.right,r,t,a)," ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" NOT IN ("+n.join(",")+")) "):(o=this.evaluateNodeToWhereClause(e.right,r,t,a),o instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" NOT IN ("+o.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" NOT IN ("+o+")) ");case"BETWEEN":return l=this.evaluateNodeToWhereClause(e.right,r,t,a)," ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"NOTBETWEEN":return l=this.evaluateNodeToWhereClause(e.right,r,t,a)," ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" NOT BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" LIKE "+this.evaluateNodeToWhereClause(e.right,r,t,a)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" LIKE "+this.evaluateNodeToWhereClause(e.right,r,t,a)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,r,t,a)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,r,t,a)+") ";case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(e.left,r,t,a)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,r,t,a)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return e.value===!0?"1":"0";case"string":return"'"+e.value.toString()+"'";case"timestamp":return this._makeDateString(e.value,r);case"date":return this._makeDateString(e.value,r);case"number":return e.value.toString();case"column_ref":return"CURRENT_DATE"===e.column.toUpperCase()?this._makeToday(!0,r):"CURRENT_TIMESTAMP"===e.column.toUpperCase()?this._makeToday(!1,r):t&&t.toLowerCase()===e.column.toLowerCase()?"("+a+")":e.column;case"function":var N=this.evaluateNodeToWhereClause(e.args,r,t,a);return this.translateFunction(e.name,N,r)}throw new Error("Unsupported sql syntax "+e.type)},e.prototype.translateFunction=function(e,r,t){switch(e.toLowerCase().trim()){case"abs":if(1!==r.length)throw new Error("Invalid Parameter for call to ABS");return"abs("+r[0]+")";case"ceiling":case"ceil":if(1!==r.length)throw new Error("Invalid Parameter for call to CEILING");switch(t){case N.FeatureServiceDatabaseType.Standardised:return"CEILING("+r[0]+")";default:return"CEILING("+r[0]+")"}case"floor":if(1!==r.length)throw new Error("Invalid Parameter for call to Floor");switch(t){default:return"FLOOR("+r[0]+")"}case"log":if(1!==r.length)throw new Error("Invalid Parameter for call to LOG");switch(t){default:return"LOG("+r[0]+")"}case"log10":if(1!==r.length)throw new Error("Invalid Parameter for call to LOG10");switch(t){default:return"LOG10("+r[0]+")"}case"power":if(2!==r.length)throw new Error("Invalid Parameter for call to POWER");switch(t){default:return"POWER("+r[0]+","+r[1]+")"}case"round":if(2===r.length)switch(t){default:return"ROUND("+r[0]+","+r[1]+")"}else{if(1!==r.length)throw new Error("Invalid Parameter for call to ROUND");switch(t){default:return"ROUND("+r[0]+")"}}case"truncate":if(r.length<1||r.length>2)throw new Error("Invalid Parameter for TRUNCATE function");switch(t){case N.FeatureServiceDatabaseType.SqlServer:return"ROUND("+r[0]+(1===r.length?"0":","+r[1])+",1)";default:return"TRUNCATE("+r[0]+(1===r.length?")":","+r[1]+")")}case"char_length":case"len":if(1!==r.length)throw new Error("Invalid Parameter for CHAR_LENGTH function");switch(t){case N.FeatureServiceDatabaseType.SqlServer:return"LEN("+r[0]+")";case N.FeatureServiceDatabaseType.Oracle:return"LENGTH("+r[0]+")";default:return"CHAR_LENGTH("+r[0]+")"}case"concat":if(r.length<1)throw new Error("Invalid Parameter for CONCAT function");switch(t){default:for(var a="CONCAT(",n=0;n<r.length;n++)0!==n&&(a+=","),a+=r[n];return a+=")"}case"lower":case"lcase":if(1!==r.length)throw new Error("Invalid Parameter for Lower function");return"LOWER("+r[0]+")";case"upper":case"ucase":if(1!==r.length)throw new Error("Invalid Parameter for Upper function");return"UPPER("+r[0]+")";case"substring":var s="";switch(t){case N.FeatureServiceDatabaseType.Oracle:return s="SUBSTR("+r[0]+","+r[1],3===r.length&&(s+=","+r[2]),s+=")";case N.FeatureServiceDatabaseType.SqlServer:return s=3===r.length?"SUBSTRING("+r[0]+","+r[1]+","+r[2]+")":"SUBSTRING("+r[0]+",  "+r[1]+", LEN("+r[0]+") - "+r[1]+")";default:return s="SUBSTRING("+r[0]+" FROM "+r[1],3===r.length&&(s+=" FOR "+r[2]),s+=")"}case"extract":switch(t){default:return"EXTRACT("+r[0].replace(/\'/g,"")+" FROM "+r[1]+")"}}throw new Error("Function Not Recognised")},e.prototype.parseTimestamp=function(e){return s(e,["YYYY-M-D H:m:s","YYYY-M-D H:mZ","YYYY-M-D H:m:sZ","YYYY-M-D H:m","YYYY-m-d"]).toDate()},e.prototype.parseDate=function(e){return s(e,["YYYY-M-D"]).toDate()},e.prototype.evaluateWhereClausesSimpleDeferred=function(e,r,t,n,s){var l=new a,o=this;try{r>=e.length?null===t?l.resolve(null):this.evaluateNodeDeferred(t,s).then(function(e){l.resolve(e)},function(e){l.reject(e)}):this.evaluateNodeDeferred(e[r],s).then(function(a){var i=n===d(a);i?o.evaluateNode(e[r].value,s).then(function(e){l.resolve(e)},function(e){l.reject(e)}):o.evaluateWhereClausesSimpleDeferred(e,r+1,t,n,s).then(function(e){l.resolve(e)},function(e){l.reject(e)})},function(e){l.reject(e)})}catch(i){l.reject(i)}return l.promise},e.prototype.evaluateWhereClausesDeferred=function(e,r,t,n){var s=new a,l=this;try{r>=e.length?null===t?s.resolve(null):this.evaluateNodeDeferred(t,n).then(function(e){s.resolve(e)},function(e){s.reject(e)}):this.evaluateNodeDeferred(e[r].operand,n).then(function(a){var i=o(a);i?l.evaluateNode(e[r].value,n).then(function(e){s.resolve(e)},function(e){s.reject(e)}):l.evaluateWhereClausesDeferred(e,r+1,t,n).then(function(e){s.resolve(e)},function(e){s.reject(e)})},function(e){s.reject(e)})}catch(i){s.reject(i)}return s.promise},e.prototype.evaluateNodeDeferred=function(e,r){var t,s=new a,l=this;try{var i,u=void 0;switch(e.type){case"case_expression":"simple"===e.format?this.evaluateNodeDeferred(e.operand,r).then(function(t){var a=d(t);l.evaluateWhereClausesSimpleDeferred(e.clauses,0,e["else"],a,r).then(function(e){s.resolve(e)},function(e){s.reject(e)})},function(e){s.reject(e)}):l.evaluateWhereClausesDeferred(e.clauses,0,e["else"],r).then(function(e){s.resolve(e)},function(e){s.reject(e)});break;case"param":s.resolve(this.parameters[e.value.toLowerCase()]);break;case"expr_list":u=[];for(var c=0,h=e.value;c<h.length;c++){var v=h[c];u.push(this.evaluateNodeDeferred(v,r))}n(u).then(N.callback(function(e){s.resolve(e)},s),N.errback(s));break;case"unary_expr":this.evaluateNodeDeferred(e.expr,r).then(N.callback(function(e){s.resolve(!o(e))},s),N.errback(s));break;case"binary_expr":switch(e.operator){case"IS":"null"!==e.right.type?s.reject(new Error("Unsupported RHS for IS")):this.evaluateNodeDeferred(e.left,r).then(N.callback(function(e){s.resolve(null===e)},s),N.errback(s));break;case"ISNOT":"null"!==e.right.type?s.reject(new Error("Unsupported RHS for IS")):this.evaluateNodeDeferred(e.left,r).then(N.callback(function(e){s.resolve(null!==e)},s),N.errback(s));break;case"LIKE":case"NOT LIKE":case"BETWEEN":case"NOTBETWEEN":case"IN":case"NOT IN":case"AND":case"OR":case"<>":case"<":case">":case">=":case"<=":case"=":case"*":case"-":case"+":case"/":t=[l.evaluateNodeDeferred(e.left,r),l.evaluateNodeDeferred(e.right,r)],n(t).then(N.callback(function(r){switch(e.operator){case"LIKE":case"NOT LIKE":var t=f(r[0],r[0],e.escape);s.resolve("LIKE"===e.operator?t:!t);break;case"BETWEEN":case"NOTBETWEEN":var a=r[0];i=r[1];var n=a>=i[0]&&a<=i[1];s.resolve("BETWEEN"===e.operator?n:!n);break;case"IN":case"NOT IN":"IN"===e.operator?r[1]instanceof Array?s.resolve(r[1].indexOf(r[0])>-1):s.resolve([r[1]].indexOf(r[0])>-1):"NOT IN"===e.operator&&(r[1]instanceof Array?s.resolve(!(r[1].indexOf(r[0])>-1)):s.resolve(!([r[1]].indexOf(r[0])>-1)));break;case"AND":s.resolve(o(r[0])&&o(r[1]));break;case"OR":s.resolve(o(r[0])||o(r[1]));break;case"<>":s.resolve(d(r[0])!==d(r[1]));break;case"<":s.resolve(d(r[0])<d(r[1]));break;case">":s.resolve(d(r[0])>d(r[1]));break;case">=":s.resolve(d(r[0])>=d(r[1]));break;case"<=":s.resolve(d(r[0])<=d(r[1]));break;case"=":s.resolve(d(r[0])===d(r[1]));break;case"*":s.resolve(r[0]*r[1]);break;case"-":s.resolve(r[0]-r[1]);break;case"+":s.resolve(r[0]+r[1]);break;case"/":s.resolve(r[0]/r[1]);break;default:s.reject(new Error("Unrecognised operator"))}},s),N.errback(s));break;default:s.reject(new Error("Not Supported Operator "+e.operator))}break;case"null":case"bool":case"string":case"number":s.resolve(e.value);break;case"date":s.resolve(l.parseDate(e.value));break;case"timestamp":s.resolve(l.parseTimestamp(e.value));break;case"column_ref":if("CURRENT_DATE"===e.column.toUpperCase()){var v=new Date;v.setHours(0,0,0,0),s.resolve(v)}else if("CURRENT_TIMESTAMP"===e.column.toUpperCase()){var p=new Date;s.resolve(p)}else s.resolve(this.featureValue(r,e.column,e));break;case"function":this.evaluateNodeDeferred(e.args,r).then(N.callback(function(t){l.executeFunctionDeferred(e.name,r,t).then(N.callback(function(e){s.resolve(e)},s),N.errback(s))},s),N.errback(s));break;default:s.reject(new Error("Malformed Where Clause"))}}catch(g){s.reject(g)}return s.promise},e.prototype.executeFunctionDeferred=function(e,r,t){var n=new a,s=0;try{switch(e.toLowerCase().trim()){case"extract":case"substring":case"abs":case"ceiling":case"ceil":case"floor":case"log":case"log10":case"power":case"round":case"truncate":case"char_length":case"len":case"concat":case"lower":case"lcase":case"upper":case"ucase":try{n.resolve(this.executeFunction(e,t))}catch(o){n.reject(o)}break;case"area":s=N.convertSquareUnitsToCode(t[0]);var i=!1;void 0!==t[1]&&null!==t[1]&&("1"===t[1].toString()||"true"===t[1].toString().toLowerCase()||"geodesic"===t[1].toString().toLowerCase())&&(i=!0),null===r.geometry?n.resolve(0):i?l.geodesicArea(r.geometry,s).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):l.planarArea(r.geometry,s).then(N.callback(function(e){n.resolve(e)},n),N.errback(n));break;case"length":s=N.convertLinearUnitsToCode(t[0]);var u=!1;void 0!==t[1]&&null!==t[1]&&("1"===t[1].toString()||"true"===t[1].toString().toLowerCase()||"geodesic"===t[1].toString().toLowerCase())&&(i=!0),null===r.geometry?n.resolve(0):u?l.geodesicArea(r.geometry,s).then(N.callback(function(e){n.resolve(e)},n),N.errback(n)):l.planarLength(r.geometry,s).then(N.callback(function(e){n.resolve(e)},n),N.errback(n));break;default:n.reject(new Error("Function Not Recognised"))}}catch(o){n.reject(o)}return n.promise},e}();return T});