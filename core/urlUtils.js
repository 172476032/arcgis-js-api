// COPYRIGHT Â© 2017 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.5/esri/copyright.txt for details.

define(["require","exports","dojo/_base/window","dojo/_base/lang","dojo/_base/url","dojo/io-query","../config","./lang","./sniff","./Logger","./Error"],function(r,e,t,n,a,i,o,l,u,s,c){function f(r){var e={path:null,query:null},t=new a(r),n=r.indexOf("?");return null===t.query?e.path=r:(e.path=r.substring(0,n),e.query=i.queryToObject(t.query)),t.fragment&&(e.hash=t.fragment,null===t.query&&(e.path=e.path.substring(0,e.path.length-(t.fragment.length+1)))),e}function p(r,e){void 0===r&&(r=!1),void 0===e&&(e=!0);var t,n=ar.proxyUrl;if("string"==typeof r){t=I(r);var a=m(r);a&&(n=a.proxyUrl)}else t=!!r;if(!n)throw nr.warn(ir),new c("urlutils:proxy-not-set",ir);var i;if(t&&e&&E()){var o=K(n);O(o)&&(n=o,i=1)}var l=f(n);return l._xo=i,l}function h(r){var e,t,a=m(r);if(a){var o=v(a.proxyUrl);e=o.path,t=o.query?i.queryToObject(o.query):null}else if(ar.forceProxy){var o=p();e=o.path,t=o.query}if(e){var l=f(r);r=e+"?"+l.path;var u=i.objectToQuery(n.mixin(t||{},l.query));u&&(r=r+"?"+u)}return r}function v(r){var e=r.indexOf("?");return-1!==e?(fr.path=r.slice(0,e),fr.query=r.slice(e+1)):(fr.path=r,fr.query=null),fr}function g(r){return r=v(r).path,r=G(r),r=A(r,!0),r=r.toLowerCase()}function d(r){for(var e={proxyUrl:r.proxyUrl,urlPrefix:g(r.urlPrefix)},t=ar.proxyRules,n=e.urlPrefix,a=t.length,i=0;i<t.length;i++){var o=t[i].urlPrefix;if(0===n.indexOf(o)){if(n.length===o.length)return-1;a=i;break}0===o.indexOf(n)&&(a=i+1)}return t.splice(a,0,e),a}function m(r){for(var e=ar.proxyRules,t=g(r),n=0;n<e.length;n++)if(0===t.indexOf(e[n].urlPrefix))return e[n]}function y(r,e){return r=U(r),e=U(e),A(r)===A(e)}function U(r){r=C(r);var e=r.indexOf("/sharing");return e>0?r.substring(0,e):r.replace(/\/+$/,"")}function x(r,e,t){void 0===t&&(t=!1);var n=J(r),a=J(e);return t||n.scheme===a.scheme?n.host.toLowerCase()===a.host.toLowerCase()&&n.port===a.port:!1}function O(r){return u("esri-phonegap")?!0:u("esri-cors")?null!=w(r):!1}function w(r,t){void 0===t&&(t=!1),"string"==typeof r&&(r=j(r)?J(r):e.appUrl);for(var n=ar.corsEnabledServers||[],a=0;a<n.length;a++){var i=n[a],o=void 0;o="string"==typeof i?b(i):i.host?b(i.host):[];for(var l=0;l<o.length;l++)if(x(r,o[l]))return t?a:i}return t?-1:null}function b(r){return e.corsServersUrlCache[r]||(k(r)||$(r)?e.corsServersUrlCache[r]=[new a(q(r))]:e.corsServersUrlCache[r]=[new a("http://"+r),new a("https://"+r)]),e.corsServersUrlCache[r]}function q(r,t,n){return void 0===t&&(t=e.appBaseUrl),$(r)?n&&n.preserveProtocolRelative?r:"http"===e.appUrl.scheme&&e.appUrl.authority===S(r).slice(2)?"http:"+r:"https:"+r:k(r)?r:R("/"===r[0]?M(t):t,r)}function P(r,t,n){if(void 0===t&&(t=e.appBaseUrl),!j(r))return r;var a=C(r),i=a.toLowerCase(),o=C(t).toLowerCase().replace(/\/+$/,""),l=n?C(n).toLowerCase().replace(/\/+$/,""):null;if(l&&0!==o.indexOf(l))return r;for(var u=function(r,e,t){return t=r.indexOf(e,t),-1===t?r.length:t},s=u(i,"/",i.indexOf("//")+2),c=-1;i.slice(0,s+1)===o.slice(0,s)+"/"&&(c=s+1,s!==i.length);)s=u(i,"/",s+1);if(-1===c)return r;if(l&&c<l.length)return r;r=a.slice(c);var f=o.slice(c-1).replace(/[^\/]+/g,"").length;if(f>0)for(var p=0;f>p;p++)r="../"+r;else r="./"+r;return r}function C(r){return r=r.trim(),r=q(r),r=V(r),r=W(r),r=Q(r)}function R(){for(var r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];if(r&&r.length){var t=[];if(j(r[0])){var n=r[0],a=n.indexOf("//");t.push(n.slice(0,a+1)),D(r[0])&&(t[0]+="/"),r[0]=n.slice(a+2)}else"/"===r[0][0]&&t.push("");for(var i=r.reduce(function(r,e){return r.concat(e.split("/"))},[]),o=0;o<i.length;o++){var l=i[o];".."===l&&t.length>0?t.pop():!l||"."===l&&0!==t.length||t.push(l)}return t.join("/")}}function S(r){if(L(r))return null;var e=r.indexOf("://");if(-1===e&&$(r))e=2;else{if(-1===e)return null;e+=3}var t=r.indexOf("/",e);return-1===t?r:r.slice(0,t)}function j(r){return $(r)||k(r)}function L(r){return"data:"===r.slice(0,5)}function B(r){var e=r.match(pr);if(!e)return null;var t=e[1],n=e[2],a=e[3],i=!!n;return{mediaType:t,isBase64:i,data:a}}function T(r){return r.isBase64?"data:"+r.mediaType+";base64,"+r.data:"data:"+r.mediaType+","+r.data}function $(r){return r&&"/"===r[0]&&"/"===r[1]}function k(r){return or.test(r)}function I(r){return ur.test(r)||"https"===e.appUrl.scheme&&$(r)}function _(r){return lr.test(r)||"http"===e.appUrl.scheme&&$(r)}function D(r){return sr.test(r)}function H(r){return $(r)?"http:"+r:r.replace(ur,"http:")}function K(r){return $(r)?"https:"+r:r.replace(lr,"https:")}function z(){return"http"===e.appUrl.scheme}function E(){return"https"===e.appUrl.scheme}function A(r,e){return void 0===e&&(e=!1),$(r)?r.slice(2):(r=r.replace(or,""),e&&r.length>1&&"/"===r[0]&&"/"===r[1]&&(r=r.slice(2)),r)}function M(r){var e=r.indexOf("//"),t=r.indexOf("/",e+2);return-1===t?r:r.slice(0,t)}function F(r){var e=0;if(j(r)){var t=r.indexOf("//");-1!==t&&(e=t+2)}var n=r.lastIndexOf("/");return e>n?r:r.slice(0,n+1)}function G(r){return r&&"/"===r[r.length-1]?r:r+"/"}function Q(r){return r.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function V(r){return z()&&I(r)&&x(e.appBaseUrl,r,!0)&&!O(r)?H(r):r}function W(r){var t=o.request.httpsDomains;if(!_(r))return r;var n,a=r.indexOf("/",7);return n=-1===a?r:r.slice(0,a),n=n.toLowerCase().slice(7),"http"!==e.appUrl.scheme||n!==e.appUrl.authority||cr.test(r)&&O(r)?((E()&&n===e.appUrl.authority||t&&t.some(function(r){return n===r||l.endsWith(n,"."+r)}))&&(r=K(r)),r):r}function X(r,e,t){if(!(e&&t&&r&&j(r)))return r;var n=r.indexOf("//"),a=r.indexOf("/",n+2),i=r.indexOf(":",n+2),o=Math.min(0>a?r.length:a,0>i?r.length:i),l=r.slice(n+2,o);if(l.toLowerCase()!==e.toLowerCase())return r;var u=r.slice(0,n+2),s=r.slice(o);return""+u+t+s}function J(r){return"string"==typeof r?new a(q(r)):(r.scheme||(r.scheme=e.appUrl.scheme),r)}function N(r,e){return e&&!e.isPortal&&e.urlKey&&e.customBaseUrl?X(r,e.urlKey+"."+e.customBaseUrl,e.portalHostname):r}function Y(r,t){if(!t||t.isPortal||!t.urlKey||!t.customBaseUrl)return r;var n=t.urlKey+"."+t.customBaseUrl;return x(e.appUrl,e.appUrl.scheme+"://"+n)?X(r,t.portalHostname,n):X(r,n,t.portalHostname)}function Z(r,e){var t=e&&e.url&&e.url.path;return r&&t&&(r=q(r,t,{preserveProtocolRelative:!0})),Y(r,e&&e.portal)}function rr(r,e){if(!r)return r;!j(r)&&e&&e.blockedRelativeUrls&&e.blockedRelativeUrls.push(r);var t=q(r);if(e){var n=e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.rootPath||e.url&&e.url.path;n&&(t=P(t,n,n),t!==r&&e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.writtenUrls.push(t))}return t=N(t,e&&e.portal)}function er(r){return hr.test(r)}Object.defineProperty(e,"__esModule",{value:!0});var tr=t.global,nr=s.getLogger("esri.core.urlUtils"),ar=o.request,ir="esri/config: esriConfig.request.proxyUrl is not set. If making a request to a CORS-enabled\n server, please push the domain into esriConfig.request.corsEnabledServers.",or=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,lr=/^\s*http:/i,ur=/^\s*https:/i,sr=/^\s*file:/i,cr=/^https?:\/\/[^\/]+\.arcgis.com\/sharing(\/|$)/i;e.appUrl=new a(tr.location),e.corsServersUrlCache={},e.appBaseUrl=function(){var r=e.appUrl.path,t=r.substring(0,r.lastIndexOf(r.split("/")[r.split("/").length-1])),n=e.appUrl.scheme+"://"+e.appUrl.host+(null!=e.appUrl.port?":"+e.appUrl.port:"");return""+n+t}(),e.urlToObject=f,e.getProxyUrl=p,e.addProxy=h;var fr={path:"",query:""};e.addProxyRule=d,e.getProxyRule=m,e.hasSamePortal=y,e.hasSameOrigin=x,e.canUseXhr=O,e.getCorsConfig=w,e.makeAbsolute=q,e.makeRelative=P,e.normalize=C,e.join=R,e.getOrigin=S,e.isAbsolute=j,e.isDataProtocol=L;var pr=/^data:(.*?)(;base64)?,(.*)$/;e.dataComponents=B,e.makeData=T,e.isProtocolRelative=$,e.hasProtocol=k,e.toHTTPS=K,e.removeFile=F,e.changeDomain=X,e.read=Z,e.write=rr,e.isSVG=er;var hr=/(^data:image\/svg|\.svg$)/i});