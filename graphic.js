// COPYRIGHT Â© 201 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/3.26/esri/copyright.txt for details.

define(["dojo/_base/declare","dojo/_base/lang","dojo/has","./kernel","./domUtils","./lang","./InfoTemplate","./geometry/jsonUtils","./symbols/jsonUtils"],function(t,e,i,s,r,n,o,a,u){function h(){}var l=t(null,{declaredClass:"esri.Graphic",constructor:function(t,e,i,s){t&&!t.declaredClass?(this.geometry=t.geometry?a.fromJson(t.geometry):null,this.symbol=t.symbol?u.fromJson(t.symbol):null,this.attributes=t.attributes||null,this.infoTemplate=t.infoTemplate?new o(t.infoTemplate):null):(this.geometry=t,this.symbol=e,this.attributes=i,this.infoTemplate=s)},_geomVersion:0,_resolution:null,_shape:null,_bgShape:null,_dataAttrs:null,_layer:null,_sourceLayer:null,_graphicsLayer:null,_suspended:!1,size:null,visible:!0,_aggregationSourceLayer:null,_aggregationInfo:null,_computedAttributes:null,_computedVersion:null,_computedGeomVersion:null,setSize:function(t){return this.size=t,this},getAggregationSourceLayer:function(){return this._aggregationSourceLayer},setAggregationSourceLayer:function(t){return this._aggregationSourceLayer=t,this},isAggregate:function(){return!!this._aggregationInfo},getAggregationInfo:function(){return this._aggregationInfo},setAggregationInfo:function(t){return this._aggregationInfo=t,this},getChildGraphics:function(){var t=this.getAggregationSourceLayer();return t?t.getChildGraphics(this):[]},getDojoShape:function(){return this._shape},getShapes:function(){var t=[];return this._shape&&t.push(this._shape),this._bgShape&&t.push(this._bgShape),t},getNode:function(){var t=this._shape&&this._shape.getNode();return t&&t.nodeType?t:null},getNodes:function(){var t,e,i=this.getShapes(),s=i.length,r=[];for(e=0;e<s;e++)(t=i[e]&&i[e].getNode())&&t.nodeType&&r.push(t);return r},getLayer:function(){return this._layer},getSourceLayer:function(){return this._sourceLayer||this._layer},clone:function(){var t=new this.constructor(this.toJson());return t.visible=this.visible,t._layer=this._layer,t._sourceLayer=this._sourceLayer,t._aggregationSourceLayer=this._aggregationSourceLayer,t._aggregationInfo=this._aggregationInfo,t._resolution=this._resolution,t},draw:function(){var t=this._graphicsLayer;return t&&t._draw(this,!0),this},setGeometry:function(t){this.geometry=t,this._geomVersion++;var e=this._graphicsLayer;return e&&(e._updateExtent(this),this.draw(),t&&"polyline"===t.type&&e._updateSVGMarkers()),this},setResolution:function(t){return this._resolution=t,this},getResolution:function(){return this._resolution},setSymbol:function(t,e){var i=this._graphicsLayer,s=this._shape;return this.symbol=t,i&&(e&&s&&i._removeShape(this),this.draw()),this},setAttributes:function(t){return this.attributes=t,this._clearCache(),this},setInfoTemplate:function(t){return this.infoTemplate=t,this},getInfoTemplate:function(){return this._getEffInfoTemplate()},_getEffInfoTemplate:function(){var t=this.getLayer();return this.infoTemplate||t&&t.infoTemplate},getTitle:function(){var t=this.getInfoTemplate(),i=t&&t.title;if(e.isFunction(i))i=i.call(t,this);else if(e.isString(i)){var s=this.getLayer(),r=s&&s._getDateOpts;i=n.substitute(this.attributes,i,{first:!0,dateFormat:r&&r.call(s)})}return i},getContent:function(){var t=this.getInfoTemplate(),i=t&&t.content;if(e.isFunction(i))i=i.call(t,this);else if(e.isString(i)){var s=this.getLayer(),r=s&&s._getDateOpts;i=n.substitute(this.attributes,i,{dateFormat:r&&r.call(s)})}return i},attr:function(t,e){return null==e||this._dataAttrs||(this._dataAttrs={}),this._dataAttrs&&(this._dataAttrs[t]=e,this._setDataAttr(t,e)),this},_isSuspended:function(){return this._suspended},_suspend:function(){this._suspended=!0,this.draw()},_resume:function(){this._suspended=!1,this.draw()},show:function(){this.visible=!0,this.attr("data-hidden");var t,e,i,s=this.getShapes();if(s.length)for(t=this.getNodes(),i=t.length,e=0;e<i;e++)r.show(t[e]);else this.draw();var n=this._graphicsLayer;return n&&n._graphicVisibilityChanged(this),this},hide:function(){this.visible=!1,this.attr("data-hidden","");var t,e,i,s=this._graphicsLayer;if(s){if("canvas-2d"===s.surfaceType)s._removeShape(this);else if(t=this.getNodes(),i=t.length)for(e=0;e<i;e++)r.hide(t[e]);s._graphicVisibilityChanged(this)}return this},toJson:function(){var t={};return this.geometry&&(t.geometry=this.geometry.toJson()),this.attributes&&(t.attributes=e.mixin({},this.attributes)),this.symbol&&(t.symbol=this.symbol.toJson()),this.infoTemplate&&(t.infoTemplate=this.infoTemplate.toJson()),t},_setDataAttr:function(t,e){var i,s=this.getNodes(),r=s.length;for(i=0;i<r;i++)this._setDOMDataAttr(s[i],t,e)},_setDOMDataAttr:function(t,e,i){null==i?t.removeAttribute(e):t.setAttribute(e,i)},_applyDataAttrs:function(){var t=this._dataAttrs;if(t){var e,i=this.getNodes(),s=i.length;for(e=0;e<s;e++){var r;for(r in t)this._setDOMDataAttr(i[e],r,t[r])}}},_getViewInfo:function(t){t=t||this.getLayer();var e=t&&t.getMap();return e&&e._getViewInfo()},_getDataValue:function(t,e,i,s,r){var n=e.id,o=this.attributes,a=t.field,u=e.isNumeric,h=null;if(n){var l=this._computedAttributes,g=this._computedVersion,c=this._computedGeomVersion,f=this._getViewInfo(s),_=e.dependsOnView||e.isJSFunc,p=e.dependsOnGeometry,d=p&&!!r;l||(l=this._computedAttributes={}),_&&!g&&(g=this._computedVersion={}),p&&!c&&(c=this._computedGeomVersion={});var m=_&&g[n]!==f._version||p&&c[n]!==this._geomVersion;if(void 0===(h=l[n])||m||d){if(h=null,e.hasExpr){var y=i.createExecContext(this,f),b=y.vars.$feature;b&&r&&(b._geometry=r),h=i.executeFunction(e.compiledFunc,y)}else if(e.isJSFunc)h=a(this,t);else if(o&&(h=o[a],u&&this._isValidNumber(h))){var v=t.normalizationType||"field";if(v){var S=h;h=null;var V=t.normalizationTotal,A=o[t.normalizationField];"log"===v&&0!==S?h=Math.log(S)*Math.LOG10E:"percent-of-total"===v&&this._isValidNumber(V)&&0!==V?h=S/V*100:"field"===v&&this._isValidNumber(A)&&0!==A&&(h=S/A)}}h=this._sanitizeValue(h,u),d||(l[n]=h,_&&(g[n]=f._version),p&&(c[n]=this._geomVersion))}}else o&&(h=this._sanitizeValue(o[a],u));return h},_sanitizeValue:function(t,e){return e&&!this._isValidNumber(t)&&(t=null),t},_isValidNumber:function(t){return"number"==typeof t&&!isNaN(t)&&t!==1/0&&t!==-1/0},_clearCache:function(){this._computedAttributes=this._computedVersion=this._computedGeomVersion=null}});return l.prototype.getShape=l.prototype.getDojoShape,h.prototype=l.prototype,l.simpleConstructor=h,i("extend-esri")&&(s.Graphic=l),l});